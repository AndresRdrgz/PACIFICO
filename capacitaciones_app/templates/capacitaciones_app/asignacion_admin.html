{% extends 'capacitaciones_app/base.html' %}
{% load static %}

{% block title %}Asignaci√≥n de Cursos{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-5">
    <h2 class="encabezado-cinta-verde">
        üß© Asignaci√≥n de Cursos
    </h2>

    </h2>



    <div class="row">
        {% include 'capacitaciones_app/asignacion_admin/_columna_cursos.html' %}
        {% include 'capacitaciones_app/asignacion_admin/_columna_usuarios.html' %}
        {% include 'capacitaciones_app/asignacion_admin/_columna_grupos.html' %}
    </div>
</div>

{% include 'capacitaciones_app/asignacion_admin/_historial.html' %}
{% include 'capacitaciones_app/asignacion_admin/_modal_cursos.html' %}
{% include 'capacitaciones_app/asignacion_admin/_asignacion_style.html' %}
{% include 'capacitaciones_app/asignacion_admin/_asignacion_script.html' %}

<!-- Ejemplo de secci√≥n de grupos -->
<div class="col" id="grupos-section">
    <h5><span>üë•</span> Grupos</h5>
    <!-- Tabla/lista de grupos (ejemplo de encabezado) -->
<table class="table">
    <thead>
        <tr>
            <th>Grupo</th>
            <th>Ver integrantes</th>
            <!-- ...otros encabezados... -->
        </tr>
    </thead>
    <tbody>
        {% for grupo in grupos %}
        <tr>
            <td>{{ grupo.nombre }}</td>
            <td>
                <button type="button"
                        class="btn btn-outline-secondary btn-sm ver-usuarios-grupo"
                        data-grupo-id="{{ grupo.id }}"
                        title="Ver usuarios del grupo">
                    üîç
                </button>
            </td>
            <!-- ...otras columnas... -->
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal para mostrar usuarios del grupo -->
<div class="modal fade" id="modalUsuariosGrupo" tabindex="-1" aria-labelledby="modalUsuariosGrupoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalUsuariosGrupoLabel">Usuarios del grupo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <ul id="listaUsuariosGrupo" class="list-group">
          <!-- Usuarios se llenan por JS -->
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
$(function() {
    $('.ver-usuarios-grupo').click(function() {
        var grupoId = $(this).data('grupo-id');
        $.get("{% url 'usuarios_grupo_ajax' 0 %}".replace('0', grupoId), function(data) {
            var $lista = $('#listaUsuariosGrupo').empty();
            if (data.usuarios.length === 0) {
                $lista.append('<li class="list-group-item">No hay usuarios en este grupo.</li>');
            } else {
                data.usuarios.forEach(function(u) {
                    $lista.append(
                        '<li class="list-group-item d-flex justify-content-between align-items-center">'
                        + u.first_name + ' ' + u.last_name + ' (' + u.username + ')'
                        + '<button class="btn btn-danger btn-sm ms-2 quitar-usuario-grupo" data-usuario-id="' + u.id + '" data-grupo-id="' + grupoId + '">Quitar</button>'
                        + '</li>'
                    );
                });
            }
            $('#modalUsuariosGrupo').modal('show');
        });
    });

    // Quitar usuario del grupo
    $('#listaUsuariosGrupo').on('click', '.quitar-usuario-grupo', function() {
        var usuarioId = $(this).data('usuario-id');
        var grupoId = $(this).data('grupo-id');
        var $btn = $(this);
        if (confirm('¬øSeguro que deseas quitar este usuario del grupo?')) {
            $.ajax({
                url: "{% url 'quitar_usuario_grupo_ajax' %}",
                type: "POST",
                data: JSON.stringify({grupo_id: grupoId, usuario_id: usuarioId}),
                contentType: "application/json",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function(resp) {
                    if (resp.success) {
                        $btn.closest('li').remove();
                    } else {
                        alert(resp.mensaje);
                    }
                }
            });
        }
    });
});
</script>
{% endblock %}
