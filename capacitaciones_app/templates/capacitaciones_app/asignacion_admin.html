{% extends 'capacitaciones_app/base.html' %}
{% load static %}

{% block title %}Asignación de Cursos{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="fw-bold text-success mb-4 text-center">👨‍🏫 Asignación de Cursos</h2>

    <!-- 🔍 Filtros visuales en una sola línea -->
    <div class="bg-light border rounded shadow-sm p-3 mb-4 d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="flex-grow-1 me-2">
            <input type="text" id="filtro-cursos" class="form-control" placeholder="🔍 Buscar curso...">
        </div>
        <div class="flex-grow-1 me-2">
            <input type="text" id="filtro-usuarios" class="form-control" placeholder="👤 Buscar usuario...">
        </div>
        <div class="flex-grow-1">
            <input type="text" id="filtro-grupos" class="form-control" placeholder="👥 Buscar grupo...">
        </div>
    </div>

    <div class="row">
        <!-- Cursos -->
        <div class="col-md-4">
            <h5>📚 Cursos</h5>
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="seleccionarTodosCursos" onclick="toggleCursos(this)">
                <label class="form-check-label fw-semibold" for="seleccionarTodosCursos">Seleccionar todos</label>
            </div>
            <ul id="lista-cursos" class="list-group">
                {% for curso in cursos %}
                    <li class="list-group-item curso-item" draggable="true" data-curso-id="{{ curso.id }}">
                        {{ curso.titulo }}
                    </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Usuarios -->
        <div class="col-md-4">
            <h5>👤 Usuarios</h5>
            <ul id="lista-usuarios" class="list-group border p-2 drop-zone">
                {% for usuario in usuarios %}
                    <li class="list-group-item drop-target d-flex justify-content-between align-items-center" data-usuario-id="{{ usuario.id }}">
                        <span>{{ usuario.username }}</span>
                        <button class="btn btn-sm btn-outline-secondary ver-cursos-btn" data-usuario-id="{{ usuario.id }}">🔍</button>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Grupos -->
        <div class="col-md-4">
            <h5>👥 Grupos</h5>
            <ul id="lista-grupos" class="list-group border p-2 drop-zone">
                {% for grupo in grupos %}
                    <li class="list-group-item drop-target" data-grupo-id="{{ grupo.id }}">
                        {{ grupo.nombre }}
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>


<!-- Historial -->
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="fw-bold text-success">📋 Historial de Asignaciones</h4>
        <a href="{% url 'exportar_asignaciones_excel' %}" class="btn btn-outline-success btn-sm">⬇️ Descargar Excel</a>
    </div>
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle table-sm">
            <thead class="table-success">
                <tr>
                    <th>#</th>
                    <th>📅 Fecha</th>
                    <th>📚 Curso</th>
                    <th>👤 Usuario</th>
                    <th>👥 Grupo</th>
                    <th>📈 Progreso</th>
                    <th>✅ Módulos</th>
                    <th>📅 Finalizado</th>
                    <th>📝 Método</th>
                </tr>
            </thead>
            <tbody>
                {% for h in historial %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ h.asignacion.fecha|date:"d/m/Y H:i" }}</td>
                    <td>{{ h.asignacion.curso.titulo }}</td>
                    <td>{% if h.asignacion.usuario %}{{ h.asignacion.usuario.username }}{% else %}—{% endif %}</td>
                    <td>{% if h.asignacion.grupo %}{{ h.asignacion.grupo.nombre }}{% else %}—{% endif %}</td>
                    <td>{{ h.progreso }}%</td>
                    <td>{{ h.completados }}/{{ h.total }}</td>
                    <td>
                        {% if h.completado_en %}
                            {{ h.completado_en|date:"d/m/Y" }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>{{ h.asignacion.metodo|capfirst }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center text-muted">No hay asignaciones registradas.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalCursosAsignados" tabindex="-1" aria-labelledby="modalCursosLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="modalCursosLabel">Cursos asignados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <ul id="lista-cursos-asignados" class="list-group"></ul>
      </div>
    </div>
  </div>
</div>

<!-- Estilos -->
<style>
.curso-item {
    user-select: none;
    padding: 8px 12px;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: grab;
    transition: box-shadow 0.2s ease;
}
.curso-item.seleccionado {
    background-color: #e0fce6;
}
.curso-item:active {
    cursor: grabbing;
}
.curso-item.dragging {
    opacity: 0.8;
    transform: scale(1.05);
    z-index: 9999;
    background-color: #d1e7dd;
    border-color: #0f5132;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
}
.drop-target {
    border: 2px dashed transparent;
    padding: 10px;
    border-radius: 6px;
    transition: background-color 0.2s ease, border 0.3s ease;
}
.drop-target.bg-light {
    background-color: #e0f7fa !important;
    border-color: #17a2b8;
    transform: scale(1.02);
}
.drop-target.success-highlight {
    animation: flash-success 1s ease;
}
@keyframes flash-success {
    0%   { background-color: #a5d6a7; }
    100% { background-color: transparent; }
}
</style>

<!-- Scripts -->
<script>
function toggleCursos(source) {
    document.querySelectorAll('.curso-item').forEach(item => {
        item.classList.toggle('seleccionado', source.checked);
    });
}

document.querySelectorAll('.curso-item').forEach(item => {
    item.addEventListener('dragstart', e => {
        e.dataTransfer.setData('cursoId', item.dataset.cursoId);
        e.dataTransfer.setData('cursoTitulo', item.innerText.trim());

        const ghost = document.createElement("div");
        ghost.style.position = "absolute";
        ghost.style.top = "-9999px";
        ghost.style.padding = "6px 12px";
        ghost.style.background = "#198754";
        ghost.style.color = "white";
        ghost.style.fontWeight = "bold";
        ghost.style.fontSize = "14px";
        ghost.style.borderRadius = "4px";
        ghost.style.boxShadow = "0 4px 10px rgba(0,0,0,0.2)";
        ghost.innerText = item.innerText.trim();
        document.body.appendChild(ghost);
        e.dataTransfer.setDragImage(ghost, 0, 0);

        item.classList.add('dragging');
    });

    item.addEventListener('dragend', () => item.classList.remove('dragging'));
});

document.querySelectorAll('.drop-target').forEach(target => {
    target.addEventListener('dragover', e => {
        e.preventDefault();
        target.classList.add('bg-light');
    });
    target.addEventListener('dragleave', () => {
        target.classList.remove('bg-light');
    });
    target.addEventListener('drop', e => {
        e.preventDefault();
        const el = e.currentTarget;
        el.classList.remove('bg-light');
        el.classList.add('success-highlight');
        setTimeout(() => el.classList.remove('success-highlight'), 1000);

        const cursoId = e.dataTransfer.getData('cursoId');
        const usuarioId = el.dataset.usuarioId || null;
        const grupoId = el.dataset.grupoId || null;

        fetch("{% url 'asignar_curso_ajax' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ curso_id: cursoId, usuario_id: usuarioId, grupo_id: grupoId })
        })
        .then(res => res.json())
        .then(data => {
            alert(data.mensaje);
            location.reload();
        })
        .catch(err => { alert("Error de red"); console.error(err); });
    });
});

function desasignarCurso(cursoId, usuarioId, btn) {
    fetch("{% url 'desasignar_curso_ajax' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ curso_id: cursoId, usuario_id: usuarioId })
    })
    .then(res => res.json())
    .then(data => { if (data.success) btn.closest('li').remove(); else alert(data.mensaje); })
    .catch(err => { alert("Error de red"); console.error(err); });
}

document.querySelectorAll('.ver-cursos-btn').forEach(button => {
    button.addEventListener('click', () => {
        const usuarioId = button.dataset.usuarioId;
        const lista = document.getElementById('lista-cursos-asignados');
        lista.innerHTML = '<li class="list-group-item">Cargando...</li>';

        fetch(`/cursos-asignados/${usuarioId}/`)
            .then(res => res.json())
            .then(data => {
                lista.innerHTML = '';
                if (data.cursos.length === 0) {
                    lista.innerHTML = '<li class="list-group-item">Sin cursos asignados</li>';
                } else {
                    data.cursos.forEach(curso => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `<span>${curso.titulo}</span><button class="btn btn-sm btn-danger" onclick="desasignarCurso(${curso.id}, ${usuarioId}, this)">❌</button>`;
                        lista.appendChild(li);
                    });
                }
                new bootstrap.Modal(document.getElementById('modalCursosAsignados')).show();
            });
    });
});

// Filtros dinámicos
function aplicarFiltro(inputId, listaId) {
    const input = document.getElementById(inputId);
    const lista = document.getElementById(listaId);
    input?.addEventListener('input', () => {
        const valor = input.value.toLowerCase();
        lista.querySelectorAll('li').forEach(item => {
            const texto = item.innerText.toLowerCase();
            item.style.display = texto.includes(valor) ? '' : 'none';
        });
    });
}

aplicarFiltro('filtro-cursos', 'lista-cursos');
aplicarFiltro('filtro-usuarios', 'lista-usuarios');
aplicarFiltro('filtro-grupos', 'lista-grupos');
</script>
{% endblock %}
