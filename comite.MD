# üß† Comit√© de Cr√©dito ‚Äî Integraci√≥n en el Sistema de Pipelines y Etapas

Este documento describe c√≥mo se implementa la funcionalidad del **Comit√© de Cr√©dito** dentro de un flujo de solicitudes basado en pipelines y etapas.

---

## üîÅ Visi√≥n General

El Comit√© de Cr√©dito es una **etapa especial dentro de un pipeline**, en la que participan varios niveles jer√°rquicos de revisi√≥n, como:

- Supervisor de Cr√©dito
- Gerente de Cr√©dito
- Gerente General

A diferencia de etapas escalonadas, **todos los niveles pueden ver, revisar y opinar sobre una solicitud al mismo tiempo**, sin necesidad de aprobaci√≥n previa de niveles inferiores.

---

## üß© Integraci√≥n en el Pipeline

### ‚úÖ Etapa del Comit√©

La etapa del Comit√© de Cr√©dito se define como cualquier `Etapa` dentro de un `Pipeline` que cumple las siguientes condiciones:

- Nombre sugerido: `"Comit√© de Cr√©dito"`
- `es_bandeja_grupal = True` ‚Üí para que todos los usuarios del comit√© vean las solicitudes.
- Accesible por todos los usuarios asignados a roles de comit√© (`NivelComite`).

---

## üß± Nuevos Modelos para Comit√©

### 1. `NivelComite`

Define los distintos niveles jer√°rquicos que pueden participar en el comit√©.

```python
class NivelComite(models.Model):
    nombre = models.CharField(max_length=100)
    orden = models.PositiveIntegerField(help_text="Jerarqu√≠a (menor = m√°s bajo)")
2. UsuarioNivelComite
Relaciona usuarios con niveles de comit√©.

python
Copiar
Editar
class UsuarioNivelComite(models.Model):
    usuario = models.ForeignKey(User, on_delete=models.CASCADE)
    nivel = models.ForeignKey(NivelComite, on_delete=models.CASCADE)
3. ParticipacionComite
Registra la opini√≥n de cada usuario que participa en una solicitud del comit√©.

python
Copiar
Editar
class ParticipacionComite(models.Model):
    solicitud = models.ForeignKey(Solicitud, on_delete=models.CASCADE, related_name='participaciones_comite')
    nivel = models.ForeignKey(NivelComite, on_delete=models.PROTECT)
    usuario = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    comentario = models.TextField()
    resultado = models.CharField(max_length=100, choices=[...], default='PENDIENTE')
    fecha = models.DateTimeField(auto_now_add=True)
4. SolicitudEscalamientoComite (opcional)
Permite registrar que un usuario sugiere participaci√≥n de un nivel superior, aunque no es obligatorio para que ese nivel participe.

python
Copiar
Editar
class SolicitudEscalamientoComite(models.Model):
    solicitud = models.ForeignKey(Solicitud, on_delete=models.CASCADE)
    solicitado_por = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    nivel_solicitado = models.ForeignKey(NivelComite, on_delete=models.PROTECT)
    comentario = models.TextField()
    atendido = models.BooleanField(default=False)
    fecha_solicitud = models.DateTimeField(auto_now_add=True)
üë• Comportamiento Funcional
Comportamiento	Detalle
Visibilidad de solicitudes del comit√©	Todos los niveles ven las solicitudes en la etapa "Comit√© de Cr√©dito".
Participaci√≥n por niveles	Cada usuario puede dejar su comentario sin esperar a otros niveles.
Escalamiento entre niveles	Opcional, solo como sugerencia de participaci√≥n.
Historial de opiniones	Se registra por solicitud, nivel, usuario, comentario y resultado.
Permisos de participaci√≥n	Basados en UsuarioNivelComite.

üìã Bandeja del Comit√©
La bandeja de trabajo del comit√© se genera listando todas las solicitudes cuya etapa actual es "Comit√© de Cr√©dito" y donde el usuario est√° asignado a alg√∫n nivel:

python
Copiar
Editar
def obtener_solicitudes_comite(user):
    if UsuarioNivelComite.objects.filter(usuario=user).exists():
        return Solicitud.objects.filter(etapa_actual__nombre="Comit√© de Cr√©dito")
    return Solicitud.objects.none()
üìå Consideraciones Finales
No hay orden forzoso de participaci√≥n (cualquier nivel puede participar primero).

Se pueden tomar decisiones a cualquier nivel si el flujo de trabajo lo permite.

Todas las opiniones quedan registradas y trazables.

Este esquema es totalmente compatible con el sistema de Pipelines, Etapas y Subestados existente.