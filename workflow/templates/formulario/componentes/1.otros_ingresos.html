{# 1. Toggle para activar “Otros ingresos” #}
<div class="form-check form-switch mb-3">
  <input class="form-check-input" type="checkbox" id="otros_ingresos_toggle">
  <label class="form-check-label" id="otros_ingresos_label" for="otros_ingresos_toggle">No</label>
</div>

{# 2. Sección principal (arranca oculta) #}
<div id="otros-ingresos-section" class="form-section" style="display: none;">
  <h3>
    <span class="section-icon"><i class="fas fa-wallet"></i></span>
    Otros Ingresos
  </h3>

  {{ otros_ingresos_formset.management_form }}

  <div id="otros-ingresos-forms">
    {% for ingreso_form in otros_ingresos_formset %}
      <div class="row align-items-end otros-ingreso-form mb-2 py-2 gx-2" style="background: #f8fafb; border-radius: 8px;">
        <div class="col-md-4">
          <label class="form-label mb-1">Tipo de ingreso</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-globe-americas text-muted"></i></span>
            {{ ingreso_form.tipo }}
          </div>
        </div>
        <div class="col-md-5">
          <label class="form-label mb-1">Descripción</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-align-left text-muted"></i></span>
            {{ ingreso_form.descripcion }}
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label mb-1">Monto</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-dollar-sign text-muted"></i></span>
            {{ ingreso_form.monto }}
          </div>
        </div>
        <div class="col-md-1 d-flex align-items-center justify-content-center pt-3">
          <button type="button" class="btn btn-danger btn-sm remove-otro-ingreso" title="Eliminar ingreso">
            <i class="fas fa-minus"></i>
          </button>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="text-end mt-2">
    <button type="button" class="btn btn-outline-success btn-sm" id="add-otro-ingreso">
      <i class="fas fa-plus"></i> Añadir otro ingreso
    </button>
  </div>
</div>

{# 3. Plantilla oculta basada en empty_form #}
<div id="otros-ingresos-empty-form" style="display: none;">
  <div class="row align-items-end otros-ingreso-form mb-2 py-2 gx-2" style="background: #f8fafb; border-radius: 8px;">
    <div class="col-md-4">
      <label class="form-label mb-1">Tipo de ingreso</label>
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-globe-americas text-muted"></i></span>
        {{ otros_ingresos_formset.empty_form.tipo }}
      </div>
    </div>
    <div class="col-md-5">
      <label class="form-label mb-1">Descripción</label>
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-align-left text-muted"></i></span>
        {{ otros_ingresos_formset.empty_form.descripcion }}
      </div>
    </div>
    <div class="col-md-2">
      <label class="form-label mb-1">Monto</label>
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-dollar-sign text-muted"></i></span>
        {{ otros_ingresos_formset.empty_form.monto }}
      </div>
    </div>
    <div class="col-md-1 d-flex align-items-center justify-content-center pt-3">
      <button type="button" class="btn btn-danger btn-sm remove-otro-ingreso" title="Eliminar ingreso">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggle = document.getElementById('otros_ingresos_toggle');
  const label = document.getElementById('otros_ingresos_label');
  const section = document.getElementById('otros-ingresos-section');
  const container = document.getElementById('otros-ingresos-forms');
  const addBtn = document.getElementById('add-otro-ingreso');
  const management = document.querySelector('[name$="-TOTAL_FORMS"]');
  let total = parseInt(management.value, 10);
  const max = 3;

  function refreshUI() {
    label.textContent = toggle.checked ? 'Sí' : 'No';
    section.style.display = toggle.checked ? 'block' : 'none';
    addBtn.style.display = total < max ? '' : 'none';
  }

  function addForm() {
    if (total >= max) return;
    const emptyForm = container.children[0].cloneNode(true);
    emptyForm.querySelectorAll('input, select').forEach(el => el.value = '');
    container.appendChild(emptyForm);
    total++;
    management.value = total;
    refreshUI();
  }

  function removeForm(button) {
    button.closest('.otros-ingreso-form').remove();
    total--;
    management.value = total;
    refreshUI();
  }

  // Listeners
  toggle.addEventListener('change', refreshUI);
  addBtn.addEventListener('click', addForm);
  container.addEventListener('click', e => {
    const btn = e.target.closest('.remove-otro-ingreso');
    if (btn) removeForm(btn);
  });

  // Estado inicial
  refreshUI();
});
</script>
