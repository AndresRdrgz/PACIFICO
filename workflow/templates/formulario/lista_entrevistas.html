{% extends 'base.html' %}
{% load static %}

{% block title %}Entrevistas Registradas{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-white">
  <div class="w-full max-w-7xl mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row items-center justify-between bg-gradient-to-r from-green-500 to-green-700 text-white rounded-2xl shadow mb-8 p-6">
      <div class="flex items-center gap-4">
        <i class="fa-solid fa-users text-4xl opacity-70"></i>
        <span class="text-3xl font-bold">{{ total_entrevistas }}</span>
        <span class="text-lg">Formulario de Datos generales registrados</span>
      </div>
      <div class="flex gap-2 mt-4 md:mt-0">
        <a href="{% url 'entrevista_cliente' %}" class="btn btn-pacifico flex items-center gap-2 bg-gradient-to-r from-green-500 to-green-700 text-white rounded-full font-semibold shadow px-5 py-2 hover:from-green-700 hover:to-green-900 transition">
          <i class="fa-solid fa-plus"></i> Nuevo Formulario
        </a>
        <a href="{% url 'descargar_entrevistas_excel' %}" class="btn flex items-center gap-2 bg-white text-green-700 border border-green-600 rounded-full font-semibold px-5 py-2 hover:bg-green-50 transition">
          <i class="fa-solid fa-file-excel"></i> Descargar Excel
        </a>
      </div>
    </div>

    <input type="text" id="searchInput" class="w-full rounded-full border border-green-300 text-green-900 px-6 py-3 text-lg mb-6 focus:ring-2 focus:ring-green-500 focus:border-green-500 placeholder:text-green-400 shadow" placeholder="üîé Buscar por nombre, c√©dula o correo...">

    {% if entrevistas %}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="entrevistasCards">
        {% for entrevista in entrevistas %}
        <div class="entrevista-card" 
             data-nombre="{{ entrevista.primer_nombre }} {{ entrevista.primer_apellido }}"
             data-cedula="{{ entrevista.provincia_cedula }}-{{ entrevista.tipo_letra }}-{{ entrevista.tomo_cedula }}-{{ entrevista.partida_cedula }}"
             data-email="{{ entrevista.email }}">
          <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-1 border border-green-100 h-full flex flex-col">
            <div class="flex items-center gap-3 bg-gradient-to-r from-green-500 to-green-700 text-white rounded-t-2xl px-6 py-4 font-bold text-lg">
              <i class="fa-solid fa-user-circle text-2xl"></i>
              {{ entrevista.primer_nombre }} {{ entrevista.primer_apellido }}
            </div>
            <div class="flex-1 bg-transparent rounded-b-2xl px-6 py-4">
              <div class="mb-2"><span class="font-semibold"><i class="fa-solid fa-id-card"></i> C√©dula:</span> <span>{{ entrevista.provincia_cedula }}-{{ entrevista.tipo_letra }}-{{ entrevista.tomo_cedula }}-{{ entrevista.partida_cedula }}</span></div>
              <div class="mb-2"><span class="font-semibold"><i class="fa-solid fa-envelope"></i> Correo:</span> <span>{{ entrevista.email }}</span></div>
              <div class="mb-2"><span class="font-semibold"><i class="fa-solid fa-mobile-screen"></i> Celular:</span> <span>{{ entrevista.telefono }}</span></div>
              <div class="mb-2"><span class="font-semibold"><i class="fa-solid fa-briefcase"></i> Producto:</span> <span class="producto-label">{{ entrevista.tipo_producto }}</span></div>
              <div class="mb-2"><span class="font-semibold"><i class="fa-solid fa-user-tie"></i> Oficial:</span> <span class="oficial-label">{{ entrevista.oficial }}</span></div>
              <div class="mb-2"><span class="font-semibold"><i class="fa-solid fa-calendar-days"></i> Fecha Entrevista:</span> <span>{{ entrevista.fecha_entrevista|date:"d/m/Y H:i" }}</span></div>
              {% if entrevista.completada_por_admin %}
              <div class="mb-2">
                <span class="badge bg-primary text-white rounded-pill">
                  <i class="fa-solid fa-user-gear"></i> Completada por Admin
                </span>
                <br><small class="text-muted">{{ entrevista.fecha_completada_admin|date:"d/m/Y H:i" }}</small>
              </div>
              {% endif %}
              <div class="mt-3 text-end">
                <a href="{% url 'descargar_entrevista_excel' entrevista.id %}" class="btn btn-outline-success btn-sm border border-green-600 text-green-700 rounded-full px-4 py-1 hover:bg-green-50 transition me-2">
                  <i class="fa-solid fa-file-excel"></i> Excel
                </a>
                <a href="{% url 'entrevista_admin' entrevista.id %}" class="btn btn-outline-primary btn-sm border border-blue-600 text-blue-700 rounded-full px-4 py-1 hover:bg-blue-50 transition me-2" target="_blank" title="Modo Administrador - Control de Calidad">
                  <i class="fa-solid fa-user-gear"></i> Admin
                </a>
                <button onclick="enviarAAAPX({{ entrevista.id }}, '{{ entrevista.primer_nombre }} {{ entrevista.primer_apellido }}')" class="btn btn-outline-warning btn-sm border border-yellow-600 text-yellow-700 rounded-full px-4 py-1 hover:bg-yellow-50 transition me-2" title="Enviar al Sistema Core APPX">
                  <i class="fa-solid fa-paper-plane"></i> APPX
                </button>
                <a href="{% url 'descargar_entrevista_pdf' entrevista.id %}" class="btn btn-outline-danger btn-sm border border-red-600 text-red-700 rounded-full px-4 py-1 hover:bg-red-50 transition">
                  <i class="fa-solid fa-file-pdf"></i> PDF
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info text-center mt-5">No hay entrevistas registradas a√∫n.</div>
    {% endif %}
  </input>
</div>

<script>
  // --- Buscador ---
  document.getElementById('searchInput').addEventListener('input', function() {
    const value = this.value.toLowerCase();
    document.querySelectorAll('.entrevista-card').forEach(function(card) {
      const nombre = card.getAttribute('data-nombre').toLowerCase();
      const cedula = card.getAttribute('data-cedula').toLowerCase();
      const email = card.getAttribute('data-email').toLowerCase();
      if (nombre.includes(value) || cedula.includes(value) || email.includes(value)) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });
  });

  // --- Funci√≥n para enviar entrevista a APPX ---
  function enviarAAAPX(entrevistaId, nombreCliente) {
    // Confirmar antes de enviar
    if (confirm(`¬øEst√° seguro que desea enviar la entrevista de ${nombreCliente} al sistema APPX Core?\n\nEsta acci√≥n enviar√° todos los datos de la entrevista al sistema central.`)) {
      
      // Deshabilitar el bot√≥n mientras se procesa
      const boton = event.target.closest('button');
      const textoOriginal = boton.innerHTML;
      boton.disabled = true;
      boton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
      
      // Obtener el token CSRF
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                       document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                       getCookie('csrftoken');
      
      // Hacer la petici√≥n AJAX
      fetch(`/workflow/api/entrevistas/${entrevistaId}/enviar-appx/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // √âxito
          alert(`‚úÖ √âXITO: ${data.message}\n\nTimestamp: ${data.timestamp}`);
          
          // Opcional: Marcar visualmente la entrevista como enviada
          const card = boton.closest('.entrevista-card');
          if (card) {
            const header = card.querySelector('.bg-gradient-to-r');
            if (header) {
              header.style.background = 'linear-gradient(to right, #10b981, #059669)';
              header.innerHTML += ' <span class="badge bg-success ms-2"><i class="fa-solid fa-paper-plane"></i> ENVIADO</span>';
            }
          }
          
        } else {
          // Error
          alert(`‚ùå ERROR: ${data.message}\n\nDetalles: ${data.error_details || 'No disponible'}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert(`‚ùå ERROR DE CONEXI√ìN: No se pudo enviar la entrevista.\n\nError t√©cnico: ${error.message}`);
      })
      .finally(() => {
        // Restaurar el bot√≥n
        boton.disabled = false;
        boton.innerHTML = textoOriginal;
      });
    }
  }

  // Funci√≥n auxiliar para obtener el CSRF token de las cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}



