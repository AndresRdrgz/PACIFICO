{% extends 'workflow/base.html' %}
{% load static %}
{% load workflow_filters %}

{% block title %}Negocios - Sistema de Workflow{% endblock %}



{% block content %}
<div class="mt-0 pt-0">
    {% if not no_access %}
    <!-- Header Estático - Sin Animaciones -->
    <div class="card mb-1" style="border: 1px solid #e0e0e0;">
        <div class="card-header"
            style="background: var(--verde-pacifico); padding: 12px 20px; border-radius: 0; border: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-white fw-bold">
                        <i class="fas fa-briefcase me-2"></i>
                        {% if pipeline %}{{ pipeline.nombre }}{% else %}Pipeline de Negocio{% endif %}
                    </h1>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Selector de Pipeline -->
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownPipeline"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-project-diagram me-1"></i>
                            Pipelines
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownPipeline" style="z-index: 9999;">
                            {% for p in pipelines %}
                            <li>
                                <a class="dropdown-item {% if pipeline and p.id == pipeline.id %}active{% endif %}"
                                    href="?pipeline={{ p.id }}&view={{ request.GET.view|default:'table' }}">
                                    {{ p.nombre }}
                                </a>
                            </li>
                            {% empty %}
                            <li><span class="dropdown-item-text text-muted">No hay pipelines disponibles</span></li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Botones de cambio de vista -->
                    <div class="btn-group" role="group" aria-label="Cambiar vista">
                        <button type="button" class="btn btn-light btn-sm active" id="btnVistaTabla"
                            onclick="cambiarVista('table')">
                            <i class="fas fa-table me-1"></i>
                            Tabla
                        </button>
                        <button type="button" class="btn btn-outline-light btn-sm" id="btnVistaKanban"
                            onclick="cambiarVista('kanban')">
                            <i class="fas fa-columns me-1"></i>
                            Kanban
                        </button>
                    </div>

                    <!-- Botón APC Tracking -->
                    <a href="{% url 'workflow:apc_tracking' %}" class="btn btn-info btn-sm" title="Tracking APC Makito">
                        <i class="fas fa-robot me-1"></i>
                        APC Tracking
                    </a>

                    {% if pipeline %}
                    <a href="#" class="btn btn-light btn-sm"
                        onclick="openSolicitudDrawerWithContext('{{ pipeline.id }}')">
                        <i class="fas fa-plus me-1"></i>Nueva Solicitud
                    </a>
                    {% else %}
                    <a href="#" class="btn btn-light btn-sm" onclick="openSolicitudDrawerWithContext()">
                        <i class="fas fa-plus me-1"></i>Nueva Solicitud
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if no_access %}
    <!-- Mensaje de acceso denegado -->
    <div class="card">
        <div class="card-body text-center py-5">
            <div class="mb-4">
                <i class="fas fa-lock fa-4x text-muted mb-3"></i>
                <h3 class="text-muted mb-3">Acceso Restringido</h3>
                {% if error_message %}
                <p class="text-muted mb-4">{{ error_message }}</p>
                {% else %}
                <p class="text-muted mb-4">No tienes acceso a ningún pipeline en el sistema de workflow.</p>
                {% endif %}
            </div>

            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>¿Cómo obtener acceso?</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-user-tie me-2 text-primary"></i>Contacta a tu Administrador
                                    </h6>
                                    <p class="small text-muted">Solicita que te asignen permisos para acceder a los
                                        pipelines necesarios para tu trabajo.</p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-users me-2 text-success"></i>Únete a un Grupo</h6>
                                    <p class="small text-muted">Pregunta si existe un grupo de usuarios con acceso a los
                                        pipelines que necesitas.</p>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-cog me-2 text-warning"></i>Configuración de Permisos</h6>
                                    <p class="small text-muted">Los permisos se configuran en la sección de
                                        administración del sistema.</p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-question-circle me-2 text-info"></i>¿Necesitas ayuda?</h6>
                                    <p class="small text-muted">Contacta al equipo de soporte técnico si tienes dudas
                                        sobre el acceso.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <a href="{% url 'workflow:dashboard' %}" class="btn btn-primary me-2">
                    <i class="fas fa-tachometer-alt me-2"></i>Ir al Dashboard
                </a>
                <a href="{% url 'main_menu' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-home me-2"></i>Menú Principal
                </a>
            </div>
        </div>
    </div>
    {% else %}

    {% if pipeline %}
    <!-- KPIs Estáticos en Fila Horizontal -->
    <div class="card mb-1" id="kpis-section" style="border: 1px solid #e0e0e0;">
        <div class="card-body py-2">
            <div class="row g-2">
                <div class="col-3">
                    <div class="kpi-card-compact kpi-total">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Total</p>
                            <h4 class="kpi-number-compact">{{ page_obj.paginator.count }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-activas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Activas</p>
                            <h4 class="kpi-number-compact">{{ solicitudes|filter_activas|length }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-completadas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Completadas</p>
                            <h4 class="kpi-number-compact">{{ solicitudes|filter_completadas|length }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-vencidas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Vencidas</p>
                            <h4 class="kpi-number-compact">{{ solicitudes|filter_vencidas|length }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if pipeline %}
    {% if view_type == 'table' %}

    <!-- Leyenda SLA Compacta -->
    <small class="text-muted mb-2 d-block" style="font-size: 0.7rem;">
        <i class="fas fa-info-circle me-1"></i>Leyenda SLA:
        <i class="fas fa-circle text-success me-1 ms-2" style="font-size: 0.5rem;"></i>En tiempo
        <i class="fas fa-circle text-warning me-1 ms-2" style="font-size: 0.5rem;"></i>Por vencer
        <i class="fas fa-circle text-danger me-1 ms-2" style="font-size: 0.5rem;"></i>Vencido
    </small>

    <!-- Vista Móvil Mejorada: Solo visible en pantallas pequeñas -->
    <div class="vista-movil d-block d-sm-none">
        <!-- Barra de búsqueda móvil -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4 border">
            <div class="relative">
                <input type="text" id="busquedaMovil"
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Buscar por código, cliente o cédula...">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Tarjetas de solicitudes -->
        <div class="space-y-4" id="solicitudesMovil">
            {% for s in solicitudes_tabla %}
            <div class="solicitud-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow duration-200"
                data-prioridad="{{ s.prioridad|lower }}" data-estado="{{ s.sla_color }}"
                data-asignado="{% if s.asignado_a == 'Sin asignar' %}sin_asignar{% else %}asignado{% endif %}"
                data-search="{{ s.codigo|lower }} {{ s.cliente|lower }} {{ s.cedula|lower }}">

                <!-- Header de la tarjeta -->
                <div class="p-4 pb-3">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <!-- Indicador de SLA -->
                            <div class="w-3 h-3 rounded-full 
                                    {% if s.sla_color == 'text-danger' %}bg-red-500
                                    {% elif s.sla_color == 'text-warning' %}bg-yellow-500
                                    {% elif s.sla_color == 'text-success' %}bg-green-500
                                    {% else %}bg-gray-400{% endif %}">
                            </div>
                            <h3 class="text-lg font-bold text-gray-900">{{ s.codigo }}</h3>
                        </div>
                        <div class="flex items-center space-x-2">
                            <!-- Badge de prioridad -->
                            {% if s.prioridad %}
                            <span class="px-2 py-1 rounded-full text-xs font-semibold
                                    {% if s.prioridad == 'Alta' %}bg-red-100 text-red-800
                                    {% elif s.prioridad == 'Media' %}bg-yellow-100 text-yellow-800
                                    {% elif s.prioridad == 'Baja' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ s.prioridad }}
                            </span>
                            {% endif %}
                            <!-- Menú de opciones -->
                            <div class="relative">
                                <button class="p-1 rounded-full hover:bg-gray-100 transition-colors"
                                    onclick="toggleMenu(this)">
                                    <i class="fas fa-ellipsis-v text-gray-400"></i>
                                </button>
                                <div
                                    class="menu-dropdown absolute right-0 top-8 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10 hidden min-w-40">
                                    <span class="block px-4 py-2 text-sm text-gray-400 cursor-not-allowed">
                                        <i class="fas fa-eye mr-2"></i>Ver Detalle
                                    </span>
                                    <a href="{% url 'workflow:transicion_solicitud' s.id %}"
                                        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                        <i class="fas fa-arrow-right mr-2"></i>Cambiar Etapa
                                    </a>
                                    {% if s.acciones.eliminar %}
                                    <button onclick="eliminarSolicitud('{{ s.id }}')"
                                        class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                        <i class="fas fa-trash mr-2"></i>Eliminar
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información principal -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Cliente</p>
                            <p class="text-sm font-semibold text-gray-900 truncate">
                                <a href="{% url 'workflow:detalle_solicitud' s.id %}"
                                    class="text-decoration-none text-success solicitud-link"
                                    title="Ver detalles de {{ s.cliente_nombre }}" onclick="event.stopPropagation();">
                                    {{ s.cliente_nombre }}
                                </a>
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Monto</p>
                            <p class="text-sm font-bold text-green-600">{{ s.monto_formateado }}</p>
                        </div>
                    </div>

                    <!-- Información secundaria -->
                    <div class="space-y-2 mb-3">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Cédula:</span>
                            <span class="text-gray-900 font-medium">{{ s.cliente_cedula }}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Producto:</span>
                            <span class="text-gray-900 font-medium truncate ml-2">{{ s.producto_descripcion }}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Propietario:</span>
                            <div class="flex items-center space-x-1">
                                {% if s.propietario_user %}
                                    {% if s.propietario_user.userprofile and s.propietario_user.userprofile.profile_picture %}
                                    <img src="{{ s.propietario_user.userprofile.profile_picture.url }}"
                                        alt="{{ s.propietario_user.get_full_name|default:s.propietario_user.username }}"
                                        class="w-4 h-4 rounded-full object-cover border">
                                    {% else %}
                                    <div
                                        class="w-4 h-4 bg-gray-300 rounded-full flex items-center justify-center text-xs font-medium text-gray-600">
                                        {{
                                        s.propietario_user.first_name|first|default:s.propietario_user.username|first|upper
                                        }}
                                    </div>
                                    {% endif %}
                                    <span class="text-gray-900 font-medium truncate text-xs">{{ s.propietario }}</span>
                                {% else %}
                                    <div
                                        class="w-4 h-4 bg-gray-200 rounded-full flex items-center justify-center text-xs font-medium text-gray-500">
                                        <i class="fas fa-user-slash"></i>
                                    </div>
                                    <span class="text-gray-500 font-medium truncate text-xs">{{ s.propietario }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Asignación -->
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs text-gray-500 uppercase tracking-wide font-medium">Asignado a</span>
                        {% if s.asignado_a != 'Sin asignar' and s.asignado_a_user %}
                        <div class="flex items-center space-x-1">
                            {% if s.asignado_a_user.userprofile and s.asignado_a_user.userprofile.profile_picture %}
                            <img src="{{ s.asignado_a_user.userprofile.profile_picture.url }}"
                                alt="{{ s.asignado_a_user.get_full_name|default:s.asignado_a_user.username }}"
                                class="w-4 h-4 rounded-full object-cover border">
                            {% else %}
                            <div
                                class="w-4 h-4 bg-blue-100 rounded-full flex items-center justify-center text-xs font-medium text-blue-600">
                                {{ s.asignado_a_user.first_name|first|default:s.asignado_a_user.username|first|upper }}
                            </div>
                            {% endif %}
                            <span class="text-sm font-medium text-gray-900 truncate">{{ s.asignado_a }}</span>
                        </div>
                        {% else %}
                        <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">
                            <i class="fas fa-user-slash mr-1"></i>Sin asignar
                        </span>
                        {% endif %}
                    </div>

                    <!-- Etapa y Estado -->
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Etapa</p>
                            {% if s.etapa %}
                            <span
                                class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                {{ s.etapa }}
                            </span>
                            {% endif %}
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Estado</p>
                            <span
                                class="inline-block px-2 py-1 bg-{{ s.estado_color }} text-white rounded-full text-xs font-medium">
                                {{ s.estado_actual }}
                            </span>
                        </div>
                    </div>

                    <!-- Etiquetas -->
                    {% if s.etiquetas_oficial %}
                    <div class="mb-3">
                        <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Etiquetas</p>
                        <span
                            class="inline-block px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                            {{ s.etiquetas_oficial }}
                        </span>
                        {% if s.origen == 'Canal Digital' %}
                        <span class="badge bg-info ms-1" style="font-size: 0.65rem;"
                            title="Solicitud del Canal Digital">
                            <i class="fas fa-mobile-alt me-1"></i>Digital
                        </span>
                        {% endif %}
                    </div>
                    {% else %}
                    {% if s.origen == 'Canal Digital' %}
                    <div class="mb-3">
                        <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Etiquetas</p>
                        <span class="badge bg-info" style="font-size: 0.65rem;" title="Solicitud del Canal Digital">
                            <i class="fas fa-mobile-alt me-1"></i>Digital
                        </span>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>

                <!-- Footer con SLA y fechas -->
                <div class="px-4 py-3 bg-gray-50 border-t border-gray-100">
                    <div class="flex items-center justify-between text-xs">
                        <div class="flex items-center space-x-4">
                            <div>
                                <span class="text-gray-500">Creado:</span>
                                <span class="text-gray-900 font-medium">{{ s.fecha_inicio }}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">SLA:</span>
                                <span class="font-medium {{ s.sla_color }}">{{ s.sla_restante }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="p-4 pt-3 bg-gray-50">
                    <div class="flex space-x-2">
                        <a href="{% url 'workflow:detalle_solicitud' s.id %}"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-eye mr-1"></i>Ver
                        </a>
                        <a href="{% url 'workflow:transicion_solicitud' s.id %}"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-arrow-right mr-1"></i>Etapa
                        </a>
                        {% if s.acciones.eliminar %}
                        <button onclick="eliminarSolicitud('{{ s.id }}')"
                            class="bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-inbox text-gray-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay solicitudes</h3>
                <p class="text-gray-500">No se encontraron solicitudes que coincidan con los filtros aplicados.</p>
            </div>
            {% endfor %}
        </div>

        <!-- Paginación móvil -->
        {% if page_obj.has_other_pages %}
        <div class="mt-6 flex justify-center">
            <nav class="flex items-center space-x-1">
                {% if page_obj.has_previous %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}"
                    class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {% endif %}

                <span class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-gray-300">
                    {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}"
                    class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </div>

    <!-- Tabla Desktop Mejorada con Vanilla JavaScript -->
    <div class="vista-desktop d-none d-sm-block">
        <!-- Table Container with Filters and Table in Same Container -->
        <div class="apc-table-container"
            style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
                <h4 class="section-title" style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #333;">
                    <i class="fas fa-list"></i> Solicitudes
                </h4>
                <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                    <!-- Quick Search Bar -->
                    <div class="search-container" style="position: relative; min-width: 300px;">
                        <input type="text" id="quickTableSearch"
                            placeholder="Buscar por cliente, producto, propietario, código..."
                            style="width: 100%; padding: 12px 16px 12px 45px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s ease; background: white; color: #333;"
                            oninput="handleQuickSearch()">
                        <i class="fas fa-search"
                            style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #64748b; pointer-events: none;"></i>
                        <button id="clearQuickSearch" onclick="handleClearSearch()"
                            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #64748b; cursor: pointer; padding: 4px; border-radius: 50%; transition: all 0.2s ease; display: none;"
                            title="Limpiar búsqueda">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Compact Filters -->
                    <div class="filter-group" style="margin: 0;">
                        <select id="filtroEtapa" onchange="applyFilters()"
                            style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white; color: #333; min-width: 140px;"
                            title="Filtrar por etapa">
                            <option value="">Todas las etapas</option>
                        </select>
                    </div>
                    <div class="filter-group" style="margin: 0;">
                        <select id="filtroSLA" onchange="applyFilters()"
                            style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white; color: #333; min-width: 120px;"
                            title="Filtrar por SLA">
                            <option value="">Todos los SLA</option>
                        </select>
                    </div>
                    <div class="filter-group" style="margin: 0;">
                        <select id="filtroAsignado" onchange="applyFilters()"
                            style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white; color: #333; min-width: 140px;"
                            title="Filtrar por asignado">
                            <option value="">Todos los asignados</option>
                        </select>
                    </div>
                    <div class="filter-group" style="margin: 0;">
                        <select id="filtroPrioridad" onchange="applyFilters()"
                            style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white; color: #333; min-width: 120px;"
                            title="Filtrar por prioridad">
                            <option value="">Todas las prioridades</option>
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <button class="refresh-btn" onclick="clearFilters()"
                        style="padding: 8px 12px; font-size: 0.875rem; background: linear-gradient(135deg, #2d5a2d, #1e5f2a); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);"
                        title="Limpiar filtros">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </div>

            <!-- Search Results Count -->
            <small class="text-muted" id="searchResultCount"
                style="display: none; font-size: 0.875rem; margin-bottom: 16px;">
                <span id="resultCount">0</span> resultados encontrados
            </small>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading" style="display: none;">
                <div class="spinner"></div>
                <span>Cargando datos...</span>
            </div>

            <!-- Table Container -->
            <div id="tableContainer" class="table-responsive" style="position: relative; display: block;">
                <!-- Scroll indicators -->
                <div class="table-scroll-indicator left" id="scrollLeftIndicator">
                    <i class="fas fa-chevron-left"></i>
                </div>
                <div class="table-scroll-indicator right" id="scrollRightIndicator">
                    <i class="fas fa-chevron-right"></i>
                </div>

                <table class="workflow-table apc-table" id="tablaSolicitudes">
                    <thead>
                        <tr>
                            <th style="width: 200px;">Cliente</th>
                            <th style="width: 150px;">Producto</th>
                            <th style="width: 120px;">Monto</th>
                            <th style="width: 150px;">Propietario</th>
                            <th style="width: 120px;">Etapa</th>
                            <th style="width: 100px;">Estado</th>
                            <th style="width: 200px;">Fecha SLA</th>
                            <th style="width: 120px;">SLA</th>
                            <th style="width: 120px;">Etiquetas</th>
                            <th style="width: 100px;">Prioridad</th>
                            <th style="width: 120px;">Código</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in solicitudes_tabla %}
                        <tr class="align-middle table-row-hover clickable-row {% if s.sla_color == 'text-danger' %}bg-danger bg-opacity-10{% endif %}"
                            data-solicitud-id="{{ s.id }}" data-etapa="{{ s.etapa_actual.nombre|default:'Sin etapa' }}"
                            data-sla="{% if s.sla_color == 'text-danger' %}vencido{% elif s.sla_color == 'text-warning' %}por vencer{% elif s.sla_color == 'text-success' %}en tiempo{% else %}sin sla{% endif %}"
                            onclick="handleRowClick(event, {{ s.id }})" style="cursor: pointer;">
                            <td class="text-dark">
                                <div>
                                    <div class="fw-semibold">
                                        <a href="#"
                                            class="text-decoration-none text-success solicitud-link"
                                            title="Ver detalles de {{ s.cliente_nombre }}"
                                            onclick="event.stopPropagation();">
                                            {{ s.cliente_nombre }}
                                        </a>
                                    </div>
                                    <small class="text-muted">{{ s.cliente_cedula }}</small>
                                </div>
                            </td>
                            <td class="text-dark">{{ s.producto_descripcion }}</td>
                            <td><span class="fw-bold text-success">{{ s.monto_formateado }}</span></td>
                            <td class="text-dark">
                                <div class="d-flex align-items-center">
                                    {% if s.propietario_user %}
                                        {% if s.propietario_user.userprofile and s.propietario_user.userprofile.profile_picture %}
                                        <img src="{{ s.propietario_user.userprofile.profile_picture.url }}"
                                            alt="{{ s.propietario_user.get_full_name|default:s.propietario_user.username }}"
                                            class="me-2 rounded-circle object-cover border"
                                            style="width: 24px; height: 24px; object-fit: cover;">
                                        {% else %}
                                        <div class="me-2 rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
                                            style="width: 24px; height: 24px; background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)); font-size: 0.7rem;">
                                            {{ s.propietario_user.first_name|first|default:s.propietario_user.username|first|upper }}
                                        </div>
                                        {% endif %}
                                        <span class="small">{{ s.propietario|default:"Sin propietario" }}</span>
                                    {% else %}
                                        <div class="me-2 rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
                                            style="width: 24px; height: 24px; background: linear-gradient(135deg, #6c757d, #495057); font-size: 0.7rem;">
                                            ?
                                        </div>
                                        <span class="small">{{ s.propietario|default:"Sin propietario" }}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if s.etapa_actual and s.etapa_actual.es_bandeja_grupal %}
                                <!-- Solicitud en bandeja grupal - deshabilitar cambio de etapa -->
                                <div class="position-relative">
                                    <select class="form-select form-select-sm etapa-select"
                                        data-solicitud-id="{{ s.id }}"
                                        data-etapa-actual="{{ s.etapa_actual.id|default:'' }}"
                                        style="min-width: 120px; opacity: 0.6; cursor: not-allowed;" disabled
                                        title="Esta solicitud está en bandeja grupal. Debes esperar a que el equipo la procese antes de poder cambiar la etapa.">
                                        <option value="{{ s.etapa_actual.id }}" selected>
                                            {{ s.etapa_actual.nombre }}
                                        </option>
                                    </select>
                                    <!-- Tooltip informativo -->
                                    <div class="position-absolute top-0 start-100 ms-2" style="z-index: 1000;">
                                        <i class="fas fa-info-circle text-warning" data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="⏳ Bandeja Grupal: Esta solicitud está siendo revisada por el equipo. Debes esperar a que sea asignada o procesada antes de poder cambiar la etapa."></i>
                                    </div>
                                </div>
                                {% else %}
                                <!-- Solicitud normal - permitir cambio de etapa -->
                                <select class="form-select form-select-sm etapa-select" data-solicitud-id="{{ s.id }}"
                                    data-etapa-actual="{{ s.etapa_actual.id|default:'' }}" style="min-width: 120px;">
                                    {% if not s.etapa %}
                                    <option value="" selected>Sin etapa</option>
                                    {% endif %}
                                    {% for etapa in pipeline.etapas.all %}
                                    <option value="{{ etapa.id }}" {% if s.etapa == etapa.nombre %}selected{% endif %}>
                                        {{ etapa.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-1">
                                    <span class="badge bg-{{ s.estado_color }}">{{ s.estado_actual }}</span>
                                    {% if s.etapa_actual and s.etapa_actual.es_bandeja_grupal %}
                                    <span class="badge bg-warning" title="Bandeja Grupal - En revisión por el equipo">
                                        <i class="fas fa-users"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-dark" style="max-width: 200px;">
                                <div style="line-height: 1.3;">
                                    <div class="d-flex align-items-center mb-1">
                                        <small class="text-muted me-1" style="min-width: 25px;">Ini:</small>
                                        <span style="font-size: 0.85rem;">{{ s.fecha_inicio|date:"d/m" }}</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted me-1" style="min-width: 25px;">Ven:</small>
                                        <span style="font-size: 0.85rem;">{{ s.fecha_vencimiento|date:"d/m" }}</span>
                                        <span class="text-muted" style="font-size: 0.75rem;">{% if s.vencimiento_sla %}{{ s.vencimiento_sla|date:"d/m" }}{% else %}N/A{% endif %}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="text-center">
                                    <div class="{{ s.sla_color }} fw-bold" title="Tiempo restante">
                                        {{ s.sla_restante }}
                                    </div>
                                    <small class="text-muted">
                                        {% if s.sla_color == 'text-success' %}En tiempo
                                        {% elif s.sla_color == 'text-warning' %}Por vencer
                                        {% elif s.sla_color == 'text-danger' %}Vencido
                                        {% else %}N/A{% endif %}
                                    </small>
                                </div>
                            </td>
                            <td>
                                <select class="etiquetas-select form-control form-control-sm" data-id="{{ s.id }}"
                                    style="min-width: 115px; width: 115px;">
                                    <option value="">Seleccionar etiqueta</option>
                                    <option value="no_responde" {% if s.etiquetas_oficial == 'no_responde' %}selected{% endif %}>📞 No responde</option>
                                    <option value="cita_agendada" {% if s.etiquetas_oficial == 'cita_agendada' %}selected{% endif %}>🗓️ Cita agendada</option>
                                    <option value="doc_completo" {% if s.etiquetas_oficial == 'doc_completo' %}selected{% endif %}>✅ Documentos completos</option>
                                    <option value="falta_carta" {% if s.etiquetas_oficial == 'falta_carta' %}selected{% endif %}>📎 Falta carta trabajo</option>
                                    <option value="seguimiento_48h" {% if s.etiquetas_oficial == 'seguimiento_48h' %}selected{% endif %}>🔄 Seguimiento en 48h</option>
                                    <option value="whatsapp_activo" {% if s.etiquetas_oficial == 'whatsapp_activo' %}selected{% endif %}>💬 WhatsApp activo</option>
                                    <option value="cliente_indeciso" {% if s.etiquetas_oficial == 'cliente_indeciso' %}selected{% endif %}>⚠️ Cliente indeciso</option>
                                    <option value="cliente_caliente" {% if s.etiquetas_oficial == 'cliente_caliente' %}selected{% endif %}>🚀 Cliente caliente</option>
                                    <option value="esperando_confirm" {% if s.etiquetas_oficial == 'esperando_confirm' %}selected{% endif %}>🕐 Esperando confirmación</option>
                                    <option value="enviado_credito" {% if s.etiquetas_oficial == 'enviado_credito' %}selected{% endif %}>🧾 Enviado a crédito</option>
                                    <option value="en_validacion" {% if s.etiquetas_oficial == 'en_validacion' %}selected{% endif %}>🔒 En validación</option>
                                    <option value="caso_descartado" {% if s.etiquetas_oficial == 'caso_descartado' %}selected{% endif %}>❌ Caso descartado</option>
                                </select>
                            </td>
                            <td>
                                <select class="prioridad-select border rounded px-2 py-1 text-xs w-full"
                                    data-id="{{ s.id }}"
                                    style="background-color: {% if s.prioridad == 'Alta' %}#fee2e2{% elif s.prioridad == 'Media' %}#fef9c3{% elif s.prioridad == 'Baja' %}#dcfce7{% else %}white{% endif %}; color: {% if s.prioridad == 'Alta' %}#b91c1c{% elif s.prioridad == 'Media' %}#b45309{% elif s.prioridad == 'Baja' %}#166534{% else %}#333{% endif %};">
                                    <option value="">-</option>
                                    {% for prioridad in prioridades_posibles %}
                                    <option value="{{ prioridad }}" {% if s.prioridad == prioridad %}selected{% endif %}>
                                        {{ prioridad }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <div class="text-center">
                                    <span class="badge bg-secondary text-white fw-bold" style="font-size: 0.75rem;">
                                        {{ s.codigo|default:"N/A" }}
                                    </span>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No hay solicitudes para mostrar</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Scroll hint -->
                <div class="scroll-hint" id="scrollHint">
                    <i class="fas fa-arrows-alt-h"></i> Desliza para ver más columnas
                </div>
            </div>

            <!-- No Data Message -->
            <div id="noDataMessage" class="no-data" style="display: none;">
                <i class="fas fa-inbox"></i>
                <p>No se encontraron solicitudes con los filtros aplicados</p>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Vista Kanban Mejorada -->

    <!-- Filtros Compactos para Kanban -->
    <div class="card card-custom mb-2">
        <div class="card-body py-2">
            <div class="row g-1 align-items-center">
                <div class="col-6 col-md-3">
                    <select id="kanbanFiltroEtapa" class="form-select form-select-sm">
                        <option value="">Todas las etapas</option>
                    </select>
                </div>
                <div class="col-6 col-md-3">
                    <select id="kanbanFiltroSLA" class="form-select form-select-sm">
                        <option value="">Todos los SLA</option>
                    </select>
                </div>
                <div class="col-12 col-md-5">
                    <input type="text" id="kanbanBusquedaGlobal" class="form-control form-control-sm"
                        placeholder="Buscar...">
                </div>
                <div class="col-12 col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-info w-100" id="kanbanLimpiarFiltros">
                        <i class="fas fa-filter-circle-xmark"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor Kanban con scroll horizontal -->
    <div class="kanban-container" style="height: calc(100vh - 280px); overflow-y: hidden; min-height: 700px;">
        <div class="kanban-board d-flex" style="overflow-x: auto; gap: 0.75rem; padding-bottom: 1rem;">
            {% for etapa in pipeline.etapas.all %}
            <div class="kanban-column" style="min-width: 320px; width: 320px; flex-shrink: 0;">
                <div class="card shadow h-100"
                    style="border: 2px solid #e9ecef; border-radius: 12px; background: #ffffff;">
                    <!-- Header de etapa con búsqueda -->
                    <div class="card-header text-white"
                        style="background: #28a745; border-radius: 12px 12px 0 0; border: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-bold text-white">
                                <i class="fas fa-list-ul me-2 text-white"></i>
                                {{ etapa.nombre }}
                            </h6>
                            <span class="badge bg-white text-success fw-bold" id="count-etapa-{{ etapa.id }}">
                                {{ solicitudes_por_etapa|get_item:etapa.id|length }}
                            </span>
                        </div>
                        <input type="text" class="form-control form-control-sm etapa-search"
                            placeholder="Buscar en {{ etapa.nombre }}..." data-etapa-id="{{ etapa.id }}"
                            style="background: rgba(255,255,255,0.9); border: none;">
                    </div>

                    <!-- Cuerpo de etapa con scroll -->
                    <div class="card-body p-3 kanban-column-body"
                        style="height: calc(100vh - 380px); overflow-y: auto; background: #f8f9fa;"
                        data-etapa-id="{{ etapa.id }}">

                        {% for s in solicitudes_por_etapa|get_item:etapa.id %}
                        <div class="kanban-card mb-3" draggable="true" data-solicitud-id="{{ s.id }}"
                            data-etapa-id="{{ etapa.id }}" data-cliente="{{ s.cliente_nombre|default:'Sin cliente' }}"
                            data-estado="{{ s.estado_actual|default:'Sin estado' }}"
                            data-asignado="{{ s.asignado_a|default:'Sin asignar' }}"
                            data-sla="{% if s.sla_color == 'text-danger' %}vencido{% elif s.sla_color == 'text-warning' %}por vencer{% elif s.sla_color == 'text-success' %}en tiempo{% else %}sin sla{% endif %}"
                            data-search="{{ s.codigo|lower }} {{ s.cliente_nombre|lower }}" data-codigo="{{ s.codigo }}"
                            data-monto="{{ s.monto_formateado }}"
                            data-fecha-inicio="{{ s.fecha_inicio_str|default:s.fecha_inicio }}"
                            data-sla-texto="{{ s.sla_restante }}" style="cursor: grab;">

                            <div class="card shadow-sm border-0"
                                style="border-left: 4px solid {% if s.sla_color == 'text-danger' %}#dc3545{% elif s.sla_color == 'text-warning' %}#ffc107{% elif s.sla_color == 'text-success' %}#198754{% else %}#6c757d{% endif %} !important; height: 110px; border-radius: 6px; transition: all 0.3s ease; background: white; cursor: pointer;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.15)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'"
                                onclick="window.location.href='{% url 'workflow:detalle_solicitud' s.id %}'">
                                <div class="card-body p-2" style="height: 100%;">
                                    <!-- Header compacto -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <h6 class="mb-0" style="font-size: 0.9rem;">
                                                <i class="fas fa-user text-muted me-1"
                                                    style="font-size: 0.75rem; width: 12px;"></i>
                                                <a href="{% url 'workflow:detalle_solicitud' s.id %}"
                                                    class="text-decoration-none fw-bold text-success solicitud-link-kanban"
                                                    title="Ver detalles de {{ s.cliente_nombre }}"
                                                    onclick="event.stopPropagation();">
                                                    {{ s.cliente_nombre|truncatechars:15 }}
                                                </a>
                                            </h6>
                                            <small class="text-muted" style="font-size: 0.65rem;">{{ s.codigo }}</small>
                                        </div>

                                        <!-- Timer y Status -->
                                        <div class="text-end">
                                            <div class="d-flex align-items-center justify-content-end mb-1">
                                                <i class="fas fa-clock text-muted me-1"
                                                    style="font-size: 0.75rem; width: 12px;"></i>
                                                <span class="{{ s.sla_color }} fw-bold" style="font-size: 0.7rem;">{{
                                                    s.sla_restante }}</span>
                                            </div>
                                            <span class="badge bg-{{ s.estado_color }}"
                                                style="font-size: 0.6rem; padding: 2px 5px;">{{ s.estado_actual
                                                }}</span>
                                        </div>
                                    </div>

                                    <!-- Contenido en 2 columnas -->
                                    <div class="row g-1">
                                        <!-- Columna izquierda -->
                                        <div class="col-7">
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="text-success fw-bold" style="font-size: 0.75rem;">{{
                                                    s.monto_formateado }}</span>
                                            </div>

                                            {% if s.asignado_a != 'Sin asignar' and s.asignado_a_user %}
                                            <div class="d-flex align-items-center">
                                                {% if s.asignado_a_user.userprofile and s.asignado_a_user.userprofile.profile_picture %}
                                                <img src="{{ s.asignado_a_user.userprofile.profile_picture.url }}"
                                                    alt="{{ s.asignado_a_user.get_full_name|default:s.asignado_a_user.username }}"
                                                    class="w-4 h-4 rounded-full object-cover me-1">
                                                {% else %}
                                                <div
                                                    class="w-4 h-4 bg-blue-100 rounded-full flex items-center justify-center text-xs font-medium text-blue-600 me-1">
                                                    {{
                                                    s.asignado_a_user.first_name|first|default:s.asignado_a_user.username|first|upper
                                                    }}
                                                </div>
                                                {% endif %}
                                                <span style="font-size: 0.7rem; color: #6c757d;">{{
                                                    s.asignado_a|truncatechars:10 }}</span>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- Columna derecha -->
                                        <div class="col-5 text-end">
                                            <div class="d-flex align-items-center justify-content-end">
                                                {% if s.origen == 'Canal Digital' %}
                                                <span class="badge bg-info me-1" style="font-size: 0.55rem;"
                                                    title="Solicitud del Canal Digital">
                                                    <i class="fas fa-mobile-alt"></i>
                                                </span>
                                                {% endif %}
                                                {% if s.prioridad %}
                                                <span class="badge me-1"
                                                    style="font-size: 0.55rem; padding: 1px 4px; background-color: {% if s.prioridad == 'Alta' %}#fee2e2{% elif s.prioridad == 'Media' %}#fef9c3{% elif s.prioridad == 'Baja' %}#dcfce7{% else %}white{% endif %}; color: {% if s.prioridad == 'Alta' %}#b91c1c{% elif s.prioridad == 'Media' %}#b45309{% elif s.prioridad == 'Baja' %}#166534{% else %}#333{% endif %};">
                                                    {{ s.prioridad }}
                                                </span>
                                                {% endif %}
                                                <small class="text-muted" style="font-size: 0.65rem;">{{ s.fecha_inicio
                                                    }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox text-muted mb-2"></i>
                            <p class="text-muted small">Sin solicitudes</p>
                        </div>
                        {% endfor %}

                        <!-- Mensaje cuando no hay solicitudes -->
                        <div class="no-solicitudes text-center py-4" style="display: none;">
                            <i class="fas fa-inbox text-muted mb-2"></i>
                            <p class="text-muted small">Sin solicitudes</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Instrucciones para seleccionar un Pipeline -->
    <div class="card mb-4"
        style="border: 2px solid #e3f2fd; background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);">
        <div class="card-body text-center py-4">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="mb-4">
                        <div
                            style="width: 80px; height: 80px; background: linear-gradient(135deg, #2196f3, #1976d2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 8px 24px rgba(33, 150, 243, 0.3);">
                            <i class="fas fa-project-diagram text-white" style="font-size: 2rem;"></i>
                        </div>
                        <h3 class="text-primary fw-bold mb-3">Selecciona un Pipeline</h3>
                        <p class="text-muted mb-4" style="font-size: 1.1rem;">Para comenzar a gestionar solicitudes,
                            elige uno de los pipelines disponibles a continuación.</p>
                    </div>

                    <div class="row justify-content-center mb-4">
                        <div class="col-md-4">
                            <div class="bg-white rounded-lg p-3 shadow-sm border">
                                <i class="fas fa-table text-primary mb-2" style="font-size: 1.5rem;"></i>
                                <h6 class="fw-bold text-dark mb-2">Vista de Tabla</h6>
                                <p class="text-muted small mb-0">Organiza las solicitudes en una tabla con filtros
                                    avanzados y búsqueda.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-white rounded-lg p-3 shadow-sm border">
                                <i class="fas fa-columns text-success mb-2" style="font-size: 1.5rem;"></i>
                                <h6 class="fw-bold text-dark mb-2">Vista Kanban</h6>
                                <p class="text-muted small mb-0">Visualiza el flujo de trabajo con columnas organizadas
                                    por etapas.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-white rounded-lg p-3 shadow-sm border">
                                <i class="fas fa-chart-line text-warning mb-2" style="font-size: 1.5rem;"></i>
                                <h6 class="fw-bold text-dark mb-2">KPIs y Métricas</h6>
                                <p class="text-muted small mb-0">Monitorea el rendimiento y el progreso de las
                                    solicitudes.</p>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info border-0"
                        style="background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196f3 !important;">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-info-circle text-primary me-3 mt-1" style="font-size: 1.2rem;"></i>
                            <div>
                                <h6 class="fw-bold text-primary mb-2">¿Qué es un Pipeline?</h6>
                                <p class="text-muted mb-2">Un pipeline es un flujo de trabajo que define las etapas y
                                    procesos que debe seguir una solicitud desde su creación hasta su finalización.</p>
                                <ul class="text-muted small mb-0">
                                    <li><strong>Etapas:</strong> Define los pasos del proceso</li>
                                    <li><strong>Requisitos:</strong> Documentos o condiciones necesarias</li>
                                    <li><strong>Permisos:</strong> Controla quién puede realizar cada acción</li>
                                    <li><strong>Seguimiento:</strong> Monitorea el progreso y tiempos</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selección de Pipeline -->
    <div class="row">
        {% for pipeline in pipelines %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card card-custom h-100">
                <div class="card-header-custom">
                    <h5 class="mb-0">{{ pipeline.nombre }}</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">{{ pipeline.descripcion|default:"Sin descripción" }}</p>

                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="bg-success bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-success">{{ pipeline.solicitud_set.count }}</h6>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-info bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-info">{{ pipeline.etapas.count }}</h6>
                                <small class="text-muted">Etapas</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-warning bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-warning">{{ pipeline.requisitos_pipeline.count }}</h6>
                                <small class="text-muted">Requisitos</small>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <a href="?pipeline={{ pipeline.id }}&view=table" class="btn btn-pacifico">
                            <i class="fas fa-table me-2"></i>Ver en Tabla
                        </a>
                        <a href="?pipeline={{ pipeline.id }}&view=kanban" class="btn btn-outline-pacifico">
                            <i class="fas fa-columns me-2"></i>Ver en Kanban
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-project-diagram fa-4x text-muted mb-3"></i>
                <h4 class="text-muted mb-3">No hay pipelines disponibles</h4>
                <p class="text-muted mb-4">Crea un pipeline para comenzar a gestionar solicitudes.</p>
                <a href="{% url 'workflow:admin_pipelines' %}" class="btn btn-pacifico">
                    <i class="fas fa-plus me-2"></i>Crear Pipeline
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endif %}
</div>

{% include 'workflow/partials/modalSolicitud.html' %}

{% include 'workflow/partials/modalRequisitos.html' %}

<!-- Modal de Confirmación Personalizado -->
<div class="modal fade" id="modalConfirmacionEtapa" tabindex="-1" aria-labelledby="modalConfirmacionEtapaLabel"
    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content"
            style="border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);">
            <!-- Header con gradiente verde -->
            <div class="modal-header"
                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; padding: 24px 32px 20px 32px; position: relative; overflow: hidden;">
                <!-- Decoración de fondo -->
                <div
                    style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; opacity: 0.6;">
                </div>
                <div
                    style="position: absolute; top: 40px; right: 60px; width: 60px; height: 60px; background: rgba(255, 255, 255, 0.08); border-radius: 50%;">
                </div>

                <div class="w-100 text-center position-relative">
                    <h4 class="modal-title text-white fw-bold mb-1" id="modalConfirmacionEtapaLabel"
                        style="font-size: 1.4rem; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <i class="fas fa-exchange-alt me-2" style="font-size: 1.2rem;"></i>
                        Confirmar Cambio de Etapa
                    </h4>
                    <p class="text-white-50 mb-0" style="font-size: 0.9rem; font-weight: 500;">Sistema de Workflow</p>
                </div>
            </div>

            <div class="modal-body" style="padding: 32px;">
                <!-- Icono central -->
                <div class="text-center mb-4">
                    <div
                        style="width: 80px; height: 80px; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.15)); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 24px rgba(40, 167, 69, 0.2);">
                        <i class="fas fa-arrow-right"
                            style="font-size: 2rem; color: #28a745; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"></i>
                    </div>
                </div>

                <!-- Mensaje principal -->
                <div class="text-center mb-4">
                    <h5 class="fw-bold mb-3" style="color: #2d3748; font-size: 1.2rem;">¿Está seguro del cambio?</h5>
                    <p class="text-muted mb-3" style="font-size: 0.95rem;">La solicitud se moverá a la siguiente etapa:
                    </p>

                    <!-- Caja verde con nombre de etapa -->
                    <div class="bg-success bg-opacity-10 border border-success border-opacity-25 rounded-3 p-3 mb-4"
                        style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.08), rgba(32, 201, 151, 0.12)) !important;">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-flag text-success me-2" style="font-size: 1.1rem;"></i>
                            <span id="nombreEtapaDestino" class="fw-bold text-success" style="font-size: 1.1rem;">Nombre
                                de la Etapa</span>
                        </div>
                    </div>

                    <!-- Selector de subestado (mostrar solo si la etapa tiene subestados) -->
                    <div id="selectorSubestado" class="mb-4" style="display: none;">
                        <h6 class="fw-bold mb-3 text-dark" style="font-size: 1rem;">
                            <i class="fas fa-list-ul text-primary me-2"></i>
                            Seleccionar estado específico:
                        </h6>
                        <div class="bg-white border border-success border-opacity-25 rounded-3 p-3">
                            <select id="subestadoSelect" class="form-select form-select-lg"
                                style="border: 2px solid #e9ecef; border-radius: 8px; font-weight: 600;">
                                <option value="">Seleccionar estado...</option>
                            </select>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Este campo es requerido para esta etapa
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Información del cambio -->
                <div class="bg-light rounded-3 p-3 mb-4" style="border-left: 4px solid #28a745;">
                    <div class="d-flex align-items-start mb-2">
                        <i class="fas fa-info-circle text-primary me-2 mt-1" style="font-size: 1rem;"></i>
                        <div>
                            <h6 class="fw-bold mb-2 text-dark" style="font-size: 0.95rem;">Información del cambio:</h6>
                            <ul class="list-unstyled mb-0"
                                style="font-size: 0.85rem; color: #6c757d; line-height: 1.6;">
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se actualizará el estado de la solicitud
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se registrará en el historial del sistema
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se notificará a los usuarios correspondientes
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer" style="padding: 24px 32px; border: none; background: #f8f9fa;">
                <button type="button" class="btn btn-outline-secondary" id="btnCancelarModal"
                    style="font-weight: 600; padding: 12px 24px; border-radius: 8px; border-width: 2px;">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnAceptarModal"
                    style="font-weight: 600; padding: 12px 24px; border-radius: 8px; background: linear-gradient(135deg, #28a745, #20c997); border: none; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                    <i class="fas fa-check me-2"></i>Aceptar
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Global utility functions
    function showLoading(show) {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tableContainer = document.getElementById('tableContainer');
        const noDataMessage = document.getElementById('noDataMessage');

        if (show) {
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (tableContainer) tableContainer.style.display = 'none';
            if (noDataMessage) noDataMessage.style.display = 'none';
        } else {
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
    }

    function hideLoading() {
        showLoading(false);
    }

    // Función global para manejar clicks en filas de la tabla
    function handleRowClick(event, solicitudId) {
        // Prevenir el click si el usuario está interactuando con elementos de formulario
        if (event.target.tagName === 'SELECT' ||
            event.target.tagName === 'BUTTON' ||
            event.target.tagName === 'INPUT' ||
            event.target.closest('select') ||
            event.target.closest('button') ||
            event.target.closest('input') ||
            event.target.closest('.dropdown') ||
            event.target.closest('.menu-dropdown')) {
            return;
        }

        // Mostrar modal con resumen de la solicitud
        if (typeof window.mostrarModalSolicitud === 'function') {
            window.mostrarModalSolicitud(solicitudId);
        } else {
            // Fallback: navegar directamente al detalle si la función modal no está disponible
            window.location.href = `/workflow/solicitud/${solicitudId}/`;
        }
    }

    // Variables globales
    let currentSolicitudes = [];
    let currentFilters = {
        cliente: '',
        producto: '',
        estado: '',
        asignado: '',
        sla: '',
        prioridad: '',
        search: ''
    };

    // Función para obtener el token CSRF
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }

    // Función para inicializar datos de la tabla desde el DOM
    function initializeTableData() {
        const tableBody = document.querySelector('#tablaSolicitudes tbody');
        if (!tableBody) return;

        currentSolicitudes = [];
        const rows = tableBody.querySelectorAll('tr');

        rows.forEach(row => {
            if (row.querySelector('td[colspan]')) return; // Skip empty/no-data rows

            const cells = row.querySelectorAll('td');
            if (cells.length < 10) return; // Ensure we have enough cells

            const solicitud = {
                id: row.getAttribute('data-solicitud-id'),
                cliente: cells[0].textContent.trim(),
                producto: cells[1].textContent.trim(),
                monto: cells[2].textContent.trim(),
                propietario: cells[3].textContent.trim(),
                etapa: row.getAttribute('data-etapa') || cells[4].textContent.trim(),
                estado: cells[5].textContent.trim(),
                fechaSla: cells[6].textContent.trim(),
                sla: row.getAttribute('data-sla') || cells[7].textContent.trim(),
                etiquetas: cells[8].textContent.trim(),
                prioridad: cells[9].textContent.trim(),
                element: row
            };

            currentSolicitudes.push(solicitud);
        });

        console.log('📊 Datos de tabla inicializados:', currentSolicitudes.length, 'solicitudes');
    }

    // Función para configurar filtros
    function setupFilters() {
        // Poblar selectores de filtros con valores únicos
        populateFilterOptions();

        // Configurar event listeners para filtros
        const filterElements = [
            'filtroCliente', 'filtroProducto', 'filtroEstado',
            'filtroAsignado', 'filtroSLA', 'filtroPrioridad'
        ];

        filterElements.forEach(filterId => {
            const element = document.getElementById(filterId);
            if (element) {
                element.addEventListener('change', applyFilters);
            }
        });

        // Botón limpiar filtros
        const clearButton = document.getElementById('limpiarFiltros');
        if (clearButton) {
            clearButton.addEventListener('click', clearFilters);
        }
    }

    // Función para poblar opciones de filtros
    function populateFilterOptions() {
        const filterConfigs = [
            { id: 'filtroCliente', field: 'cliente' },
            { id: 'filtroProducto', field: 'producto' },
            { id: 'filtroEstado', field: 'estado' },
            { id: 'filtroAsignado', field: 'propietario' },
            { id: 'filtroSLA', field: 'sla' },
            { id: 'filtroPrioridad', field: 'prioridad' }
        ];

        filterConfigs.forEach(config => {
            const select = document.getElementById(config.id);
            if (!select) return;

            const uniqueValues = [...new Set(
                currentSolicitudes.map(s => s[config.field])
                    .filter(value => value && value.trim() !== '')
            )].sort();

            // Clear existing options except first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            uniqueValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
        });
    }

    // Función para configurar búsqueda global
    function setupGlobalSearch() {
        const searchInput = document.getElementById('busquedaGlobal');
        if (searchInput) {
            searchInput.addEventListener('keyup', function () {
                currentFilters.search = this.value.toLowerCase();
                applyFilters();
            });
        }
    }

    // Función para configurar búsqueda rápida en tabla
    function setupQuickTableSearch() {
        const quickSearchInput = document.getElementById('quickTableSearch');
        const clearButton = document.getElementById('clearQuickSearch');
        const resultCountElement = document.getElementById('searchResultCount');
        const resultNumber = document.getElementById('resultCount');

        if (!quickSearchInput) return;

        function performQuickSearch() {
            const searchTerm = quickSearchInput.value.toLowerCase().trim();
            const tableRows = document.querySelectorAll('#tablaSolicitudes tbody tr[data-solicitud-id]');
            let visibleCount = 0;

            tableRows.forEach(row => {
                if (searchTerm === '') {
                    // If search is empty, show all rows that aren't hidden by other filters
                    if (!row.classList.contains('filter-hidden')) {
                        row.style.display = '';
                        visibleCount++;
                    }
                } else {
                    // Get all searchable text from the row
                    const clienteText = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
                    const productoText = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                    const propietarioText = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
                    const etapaText = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
                    const estadoText = row.querySelector('td:nth-child(6)')?.textContent.toLowerCase() || '';
                    const codigoText = row.querySelector('td:nth-child(11)')?.textContent.toLowerCase() || '';

                    const searchableText = `${clienteText} ${productoText} ${propietarioText} ${etapaText} ${estadoText} ${codigoText}`;

                    if (searchableText.includes(searchTerm) && !row.classList.contains('filter-hidden')) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });

            // Update clear button visibility
            clearButton.style.display = searchTerm ? 'block' : 'none';

            // Update result count
            if (searchTerm) {
                resultNumber.textContent = visibleCount;
                resultCountElement.style.display = 'block';
            } else {
                resultCountElement.style.display = 'none';
            }
        }

        // Event listeners
        quickSearchInput.addEventListener('input', performQuickSearch);
        quickSearchInput.addEventListener('keyup', function (e) {
            if (e.key === 'Escape') {
                this.value = '';
                performQuickSearch();
                this.blur();
            }
        });

        clearButton.addEventListener('click', function () {
            quickSearchInput.value = '';
            performQuickSearch();
            quickSearchInput.focus();
        });
    }

    // New compact search functions
    let searchTimeout;

    const handleQuickSearch = () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchTerm = document.getElementById('quickTableSearch').value.toLowerCase().trim();
            const clearButton = document.getElementById('clearQuickSearch');

            // Show/hide clear button
            if (searchTerm) {
                clearButton.style.display = 'block';
            } else {
                clearButton.style.display = 'none';
            }

            // Filter data
            filterAndRenderData(searchTerm);
        }, 300); // Debounce for 300ms
    };

    const handleClearSearch = () => {
        document.getElementById('quickTableSearch').value = '';
        document.getElementById('clearQuickSearch').style.display = 'none';
        filterAndRenderData('');
    };

    const filterAndRenderData = (searchTerm) => {
        const tableRows = document.querySelectorAll('#tablaSolicitudes tbody tr[data-solicitud-id]');
        let visibleCount = 0;

        tableRows.forEach(row => {
            if (searchTerm === '') {
                // If search is empty, show all rows that aren't hidden by other filters
                if (!row.classList.contains('filter-hidden')) {
                    row.style.display = '';
                    visibleCount++;
                }
            } else {
                // Get all searchable text from the row
                const clienteText = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
                const productoText = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                const propietarioText = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
                const etapaText = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
                const estadoText = row.querySelector('td:nth-child(6)')?.textContent.toLowerCase() || '';
                const codigoText = row.querySelector('td:nth-child(11)')?.textContent.toLowerCase() || '';

                const searchableText = `${clienteText} ${productoText} ${propietarioText} ${etapaText} ${estadoText} ${codigoText}`;

                if (searchableText.includes(searchTerm) && !row.classList.contains('filter-hidden')) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Update result count
        const resultCountElement = document.getElementById('searchResultCount');
        const resultNumber = document.getElementById('resultCount');

        if (searchTerm) {
            resultNumber.textContent = visibleCount;
            resultCountElement.style.display = 'block';
        } else {
            resultCountElement.style.display = 'none';
        }
    };

    // Función para aplicar filtros
    function applyFilters() {
        // Actualizar filtros actuales
        const filterElements = {
            cliente: document.getElementById('filtroCliente'),
            producto: document.getElementById('filtroProducto'),
            estado: document.getElementById('filtroEstado'),
            asignado: document.getElementById('filtroAsignado'),
            sla: document.getElementById('filtroSLA'),
            prioridad: document.getElementById('filtroPrioridad')
        };

        Object.keys(filterElements).forEach(key => {
            const element = filterElements[key];
            if (element) {
                currentFilters[key] = element.value;
            }
        });

        // Filtrar solicitudes
        const filteredSolicitudes = currentSolicitudes.filter(solicitud => {
            // Filtros de select
            if (currentFilters.cliente && solicitud.cliente !== currentFilters.cliente) return false;
            if (currentFilters.producto && solicitud.producto !== currentFilters.producto) return false;
            if (currentFilters.estado && solicitud.estado !== currentFilters.estado) return false;
            if (currentFilters.asignado && solicitud.propietario !== currentFilters.asignado) return false;
            if (currentFilters.sla && solicitud.sla !== currentFilters.sla) return false;
            if (currentFilters.prioridad && solicitud.prioridad !== currentFilters.prioridad) return false;

            // Búsqueda global
            if (currentFilters.search) {
                const searchTerms = [
                    solicitud.cliente, solicitud.producto, solicitud.propietario,
                    solicitud.etapa, solicitud.estado, solicitud.etiquetas
                ].join(' ').toLowerCase();

                if (!searchTerms.includes(currentFilters.search)) return false;
            }

            return true;
        });

        // Mostrar/ocultar filas
        currentSolicitudes.forEach(solicitud => {
            const isVisible = filteredSolicitudes.includes(solicitud);
            solicitud.element.style.display = isVisible ? '' : 'none';
        });

        // Actualizar contador de resultados
        updateResultsCounter(filteredSolicitudes.length, currentSolicitudes.length);
    }

    // Función para limpiar filtros
    function clearFilters() {
        const filterElements = [
            'filtroCliente', 'filtroProducto', 'filtroEstado',
            'filtroAsignado', 'filtroSLA', 'filtroPrioridad', 'busquedaGlobal'
        ];

        filterElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
        });

        // Reset filters object
        Object.keys(currentFilters).forEach(key => {
            currentFilters[key] = '';
        });

        // Show all rows
        currentSolicitudes.forEach(solicitud => {
            solicitud.element.style.display = '';
        });

        updateResultsCounter(currentSolicitudes.length, currentSolicitudes.length);
    }

    // Función para actualizar contador de resultados
    function updateResultsCounter(showing, total) {
        const counter = document.getElementById('resultsCounter');
        if (counter) {
            if (showing === total) {
                counter.textContent = `Mostrando ${total} solicitudes`;
            } else {
                counter.textContent = `Mostrando ${showing} de ${total} solicitudes`;
            }
        }
    }

    // Función para configurar scroll de tabla
    function setupTableScroll() {
        const tableContainer = document.getElementById('tableContainer');
        if (!tableContainer) return;

        const leftIndicator = document.getElementById('scrollLeftIndicator');
        const rightIndicator = document.getElementById('scrollRightIndicator');
        const scrollHint = document.getElementById('scrollHint');

        function updateScrollIndicators() {
            const scrollLeft = tableContainer.scrollLeft;
            const scrollWidth = tableContainer.scrollWidth;
            const clientWidth = tableContainer.clientWidth;

            if (leftIndicator) {
                leftIndicator.style.display = scrollLeft > 0 ? 'flex' : 'none';
            }

            if (rightIndicator) {
                rightIndicator.style.display = scrollLeft < (scrollWidth - clientWidth - 5) ? 'flex' : 'none';
            }

            if (scrollHint) {
                scrollHint.style.display = scrollWidth > clientWidth ? 'block' : 'none';
            }
        }

        tableContainer.addEventListener('scroll', updateScrollIndicators);
        window.addEventListener('resize', updateScrollIndicators);

        // Initial check
        setTimeout(updateScrollIndicators, 100);
    }

    // Función para scroll manual de tabla
    function scrollTable(direction) {
        const tableContainer = document.getElementById('tableContainer');
        if (!tableContainer) return;

        const scrollAmount = 300;
        const currentScroll = tableContainer.scrollLeft;

        if (direction === 'left') {
            tableContainer.scrollTo({
                left: currentScroll - scrollAmount,
                behavior: 'smooth'
            });
        } else {
            tableContainer.scrollTo({
                left: currentScroll + scrollAmount,
                behavior: 'smooth'
            });
        }
    }

    // Función para inicializar la aplicación
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Inicializando sistema de tabla mejorado...');

        // Inicializar datos de la tabla desde el DOM
        initializeTableData();

        // Configurar filtros
        setupFilters();

        // Configurar búsqueda global
        setupGlobalSearch();

        // Configurar búsqueda rápida en tabla
        setupQuickTableSearch();

        // Configurar scroll de tabla
        setupTableScroll();

        // Ocultar loading
        hideLoading();

        console.log('✅ Sistema inicializado correctamente');
    });

    document.addEventListener('DOMContentLoaded', function () {

        // =====================================
        // FUNCIONES DE NOTIFICACIÓN PERSONALIZADA
        // =====================================

        function mostrarNotificacionExito(mensaje) {
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion-personalizada notificacion-exito';
            notificacion.innerHTML = `
                <div class="notificacion-contenido">
                    <i class="fas fa-check-circle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            `;

            document.body.appendChild(notificacion);

            // Animar entrada
            setTimeout(() => {
                notificacion.classList.add('show');
            }, 100);

            // Auto-remover después de 4 segundos
            setTimeout(() => {
                notificacion.classList.remove('show');
                setTimeout(() => notificacion.remove(), 300);
            }, 4000);
        }

        // Hacer la función globalmente accesible
        window.mostrarNotificacionExito = mostrarNotificacionExito;

        function mostrarNotificacionError(mensaje) {
            console.log('🚨 Mostrando notificación de error:', mensaje);

            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion-personalizada notificacion-error';
            notificacion.innerHTML = `
                <div class="notificacion-contenido">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            `;

            document.body.appendChild(notificacion);

            // Animar entrada
            setTimeout(() => {
                notificacion.classList.add('show');
            }, 100);

            // Auto-remover después de 5 segundos (más tiempo para errores)
            setTimeout(() => {
                notificacion.classList.remove('show');
                setTimeout(() => notificacion.remove(), 300);
            }, 5000);
        }

        // Hacer la función globalmente accesible
        window.mostrarNotificacionError = mostrarNotificacionError;

        function mostrarNotificacionAdvertencia(mensaje) {
            console.log('⚠️ Mostrando notificación de advertencia:', mensaje);

            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion-personalizada notificacion-advertencia';
            notificacion.innerHTML = `
                <div class="notificacion-contenido">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            `;

            document.body.appendChild(notificacion);

            // Animar entrada
            setTimeout(() => {
                notificacion.classList.add('show');
            }, 100);

            // Auto-remover después de 6 segundos (más tiempo para advertencias)
            setTimeout(() => {
                notificacion.classList.remove('show');
                setTimeout(() => notificacion.remove(), 300);
            }, 6000);
        }

        // Hacer la función globalmente accesible
        window.mostrarNotificacionAdvertencia = mostrarNotificacionAdvertencia;

        // =====================================
        // MODAL DE CONFIRMACIÓN PERSONALIZADO
        // =====================================

        // Variables globales para el modal
        let modalConfirmCallback = null;
        let modalCancelCallback = null;
        let currentEtapaId = null;
        let currentSubestados = [];

        // Función para mostrar modal de confirmación
        window.mostrarModalConfirmacion = function (nombreEtapa, onConfirm, onCancel, opciones) {
            // Opciones por defecto
            var configuracion = {
                titulo: 'Confirmar Cambio de Etapa',
                subtitulo: 'Sistema de Workflow',
                pregunta: '¿Está seguro del cambio?',
                descripcion: 'La solicitud se moverá a la siguiente etapa:',
                icono: 'fas fa-arrow-right',
                tipo: 'cambio_etapa', // cambio_etapa, eliminar, accion_general
                etapaId: null
            };

            // Sobrescribir configuración si se proporcionan opciones
            if (opciones) {
                configuracion = Object.assign(configuracion, opciones);
            }

            // Guardar el ID de etapa actual
            currentEtapaId = configuracion.etapaId;

            // Configurar para diferentes tipos de acción
            if (nombreEtapa === 'Eliminar Solicitud' || configuracion.tipo === 'eliminar') {
                configuracion.titulo = 'Confirmar Eliminación';
                configuracion.pregunta = '¿Está seguro de eliminar esta solicitud?';
                configuracion.descripcion = 'Esta acción no se puede deshacer:';
                configuracion.icono = 'fas fa-trash';
                const nombreEtapaDestino = document.getElementById('nombreEtapaDestino');
                if (nombreEtapaDestino) {
                    nombreEtapaDestino.innerHTML = '<span class="text-danger fw-bold">Esta acción es permanente</span>';
                }
                // Ocultar selector de subestado para eliminación
                const selectorSubestado = document.getElementById('selectorSubestado');
                if (selectorSubestado) selectorSubestado.style.display = 'none';
            } else {
                // Para cambio de etapa normal
                const nombreEtapaDestino = document.getElementById('nombreEtapaDestino');
                if (nombreEtapaDestino) {
                    nombreEtapaDestino.textContent = nombreEtapa;
                }

                // Cargar subestados si se proporciona etapaId
                if (currentEtapaId) {
                    cargarSubestados(currentEtapaId);
                } else {
                    const selectorSubestado = document.getElementById('selectorSubestado');
                    if (selectorSubestado) selectorSubestado.style.display = 'none';
                }
            }

            // Actualizar contenido del modal
            const modalLabel = document.getElementById('modalConfirmacionEtapaLabel');
            if (modalLabel) {
                modalLabel.innerHTML = `<i class="${configuracion.icono} me-2"></i>${configuracion.titulo}`;
            }

            const modalSubtitle = modalLabel?.nextElementSibling;
            if (modalSubtitle) {
                modalSubtitle.textContent = configuracion.subtitulo;
            }

            const modalBodyH5 = document.querySelector('.modal-body h5');
            if (modalBodyH5) {
                modalBodyH5.textContent = configuracion.pregunta;
            }

            const modalBodyP = document.querySelector('.modal-body p.text-muted');
            if (modalBodyP) {
                modalBodyP.textContent = configuracion.descripcion;
            }

            const modalIcon = document.querySelector('.modal-body .text-center .fas');
            if (modalIcon) {
                modalIcon.className = configuracion.icono;
                modalIcon.style.fontSize = '2rem';
                modalIcon.style.color = '#28a745';
            }

            // Guardar callbacks
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel || function () { };

            // Mostrar el modal
            const modalElement = document.getElementById('modalConfirmacionEtapa');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Validar formulario inicial cuando se muestre el modal
            modalElement.addEventListener('shown.bs.modal', function () {
                validarFormularioModal();
            });
        };

        // Función para cargar subestados de una etapa
        function cargarSubestados(etapaId) {
            console.log('🔍 Cargando subestados para etapa:', etapaId);

            fetch(`/workflow/api/etapas/${etapaId}/subestados/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.subestados && data.subestados.length > 0) {
                        console.log('✅ Subestados cargados:', data.subestados);
                        currentSubestados = data.subestados;
                        mostrarSelectorSubestado(data.subestados);
                    } else {
                        console.log('ℹ️ No hay subestados para esta etapa');
                        const selectorSubestado = document.getElementById('selectorSubestado');
                        if (selectorSubestado) selectorSubestado.style.display = 'none';
                        currentSubestados = [];
                    }
                })
                .catch(error => {
                    console.error('❌ Error cargando subestados:', error);
                    const selectorSubestado = document.getElementById('selectorSubestado');
                    if (selectorSubestado) selectorSubestado.style.display = 'none';
                    currentSubestados = [];
                });
        }

        // Función para mostrar el selector de subestados
        function mostrarSelectorSubestado(subestados) {
            const select = document.getElementById('subestadoSelect');
            if (!select) return;

            select.innerHTML = '';
            select.appendChild(new Option('Seleccionar estado...', ''));

            subestados.forEach(subestado => {
                select.appendChild(new Option(subestado.nombre, subestado.id));
            });

            const selectorSubestado = document.getElementById('selectorSubestado');
            if (selectorSubestado) selectorSubestado.style.display = 'block';

            // Validar selección al cambiar
            select.addEventListener('change', function () {
                validarFormularioModal();
            });
        }

        // Función para validar el formulario del modal
        function validarFormularioModal() {
            const btnAceptar = document.getElementById('btnAceptarModal');
            if (!btnAceptar) return false;

            // Si hay subestados disponibles, debe seleccionar uno
            if (currentSubestados.length > 0) {
                const subestadoSelect = document.getElementById('subestadoSelect');
                const subestadoSeleccionado = subestadoSelect ? subestadoSelect.value : '';

                if (!subestadoSeleccionado) {
                    btnAceptar.disabled = true;
                    btnAceptar.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Seleccionar Estado';
                    return false;
                } else {
                    btnAceptar.disabled = false;
                    btnAceptar.innerHTML = '<i class="fas fa-check me-2"></i>Aceptar';
                    return true;
                }
            } else {
                // No hay subestados, siempre válido
                btnAceptar.disabled = false;
                btnAceptar.innerHTML = '<i class="fas fa-check me-2"></i>Aceptar';
                return true;
            }
        }

        // Event listeners para los botones del modal
        const btnAceptarModal = document.getElementById('btnAceptarModal');
        if (btnAceptarModal) {
            btnAceptarModal.addEventListener('click', function () {
                // Validar formulario antes de proceder
                if (!validarFormularioModal()) {
                    return;
                }

                // Ocultar modal
                const modalElement = document.getElementById('modalConfirmacionEtapa');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) modalInstance.hide();

                // Ejecutar callback de confirmación con datos de subestado
                if (modalConfirmCallback) {
                    const subestadoSelect = document.getElementById('subestadoSelect');
                    const subestadoSeleccionado = subestadoSelect ? subestadoSelect.value : '';
                    modalConfirmCallback(subestadoSeleccionado);
                }
            });
        }

        const btnCancelarModal = document.getElementById('btnCancelarModal');
        if (btnCancelarModal) {
            btnCancelarModal.addEventListener('click', function () {
                // Ocultar modal
                const modalElement = document.getElementById('modalConfirmacionEtapa');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) modalInstance.hide();

                // Ejecutar callback de cancelación
                if (modalCancelCallback) {
                    modalCancelCallback();
                }
            });
        }

        // Función para cargar transiciones válidas
        function cargarTransicionesValidas(solicitudId, select, callback) {
            console.log('🔍 Cargando transiciones válidas para solicitud:', solicitudId);

            // Deshabilitar el select mientras se cargan las transiciones
            select.disabled = true;

            // Obtener la etapa actual y opción seleccionada
            var etapaActual = select.getAttribute('data-etapa-actual') || select.dataset.etapaActual;
            var opcionSeleccionada = select.value;

            // Realizar petición AJAX
            fetch(`/workflow/api/solicitudes/${solicitudId}/transiciones-validas/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
                .then(response => {
                    console.log('🔍 DEBUG cargarTransicionesValidas: Response status:', response.status);
                    console.log('🔍 DEBUG cargarTransicionesValidas: Response ok:', response.ok);
                    console.log('🔍 DEBUG cargarTransicionesValidas: Content-Type:', response.headers.get('content-type'));

                    // Verificar si la respuesta es exitosa
                    if (!response.ok) {
                        console.error('❌ ERROR cargarTransicionesValidas: Response not ok, status:', response.status);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    // Verificar si el contenido es JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.error('❌ ERROR cargarTransicionesValidas: Content-Type no es JSON:', contentType);
                        throw new Error('La respuesta no es JSON válido');
                    }
                    console.log('✅ DEBUG cargarTransicionesValidas: Content-Type es JSON, procediendo a parsear');
                    return response.json();
                })
                .then(data => {
                    console.log('🔍 DEBUG cargarTransicionesValidas: Data recibida:', data);
                    if (data.success) {
                        // Limpiar el select
                        select.innerHTML = '';

                        // SIEMPRE agregar la etapa actual primero (si existe)
                        if (data.etapa_actual && data.etapa_actual.id) {
                            const optionActual = document.createElement('option');
                            optionActual.value = data.etapa_actual.id;
                            optionActual.className = 'text-primary fw-bold';
                            optionActual.setAttribute('data-puede-realizar', 'true');
                            optionActual.setAttribute('data-requisitos-faltantes', '0');
                            optionActual.selected = true;
                            optionActual.textContent = `${data.etapa_actual.nombre} (Actual)`;
                            select.appendChild(optionActual);
                        }

                        // Agregar las etapas válidas según las transiciones
                        data.transiciones.forEach(function (transicion) {
                            // No agregar la etapa actual nuevamente si ya está en las transiciones
                            if (data.etapa_actual && transicion.etapa_destino.id === data.etapa_actual.id) {
                                return;
                            }

                            var warningClass = !transicion.puede_realizar ? 'text-warning' : '';
                            var requisitosInfo = transicion.total_requisitos_faltantes > 0 ?
                                ` (${transicion.total_requisitos_faltantes} requisitos faltantes)` : '';

                            const optionTransicion = document.createElement('option');
                            optionTransicion.value = transicion.etapa_destino.id;
                            optionTransicion.className = warningClass;
                            optionTransicion.setAttribute('data-puede-realizar', transicion.puede_realizar);
                            optionTransicion.setAttribute('data-requisitos-faltantes', transicion.total_requisitos_faltantes);
                            optionTransicion.textContent = `${transicion.etapa_destino.nombre}${requisitosInfo}`;
                            select.appendChild(optionTransicion);
                        });

                        // Si no hay etapa actual en los datos pero sí en el select original, agregarla
                        if ((!data.etapa_actual || !data.etapa_actual.id) && etapaActual) {
                            const optionFallback = document.createElement('option');
                            optionFallback.value = etapaActual;
                            optionFallback.className = 'text-primary fw-bold';
                            optionFallback.setAttribute('data-puede-realizar', 'true');
                            optionFallback.setAttribute('data-requisitos-faltantes', '0');
                            optionFallback.selected = true;
                            optionFallback.textContent = `Etapa actual (ID: ${etapaActual})`;
                            select.appendChild(optionFallback);
                        }

                        // Actualizar data attributes
                        select.setAttribute('data-etapa-actual', etapaActual);
                        select.setAttribute('data-transiciones-cargadas', 'true');

                        // Habilitar el select
                        select.disabled = false;

                        console.log('✅ Transiciones válidas cargadas:', data.transiciones);

                        // Ejecutar callback si existe
                        if (typeof callback === 'function') {
                            callback();
                        }
                    } else {
                        console.error('❌ Error al cargar transiciones válidas:', data.error);
                        // Restaurar opciones originales en caso de error
                        restaurarOpcionesOriginales(select, etapaActual, opcionSeleccionada);
                        // Mostrar notificación de error
                        if (typeof showToast !== 'undefined') {
                            showToast('Error al cargar transiciones: ' + (data.error || 'Error desconocido'), 'error', 5000);
                        } else {
                            mostrarNotificacionError('Error al cargar transiciones: ' + (data.error || 'Error desconocido'));
                        }

                        // Ejecutar callback si existe (incluso en error)
                        if (typeof callback === 'function') {
                            callback();
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ Error en la petición de transiciones válidas:', error);
                    // Restaurar opciones originales en caso de error
                    restaurarOpcionesOriginales(select, etapaActual, opcionSeleccionada);
                    // Mostrar notificación de error más específica
                    let mensajeError = 'Error al cargar transiciones válidas';
                    if (error.message.includes('404')) {
                        mensajeError = 'No se encontró la solicitud o no tienes permisos';
                    } else if (error.message.includes('403')) {
                        mensajeError = 'No tienes permisos para ver esta solicitud';
                    } else if (error.message.includes('500')) {
                        mensajeError = 'Error interno del servidor';
                    } else if (error.message.includes('JSON')) {
                        mensajeError = 'Error en el formato de respuesta del servidor';
                    }

                    if (typeof showToast !== 'undefined') {
                        showToast(mensajeError, 'error', 5000);
                    } else {
                        mostrarNotificacionError(mensajeError);
                    }

                    // Ejecutar callback si existe (incluso en error)
                    if (typeof callback === 'function') {
                        callback();
                    }
                });
        }


        // Función auxiliar para restaurar opciones originales en caso de error
        function restaurarOpcionesOriginales(select, etapaActual, opcionSeleccionada) {
            select.disabled = false;
            select.innerHTML = '';

            // Restaurar la opción seleccionada originalmente con mejor formato
            if (etapaActual) {
                const option = document.createElement('option');
                option.value = etapaActual;
                option.selected = true;
                option.className = 'text-primary fw-bold';
                option.textContent = `📍 Etapa actual (ID: ${etapaActual})`;
                select.appendChild(option);
            }

            // Marcar como no cargado para permitir reintentos
            select.setAttribute('data-transiciones-cargadas', 'false');
        }

        // Cargar transiciones válidas inmediatamente al cargar la página
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 Cargando transiciones válidas para todos los selects de etapa...');

            // Mostrar indicador de carga global
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'text-center py-2';
            loadingIndicator.innerHTML = '<small class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Cargando transiciones válidas...</small>';

            const firstSelect = document.querySelector('.etapa-select');
            if (firstSelect) {
                const closestTd = firstSelect.closest('td');
                if (closestTd) {
                    closestTd.parentNode.insertBefore(loadingIndicator, closestTd);
                }
            }

            const etapaSelects = document.querySelectorAll('.etapa-select:not([disabled])');
            const totalSelects = etapaSelects.length;
            var loadedSelects = 0;

            etapaSelects.forEach(function (select) {
                // No cargar transiciones si el select está deshabilitado (bandeja grupal)
                if (select.disabled) {
                    console.log('❌ Select deshabilitado - no cargando transiciones');
                    return;
                }

                var solicitudId = select.getAttribute('data-solicitud-id') || select.dataset.solicitudId;
                console.log('📋 Cargando transiciones para solicitud:', solicitudId);

                // Modificar la función para incluir callback de completado
                cargarTransicionesValidas(solicitudId, select, function () {
                    loadedSelects++;
                    if (loadedSelects >= totalSelects) {
                        // Ocultar indicador de carga cuando todos estén listos
                        loadingIndicator.style.transition = 'opacity 0.3s';
                        loadingIndicator.style.opacity = '0';
                        setTimeout(function () {
                            if (loadingIndicator.parentNode) {
                                loadingIndicator.parentNode.removeChild(loadingIndicator);
                            }
                        }, 300);
                        console.log('✅ Todas las transiciones han sido cargadas');
                    }
                });
            });

            // Si no hay selects para cargar, remover el indicador inmediatamente
            if (totalSelects === 0) {
                if (loadingIndicator.parentNode) {
                    loadingIndicator.parentNode.removeChild(loadingIndicator);
                }
            }
        });

        // Mantener el evento focus como fallback para casos donde se agreguen selects dinámicamente
        document.addEventListener('focus', function (event) {
            if (event.target.classList.contains('etapa-select')) {
                const select = event.target;

                // No cargar transiciones si el select está deshabilitado (bandeja grupal)
                if (select.disabled) {
                    console.log('❌ Select deshabilitado - no cargando transiciones');
                    return;
                }

                // Solo cargar si no se han cargado ya las transiciones (verificar si tiene data-transiciones-cargadas)
                const transicionesCargadas = select.getAttribute('data-transiciones-cargadas') === 'true';
                if (!transicionesCargadas) {
                    var solicitudId = select.getAttribute('data-solicitud-id') || select.dataset.solicitudId;
                    console.log('📋 Cargando transiciones en focus para solicitud:', solicitudId);
                    cargarTransicionesValidas(solicitudId, select);
                }
            }
        }, true);

        // Manejar cambio de etapa con modal personalizado
        document.addEventListener('change', function (event) {
            if (event.target.classList.contains('etapa-select')) {
                const select = event.target;

                // Verificar si el select está deshabilitado (bandeja grupal)
                if (select.disabled) {
                    console.log('❌ Select deshabilitado - solicitud en bandeja grupal');
                    // Mostrar mensaje informativo
                    if (typeof showToast !== 'undefined') {
                        showToast('⏳ Esta solicitud está en bandeja grupal. Debes esperar a que el equipo la procese antes de poder cambiar la etapa.', 'warning', 6000);
                    } else {
                        mostrarNotificacionAdvertencia('⏳ Esta solicitud está en bandeja grupal. Debes esperar a que el equipo la procese antes de poder cambiar la etapa.');
                    }
                    return; // No permitir cambios
                }

                var solicitudId = select.getAttribute('data-solicitud-id') || select.dataset.solicitudId;
                var etapaActual = select.getAttribute('data-etapa-actual') || select.dataset.etapaActual;
                var nuevaEtapaId = select.value;
                var nombreEtapa = select.options[select.selectedIndex]?.text || '';

                console.log('🔥 CAMBIO DE ETAPA DETECTADO:');
                console.log('- Solicitud ID:', solicitudId);
                console.log('- Etapa Actual:', etapaActual);
                console.log('- Nueva Etapa ID:', nuevaEtapaId);
                console.log('- Nombre Etapa:', nombreEtapa);

                if (nuevaEtapaId === etapaActual.toString() || !nuevaEtapaId) {
                    console.log('❌ No hay cambio de etapa - valores iguales o sin selección');
                    return; // No hay cambio
                }

                // Verificar si hay requisitos faltantes
                const opcionSeleccionada = select.options[select.selectedIndex];
                const puedeRealizar = opcionSeleccionada?.getAttribute('data-puede-realizar') === 'true';
                const requisitosFaltantes = parseInt(opcionSeleccionada?.getAttribute('data-requisitos-faltantes') || '0');

                if (puedeRealizar === false || requisitosFaltantes > 0) {
                    console.log('🔍 Requisitos faltantes detectados, mostrando modal');
                    console.log('📋 Parámetros:', { solicitudId, nuevaEtapaId, nombreEtapa, puedeRealizar, requisitosFaltantes });

                    // Usar la función global correcta que maneja la carga de requisitos
                    if (typeof window.mostrarModalRequisitosFaltantes === 'function') {
                        console.log('✅ Función disponible, llamando con parámetros correctos');
                        try {
                            window.mostrarModalRequisitosFaltantes(solicitudId, nuevaEtapaId, nombreEtapa, function () {
                                // Callback de éxito - proceder con el cambio
                                console.log('✅ Requisitos completados, procediendo con cambio de etapa');
                                window.ejecutarCambioEtapa(solicitudId, nuevaEtapaId, etapaActual, select, null);
                            }, function () {
                                // Callback de cancelación
                                console.log('❌ Cambio de etapa cancelado');
                                select.value = etapaActual; // Revertir selección
                            });
                        } catch (error) {
                            console.error('❌ Error al llamar mostrarModalRequisitosFaltantes:', error);
                            alert('Error al mostrar modal de requisitos: ' + error.message);
                            select.value = etapaActual; // Revertir selección
                        }
                    } else {
                        console.error('❌ Función mostrarModalRequisitosFaltantes no disponible');
                        alert('Error: Función de requisitos no disponible');
                        select.value = etapaActual; // Revertir selección
                    }
                    return;
                }

                // Mostrar modal de confirmación personalizado
                mostrarModalConfirmacion(nombreEtapa, function (subestadoSeleccionado) {
                    // CALLBACK DE CONFIRMACIÓN
                    console.log('✅ Confirmado desde modal personalizado, ejecutando cambio de etapa');
                    console.log('🔍 Subestado seleccionado:', subestadoSeleccionado);
                    window.ejecutarCambioEtapa(solicitudId, nuevaEtapaId, etapaActual, select, subestadoSeleccionado);
                }, function () {
                    // CALLBACK DE CANCELACIÓN
                    console.log('❌ Cancelado desde modal personalizado');
                    select.value = etapaActual; // Revertir selección
                }, {
                    etapaId: nuevaEtapaId
                });
            }
        });

        // Función para cambiar entre vistas
        window.cambiarVista = function (vista) {
            console.log('Cambiando a vista:', vista);

            // Obtener parámetros actuales de la URL
            var urlParams = new URLSearchParams(window.location.search);

            // Actualizar el parámetro de vista
            urlParams.set('view', vista);

            // Mantener el pipeline si existe
            // Django template code - will be processed server-side
            // {% if pipeline %}
            // urlParams.set('pipeline', '{{ pipeline.id }}');
            // {% endif %}

            // Redirigir con los nuevos parámetros
            var newUrl = window.location.pathname + '?' + urlParams.toString();
            window.location.href = newUrl;
        };

        // Actualizar estado de botones según vista actual
        document.addEventListener('DOMContentLoaded', function () {
            var currentView = '{{ request.GET.view|default:"table" }}'; // Django template variable

            const btnVistaTabla = document.getElementById('btnVistaTabla');
            const btnVistaKanban = document.getElementById('btnVistaKanban');

            if (currentView === 'kanban') {
                if (btnVistaTabla) {
                    btnVistaTabla.classList.remove('active', 'btn-light');
                    btnVistaTabla.classList.add('btn-outline-light');
                }
                if (btnVistaKanban) {
                    btnVistaKanban.classList.remove('btn-outline-light');
                    btnVistaKanban.classList.add('active', 'btn-light');
                }
            } else {
                if (btnVistaTabla) {
                    btnVistaTabla.classList.remove('btn-outline-light');
                    btnVistaTabla.classList.add('active', 'btn-light');
                }
                if (btnVistaKanban) {
                    btnVistaKanban.classList.remove('active', 'btn-light');
                    btnVistaKanban.classList.add('btn-outline-light');
                }
            }
        });
    });
</script>


<!-- incluir estilos de negocios_styles.html -->
{% include "workflow/partials/negocios_styles.html" %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Inicializando sistema de requisitos faltantes');

        // Verificar que todas las funciones estén disponibles
        if (window.verificarFuncionesRequisitos) {
            window.verificarFuncionesRequisitos();
        }

        // Verificar que el modal esté disponible
        const modalElement = document.getElementById('modalRequisitosFaltantes');
        if (modalElement) {
            console.log('✅ Modal de requisitos faltantes encontrado');
        } else {
            console.error('❌ Modal de requisitos faltantes no encontrado');
        }

        // Horizontal scroll functionality for table - Matching APC Tracking
        const tableContainer = document.getElementById('tableContainer');
        const scrollLeftIndicator = document.getElementById('scrollLeftIndicator');
        const scrollRightIndicator = document.getElementById('scrollRightIndicator');
        const scrollHint = document.getElementById('scrollHint');

        if (tableContainer && scrollLeftIndicator && scrollRightIndicator) {
            let scrollHintTimeout;

            // Function to update scroll indicators visibility
            function updateScrollIndicators() {
                const scrollLeft = tableContainer.scrollLeft;
                const scrollWidth = tableContainer.scrollWidth;
                const clientWidth = tableContainer.clientWidth;
                const maxScrollLeft = scrollWidth - clientWidth;

                // Show/hide left indicator
                if (scrollLeft > 10) {
                    scrollLeftIndicator.classList.add('visible');
                } else {
                    scrollLeftIndicator.classList.remove('visible');
                }

                // Show/hide right indicator
                if (scrollLeft < maxScrollLeft - 10) {
                    scrollRightIndicator.classList.add('visible');
                } else {
                    scrollRightIndicator.classList.remove('visible');
                }
            }

            // Function to show scroll hint
            function showScrollHint() {
                if (scrollHint) {
                    scrollHint.classList.add('visible');
                    clearTimeout(scrollHintTimeout);
                    scrollHintTimeout = setTimeout(() => {
                        scrollHint.classList.remove('visible');
                    }, 3000);
                }
            }

            // Update indicators on scroll
            tableContainer.addEventListener('scroll', updateScrollIndicators);

            // Add click handlers for scroll indicators
            scrollLeftIndicator.addEventListener('click', function () {
                window.scrollTable('left');
            });

            scrollRightIndicator.addEventListener('click', function () {
                window.scrollTable('right');
            });

            // Initial check and show hint if scrollable
            setTimeout(() => {
                updateScrollIndicators();
                if (tableContainer.scrollWidth > tableContainer.clientWidth) {
                    showScrollHint();
                }
            }, 500);

            // Update on window resize
            window.addEventListener('resize', updateScrollIndicators);

            // Hide hint on user interaction
            tableContainer.addEventListener('scroll', () => {
                if (scrollHint) {
                    scrollHint.classList.remove('visible');
                }
            });
        }

        // Manejar edición de etiquetas con select
        document.querySelectorAll('.etiquetas-select').forEach(function (select) {
            select.addEventListener('change', function (e) {
                const solicitudId = e.target.dataset.id;
                const nuevaEtiqueta = e.target.value;

                e.target.disabled = true;

                fetch(`/workflow/api/solicitudes/${solicitudId}/actualizar-etiquetas/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ etiquetas_oficial: nuevaEtiqueta })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            e.target.style.borderColor = '#22c55e';
                            setTimeout(() => {
                                e.target.style.borderColor = '';
                            }, 1000);
                        } else {
                            e.target.style.borderColor = '#ef4444';
                            alert(data.error || 'Error al guardar etiqueta');
                        }
                    })
                    .catch(error => {
                        e.target.style.borderColor = '#ef4444';
                        alert('Error de conexión');
                    })
                    .finally(() => {
                        e.target.disabled = false;
                    });
            });
        });

        // Manejar edición de prioridad
        document.querySelectorAll('.prioridad-select').forEach(function (select) {
            select.addEventListener('change', function (e) {
                const solicitudId = e.target.dataset.id;
                const nuevaPrioridad = e.target.value;
                fetch(`/workflow/api/solicitudes/${solicitudId}/actualizar-prioridad/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ prioridad: nuevaPrioridad })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Cambia color del fondo según la prioridad seleccionada
                            if (nuevaPrioridad === 'Alta') {
                                e.target.style.backgroundColor = '#fee2e2';
                                e.target.style.color = '#b91c1c';
                            } else if (nuevaPrioridad === 'Media') {
                                e.target.style.backgroundColor = '#fef9c3';
                                e.target.style.color = '#b45309';
                            } else if (nuevaPrioridad === 'Baja') {
                                e.target.style.backgroundColor = '#dcfce7';
                                e.target.style.color = '#166534';
                            } else {
                                e.target.style.backgroundColor = 'white';
                                e.target.style.color = '#333';
                            }
                        } else {
                            alert(data.error || 'Error al guardar prioridad');
                        }
                    });
            });
        });
    });
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Function to scroll table horizontally - Matching APC Tracking
    window.scrollTable = function (direction) {
        const tableContainer = document.getElementById('tableContainer');
        if (tableContainer) {
            const scrollAmount = 300;
            const currentScroll = tableContainer.scrollLeft;

            if (direction === 'left') {
                tableContainer.scrollTo({
                    left: currentScroll - scrollAmount,
                    behavior: 'smooth'
                });
            } else if (direction === 'right') {
                tableContainer.scrollTo({
                    left: currentScroll + scrollAmount,
                    behavior: 'smooth'
                });
            }
        }
    };
</script>

<!-- JavaScript para Vista Móvil 
<script>
    // Funcionalidad mejorada para vista móvil
    document.addEventListener('DOMContentLoaded', function() {
        // Animaciones de entrada escalonadas
        const cards = document.querySelectorAll('.vista-movil .solicitud-card');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
        });
    
        // Búsqueda móvil mejorada con debounce
        const busquedaMovil = document.getElementById('busquedaMovil');
        if (busquedaMovil) {
            let searchTimeout;
            
            busquedaMovil.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const searchTerm = this.value.toLowerCase();
                
                searchTimeout = setTimeout(() => {
                    const cards = document.querySelectorAll('.solicitud-card');
                    let visibleCount = 0;
                    
                    cards.forEach((card, index) => {
                        const searchData = card.getAttribute('data-search');
                        const isVisible = searchData && searchData.includes(searchTerm);
                        
                        if (isVisible) {
                            card.style.display = 'block';
                            card.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s both`;
                            visibleCount++;
                        } else {
                            card.style.animation = 'fadeOut 0.3s ease-out';
                            setTimeout(() => {
                                card.style.display = 'none';
                            }, 300);
                        }
                    });
                    
                    // Mostrar mensaje mejorado si no hay resultados
                    const noResultsMsg = document.getElementById('noResultsMessage');
                    
                    if (visibleCount === 0 && searchTerm !== '') {
                        if (!noResultsMsg) {
                            const container = document.getElementById('solicitudesMovil');
                            const msg = document.createElement('div');
                            msg.id = 'noResultsMessage';
                            msg.className = 'empty-state';
                            msg.style.animation = 'fadeInUp 0.5s ease-out';
                            msg.innerHTML = `
                                <div class="empty-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <h3 class="empty-title">Sin resultados para "${searchTerm}"</h3>
                                <p class="empty-subtitle">Intenta con otros términos de búsqueda o revisa los filtros aplicados.</p>
                                <div class="empty-decoration">
                                    <div class="decoration-dot"></div>
                                    <div class="decoration-dot"></div>
                                    <div class="decoration-dot"></div>
                                </div>
                            `;
                            container.appendChild(msg);
                        }
                    } else if (noResultsMsg) {
                        noResultsMsg.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => noResultsMsg.remove(), 300);
                    }
                }, 300);
            });
            
            // Efecto de foco mejorado
            busquedaMovil.addEventListener('focus', function() {
                this.parentElement.style.transform = 'scale(1.02)';
                this.parentElement.style.boxShadow = '0 8px 25px rgba(0, 156, 60, 0.15)';
            });
            
            busquedaMovil.addEventListener('blur', function() {
                this.parentElement.style.transform = 'scale(1)';
                this.parentElement.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.05)';
            });
        }
        
        // Filtros rápidos móvil mejorados
        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // Efecto de ripple
                const ripple = document.createElement('span');
                ripple.style.cssText = `
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.6);
                    transform: scale(0);
                    animation: ripple 0.6s linear;
                    width: 20px;
                    height: 20px;
                    left: 50%;
                    top: 50%;
                    margin-left: -10px;
                    margin-top: -10px;
                `;
                this.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
                
                // Remover clase activa de todos los botones con animación
                filterBtns.forEach(b => {
                    b.classList.remove('active');
                    b.style.transform = 'scale(1)';
                });
                
                // Agregar clase activa al botón clickeado con animación
                this.classList.add('active');
                this.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
                
                const filter = this.getAttribute('data-filter');
                const cards = document.querySelectorAll('.solicitud-card');
                let visibleCount = 0;
                
                cards.forEach((card, index) => {
                    let show = false;
                    
                    switch(filter) {
                        case 'todos':
                            show = true;
                            break;
                        case 'alta':
                            show = card.getAttribute('data-prioridad') === 'alta';
                            break;
                        case 'vencidas':
                            show = card.getAttribute('data-estado') === 'text-danger';
                            break;
                        case 'sin_asignar':
                            show = card.getAttribute('data-asignado') === 'sin_asignar';
                            break;
                    }
                    
                    if (show) {
                        card.style.display = 'block';
                        card.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s both`;
                        visibleCount++;
                    } else {
                        card.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => {
                            card.style.display = 'none';
                        }, 300);
                    }
                });
                
                // Mostrar contador de resultados
                setTimeout(() => {
                    const activeFilter = this.textContent.trim();
                    showFilterResults(visibleCount, activeFilter);
                }, 500);
            });
        });
        
        // Función para mostrar resultados de filtro
        function showFilterResults(count, filterName) {
            // Remover mensaje anterior si existe
            const existingMsg = document.querySelector('.filter-results-msg');
            if (existingMsg) existingMsg.remove();
            
            if (count === 0) return;
            
            const container = document.getElementById('solicitudesMovil');
            const msg = document.createElement('div');
            msg.className = 'filter-results-msg';
            msg.style.cssText = `
                background: linear-gradient(135deg, rgba(0, 156, 60, 0.1), rgba(34, 166, 80, 0.15));
                color: #009c3c;
                padding: 12px 20px;
                border-radius: 12px;
                margin-bottom: 20px;
                text-align: center;
                font-weight: 600;
                font-size: 14px;
                border: 1px solid rgba(0, 156, 60, 0.3);
                animation: slideInDown 0.5s ease-out;
            `;
            msg.innerHTML = `
                <i class="fas fa-filter" style="margin-right: 8px;"></i>
                ${count} solicitud${count !== 1 ? 'es' : ''} ${filterName.toLowerCase()}
            `;
            
            container.insertBefore(msg, container.firstChild);
            
            // Auto-remover después de 3 segundos
            setTimeout(() => {
                if (msg.parentNode) {
                    msg.style.animation = 'slideOutUp 0.3s ease-out';
                    setTimeout(() => msg.remove(), 300);
                }
            }, 3000);
        }
    });
    
    // Función para toggle de menús desplegables
    function toggleMenu(button) {
        const menu = button.nextElementSibling;
        const allMenus = document.querySelectorAll('.menu-dropdown');
        
        // Cerrar todos los otros menús
        allMenus.forEach(m => {
            if (m !== menu) {
                m.classList.add('hidden');
            }
        });
        
        // Toggle del menú actual
        menu.classList.toggle('hidden');
        
        // Cerrar menú al hacer click fuera
        if (!menu.classList.contains('hidden')) {
            document.addEventListener('click', function closeMenu(e) {
                if (!button.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.add('hidden');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }
    }
    
    // Función para eliminar solicitud (reutilizada)
    function eliminarSolicitud(id) {
        mostrarModalConfirmacion('Eliminar Solicitud', function() {
            // CALLBACK DE CONFIRMACIÓN PARA ELIMINAR
            console.log('✅ Confirmado eliminar solicitud:', id);
            
            fetch(`/workflow/api/solicitudes/${id}/eliminar/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
            .then(response => {
                if (response.ok) {
                                if (typeof showToast !== 'undefined') {
                    showToast('Solicitud eliminada exitosamente', 'success', 4000);
                } else {
                    mostrarNotificacionExito('Solicitud eliminada exitosamente');
                }
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    if (typeof toastr !== 'undefined') {
                        toastr.error('Error al eliminar la solicitud');
                    } else {
                        mostrarNotificacionError('Error al eliminar la solicitud');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof showToast !== 'undefined') {
                    showToast('Error al eliminar la solicitud', 'error', 5000);
                } else {
                    mostrarNotificacionError('Error al eliminar la solicitud');
                }
            });
        }, function() {
            // CALLBACK DE CANCELACIÓN
            console.log('❌ Cancelada eliminación de solicitud');
        });
    }
    
    // Función para toggle de secciones móviles
    function toggleSection(sectionId) {
        let content, toggleBtn;
        
        if (sectionId === 'kpis-section') {
            content = document.querySelector('.kpis-content');
            toggleBtn = document.getElementById('toggle-kpis');
        } else if (sectionId === 'filters-section') {
            content = document.querySelector('.filters-content');
            toggleBtn = document.getElementById('toggle-filters');
        }
        
        const toggleText = toggleBtn.querySelector('.toggle-text');
        const icon = toggleBtn.querySelector('i');
        
        if (content && toggleBtn) {
            if (content.classList.contains('collapsed')) {
                // Mostrar contenido
                content.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                
                if (sectionId === 'kpis-section') {
                    toggleText.textContent = 'Ocultar KPIs';
                    icon.className = 'fas fa-chart-bar me-1';
                } else if (sectionId === 'filters-section') {
                    toggleText.textContent = 'Ocultar Filtros';
                    icon.className = 'fas fa-filter me-1';
                }
            } else {
                // Ocultar contenido
                content.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                
                if (sectionId === 'kpis-section') {
                    toggleText.textContent = 'Mostrar KPIs';
                    icon.className = 'fas fa-chart-bar me-1';
                } else if (sectionId === 'filters-section') {
                    toggleText.textContent = 'Mostrar Filtros';
                    icon.className = 'fas fa-filter me-1';
                }
            }
            
            // Guardar estado en localStorage
            localStorage.setItem(sectionId + '_collapsed', content.classList.contains('collapsed'));
        }
    }
    
    // Restaurar estado de secciones al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        ['kpis-section', 'filters-section'].forEach(sectionId => {
            const isCollapsed = localStorage.getItem(sectionId + '_collapsed') === 'true';
            if (isCollapsed) {
                // Aplicar estado colapsado directamente sin animación
                let content, toggleBtn;
                
                if (sectionId === 'kpis-section') {
                    content = document.querySelector('.kpis-content');
                    toggleBtn = document.getElementById('toggle-kpis');
                } else if (sectionId === 'filters-section') {
                    content = document.querySelector('.filters-content');
                    toggleBtn = document.getElementById('toggle-filters');
                }
                
                if (content && toggleBtn) {
                    content.classList.add('collapsed');
                    toggleBtn.classList.add('collapsed');
                    
                    const toggleText = toggleBtn.querySelector('.toggle-text');
                    const icon = toggleBtn.querySelector('i');
                    
                    if (sectionId === 'kpis-section') {
                        toggleText.textContent = 'Mostrar KPIs';
                    } else if (sectionId === 'filters-section') {
                        toggleText.textContent = 'Mostrar Filtros';
                    }
                }
            }
        });
        
        // ============================================
        // FUNCIONALIDAD DE FILTROS COLLAPSE
        // ============================================
        
        // Configurar toggle de filtros
        const filtrosCollapse = document.getElementById('filtrosCollapse');
        const toggleIcon = document.getElementById('toggleIcon');
        const toggleText = document.getElementById('toggleText');
        
        if (filtrosCollapse && toggleIcon && toggleText) {
            // Restaurar estado desde localStorage, por defecto colapsado
            const isCollapsed = localStorage.getItem('filtros_collapsed');
            
            // Si no hay valor guardado, usar estado por defecto (colapsado)
            if (isCollapsed === null || isCollapsed === 'true') {
                filtrosCollapse.classList.remove('show');
                toggleIcon.className = 'fas fa-eye-slash';
                toggleText.textContent = 'Mostrar filtros';
                localStorage.setItem('filtros_collapsed', 'true');
            } else {
                // Solo expandir si explícitamente se guardó como expandido
                filtrosCollapse.classList.add('show');
                toggleIcon.className = 'fas fa-eye';
                toggleText.textContent = 'Ocultar filtros';
            }
            
            // Manejar eventos de collapse
            filtrosCollapse.addEventListener('show.bs.collapse', function () {
                toggleIcon.className = 'fas fa-eye';
                toggleText.textContent = 'Ocultar filtros';
                localStorage.setItem('filtros_collapsed', 'false');
            });
            
            filtrosCollapse.addEventListener('hide.bs.collapse', function () {
                toggleIcon.className = 'fas fa-eye-slash';
                toggleText.textContent = 'Mostrar filtros';
                localStorage.setItem('filtros_collapsed', 'true');
            });
        }
        
        // ============================================
        // FUNCIONALIDAD KANBAN
        // ============================================
        
        // Configurar filtros Kanban
        function configurarFiltrosKanban() {
            const kanbanBoard = document.querySelector('.kanban-board');
            if (!kanbanBoard) return; // Solo si estamos en vista Kanban
            
            console.log('Configurando filtros Kanban...');
            
            // Obtener valores únicos de todas las tarjetas
            var clientes = new Set();
            var estados = new Set();
            var asignados = new Set();
            var slas = new Set();
            
            const kanbanCards = document.querySelectorAll('.kanban-card');
            kanbanCards.forEach(function(card) {
                var cliente = card.getAttribute('data-cliente');
                var estado = card.getAttribute('data-estado');
                var asignado = card.getAttribute('data-asignado');
                var sla = card.getAttribute('data-sla');
                
                if (cliente && cliente !== 'Sin cliente') clientes.add(cliente);
                if (estado && estado !== 'Sin estado') estados.add(estado);
                if (asignado && asignado !== 'Sin asignar') asignados.add(asignado);
                if (sla && sla !== 'sin sla') slas.add(sla);
            });
            
            // Poblar filtros
            var filtroCliente = document.getElementById('kanbanFiltroCliente');
            var filtroEstado = document.getElementById('kanbanFiltroEstado');
            var filtroAsignado = document.getElementById('kanbanFiltroAsignado');
            var filtroSLA = document.getElementById('kanbanFiltroSLA');
            
            // Limpiar opciones existentes (excepto la primera)
            if (filtroCliente) {
                const firstOption = filtroCliente.querySelector('option:first-child');
                filtroCliente.innerHTML = '';
                if (firstOption) filtroCliente.appendChild(firstOption);
            }
            if (filtroEstado) {
                const firstOption = filtroEstado.querySelector('option:first-child');
                filtroEstado.innerHTML = '';
                if (firstOption) filtroEstado.appendChild(firstOption);
            }
            if (filtroAsignado) {
                const firstOption = filtroAsignado.querySelector('option:first-child');
                filtroAsignado.innerHTML = '';
                if (firstOption) filtroAsignado.appendChild(firstOption);
            }
            if (filtroSLA) {
                const firstOption = filtroSLA.querySelector('option:first-child');
                filtroSLA.innerHTML = '';
                if (firstOption) filtroSLA.appendChild(firstOption);
            }
            
            // Agregar nuevas opciones
            Array.from(clientes).sort().forEach(function(cliente) {
                if (filtroCliente) {
                    const option = document.createElement('option');
                    option.value = cliente;
                    option.textContent = cliente;
                    filtroCliente.appendChild(option);
                }
            });
            
            Array.from(estados).sort().forEach(function(estado) {
                if (filtroEstado) {
                    const option = document.createElement('option');
                    option.value = estado;
                    option.textContent = estado;
                    filtroEstado.appendChild(option);
                }
            });
            
            Array.from(asignados).sort().forEach(function(asignado) {
                if (filtroAsignado) {
                    const option = document.createElement('option');
                    option.value = asignado;
                    option.textContent = asignado;
                    filtroAsignado.appendChild(option);
                }
            });
            
            Array.from(slas).sort().forEach(function(sla) {
                if (filtroSLA) {
                    var texto = sla === 'vencido' ? 'Vencido' : 
                               sla === 'por vencer' ? 'Por vencer' : 
                               sla === 'en tiempo' ? 'En tiempo' : sla;
                    const option = document.createElement('option');
                    option.value = sla;
                    option.textContent = texto;
                    filtroSLA.appendChild(option);
                }
            });
            
            console.log('Filtros Kanban configurados:', {
                clientes: clientes.size,
                estados: estados.size,
                asignados: asignados.size,
                slas: slas.size
            });
            
            // Actualizar contadores
            actualizarContadoresKanban();
        }
        
        // Aplicar filtros Kanban
        function aplicarFiltrosKanban() {
            const kanbanCards = document.querySelectorAll('.kanban-card');
            if (kanbanCards.length === 0) return;
            
            const filtroClienteEl = document.getElementById('kanbanFiltroCliente');
            const filtroEstadoEl = document.getElementById('kanbanFiltroEstado');
            const filtroAsignadoEl = document.getElementById('kanbanFiltroAsignado');
            const filtroSLAEl = document.getElementById('kanbanFiltroSLA');
            const busquedaGlobalEl = document.getElementById('kanbanBusquedaGlobal');
            
            var filtroCliente = filtroClienteEl ? filtroClienteEl.value : '';
            var filtroEstado = filtroEstadoEl ? filtroEstadoEl.value : '';
            var filtroAsignado = filtroAsignadoEl ? filtroAsignadoEl.value : '';
            var filtroSLA = filtroSLAEl ? filtroSLAEl.value : '';
            var busquedaGlobal = busquedaGlobalEl ? busquedaGlobalEl.value.toLowerCase() : '';
            
            kanbanCards.forEach(function(card) {
                var mostrar = true;
                
                // Filtro cliente
                if (filtroCliente && card.getAttribute('data-cliente') !== filtroCliente) {
                    mostrar = false;
                }
                
                // Filtro estado
                if (filtroEstado && card.getAttribute('data-estado') !== filtroEstado) {
                    mostrar = false;
                }
                
                // Filtro asignado
                if (filtroAsignado && card.getAttribute('data-asignado') !== filtroAsignado) {
                    mostrar = false;
                }
                
                // Filtro SLA
                if (filtroSLA && card.getAttribute('data-sla') !== filtroSLA) {
                    mostrar = false;
                }
                
                // Búsqueda global
                const searchData = card.getAttribute('data-search');
                if (busquedaGlobal && searchData && !searchData.includes(busquedaGlobal)) {
                    mostrar = false;
                }
                
                card.style.display = mostrar ? '' : 'none';
            });
            
            // Actualizar contadores y mostrar mensajes cuando no hay solicitudes
            actualizarContadoresKanban();
            mostrarMensajesVacios();
        }
        
        // Actualizar contadores de etapas
        function actualizarContadoresKanban() {
            const kanbanColumns = document.querySelectorAll('.kanban-column');
            kanbanColumns.forEach(function(column) {
                const columnBody = column.querySelector('.kanban-column-body');
                if (columnBody) {
                    const etapaId = columnBody.getAttribute('data-etapa-id');
                    const visibleCards = columnBody.querySelectorAll('.kanban-card:not([style*="display: none"])');
                    const count = visibleCards.length;
                    const countElement = document.getElementById('count-etapa-' + etapaId);
                    if (countElement) {
                        countElement.textContent = count;
                    }
                }
            });
        }
        
        // Mostrar mensajes cuando no hay solicitudes visibles
        function mostrarMensajesVacios() {
            const kanbanColumnBodies = document.querySelectorAll('.kanban-column-body');
            kanbanColumnBodies.forEach(function(body) {
                const visibleCards = body.querySelectorAll('.kanban-card:not([style*="display: none"])');
                const hasVisible = visibleCards.length > 0;
                const noSolicitudesElement = body.querySelector('.no-solicitudes');
                if (noSolicitudesElement) {
                    noSolicitudesElement.style.display = hasVisible ? 'none' : '';
                }
            });
        }
        
        // Búsqueda por etapa - Event delegation
        document.addEventListener('input', function(event) {
            if (event.target.classList.contains('etapa-search')) {
                const input = event.target;
                const etapaId = input.getAttribute('data-etapa-id');
                const searchTerm = input.value.toLowerCase();
                
                const columnBody = document.querySelector(`.kanban-column-body[data-etapa-id="${etapaId}"]`);
                if (columnBody) {
                    const cards = columnBody.querySelectorAll('.kanban-card');
                    cards.forEach(function(card) {
                        const searchData = card.getAttribute('data-search');
                        const shouldShow = !searchTerm || (searchData && searchData.includes(searchTerm));
                        card.style.display = shouldShow ? '' : 'none';
                    });
                }
                
                actualizarContadoresKanban();
                mostrarMensajesVacios();
            }
        });
        
        // Event listeners para filtros Kanban
        const kanbanFilters = [
            'kanbanFiltroCliente', 
            'kanbanFiltroEstado', 
            'kanbanFiltroAsignado', 
            'kanbanFiltroSLA'
        ];
        
        kanbanFilters.forEach(function(filterId) {
            const filterElement = document.getElementById(filterId);
            if (filterElement) {
                filterElement.addEventListener('change', aplicarFiltrosKanban);
            }
        });
        
        const busquedaGlobal = document.getElementById('kanbanBusquedaGlobal');
        if (busquedaGlobal) {
            busquedaGlobal.addEventListener('input', aplicarFiltrosKanban);
        }
        
        // Limpiar filtros Kanban
        const limpiarFiltros = document.getElementById('kanbanLimpiarFiltros');
        if (limpiarFiltros) {
            limpiarFiltros.addEventListener('click', function() {
                // Limpiar filtros principales
                kanbanFilters.forEach(function(filterId) {
                    const filterElement = document.getElementById(filterId);
                    if (filterElement) {
                        filterElement.value = '';
                    }
                });
                
                // Limpiar búsqueda global
                if (busquedaGlobal) {
                    busquedaGlobal.value = '';
                }
                
                // Limpiar búsquedas por etapa
                const etapaSearches = document.querySelectorAll('.etapa-search');
                etapaSearches.forEach(function(search) {
                    search.value = '';
                });
                
                // Mostrar todas las tarjetas
                const kanbanCards = document.querySelectorAll('.kanban-card');
                kanbanCards.forEach(function(card) {
                    card.style.display = '';
                });
                
                actualizarContadoresKanban();
                mostrarMensajesVacios();
            });
        }
        
        // Cambio de etapa desde dropdown en Kanban
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('cambiar-etapa-kanban')) {
                event.preventDefault();
                
                const link = event.target;
                const solicitudId = link.getAttribute('data-solicitud-id') || link.dataset.solicitudId;
                const etapaId = link.getAttribute('data-etapa-id') || link.dataset.etapaId;
                const etapaNombre = link.getAttribute('data-etapa-nombre') || link.dataset.etapaNombre;
                
                // Confirmar cambio con modal personalizado
                mostrarModalConfirmacion(etapaNombre, function() {
                    // Función que se ejecuta al confirmar - Fetch API para Kanban
                    console.log('Ejecutando cambio de etapa Kanban:', solicitudId, etapaId);
                    
                    // Obtener CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    const csrfValue = csrfToken ? csrfToken.value : '';
                    
                    // Realizar petición Fetch para cambiar etapa
                    fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfValue,
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            etapa_id: etapaId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Respuesta del servidor Kanban:', data);
                        if (data.success) {
                            // Mostrar mensaje de éxito
                            if (typeof showToast !== 'undefined') {
                                showToast(data.mensaje || 'Etapa cambiada exitosamente', 'success', 4000);
                            } else {
                                alert('Etapa cambiada exitosamente');
                            }
                            
                            // Recargar la página para mostrar cambios
                            setTimeout(function() {
                                location.reload();
                            }, 1000);
                        } else {
                            alert('Error: ' + (data.error || 'No se pudo cambiar la etapa'));
                        }
                    })
                    .catch(error => {
                        console.error('Error Fetch Kanban:', error);
                        var errorMsg = 'Error al cambiar etapa';
                        
                        if (error.message) {
                            errorMsg = error.message;
                        } else {
                            errorMsg = 'Error de conexión';
                        }
                        
                        alert(errorMsg);
                    });
                });
            }
        });
        });
        
        function realizarCambioEtapaKanban(solicitudId, etapaId, etapaNombre) {
            console.log('🔄 KANBAN: Iniciando cambio de etapa', {
                solicitudId: solicitudId,
                etapaId: etapaId,
                etapaNombre: etapaNombre
            });
            
            // Agregar indicador visual de carga
            const card = document.querySelector(`.kanban-card[data-solicitud-id="${solicitudId}"]`);
            if (card) {
                card.classList.add('updating');
                card.style.opacity = '0.6';
            }
            
            // Obtener CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfValue = csrfToken ? csrfToken.value : '';
            
            // Realizar petición Fetch
            fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfValue,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    etapa_id: etapaId
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('✅ KANBAN: Respuesta exitosa del servidor', data);
                
                if (data.success) {
                    // Mostrar toast de éxito
                    if (typeof toastr !== 'undefined') {
                        toastr.success(data.mensaje || `Solicitud movida a ${etapaNombre}`, 'Etapa Actualizada', {
                            positionClass: 'toast-top-right',
                            timeOut: 3000,
                            showMethod: 'slideDown',
                            hideMethod: 'slideUp'
                        });
                    } else {
                        mostrarNotificacionExito(data.mensaje || `Solicitud movida a ${etapaNombre}`);
                    }
                    
                    console.log('🔄 KANBAN: Actualizando vista...');
                    
                    // Animar movimiento de tarjeta
                    if (card) {
                        card.style.transition = 'opacity 0.3s';
                        card.style.opacity = '0';
                        
                        setTimeout(() => {
                            // Mover la tarjeta a la nueva columna
                            const nuevaColumna = document.querySelector(`.kanban-column-body[data-etapa-id="${etapaId}"]`);
                            
                            if (nuevaColumna) {
                                // Actualizar atributos de la tarjeta
                                card.setAttribute('data-etapa-id', etapaId);
                                
                                // Mover físicamente la tarjeta
                                nuevaColumna.appendChild(card);
                                
                                // Restablecer opacidad y animar aparición
                                card.style.opacity = '1';
                                card.classList.remove('updating');
                                
                                // Actualizar contadores
                                actualizarContadoresKanban();
                                
                                console.log('✅ KANBAN: Vista actualizada correctamente');
                            }
                        }, 300);
                    }
                    
                    // Sincronizar con otras vistas
                    sincronizarCambioEtapa(solicitudId, etapaId, data);
                    
                } else {
                    console.error('❌ KANBAN: Error en respuesta del servidor', data.error);
                    
                    // Mostrar toast de error
                    if (typeof toastr !== 'undefined') {
                        toastr.error(data.error || 'Error desconocido', 'Error al Cambiar Etapa', {
                            positionClass: 'toast-top-right',
                            timeOut: 5000
                        });
                    } else {
                        mostrarNotificacionError(data.error || 'Error al cambiar etapa');
                    }
                }
            })
            .catch(error => {
                console.error('❌ KANBAN: Error Fetch', error);
                
                var errorMsg = 'Error al cambiar etapa';
                if (error.message) {
                    errorMsg = error.message;
                } else {
                    errorMsg = 'Error de conexión con el servidor';
                }
                
                // Mostrar toast de error
                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMsg, 'Error de Conexión', {
                        positionClass: 'toast-top-right',
                        timeOut: 5000
                    });
                } else {
                    mostrarNotificacionError(errorMsg);
                }
            })
            .finally(() => {
                // Asegurar que se remueva el indicador de carga
                if (card) {
                    card.classList.remove('updating');
                    card.style.opacity = '1';
                }
                console.log('🏁 KANBAN: Petición completada');
            });
        }
        
        // Inicializar drag and drop cuando la página esté lista
        const kanbanBoard = document.querySelector('.kanban-board');
        if (kanbanBoard) {
            console.log('Inicializando drag and drop para Kanban...');
            inicializarDragAndDrop();
            
            // Solo configurar filtros si existen los elementos de filtro
            const kanbanFiltroCliente = document.getElementById('kanbanFiltroCliente');
            if (kanbanFiltroCliente) {
                configurarFiltrosKanban();
            }
        }
        
        // ============================================
        // DRAG & DROP FUNCIONALIDAD
        // ============================================
        
        function inicializarDragAndDrop() {
            // Evitar inicialización múltiple
            const kanbanCards = document.querySelectorAll('.kanban-card');
            if (kanbanCards.length > 0 && kanbanCards[0].dataset.dragInitialized === 'true') {
                console.log('Drag and drop ya inicializado, saltando...');
                return;
            }
            
            console.log('Configurando eventos de drag and drop...');
            console.log('Tarjetas Kanban encontradas:', kanbanCards.length);
            console.log('Columnas Kanban encontradas:', document.querySelectorAll('.kanban-column-body').length);
            
            // Marcar como inicializado
            kanbanCards.forEach(function(card) {
                card.dataset.dragInitialized = 'true';
            });
            
            // Configurar eventos de drag para las tarjetas
            kanbanCards.forEach(function(card) {
                card.addEventListener('dragstart', function(e) {
                    var solicitudId = this.getAttribute('data-solicitud-id');
                    var etapaActual = this.getAttribute('data-etapa-id');
                    
                    console.log('🔄 Iniciando drag de solicitud:', solicitudId, 'desde etapa:', etapaActual);
                    
                    var dragData = JSON.stringify({
                        solicitudId: solicitudId,
                        etapaActual: etapaActual
                    });
                    e.dataTransfer.setData('text/plain', dragData);
                    e.dataTransfer.effectAllowed = 'move';
                    
                    console.log('📦 Datos de drag configurados:', dragData);
                    
                    this.classList.add('dragging');
                    
                    // Agregar efecto visual a las zonas de drop
                    const dropZones = document.querySelectorAll('.kanban-column-body');
                    dropZones.forEach(function(zone) {
                        zone.classList.add('drop-zone-active');
                    });
                });
                
                card.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                    const dropZones = document.querySelectorAll('.kanban-column-body');
                    dropZones.forEach(function(zone) {
                        zone.classList.remove('drop-zone-active');
                    });
                });
            });
            
            // Configurar eventos de drop para las columnas
            const kanbanColumnBodies = document.querySelectorAll('.kanban-column-body');
            kanbanColumnBodies.forEach(function(columnBody) {
                columnBody.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    
                    // Obtener información de la tarjeta que se está arrastrando
                    var dragData = null;
                    try {
                        // Solo intentar obtener datos si hay tipos de datos disponibles
                        if (e.dataTransfer.types.includes('text/plain')) {
                            dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                        }
                    } catch (error) {
                        console.log('No se pudieron obtener datos del drag:', error);
                        // Si no hay datos, permitir hover normal
                        this.classList.add('drop-zone-hover');
                        return;
                    }
                    
                    var solicitudId = dragData.solicitudId;
                    var nuevaEtapaId = this.getAttribute('data-etapa-id');
                    
                    // Simplemente mostrar hover visual sin validación en dragover
                    this.classList.add('drop-zone-hover');
                });
                
                columnBody.addEventListener('dragleave', function(e) {
                    this.classList.remove('drop-zone-hover', 'drop-zone-valid', 'drop-zone-invalid');
                });
                
                columnBody.addEventListener('drop', function(e) {
                    e.preventDefault();
                    
                    const dropZone = this;
                    const nuevaEtapaId = dropZone.getAttribute('data-etapa-id');
                    
                    console.log('🎯 Drop detectado en etapa:', nuevaEtapaId);
                    
                    // Remover clases de hover
                    dropZone.classList.remove('drop-zone-hover', 'drop-zone-active');
                    const allDropZones = document.querySelectorAll('.kanban-column-body');
                    allDropZones.forEach(function(zone) {
                        zone.classList.remove('drop-zone-active');
                    });
                    
                    try {
                        var data = JSON.parse(e.dataTransfer.getData('text/plain'));
                        var solicitudId = data.solicitudId;
                        var etapaActual = data.etapaActual;
                        
                        console.log('📥 Datos de drop recibidos:', data);
                        
                        // Verificar si es un movimiento válido
                        if (nuevaEtapaId === etapaActual) {
                            console.log('Movimiento cancelado: misma etapa');
                            return;
                        }
                        
                        // NUEVO: Validar transición antes de permitir el drop
                        validarTransicionKanban(solicitudId, nuevaEtapaId, function(esValida, mensaje, requisitosFaltantes) {
                            if (!esValida) {
                                // Si hay requisitos faltantes, mostrar el modal de requisitos
                                if (requisitosFaltantes && requisitosFaltantes.length > 0) {
                                    console.log('📋 Mostrando modal de requisitos faltantes:', requisitosFaltantes);
                                    
                                    // Obtener nombre de la nueva etapa
                                    var nuevaEtapaNombre = dropZone.closest('.kanban-column').querySelector('.card-header h6').textContent.trim();
                                    nuevaEtapaNombre = nuevaEtapaNombre.replace(/\d+$/, '').trim(); // Remover contador
                                    
                                    // Usar la función global correcta que maneja la carga de requisitos
                                    if (typeof window.mostrarModalRequisitosFaltantes === 'function') {
                                        console.log('✅ Función disponible, llamando con parámetros correctos');
                                        try {
                                            window.mostrarModalRequisitosFaltantes(solicitudId, nuevaEtapaId, nuevaEtapaNombre, function() {
                                                // Callback de éxito - proceder con el cambio
                                                console.log('✅ Requisitos completados, procediendo con cambio de etapa');
                                                window.ejecutarCambioEtapa(solicitudId, nuevaEtapaId, null, null, null, true, nuevaEtapaNombre);
                                            }, function() {
                                                // Callback de cancelación
                                                console.log('❌ Cambio de etapa cancelado');
                                                // No hacer nada, la tarjeta se queda en su lugar
                                            });
                                        } catch (error) {
                                            console.error('❌ Error al llamar mostrarModalRequisitosFaltantes:', error);
                                            if (typeof showToast !== 'undefined') {
                                                showToast('Error al mostrar modal de requisitos: ' + error.message, 'error', 6000);
                                            } else {
                                                alert('Error al mostrar modal de requisitos: ' + error.message);
                                            }
                                        }
                                    } else {
                                        console.error('❌ Función mostrarModalRequisitosFaltantes no disponible');
                                        if (typeof showToast !== 'undefined') {
                                            showToast('Error: Función de requisitos no disponible', 'error', 6000);
                                        } else {
                                            alert('Error: Función de requisitos no disponible');
                                        }
                                    }
                                } else {
                                    // Mostrar error y cancelar movimiento
                                    if (typeof toastr !== 'undefined') {
                                        toastr.error(mensaje, 'Transición No Válida', {
                                            positionClass: 'toast-top-right',
                                            timeOut: 5000
                                        });
                                    } else {
                                        mostrarNotificacionError(mensaje);
                                    }
                                }
                                return;
                            }
                            
                            // Obtener nombre de la nueva etapa
                            var nuevaEtapaNombre = dropZone.closest('.kanban-column').querySelector('.card-header h6').textContent.trim();
                            nuevaEtapaNombre = nuevaEtapaNombre.replace(/\d+$/, '').trim(); // Remover contador
                            
                            // Confirmar movimiento con modal personalizado
                            window.mostrarModalConfirmacion(nuevaEtapaNombre, function() {
                                // Función que se ejecuta al confirmar - usar función unificada
                                console.log('Ejecutando cambio de etapa Drag & Drop:', solicitudId, nuevaEtapaId);
                                window.ejecutarCambioEtapa(solicitudId, nuevaEtapaId, null, null, null, true, nuevaEtapaNombre);
                            });
                        });
                        return;
                    
                } catch (error) {
                    console.error('Error al procesar drop:', error);
                }
            });
        }
    }
    
    
    
    // Función para validar transiciones en Kanban
    function validarTransicionKanban(solicitudId, nuevaEtapaId, callback) {
        console.log('🔍 Validando transición Kanban:', solicitudId, nuevaEtapaId);
        
        // Validar parámetros
        if (!solicitudId || !nuevaEtapaId || typeof callback !== 'function') {
            console.error('❌ Parámetros inválidos para validarTransicionKanban');
            callback(false, 'Parámetros inválidos', []);
            return;
        }
        
        try {
            fetch(`/workflow/api/solicitudes/${solicitudId}/transiciones-validas/`)
            .then(response => {
                // Verificar si la respuesta es exitosa
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // Verificar si el contenido es JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('La respuesta no es JSON válido');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Buscar si la transición es válida
                    var transicionValida = data.transiciones.find(function(t) {
                        return t.etapa_destino.id == nuevaEtapaId;
                    });
                    
                    if (transicionValida) {
                        if (transicionValida.puede_realizar) {
                            callback(true, 'Transición válida', []);
                        } else {
                            var mensaje = `No puedes mover a "${transicionValida.etapa_destino.nombre}" porque faltan ${transicionValida.total_requisitos_faltantes} requisito(s) obligatorio(s)`;
                            callback(false, mensaje, transicionValida.requisitos_faltantes);
                        }
                    } else {
                        callback(false, 'No existe una transición válida hacia esta etapa', []);
                    }
                } else {
                    callback(false, 'Error al validar transición: ' + (data.error || 'Error desconocido'), []);
                }
            })
            .catch(error => {
                console.error('❌ Error validando transición Kanban:', error);
                let mensajeError = 'Error de conexión al validar transición';
                if (error.message.includes('404')) {
                    mensajeError = 'No se encontró la solicitud';
                } else if (error.message.includes('403')) {
                    mensajeError = 'No tienes permisos para esta solicitud';
                } else if (error.message.includes('500')) {
                    mensajeError = 'Error interno del servidor';
                } else if (error.message.includes('JSON')) {
                    mensajeError = 'Error en el formato de respuesta';
                }
                
                // Usar callback en lugar de mostrar notificación directamente
                callback(false, mensajeError, []);
            });
        } catch (error) {
            console.error('❌ Error crítico en validarTransicionKanban:', error);
            callback(false, 'Error interno en la validación', []);
        }
    }
    
    // Nueva función para actualizar kanban tras movimiento sin recargar página
    window.actualizarKanbanTrasMovimiento = function(solicitudId, nuevaEtapaId, etapaNombre) {
        console.log('🔄 Actualizando kanban tras movimiento', {
            solicitudId: solicitudId,
            nuevaEtapaId: nuevaEtapaId,
            etapaNombre: etapaNombre
        });
        
        const card = document.querySelector(`.kanban-card[data-solicitud-id="${solicitudId}"]`);
        const nuevaColumna = document.querySelector(`.kanban-column-body[data-etapa-id="${nuevaEtapaId}"]`);
        
        if (card && nuevaColumna) {
            // Animar movimiento suave
            card.style.transition = 'opacity 0.3s';
            card.style.opacity = '0';
            
            setTimeout(() => {
                // Actualizar atributos
                card.setAttribute('data-etapa-id', nuevaEtapaId);
                
                // Mover a nueva columna
                nuevaColumna.appendChild(card);
                
                // Mostrar con animación
                card.style.opacity = '1';
                
                // Actualizar contadores
                if (typeof actualizarContadoresKanban === 'function') {
                    actualizarContadoresKanban();
                }
                
                console.log('✅ Kanban actualizado dinámicamente');
            }, 300);
        } else {
            console.warn('⚠️ No se pudo encontrar la tarjeta o columna para actualizar');
            // Fallback: recargar página después de un breve delay
            setTimeout(() => {
                console.log('🔄 Recargando página como fallback...');
                location.reload();
            }, 1500);
        }
    };
    
    function mostrarNotificacionExito(mensaje) {
        // Crear notificación flotante
        const notificacion = document.createElement('div');
        notificacion.className = 'drag-notification';
        notificacion.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            ${mensaje}
        `;
        
        document.body.appendChild(notificacion);
        
        // Animar entrada
        setTimeout(() => {
            notificacion.classList.add('show');
        }, 100);
        
        // Auto-remover después de 3 segundos
        setTimeout(() => {
            notificacion.classList.remove('show');
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.parentNode.removeChild(notificacion);
                }
            }, 300);
        }, 3000);
    }
    
    // 🏗️ SISTEMA DE SINCRONIZACIÓN CON OTRAS VISTAS
    function sincronizarCambioEtapa(solicitudId, nuevaEtapaId, response) {
        // Comunicación entre pestañas/ventanas usando BroadcastChannel
        if ('BroadcastChannel' in window) {
            if (!window.workflowChannel) {
                window.workflowChannel = new BroadcastChannel('workflow-sync');
            }
            
            // Crear notificación de cambio de etapa
            const notification = {
                type: 'solicitud_cambio_etapa',
                data: {
                    solicitud_id: solicitudId,
                    codigo: response.codigo || 'N/A',
                    etapa_actual: {
                        id: nuevaEtapaId,
                        nombre: response.nueva_etapa.nombre
                    },
                    etapa_anterior: response.etapa_anterior,
                    user_action: {
                        username: 'current_user'
                    },
                    timestamp: new Date().toISOString()
                }
            };
            
            // Enviar notificación a otras pestañas
            window.workflowChannel.postMessage({
                type: 'sync_solicitud',
                notification: notification,
                source: 'tabla-kanban',
                timestamp: new Date().toISOString()
            });
        }
        
        // También usar localStorage como respaldo
        localStorage.setItem('workflow_last_sync', JSON.stringify({
            notification: {
                type: 'solicitud_cambio_etapa',
                data: {
                    solicitud_id: solicitudId,
                    etapa_actual: { id: nuevaEtapaId }
                }
            },
            timestamp: new Date().toISOString()
        }));
    }
    
    // BroadcastChannel para sincronización entre pestañas
    if ('BroadcastChannel' in window) {
        if (!window.workflowChannel) {
            window.workflowChannel = new BroadcastChannel('workflow_updates');
        }
        
        window.workflowChannel.onmessage = function(event) {
            if (event.data.type === 'etapa_changed') {
                console.log('🔄 Sincronización recibida:', event.data);
                // Recargar página para mostrar cambios
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        };
    }

    
</script>
-->

<style>
    /* APC Tracking Style Variables */
    :root {
        --primary-color: #2d5a2d;
        --primary-hover: #1e5f2a;
        --background-color: #f8fafc;
        --card-background: #ffffff;
        --border-color: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --border-radius: 12px;
        --border-radius-sm: 8px;
    }

    /* Override with Pacifico green if available */
    .negocios-container {
        --primary-color: var(--verde-pacifico, #2d5a2d) !important;
    }

    /* Status Badge Styles - Matching APC Tracking */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        transition: all 0.2s ease;
    }

    .status-pending {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        border: 1px solid #f59e0b;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
    }

    .status-in_progress {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        border: 1px solid #3b82f6;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        animation: pulse 2s infinite;
    }

    .status-completed {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #065f46;
        border: 1px solid #10b981;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }

    .status-error {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
        border: 1px solid #ef4444;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    /* Modern Table Styles - Matching APC Tracking */
    body .workflow-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 16px;
        border-radius: var(--border-radius-sm);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body .workflow-table th,
    body .workflow-table td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
        font-size: 0.875rem;
    }

    body .workflow-table th {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        font-weight: 700;
        color: var(--text-primary);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    body .workflow-table th:first-child {
        border-top-left-radius: var(--border-radius-sm);
    }

    body .workflow-table th:last-child {
        border-top-right-radius: var(--border-radius-sm);
    }

    body .workflow-table tbody tr {
        transition: all 0.2s ease;
    }

    body .workflow-table tbody tr:hover {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    body .workflow-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Table Container Styles */
    body .apc-table-container,
    body .table-responsive {
        background: var(--card-background) !important;
        border-radius: var(--border-radius);

        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        position: relative;
        overflow-x: auto;
        overflow-y: hidden;
    }

    /* Container position for scroll indicators */
    .table-container {
        position: relative !important;
    }

    .table-responsive {
        position: relative !important;
    }

    /* Enhanced Badge Styles */
    .workflow-table .badge {
        font-size: 0.75rem !important;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 12px;
    }

    .workflow-table .badge.bg-success {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0) !important;
        color: #065f46 !important;
        border: 1px solid #10b981;
    }

    .workflow-table .badge.bg-warning {
        background: linear-gradient(135deg, #fef3c7, #fde68a) !important;
        color: #92400e !important;
        border: 1px solid #f59e0b;
    }

    .workflow-table .badge.bg-danger {
        background: linear-gradient(135deg, #fee2e2, #fecaca) !important;
        color: #991b1b !important;
        border: 1px solid #ef4444;
    }

    .workflow-table .badge.bg-info {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;
        color: #1e40af !important;
        border: 1px solid #3b82f6;
    }

    .workflow-table .badge.bg-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)) !important;
        color: white !important;
        border: 1px solid var(--primary-color);
    }

    /* Form Controls Styling */
    .workflow-table .form-select-sm,
    .workflow-table .form-control-sm {
        font-size: 0.875rem !important;
        padding: 8px 12px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        transition: all 0.2s ease;
        background: var(--card-background);
        color: var(--text-primary);
    }

    .workflow-table .form-select-sm:focus,
    .workflow-table .form-control-sm:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .workflow-table .form-select-sm:hover,
    .workflow-table .form-control-sm:hover {
        border-color: var(--primary-color);
    }

    /* Link Styles */
    .workflow-table .solicitud-link {
        font-size: 0.9rem !important;
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .workflow-table .solicitud-link:hover {
        color: var(--primary-hover);
        text-decoration: underline;
    }

    /* Text Styles */
    .workflow-table .text-muted {
        font-size: 0.8rem !important;
        color: var(--text-muted);
    }

    .workflow-table .fw-semibold {
        font-size: 0.9rem !important;
        font-weight: 600;
        color: var(--text-primary);
    }

    .workflow-table small {
        font-size: 0.75rem !important;
        color: var(--text-secondary);
    }

    /* Icon Styles */
    .workflow-table .fas {
        font-size: 0.8rem !important;
        color: var(--text-secondary);
        transition: color 0.2s ease;
    }

    .workflow-table .fas:hover {
        color: var(--primary-color);
    }

    /* Remove table border and spacing issues */
    .workflow-table thead {
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9) !important;
    }

    .workflow-table thead tr {
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    .workflow-table thead th {
        border-top: none !important;
        border-left: none !important;
        border-right: none !important;
        border-bottom: 1px solid var(--border-color) !important;
        margin: 0 !important;
        padding: 16px !important;
    }

    .workflow-table thead::after,
    .workflow-table thead tr::after,
    .workflow-table thead th::after {
        content: none !important;
        display: none !important;
    }

    /* Clean table layout */
    .workflow-table tbody {
        margin: 0 !important;
        padding: 0 !important;
    }

    .workflow-table tbody tr:first-child {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }

    .workflow-table tbody tr:first-child td {
        margin-top: 0 !important;
        padding-top: 16px !important;
    }

    /* Remove container borders */
    .table-container {
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    .table-responsive {
        border: none !important;
        margin: 0 !important;
        background: var(--card-background) !important;
        border-radius: var(--border-radius) !important;
        box-shadow: var(--shadow-md) !important;
    }

    .card-body {
        padding: 24px !important;
        background: var(--card-background) !important;
    }

    /* Table border consistency */
    .workflow-table {
        border: none !important;
        background: var(--card-background) !important;
        border-radius: var(--border-radius-sm) !important;
        border-collapse: separate !important;
        border-spacing: 0 !important;
    }

    /* Dropdown and select improvements */
    .kanban-column .dropdown {
        z-index: 1020 !important;
    }

    .kanban-column .dropdown-menu {
        z-index: 1025 !important;
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-lg);
    }

    .kanban-column .dropdown-toggle {
        background: transparent !important;
        border: none !important;
        color: var(--text-secondary) !important;
    }

    /* Modern sorting indicators */
    .workflow-table th {
        position: relative !important;
        padding-right: 2rem !important;
    }

    .workflow-table th.sortable::after {
        content: '↕' !important;
        position: absolute !important;
        right: 8px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        font-size: 0.75rem !important;
        color: var(--text-muted) !important;
        opacity: 0.3 !important;
        transition: all 0.2s ease !important;
    }

    .workflow-table th.sortable:hover::after {
        opacity: 0.6 !important;
        color: var(--text-secondary) !important;
    }

    .workflow-table th.sorted-asc::after {
        content: '↑' !important;
        opacity: 1 !important;
        color: var(--primary-color) !important;
    }

    .workflow-table th.sorted-desc::after {
        content: '↓' !important;
        opacity: 1 !important;
        color: var(--primary-color) !important;
    }

    /* Custom scrollbar for table */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
        width: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        border-radius: 4px;
        transition: background 0.2s ease;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, var(--primary-hover), #155a15);
    }

    /* Ensure table maintains minimum width for scrolling */
    .workflow-table {
        min-width: 1200px;
    }

    /* Horizontal Scroll Indicators - Matching APC Tracking */
    .table-scroll-indicator {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        background: rgba(45, 90, 45, 0.8);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        opacity: 0;
        transition: all 0.3s ease;
        font-size: 16px;
        box-shadow: var(--shadow-md);
    }

    .table-scroll-indicator:hover {
        background: rgba(45, 90, 45, 1);
        transform: translateY(-50%) scale(1.1);
        box-shadow: var(--shadow-lg);
    }

    .table-scroll-indicator:active {
        transform: translateY(-50%) scale(0.95);
    }

    .table-scroll-indicator.left {
        left: 10px;
    }

    .table-scroll-indicator.right {
        right: 10px;
    }

    .table-scroll-indicator.visible {
        opacity: 1;
    }

    /* Scroll hint for users */
    .scroll-hint {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.875rem;
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
        pointer-events: none;
    }

    .scroll-hint.visible {
        opacity: 1;
    }

    /* Modern Table Styling - Matching APC Tracking */

    /* Card and Container Styles - Matching APC Tracking */
    .card {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
    }

    .card:hover {
        box-shadow: var(--shadow-md);
    }

    .card-header {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-bottom: 1px solid var(--border-color);
        padding: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .card-body {
        padding: 24px !important;
        background: var(--card-background) !important;
    }

    /* Button Styles - Matching APC Tracking */
    .btn {
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        transition: all 0.2s ease;
        font-size: 0.875rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        border-color: var(--primary-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-hover), #155a15);
        border-color: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-outline-primary {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .btn-outline-primary:hover {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    /* Input Styles - Matching APC Tracking */
    .form-control,
    .form-select {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        background: var(--card-background);
        color: var(--text-primary);
        transition: all 0.2s ease;
        font-size: 0.875rem;
    }

    .form-control:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .form-control:hover,
    .form-select:hover {
        border-color: var(--primary-color);
    }

    /* Loading Styles */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: var(--text-muted);
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 12px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Modern toast notification styles */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 20px;
        border-radius: var(--border-radius-sm);
        color: white;
        font-weight: 600;
        z-index: 9999;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        box-shadow: var(--shadow-lg);
        max-width: 350px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .toast-notification.show {
        opacity: 1;
        transform: translateX(0);
    }

    /* Ensure sections are hidden by default */
    #motivoConsultaSection {
        display: none !important;
    }

    #motivoConsultaSection.show {
        display: block !important;
    }

    #comoSeEnteroSection {
        display: none !important;
    }

    #comoSeEnteroSection.show {
        display: block !important;
    }

    #apcMakitoSection {
        display: none !important;
    }

    #apcMakitoSection.show {
        display: block !important;
    }

    .toast-notification.success {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .toast-notification.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    /* Modern auto-populated indicator styles */
    .selected-item.auto-populated {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;
        border: 1px solid #3b82f6 !important;
        border-radius: var(--border-radius-sm);
    }

    .auto-populated-indicator {
        color: #1e40af !important;
        font-size: 0.75rem !important;
        font-weight: 600;
        display: block !important;
        margin-top: 4px !important;
        font-style: italic;
    }

    /* Modern cliente placeholder styles */
    #clientePlaceholder {
        background: var(--card-background);
        border: 2px dashed var(--border-color);
        border-radius: var(--border-radius-sm);
        padding: 24px;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    #clientePlaceholder:hover {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    #clientePlaceholder i {
        font-size: 1.2rem;
        margin-bottom: 8px;
        display: block;
        color: var(--text-secondary);
    }

    /* === APC TRACKING FILTER STYLES === */
    .apc-filters {
        background: var(--card-background) !important;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }

    .apc-table-container {
        background: var(--card-background) !important;
        border-radius: 12px;
        padding: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }

    .section-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-title i {
        color: var(--primary-color);
        font-size: 1rem;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        align-items: end;
    }

    @media (max-width: 768px) {
        .filter-row {
            grid-template-columns: 1fr;
        }
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .filter-group select,
    .filter-group input {
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: var(--card-background);
        color: var(--text-primary);
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .filter-group select:hover,
    .filter-group input:hover {
        border-color: var(--primary-color);
    }

    .refresh-btn {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)) !important;
        color: white !important;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: var(--shadow-sm);
    }

    .refresh-btn:hover {
        background: linear-gradient(135deg, var(--primary-hover), #155a15) !important;
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        color: white !important;
    }

    .refresh-btn:active {
        transform: translateY(0);
        box-shadow: var(--shadow-sm);
    }

    /* Override for gap utility in filter buttons */
    .filter-group .d-flex.gap-2 {
        gap: 8px !important;
    }

    /* === FILTER COLLAPSE STYLES === */
    .apc-filters .section-title {
        margin-bottom: 0 !important;
    }

    .apc-filters .btn-outline-secondary {
        border-color: var(--border-color);
        color: var(--text-secondary);
        font-size: 0.875rem;
        padding: 8px 16px;
        transition: all 0.2s ease;
    }

    .apc-filters .btn-outline-secondary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .apc-filters .btn-outline-secondary:focus {
        box-shadow: 0 0 0 2px rgba(45, 90, 45, 0.25);
    }

    /* Smooth collapse animation */
    #filtrosCollapse {
        transition: all 0.3s ease;
    }

    #filtrosCollapse.collapsing {
        opacity: 0.5;
    }

    #filtrosCollapse.collapse.show {
        opacity: 1;
    }

    #filtrosCollapse.collapse:not(.show) {
        opacity: 0;
    }

    /* Compact layout responsive design */
    @media (max-width: 768px) {
        .vista-desktop .card-body>div:first-child>div:last-child {
            flex-direction: column;
            align-items: stretch !important;
            gap: 12px !important;
        }

        .vista-desktop .search-container {
            min-width: 100% !important;
        }

        .vista-desktop .filter-group {
            width: 100%;
        }
    }

    /* Compact layout hover effects */
    .vista-desktop .search-container input:focus {
        outline: none;
        border-color: #2d5a2d;
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .vista-desktop .search-container input:hover {
        border-color: #2d5a2d;
    }

    .vista-desktop .filter-group select:focus {
        outline: none;
        border-color: #2d5a2d;
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .vista-desktop .filter-group select:hover {
        border-color: #2d5a2d;
    }

    .vista-desktop .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .vista-desktop .refresh-btn:active {
        transform: translateY(0);
    }
</style>

{% include 'workflow/partials/drawer.html' %}

<!-- JavaScript functions for drawer functionality -->
<script>
    // Define functions immediately to ensure they're available
    (function () {
        // Search functionality variables
        let searchTimeout;
        let currentSearchType = '';

        // Ensure drawer functions are available globally
        window.openSolicitudDrawerWithContext = function (pipelineId = null) {
            console.log('🔧 openSolicitudDrawerWithContext called with pipelineId:', pipelineId);

            // Check if drawer exists
            const drawer = document.getElementById('solicitudDrawer');
            if (!drawer) {
                console.error('❌ Drawer element not found!');
                alert('Error: Drawer not found. Please refresh the page.');
                return;
            }

            // Open drawer
            drawer.classList.add('active');
            document.body.style.overflow = 'hidden';

            // If pipelineId is provided, lock the pipeline selection
            if (pipelineId) {
                console.log('🔒 Locking pipeline:', pipelineId);
                lockPipeline(pipelineId);
            }

            console.log('✅ Drawer opened successfully');
        };

        // Also define the base openSolicitudDrawer function
        window.openSolicitudDrawer = function (pipelineId = null) {
            console.log('🔧 openSolicitudDrawer called with pipelineId:', pipelineId);

            const drawer = document.getElementById('solicitudDrawer');
            if (!drawer) {
                console.error('❌ Drawer element not found!');
                return;
            }

            drawer.classList.add('active');
            document.body.style.overflow = 'hidden';

            if (pipelineId) {
                lockPipeline(pipelineId);
            }
        };

        window.lockPipeline = function (pipelineId) {
            console.log('🔒 lockPipeline called with:', pipelineId);

            const pipelineSelect = document.getElementById('pipelineSelect');
            const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');
            const pipelineLockedName = document.getElementById('pipelineLockedName');

            if (!pipelineSelect || !pipelineLockedInfo || !pipelineLockedName) {
                console.error('❌ Pipeline elements not found!');
                return;
            }

            // Set and disable the select
            pipelineSelect.value = pipelineId;
            pipelineSelect.disabled = true;
            pipelineSelect.style.display = 'none';

            console.log('🔒 Pipeline select value set to:', pipelineSelect.value);
            console.log('🔒 Pipeline select disabled:', pipelineSelect.disabled);
            console.log('🔒 Pipeline select display:', pipelineSelect.style.display);

            // Show locked info
            const selectedOption = pipelineSelect.options[pipelineSelect.selectedIndex];
            if (selectedOption) {
                pipelineLockedName.textContent = selectedOption.text;
                pipelineLockedInfo.style.display = 'block';

                console.log('🔒 Pipeline locked info displayed:', pipelineLockedInfo.style.display);
                console.log('🔒 Pipeline locked name:', pipelineLockedName.textContent);

                // Load form data for the locked pipeline
                loadFormularioData(pipelineId);
            }

            console.log('✅ Pipeline locked successfully');
        };

        window.closeSolicitudDrawer = function () {
            console.log('🔧 closeSolicitudDrawer called');

            const drawer = document.getElementById('solicitudDrawer');
            if (drawer) {
                drawer.classList.remove('active');
                document.body.style.overflow = '';
                resetForm();
                console.log('✅ Drawer closed successfully');
            }
        };

        window.resetForm = function () {
            console.log('🔧 resetForm called');

            const form = document.getElementById('solicitudForm');
            if (form) {
                form.reset();
            }

            // Reset hidden inputs
            const cotizacionId = document.getElementById('cotizacionId');
            const clienteId = document.getElementById('clienteId');
            if (cotizacionId) cotizacionId.value = '';
            if (clienteId) clienteId.value = '';

            // Reset selected displays
            const cotizacionSelected = document.getElementById('cotizacionSelected');
            const clienteSelected = document.getElementById('clienteSelected');
            const clientePlaceholder = document.getElementById('clientePlaceholder');

            if (cotizacionSelected) cotizacionSelected.style.display = 'none';
            if (clienteSelected) {
                clienteSelected.style.display = 'none';
                clienteSelected.classList.remove('auto-populated');

                // Remove auto-populated indicator
                const indicator = clienteSelected.querySelector('.auto-populated-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            if (clientePlaceholder) {
                clientePlaceholder.style.display = 'block';
            }

            // Clear search inputs
            const cotizacionSearch = document.getElementById('cotizacionSearch');
            if (cotizacionSearch) cotizacionSearch.value = '';

            // Reset campos personalizados
            const camposContainer = document.getElementById('camposContainer');
            if (camposContainer) {
                camposContainer.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                Selecciona un pipeline para ver los campos personalizados
            </div>
        `;
            }

            // Reset requisitos
            const requisitosContainer = document.getElementById('requisitosContainer');
            if (requisitosContainer) {
                requisitosContainer.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                Selecciona un pipeline para ver los requisitos
            </div>
        `;
            }

            // Reset pipeline lock
            const pipelineSelect = document.getElementById('pipelineSelect');
            const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');
            if (pipelineSelect) {
                pipelineSelect.disabled = false;
                pipelineSelect.style.display = 'block';
                console.log('🔧 Pipeline select reset - disabled:', pipelineSelect.disabled, 'display:', pipelineSelect.style.display);
            }
            if (pipelineLockedInfo) {
                pipelineLockedInfo.style.display = 'none';
                console.log('🔧 Pipeline locked info reset - display:', pipelineLockedInfo.style.display);
            }

            // Hide dynamic sections
            const motivoSection = document.getElementById('motivoConsultaSection');
            const comoSeEnteroSection = document.getElementById('comoSeEnteroSection');
            const apcMakitoSection = document.getElementById('apcMakitoSection');

            if (motivoSection) {
                motivoSection.classList.remove('show');
            }
            if (comoSeEnteroSection) {
                comoSeEnteroSection.classList.remove('show');
            }
            if (apcMakitoSection) {
                apcMakitoSection.classList.remove('show');
                // Reset APC specific fields
                const apcCheckbox = document.getElementById('descargarApcMakito');
                const apcCamposAdicionales = document.getElementById('apcCamposAdicionales');
                const apcTipoDocumento = document.getElementById('apcTipoDocumento');
                const apcNoCedula = document.getElementById('apcNoCedula');

                if (apcCheckbox) apcCheckbox.checked = false;
                if (apcCamposAdicionales) apcCamposAdicionales.style.display = 'none';
                if (apcTipoDocumento) apcTipoDocumento.value = '';
                if (apcNoCedula) apcNoCedula.value = '';
            }

            hideSearchResults();
            console.log('✅ Form reset successfully');
        };

        window.loadFormularioData = function (pipelineId) {
            console.log('🔧 loadFormularioData called with pipelineId:', pipelineId);

            fetch(`/workflow/api/formulario-datos/?pipeline_id=${pipelineId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('✅ Form data loaded:', data);
                        renderCamposPersonalizados(data.campos_personalizados);
                        renderRequisitos(data.requisitos);
                    } else {
                        console.error('❌ Error loading form data:', data.error);
                    }
                })
                .catch(error => {
                    console.error('❌ Error loading form data:', error);
                });
        };

        window.hideSearchResults = function (type) {
            if (type) {
                const results = document.getElementById(`${type}Results`);
                if (results) results.classList.remove('show');
            } else {
                const cotizacionResults = document.getElementById('cotizacionResults');
                if (cotizacionResults) cotizacionResults.classList.remove('show');
            }
        };

        // Initialize drawer functionality when page loads
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 Initializing drawer functionality...');

            // Close drawer when clicking outside
            const drawer = document.getElementById('solicitudDrawer');
            if (drawer) {
                drawer.addEventListener('click', function (e) {
                    if (e.target === this) {
                        closeSolicitudDrawer();
                    }
                });
                console.log('✅ Drawer click outside handler initialized');
            }

            // Setup search functionality if elements exist
            const cotizacionSearch = document.getElementById('cotizacionSearch');
            if (cotizacionSearch) {
                setupSearch();
                console.log('✅ Search functionality initialized');
            }

            // Setup APC Makito functionality
            setupApcMakitoToggle();
            console.log('✅ APC Makito functionality initialized');

            console.log('✅ Drawer functionality initialized successfully');
        });

        // Fallback function in case the drawer functions are not loaded
        window.openSolicitudDrawer = function (pipelineId = null) {
            console.log('🔧 openSolicitudDrawer fallback called with pipelineId:', pipelineId);
            openSolicitudDrawerWithContext(pipelineId);
        };

        // Missing functions that are referenced but not defined
        window.renderCamposPersonalizados = function (campos) {
            console.log('🔧 renderCamposPersonalizados called with:', campos);

            const container = document.getElementById('camposContainer');
            if (!container) {
                console.error('❌ camposContainer not found!');
                return;
            }

            container.innerHTML = '';

            if (!campos || campos.length === 0) {
                container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                No hay campos personalizados para este pipeline
            </div>
        `;
                return;
            }

            campos.forEach(campo => {
                const campoDiv = document.createElement('div');
                campoDiv.className = 'campo-dinamico';

                let inputHtml = '';
                const required = campo.requerido ? 'required' : '';
                const requiredStar = campo.requerido ? '<span class="campo-required">*</span>' : '';

                switch (campo.tipo) {
                    case 'texto':
                        inputHtml = `<input type="text" class="form-control" name="campo_${campo.id}" ${required}>`;
                        break;
                    case 'numero':
                        inputHtml = `<input type="number" step="0.01" class="form-control" name="campo_${campo.id}" ${required}>`;
                        break;
                    case 'entero':
                        inputHtml = `<input type="number" class="form-control" name="campo_${campo.id}" ${required}>`;
                        break;
                    case 'fecha':
                        inputHtml = `<input type="date" class="form-control" name="campo_${campo.id}" ${required}>`;
                        break;
                    case 'booleano':
                        inputHtml = `
                    <select class="form-control" name="campo_${campo.id}" ${required}>
                        <option value="">Seleccionar...</option>
                        <option value="true">Sí</option>
                        <option value="false">No</option>
                    </select>
                `;
                        break;
                }

                campoDiv.innerHTML = `
            <label class="campo-label">
                ${campo.nombre} ${requiredStar}
            </label>
            ${inputHtml}
        `;

                container.appendChild(campoDiv);
            });

            console.log('✅ Campos personalizados rendered successfully');
        };

        window.renderRequisitos = function (requisitos) {
            console.log('🔧 renderRequisitos called with:', requisitos);

            const container = document.getElementById('requisitosContainer');
            if (!container) {
                console.error('❌ requisitosContainer not found!');
                return;
            }

            container.innerHTML = '';

            if (!requisitos || requisitos.length === 0) {
                container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                No hay requisitos para este pipeline
            </div>
        `;
                return;
            }

            requisitos.forEach(requisito => {
                const requisitoDiv = document.createElement('div');
                requisitoDiv.className = 'requisito-item';

                requisitoDiv.innerHTML = `
            <div class="requisito-header">
                <div class="requisito-info">
                    <div class="requisito-nombre">
                        ${requisito.nombre}
                        ${requisito.obligatorio ? '<span class="requisito-obligatorio">(Obligatorio)</span>' : ''}
                    </div>
                    ${requisito.descripcion ? `<div class="requisito-descripcion">${requisito.descripcion}</div>` : ''}
                </div>
            </div>
            <div class="requisito-upload">
                <label class="file-upload-label">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Subir archivo
                    <input type="file" class="file-upload-input" name="archivo_requisito_${requisito.id}" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.zip,.rar">
                </label>
                <div class="file-upload-info">
                    <small class="text-muted">Formatos permitidos: PDF, DOC, DOCX, JPG, PNG, GIF, ZIP, RAR</small>
                </div>
                <div class="file-selected" style="display: none;">
                    <i class="fas fa-file me-2"></i>
                    <span class="file-name"></span>
                    <button type="button" class="btn-remove-file" onclick="removeFile(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;

                container.appendChild(requisitoDiv);
            });

            // Setup file upload handlers after rendering
            setTimeout(() => {
                setupFileUploadHandlers();
            }, 100);

            console.log('✅ Requisitos rendered successfully');
        };

        // Setup APC Makito toggle functionality
        window.setupApcMakitoToggle = function () {
            console.log('🔧 setupApcMakitoToggle called');

            const apcCheckbox = document.getElementById('descargarApcMakito');
            const apcCamposAdicionales = document.getElementById('apcCamposAdicionales');

            if (apcCheckbox && apcCamposAdicionales) {
                apcCheckbox.addEventListener('change', function () {
                    if (this.checked) {
                        apcCamposAdicionales.style.display = 'block';
                        console.log('✅ APC campos adicionales shown');
                    } else {
                        apcCamposAdicionales.style.display = 'none';
                        // Clear the fields when hiding
                        const tipoDocumento = document.getElementById('apcTipoDocumento');
                        const noCedula = document.getElementById('apcNoCedula');
                        if (tipoDocumento) tipoDocumento.value = '';
                        if (noCedula) noCedula.value = '';
                        console.log('✅ APC campos adicionales hidden and cleared');
                    }
                });
                console.log('✅ APC checkbox event listener added');
            } else {
                console.log('⚠️ APC elements not found');
            }
        };

        window.setupSearch = function () {
            console.log('🔧 setupSearch called');

            // Cotización search
            const cotizacionSearch = document.getElementById('cotizacionSearch');
            if (cotizacionSearch) {
                cotizacionSearch.addEventListener('input', function (e) {
                    clearTimeout(searchTimeout);
                    const query = e.target.value;
                    if (query.length < 2) {
                        hideSearchResults('cotizacion');
                        return;
                    }
                    searchTimeout = setTimeout(() => {
                        searchCotizaciones(query);
                    }, 300);
                });
            }



            // Pipeline change
            const pipelineSelect = document.getElementById('pipelineSelect');
            if (pipelineSelect) {
                pipelineSelect.addEventListener('change', function (e) {
                    const pipelineId = e.target.value;
                    if (pipelineId) {
                        loadFormularioData(pipelineId);
                    } else {
                        // Reset to placeholder messages
                        const camposContainer = document.getElementById('camposContainer');
                        const requisitosContainer = document.getElementById('requisitosContainer');

                        if (camposContainer) {
                            camposContainer.innerHTML = `
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona un pipeline para ver los campos personalizados
                        </div>
                    `;
                        }

                        if (requisitosContainer) {
                            requisitosContainer.innerHTML = `
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona un pipeline para ver los requisitos
                        </div>
                    `;
                        }
                    }
                });
            }

            console.log('✅ Search functionality setup successfully');
        };

        // Search functions moved to top of IIFE
        function searchCotizaciones(query) {
            console.log('🔧 searchCotizaciones called with query:', query);

            fetch(`/workflow/api/buscar-cotizaciones-drawer/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSearchResults('cotizacion', data.cotizaciones);
                    }
                })
                .catch(error => {
                    console.error('❌ Error searching cotizaciones:', error);
                });
        }

        function showSearchResults(type, results) {
            console.log('🔧 showSearchResults called with type:', type, 'results:', results);

            const resultsContainer = document.getElementById(`${type}Results`);
            if (!resultsContainer) {
                console.error('❌ Results container not found for type:', type);
                return;
            }

            resultsContainer.innerHTML = '';

            if (!results || results.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
            } else {
                results.forEach(item => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.onclick = () => selectItem(type, item);

                    if (type === 'cotizacion') {
                        const montoFinanciado = item.montoFinanciado || item.auxMonto2 || 0;
                        const montoFormateado = typeof montoFinanciado === 'number' ? montoFinanciado.toLocaleString() : '0';
                        resultItem.innerHTML = `
                    <div class="search-result-name">${item.nombreCliente || 'Sin nombre'}</div>
                    <div class="search-result-details">
                        ${item.cedulaCliente || 'Sin cédula'} • 
                        ${item.tipoPrestamo || 'Sin tipo'} • 
                        Monto Financiado: $${montoFormateado}
                    </div>
                `;
                    } else {
                        resultItem.innerHTML = `
                    <div class="search-result-name">${item.nombreCliente || 'Sin nombre'}</div>
                    <div class="search-result-details">
                        ${item.cedulaCliente || 'Sin cédula'} • 
                        ${item.tipoPrestamo || 'Sin tipo'} • 
                        $${(item.montoPrestamo || 0).toLocaleString()}
                    </div>
                `;
                    }

                    resultsContainer.appendChild(resultItem);
                });
            }

            resultsContainer.classList.add('show');
        }

        function selectItem(type, item) {
            console.log('🔧 selectItem called with type:', type, 'item:', item);

            const idInput = document.getElementById(`${type}Id`);
            const searchInput = document.getElementById(`${type}Search`);
            const selectedContainer = document.getElementById(`${type}Selected`);

            if (idInput) idInput.value = item.id;
            if (searchInput) searchInput.value = '';

            if (selectedContainer) {
                const nameElement = selectedContainer.querySelector('.selected-name');
                const detailsElement = selectedContainer.querySelector('.selected-details');

                if (nameElement) nameElement.textContent = item.nombreCliente || 'Sin nombre';
                if (detailsElement) {
                    if (type === 'cotizacion') {
                        const montoFinanciado = item.montoFinanciado || item.auxMonto2 || 0;
                        const montoFormateado = typeof montoFinanciado === 'number' ? montoFinanciado.toLocaleString() : '0';
                        detailsElement.textContent = `${item.cedulaCliente || 'Sin cédula'} • ${item.tipoPrestamo || 'Sin tipo'} • Monto Financiado: $${montoFormateado}`;

                        // Show observaciones section and populate with observaciones from cotización
                        const observacionesSection = document.getElementById('observacionesSection');
                        const observacionesSelected = document.getElementById('observacionesSelected');
                        const observacionesPlaceholder = document.getElementById('observacionesPlaceholder');
                        const observacionesText = document.querySelector('.observaciones-text');

                        if (observacionesSection && observacionesSelected && observacionesPlaceholder && observacionesText) {
                            observacionesSection.style.display = 'block';

                            const observaciones = item.observaciones || '';

                            if (observaciones.trim()) {
                                observacionesText.textContent = observaciones;
                                observacionesSelected.style.display = 'block';
                                observacionesPlaceholder.style.display = 'none';
                            } else {
                                observacionesSelected.style.display = 'none';
                                observacionesPlaceholder.style.display = 'block';
                            }
                        }

                        // Show motivo de consulta section and populate with observaciones
                        const motivoSection = document.getElementById('motivoConsultaSection');
                        const motivoTextarea = document.getElementById('motivoConsulta');

                        if (motivoSection && motivoTextarea) {
                            motivoSection.classList.add('show');

                            const observaciones = item.observaciones || '';
                            motivoTextarea.value = observaciones;
                            motivoTextarea.dispatchEvent(new Event('input', { bubbles: true }));

                            if (!observaciones.trim()) {
                                setTimeout(() => {
                                    motivoTextarea.focus();
                                }, 100);
                            }
                        }

                        // Show como se entero section
                        const comoSeEnteroSection = document.getElementById('comoSeEnteroSection');
                        if (comoSeEnteroSection) {
                            comoSeEnteroSection.classList.add('show');
                        }

                        // Show APC Makito section
                        const apcMakitoSection = document.getElementById('apcMakitoSection');
                        if (apcMakitoSection) {
                            apcMakitoSection.classList.add('show');
                        }

                        // Auto-populate cliente from cotización
                        autoPopulateClienteFromCotizacion(item);
                    } else {
                        detailsElement.textContent = `${item.cedulaCliente || 'Sin cédula'} • ${item.tipoPrestamo || 'Sin tipo'} • $${(item.montoPrestamo || 0).toLocaleString()}`;
                    }
                }

                selectedContainer.style.display = 'block';
            }

            hideSearchResults(type);
        }



        // Duplicate functions removed - using the ones defined at the top of IIFE

        function autoPopulateClienteFromCotizacion(cotizacion) {
            console.log('🔧 autoPopulateClienteFromCotizacion called with:', cotizacion);

            // Clear any existing cliente first
            clearCliente();

            // Create a cliente object from cotización data
            const clienteData = {
                id: null, // We'll need to find the actual cliente ID
                nombreCliente: cotizacion.nombreCliente,
                cedulaCliente: cotizacion.cedulaCliente,
                edad: null, // Not available in cotización data
                sexo: null  // Not available in cotización data
            };

            // Search for the actual cliente by cédula
            if (clienteData.cedulaCliente) {
                fetch(`/workflow/api/buscar-clientes-drawer/?q=${encodeURIComponent(clienteData.cedulaCliente)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.clientes.length > 0) {
                            // Use the first matching cliente
                            const cliente = data.clientes[0];
                            console.log('🔧 Found matching cliente:', cliente);
                            selectClienteAutomatically(cliente);
                        } else {
                            // If no cliente found, create a virtual cliente object
                            console.log('🔧 No matching cliente found, using cotización data');
                            selectClienteAutomatically(clienteData);
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error searching for cliente:', error);
                        // Fallback to using cotización data
                        selectClienteAutomatically(clienteData);
                    });
            } else {
                // No cédula available, use cotización data directly
                selectClienteAutomatically(clienteData);
            }
        }

        function selectClienteAutomatically(cliente) {
            console.log('🔧 selectClienteAutomatically called with:', cliente);

            const clienteIdInput = document.getElementById('clienteId');
            const clienteSelectedContainer = document.getElementById('clienteSelected');
            const clientePlaceholder = document.getElementById('clientePlaceholder');

            if (clienteIdInput) clienteIdInput.value = cliente.id || '';

            if (clienteSelectedContainer && clientePlaceholder) {
                const nameElement = clienteSelectedContainer.querySelector('.selected-name');
                const detailsElement = clienteSelectedContainer.querySelector('.selected-details');

                if (nameElement) nameElement.textContent = cliente.nombreCliente || 'Sin nombre';
                if (detailsElement) {
                    if (cliente.id) {
                        // Real cliente with full data
                        detailsElement.textContent = `${cliente.cedulaCliente || 'Sin cédula'} • ${cliente.edad || 'Sin edad'} años`;
                    } else {
                        // Virtual cliente from cotización data
                        detailsElement.textContent = `${cliente.cedulaCliente || 'Sin cédula'} • (Datos de cotización)`;
                    }
                }

                // Add auto-populated indicator
                clienteSelectedContainer.classList.add('auto-populated');
                clienteSelectedContainer.style.display = 'block';
                clientePlaceholder.style.display = 'none';

                // Add a small indicator text
                const indicator = document.createElement('small');
                indicator.className = 'auto-populated-indicator';
                indicator.innerHTML = '<i class="fas fa-magic me-1"></i>Auto-completado desde cotización';

                // Remove any existing indicator
                const existingIndicator = clienteSelectedContainer.querySelector('.auto-populated-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }

                clienteSelectedContainer.appendChild(indicator);
            }
        }

        function setupFileUploadHandlers() {
            console.log('🔧 setupFileUploadHandlers called');

            document.querySelectorAll('.file-upload-input').forEach(input => {
                input.addEventListener('change', function () {
                    const file = this.files[0];
                    const requisitoItem = this.closest('.requisito-item');
                    const fileSelected = requisitoItem.querySelector('.file-selected');
                    const fileName = fileSelected.querySelector('.file-name');
                    const uploadLabel = requisitoItem.querySelector('.file-upload-label');

                    if (file) {
                        fileName.textContent = file.name;
                        fileSelected.style.display = 'flex';
                        uploadLabel.style.display = 'none';
                    }
                });
            });
        }

        function removeFile(button) {
            console.log('🔧 removeFile called');

            const requisitoItem = button.closest('.requisito-item');
            const fileSelected = requisitoItem.querySelector('.file-selected');
            const uploadLabel = requisitoItem.querySelector('.file-upload-label');
            const fileInput = requisitoItem.querySelector('.file-upload-input');

            fileInput.value = '';
            fileSelected.style.display = 'none';
            uploadLabel.style.display = 'inline-block';
        }

        // Additional functions that might be missing
        window.submitSolicitud = function () {
            console.log('🔧 submitSolicitud called');

            const form = document.getElementById('solicitudForm');
            const formData = new FormData(form);

            // Validar pipeline - check both form data and locked pipeline
            const pipelineFromForm = formData.get('pipeline');
            const pipelineSelect = document.getElementById('pipelineSelect');
            const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');

            let pipelineId = pipelineFromForm;

            // If pipeline is locked (hidden), get the value from the select element
            if (!pipelineId && pipelineLockedInfo && pipelineLockedInfo.style.display !== 'none') {
                pipelineId = pipelineSelect ? pipelineSelect.value : null;
                console.log('🔧 Pipeline is locked, using value from select:', pipelineId);
            }

            if (!pipelineId) {
                alert('Por favor selecciona un pipeline');
                return;
            }

            // Validar como se enteró (required field)
            const comoSeEntero = formData.get('como_se_entero');
            if (!comoSeEntero) {
                alert('Por favor selecciona cómo se enteró de nuestros servicios');
                return;
            }

            // Validar campos APC si está activado
            const descargarApc = formData.get('descargar_apc_makito');
            if (descargarApc) {
                const apcTipoDocumento = formData.get('apc_tipo_documento');
                const apcNoCedula = formData.get('apc_no_cedula');

                if (!apcTipoDocumento) {
                    alert('Por favor selecciona el tipo de documento para APC');
                    return;
                }

                if (!apcNoCedula || apcNoCedula.trim() === '') {
                    alert('Por favor ingresa el número de documento para APC');
                    return;
                }
            }

            // If pipeline was locked, add it to form data
            if (!pipelineFromForm && pipelineId) {
                formData.set('pipeline', pipelineId);
                console.log('🔧 Added locked pipeline to form data:', pipelineId);
            }

            // Debug: Log all form data
            console.log('🔧 Form data contents:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }

            // Validar archivos obligatorios si corresponde
            const requiredFiles = document.querySelectorAll('.requisito-item .file-upload-input[required]');
            let hasRequiredFiles = true;

            for (let input of requiredFiles) {
                if (!input.files || input.files.length === 0) {
                    hasRequiredFiles = false;
                    break;
                }
            }

            if (!hasRequiredFiles) {
                alert('Por favor sube todos los archivos obligatorios');
                return;
            }

            // Show loading state
            const submitBtn = document.querySelector('.drawer-footer .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner"></span> Creando...';
            submitBtn.disabled = true;

            fetch('/workflow/nueva-solicitud/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeSolicitudDrawer();
                        // Mostrar mensaje de éxito
                        showSuccessMessage(data.message);
                        // Recargar la página para mostrar la nueva solicitud
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al crear la solicitud');
                })
                .finally(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        };

        window.showSuccessMessage = function (message) {
            console.log('🔧 showSuccessMessage called with:', message);

            // Create a simple toast notification
            const toast = document.createElement('div');
            toast.className = 'toast-notification success';
            toast.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
    `;

            document.body.appendChild(toast);

            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        };

        window.clearCotizacion = function () {
            console.log('🔧 clearCotizacion called');
            document.getElementById('cotizacionId').value = '';
            document.getElementById('cotizacionSelected').style.display = 'none';

            // Also clear cliente when cotización is cleared
            console.log('🔧 Also clearing cliente due to cotización clear');
            clearCliente();
        };

        window.clearCliente = function () {
            console.log('🔧 clearCliente called');
            document.getElementById('clienteId').value = '';
            const clienteSelected = document.getElementById('clienteSelected');
            const clientePlaceholder = document.getElementById('clientePlaceholder');

            if (clienteSelected) {
                clienteSelected.style.display = 'none';
                clienteSelected.classList.remove('auto-populated');

                // Remove auto-populated indicator
                const indicator = clienteSelected.querySelector('.auto-populated-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            if (clientePlaceholder) {
                clientePlaceholder.style.display = 'block';
            }
        };

        // Función para cerrar el modal de requisitos
        // Función unificada para cerrar el modal de requisitos
        window.cerrarModalRequisitos = function () {
            console.log('🚪 Cerrando modal de requisitos');

            const modal = bootstrap.Modal.getInstance(document.getElementById('modalRequisitosFaltantes'));
            if (modal) {
                modal.hide();
            } else {
                // Si no hay instancia, intentar crear una nueva y ocultarla
                const modalElement = document.getElementById('modalRequisitosFaltantes');
                if (modalElement) {
                    const newModal = new bootstrap.Modal(modalElement);
                    newModal.hide();
                }
            }

            // Resetear estado después de cerrar
            setTimeout(() => {
                window.resetearEstadoModal();
            }, 300);
        }

        // Función unificada para mostrar modal de requisitos faltantes (funciona para tabla y kanban)
        window.mostrarModalRequisitosFaltantes = function (solicitudId, nuevaEtapaId, nombreEtapa, callbackExito, callbackCancelacion) {
            console.log('🔍 Mostrando modal de requisitos faltantes');
            console.log('📋 Parámetros recibidos:', { solicitudId, nuevaEtapaId, nombreEtapa, callbackExito: typeof callbackExito, callbackCancelacion: typeof callbackCancelacion });

            // Validar parámetros con early return
            if (!solicitudId || !nuevaEtapaId || !nombreEtapa) {
                console.error('❌ Parámetros inválidos:', { solicitudId, nuevaEtapaId, nombreEtapa });
                const errorMessage = 'Error: Parámetros inválidos para mostrar modal de requisitos';

                if (typeof showToast !== 'undefined') {
                    showToast(errorMessage, 'error', 6000);
                } else {
                    alert(errorMessage);
                }
                return;
            }

            // Set current solicitud ID for file uploads
            window.currentSolicitudId = solicitudId;
            console.log('🔧 currentSolicitudId establecido:', window.currentSolicitudId);

            // Resetear estado del modal
            window.resetearEstadoModal();

            // Mostrar loading en el modal
            const listaContainer = document.getElementById('listaRequisitosFaltantes');
            const loadingElement = document.getElementById('loadingRequisitos');

            if (listaContainer) listaContainer.innerHTML = '';
            if (loadingElement) loadingElement.style.display = 'block';

            // Actualizar título del modal
            const etapaDestinoElement = document.getElementById('etapaDestinoNombre');
            if (etapaDestinoElement) {
                etapaDestinoElement.textContent = nombreEtapa;
            }

            // Cargar requisitos faltantes
            fetch(`/workflow/api/solicitudes/${solicitudId}/requisitos-faltantes-detallado/?nueva_etapa_id=${nuevaEtapaId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('📋 Requisitos faltantes recibidos:', data);

                    // Ocultar loading
                    if (loadingElement) loadingElement.style.display = 'none';

                    if (data.success) {
                        // Llenar la lista de requisitos faltantes
                        window.llenarListaRequisitosFaltantes(data.requisitos, data.total_requisitos, data.requisitos_completos);

                        // Configurar event listeners del modal
                        window.configurarEventListenersModal(solicitudId, nuevaEtapaId, callbackExito, callbackCancelacion);

                        // Mostrar modal
                        const modal = new bootstrap.Modal(document.getElementById('modalRequisitosFaltantes'));
                        modal.show();
                    } else {
                        console.error('❌ Error al cargar requisitos faltantes:', data.error);
                        if (typeof showToast !== 'undefined') {
                            showToast('Error al cargar requisitos faltantes: ' + data.error, 'error', 6000);
                        } else {
                            alert('Error al cargar requisitos faltantes: ' + data.error);
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ Error en petición de requisitos faltantes:', error);
                    // Ocultar loading
                    if (loadingElement) loadingElement.style.display = 'none';

                    if (typeof showToast !== 'undefined') {
                        showToast('Error al cargar requisitos faltantes', 'error', 6000);
                    } else {
                        alert('Error al cargar requisitos faltantes');
                    }
                });
        }

        // Función unificada para llenar la lista de requisitos en el modal
        window.llenarListaRequisitosFaltantes = function (requisitos, totalRequisitos, requisitosCompletos) {
            const listaContainer = document.getElementById('listaRequisitosFaltantes');
            const btnValidar = document.getElementById('btnValidarYContinuar');

            if (!listaContainer) {
                console.error('❌ No se encontró el contenedor de requisitos');
                return;
            }

            if (!btnValidar) {
                console.error('❌ No se encontró el botón de validar');
                return;
            }

            // Store the data globally for use by verification function
            window.currentRequisitosData = {
                requisitos: requisitos,
                total_requisitos: totalRequisitos,
                requisitos_completos: requisitosCompletos
            };

            // Limpiar contenedor
            listaContainer.innerHTML = '';

            // Si todos los requisitos están completos, mostrar mensaje de éxito
            if (requisitosCompletos === totalRequisitos) {
                btnValidar.innerHTML = `<i class="fas fa-check me-2"></i>Todos los Requisitos Completos - Continuar`;
                btnValidar.className = 'btn btn-success';
                btnValidar.disabled = false;
                listaContainer.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Todos los requisitos están completos</div>';
                return;
            }

            // Validar que requisitos sea un array
            if (!Array.isArray(requisitos)) {
                console.error('❌ requisitos no es un array:', requisitos);
                listaContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error al cargar requisitos</div>';
                btnValidar.disabled = true;
                return;
            }

            // Actualizar el botón con el conteo correcto
            btnValidar.innerHTML = `<i class="fas fa-check me-2"></i>Validar y Continuar (${requisitosCompletos}/${totalRequisitos})`;
            if (requisitosCompletos === totalRequisitos) {
                btnValidar.className = 'btn btn-success';
                btnValidar.disabled = false;
            } else {
                btnValidar.className = 'btn btn-primary';
                btnValidar.disabled = true;
            }

            if (requisitos.length === 0) {
                listaContainer.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Todos los requisitos están completos</div>';
                return;
            }

            requisitos.forEach(requisito => {
                const isCompleto = requisito.esta_cumplido;
                const tituloClass = isCompleto ? 'text-success' : 'text-danger';
                const tituloIcon = isCompleto ? 'fa-check-circle' : 'fa-exclamation-triangle';
                const badgeClass = isCompleto ? 'bg-success' : 'bg-danger';
                const badgeText = isCompleto ? 'Completo' : 'Faltante';
                const cardClass = isCompleto ? 'border-success' : 'border-danger';

                const requisitoHtml = `
            <div class="card mb-3 requisito-card ${cardClass}" data-requisito-id="${requisito.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="card-title ${tituloClass} mb-1">
                                <i class="fas ${tituloIcon} me-2"></i>
                                ${requisito.nombre}
                            </h6>
                            ${requisito.descripcion ? `<p class="text-muted small mb-2">${requisito.descripcion}</p>` : ''}
                            ${requisito.mensaje_personalizado ? `<p class="text-info small mb-2"><i class="fas fa-info-circle me-1"></i>${requisito.mensaje_personalizado}</p>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>
                    </div>
                    
                    ${requisito.archivo_actual ? `
                        <div class="alert alert-success mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-file-check me-2 mt-1 text-success"></i>
                                <div class="flex-grow-1">
                                    <strong>Archivo subido:</strong> 
                                    <a href="${requisito.archivo_actual.url}" target="_blank" class="text-decoration-none">
                                        ${requisito.archivo_actual.nombre}
                                    </a>
                                    ${!isCompleto ? `
                                        <div class="mt-2 d-flex gap-2">
                                            <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="mostrarUploadParaReemplazo(${requisito.id})" aria-label="Reemplazar archivo">
                                                <i class="fas fa-upload me-1"></i>Reemplazar archivo
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" style="display:none;" id="cancelar-upload-btn-${requisito.id}" onclick="cancelarUploadParaReemplazo(${requisito.id})" aria-label="Cancelar reemplazo">
                                                <i class="fas fa-times me-1"></i>Cancelar
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${!isCompleto ? `
                        <div class="upload-section" style="${requisito.archivo_actual ? 'display: none;' : ''}" id="upload-section-${requisito.id}">
                            <div class="mb-3">
                                <label class="form-label">
                                    ${requisito.archivo_actual ? 'Reemplazar archivo' : 'Subir archivo'} 
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="file" class="form-control requisito-file-input" 
                                       data-requisito-id="${requisito.id}" 
                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif"
                                       aria-label="${requisito.archivo_actual ? 'Reemplazar archivo' : 'Subir archivo'}">
                                <small class="text-muted">El archivo se subirá automáticamente cuando hagas clic en 'Validar y Continuar'</small>
                            </div>
                        </div>
                    ` : `
                        <div class="alert alert-light border-success">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span class="text-success fw-semibold">Requisito completado</span>
                            </div>
                        </div>
                    `}
                </div>
            </div>
        `;

                listaContainer.insertAdjacentHTML('beforeend', requisitoHtml);
            });

            // Configurar event listeners para los inputs de archivo
            window.configurarEventListenersArchivos();

            // Verificar estado inicial de requisitos
            window.verificarTodosRequisitosCompletos();
        }

        // Función para mostrar upload para reemplazar archivo
        window.mostrarUploadParaReemplazo = function (requisitoId) {
            const uploadSection = document.getElementById(`upload-section-${requisitoId}`);
            const cancelarBtn = document.getElementById(`cancelar-upload-btn-${requisitoId}`);
            if (uploadSection) {
                uploadSection.style.display = 'block';
                if (cancelarBtn) cancelarBtn.style.display = 'inline-block';
                // Scroll to the upload section
                uploadSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Función para cancelar upload para reemplazo
        window.cancelarUploadParaReemplazo = function (requisitoId) {
            const uploadSection = document.getElementById(`upload-section-${requisitoId}`);
            const cancelarBtn = document.getElementById(`cancelar-upload-btn-${requisitoId}`);
            if (uploadSection) uploadSection.style.display = 'none';
            if (cancelarBtn) cancelarBtn.style.display = 'none';
        }

        // Función para configurar event listeners de archivos
        window.configurarEventListenersArchivos = function () {
            // Los archivos se subirán automáticamente cuando se haga clic en "Validar y Continuar"
            console.log('Event listeners de archivos configurados - los archivos se subirán con "Validar y Continuar"');

            // Actualizar estado del botón cuando se selecciona un archivo
            document.querySelectorAll('.requisito-file-input').forEach(input => {
                input.addEventListener('change', function () {
                    // Verificar estado de requisitos después de seleccionar archivo
                    setTimeout(() => {
                        window.verificarTodosRequisitosCompletos();
                    }, 100);
                });
            });
        }

        /*
         * SISTEMA UNIFICADO DE REQUISITOS FALTANTES
         * =========================================
         * 
         * Este sistema maneja la validación y carga de requisitos faltantes para transiciones
         * de etapa tanto en vista de tabla como en vista Kanban.
         * 
         * FUNCIONES PRINCIPALES:
         * - mostrarModalRequisitosFaltantes: Función principal que muestra el modal
         * - llenarListaRequisitosFaltantes: Llena la lista de requisitos en el modal
         * - configurarEventListenersModal: Configura los eventos del modal
         * - verificarTodosRequisitosCompletos: Verifica si todos los requisitos están completos
         * - subirArchivosSecuencialmente: Sube archivos uno por uno con progreso
         * - resetearEstadoModal: Resetea el estado del modal
         * - cerrarModalRequisitos: Cierra el modal de forma segura
         * - ejecutarCambioEtapa: Función unificada para cambiar etapa
         * - verificarFuncionesRequisitos: Verifica que todas las funciones estén disponibles
         * 
         * FLUJO DE TRABAJO:
         * 1. Usuario intenta cambiar etapa (tabla o kanban)
         * 2. Se verifica si hay requisitos faltantes
         * 3. Si los hay, se muestra el modal con la lista
         * 4. Usuario sube archivos o confirma requisitos existentes
         * 5. Se validan todos los requisitos
         * 6. Se ejecuta la transición de etapa
         * 7. Se actualiza la UI según la vista (tabla o kanban)
         */

        // Función para resetear el estado del modal
        window.resetearEstadoModal = function () {
            console.log('🔄 Reseteando estado del modal');

            // Resetear botón de validar
            const btnValidar = document.getElementById('btnValidarYContinuar');
            if (btnValidar) {
                btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Validar y Continuar';
                btnValidar.className = 'btn btn-primary';
                btnValidar.disabled = true;
            }

            // Limpiar contenedor de requisitos
            const listaContainer = document.getElementById('listaRequisitosFaltantes');
            if (listaContainer) {
                listaContainer.innerHTML = '';
            }

            // Ocultar loading
            const loadingElement = document.getElementById('loadingRequisitos');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

            // Limpiar variables globales
            window.currentSolicitudId = null;
            window.currentNuevaEtapaId = null;
        }

        // Función unificada para subir archivos secuencialmente
        window.subirArchivosSecuencialmente = function (archivos, index, callback) {
            // Early return if all files processed
            if (index >= archivos.length) {
                console.log('✅ Todos los archivos procesados');
                if (typeof callback === 'function') {
                    callback(true); // Pass success flag
                }
                return;
            }

            // Update progress in loading overlay (removed to fix recursion error)
            console.log(`📤 Procesando archivo ${index + 1} de ${archivos.length}`);


            const archivo = archivos[index];

            // Validate required data
            if (!archivo.requisitoId || !archivo.file) {
                console.error('❌ Datos de archivo inválidos:', archivo);
                // Continue with next file
                window.subirArchivosSecuencialmente(archivos, index + 1, callback);
                return;
            }

            const formData = new FormData();
            formData.append('requisito_id', archivo.requisitoId);
            formData.append('archivo', archivo.file);

            const solicitudId = window.currentSolicitudId;

            if (!solicitudId) {
                console.error('❌ No se encontró solicitudId para subir archivo');
                // Continue with next file
                window.subirArchivosSecuencialmente(archivos, index + 1, callback);
                return;
            }

            console.log(`📤 Subiendo archivo ${index + 1}/${archivos.length} para requisito ${archivo.requisitoId}`);

            const handleUploadError = (error, isNetworkError = false) => {
                console.error(`❌ Error al subir archivo para requisito ${archivo.requisitoId}:`, error);

                const mensaje = isNetworkError
                    ? `Error de conexión al subir archivo: ${error}`
                    : `Error al subir archivo: ${error}`;

                if (typeof showToast !== 'undefined') {
                    showToast(mensaje, 'error', 5000);
                }

                // Continue with next file even on error
                window.subirArchivosSecuencialmente(archivos, index + 1, callback);
            };

            fetch(`/workflow/api/solicitudes/${solicitudId}/subir-requisito-modal/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log(`✅ Archivo subido exitosamente para requisito ${archivo.requisitoId}`);

                        // Update UI for this requirement
                        const requisitoCard = document.querySelector(`.requisito-card[data-requisito-id="${archivo.requisitoId}"]`);
                        if (requisitoCard) {
                            const uploadSection = requisitoCard.querySelector('.upload-section');
                            const successSection = requisitoCard.querySelector('.success-section');

                            if (uploadSection) uploadSection.style.display = 'none';
                            if (successSection) successSection.style.display = 'block';

                            // Update badge with proper classes
                            const badge = requisitoCard.querySelector('.badge');
                            if (badge) {
                                badge.className = 'badge bg-success';
                                badge.textContent = 'Completo';
                            }
                        }

                        // Continue with next file
                        window.subirArchivosSecuencialmente(archivos, index + 1, callback);
                    } else {
                        // Handle server-side error
                        handleUploadError(data.error || 'Error desconocido del servidor');
                    }
                })
                .catch(error => {
                    // Handle network or parsing errors
                    handleUploadError(error.message, true);
                });
        };

        // Función para subir requisito desde el modal (mantenida para compatibilidad)
        window.subirRequisitoModal = function (requisitoId) {
            const fileInput = document.querySelector(`.requisito-file-input[data-requisito-id="${requisitoId}"]`);
            const btnSubir = document.querySelector(`.btn-subir-requisito[data-requisito-id="${requisitoId}"]`);
            const requisitoCard = document.querySelector(`.requisito-card[data-requisito-id="${requisitoId}"]`);

            if (!fileInput.files.length) {
                alert('Por favor selecciona un archivo');
                return;
            }

            const formData = new FormData();
            formData.append('requisito_id', requisitoId);
            formData.append('archivo', fileInput.files[0]);

            // Mostrar estado de carga
            const originalText = btnSubir.innerHTML;
            btnSubir.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Subiendo...';
            btnSubir.disabled = true;

            // Obtener solicitud ID del modal (se puede pasar como parámetro global)
            const solicitudId = window.currentSolicitudId;

            fetch(`/workflow/api/solicitudes/${solicitudId}/subir-requisito-modal/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Ocultar sección de upload y mostrar éxito
                        const uploadSection = requisitoCard.querySelector('.upload-section');
                        const successSection = requisitoCard.querySelector('.success-section');

                        uploadSection.style.display = 'none';
                        successSection.style.display = 'block';

                        // Actualizar badge
                        const badge = requisitoCard.querySelector('.badge');
                        badge.className = 'badge bg-success';
                        badge.textContent = 'Completo';

                        // Mostrar mensaje de éxito
                        if (typeof showToast !== 'undefined') {
                            showToast(data.mensaje, 'success', 4000);
                        }

                        // Verificar si todos los requisitos están completos
                        window.verificarTodosRequisitosCompletos();

                    } else {
                        alert('Error al subir requisito: ' + data.error);
                        btnSubir.innerHTML = originalText;
                        btnSubir.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al subir requisito');
                    btnSubir.innerHTML = originalText;
                    btnSubir.disabled = false;
                });
        }

        // Función unificada para verificar si todos los requisitos están completos
        window.verificarTodosRequisitosCompletos = function () {
            const btnValidar = document.getElementById('btnValidarYContinuar');

            if (!btnValidar) {
                console.error('❌ No se encontró el botón de validar');
                return false;
            }

            // Use the data from the last API call instead of counting DOM elements
            const requisitosData = window.currentRequisitosData;
            if (!requisitosData) {
                console.warn('⚠️ No hay datos de requisitos disponibles');
                return false;
            }

            const totalRequisitos = requisitosData.total_requisitos;
            const requisitosCompletos = requisitosData.requisitos_completos;

            // Count files selected for incomplete requirements
            let archivosSeleccionadosParaIncompletos = 0;
            const requisitosIncompletos = requisitosData.requisitos.filter(req => !req.esta_cumplido);

            requisitosIncompletos.forEach(requisito => {
                const fileInput = document.querySelector(`.requisito-file-input[data-requisito-id="${requisito.id}"]`);
                if (fileInput && fileInput.files && fileInput.files.length > 0) {
                    // Check if file input is visible (not hidden due to completion)
                    const isVisible = fileInput.offsetParent !== null ||
                        getComputedStyle(fileInput).display !== 'none';
                    if (isVisible) {
                        archivosSeleccionadosParaIncompletos++;
                    }
                }
            });

            console.log('🔍 Verificando requisitos:', {
                totalRequisitos,
                requisitosCompletos,
                archivosSeleccionadosParaIncompletos,
                requisitosIncompletos: requisitosIncompletos.length,
                requisitosData: requisitosData
            });

            // Early return for no requirements
            if (totalRequisitos === 0) {
                btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Continuar';
                btnValidar.className = 'btn btn-success';
                btnValidar.disabled = false;
                return true;
            }

            // All requirements completed
            if (totalRequisitos === requisitosCompletos && totalRequisitos > 0) {
                btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Todos los Requisitos Completos - Continuar';
                btnValidar.className = 'btn btn-success';
                btnValidar.disabled = false;
                return true;
            }

            // Files selected for incomplete requirements
            if (archivosSeleccionadosParaIncompletos > 0) {
                btnValidar.innerHTML = `<i class="fas fa-upload me-2"></i>Validar y Continuar (${requisitosCompletos}/${totalRequisitos})`;
                btnValidar.className = 'btn btn-primary';
                btnValidar.disabled = false;
                return false; // Not all complete, but can proceed with upload
            }

            // No files selected and requirements missing
            btnValidar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Validar y Continuar (${requisitosCompletos}/${totalRequisitos})`;
            btnValidar.className = 'btn btn-warning';
            btnValidar.disabled = true;
            return false;
        };

        // Función unificada para configurar event listeners del modal
        window.configurarEventListenersModal = function (solicitudId, nuevaEtapaId, callbackExito, callbackCancelacion) {
            console.log('🔧 Configurando event listeners del modal:', { solicitudId, nuevaEtapaId });

            // Guardar para uso global
            window.currentSolicitudId = solicitudId;
            window.currentNuevaEtapaId = nuevaEtapaId;

            // Botón de validar y continuar
            const btnValidar = document.getElementById('btnValidarYContinuar');
            if (!btnValidar) {
                console.error('❌ No se encontró el botón de validar');
                return;
            }

            btnValidar.onclick = function () {
                console.log('🔄 Botón validar clickeado');

                // Early return if button is disabled
                if (btnValidar.disabled) {
                    console.log('⚠️ Botón deshabilitado, ignorando click');
                    return;
                }

                // Disable button immediately to prevent double clicks
                btnValidar.disabled = true;
                const originalHTML = btnValidar.innerHTML;

                // Get current requirements state
                const totalRequisitos = document.querySelectorAll('.requisito-card').length;
                const requisitosCompletos = document.querySelectorAll('.requisito-card .badge.bg-success').length;

                // Get files that need to be uploaded
                const requisitosConArchivos = document.querySelectorAll('.requisito-card .requisito-file-input');
                const archivosParaSubir = [];

                requisitosConArchivos.forEach(input => {
                    if (input.files && input.files.length > 0) {
                        const requisitoCard = input.closest('.requisito-card');
                        const badge = requisitoCard?.querySelector('.badge');

                        // Only upload if not already completed
                        if (badge && !badge.classList.contains('bg-success')) {
                            archivosParaSubir.push({
                                requisitoId: input.dataset.requisitoId,
                                file: input.files[0]
                            });
                        }
                    }
                });

                console.log('📁 Archivos para subir:', archivosParaSubir.length);
                console.log('🔍 Verificando requisitos:', {
                    totalRequisitos,
                    requisitosCompletos,
                    archivosSeleccionados: archivosParaSubir.length
                });

                // Function to handle success completion
                const handleSuccessCompletion = () => {
                    console.log('✅ Todos los requisitos completos, procediendo con transición');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalRequisitosFaltantes'));
                    if (modal) {
                        modal.hide();
                    }
                    if (callbackExito) {
                        callbackExito();
                    }
                };

                // Function to handle error/incomplete state
                const handleIncompleteState = (currentCompleted, currentTotal) => {
                    const pendingCount = currentTotal - currentCompleted;
                    const mensaje = `Aún faltan ${pendingCount} requisitos por completar`;

                    btnValidar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Validar y Continuar (${currentCompleted}/${currentTotal})`;
                    btnValidar.className = 'btn btn-warning';
                    btnValidar.disabled = true;

                    if (typeof showToast !== 'undefined') {
                        showToast(mensaje, 'warning', 6000);
                    } else {
                        alert(mensaje);
                    }
                };

                // If there are files to upload, handle them first
                if (archivosParaSubir.length > 0) {
                    btnValidar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Subiendo archivos...';

                    // Show loading overlay with progress (removed to fix recursion error)
                    console.log(`📤 Iniciando carga de ${archivosParaSubir.length} archivos`);


                    // Upload files sequentially with proper error handling
                    window.subirArchivosSecuencialmente(archivosParaSubir, 0, function (uploadSuccess = true) {
                        // Hide loading overlay (removed to fix recursion error)
                        console.log('📤 Finalizando carga de archivos');


                        // Verify final state after uploads
                        window.verificarTodosRequisitosCompletos();

                        const finalTotalRequisitos = document.querySelectorAll('.requisito-card').length;
                        const finalRequisitosCompletos = document.querySelectorAll('.requisito-card .badge.bg-success').length;

                        if (finalTotalRequisitos === finalRequisitosCompletos && uploadSuccess) {
                            handleSuccessCompletion();
                        } else {
                            handleIncompleteState(finalRequisitosCompletos, finalTotalRequisitos);
                        }
                    });
                } else if (totalRequisitos === requisitosCompletos) {
                    // All requirements already completed, proceed immediately
                    handleSuccessCompletion();
                } else {
                    // Requirements still missing
                    handleIncompleteState(requisitosCompletos, totalRequisitos);
                }
            };

            // Configurar evento de cierre del modal
            const modal = document.getElementById('modalRequisitosFaltantes');
            if (modal) {
                modal.addEventListener('hidden.bs.modal', function () {
                    console.log('🚪 Modal cerrado');
                    if (callbackCancelacion) {
                        callbackCancelacion();
                    }
                });
            }
        }

        // Función para verificar que todas las funciones necesarias estén disponibles
        window.verificarFuncionesRequisitos = function () {
            const funcionesNecesarias = [
                'mostrarModalRequisitosFaltantes',
                'llenarListaRequisitosFaltantes',
                'configurarEventListenersModal',
                'verificarTodosRequisitosCompletos',
                'subirArchivosSecuencialmente',
                'resetearEstadoModal',
                'cerrarModalRequisitos',
                'ejecutarCambioEtapa'
            ];

            const funcionesFaltantes = funcionesNecesarias.filter(func => typeof window[func] !== 'function');

            if (funcionesFaltantes.length > 0) {
                console.error('❌ Funciones faltantes:', funcionesFaltantes);
                return false;
            }

            console.log('✅ Todas las funciones de requisitos están disponibles');
            return true;
        }

        // Función de prueba para verificar el sistema completo
        window.probarSistemaRequisitos = function () {
            console.log('🧪 Probando sistema de requisitos faltantes...');

            // Verificar funciones
            const funcionesOk = window.verificarFuncionesRequisitos();
            if (!funcionesOk) {
                console.error('❌ Falló la verificación de funciones');
                return false;
            }

            // Verificar modal
            const modalElement = document.getElementById('modalRequisitosFaltantes');
            if (!modalElement) {
                console.error('❌ Modal no encontrado');
                return false;
            }

            // Verificar elementos del modal
            const elementosNecesarios = [
                'listaRequisitosFaltantes',
                'btnValidarYContinuar',
                'etapaDestinoNombre',
                'loadingRequisitos'
            ];

            const elementosFaltantes = elementosNecesarios.filter(id => !document.getElementById(id));
            if (elementosFaltantes.length > 0) {
                console.error('❌ Elementos del modal faltantes:', elementosFaltantes);
                return false;
            }

            console.log('✅ Sistema de requisitos funcionando correctamente');
            console.log('💡 Para probar el modal, usa: window.mostrarModalRequisitosFaltantes(solicitudId, etapaId, "Nombre Etapa", callback)');
            return true;
        }

        // Función unificada para ejecutar el cambio de etapa (funciona para tabla y kanban)
        window.ejecutarCambioEtapa = function (solicitudId, nuevaEtapaId, etapaActual, selectElement, subestadoSeleccionado = null, esKanban = false, etapaNombre = null) {
            console.log('🔄 Ejecutando cambio de etapa:', { solicitudId, nuevaEtapaId, etapaActual, subestadoSeleccionado, esKanban, etapaNombre });

            // Deshabilitar select mientras se procesa (solo para tabla)
            if (selectElement && !esKanban) {
                selectElement.disabled = true;
            }

            // Preparar datos de la petición
            const requestData = {
                etapa_id: nuevaEtapaId
            };

            // Agregar subestado si se seleccionó uno
            if (subestadoSeleccionado) {
                requestData.subestado_id = subestadoSeleccionado;
                console.log('🔍 Incluyendo subestado en la petición:', subestadoSeleccionado);
            }

            // Realizar petición AJAX
            fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Respuesta del servidor:', data);
                    if (data.success) {
                        // Actualizar data attribute (solo para tabla)
                        if (selectElement && !esKanban) {
                            selectElement.setAttribute('data-etapa-actual', nuevaEtapaId);
                        }

                        // Mostrar mensaje de éxito
                        if (typeof showToast !== 'undefined') {
                            showToast(data.mensaje || 'Etapa cambiada exitosamente', 'success', 4000);
                        } else {
                            alert(data.mensaje || 'Etapa cambiada exitosamente');
                        }

                        if (esKanban) {
                            // Para Kanban: actualizar UI dinámicamente
                            console.log('🔄 Actualizando Kanban dinámicamente...');
                            actualizarKanbanTrasMovimiento(solicitudId, nuevaEtapaId, etapaNombre);
                        } else {
                            // Para tabla: recargar página
                            setTimeout(function () {
                                location.reload();
                            }, 1000);
                        }
                    } else {
                        // Manejar errores específicos
                        if (data.tipo_error === 'transicion_invalida') {
                            if (typeof showToast !== 'undefined') {
                                showToast('Transición no válida: ' + data.mensaje, 'error', 6000);
                            } else {
                                alert('Transición no válida: ' + data.mensaje);
                            }
                        } else if (data.tipo_error === 'requisitos_faltantes') {
                            if (typeof showToast !== 'undefined') {
                                showToast('Requisitos faltantes: ' + data.mensaje, 'warning', 6000);
                            } else {
                                alert('Requisitos faltantes: ' + data.mensaje);
                            }
                        } else {
                            if (typeof showToast !== 'undefined') {
                                showToast('Error: ' + data.error, 'error', 6000);
                            } else {
                                alert('Error: ' + data.error);
                            }
                        }

                        // Revertir selección
                        if (selectElement && !esKanban) {
                            selectElement.value = etapaActual;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (typeof showToast !== 'undefined') {
                        showToast('Error al cambiar etapa', 'error', 6000);
                    } else {
                        alert('Error al cambiar etapa');
                    }

                    // Revertir selección
                    if (selectElement && !esKanban) {
                        selectElement.value = etapaActual;
                    }
                })
                .finally(() => {
                    // Habilitar select (solo para tabla)
                    if (selectElement && !esKanban) {
                        selectElement.disabled = false;
                    }
                });
        }

        // Fallback: Asegurar que el drag and drop se inicialice si no se hizo antes
        setTimeout(function () {
            const kanbanBoard = document.querySelector('.kanban-board');
            const kanbanCards = document.querySelectorAll('.kanban-card');
            if (kanbanBoard && kanbanCards.length > 0) {
                console.log('Fallback: Verificando drag and drop...');
                if (!kanbanCards[0].dataset.dragInitialized) {
                    console.log('Fallback: Inicializando drag and drop...');
                    inicializarDragAndDrop();
                    kanbanCards.forEach(function (card) {
                        card.dataset.dragInitialized = 'true';
                    });
                }
            }
        }, 1000);

    })(); // Close IIFE
</script>



{% endblock %}