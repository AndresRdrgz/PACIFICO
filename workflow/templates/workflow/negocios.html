{% extends 'workflow/base.html' %}
{% load static %}
{% load workflow_filters %}

{% block title %}Negocios - Sistema de Workflow{% endblock %}

{% block content %}
<div class="mt-0 pt-0">
        <!-- Header Estático - Sin Animaciones -->
    <div class="card mb-1" style="border: 1px solid #e0e0e0;">
        <div class="card-header" style="background: var(--verde-pacifico); padding: 12px 20px; border-radius: 0; border: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-white fw-bold">
                        <i class="fas fa-briefcase me-2"></i>
                        {% if pipeline %}{{ pipeline.nombre }}{% else %}Pipeline de Negocio{% endif %}
                    </h1>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Selector de Pipeline -->
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownPipeline" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-project-diagram me-1"></i>
                            Pipelines
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownPipeline" style="z-index: 9999;">
                            {% for p in pipelines %}
                            <li>
                                <a class="dropdown-item {% if pipeline and p.id == pipeline.id %}active{% endif %}" 
                                   href="?pipeline={{ p.id }}&view={{ request.GET.view|default:'table' }}">
                                    {{ p.nombre }}
                                </a>
                            </li>
                            {% empty %}
                            <li><span class="dropdown-item-text text-muted">No hay pipelines disponibles</span></li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <!-- Botones de cambio de vista -->
                    <div class="btn-group" role="group" aria-label="Cambiar vista">
                        <button type="button" class="btn btn-light btn-sm active" id="btnVistaTabla" onclick="cambiarVista('table')">
                            <i class="fas fa-table me-1"></i>
                            Tabla
                        </button>
                        <button type="button" class="btn btn-outline-light btn-sm" id="btnVistaKanban" onclick="cambiarVista('kanban')">
                            <i class="fas fa-columns me-1"></i>
                            Kanban
                        </button>
                    </div>
                    
                    {% if pipeline %}
                    <a href="#" class="btn btn-light btn-sm" onclick="openSolicitudDrawerWithContext({{ pipeline.id }})">
                        <i class="fas fa-plus me-1"></i>Nueva Solicitud
                    </a>
                    {% else %}
                    <a href="#" class="btn btn-light btn-sm" onclick="openSolicitudDrawerWithContext()">
                        <i class="fas fa-plus me-1"></i>Nueva Solicitud
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if pipeline %}
        <!-- KPIs Estáticos en Fila Horizontal -->
    <div class="card mb-1" id="kpis-section" style="border: 1px solid #e0e0e0;">
        <div class="card-body py-2">
            <div class="row g-2">
                <div class="col-3">
                    <div class="kpi-card-compact kpi-total">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Total</p>
                            <h4 class="kpi-number-compact">{{ page_obj.paginator.count }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-activas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Activas</p>
                            <h4 class="kpi-number-compact">{{ solicitudes|filter_activas|length }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-completadas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Completadas</p>
                            <h4 class="kpi-number-compact">{{ solicitudes|filter_completadas|length }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-vencidas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Vencidas</p>
                            <h4 class="kpi-number-compact">{{ solicitudes|filter_vencidas|length }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if pipeline %}
    {% if view_type == 'table' %}

    <!-- Leyenda SLA Compacta -->
    <small class="text-muted mb-2 d-block" style="font-size: 0.7rem;">
        <i class="fas fa-info-circle me-1"></i>Leyenda SLA:
        <i class="fas fa-circle text-success me-1 ms-2" style="font-size: 0.5rem;"></i>En tiempo
        <i class="fas fa-circle text-warning me-1 ms-2" style="font-size: 0.5rem;"></i>Por vencer
        <i class="fas fa-circle text-danger me-1 ms-2" style="font-size: 0.5rem;"></i>Vencido
    </small>

    <!-- Vista Móvil Mejorada: Solo visible en pantallas pequeñas -->
    <div class="vista-movil d-block d-sm-none">
        <!-- Barra de búsqueda móvil -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4 border">
            <div class="relative">
                <input type="text" id="busquedaMovil" 
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                       placeholder="Buscar por código, cliente o cédula...">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Tarjetas de solicitudes -->
        <div class="space-y-4" id="solicitudesMovil">
            {% for s in solicitudes_tabla %}
                <div class="solicitud-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow duration-200" 
                     data-prioridad="{{ s.prioridad|lower }}" 
                     data-estado="{{ s.sla_color }}"
                     data-asignado="{% if s.asignado_a == 'Sin asignar' %}sin_asignar{% else %}asignado{% endif %}"
                     data-search="{{ s.codigo|lower }} {{ s.cliente|lower }} {{ s.cedula|lower }}">
                    
                    <!-- Header de la tarjeta -->
                    <div class="p-4 pb-3">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <!-- Indicador de SLA -->
                                <div class="w-3 h-3 rounded-full 
                                    {% if s.sla_color == 'text-danger' %}bg-red-500
                                    {% elif s.sla_color == 'text-warning' %}bg-yellow-500
                                    {% elif s.sla_color == 'text-success' %}bg-green-500
                                    {% else %}bg-gray-400{% endif %}">
                                </div>
                                <h3 class="text-lg font-bold text-gray-900">{{ s.codigo }}</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- Badge de prioridad -->
                                {% if s.prioridad %}
                                <span class="px-2 py-1 rounded-full text-xs font-semibold
                                    {% if s.prioridad == 'Alta' %}bg-red-100 text-red-800
                                    {% elif s.prioridad == 'Media' %}bg-yellow-100 text-yellow-800
                                    {% elif s.prioridad == 'Baja' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ s.prioridad }}
                                </span>
                                {% endif %}
                                <!-- Menú de opciones -->
                                <div class="relative">
                                    <button class="p-1 rounded-full hover:bg-gray-100 transition-colors" onclick="toggleMenu(this)">
                                        <i class="fas fa-ellipsis-v text-gray-400"></i>
                                    </button>
                                    <div class="menu-dropdown absolute right-0 top-8 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10 hidden min-w-40">
                                        <a href="{% url 'workflow:detalle_solicitud_profesional' s.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            <i class="fas fa-eye mr-2"></i>Ver Detalle
                                        </a>
                                        <a href="{% url 'workflow:transicion_solicitud' s.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            <i class="fas fa-arrow-right mr-2"></i>Cambiar Etapa
                                        </a>
                                        {% if s.acciones.eliminar %}
                                        <button onclick="eliminarSolicitud({{ s.id }})" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                            <i class="fas fa-trash mr-2"></i>Eliminar
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Información principal -->
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Cliente</p>
                                <p class="text-sm font-semibold text-gray-900 truncate">{{ s.cliente_nombre }}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Monto</p>
                                <p class="text-sm font-bold text-green-600">{{ s.monto_formateado }}</p>
                            </div>
                        </div>

                        <!-- Información secundaria -->
                        <div class="space-y-2 mb-3">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Cédula:</span>
                                <span class="text-gray-900 font-medium">{{ s.cliente_cedula }}</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Producto:</span>
                                <span class="text-gray-900 font-medium truncate ml-2">{{ s.producto_descripcion }}</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Propietario:</span>
                                <span class="text-gray-900 font-medium truncate ml-2">{{ s.propietario }}</span>
                            </div>
                        </div>

                        <!-- Asignación -->
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs text-gray-500 uppercase tracking-wide font-medium">Asignado a</span>
                            {% if s.asignado_a != 'Sin asignar' %}
                                <div class="flex items-center space-x-2">
                                    <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-blue-600 text-xs"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-900 truncate">{{ s.asignado_a }}</span>
                                </div>
                            {% else %}
                                <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">
                                    <i class="fas fa-user-slash mr-1"></i>Sin asignar
                                </span>
                            {% endif %}
                        </div>

                        <!-- Etapa y Estado -->
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Etapa</p>
                                {% if s.etapa %}
                                <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                    {{ s.etapa }}
                                </span>
                                {% endif %}
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Estado</p>
                                <span class="inline-block px-2 py-1 bg-{{ s.estado_color }} text-white rounded-full text-xs font-medium">
                                    {{ s.estado_actual }}
                                </span>
                            </div>
                        </div>

                        <!-- Etiquetas -->
                        {% if s.etiquetas_oficial %}
                        <div class="mb-3">
                            <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Etiquetas</p>
                            <span class="inline-block px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                                {{ s.etiquetas_oficial }}
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Footer con SLA y fechas -->
                    <div class="px-4 py-3 bg-gray-50 border-t border-gray-100">
                        <div class="flex items-center justify-between text-xs">
                            <div class="flex items-center space-x-4">
                                <div>
                                    <span class="text-gray-500">Creado:</span>
                                    <span class="text-gray-900 font-medium">{{ s.fecha_inicio }}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">SLA:</span>
                                    <span class="font-medium {{ s.sla_color }}">{{ s.sla_restante }}</span>
                                </div>
                            </div>
                            {% for alerta in s.alertas %}
                                <i class="fas {{ alerta.icon }} text-{{ alerta.color }}" title="{{ alerta.tooltip }}"></i>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="p-4 pt-3 bg-gray-50">
                        <div class="flex space-x-2">
                            <a href="{% url 'workflow:detalle_solicitud_profesional' s.id %}" 
                               class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-eye mr-1"></i>Ver
                            </a>
                            <a href="{% url 'workflow:transicion_solicitud' s.id %}" 
                               class="flex-1 bg-gray-600 hover:bg-gray-700 text-white text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-arrow-right mr-1"></i>Etapa
                            </a>
                            {% if s.acciones.eliminar %}
                            <button onclick="eliminarSolicitud({{ s.id }})" 
                                    class="bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-inbox text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No hay solicitudes</h3>
                    <p class="text-gray-500">No se encontraron solicitudes que coincidan con los filtros aplicados.</p>
                </div>
            {% endfor %}
        </div>

        <!-- Paginación móvil -->
        {% if page_obj.has_other_pages %}
        <div class="mt-6 flex justify-center">
            <nav class="flex items-center space-x-1">
                {% if page_obj.has_previous %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {% endif %}
                
                <span class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-gray-300">
                    {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </div>

    <!-- Tabla Desktop Mejorada con DataTable -->
    <div class="vista-desktop d-none d-sm-block">
        <div class="card card-custom">
            <!-- Filtros Responsivos Mejorados -->
            <div class="card-header-custom bg-light" style="border-bottom: 1px solid #dee2e6;">
                <div class="row g-2 align-items-center">
                    <!-- Primera fila: Filtros principales -->
                    <div class="col-12 col-lg-8">
                        <div class="row g-2">
                            <div class="col-6 col-md-4 col-lg-2">
                                <select id="filtroCliente" class="form-select form-select-sm">
                                    <option value="">Todos los clientes</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-4 col-lg-2">
                                <select id="filtroProducto" class="form-select form-select-sm">
                                    <option value="">Todos los productos</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-4 col-lg-2">
                                <select id="filtroEstado" class="form-select form-select-sm">
                                    <option value="">Todos los estados</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-4 col-lg-2">
                                <select id="filtroAsignado" class="form-select form-select-sm">
                                    <option value="">Todas las asignaciones</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-4 col-lg-2">
                                <select id="filtroSLA" class="form-select form-select-sm">
                                    <option value="">Todos los SLA</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-4 col-lg-2">
                                <select id="filtroPrioridad" class="form-select form-select-sm">
                                    <option value="">Todas las prioridades</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Segunda fila: Búsqueda y controles -->
                    <div class="col-12 col-lg-4">
                        <div class="d-flex gap-2 align-items-center justify-content-lg-end">
                            <input type="text" id="busquedaGlobal" class="form-control form-control-sm flex-grow-1" 
                                   placeholder="Buscar..." 
                                   style="max-width: 200px;">
                            <button type="button" class="btn btn-sm btn-outline-success" id="exportarExcel" title="Exportar a Excel">
                                <i class="fas fa-file-excel"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" id="limpiarFiltros" title="Limpiar filtros">
                                <i class="fas fa-filter-circle-xmark"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0" style="border: none;">
                <div class="table-container" style="height: 80vh; overflow: hidden; border: none;">
                    <div class="table-responsive" style="height: 100%; border: none;">
                        <table class="table table-hover workflow-table mb-0" id="tablaSolicitudes" style="border: none;">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th class="fw-bold" style="width: 80px;">Nº</th>
                                    <th class="fw-bold" style="width: 200px;">Cliente</th>
                                    <th class="fw-bold" style="width: 150px;">Producto</th>
                                    <th class="fw-bold" style="width: 120px;">Monto</th>
                                    <th class="fw-bold" style="width: 150px;">Propietario</th>
                                    <th class="fw-bold" style="width: 200px;">Asignado a</th>
                                    <th class="fw-bold" style="width: 120px;">Etapa</th>
                                    <th class="fw-bold" style="width: 100px;">Estado</th>
                                    <th class="fw-bold" style="width: 200px;">Fecha<br>SLA</th>
                                    <th class="fw-bold" style="width: 120px;">SLA</th>
                                    <th class="fw-bold" style="width: 120px;">Etiquetas</th>
                                    <th class="fw-bold" style="width: 100px;">Prioridad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in solicitudes_tabla %}
                                <tr class="align-middle table-row-hover clickable-row {% if s.sla_color == 'text-danger' %}bg-danger bg-opacity-10{% endif %}" 
                                    data-solicitud-id="{{ s.id }}"
                                    data-cliente="{{ s.cliente_nombre|default:'Sin cliente' }}"
                                    data-producto="{{ s.producto_descripcion|default:'Sin producto' }}"
                                    data-estado="{{ s.estado_actual|default:'Sin estado' }}"
                                    data-asignado="{{ s.asignado_a|default:'Sin asignar' }}"
                                    data-sla="{% if s.sla_color == 'text-danger' %}vencido{% elif s.sla_color == 'text-warning' %}por vencer{% elif s.sla_color == 'text-success' %}en tiempo{% else %}sin sla{% endif %}"
                                    data-prioridad="{{ s.prioridad|default:'Sin prioridad' }}"
                                    onclick="handleRowClick(event, {{ s.id }})"
                                    style="cursor: pointer;">
                                    <td class="text-dark">
                                        <div class="d-flex align-items-center">
                                            <!-- Iconos de alerta -->
                                            {% for alerta in s.alertas %}
                                            <i class="fas {{ alerta.icon }} text-{{ alerta.color }} me-1" title="{{ alerta.tooltip }}" style="font-size: 0.8rem;"></i>
                                            {% endfor %}
                                            <!-- Número clickeable -->
                                            <span class="text-decoration-none fw-bold solicitud-link" 
                                                  title="Ver detalles">
                                                {{ s.codigo }}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="text-dark">
                                        <div>
                                            <div class="fw-semibold">{{ s.cliente_nombre }}</div>
                                            <small class="text-muted">{{ s.cliente_cedula }}</small>
                                        </div>
                                    </td>
                                    <td class="text-dark">{{ s.producto_descripcion }}</td>
                                    <td><span class="fw-bold text-success">{{ s.monto_formateado }}</span></td>
                                    <td class="text-dark"><i class="fas fa-user me-1 text-muted"></i> {{ s.propietario }}</td>
                                    <td style="max-width: 200px;">
                                        {% if s.asignado_a != 'Sin asignar' %}
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user me-1 text-success" style="min-width: 12px;"></i> 
                                                <span class="text-dark" style="word-wrap: break-word; line-height: 1.2;">{{ s.asignado_a }}</span>
                                            </div>
                                        {% else %}
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-slash me-1 text-muted" style="min-width: 12px;"></i> 
                                                <span class="text-muted" style="word-wrap: break-word; line-height: 1.2;">{{ s.asignado_a }}</span>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm etapa-select" 
                                                data-solicitud-id="{{ s.id }}" 
                                                data-etapa-actual="{{ s.etapa_actual.id|default:'' }}"
                                                style="min-width: 120px;">
                                            {% if not s.etapa %}
                                                <option value="" selected>Sin etapa</option>
                                            {% endif %}
                                            {% for etapa in pipeline.etapas.all %}
                                                <option value="{{ etapa.id }}" 
                                                        {% if s.etapa == etapa.nombre %}selected{% endif %}>
                                                    {{ etapa.nombre }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ s.estado_color }}">{{ s.estado_actual }}</span>
                                    </td>
                                    <td class="text-dark" style="max-width: 200px;">
                                        <div style="line-height: 1.3;">
                                            <div class="d-flex align-items-center mb-1">
                                                <small class="text-muted me-1" style="min-width: 25px;">Ini:</small> 
                                                <span style="font-size: 0.85rem;">{{ s.fecha_inicio|date:"d/m" }}</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <small class="text-muted me-1" style="min-width: 25px;">Ven:</small> 
                                                <span style="font-size: 0.85rem;">{% if s.vencimiento_sla %}{{ s.vencimiento_sla|date:"d/m" }}{% else %}N/A{% endif %}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-center">
                                            <div class="{{ s.sla_color }} fw-bold" title="Tiempo restante">
                                                {{ s.sla_restante }}
                                            </div>
                                            <small class="text-muted">
                                                {% if s.sla_color == 'text-success' %}En tiempo
                                                {% elif s.sla_color == 'text-warning' %}Por vencer
                                                {% elif s.sla_color == 'text-danger' %}Vencido
                                                {% else %}N/A{% endif %}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <select class="etiquetas-select form-control form-control-sm" 
                                                data-id="{{ s.id }}" 
                                                style="min-width: 115px; width: 115px;">
                                            <option value="">Seleccionar etiqueta</option>
                                            <option value="no_responde" {% if s.etiquetas_oficial == 'no_responde' %}selected{% endif %}>📞 No responde</option>
                                            <option value="cita_agendada" {% if s.etiquetas_oficial == 'cita_agendada' %}selected{% endif %}>🗓️ Cita agendada</option>
                                            <option value="doc_completo" {% if s.etiquetas_oficial == 'doc_completo' %}selected{% endif %}>✅ Documentos completos</option>
                                            <option value="falta_carta" {% if s.etiquetas_oficial == 'falta_carta' %}selected{% endif %}>📎 Falta carta trabajo</option>
                                            <option value="seguimiento_48h" {% if s.etiquetas_oficial == 'seguimiento_48h' %}selected{% endif %}>🔄 Seguimiento en 48h</option>
                                            <option value="whatsapp_activo" {% if s.etiquetas_oficial == 'whatsapp_activo' %}selected{% endif %}>💬 WhatsApp activo</option>
                                            <option value="cliente_indeciso" {% if s.etiquetas_oficial == 'cliente_indeciso' %}selected{% endif %}>⚠️ Cliente indeciso</option>
                                            <option value="cliente_caliente" {% if s.etiquetas_oficial == 'cliente_caliente' %}selected{% endif %}>🚀 Cliente caliente</option>
                                            <option value="esperando_confirm" {% if s.etiquetas_oficial == 'esperando_confirm' %}selected{% endif %}>🕐 Esperando confirmación</option>
                                            <option value="enviado_credito" {% if s.etiquetas_oficial == 'enviado_credito' %}selected{% endif %}>🧾 Enviado a crédito</option>
                                            <option value="en_validacion" {% if s.etiquetas_oficial == 'en_validacion' %}selected{% endif %}>🔒 En validación</option>
                                            <option value="caso_descartado" {% if s.etiquetas_oficial == 'caso_descartado' %}selected{% endif %}>❌ Caso descartado</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="prioridad-select border rounded px-2 py-1 text-xs w-full"
                                                data-id="{{ s.id }}"
                                                style="background-color:
                                                  {% if s.prioridad == 'Alta' %}#fee2e2
                                                  {% elif s.prioridad == 'Media' %}#fef9c3
                                                  {% elif s.prioridad == 'Baja' %}#dcfce7
                                                  {% else %}white{% endif %};
                                                  color:
                                                  {% if s.prioridad == 'Alta' %}#b91c1c
                                                  {% elif s.prioridad == 'Media' %}#b45309
                                                  {% elif s.prioridad == 'Baja' %}#166534
                                                  {% else %}#333{% endif %};">
                                          <option value="">-</option>
                                          {% for prioridad in prioridades_posibles %}
                                            <option value="{{ prioridad }}" {% if s.prioridad == prioridad %}selected{% endif %}>{{ prioridad }}</option>
                                          {% endfor %}
                                        </select>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="12" class="text-center py-4">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">No hay solicitudes para mostrar</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Paginación -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Paginación de solicitudes" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Anterior</a>
                        </li>
                        {% endif %}
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Siguiente</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>

    {% else %}
    <!-- Vista Kanban Mejorada -->
    
    <!-- Filtros Compactos para Kanban -->
    <div class="card card-custom mb-2">
        <div class="card-body py-2">
            <div class="row g-1 align-items-center">
                <div class="col-6 col-md-2">
                    <select id="kanbanFiltroCliente" class="form-select form-select-sm">
                        <option value="">Todos los clientes</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <select id="kanbanFiltroEstado" class="form-select form-select-sm">
                        <option value="">Todos los estados</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <select id="kanbanFiltroAsignado" class="form-select form-select-sm">
                        <option value="">Todas las asignaciones</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <select id="kanbanFiltroSLA" class="form-select form-select-sm">
                        <option value="">Todos los SLA</option>
                    </select>
                </div>
                <div class="col-12 col-md-3">
                    <input type="text" id="kanbanBusquedaGlobal" class="form-control form-control-sm" 
                           placeholder="Buscar...">
                </div>
                <div class="col-12 col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-info w-100" id="kanbanLimpiarFiltros">
                        <i class="fas fa-filter-circle-xmark"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contenedor Kanban con scroll horizontal -->
    <div class="kanban-container" style="height: calc(100vh - 280px); overflow-y: hidden; min-height: 700px;">
        <div class="kanban-board d-flex" style="overflow-x: auto; gap: 0.75rem; padding-bottom: 1rem;">
            {% for etapa in pipeline.etapas.all %}
            <div class="kanban-column" style="min-width: 320px; width: 320px; flex-shrink: 0;">
                <div class="card shadow h-100" style="border: 2px solid #e9ecef; border-radius: 12px; background: #ffffff;">
                    <!-- Header de etapa con búsqueda -->
                    <div class="card-header text-white" style="background: #28a745; border-radius: 12px 12px 0 0; border: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-bold text-white">
                                <i class="fas fa-list-ul me-2 text-white"></i>
                                {{ etapa.nombre }}
                            </h6>
                            <span class="badge bg-white text-success fw-bold" id="count-etapa-{{ etapa.id }}">
                                {{ solicitudes_por_etapa|get_item:etapa.id|length }}
                            </span>
                        </div>
                        <input type="text" class="form-control form-control-sm etapa-search" 
                               placeholder="Buscar en {{ etapa.nombre }}..." 
                               data-etapa-id="{{ etapa.id }}"
                               style="background: rgba(255,255,255,0.9); border: none;">
                    </div>
                    
                    <!-- Cuerpo de etapa con scroll -->
                    <div class="card-body p-3 kanban-column-body" 
                         style="height: calc(100vh - 380px); overflow-y: auto; background: #f8f9fa;"
                         data-etapa-id="{{ etapa.id }}">
                        
                        {% for s in solicitudes_por_etapa|get_item:etapa.id %}
                        <div class="kanban-card mb-3" 
                             draggable="true" 
                             data-solicitud-id="{{ s.id }}"
                             data-etapa-id="{{ etapa.id }}"
                             data-cliente="{{ s.cliente_nombre|default:'Sin cliente' }}"
                             data-estado="{{ s.estado_actual|default:'Sin estado' }}"
                             data-asignado="{{ s.asignado_a|default:'Sin asignar' }}"
                             data-sla="{% if s.sla_color == 'text-danger' %}vencido{% elif s.sla_color == 'text-warning' %}por vencer{% elif s.sla_color == 'text-success' %}en tiempo{% else %}sin sla{% endif %}"
                             data-search="{{ s.codigo|lower }} {{ s.cliente_nombre|lower }}"
                             data-codigo="{{ s.codigo }}"
                             data-monto="{{ s.monto_formateado }}"
                             data-fecha-inicio="{{ s.fecha_inicio_str|default:s.fecha_inicio }}"
                             data-sla-texto="{{ s.sla_restante }}"
                             style="cursor: grab;">
                             
                            <div class="card shadow-sm border-0" 
                                 style="border-left: 4px solid {% if s.sla_color == 'text-danger' %}#dc3545{% elif s.sla_color == 'text-warning' %}#ffc107{% elif s.sla_color == 'text-success' %}#198754{% else %}#6c757d{% endif %} !important; 
                                        height: 110px; 
                                        border-radius: 6px;
                                        transition: all 0.3s ease;
                                        background: white;
                                        cursor: pointer;"
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.15)'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'"
                                 onclick="mostrarModalSolicitud({{ s.id }})">
                                <div class="card-body p-2" style="height: 100%;">
                                    <!-- Header compacto -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0" style="font-size: 0.9rem;">
                                            <span class="text-decoration-none fw-bold text-primary solicitud-link-kanban" 
                                               title="Ver detalles">
                                                {{ s.codigo }}
                                            </span>
                                        </h6>
                                        
                                        <!-- Botón de cambio de etapa eliminado por solicitud del usuario -->
                                    </div>
                                    
                                    <!-- Contenido en 2 columnas -->
                                    <div class="row g-1" style="height: calc(100% - 35px);">
                                        <!-- Columna izquierda -->
                                        <div class="col-7">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-user text-muted me-1" style="font-size: 0.75rem; width: 12px;"></i>
                                                <span style="font-size: 0.75rem; color: #495057;">{{ s.cliente_nombre|truncatechars:12 }}</span>
                                            </div>
                                            
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-dollar-sign text-success me-1" style="font-size: 0.75rem; width: 12px;"></i>
                                                <span class="text-success fw-bold" style="font-size: 0.75rem;">{{ s.monto_formateado }}</span>
                                            </div>
                                            
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-check text-muted me-1" style="font-size: 0.75rem; width: 12px;"></i>
                                                <span style="font-size: 0.7rem; color: #6c757d;">
                                                    {% if s.asignado_a != 'Sin asignar' %}
                                                        {{ s.asignado_a|truncatechars:10 }}
                                                    {% else %}
                                                        <em>Sin asignar</em>
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <!-- Columna derecha -->
                                        <div class="col-5">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-clock text-muted me-1" style="font-size: 0.75rem; width: 12px;"></i>
                                                <span class="{{ s.sla_color }} fw-bold" style="font-size: 0.7rem;">{{ s.sla_restante }}</span>
                                            </div>
                                            
                                            <div class="mb-1">
                                                <span class="badge bg-{{ s.estado_color }}" style="font-size: 0.6rem; padding: 2px 5px;">{{ s.estado_actual }}</span>
                                            </div>
                                            
                                            <div class="d-flex align-items-center">
                                                {% if s.prioridad %}
                                                <span class="badge" 
                                                      style="font-size: 0.55rem; padding: 1px 4px;
                                                             background-color: {% if s.prioridad == 'Alta' %}#fee2e2{% elif s.prioridad == 'Media' %}#fef9c3{% elif s.prioridad == 'Baja' %}#dcfce7{% else %}white{% endif %};
                                                             color: {% if s.prioridad == 'Alta' %}#b91c1c{% elif s.prioridad == 'Media' %}#b45309{% elif s.prioridad == 'Baja' %}#166534{% else %}#333{% endif %};">
                                                    {{ s.prioridad }}
                                                </span>
                                                {% endif %}
                                                <small class="text-muted ms-auto" style="font-size: 0.65rem;">{{ s.fecha_inicio }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox text-muted mb-2"></i>
                            <p class="text-muted small">Sin solicitudes</p>
                        </div>
                        {% endfor %}
                        
                        <!-- Mensaje cuando no hay solicitudes -->
                        <div class="no-solicitudes text-center py-4" style="display: none;">
                            <i class="fas fa-inbox text-muted mb-2"></i>
                            <p class="text-muted small">Sin solicitudes</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Selección de Pipeline -->
    <div class="row">
        {% for pipeline in pipelines %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card card-custom h-100">
                <div class="card-header-custom">
                    <h5 class="mb-0">{{ pipeline.nombre }}</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">{{ pipeline.descripcion|default:"Sin descripción" }}</p>
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="bg-success bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-success">{{ pipeline.solicitud_set.count }}</h6>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-info bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-info">{{ pipeline.etapas.count }}</h6>
                                <small class="text-muted">Etapas</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-warning bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-warning">{{ pipeline.requisitos_pipeline.count }}</h6>
                                <small class="text-muted">Requisitos</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="?pipeline={{ pipeline.id }}&view=table" class="btn btn-pacifico">
                            <i class="fas fa-table me-2"></i>Ver en Tabla
                        </a>
                        <a href="?pipeline={{ pipeline.id }}&view=kanban" class="btn btn-outline-pacifico">
                            <i class="fas fa-columns me-2"></i>Ver en Kanban
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-project-diagram fa-4x text-muted mb-3"></i>
                <h4 class="text-muted mb-3">No hay pipelines disponibles</h4>
                <p class="text-muted mb-4">Crea un pipeline para comenzar a gestionar solicitudes.</p>
                <a href="{% url 'workflow:admin_pipelines' %}" class="btn btn-pacifico">
                    <i class="fas fa-plus me-2"></i>Crear Pipeline
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endif %}
</div>

{% include 'workflow/partials/modalSolicitud.html' %}

{% include 'workflow/partials/modalRequisitos.html' %}

<!-- Modal de Confirmación Personalizado -->
<div class="modal fade" id="modalConfirmacionEtapa" tabindex="-1" aria-labelledby="modalConfirmacionEtapaLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);">
            <!-- Header con gradiente verde -->
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; padding: 24px 32px 20px 32px; position: relative; overflow: hidden;">
                <!-- Decoración de fondo -->
                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; opacity: 0.6;"></div>
                <div style="position: absolute; top: 40px; right: 60px; width: 60px; height: 60px; background: rgba(255, 255, 255, 0.08); border-radius: 50%;"></div>
                
                <div class="w-100 text-center position-relative">
                    <h4 class="modal-title text-white fw-bold mb-1" id="modalConfirmacionEtapaLabel" style="font-size: 1.4rem; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <i class="fas fa-exchange-alt me-2" style="font-size: 1.2rem;"></i>
                        Confirmar Cambio de Etapa
                    </h4>
                    <p class="text-white-50 mb-0" style="font-size: 0.9rem; font-weight: 500;">Sistema de Workflow</p>
                </div>
            </div>
            
            <div class="modal-body" style="padding: 32px;">
                <!-- Icono central -->
                <div class="text-center mb-4">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.15)); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 24px rgba(40, 167, 69, 0.2);">
                        <i class="fas fa-arrow-right" style="font-size: 2rem; color: #28a745; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"></i>
                    </div>
                </div>
                
                <!-- Mensaje principal -->
                <div class="text-center mb-4">
                    <h5 class="fw-bold mb-3" style="color: #2d3748; font-size: 1.2rem;">¿Está seguro del cambio?</h5>
                    <p class="text-muted mb-3" style="font-size: 0.95rem;">La solicitud se moverá a la siguiente etapa:</p>
                    
                    <!-- Caja verde con nombre de etapa -->
                    <div class="bg-success bg-opacity-10 border border-success border-opacity-25 rounded-3 p-3 mb-4" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.08), rgba(32, 201, 151, 0.12)) !important;">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-flag text-success me-2" style="font-size: 1.1rem;"></i>
                            <span id="nombreEtapaDestino" class="fw-bold text-success" style="font-size: 1.1rem;">Nombre de la Etapa</span>
                        </div>
                    </div>
                </div>
                
                <!-- Información del cambio -->
                <div class="bg-light rounded-3 p-3 mb-4" style="border-left: 4px solid #28a745;">
                    <div class="d-flex align-items-start mb-2">
                        <i class="fas fa-info-circle text-primary me-2 mt-1" style="font-size: 1rem;"></i>
                        <div>
                            <h6 class="fw-bold mb-2 text-dark" style="font-size: 0.95rem;">Información del cambio:</h6>
                            <ul class="list-unstyled mb-0" style="font-size: 0.85rem; color: #6c757d; line-height: 1.6;">
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se actualizará el estado de la solicitud
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se registrará en el historial del sistema
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se notificará a los usuarios correspondientes
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 24px 32px; border: none; background: #f8f9fa;">
                <button type="button" class="btn btn-outline-secondary" id="btnCancelarModal" style="font-weight: 600; padding: 12px 24px; border-radius: 8px; border-width: 2px;">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnAceptarModal" style="font-weight: 600; padding: 12px 24px; border-radius: 8px; background: linear-gradient(135deg, #28a745, #20c997); border: none; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                    <i class="fas fa-check me-2"></i>Aceptar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- DataTables CSS y JS desde CDN -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/colresize/1.0.0/dataTables.colResize.css">
<link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css">

<!-- Toastr CSS y JS para notificaciones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/colresize/1.0.0/dataTables.colResize.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>

<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
$(document).ready(function() {
    // =====================================
    // CONFIGURACIÓN DE TOASTR
    // =====================================
    
    // Configurar toastr si está disponible
    if (typeof toastr !== 'undefined') {
        toastr.options = {
            closeButton: true,
            debug: false,
            newestOnTop: true,
            progressBar: true,
            positionClass: 'toast-top-right',
            preventDuplicates: true,
            onclick: null,
            showDuration: '300',
            hideDuration: '1000',
            timeOut: '4000',
            extendedTimeOut: '1000',
            showEasing: 'swing',
            hideEasing: 'linear',
            showMethod: 'fadeIn',
            hideMethod: 'fadeOut',
            toastClass: 'toast-pacifico',
            iconClasses: {
                error: 'toast-error',
                info: 'toast-info',
                success: 'toast-success',
                warning: 'toast-warning'
            }
        };
        
        console.log('✅ Toastr configurado correctamente');
    } else {
        console.warn('⚠️ Toastr no está disponible');
    }
    
    // =====================================
    // INICIALIZACIÓN DE DATATABLES
    // =====================================
    
    // Inicializar DataTable con configuración mejorada
    var table = $('#tablaSolicitudes').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        scrollX: true,
        scrollY: '70vh',
        scrollCollapse: true,
        fixedColumns: {
            left: 1,
            heightMatch: 'auto'
        },
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json',
            search: 'Buscar:',
            lengthMenu: 'Mostrar _MENU_ registros',
            info: 'Mostrando _START_ a _END_ de _TOTAL_ registros',
            paginate: {
                previous: 'Anterior',
                next: 'Siguiente'
            }
        },
        columnDefs: [
            { orderable: false, targets: [10, 11] }, // Etiquetas y Prioridad no ordenables
            { width: '80px', targets: 0 }, // Nº
            { width: '200px', targets: 1 }, // Cliente
            { width: '150px', targets: 2 }, // Producto
            { width: '120px', targets: 3 }, // Monto
            { width: '150px', targets: 4 }, // Propietario
            { width: '150px', targets: 5 }, // Asignado a
            { width: '120px', targets: 6 }, // Etapa
            { width: '100px', targets: 7 }, // Estado
            { width: '150px', targets: 8 }, // Fecha SLA
            { width: '120px', targets: 9 }, // SLA
            { width: '180px', targets: 10 }, // Etiquetas
            { width: '100px', targets: 11 }, // Prioridad
        ],
        autoWidth: false,
        pageLength: 25,
        responsive: false,
        deferRender: true,
        processing: true,
        dom: 'rt<"bottom d-flex justify-content-between align-items-center mt-3"<"d-flex align-items-center gap-2"l<"text-muted small"i>>p><"clear">'
    });

    // Ocultar el buscador nativo de DataTables
    $('.dataTables_filter').hide();
    
    // Configurar filtros dinámicos
    // =====================================
    // FUNCIONES DE NOTIFICACIÓN PERSONALIZADA
    // =====================================
    
    function mostrarNotificacionExito(mensaje) {
        var $notificacion = $(`
            <div class="notificacion-personalizada notificacion-exito">
                <div class="notificacion-contenido">
                    <i class="fas fa-check-circle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            </div>
        `);
        
        $('body').append($notificacion);
        
        // Animar entrada
        setTimeout(() => {
            $notificacion.addClass('show');
        }, 100);
        
        // Auto-remover después de 4 segundos
        setTimeout(() => {
            $notificacion.removeClass('show');
            setTimeout(() => $notificacion.remove(), 300);
        }, 4000);
    }
    
    function mostrarNotificacionError(mensaje) {
        console.log('🚨 Mostrando notificación de error:', mensaje);
        
        var $notificacion = $(`
            <div class="notificacion-personalizada notificacion-error">
                <div class="notificacion-contenido">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            </div>
        `);
        
        $('body').append($notificacion);
        
        // Animar entrada
        setTimeout(() => {
            $notificacion.addClass('show');
        }, 100);
        
        // Auto-remover después de 5 segundos (más tiempo para errores)
        setTimeout(() => {
            $notificacion.removeClass('show');
            setTimeout(() => $notificacion.remove(), 300);
        }, 5000);
    }
    
    function configurarFiltros() {
        console.log('Configurando filtros...');
        
        // Obtener valores únicos de cada columna
        var clientes = new Set();
        var productos = new Set();
        var estados = new Set();
        var asignados = new Set();
        var slas = new Set();
        var prioridades = new Set();
        
        // Usar selector directo para obtener todas las filas
        $('#tablaSolicitudes tbody tr').each(function() {
            var $row = $(this);
            
            // Extraer datos de los atributos data-*
            var cliente = $row.attr('data-cliente');
            var producto = $row.attr('data-producto');
            var estado = $row.attr('data-estado');
            var asignado = $row.attr('data-asignado');
            var sla = $row.attr('data-sla');
            var prioridad = $row.attr('data-prioridad');
            
            console.log('Datos de fila:', { cliente, producto, estado, asignado, sla, prioridad });
            
            if (cliente && cliente !== 'Sin cliente') clientes.add(cliente);
            if (producto && producto !== 'Sin producto') productos.add(producto);
            if (estado && estado !== 'Sin estado') estados.add(estado);
            if (asignado && asignado !== 'Sin asignar') asignados.add(asignado);
            if (sla && sla !== 'sin sla') slas.add(sla);
            if (prioridad && prioridad !== 'Sin prioridad') prioridades.add(prioridad);
        });
        
        // Poblar filtros
        poblarFiltro('#filtroCliente', Array.from(clientes));
        poblarFiltro('#filtroProducto', Array.from(productos));
        poblarFiltro('#filtroEstado', Array.from(estados));
        poblarFiltro('#filtroAsignado', Array.from(asignados));
        poblarFiltro('#filtroSLA', Array.from(slas));
        poblarFiltro('#filtroPrioridad', Array.from(prioridades));
        
        console.log('Filtros configurados:', {
            clientes: Array.from(clientes),
            productos: Array.from(productos),
            estados: Array.from(estados),
            asignados: Array.from(asignados),
            slas: Array.from(slas),
            prioridades: Array.from(prioridades)
        });
    }
    
    function poblarFiltro(selector, valores) {
        var $select = $(selector);
        $select.find('option:not(:first)').remove();
        
        valores.sort().forEach(function(valor) {
            var texto = valor.charAt(0).toUpperCase() + valor.slice(1);
            $select.append('<option value="' + valor + '">' + texto + '</option>');
        });
    }
    
    // Configurar filtros al inicializar (después de que la tabla esté lista)
    setTimeout(function() {
        configurarFiltros();
    }, 500);
    
    // Aplicar filtros en tiempo real
    $('#filtroCliente, #filtroProducto, #filtroEstado, #filtroAsignado, #filtroSLA, #filtroPrioridad').on('change', function() {
        console.log('Filtro cambiado:', $(this).attr('id'), '=', $(this).val());
        aplicarFiltrosAvanzados();
    });
    
    // Búsqueda global
    $('#busquedaGlobal').on('keyup', function() {
        table.search(this.value).draw();
    });
    
    // Limpiar filtros
    $('#limpiarFiltros').on('click', function() {
        $('#filtroCliente, #filtroProducto, #filtroEstado, #filtroAsignado, #filtroSLA, #filtroPrioridad').val('');
        $('#busquedaGlobal').val('');
        table.search('').draw();
        aplicarFiltrosAvanzados();
    });
    
    // =====================================
    // MODAL DE CONFIRMACIÓN PERSONALIZADO
    // =====================================
    
    // Variables globales para el modal
    let modalConfirmCallback = null;
    let modalCancelCallback = null;
    
    // Función para mostrar modal de confirmación
    window.mostrarModalConfirmacion = function(nombreEtapa, onConfirm, onCancel, opciones) {
        // Opciones por defecto
        var configuracion = {
            titulo: 'Confirmar Cambio de Etapa',
            subtitulo: 'Sistema de Workflow',
            pregunta: '¿Está seguro del cambio?',
            descripcion: 'La solicitud se moverá a la siguiente etapa:',
            icono: 'fas fa-arrow-right',
            tipo: 'cambio_etapa' // cambio_etapa, eliminar, accion_general
        };
        
        // Sobrescribir configuración si se proporcionan opciones
        if (opciones) {
            configuracion = Object.assign(configuracion, opciones);
        }
        
        // Configurar para diferentes tipos de acción
        if (nombreEtapa === 'Eliminar Solicitud' || configuracion.tipo === 'eliminar') {
            configuracion.titulo = 'Confirmar Eliminación';
            configuracion.pregunta = '¿Está seguro de eliminar esta solicitud?';
            configuracion.descripcion = 'Esta acción no se puede deshacer:';
            configuracion.icono = 'fas fa-trash';
            $('#nombreEtapaDestino').html('<span class="text-danger fw-bold">Esta acción es permanente</span>');
        } else {
            // Para cambio de etapa normal
            $('#nombreEtapaDestino').text(nombreEtapa);
        }
        
        // Actualizar contenido del modal
        $('#modalConfirmacionEtapaLabel').html(`<i class="${configuracion.icono} me-2"></i>${configuracion.titulo}`);
        $('#modalConfirmacionEtapaLabel').next('p').text(configuracion.subtitulo);
        $('.modal-body h5').text(configuracion.pregunta);
        $('.modal-body p.text-muted').text(configuracion.descripcion);
        $('.modal-body .text-center .fas').removeClass().addClass(configuracion.icono).css('font-size', '2rem').css('color', '#28a745');
        
        // Guardar callbacks
        modalConfirmCallback = onConfirm;
        modalCancelCallback = onCancel || function() {};
        
        // Mostrar el modal
        var modal = new bootstrap.Modal(document.getElementById('modalConfirmacionEtapa'));
        modal.show();
    };
    
    // Event listeners para los botones del modal
    $('#btnAceptarModal').on('click', function() {
        // Ocultar modal
        bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionEtapa')).hide();
        
        // Ejecutar callback de confirmación
        if (modalConfirmCallback) {
            modalConfirmCallback();
        }
    });
    
    $('#btnCancelarModal').on('click', function() {
        // Ocultar modal
        bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionEtapa')).hide();
        
        // Ejecutar callback de cancelación
        if (modalCancelCallback) {
            modalCancelCallback();
        }
    });
    
    // Manejar cambio de etapa con modal personalizado
    $(document).on('change', '.etapa-select', function() {
        var $select = $(this);
        var solicitudId = $select.data('solicitud-id');
        var etapaActual = $select.data('etapa-actual');
        var nuevaEtapaId = $select.val();
        var nombreEtapa = $select.find('option:selected').text();
        
        console.log('🔥 CAMBIO DE ETAPA DETECTADO:');
        console.log('- Solicitud ID:', solicitudId);
        console.log('- Etapa Actual:', etapaActual);
        console.log('- Nueva Etapa ID:', nuevaEtapaId);
        console.log('- Nombre Etapa:', nombreEtapa);
        
        if (nuevaEtapaId === etapaActual.toString()) {
            console.log('❌ No hay cambio de etapa - valores iguales');
            return; // No hay cambio
        }
        
        // Mostrar modal de confirmación personalizado
        mostrarModalConfirmacion(nombreEtapa, function() {
            // CALLBACK DE CONFIRMACIÓN
            console.log('✅ Confirmado desde modal personalizado, ejecutando cambio de etapa');
            
            // Deshabilitar select mientras se procesa
            $select.prop('disabled', true);
            
            // Realizar petición AJAX
            fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                body: JSON.stringify({
                    etapa_id: nuevaEtapaId
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Respuesta del servidor:', data);
                if (data.success) {
                    // Actualizar data attribute
                    $select.data('etapa-actual', nuevaEtapaId);
                    
                    // Mostrar mensaje de éxito con toastr si está disponible
                    if (typeof toastr !== 'undefined') {
                        toastr.success(data.mensaje || 'Etapa cambiada exitosamente');
                    } else {
                        // Usar notificación personalizada en lugar de alert
                        mostrarNotificacionExito(data.mensaje || 'Etapa cambiada exitosamente');
                    }
                    
                    // Recargar página
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    if (typeof toastr !== 'undefined') {
                        toastr.error('Error: ' + data.error);
                    } else {
                        mostrarNotificacionError('Error: ' + data.error);
                    }
                    $select.val(etapaActual); // Revertir selección
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof toastr !== 'undefined') {
                    toastr.error('Error al cambiar etapa');
                } else {
                    mostrarNotificacionError('Error al cambiar etapa');
                }
                $select.val(etapaActual); // Revertir selección
            })
            .finally(() => {
                $select.prop('disabled', false);
            });
            
        }, function() {
            // CALLBACK DE CANCELACIÓN
            console.log('❌ Cancelado desde modal personalizado');
            $select.val(etapaActual); // Revertir selección
        });
    });
    
    function aplicarFiltrosAvanzados() {
        console.log('Aplicando filtros avanzados...');
        
        // Limpiar filtros anteriores
        $.fn.dataTable.ext.search.splice(0, $.fn.dataTable.ext.search.length);
        
        var filtros = {
            cliente: $('#filtroCliente').val(),
            producto: $('#filtroProducto').val(),
            estado: $('#filtroEstado').val(),
            asignado: $('#filtroAsignado').val(),
            sla: $('#filtroSLA').val(),
            prioridad: $('#filtroPrioridad').val()
        };
        
        console.log('Filtros activos:', filtros);
        
        // Solo aplicar filtros si hay valores seleccionados
        var hayFiltros = Object.values(filtros).some(valor => valor !== '');
        
        if (hayFiltros) {
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                // Verificar que estamos en la tabla correcta
                if (settings.nTable.id !== 'tablaSolicitudes') {
                    return true;
                }
                
                // Obtener la fila del DOM usando el API de DataTables
                var row = table.row(dataIndex);
                if (!row.node()) {
                    return true;
                }
                
                var $row = $(row.node());
                var match = true;
                
                if (filtros.cliente) {
                    var dataCliente = $row.attr('data-cliente');
                    match = match && (dataCliente === filtros.cliente);
                    console.log('Cliente:', dataCliente, '===', filtros.cliente, '?', match);
                }
                if (filtros.producto) {
                    var dataProducto = $row.attr('data-producto');
                    match = match && (dataProducto === filtros.producto);
                    console.log('Producto:', dataProducto, '===', filtros.producto, '?', match);
                }
                if (filtros.estado) {
                    var dataEstado = $row.attr('data-estado');
                    match = match && (dataEstado === filtros.estado);
                    console.log('Estado:', dataEstado, '===', filtros.estado, '?', match);
                }
                if (filtros.asignado) {
                    var dataAsignado = $row.attr('data-asignado');
                    match = match && (dataAsignado === filtros.asignado);
                    console.log('Asignado:', dataAsignado, '===', filtros.asignado, '?', match);
                }
                if (filtros.sla) {
                    var dataSla = $row.attr('data-sla');
                    match = match && (dataSla === filtros.sla);
                    console.log('SLA:', dataSla, '===', filtros.sla, '?', match);
                }
                if (filtros.prioridad) {
                    var dataPrioridad = $row.attr('data-prioridad');
                    match = match && (dataPrioridad === filtros.prioridad);
                    console.log('Prioridad:', dataPrioridad, '===', filtros.prioridad, '?', match);
                }
                
                console.log('Fila', dataIndex, 'match final:', match);
                return match;
            });
        }
        
        table.draw();
        console.log('Filtros aplicados, tabla redibujada');
    }
    
    // Función mejorada para mostrar modal de solicitud
    window.mostrarModalSolicitud = function(solicitudId) {
        // Limpia el modal
        $('#modalSolicitudCodigo').text('Cargando...');
        $('#modalSolicitudEstadoBadge').text('');
        $('#modalSolicitudTipo').text('');
        $('#modalSolicitudFechaInicio').text('-');
        $('#modalSolicitudVencimiento').text('-');
        $('#modalSolicitudEtapaActual').text('-');
        $('#modalSolicitudArea').text('-');
        $('#modalSolicitudCliente').text('-');
        $('#modalSolicitudCedula').text('-');
        $('#modalSolicitudCanal').text('-');
        // Acciones
        $('#modalBtnProcesarTarea').prop('disabled', true);
        $('#modalBtnDevolver').prop('disabled', true);
        $('#modalBtnAnular').prop('disabled', true);
        $('#modalBtnComentarios').prop('disabled', true);
        // Workflow, historial, comentarios
        $('#modalSolicitudWorkflowProgress').html('<div class="text-center text-muted py-2">Cargando...</div>');
        $('#modalSolicitudWorkflowDetail').html('');
        $('#modalSolicitudHistorial').html('');
        $('#modalSolicitudComentarios').html('');

        // Fetch API
        $.get(`/workflow/api/solicitud_brief/${solicitudId}/`, function(data) {
            // General
            $('#modalSolicitudCodigo').text(data.general.codigo || '-');
            $('#modalSolicitudEstadoBadge').text(data.general.estado || '-');
            $('#modalSolicitudTipo').text(data.general.tipo || '-');
            $('#modalSolicitudFechaInicio').text(data.general.fecha_inicio || '-');
            $('#modalSolicitudVencimiento').text(data.general.vencimiento || '-');
            $('#modalSolicitudEtapaActual').text(data.general.etapa_actual || '-');
            $('#modalSolicitudArea').text(data.general.area || '-');
            // Cliente
            $('#modalSolicitudCliente').text(data.cliente.nombre || '-');
            $('#modalSolicitudCedula').text(data.cliente.cedula || '-');
            $('#modalSolicitudCanal').text(data.cliente.canal || '-');
            // Acciones
            $('#modalBtnProcesarTarea').prop('disabled', !data.acciones.puede_procesar);
            $('#modalBtnDevolver').prop('disabled', !data.acciones.puede_devolver);
            $('#modalBtnAnular').prop('disabled', !data.acciones.puede_anular);
            $('#modalBtnComentarios').prop('disabled', !data.acciones.puede_comentar);
            // --- WORKFLOW ROADMAP ---
            let etapas = data.workflow;
            let roadmapHtml = '<div class="workflow-roadmap">';
            etapas.forEach(function(etapa, idx) {
                let stepClass = etapa.actual ? 'workflow-step current' : (etapa.completada ? 'workflow-step completed' : 'workflow-step pending');
                let icon = etapa.completada ? '<i class="fas fa-check"></i>' : (etapa.actual ? '<i class="fas fa-bolt"></i>' : (idx+1));
                roadmapHtml += `<div class="${stepClass}">
                    <div class="circle">${icon}</div>
                    <div class="step-label">${etapa.nombre}</div>
                </div>`;
                if (idx < etapas.length - 1) {
                    roadmapHtml += '<div class="workflow-connector"></div>';
                }
            });
            roadmapHtml += '</div>';
            $('#modalSolicitudWorkflowProgress').html(roadmapHtml);
            // Workflow detail (tab)
            let detailHtml = '<ul class="list-group">';
            etapas.forEach(function(etapa) {
                detailHtml += `<li class="list-group-item d-flex justify-content-between align-items-center ${etapa.actual ? 'active' : ''}">
                    <span>${etapa.nombre}</span>
                    <span class="badge bg-${etapa.completada ? 'success' : (etapa.actual ? 'warning text-dark' : 'secondary')}">${etapa.completada ? 'Completada' : (etapa.actual ? 'Actual' : 'Pendiente')}</span>
                </li>`;
            });
            detailHtml += '</ul>';
            $('#modalSolicitudWorkflowDetail').html(detailHtml);
            // Historial
            let histHtml = '<ul class="list-group">';
            data.historial.forEach(function(h) {
                histHtml += `<li class="list-group-item">
                    <div><b>Etapa:</b> ${h.etapa} <span class="text-muted small">(${h.subestado})</span></div>
                    <div><b>Usuario:</b> ${h.usuario}</div>
                    <div><b>Inicio:</b> ${h.fecha_inicio} ${h.fecha_fin ? '<b>Fin:</b> ' + h.fecha_fin : ''}</div>
                </li>`;
            });
            histHtml += '</ul>';
            $('#modalSolicitudHistorial').html(histHtml);
            // Comentarios
            let comHtml = '';
            if (data.comentarios.length === 0) {
                comHtml = '<div class="text-muted">Sin comentarios.</div>';
            } else {
                data.comentarios.forEach(function(c) {
                    comHtml += `<div class="border rounded p-2 mb-2"><b>${c.usuario}</b> <span class="text-muted small">${c.fecha}</span><br>${c.texto}</div>`;
                });
            }
            $('#modalSolicitudComentarios').html(comHtml);
        });
        // Mostrar modal
        var modal = new bootstrap.Modal(document.getElementById('modalSolicitud'));
        modal.show();
    };
    
    // Función para manejar clicks en filas de la tabla
    function handleRowClick(event, solicitudId) {
        // Prevenir el click si el usuario está interactuando con elementos de formulario
        if (event.target.tagName === 'SELECT' || 
            event.target.tagName === 'BUTTON' || 
            event.target.tagName === 'INPUT' ||
            event.target.closest('select') ||
            event.target.closest('button') ||
            event.target.closest('input') ||
            event.target.closest('.dropdown') ||
            event.target.closest('.menu-dropdown')) {
            return;
        }
        
        // Si no es un elemento de formulario, mostrar el modal
        mostrarModalSolicitud(solicitudId);
    }
    


    // Función para cambiar entre vistas
    window.cambiarVista = function(vista) {
        console.log('Cambiando a vista:', vista);
        
        // Obtener parámetros actuales de la URL
        var urlParams = new URLSearchParams(window.location.search);
        
        // Actualizar el parámetro de vista
        urlParams.set('view', vista);
        
        // Mantener el pipeline si existe
        {% if pipeline %}
        urlParams.set('pipeline', '{{ pipeline.id }}');
        {% endif %}
        
        // Redirigir con los nuevos parámetros
        var newUrl = window.location.pathname + '?' + urlParams.toString();
        window.location.href = newUrl;
    };
    
    // Actualizar estado de botones según vista actual
    $(document).ready(function() {
        var currentView = '{{ request.GET.view|default:"table" }}';
        
        if (currentView === 'kanban') {
            $('#btnVistaTabla').removeClass('active btn-light').addClass('btn-outline-light');
            $('#btnVistaKanban').removeClass('btn-outline-light').addClass('active btn-light');
        } else {
            $('#btnVistaTabla').removeClass('btn-outline-light').addClass('active btn-light');
            $('#btnVistaKanban').removeClass('active btn-light').addClass('btn-outline-light');
        }
    });
});
</script>

<!-- Mantener estilos PACIFICO para badges y botones -->
<style>
/* Estilos para botones de cambio de vista */
.btn-group .btn {
    border-radius: 0.375rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-group .btn:first-child {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-group .btn:last-child {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.btn-group .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-group .btn.active {
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Estilos para filtros responsivos */
@media (max-width: 991.98px) {
    .card-header-custom .row .col-6:nth-child(odd) {
        padding-right: 0.5rem;
    }
    .card-header-custom .row .col-6:nth-child(even) {
        padding-left: 0.5rem;
    }
}

@media (max-width: 767.98px) {
    .ribbon-actions .btn-group {
        flex-direction: column;
    }
    .ribbon-actions .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 2px;
    }
    .ribbon-actions {
        flex-direction: column;
        gap: 8px !important;
    }
}

/* Estilos para filas clickeables */
.clickable-row {
    transition: all 0.2s ease;
}

.clickable-row:hover {
    background-color: rgba(0, 156, 60, 0.1) !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.clickable-row:active {
    transform: translateY(0);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
}

/* Mejorar paginación de DataTables */
.dataTables_wrapper .bottom {
    background: #f8f9fa;
    padding: 15px;
    border-top: 1px solid #dee2e6;
    border-radius: 0 0 8px 8px;
}

.dataTables_length select {
    min-width: 60px;
}

.dataTables_info {
    font-size: 0.875rem;
}

/* Estilos para Kanban Drag & Drop */
.kanban-card {
    cursor: grab;
    transition: all 0.3s ease;
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.kanban-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg) scale(0.95);
    cursor: grabbing;
}

.kanban-card.updating {
    opacity: 0.7;
    pointer-events: none;
}

.drop-zone-active {
    border: 2px dashed #007bff;
    background-color: rgba(0, 123, 255, 0.05);
    border-radius: 8px;
}

.drop-zone-hover {
    border-color: #28a745 !important;
    background-color: rgba(40, 167, 69, 0.1) !important;
}

.drag-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s ease;
    font-weight: 500;
}

.drag-notification.show {
    transform: translateX(0);
    opacity: 1;
}

/* Estilos para tarjetas Kanban compactas */
.kanban-column {
    border-radius: 12px;
    overflow: hidden;
}

.kanban-column-body {
    background: #f8f9fa;
}

.kanban-card .card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.kanban-card .card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* Responsividad para filtros Kanban */
@media (max-width: 768px) {
    .kanban-board {
        padding-bottom: 20px !important;
    }
    
    .kanban-column {
        min-width: 280px !important;
        width: 280px !important;
    }
    
    .card-body.py-2 .row {
        row-gap: 0.5rem;
    }
}

/* Estilos mejorados para contenedores Kanban */
.kanban-container {
    min-height: 700px;
    background: #f1f3f4;
    border-radius: 12px;
    padding: 1rem;
}

.kanban-board {
    gap: 0.75rem;
    padding-bottom: 1rem;
}

.kanban-column .card {
    border: 2px solid #e9ecef;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-radius: 12px;
    overflow: hidden;
    background: #ffffff;
}

.kanban-column .card-header {
    background: #28a745;
    border: none;
    padding: 1rem;
    color: white;
}

.kanban-column-body {
    background: #fafbfc;
    padding: 1rem;
}

/* Estilos para tarjetas individuales mejoradas */
.kanban-card .card {
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 6px;
    transition: all 0.3s ease;
    background: white;
    height: 110px;
}

.kanban-card .card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.kanban-card .card-body {
    padding: 0.5rem;
    height: 100%;
}

/* Scrollbar personalizado para contenedores Kanban */
.kanban-column-body::-webkit-scrollbar {
    width: 6px;
}

.kanban-column-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.kanban-column-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.kanban-column-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Animaciones mejoradas para drag and drop */
.kanban-card.dragging {
    opacity: 0.7;
    transform: rotate(2deg) scale(1.02);
    z-index: 1000;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.kanban-column.drag-over {
    background: #e8f5e8;
    border: 2px dashed #28a745;
    transform: scale(1.02);
    transition: all 0.3s ease;
}

/* Estilos para badges y etiquetas */
.badge {
    font-size: 0.65rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 500;
}

/* Mejoras visuales adicionales */
.kanban-card .dropdown-toggle {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    transition: all 0.2s ease;
}

.kanban-card .dropdown-toggle:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
}

.kanban-card .dropdown-menu {
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 8px;
    padding: 0.5rem 0;
}

.kanban-card .dropdown-item {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.kanban-card .dropdown-item:hover {
    background: #f8f9fa;
    color: #495057;
}

/* Responsive mejoras */
@media (max-width: 768px) {
    .kanban-container {
        min-height: 500px;
        padding: 0.5rem;
    }
    
    .kanban-board {
        gap: 0.5rem;
    }
    
    .kanban-column {
        min-width: 300px !important;
        width: 300px !important;
    }
    
    .kanban-card .card {
        min-height: 150px;
    }
}
    margin: 0;
}

/* Responsividad para vistas móvil y desktop */
.vista-movil {
    display: block !important;
}

.vista-desktop {
    display: none !important;
}

/* En pantallas pequeñas (sm y superiores - ≥576px) */
@media (min-width: 576px) {
    .vista-movil {
        display: none !important;
    }
    
    .vista-desktop {
        display: block !important;
    }
}

/* Estilos específicos para la vista móvil usando Tailwind-like classes pero con CSS tradicional */
.vista-movil .bg-white { background-color: white; }
.vista-movil .rounded-lg { border-radius: 0.5rem; }
.vista-movil .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
.vista-movil .border { border: 1px solid #e5e7eb; }
.vista-movil .p-4 { padding: 1rem; }
.vista-movil .mb-4 { margin-bottom: 1rem; }
.vista-movil .w-full { width: 100%; }
.vista-movil .pl-10 { padding-left: 2.5rem; }
.vista-movil .pr-4 { padding-right: 1rem; }
.vista-movil .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
.vista-movil .border-gray-300 { border-color: #d1d5db; }
.vista-movil .rounded-lg { border-radius: 0.5rem; }
.vista-movil .focus\:ring-2:focus { outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
.vista-movil .focus\:ring-blue-500:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
.vista-movil .focus\:border-transparent:focus { border-color: transparent; }
.vista-movil .absolute { position: absolute; }
.vista-movil .inset-y-0 { top: 0; bottom: 0; }
.vista-movil .left-0 { left: 0; }
.vista-movil .pl-3 { padding-left: 0.75rem; }
.vista-movil .flex { display: flex; }
.vista-movil .items-center { align-items: center; }
.vista-movil .text-gray-400 { color: #9ca3af; }
.vista-movil .gap-2 { gap: 0.5rem; }
.vista-movil .overflow-x-auto { overflow-x: auto; }
.vista-movil .pb-2 { padding-bottom: 0.5rem; }
.vista-movil .whitespace-nowrap { white-space: nowrap; }
.vista-movil .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
.vista-movil .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
.vista-movil .rounded-full { border-radius: 9999px; }
.vista-movil .text-xs { font-size: 0.75rem; line-height: 1rem; }
.vista-movil .font-medium { font-weight: 500; }
.vista-movil .bg-blue-100 { background-color: #dbeafe; }
.vista-movil .text-blue-800 { color: #1e40af; }
.vista-movil .border-blue-200 { border-color: #bfdbfe; }
.vista-movil .bg-gray-100 { background-color: #f3f4f6; }
.vista-movil .text-gray-700 { color: #374151; }
.vista-movil .border-gray-200 { border-color: #e5e7eb; }
.vista-movil .space-y-4 > * + * { margin-top: 1rem; }
.vista-movil .rounded-xl { border-radius: 0.75rem; }
.vista-movil .overflow-hidden { overflow: hidden; }
.vista-movil .hover\:shadow-md:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
.vista-movil .transition-shadow { transition-property: box-shadow; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
.vista-movil .duration-200 { transition-duration: 200ms; }
.vista-movil .pb-3 { padding-bottom: 0.75rem; }
.vista-movil .items-start { align-items: flex-start; }
.vista-movil .justify-between { justify-content: space-between; }
.vista-movil .mb-3 { margin-bottom: 0.75rem; }
.vista-movil .space-x-2 > * + * { margin-left: 0.5rem; }
.vista-movil .w-3 { width: 0.75rem; }
.vista-movil .h-3 { height: 0.75rem; }
.vista-movil .bg-red-500 { background-color: #ef4444; }
.vista-movil .bg-yellow-500 { background-color: #eab308; }
.vista-movil .bg-green-500 { background-color: #22c55e; }
.vista-movil .bg-gray-400 { background-color: #9ca3af; }
.vista-movil .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
.vista-movil .font-bold { font-weight: 700; }
.vista-movil .text-gray-900 { color: #111827; }
.vista-movil .font-semibold { font-weight: 600; }
.vista-movil .bg-red-100 { background-color: #fee2e2; }
.vista-movil .text-red-800 { color: #991b1b; }
.vista-movil .bg-yellow-100 { background-color: #fef3c7; }
.vista-movil .text-yellow-800 { color: #92400e; }
.vista-movil .bg-green-100 { background-color: #dcfce7; }
.vista-movil .text-green-800 { color: #166534; }
.vista-movil .bg-gray-800 { background-color: #1f2937; }
.vista-movil .relative { position: relative; }
.vista-movil .p-1 { padding: 0.25rem; }
.vista-movil .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
.vista-movil .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
.vista-movil .right-0 { right: 0; }
.vista-movil .top-8 { top: 2rem; }
.vista-movil .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
.vista-movil .z-10 { z-index: 10; }
.vista-movil .hidden { display: none; }
.vista-movil .min-w-40 { min-width: 10rem; }
.vista-movil .block { display: block; }
.vista-movil .px-4 { padding-left: 1rem; padding-right: 1rem; }
.vista-movil .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
.vista-movil .hover\:bg-gray-50:hover { background-color: #f9fafb; }
.vista-movil .w-full { width: 100%; }
.vista-movil .text-left { text-align: left; }
.vista-movil .text-red-600 { color: #dc2626; }
.vista-movil .hover\:bg-red-50:hover { background-color: #fef2f2; }
.vista-movil .grid { display: grid; }
.vista-movil .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
.vista-movil .gap-3 { gap: 0.75rem; }
.vista-movil .text-gray-500 { color: #6b7280; }
.vista-movil .uppercase { text-transform: uppercase; }
.vista-movil .tracking-wide { letter-spacing: 0.025em; }
.vista-movil .text-green-600 { color: #16a34a; }
.vista-movil .space-y-2 > * + * { margin-top: 0.5rem; }
.vista-movil .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.vista-movil .ml-2 { margin-left: 0.5rem; }
.vista-movil .w-6 { width: 1.5rem; }
.vista-movil .h-6 { height: 1.5rem; }
.vista-movil .text-blue-600 { color: #2563eb; }
.vista-movil .bg-orange-100 { background-color: #fed7aa; }
.vista-movil .text-orange-800 { color: #9a3412; }
.vista-movil .mr-1 { margin-right: 0.25rem; }
.vista-movil .inline-block { display: inline-block; }
.vista-movil .bg-purple-100 { background-color: #f3e8ff; }
.vista-movil .text-purple-800 { color: #6b21a8; }
.vista-movil .mb-1 { margin-bottom: 0.25rem; }
.vista-movil .bg-gray-50 { background-color: #f9fafb; }
.vista-movil .border-t { border-top-width: 1px; }
.vista-movil .border-gray-100 { border-color: #f3f4f6; }
.vista-movil .space-x-4 > * + * { margin-left: 1rem; }
.vista-movil .pt-3 { padding-top: 0.75rem; }
.vista-movil .text-center { text-align: center; }
.vista-movil .bg-blue-600 { background-color: #2563eb; }
.vista-movil .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
.vista-movil .text-white { color: white; }
.vista-movil .rounded-lg { border-radius: 0.5rem; }
.vista-movil .bg-gray-600 { background-color: #4b5563; }
.vista-movil .hover\:bg-gray-700:hover { background-color: #374151; }
.vista-movil .bg-red-600 { background-color: #dc2626; }
.vista-movil .hover\:bg-red-700:hover { background-color: #b91c1c; }
.vista-movil .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
.vista-movil .w-16 { width: 4rem; }
.vista-movil .h-16 { height: 4rem; }
.vista-movil .mx-auto { margin-left: auto; margin-right: auto; }
.vista-movil .text-2xl { font-size: 1.5rem; line-height: 2rem; }
.vista-movil .mb-2 { margin-bottom: 0.5rem; }
.vista-movil .mt-6 { margin-top: 1.5rem; }
.vista-movil .justify-center { justify-content: center; }
.vista-movil .space-x-1 > * + * { margin-left: 0.25rem; }
.vista-movil .rounded-l-md { border-top-left-radius: 0.375rem; border-bottom-left-radius: 0.375rem; }
.vista-movil .hover\:bg-gray-50:hover { background-color: #f9fafb; }
.vista-movil .border-t { border-top-width: 1px; }
.vista-movil .border-b { border-bottom-width: 1px; }
.vista-movil .rounded-r-md { border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem; }

/* Ocultar buscador nativo de DataTables */
.dataTables_filter {
    display: none !important;
}

/* === ESTILOS PARA KPIs COMPACTOS === */
.kpi-card-compact {
    background: #ffffff;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 156, 60, 0.1);
    transition: all 0.3s ease;
    height: 100%;
    display: flex;
    align-items: center;
}

.kpi-card-compact:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-color: rgba(0, 156, 60, 0.2);
}

.kpi-icon-compact {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    margin-right: 10px;
    flex-shrink: 0;
}

.kpi-content-compact {
    flex: 1;
    min-width: 0;
}

.kpi-label-compact {
    font-size: 0.65rem;
    font-weight: 600;
    margin: 0 0 2px 0;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    opacity: 0.7;
    line-height: 1;
}

.kpi-number-compact {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    line-height: 1;
}

/* Variantes de KPIs compactos */
.kpi-total .kpi-icon-compact {
    background: linear-gradient(135deg, #009c3c, #22a650);
    color: white;
}

.kpi-total .kpi-number-compact {
    color: #009c3c;
}

.kpi-activas .kpi-icon-compact {
    background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    color: white;
}

.kpi-activas .kpi-number-compact {
    color: #0d6efd;
}

.kpi-completadas .kpi-icon-compact {
    background: linear-gradient(135deg, #ffc107, #ffb84d);
    color: #000;
}

.kpi-completadas .kpi-number-compact {
    color: #ffc107;
}

.kpi-vencidas .kpi-icon-compact {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.kpi-vencidas .kpi-number-compact {
    color: #dc3545;
}

/* === ESTILOS PARA TABLA OPTIMIZADA === */
.table-container {
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

.table-container .table-responsive {
    overflow-y: auto;
    overflow-x: auto;
}

.table-container .table {
    margin-bottom: 0;
}

.table-container .sticky-top {
    position: sticky;
    top: 0;
    z-index: 1020;
    background: #f8f9fa;
}

.solicitud-link {
    color: #009c3c;
    font-weight: 600;
    transition: all 0.2s ease;
}

.solicitud-link:hover {
    color: #007529;
    text-decoration: underline !important;
}

/* Responsive para filtros integrados */
@media (max-width: 1200px) {
    .card-header-custom .d-flex {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .card-header-custom select {
        width: 100px !important;
        font-size: 0.75rem;
    }
    
    .card-header-custom input {
        width: 150px !important;
    }
}

@media (max-width: 768px) {
    .card-header-custom .d-flex {
        flex-direction: column;
        align-items: stretch;
    }
    
    .card-header-custom select,
    .card-header-custom input {
        width: 100% !important;
        margin-bottom: 0.5rem;
    }
}

/* === ESTILOS PARA LEYENDA SLA COMPACTA === */
.sla-legend-compact {
    padding: 8px 12px;
    background: rgba(0, 156, 60, 0.02);
    border: 1px solid rgba(0, 156, 60, 0.1);
    border-radius: 6px;
    margin-bottom: 8px;
}

.sla-legend-compact small {
    font-size: 0.75rem;
    line-height: 1.2;
}

.sla-legend-compact i.fa-circle {
    display: inline-block;
    margin-right: 4px;
}

/* Responsive para KPIs */
@media (max-width: 768px) {
    .kpi-card {
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 8px;
    }
    
    .kpi-number {
        font-size: 1.25rem;
    }
    
    .kpi-label {
        font-size: 0.7rem;
    }
    
    .kpi-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
        margin-right: 8px;
    }
    
    .sla-legend-items {
        gap: 16px;
    }
}

/* Estilos para el buscador personalizado en el header */
#busquedaTabla {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

#busquedaTabla:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}
.dataTables_info {
    display: none !important;
}
/* Oculta solo el selector de cantidad de registros de la parte superior, pero no el de abajo */
.dataTables_wrapper > .dataTables_length:first-child {
    display: none !important;
}
.dataTables_length {
    float: none !important;
    display: inline-block !important;
    margin: 0 1rem 0 0 !important;
    vertical-align: middle;
}
.dataTables_wrapper .dt-bottom-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}

/* Estilos para columna fija */
.DTFC_LeftWrapper {
    background: #f8f9fa;
    border-right: 2px solid #dee2e6;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

.DTFC_LeftWrapper table {
    background: white;
}

.DTFC_LeftWrapper th,
.DTFC_LeftWrapper td {
    background: white !important;
    border-right: 1px solid #dee2e6;
}

/* Mejorar la separación visual */
.DTFC_LeftWrapper th:last-child,
.DTFC_LeftWrapper td:last-child {
    border-right: 2px solid #007bff;
}

/* Centrar encabezados de columnas */
#tablaSolicitudes thead th {
    text-align: center !important;
    vertical-align: middle !important;
    font-weight: 600 !important;
    background-color: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6 !important;
}

/* Centrar también los encabezados en la columna fija */
.DTFC_LeftWrapper thead th {
    text-align: center !important;
    vertical-align: middle !important;
    font-weight: 600 !important;
    background-color: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6 !important;
}

/* Mejorar la apariencia general de la tabla */
#tablaSolicitudes {
    border-collapse: collapse !important;
    width: 100% !important;
}

#tablaSolicitudes tbody tr:hover {
    background-color: #f8f9fa !important;
    transition: background-color 0.2s ease;
}

#tablaSolicitudes tbody td {
    vertical-align: middle !important;
    padding: 0.75rem 0.5rem !important;
    border-bottom: 1px solid #dee2e6 !important;
}

/* Estilos para la columna fija mejorados */
.DTFC_LeftWrapper {
    background: #f8f9fa !important;
    border-right: 3px solid #007bff !important;
    box-shadow: 3px 0 8px rgba(0,0,0,0.15) !important;
    z-index: 1000 !important;
}

.DTFC_LeftWrapper table {
    background: white !important;
    border-collapse: collapse !important;
}

.DTFC_LeftWrapper th,
.DTFC_LeftWrapper td {
    background: white !important;
    border-right: 1px solid #dee2e6 !important;
    padding: 0.75rem 0.5rem !important;
}

.DTFC_LeftWrapper tbody tr:hover {
    background-color: #e3f2fd !important;
}

/* Mejorar la separación visual de la columna fija */
.DTFC_LeftWrapper th:last-child,
.DTFC_LeftWrapper td:last-child {
    border-right: 3px solid #007bff !important;
    position: relative;
}

.DTFC_LeftWrapper th:last-child::after,
.DTFC_LeftWrapper td:last-child::after {
    content: '';
    position: absolute;
    right: -3px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(90deg, #007bff, #0056b3);
}

/* Estilos para el scroll horizontal */
.dataTables_scrollBody {
    border: 1px solid #dee2e6 !important;
    border-radius: 0.375rem !important;
}

.dataTables_scrollHead {
    border: 1px solid #dee2e6 !important;
    border-bottom: none !important;
    border-radius: 0.375rem 0.375rem 0 0 !important;
}

/* Estilos para los filtros mejorados */
.form-control-custom {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

/* Estilos para filtros compactos en una fila */
.form-select-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 0.25rem;
}

.form-control-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 0.25rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 0.25rem;
}

.small {
    font-size: 0.75rem;
    margin-bottom: 0.25rem;
}

/* Espaciado compacto para filtros */
.row.g-2 {
    --bs-gutter-x: 0.5rem;
    --bs-gutter-y: 0.5rem;
}

/* Alineación de elementos en filtros */
.align-items-end {
    align-items: end !important;
}

.form-control-custom:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.form-label.fw-semibold {
    color: #495057;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

/* Estilos para botones de filtros */
.btn-pacifico {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

.btn-pacifico:hover {
    background-color: #0056b3;
    border-color: #0056b3;
    color: white;
}

.btn-outline-pacifico {
    color: #007bff;
    border-color: #007bff;
}

.btn-outline-pacifico:hover {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

/* Estilos para botones en el header de filtros */
.card-header-custom .btn-light {
    background-color: rgba(255, 255, 255, 0.9);
    border-color: rgba(255, 255, 255, 0.3);
    color: #495057;
    font-weight: 500;
    transition: all 0.2s ease;
}

.card-header-custom .btn-light:hover {
    background-color: rgba(255, 255, 255, 1);
    border-color: rgba(255, 255, 255, 0.5);
    color: #212529;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.card-header-custom .btn-outline-light {
    background-color: transparent;
    border-color: rgba(255, 255, 255, 0.5);
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    transition: all 0.2s ease;
}

.card-header-custom .btn-outline-light:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.8);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Animación para los filtros */
.card-custom {
    transition: all 0.3s ease;
}

.card-custom:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

/* Estilos para filtros activos */
.filtro-activo {
    background-color: #e3f2fd !important;
    border-color: #2196f3 !important;
    box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25) !important;
}

.filtro-activo:focus {
    background-color: #e3f2fd !important;
    border-color: #1976d2 !important;
    box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25) !important;
}

/* Indicador visual para filtros activos */
.filtro-activo::before {
    content: '✓';
    position: absolute;
    top: -8px;
    right: -8px;
    background: #2196f3;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    z-index: 10;
}

/* Contenedor relativo para el indicador */
.col-md-2 {
    position: relative;
}

/* Estilos para la cinta (ribbon) */
.ribbon-container {
    position: relative;
    margin-bottom: 2rem;
}

.ribbon {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 1.5rem 2rem;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    position: relative;
    overflow: hidden;
}

.ribbon::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ffc107, #fd7e14, #e83e8c, #6f42c1);
    border-radius: 8px 8px 0 0;
}

.ribbon-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.ribbon-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.ribbon h1 {
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.ribbon p {
    margin: 0;
    opacity: 0.9;
}

/* Responsive para la cinta */
@media (max-width: 768px) {
    .ribbon-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .ribbon-actions {
        margin-top: 1rem;
    }
}

.table-row-hover:hover {
    background-color: #f5f9f6 !important;
    transition: background 0.2s;
}

/* MEJORAS PREMIUM PARA VISTA MÓVIL - ESTILO PACIFICO */
.vista-movil .solicitud-card {
    background: #ffffff !important;
    border-radius: 16px !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08) !important;
    border: 2px solid rgba(0, 156, 60, 0.2) !important;
    margin-bottom: 20px !important;
    overflow: hidden !important;
    transition: all 0.3s ease !important;
    position: relative !important;
}

.vista-movil .solicitud-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #009c3c, #22a650, #00d46a);
    z-index: 1;
}

.vista-movil .solicitud-card:hover {
    transform: translateY(-4px) !important;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12) !important;
    border-color: rgba(0, 156, 60, 0.4) !important;
}

.vista-movil .solicitud-card .p-4:first-child {
    background: #ffffff !important;
    color: #2d3748 !important;
    padding: 24px !important;
    position: relative;
    overflow: hidden;
    border-bottom: 2px solid rgba(0, 156, 60, 0.1) !important;
}

.vista-movil .solicitud-card .text-lg {
    font-size: 20px !important;
    font-weight: 800 !important;
    color: #009c3c !important;
    text-shadow: none !important;
}

.vista-movil .solicitud-card .w-3.h-3 {
    width: 14px !important;
    height: 14px !important;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3) !important;
    animation: pulse 2s infinite !important;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.1); }
}

.vista-movil .solicitud-card .bg-red-500 {
    background: linear-gradient(45deg, #ef4444, #dc2626) !important;
}

.vista-movil .solicitud-card .bg-yellow-500 {
    background: linear-gradient(45deg, #f59e0b, #d97706) !important;
}

.vista-movil .solicitud-card .bg-green-500 {
    background: linear-gradient(45deg, #10b981, #059669) !important;
}

.vista-movil .solicitud-card .rounded-full {
    border-radius: 25px !important;
    padding: 8px 16px !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    font-size: 11px !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
}

.vista-movil .solicitud-card .bg-red-100 {
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.9), rgba(200, 35, 51, 0.9)) !important;
    color: white !important;
}

.vista-movil .solicitud-card .bg-yellow-100 {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.9), rgba(255, 179, 77, 0.9)) !important;
    color: #000 !important;
}

.vista-movil .solicitud-card .bg-green-100 {
    background: linear-gradient(135deg, rgba(0, 156, 60, 0.9), rgba(34, 166, 80, 0.9)) !important;
    color: white !important;
}

.vista-movil .solicitud-card .grid {
    background: rgba(0, 156, 60, 0.05) !important;
    border-radius: 12px !important;
    padding: 16px !important;
    border: 1px solid rgba(0, 156, 60, 0.1) !important;
    margin-top: 16px !important;
}

.vista-movil .solicitud-card .text-green-600 {
    background: linear-gradient(135deg, #10b981, #059669) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    font-weight: 800 !important;
    font-size: 16px !important;
}

.vista-movil .solicitud-card .bg-gray-50:last-child {
    background: rgba(0, 156, 60, 0.02) !important;
    border-top: 1px solid rgba(0, 156, 60, 0.1) !important;
}

.vista-movil .solicitud-card .bg-blue-600 {
    background: linear-gradient(135deg, #009c3c, #22a650) !important;
    box-shadow: 0 4px 12px rgba(0, 156, 60, 0.3) !important;
    border-radius: 12px !important;
    padding: 12px 20px !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
}

.vista-movil .solicitud-card .bg-blue-600:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 20px rgba(0, 156, 60, 0.4) !important;
}

.vista-movil .solicitud-card .bg-gray-600 {
    background: linear-gradient(135deg, #6c757d, #495057) !important;
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3) !important;
    border-radius: 12px !important;
    padding: 12px 20px !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
}

.vista-movil .solicitud-card .bg-red-600 {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3) !important;
    border-radius: 12px !important;
    padding: 12px 20px !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
}

.vista-movil .solicitud-card .text-xs {
    font-size: 12px !important;
    font-weight: 600 !important;
    color: #009c3c !important;
    text-transform: uppercase !important;
    letter-spacing: 0.8px !important;
}

.vista-movil .solicitud-card .bg-blue-100 {
    background: linear-gradient(135deg, rgba(0, 156, 60, 0.1), rgba(34, 166, 80, 0.15)) !important;
    color: #009c3c !important;
    border-radius: 20px !important;
    padding: 8px 16px !important;
    font-weight: 700 !important;
    border: 1px solid rgba(0, 156, 60, 0.3) !important;
}

.vista-movil .solicitud-card .bg-purple-100 {
    background: linear-gradient(135deg, rgba(108, 117, 125, 0.1), rgba(73, 80, 87, 0.15)) !important;
    color: #495057 !important;
    border-radius: 20px !important;
    padding: 8px 16px !important;
    font-weight: 700 !important;
    border: 1px solid rgba(108, 117, 125, 0.3) !important;
}

.vista-movil .empty-state {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0) !important;
    border-radius: 25px !important;
    border: 3px dashed #cbd5e1 !important;
    padding: 60px 30px !important;
    text-align: center !important;
}

.vista-movil .empty-state .w-16 {
    background: linear-gradient(135deg, #e2e8f0, #cbd5e1) !important;
    width: 100px !important;
    height: 100px !important;
    border-radius: 50% !important;
    margin: 0 auto 25px !important;
    animation: bounce 3s infinite !important;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
}

/* Mejoras adicionales para micro-interacciones */
.vista-movil .solicitud-card .p-4:first-child::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 50% 50%, rgba(0, 156, 60, 0.05) 0%, transparent 60%);
    animation: shimmer 4s infinite;
}

@keyframes shimmer {
    0%, 100% { opacity: 0; transform: rotate(0deg); }
    50% { opacity: 1; transform: rotate(180deg); }
}

.vista-movil .solicitud-card .menu-dropdown {
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(20px) !important;
    border-radius: 15px !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.vista-movil .solicitud-card .menu-dropdown a:hover,
.vista-movil .solicitud-card .menu-dropdown button:hover {
    background: linear-gradient(90deg, #f3f4f6, #e5e7eb) !important;
    border-radius: 10px !important;
    margin: 2px !important;
}

.vista-movil .solicitud-card .text-sm.font-semibold {
    font-size: 15px !important;
    font-weight: 700 !important;
    color: #2d3748 !important;
    text-shadow: none !important;
}

.vista-movil .solicitud-card .text-sm.font-medium {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #2d3748 !important;
}

.vista-movil .solicitud-card .text-sm.font-bold {
    color: #10b981 !important;
    font-weight: 800 !important;
    font-size: 16px !important;
}

/* Mejoras para filtros móviles */
.vista-movil .filter-btn {
    transition: all 0.3s ease !important;
    position: relative !important;
    overflow: hidden !important;
}

.vista-movil .filter-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s ease;
}

.vista-movil .filter-btn:hover::before {
    left: 100%;
}

.vista-movil .filter-btn.active {
    background: linear-gradient(135deg, #009c3c, #22a650) !important;
    color: white !important;
    border: 1px solid #009c3c !important;
    box-shadow: 0 4px 12px rgba(0, 156, 60, 0.3) !important;
}

/* Mejoras para el buscador móvil */
.vista-movil input[type="text"] {
    background: rgba(255, 255, 255, 0.9) !important;
    border: 2px solid rgba(0, 156, 60, 0.1) !important;
    border-radius: 12px !important;
    padding: 12px 16px 12px 40px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    backdrop-filter: blur(10px) !important;
    transition: all 0.3s ease !important;
}

.vista-movil input[type="text"]:focus {
    border-color: #009c3c !important;
    box-shadow: 0 0 0 3px rgba(0, 156, 60, 0.1) !important;
    background: white !important;
}

.vista-movil .relative .absolute {
    color: #4a5568 !important;
    font-size: 16px !important;
}

/* =====================================
   ESTILOS PARA NOTIFICACIONES PERSONALIZADAS
   ===================================== */
.notificacion-personalizada {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px 20px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    z-index: 9999;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.notificacion-personalizada.show {
    transform: translateX(0);
    opacity: 1;
}

.notificacion-exito {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.notificacion-error {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.notificacion-contenido {
    display: flex;
    align-items: center;
    white-space: nowrap;
}

.notificacion-personalizada i {
    font-size: 1.1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* =====================================
   ESTILOS PERSONALIZADOS PARA TOASTR
   ===================================== */

/* Estilos generales para toastr con tema Pacífico */
.toast-pacifico {
    border-radius: 12px !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    font-weight: 600 !important;
    font-size: 0.9rem !important;
    padding: 20px 24px !important;
    min-width: 320px !important;
    opacity: 0.95 !important;
}

/* Toast de éxito con gradiente verde Pacífico */
.toast-success {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
    color: white !important;
}

.toast-success .toast-progress {
    background: rgba(255, 255, 255, 0.3) !important;
}

/* Toast de error con gradiente rojo */
.toast-error {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
    color: white !important;
}

.toast-error .toast-progress {
    background: rgba(255, 255, 255, 0.3) !important;
}

/* Toast de información con gradiente azul */
.toast-info {
    background: linear-gradient(135deg, #17a2b8, #138496) !important;
    color: white !important;
}

.toast-info .toast-progress {
    background: rgba(255, 255, 255, 0.3) !important;
}

/* Toast de advertencia con gradiente amarillo */
.toast-warning {
    background: linear-gradient(135deg, #ffc107, #e0a800) !important;
    color: #212529 !important;
}

.toast-warning .toast-progress {
    background: rgba(0, 0, 0, 0.2) !important;
}

/* Botón de cerrar personalizado */
.toast-close-button {
    color: rgba(255, 255, 255, 0.8) !important;
    font-size: 16px !important;
    font-weight: bold !important;
    opacity: 0.8 !important;
    transition: all 0.2s ease !important;
}

.toast-close-button:hover {
    opacity: 1 !important;
    transform: scale(1.1) !important;
}

/* Barra de progreso personalizada */
.toast-progress {
    height: 4px !important;
    border-radius: 2px !important;
    position: absolute !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
}

/* Animaciones personalizadas */
.toast-pacifico {
    animation: toastSlideIn 0.3s ease-out !important;
}

@keyframes toastSlideIn {
    0% {
        transform: translateX(100%);
        opacity: 0;
    }
    100% {
        transform: translateX(0);
        opacity: 0.95;
    }
}

/* Estilos para el header de Negocios */
.ribbon {
    overflow: hidden;
    position: relative;
}

.ribbon-container {
    padding: 0 15px;
}

.ribbon-actions {
    white-space: nowrap;
}

.ribbon-actions .btn {
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    white-space: nowrap;
}

.ribbon-actions .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.ribbon-actions .btn-light:hover {
    background-color: #f8f9fa;
    border-color: #f8f9fa;
}

.ribbon-actions .btn-outline-light:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
}

/* Responsive para móvil */
@media (max-width: 767px) {
    .ribbon-actions {
        width: 100%;
        justify-content: center;
        margin-top: 10px;
    }
    
    .ribbon-actions .btn {
        flex: 1;
        max-width: 150px;
    }
}

/* Estilos para controles móviles */
.mobile-controls {
    background: rgba(0, 156, 60, 0.02);
    border-radius: 12px;
    padding: 12px;
    border: 1px solid rgba(0, 156, 60, 0.1);
}

.toggle-btn {
    border-color: #009c3c !important;
    color: #009c3c !important;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.toggle-btn:hover {
    background-color: #009c3c !important;
    color: white !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 156, 60, 0.3);
}

.toggle-btn.collapsed {
    background-color: #f8f9fa !important;
    color: #6c757d !important;
    border-color: #dee2e6 !important;
}

.toggle-btn.collapsed:hover {
    background-color: #009c3c !important;
    color: white !important;
    border-color: #009c3c !important;
}

/* Estilo especial para toggle en header de filtros */
.card-header-custom .toggle-btn {
    background-color: rgba(255, 255, 255, 0.9) !important;
    color: #009c3c !important;
    border-color: rgba(255, 255, 255, 0.9) !important;
    font-weight: 600;
}

.card-header-custom .toggle-btn:hover {
    background-color: white !important;
    color: #007529 !important;
    border-color: white !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.card-header-custom .toggle-btn.collapsed {
    background-color: rgba(255, 255, 255, 0.7) !important;
    color: #6c757d !important;
    border-color: rgba(255, 255, 255, 0.7) !important;
}

.card-header-custom .toggle-btn.collapsed:hover {
    background-color: white !important;
    color: #009c3c !important;
    border-color: white !important;
}

/* Contenidos colapsables */
.kpis-content, .filters-content {
    transition: all 0.4s ease;
    overflow: hidden;
    opacity: 1;
    max-height: 2000px;
}

.kpis-content.collapsed, .filters-content.collapsed {
    opacity: 0;
    max-height: 0;
    margin: 0;
    padding: 0;
    transform: translateY(-10px);
}

/* Solo en móvil mostrar controles */
@media (min-width: 576px) {
    .mobile-controls {
        display: none !important;
    }
}

/* Animaciones de entrada */
.vista-movil .solicitud-card {
    animation: fadeInUp 0.5s ease-out !important;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-20px);
    }
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideOutUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-30px);
    }
}

@keyframes ripple {
    to {
        transform: scale(4);
        opacity: 0;
    }
}

/* Mejoras para paginación móvil */
.vista-movil nav a,
.vista-movil nav span {
    background: rgba(255, 255, 255, 0.9) !important;
    border: 1px solid rgba(0, 156, 60, 0.2) !important;
    border-radius: 12px !important;
    padding: 12px 16px !important;
    font-weight: 600 !important;
    color: #2d3748 !important;
    backdrop-filter: blur(10px) !important;
    transition: all 0.3s ease !important;
}

.vista-movil nav a:hover {
    background: linear-gradient(135deg, #009c3c, #22a650) !important;
    color: white !important;
    border-color: #009c3c !important;
    box-shadow: 0 4px 12px rgba(0, 156, 60, 0.3) !important;
    transform: translateY(-2px) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Manejar edición de etiquetas con select
  document.querySelectorAll('.etiquetas-select').forEach(function(select) {
    select.addEventListener('change', function(e) {
      const solicitudId = e.target.dataset.id;
      const nuevaEtiqueta = e.target.value;
      
      e.target.disabled = true;
      
      fetch(`/workflow/api/solicitudes/${solicitudId}/actualizar-etiquetas/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ etiquetas_oficial: nuevaEtiqueta })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          e.target.style.borderColor = '#22c55e';
          setTimeout(() => {
            e.target.style.borderColor = '';
          }, 1000);
        } else {
          e.target.style.borderColor = '#ef4444';
          alert(data.error || 'Error al guardar etiqueta');
        }
      })
      .catch(error => {
        e.target.style.borderColor = '#ef4444';
        alert('Error de conexión');
      })
      .finally(() => {
        e.target.disabled = false;
      });
    });
  });

  // Manejar edición de prioridad
  document.querySelectorAll('.prioridad-select').forEach(function(select) {
    select.addEventListener('change', function(e) {
      const solicitudId = e.target.dataset.id;
      const nuevaPrioridad = e.target.value;
      fetch(`/workflow/api/solicitudes/${solicitudId}/actualizar-prioridad/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ prioridad: nuevaPrioridad })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Cambia color del fondo según la prioridad seleccionada
          if (nuevaPrioridad === 'Alta') {
            e.target.style.backgroundColor = '#fee2e2';
            e.target.style.color = '#b91c1c';
          } else if (nuevaPrioridad === 'Media') {
            e.target.style.backgroundColor = '#fef9c3';
            e.target.style.color = '#b45309';
          } else if (nuevaPrioridad === 'Baja') {
            e.target.style.backgroundColor = '#dcfce7';
            e.target.style.color = '#166534';
          } else {
            e.target.style.backgroundColor = 'white';
            e.target.style.color = '#333';
          }
        } else {
          alert(data.error || 'Error al guardar prioridad');
        }
      });
    });
  });
});
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

<!-- JavaScript para Vista Móvil -->
<script>
// Funcionalidad mejorada para vista móvil
document.addEventListener('DOMContentLoaded', function() {
    // Animaciones de entrada escalonadas
    const cards = document.querySelectorAll('.vista-movil .solicitud-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });

    // Búsqueda móvil mejorada con debounce
    const busquedaMovil = document.getElementById('busquedaMovil');
    if (busquedaMovil) {
        let searchTimeout;
        
        busquedaMovil.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const searchTerm = this.value.toLowerCase();
            
            searchTimeout = setTimeout(() => {
                const cards = document.querySelectorAll('.solicitud-card');
                let visibleCount = 0;
                
                cards.forEach((card, index) => {
                    const searchData = card.getAttribute('data-search');
                    const isVisible = searchData && searchData.includes(searchTerm);
                    
                    if (isVisible) {
                        card.style.display = 'block';
                        card.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s both`;
                        visibleCount++;
                    } else {
                        card.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => {
                            card.style.display = 'none';
                        }, 300);
                    }
                });
                
                // Mostrar mensaje mejorado si no hay resultados
                const noResultsMsg = document.getElementById('noResultsMessage');
                
                if (visibleCount === 0 && searchTerm !== '') {
                    if (!noResultsMsg) {
                        const container = document.getElementById('solicitudesMovil');
                        const msg = document.createElement('div');
                        msg.id = 'noResultsMessage';
                        msg.className = 'empty-state';
                        msg.style.animation = 'fadeInUp 0.5s ease-out';
                        msg.innerHTML = `
                            <div class="empty-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <h3 class="empty-title">Sin resultados para "${searchTerm}"</h3>
                            <p class="empty-subtitle">Intenta con otros términos de búsqueda o revisa los filtros aplicados.</p>
                            <div class="empty-decoration">
                                <div class="decoration-dot"></div>
                                <div class="decoration-dot"></div>
                                <div class="decoration-dot"></div>
                            </div>
                        `;
                        container.appendChild(msg);
                    }
                } else if (noResultsMsg) {
                    noResultsMsg.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => noResultsMsg.remove(), 300);
                }
            }, 300);
        });
        
        // Efecto de foco mejorado
        busquedaMovil.addEventListener('focus', function() {
            this.parentElement.style.transform = 'scale(1.02)';
            this.parentElement.style.boxShadow = '0 8px 25px rgba(0, 156, 60, 0.15)';
        });
        
        busquedaMovil.addEventListener('blur', function() {
            this.parentElement.style.transform = 'scale(1)';
            this.parentElement.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.05)';
        });
    }
    
    // Filtros rápidos móvil mejorados
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Efecto de ripple
            const ripple = document.createElement('span');
            ripple.style.cssText = `
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.6);
                transform: scale(0);
                animation: ripple 0.6s linear;
                width: 20px;
                height: 20px;
                left: 50%;
                top: 50%;
                margin-left: -10px;
                margin-top: -10px;
            `;
            this.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
            
            // Remover clase activa de todos los botones con animación
            filterBtns.forEach(b => {
                b.classList.remove('active');
                b.style.transform = 'scale(1)';
            });
            
            // Agregar clase activa al botón clickeado con animación
            this.classList.add('active');
            this.style.transform = 'scale(1.05)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
            
            const filter = this.getAttribute('data-filter');
            const cards = document.querySelectorAll('.solicitud-card');
            let visibleCount = 0;
            
            cards.forEach((card, index) => {
                let show = false;
                
                switch(filter) {
                    case 'todos':
                        show = true;
                        break;
                    case 'alta':
                        show = card.getAttribute('data-prioridad') === 'alta';
                        break;
                    case 'vencidas':
                        show = card.getAttribute('data-estado') === 'text-danger';
                        break;
                    case 'sin_asignar':
                        show = card.getAttribute('data-asignado') === 'sin_asignar';
                        break;
                }
                
                if (show) {
                    card.style.display = 'block';
                    card.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s both`;
                    visibleCount++;
                } else {
                    card.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => {
                        card.style.display = 'none';
                    }, 300);
                }
            });
            
            // Mostrar contador de resultados
            setTimeout(() => {
                const activeFilter = this.textContent.trim();
                showFilterResults(visibleCount, activeFilter);
            }, 500);
        });
    });
    
    // Función para mostrar resultados de filtro
    function showFilterResults(count, filterName) {
        // Remover mensaje anterior si existe
        const existingMsg = document.querySelector('.filter-results-msg');
        if (existingMsg) existingMsg.remove();
        
        if (count === 0) return;
        
        const container = document.getElementById('solicitudesMovil');
        const msg = document.createElement('div');
        msg.className = 'filter-results-msg';
        msg.style.cssText = `
            background: linear-gradient(135deg, rgba(0, 156, 60, 0.1), rgba(34, 166, 80, 0.15));
            color: #009c3c;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid rgba(0, 156, 60, 0.3);
            animation: slideInDown 0.5s ease-out;
        `;
        msg.innerHTML = `
            <i class="fas fa-filter" style="margin-right: 8px;"></i>
            ${count} solicitud${count !== 1 ? 'es' : ''} ${filterName.toLowerCase()}
        `;
        
        container.insertBefore(msg, container.firstChild);
        
        // Auto-remover después de 3 segundos
        setTimeout(() => {
            if (msg.parentNode) {
                msg.style.animation = 'slideOutUp 0.3s ease-out';
                setTimeout(() => msg.remove(), 300);
            }
        }, 3000);
    }
});

// Función para toggle de menús desplegables
function toggleMenu(button) {
    const menu = button.nextElementSibling;
    const allMenus = document.querySelectorAll('.menu-dropdown');
    
    // Cerrar todos los otros menús
    allMenus.forEach(m => {
        if (m !== menu) {
            m.classList.add('hidden');
        }
    });
    
    // Toggle del menú actual
    menu.classList.toggle('hidden');
    
    // Cerrar menú al hacer click fuera
    if (!menu.classList.contains('hidden')) {
        document.addEventListener('click', function closeMenu(e) {
            if (!button.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeMenu);
            }
        });
    }
}

// Función para eliminar solicitud (reutilizada)
function eliminarSolicitud(id) {
    mostrarModalConfirmacion('Eliminar Solicitud', function() {
        // CALLBACK DE CONFIRMACIÓN PARA ELIMINAR
        console.log('✅ Confirmado eliminar solicitud:', id);
        
        fetch(`/workflow/api/solicitudes/${id}/eliminar/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
        .then(response => {
            if (response.ok) {
                if (typeof toastr !== 'undefined') {
                    toastr.success('Solicitud eliminada exitosamente');
                } else {
                    mostrarNotificacionExito('Solicitud eliminada exitosamente');
                }
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                if (typeof toastr !== 'undefined') {
                    toastr.error('Error al eliminar la solicitud');
                } else {
                    mostrarNotificacionError('Error al eliminar la solicitud');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (typeof toastr !== 'undefined') {
                toastr.error('Error al eliminar la solicitud');
            } else {
                mostrarNotificacionError('Error al eliminar la solicitud');
            }
        });
    }, function() {
        // CALLBACK DE CANCELACIÓN
        console.log('❌ Cancelada eliminación de solicitud');
    });
}

// Función para toggle de secciones móviles
function toggleSection(sectionId) {
    let content, toggleBtn;
    
    if (sectionId === 'kpis-section') {
        content = document.querySelector('.kpis-content');
        toggleBtn = document.getElementById('toggle-kpis');
    } else if (sectionId === 'filters-section') {
        content = document.querySelector('.filters-content');
        toggleBtn = document.getElementById('toggle-filters');
    }
    
    const toggleText = toggleBtn.querySelector('.toggle-text');
    const icon = toggleBtn.querySelector('i');
    
    if (content && toggleBtn) {
        if (content.classList.contains('collapsed')) {
            // Mostrar contenido
            content.classList.remove('collapsed');
            toggleBtn.classList.remove('collapsed');
            
            if (sectionId === 'kpis-section') {
                toggleText.textContent = 'Ocultar KPIs';
                icon.className = 'fas fa-chart-bar me-1';
            } else if (sectionId === 'filters-section') {
                toggleText.textContent = 'Ocultar Filtros';
                icon.className = 'fas fa-filter me-1';
            }
        } else {
            // Ocultar contenido
            content.classList.add('collapsed');
            toggleBtn.classList.add('collapsed');
            
            if (sectionId === 'kpis-section') {
                toggleText.textContent = 'Mostrar KPIs';
                icon.className = 'fas fa-chart-bar me-1';
            } else if (sectionId === 'filters-section') {
                toggleText.textContent = 'Mostrar Filtros';
                icon.className = 'fas fa-filter me-1';
            }
        }
        
        // Guardar estado en localStorage
        localStorage.setItem(sectionId + '_collapsed', content.classList.contains('collapsed'));
    }
}

// Restaurar estado de secciones al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    ['kpis-section', 'filters-section'].forEach(sectionId => {
        const isCollapsed = localStorage.getItem(sectionId + '_collapsed') === 'true';
        if (isCollapsed) {
            // Aplicar estado colapsado directamente sin animación
            let content, toggleBtn;
            
            if (sectionId === 'kpis-section') {
                content = document.querySelector('.kpis-content');
                toggleBtn = document.getElementById('toggle-kpis');
            } else if (sectionId === 'filters-section') {
                content = document.querySelector('.filters-content');
                toggleBtn = document.getElementById('toggle-filters');
            }
            
            if (content && toggleBtn) {
                content.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                
                const toggleText = toggleBtn.querySelector('.toggle-text');
                const icon = toggleBtn.querySelector('i');
                
                if (sectionId === 'kpis-section') {
                    toggleText.textContent = 'Mostrar KPIs';
                } else if (sectionId === 'filters-section') {
                    toggleText.textContent = 'Mostrar Filtros';
                }
            }
        }
    });
    
    // ============================================
    // FUNCIONALIDAD KANBAN
    // ============================================
    
    // Configurar filtros Kanban
    function configurarFiltrosKanban() {
        if ($('#kanbanFiltroCliente').length === 0) return; // Solo si estamos en vista Kanban
        
        console.log('Configurando filtros Kanban...');
        
        // Obtener valores únicos de todas las tarjetas
        var clientes = new Set();
        var estados = new Set();
        var asignados = new Set();
        var slas = new Set();
        
        $('.kanban-card').each(function() {
            var $card = $(this);
            
            var cliente = $card.attr('data-cliente');
            var estado = $card.attr('data-estado');
            var asignado = $card.attr('data-asignado');
            var sla = $card.attr('data-sla');
            
            if (cliente && cliente !== 'Sin cliente') clientes.add(cliente);
            if (estado && estado !== 'Sin estado') estados.add(estado);
            if (asignado && asignado !== 'Sin asignar') asignados.add(asignado);
            if (sla && sla !== 'sin sla') slas.add(sla);
        });
        
        // Poblar filtros
        var $filtroCliente = $('#kanbanFiltroCliente');
        var $filtroEstado = $('#kanbanFiltroEstado');
        var $filtroAsignado = $('#kanbanFiltroAsignado');
        var $filtroSLA = $('#kanbanFiltroSLA');
        
        // Limpiar opciones existentes (excepto la primera)
        $filtroCliente.find('option:not(:first)').remove();
        $filtroEstado.find('option:not(:first)').remove();
        $filtroAsignado.find('option:not(:first)').remove();
        $filtroSLA.find('option:not(:first)').remove();
        
        // Agregar nuevas opciones
        Array.from(clientes).sort().forEach(function(cliente) {
            $filtroCliente.append(`<option value="${cliente}">${cliente}</option>`);
        });
        
        Array.from(estados).sort().forEach(function(estado) {
            $filtroEstado.append(`<option value="${estado}">${estado}</option>`);
        });
        
        Array.from(asignados).sort().forEach(function(asignado) {
            $filtroAsignado.append(`<option value="${asignado}">${asignado}</option>`);
        });
        
        Array.from(slas).sort().forEach(function(sla) {
            var texto = sla === 'vencido' ? 'Vencido' : 
                       sla === 'por vencer' ? 'Por vencer' : 
                       sla === 'en tiempo' ? 'En tiempo' : sla;
            $filtroSLA.append(`<option value="${sla}">${texto}</option>`);
        });
        
        console.log('Filtros Kanban configurados:', {
            clientes: clientes.size,
            estados: estados.size,
            asignados: asignados.size,
            slas: slas.size
        });
        
        // Actualizar contadores
        actualizarContadoresKanban();
    }
    
    // Aplicar filtros Kanban
    function aplicarFiltrosKanban() {
        if ($('.kanban-card').length === 0) return;
        
        var filtroCliente = $('#kanbanFiltroCliente').val();
        var filtroEstado = $('#kanbanFiltroEstado').val();
        var filtroAsignado = $('#kanbanFiltroAsignado').val();
        var filtroSLA = $('#kanbanFiltroSLA').val();
        var busquedaGlobal = $('#kanbanBusquedaGlobal').val().toLowerCase();
        
        $('.kanban-card').each(function() {
            var $card = $(this);
            var mostrar = true;
            
            // Filtro cliente
            if (filtroCliente && $card.attr('data-cliente') !== filtroCliente) {
                mostrar = false;
            }
            
            // Filtro estado
            if (filtroEstado && $card.attr('data-estado') !== filtroEstado) {
                mostrar = false;
            }
            
            // Filtro asignado
            if (filtroAsignado && $card.attr('data-asignado') !== filtroAsignado) {
                mostrar = false;
            }
            
            // Filtro SLA
            if (filtroSLA && $card.attr('data-sla') !== filtroSLA) {
                mostrar = false;
            }
            
            // Búsqueda global
            if (busquedaGlobal && !$card.attr('data-search').includes(busquedaGlobal)) {
                mostrar = false;
            }
            
            $card.toggle(mostrar);
        });
        
        // Actualizar contadores y mostrar mensajes cuando no hay solicitudes
        actualizarContadoresKanban();
        mostrarMensajesVacios();
    }
    
    // Actualizar contadores de etapas
    function actualizarContadoresKanban() {
        $('.kanban-column').each(function() {
            var $column = $(this);
            var etapaId = $column.find('.kanban-column-body').attr('data-etapa-id');
            var count = $column.find('.kanban-card:visible').length;
            $('#count-etapa-' + etapaId).text(count);
        });
    }
    
    // Mostrar mensajes cuando no hay solicitudes visibles
    function mostrarMensajesVacios() {
        $('.kanban-column-body').each(function() {
            var $body = $(this);
            var hasVisible = $body.find('.kanban-card:visible').length > 0;
            $body.find('.no-solicitudes').toggle(!hasVisible);
        });
    }
    
    // Búsqueda por etapa
    $('.etapa-search').on('input', function() {
        var $input = $(this);
        var etapaId = $input.attr('data-etapa-id');
        var searchTerm = $input.val().toLowerCase();
        
        $('.kanban-column-body[data-etapa-id="' + etapaId + '"] .kanban-card').each(function() {
            var $card = $(this);
            var searchData = $card.attr('data-search');
            var shouldShow = !searchTerm || searchData.includes(searchTerm);
            $card.toggle(shouldShow);
        });
        
        actualizarContadoresKanban();
        mostrarMensajesVacios();
    });
    
    // Event listeners para filtros Kanban
    $('#kanbanFiltroCliente, #kanbanFiltroEstado, #kanbanFiltroAsignado, #kanbanFiltroSLA').on('change', aplicarFiltrosKanban);
    $('#kanbanBusquedaGlobal').on('input', aplicarFiltrosKanban);
    
    // Limpiar filtros Kanban
    $('#kanbanLimpiarFiltros').on('click', function() {
        $('#kanbanFiltroCliente, #kanbanFiltroEstado, #kanbanFiltroAsignado, #kanbanFiltroSLA').val('');
        $('#kanbanBusquedaGlobal').val('');
        $('.etapa-search').val('');
        $('.kanban-card').show();
        actualizarContadoresKanban();
        mostrarMensajesVacios();
    });
    
    // Cambio de etapa desde dropdown en Kanban
    $(document).on('click', '.cambiar-etapa-kanban', function(e) {
        e.preventDefault();
        
        var $link = $(this);
        var solicitudId = $link.data('solicitud-id');
        var etapaId = $link.data('etapa-id');
        var etapaNombre = $link.data('etapa-nombre');
        
        // Confirmar cambio con modal personalizado
        mostrarModalConfirmacion(etapaNombre, function() {
            // Función que se ejecuta al confirmar - AJAX directo para Kanban
            console.log('Ejecutando cambio de etapa Kanban:', solicitudId, etapaId);
            
            // Realizar petición AJAX para cambiar etapa
            $.ajax({
                url: `/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                data: JSON.stringify({
                    etapa_id: etapaId
                }),
                contentType: 'application/json',
                success: function(response) {
                    console.log('Respuesta del servidor Kanban:', response);
                    if (response.success) {
                        // Mostrar mensaje de éxito
                        if (typeof toastr !== 'undefined') {
                            toastr.success(response.mensaje || 'Etapa cambiada exitosamente');
                        } else {
                            alert('Etapa cambiada exitosamente');
                        }
                        
                        // Recargar la página para mostrar cambios
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        alert('Error: ' + (response.error || 'No se pudo cambiar la etapa'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error AJAX Kanban:', xhr, status, error);
                    var errorMsg = 'Error al cambiar etapa';
                    try {
                        var response = JSON.parse(xhr.responseText);
                        errorMsg = response.error || errorMsg;
                    } catch(e) {
                        errorMsg = 'Error de conexión';
                    }
                    
                    alert(errorMsg);
                }
            });
        });
        return;
    });
    
    function realizarCambioEtapaKanban(solicitudId, etapaId, etapaNombre) {
        console.log('🔄 KANBAN: Iniciando cambio de etapa', {
            solicitudId: solicitudId,
            etapaId: etapaId,
            etapaNombre: etapaNombre
        });
        
        // Agregar indicador visual de carga
        var $card = $(`.kanban-card[data-solicitud-id="${solicitudId}"]`);
        $card.addClass('updating').css('opacity', '0.6');
        
        // Realizar petición AJAX
        $.ajax({
            url: `/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            data: JSON.stringify({
                etapa_id: etapaId
            }),
            contentType: 'application/json',
            success: function(response) {
                console.log('✅ KANBAN: Respuesta exitosa del servidor', response);
                
                if (response.success) {
                    // Mostrar toast de éxito
                    if (typeof toastr !== 'undefined') {
                        toastr.success(response.mensaje || `Solicitud movida a ${etapaNombre}`, 'Etapa Actualizada', {
                            positionClass: 'toast-top-right',
                            timeOut: 3000,
                            showMethod: 'slideDown',
                            hideMethod: 'slideUp'
                        });
                    } else {
                        mostrarNotificacionExito(response.mensaje || `Solicitud movida a ${etapaNombre}`);
                    }
                    
                    console.log('🔄 KANBAN: Actualizando vista...');
                    
                    // Animar movimiento de tarjeta
                    $card.fadeOut(300, function() {
                        // Mover la tarjeta a la nueva columna
                        var $nuevaColumna = $(`.kanban-column-body[data-etapa-id="${etapaId}"]`);
                        
                        // Actualizar atributos de la tarjeta
                        $card.attr('data-etapa-id', etapaId);
                        
                        // Mover físicamente la tarjeta
                        $card.appendTo($nuevaColumna);
                        
                        // Restablecer opacidad y animar aparición
                        $card.css('opacity', '1').removeClass('updating').fadeIn(300);
                        
                        // Actualizar contadores
                        actualizarContadoresKanban();
                        
                        console.log('✅ KANBAN: Vista actualizada correctamente');
                    });
                    
                    // Sincronizar con otras vistas
                    sincronizarCambioEtapa(solicitudId, etapaId, response);
                    
                } else {
                    console.error('❌ KANBAN: Error en respuesta del servidor', response.error);
                    
                    // Mostrar toast de error
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.error || 'Error desconocido', 'Error al Cambiar Etapa', {
                            positionClass: 'toast-top-right',
                            timeOut: 5000
                        });
                    } else {
                        mostrarNotificacionError(response.error || 'Error al cambiar etapa');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('❌ KANBAN: Error AJAX', {
                    status: status,
                    error: error,
                    response: xhr.responseText
                });
                
                var errorMsg = 'Error al cambiar etapa';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.error || errorMsg;
                } catch(e) {
                    errorMsg = 'Error de conexión con el servidor';
                }
                
                // Mostrar toast de error
                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMsg, 'Error de Conexión', {
                        positionClass: 'toast-top-right',
                        timeOut: 5000
                    });
                } else {
                    mostrarNotificacionError(errorMsg);
                }
            },
            complete: function() {
                // Asegurar que se remueva el indicador de carga
                $card.removeClass('updating').css('opacity', '1');
                console.log('🏁 KANBAN: Petición completada');
            }
        });
    }
    
    // Inicializar filtros Kanban cuando la página esté lista
    if ($('#kanbanFiltroCliente').length > 0) {
        configurarFiltrosKanban();
        inicializarDragAndDrop();
    }
    
    // ============================================
    // DRAG & DROP FUNCIONALIDAD
    // ============================================
    
    function inicializarDragAndDrop() {
        // Configurar eventos de drag para las tarjetas
        $('.kanban-card').on('dragstart', function(e) {
            var solicitudId = $(this).attr('data-solicitud-id');
            var etapaActual = $(this).attr('data-etapa-id');
            
            e.originalEvent.dataTransfer.setData('text/plain', JSON.stringify({
                solicitudId: solicitudId,
                etapaActual: etapaActual
            }));
            
            $(this).addClass('dragging');
            
            // Agregar efecto visual a las zonas de drop
            $('.kanban-column-body').addClass('drop-zone-active');
        });
        
        $('.kanban-card').on('dragend', function(e) {
            $(this).removeClass('dragging');
            $('.kanban-column-body').removeClass('drop-zone-active');
        });
        
        // Configurar eventos de drop para las columnas
        $('.kanban-column-body').on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('drop-zone-hover');
        });
        
        $('.kanban-column-body').on('dragleave', function(e) {
            $(this).removeClass('drop-zone-hover');
        });
        
        $('.kanban-column-body').on('drop', function(e) {
            e.preventDefault();
            
            var $dropZone = $(this);
            var nuevaEtapaId = $dropZone.attr('data-etapa-id');
            
            // Remover clases de hover
            $dropZone.removeClass('drop-zone-hover drop-zone-active');
            $('.kanban-column-body').removeClass('drop-zone-active');
            
            try {
                var data = JSON.parse(e.originalEvent.dataTransfer.getData('text/plain'));
                var solicitudId = data.solicitudId;
                var etapaActual = data.etapaActual;
                
                // Verificar si es un movimiento válido
                if (nuevaEtapaId === etapaActual) {
                    console.log('Movimiento cancelado: misma etapa');
                    return;
                }
                
                // Obtener nombre de la nueva etapa
                var nuevaEtapaNombre = $dropZone.closest('.kanban-column').find('.card-header-custom h6').text().trim();
                nuevaEtapaNombre = nuevaEtapaNombre.replace(/\d+$/, '').trim(); // Remover contador
                
                // Confirmar movimiento con modal personalizado
                mostrarModalConfirmacion(nuevaEtapaNombre, function() {
                    // Función que se ejecuta al confirmar - AJAX directo para Drag & Drop
                    console.log('Ejecutando cambio de etapa Drag & Drop:', solicitudId, nuevaEtapaId);
                    
                    // Realizar petición AJAX para cambiar etapa
                    $.ajax({
                        url: `/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`,
                        type: 'POST',
                        headers: {
                            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                        },
                        data: JSON.stringify({
                            etapa_id: nuevaEtapaId
                        }),
                        contentType: 'application/json',
                        success: function(response) {
                            console.log('✅ DRAG & DROP: Respuesta exitosa del servidor', response);
                            if (response.success) {
                                // Mostrar toast de éxito con configuración específica
                                if (typeof toastr !== 'undefined') {
                                    toastr.success(response.mensaje || `Solicitud movida a ${nuevaEtapaNombre}`, 'Movimiento Completado', {
                                        positionClass: 'toast-top-right',
                                        timeOut: 3000,
                                        showMethod: 'fadeIn',
                                        hideMethod: 'fadeOut',
                                        iconClass: 'toast-success-custom'
                                    });
                                } else {
                                    mostrarNotificacionExito(response.mensaje || `Solicitud movida a ${nuevaEtapaNombre}`);
                                }
                                
                                console.log('🔄 DRAG & DROP: Actualizando kanban sin recargar página completa...');
                                
                                // Actualizar la vista kanban dinámicamente sin recargar
                                actualizarKanbanTrasMovimiento(solicitudId, nuevaEtapaId, nuevaEtapaNombre);
                                
                            } else {
                                console.error('❌ DRAG & DROP: Error en respuesta', response.error);
                                
                                // Mostrar toast de error
                                if (typeof toastr !== 'undefined') {
                                    toastr.error(response.error || 'No se pudo cambiar la etapa', 'Error en Movimiento', {
                                        positionClass: 'toast-top-right',
                                        timeOut: 5000
                                    });
                                } else {
                                    mostrarNotificacionError(response.error || 'No se pudo cambiar la etapa');
                                }
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('❌ DRAG & DROP: Error AJAX', {
                                status: status,
                                error: error,
                                response: xhr.responseText,
                                solicitudId: solicitudId,
                                nuevaEtapaId: nuevaEtapaId
                            });
                            
                            var errorMsg = 'Error al cambiar etapa';
                            try {
                                var response = JSON.parse(xhr.responseText);
                                errorMsg = response.error || errorMsg;
                            } catch(e) {
                                errorMsg = 'Error de conexión con el servidor';
                            }
                            
                            // Mostrar toast de error con más detalles
                            if (typeof toastr !== 'undefined') {
                                toastr.error(errorMsg, 'Error de Conexión', {
                                    positionClass: 'toast-top-right',
                                    timeOut: 6000,
                                    extendedTimeOut: 2000
                                });
                            } else {
                                mostrarNotificacionError(errorMsg);
                            }
                        }
                    });
                });
                return;
                
            } catch (error) {
                console.error('Error al procesar drop:', error);
            }
        });
    }
    
    function realizarCambioEtapaDragDrop(solicitudId, nuevaEtapaId, etapaNombre) {
        console.log('🔄 DRAG DROP (Función): Iniciando cambio de etapa', {
            solicitudId: solicitudId,
            nuevaEtapaId: nuevaEtapaId,
            etapaNombre: etapaNombre
        });
        
        var $card = $(`.kanban-card[data-solicitud-id="${solicitudId}"]`);
        
        // Agregar indicador de carga visual
        $card.addClass('updating').css('opacity', '0.7');
        
        $.ajax({
            url: `/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            data: JSON.stringify({
                etapa_id: nuevaEtapaId
            }),
            contentType: 'application/json',
            success: function(response) {
                console.log('✅ DRAG DROP (Función): Respuesta exitosa', response);
                
                if (response.success) {
                    // Mostrar toast de éxito
                    if (typeof toastr !== 'undefined') {
                        toastr.success(response.mensaje || `Solicitud movida a ${etapaNombre}`, 'Arrastre Completado', {
                            positionClass: 'toast-top-right',
                            timeOut: 3000,
                            showMethod: 'slideDown'
                        });
                    } else {
                        mostrarNotificacionExito(`Solicitud movida a ${etapaNombre}`);
                    }
                    
                    // Animar movimiento de tarjeta
                    $card.fadeOut(200, function() {
                        // Mover la tarjeta a la nueva columna
                        var $nuevaColumna = $(`.kanban-column-body[data-etapa-id="${nuevaEtapaId}"]`);
                        
                        // Actualizar atributos de la tarjeta
                        $card.attr('data-etapa-id', nuevaEtapaId);
                        
                        // Mover físicamente la tarjeta
                        $card.appendTo($nuevaColumna);
                        
                        // Restablecer estilos y animar aparición
                        $card.css('opacity', '1').removeClass('updating').fadeIn(300);
                        
                        // Actualizar contadores
                        actualizarContadoresKanban();
                        
                        console.log('✅ DRAG DROP (Función): Tarjeta movida y vista actualizada');
                    });
                    
                    // Sincronizar con otras vistas
                    sincronizarCambioEtapa(solicitudId, nuevaEtapaId, response);
                    
                } else {
                    console.error('❌ DRAG DROP (Función): Error en respuesta', response.error);
                    
                    // Mostrar toast de error
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.error || 'Error desconocido', 'Error en Arrastre', {
                            positionClass: 'toast-top-right',
                            timeOut: 5000
                        });
                    } else {
                        mostrarNotificacionError(response.error || 'Error al cambiar etapa');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('❌ DRAG DROP (Función): Error AJAX', {
                    status: status,
                    error: error,
                    response: xhr.responseText
                });
                
                var errorMsg = 'Error al cambiar etapa';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.error || errorMsg;
                } catch(e) {
                    errorMsg = 'Error de conexión';
                }
                
                // Mostrar toast de error
                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMsg, 'Error de Conexión', {
                        positionClass: 'toast-top-right',
                        timeOut: 5000
                    });
                } else {
                    mostrarNotificacionError(errorMsg);
                }
            },
            complete: function() {
                // Asegurar que se remueva el indicador de carga
                $card.removeClass('updating').css('opacity', '1');
                console.log('🏁 DRAG DROP (Función): Petición completada');
            }
        });
    }
    
    // Nueva función para actualizar kanban tras movimiento sin recargar página
    function actualizarKanbanTrasMovimiento(solicitudId, nuevaEtapaId, etapaNombre) {
        console.log('🔄 Actualizando kanban tras movimiento', {
            solicitudId: solicitudId,
            nuevaEtapaId: nuevaEtapaId,
            etapaNombre: etapaNombre
        });
        
        var $card = $(`.kanban-card[data-solicitud-id="${solicitudId}"]`);
        var $nuevaColumna = $(`.kanban-column-body[data-etapa-id="${nuevaEtapaId}"]`);
        
        if ($card.length && $nuevaColumna.length) {
            // Animar movimiento suave
            $card.fadeOut(300, function() {
                // Actualizar atributos
                $card.attr('data-etapa-id', nuevaEtapaId);
                
                // Mover a nueva columna
                $card.appendTo($nuevaColumna);
                
                // Mostrar con animación
                $card.fadeIn(400);
                
                // Actualizar contadores
                if (typeof actualizarContadoresKanban === 'function') {
                    actualizarContadoresKanban();
                }
                
                console.log('✅ Kanban actualizado dinámicamente');
            });
        } else {
            console.warn('⚠️ No se pudo encontrar la tarjeta o columna para actualizar');
            // Fallback: recargar página después de un breve delay
            setTimeout(() => {
                console.log('🔄 Recargando página como fallback...');
                location.reload();
            }, 1500);
        }
    }
    
    function mostrarNotificacionExito(mensaje) {
        // Crear notificación flotante
        var $notificacion = $(`
            <div class="drag-notification">
                <i class="fas fa-check-circle me-2"></i>
                ${mensaje}
            </div>
        `);
        
        $('body').append($notificacion);
        
        // Animar entrada
        setTimeout(() => {
            $notificacion.addClass('show');
        }, 100);
        
        // Auto-remover después de 3 segundos
        setTimeout(() => {
            $notificacion.removeClass('show');
            setTimeout(() => $notificacion.remove(), 300);
        }, 3000);
    }
    
    // 🏗️ SISTEMA DE SINCRONIZACIÓN CON OTRAS VISTAS
    function sincronizarCambioEtapa(solicitudId, nuevaEtapaId, response) {
        // Comunicación entre pestañas/ventanas usando BroadcastChannel
        if ('BroadcastChannel' in window) {
            if (!window.workflowChannel) {
                window.workflowChannel = new BroadcastChannel('workflow-sync');
            }
            
            // Crear notificación de cambio de etapa
            const notification = {
                type: 'solicitud_cambio_etapa',
                data: {
                    solicitud_id: solicitudId,
                    codigo: response.codigo || 'N/A',
                    etapa_actual: {
                        id: nuevaEtapaId,
                        nombre: response.nueva_etapa.nombre
                    },
                    etapa_anterior: response.etapa_anterior,
                    user_action: {
                        username: 'current_user'
                    },
                    timestamp: new Date().toISOString()
                }
            };
            
            // Enviar notificación a otras pestañas
            window.workflowChannel.postMessage({
                type: 'sync_solicitud',
                notification: notification,
                source: 'tabla-kanban',
                timestamp: new Date().toISOString()
            });
        }
        
        // También usar localStorage como respaldo
        localStorage.setItem('workflow_last_sync', JSON.stringify({
            notification: {
                type: 'solicitud_cambio_etapa',
                data: {
                    solicitud_id: solicitudId,
                    etapa_actual: { id: nuevaEtapaId }
                }
            },
            timestamp: new Date().toISOString()
        }));
    }
    
         // 🚀 SISTEMA DE POLLING PARA TABLA/KANBAN
     let lastUpdateCheckTabla = new Date().toISOString();
     let isPollingActiveTabla = true;
     
     function iniciarPollingTablaKanban() {
         console.log('🔄 Iniciando polling para tabla/kanban cada 30 segundos');
         
         setInterval(function() {
             if (isPollingActiveTabla && !document.hidden) {
                 verificarActualizacionesTablaKanban();
             }
         }, 30000); // 30 segundos
     }
     
     function verificarActualizacionesTablaKanban() {
         const currentView = $('.workflow-table').length > 0 ? 'tabla' : 'kanban';
         
         fetch(`/workflow/api/check-updates/?last_check=${lastUpdateCheckTabla}&view=${currentView}`, {
             method: 'GET',
             headers: {
                 'Content-Type': 'application/json',
                 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
             }
         })
         .then(response => response.json())
         .then(data => {
             if (data.success && data.has_updates) {
                 console.log('📡 Cambios detectados en tabla/kanban:', data.cambios_detectados);
                 
                 // Actualizar vista suavemente SIN recargar página
                 if (data.total_cambios > 0) {
                     // Mostrar notificación discreta
                     mostrarNotificacionTablaKanban(data.total_cambios);
                     
                     // Actualizar contenido específico según la vista
                     setTimeout(() => {
                         actualizarContenidoSinRecargar(data);
                     }, 1000);
                 }
                 
                 lastUpdateCheckTabla = data.timestamp;
             }
         })
         .catch(error => {
             console.error('❌ Error en polling tabla/kanban:', error);
         });
     }
     
     function mostrarNotificacionTablaKanban(totalCambios) {
         // Crear notificación discreta
         const $notification = $(`
             <div style="
                 position: fixed;
                 top: 20px;
                 right: 20px;
                 background: #28a745;
                 color: white;
                 padding: 8px 12px;
                 border-radius: 4px;
                 font-size: 0.8rem;
                 z-index: 9999;
                 opacity: 0;
                 transition: opacity 0.3s ease;
                 box-shadow: 0 2px 5px rgba(0,0,0,0.2);
             ">
                 <i class="fas fa-sync-alt me-1"></i>${totalCambios} actualización(es) - Actualizando...
             </div>
         `);
         
         $('body').append($notification);
         
         // Animar entrada
         setTimeout(() => $notification.css('opacity', '1'), 100);
         
         // Remover después
         setTimeout(() => {
             $notification.css('opacity', '0');
             setTimeout(() => $notification.remove(), 300);
         }, 1800);
     }
     
     function actualizarContenidoSinRecargar(data) {
         console.log('🔄 Actualizando contenido sin recargar página');
         
         // Detectar qué vista está activa
         const esTabla = $('.workflow-table').length > 0;
         const esKanban = $('.kanban-column').length > 0;
         
         if (esTabla) {
             console.log('📊 Actualizando vista tabla');
             actualizarVistaTabla(data);
         }
         
         if (esKanban) {
             console.log('📋 Actualizando vista kanban');
             actualizarVistaKanban(data);
         }
     }
     
     function actualizarVistaTabla(data) {
         // Para tabla, necesitamos recargar los datos específicos
         // Por ahora, hacer una actualización suave de la tabla
         const $tabla = $('.workflow-table tbody');
         if ($tabla.length > 0) {
             $tabla.css('opacity', '0.7');
             
             // Simular actualización - en producción aquí iría una llamada AJAX
             // para obtener solo las filas actualizadas
             setTimeout(() => {
                 $tabla.css('opacity', '1');
                 console.log('✅ Tabla actualizada');
             }, 500);
         }
     }
     
     function actualizarVistaKanban(data) {
         // Para kanban, actualizar contadores y verificar cambios
         if (typeof actualizarContadoresKanban === 'function') {
             actualizarContadoresKanban();
         }
         
         // Efecto visual para indicar actualización
         $('.kanban-column').each(function() {
             const $column = $(this);
             $column.css('opacity', '0.9');
             setTimeout(() => {
                 $column.css('opacity', '1');
             }, 300);
         });
         
         console.log('✅ Kanban actualizado');
     }
     
     // Pausar polling cuando no está activo
     document.addEventListener('visibilitychange', function() {
         isPollingActiveTabla = !document.hidden;
     });
     
     // Iniciar polling
     iniciarPollingTablaKanban();
     
     // Escuchar cambios de otras pestañas/vistas
     if ('BroadcastChannel' in window) {
         window.workflowChannel = new BroadcastChannel('workflow-sync');
         
         window.workflowChannel.addEventListener('message', function(event) {
             const message = event.data;
             
             if (message.type === 'sync_solicitud' && message.source !== 'tabla-kanban') {
                 console.log('Sincronizando desde otra vista:', message.source);
                 
                 const notification = message.notification;
                 const data = notification.data;
                 
                 if (notification.type === 'solicitud_cambio_etapa') {
                     // Actualizar tabla si existe
                     const $filaTabla = $(`.workflow-table tbody tr[data-solicitud-id="${data.solicitud_id}"]`);
                     if ($filaTabla.length > 0) {
                         // Recargar la fila de la tabla o toda la tabla
                         location.reload();
                     }
                     
                     // Actualizar kanban si existe
                     const $cardKanban = $(`.kanban-card[data-solicitud-id="${data.solicitud_id}"]`);
                     if ($cardKanban.length > 0) {
                         // Mover tarjeta a nueva columna
                         const $nuevaColumna = $(`.kanban-column-body[data-etapa-id="${data.etapa_actual.id}"]`);
                         if ($nuevaColumna.length > 0) {
                             $cardKanban.attr('data-etapa-id', data.etapa_actual.id);
                             $cardKanban.appendTo($nuevaColumna);
                             actualizarContadoresKanban();
                         }
                     }
                 }
             }
         });
     }
});
</script>

<style>
/* Tamaño intermedio de letra en vista tabla */
.workflow-table {
    font-size: 0.9rem !important;
}

.workflow-table th {
    font-size: 0.85rem !important;
    padding: 0.6rem !important;
}

.workflow-table td {
    font-size: 0.9rem !important;
    padding: 0.6rem !important;
}

.workflow-table .fw-semibold {
    font-size: 0.9rem !important;
}

.workflow-table small {
    font-size: 0.75rem !important;
}

.workflow-table .badge {
    font-size: 0.75rem !important;
}

.workflow-table .form-select-sm {
    font-size: 0.85rem !important;
}

.workflow-table .form-control-sm {
    font-size: 0.85rem !important;
}

.workflow-table .solicitud-link {
    font-size: 0.9rem !important;
}

.workflow-table .text-muted {
    font-size: 0.8rem !important;
}

.workflow-table .fas {
    font-size: 0.8rem !important;
}

/* Eliminar completamente el borde vacío debajo del encabezado */
.workflow-table thead {
    border-bottom: none !important;
    border-collapse: collapse !important;
}

.workflow-table thead tr {
    border-bottom: none !important;
}

.workflow-table thead th {
    border-bottom: none !important;
    border-top: none !important;
    vertical-align: middle !important;
}

.workflow-table thead::after,
.workflow-table thead tr::after,
.workflow-table thead th::after {
    display: none !important;
    content: none !important;
}

/* Eliminar cualquier margen o padding que cause el espacio vacío */
.workflow-table thead {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}

.workflow-table tbody {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

.workflow-table tbody tr:first-child {
    border-top: none !important;
}

.workflow-table tbody tr:first-child td {
    border-top: none !important;
}

/* Forzar que la tabla no tenga separación entre thead y tbody */
.workflow-table {
    border-collapse: collapse !important;
    border-spacing: 0 !important;
}

/* Eliminar todos los bordes del contenedor de tabla */
.table-container {
    border: none !important;
    border-top: none !important;
    border-bottom: none !important;
}

.table-responsive {
    border: none !important;
    border-top: none !important;
    border-bottom: none !important;
}

.card-body {
    border-top: none !important;
}

/* Eliminar cualquier borde superior o inferior de la tabla */
.workflow-table {
    border: none !important;
    border-top: none !important;
    border-bottom: none !important;
}

.workflow-table thead {
    border-top: none !important;
}

.workflow-table tbody {
    border-bottom: none !important;
}

/* Asegurar que los dropdowns Kanban aparezcan al frente */
.kanban-column .dropdown {
    z-index: 1050 !important;
}

.kanban-column .dropdown-menu {
    z-index: 1052 !important;
    position: fixed !important;
    will-change: transform !important;
}

.kanban-column .dropdown-toggle {
    z-index: 1051 !important;
}

/* Hacer más sutil el indicador de ordenamiento */
.workflow-table th {
    position: relative !important;
    padding-right: 1.5rem !important;
}

.workflow-table th.sortable::after {
    content: '⇅' !important;
    position: absolute !important;
    right: 0.5rem !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    font-size: 0.7rem !important;
    color: #6c757d !important;
    opacity: 0.5 !important;
    transition: opacity 0.2s ease !important;
}

.workflow-table th.sortable:hover::after {
    opacity: 1 !important;
    color: #495057 !important;
}

.workflow-table th.sorted-asc::after {
    content: '↑' !important;
    opacity: 1 !important;
    color: var(--verde-pacifico) !important;
}

.workflow-table th.sorted-desc::after {
    content: '↓' !important;
    opacity: 1 !important;
    color: var(--verde-pacifico) !important;
}

/* Toast notification styles */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 10001;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 300px;
    font-weight: 500;
}

.toast-notification.show {
    transform: translateX(0);
}

.toast-notification.success {
    background: #28a745;
}

.toast-notification.error {
    background: #dc3545;
}

/* Auto-populated indicator styles */
.selected-item.auto-populated {
    border-left: 3px solid #28a745;
    background-color: #f8fff9;
}

.auto-populated-indicator {
    color: #28a745 !important;
    font-size: 0.75rem !important;
    display: block !important;
    margin-top: 4px !important;
    font-style: italic;
}

/* Cliente placeholder styles */
#clientePlaceholder {
    background-color: #f8f9fa;
    border: 1px dashed #dee2e6;
    border-radius: 6px;
    padding: 20px;
    text-align: center;
    color: #6c757d;
    font-size: 0.9rem;
}

#clientePlaceholder i {
    font-size: 1.2rem;
    margin-bottom: 8px;
    display: block;
}
</style>

{% include 'workflow/partials/drawer.html' %}

<!-- JavaScript functions for drawer functionality -->
<script>
// Define functions immediately to ensure they're available
(function() {
    // Ensure drawer functions are available globally
window.openSolicitudDrawerWithContext = function(pipelineId = null) {
    console.log('🔧 openSolicitudDrawerWithContext called with pipelineId:', pipelineId);
    
    // Check if drawer exists
    const drawer = document.getElementById('solicitudDrawer');
    if (!drawer) {
        console.error('❌ Drawer element not found!');
        alert('Error: Drawer not found. Please refresh the page.');
        return;
    }
    
    // Open drawer
    drawer.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // If pipelineId is provided, lock the pipeline selection
    if (pipelineId) {
        console.log('🔒 Locking pipeline:', pipelineId);
        lockPipeline(pipelineId);
    }
    
    console.log('✅ Drawer opened successfully');
};

// Also define the base openSolicitudDrawer function
window.openSolicitudDrawer = function(pipelineId = null) {
    console.log('🔧 openSolicitudDrawer called with pipelineId:', pipelineId);
    
    const drawer = document.getElementById('solicitudDrawer');
    if (!drawer) {
        console.error('❌ Drawer element not found!');
        return;
    }
    
    drawer.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    if (pipelineId) {
        lockPipeline(pipelineId);
    }
};

window.lockPipeline = function(pipelineId) {
    console.log('🔒 lockPipeline called with:', pipelineId);
    
    const pipelineSelect = document.getElementById('pipelineSelect');
    const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');
    const pipelineLockedName = document.getElementById('pipelineLockedName');
    
    if (!pipelineSelect || !pipelineLockedInfo || !pipelineLockedName) {
        console.error('❌ Pipeline elements not found!');
        return;
    }
    
    // Set and disable the select
    pipelineSelect.value = pipelineId;
    pipelineSelect.disabled = true;
    pipelineSelect.style.display = 'none';
    
    console.log('🔒 Pipeline select value set to:', pipelineSelect.value);
    console.log('🔒 Pipeline select disabled:', pipelineSelect.disabled);
    console.log('🔒 Pipeline select display:', pipelineSelect.style.display);
    
    // Show locked info
    const selectedOption = pipelineSelect.options[pipelineSelect.selectedIndex];
    if (selectedOption) {
        pipelineLockedName.textContent = selectedOption.text;
        pipelineLockedInfo.style.display = 'block';
        
        console.log('🔒 Pipeline locked info displayed:', pipelineLockedInfo.style.display);
        console.log('🔒 Pipeline locked name:', pipelineLockedName.textContent);
        
        // Load form data for the locked pipeline
        loadFormularioData(pipelineId);
    }
    
    console.log('✅ Pipeline locked successfully');
};

window.closeSolicitudDrawer = function() {
    console.log('🔧 closeSolicitudDrawer called');
    
    const drawer = document.getElementById('solicitudDrawer');
    if (drawer) {
        drawer.classList.remove('active');
        document.body.style.overflow = '';
        resetForm();
        console.log('✅ Drawer closed successfully');
    }
};

window.resetForm = function() {
    console.log('🔧 resetForm called');
    
    const form = document.getElementById('solicitudForm');
    if (form) {
        form.reset();
    }
    
    // Reset hidden inputs
    const cotizacionId = document.getElementById('cotizacionId');
    const clienteId = document.getElementById('clienteId');
    if (cotizacionId) cotizacionId.value = '';
    if (clienteId) clienteId.value = '';
    
    // Reset selected displays
    const cotizacionSelected = document.getElementById('cotizacionSelected');
    const clienteSelected = document.getElementById('clienteSelected');
    const clientePlaceholder = document.getElementById('clientePlaceholder');
    
    if (cotizacionSelected) cotizacionSelected.style.display = 'none';
    if (clienteSelected) {
        clienteSelected.style.display = 'none';
        clienteSelected.classList.remove('auto-populated');
        
        // Remove auto-populated indicator
        const indicator = clienteSelected.querySelector('.auto-populated-indicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    if (clientePlaceholder) {
        clientePlaceholder.style.display = 'block';
    }
    
    // Clear search inputs
    const cotizacionSearch = document.getElementById('cotizacionSearch');
    if (cotizacionSearch) cotizacionSearch.value = '';
    
    // Reset campos personalizados
    const camposContainer = document.getElementById('camposContainer');
    if (camposContainer) {
        camposContainer.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                Selecciona un pipeline para ver los campos personalizados
            </div>
        `;
    }
    
    // Reset requisitos
    const requisitosContainer = document.getElementById('requisitosContainer');
    if (requisitosContainer) {
        requisitosContainer.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                Selecciona un pipeline para ver los requisitos
            </div>
        `;
    }
    
    // Reset pipeline lock
    const pipelineSelect = document.getElementById('pipelineSelect');
    const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');
    if (pipelineSelect) {
        pipelineSelect.disabled = false;
        pipelineSelect.style.display = 'block';
        console.log('🔧 Pipeline select reset - disabled:', pipelineSelect.disabled, 'display:', pipelineSelect.style.display);
    }
    if (pipelineLockedInfo) {
        pipelineLockedInfo.style.display = 'none';
        console.log('🔧 Pipeline locked info reset - display:', pipelineLockedInfo.style.display);
    }
    
    hideSearchResults();
    console.log('✅ Form reset successfully');
};

window.loadFormularioData = function(pipelineId) {
    console.log('🔧 loadFormularioData called with pipelineId:', pipelineId);
    
    fetch(`/workflow/api/formulario-datos/?pipeline_id=${pipelineId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ Form data loaded:', data);
                renderCamposPersonalizados(data.campos_personalizados);
                renderRequisitos(data.requisitos);
            } else {
                console.error('❌ Error loading form data:', data.error);
            }
        })
        .catch(error => {
            console.error('❌ Error loading form data:', error);
        });
};

window.hideSearchResults = function(type) {
    if (type) {
        const results = document.getElementById(`${type}Results`);
        if (results) results.classList.remove('show');
    } else {
        const cotizacionResults = document.getElementById('cotizacionResults');
        if (cotizacionResults) cotizacionResults.classList.remove('show');
    }
};

// Initialize drawer functionality when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initializing drawer functionality...');
    
    // Close drawer when clicking outside
    const drawer = document.getElementById('solicitudDrawer');
    if (drawer) {
        drawer.addEventListener('click', function(e) {
            if (e.target === this) {
                closeSolicitudDrawer();
            }
        });
        console.log('✅ Drawer click outside handler initialized');
    }
    
    // Setup search functionality if elements exist
    const cotizacionSearch = document.getElementById('cotizacionSearch');
    if (cotizacionSearch) {
        setupSearch();
        console.log('✅ Search functionality initialized');
    }
    
    console.log('✅ Drawer functionality initialized successfully');
});

// Fallback function in case the drawer functions are not loaded
window.openSolicitudDrawer = function(pipelineId = null) {
    console.log('🔧 openSolicitudDrawer fallback called with pipelineId:', pipelineId);
    openSolicitudDrawerWithContext(pipelineId);
};

// Missing functions that are referenced but not defined
window.renderCamposPersonalizados = function(campos) {
    console.log('🔧 renderCamposPersonalizados called with:', campos);
    
    const container = document.getElementById('camposContainer');
    if (!container) {
        console.error('❌ camposContainer not found!');
        return;
    }
    
    container.innerHTML = '';
    
    if (!campos || campos.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                No hay campos personalizados para este pipeline
            </div>
        `;
        return;
    }
    
    campos.forEach(campo => {
        const campoDiv = document.createElement('div');
        campoDiv.className = 'campo-dinamico';
        
        let inputHtml = '';
        const required = campo.requerido ? 'required' : '';
        const requiredStar = campo.requerido ? '<span class="campo-required">*</span>' : '';
        
        switch (campo.tipo) {
            case 'texto':
                inputHtml = `<input type="text" class="form-control" name="campo_${campo.id}" ${required}>`;
                break;
            case 'numero':
                inputHtml = `<input type="number" step="0.01" class="form-control" name="campo_${campo.id}" ${required}>`;
                break;
            case 'entero':
                inputHtml = `<input type="number" class="form-control" name="campo_${campo.id}" ${required}>`;
                break;
            case 'fecha':
                inputHtml = `<input type="date" class="form-control" name="campo_${campo.id}" ${required}>`;
                break;
            case 'booleano':
                inputHtml = `
                    <select class="form-control" name="campo_${campo.id}" ${required}>
                        <option value="">Seleccionar...</option>
                        <option value="true">Sí</option>
                        <option value="false">No</option>
                    </select>
                `;
                break;
        }
        
        campoDiv.innerHTML = `
            <label class="campo-label">
                ${campo.nombre} ${requiredStar}
            </label>
            ${inputHtml}
        `;
        
        container.appendChild(campoDiv);
    });
    
    console.log('✅ Campos personalizados rendered successfully');
};

window.renderRequisitos = function(requisitos) {
    console.log('🔧 renderRequisitos called with:', requisitos);
    
    const container = document.getElementById('requisitosContainer');
    if (!container) {
        console.error('❌ requisitosContainer not found!');
        return;
    }
    
    container.innerHTML = '';
    
    if (!requisitos || requisitos.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                No hay requisitos para este pipeline
            </div>
        `;
        return;
    }
    
    requisitos.forEach(requisito => {
        const requisitoDiv = document.createElement('div');
        requisitoDiv.className = 'requisito-item';
        
        requisitoDiv.innerHTML = `
            <div class="requisito-header">
                <div class="requisito-info">
                    <div class="requisito-nombre">
                        ${requisito.nombre}
                        ${requisito.obligatorio ? '<span class="requisito-obligatorio">(Obligatorio)</span>' : ''}
                    </div>
                    ${requisito.descripcion ? `<div class="requisito-descripcion">${requisito.descripcion}</div>` : ''}
                </div>
            </div>
            <div class="requisito-upload">
                <label class="file-upload-label">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Subir archivo
                    <input type="file" class="file-upload-input" name="archivo_requisito_${requisito.id}" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.zip,.rar">
                </label>
                <div class="file-upload-info">
                    <small class="text-muted">Formatos permitidos: PDF, DOC, DOCX, JPG, PNG, GIF, ZIP, RAR</small>
                </div>
                <div class="file-selected" style="display: none;">
                    <i class="fas fa-file me-2"></i>
                    <span class="file-name"></span>
                    <button type="button" class="btn-remove-file" onclick="removeFile(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(requisitoDiv);
    });
    
    // Setup file upload handlers after rendering
    setTimeout(() => {
        setupFileUploadHandlers();
    }, 100);
    
    console.log('✅ Requisitos rendered successfully');
};

window.setupSearch = function() {
    console.log('🔧 setupSearch called');
    
    // Cotización search
    const cotizacionSearch = document.getElementById('cotizacionSearch');
    if (cotizacionSearch) {
        cotizacionSearch.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value;
            if (query.length < 2) {
                hideSearchResults('cotizacion');
                return;
            }
            searchTimeout = setTimeout(() => {
                searchCotizaciones(query);
            }, 300);
        });
    }



    // Pipeline change
    const pipelineSelect = document.getElementById('pipelineSelect');
    if (pipelineSelect) {
        pipelineSelect.addEventListener('change', function(e) {
            const pipelineId = e.target.value;
            if (pipelineId) {
                loadFormularioData(pipelineId);
            } else {
                // Reset to placeholder messages
                const camposContainer = document.getElementById('camposContainer');
                const requisitosContainer = document.getElementById('requisitosContainer');
                
                if (camposContainer) {
                    camposContainer.innerHTML = `
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona un pipeline para ver los campos personalizados
                        </div>
                    `;
                }
                
                if (requisitosContainer) {
                    requisitosContainer.innerHTML = `
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona un pipeline para ver los requisitos
                        </div>
                    `;
                }
            }
        });
    }
    
    console.log('✅ Search functionality setup successfully');
};

// Search functionality variables
let searchTimeout;
let currentSearchType = '';

function searchCotizaciones(query) {
    console.log('🔧 searchCotizaciones called with query:', query);
    
    fetch(`/workflow/api/buscar-cotizaciones-drawer/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSearchResults('cotizacion', data.cotizaciones);
            }
        })
        .catch(error => {
            console.error('❌ Error searching cotizaciones:', error);
        });
}



function showSearchResults(type, results) {
    console.log('🔧 showSearchResults called with type:', type, 'results:', results);
    
    const resultsContainer = document.getElementById(`${type}Results`);
    if (!resultsContainer) {
        console.error('❌ Results container not found for type:', type);
        return;
    }
    
    resultsContainer.innerHTML = '';
    
    if (!results || results.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
    } else {
        results.forEach(item => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.onclick = () => selectItem(type, item);
            
            resultItem.innerHTML = `
                <div class="search-result-name">${item.nombreCliente || 'Sin nombre'}</div>
                <div class="search-result-details">
                    ${item.cedulaCliente || 'Sin cédula'} • 
                    ${item.tipoPrestamo || 'Sin tipo'} • 
                    $${item.montoPrestamo.toLocaleString()}
                </div>
            `;
            
            resultsContainer.appendChild(resultItem);
        });
    }
    
    resultsContainer.classList.add('show');
}

function selectItem(type, item) {
    console.log('🔧 selectItem called with type:', type, 'item:', item);
    
    const idInput = document.getElementById(`${type}Id`);
    const searchInput = document.getElementById(`${type}Search`);
    const selectedContainer = document.getElementById(`${type}Selected`);
    
    if (idInput) idInput.value = item.id;
    if (searchInput) searchInput.value = '';
    
    if (selectedContainer) {
        const nameElement = selectedContainer.querySelector('.selected-name');
        const detailsElement = selectedContainer.querySelector('.selected-details');
        
        if (nameElement) nameElement.textContent = item.nombreCliente || 'Sin nombre';
        if (detailsElement) detailsElement.textContent = `${item.cedulaCliente || 'Sin cédula'} • ${item.tipoPrestamo || 'Sin tipo'} • $${item.montoPrestamo.toLocaleString()}`;
        
        selectedContainer.style.display = 'block';
        
        // Auto-populate cliente when cotización is selected
        autoPopulateClienteFromCotizacion(item);
    }
    
    hideSearchResults(type);
}

function autoPopulateClienteFromCotizacion(cotizacion) {
    console.log('🔧 autoPopulateClienteFromCotizacion called with:', cotizacion);
    
    // Clear any existing cliente first
    clearCliente();
    
    // Create a cliente object from cotización data
    const clienteData = {
        id: null, // We'll need to find the actual cliente ID
        nombreCliente: cotizacion.nombreCliente,
        cedulaCliente: cotizacion.cedulaCliente,
        edad: null, // Not available in cotización data
        sexo: null  // Not available in cotización data
    };
    
    // Search for the actual cliente by cédula
    if (clienteData.cedulaCliente) {
        fetch(`/workflow/api/buscar-clientes-drawer/?q=${encodeURIComponent(clienteData.cedulaCliente)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.clientes.length > 0) {
                    // Use the first matching cliente
                    const cliente = data.clientes[0];
                    console.log('🔧 Found matching cliente:', cliente);
                    selectClienteAutomatically(cliente);
                } else {
                    // If no cliente found, create a virtual cliente object
                    console.log('🔧 No matching cliente found, using cotización data');
                    selectClienteAutomatically(clienteData);
                }
            })
            .catch(error => {
                console.error('❌ Error searching for cliente:', error);
                // Fallback to using cotización data
                selectClienteAutomatically(clienteData);
            });
    } else {
        // No cédula available, use cotización data directly
        selectClienteAutomatically(clienteData);
    }
}

function selectClienteAutomatically(cliente) {
    console.log('🔧 selectClienteAutomatically called with:', cliente);
    
    const clienteIdInput = document.getElementById('clienteId');
    const clienteSelectedContainer = document.getElementById('clienteSelected');
    const clientePlaceholder = document.getElementById('clientePlaceholder');
    
    if (clienteIdInput) clienteIdInput.value = cliente.id || '';
    
    if (clienteSelectedContainer && clientePlaceholder) {
        const nameElement = clienteSelectedContainer.querySelector('.selected-name');
        const detailsElement = clienteSelectedContainer.querySelector('.selected-details');
        
        if (nameElement) nameElement.textContent = cliente.nombreCliente || 'Sin nombre';
        if (detailsElement) {
            if (cliente.id) {
                // Real cliente with full data
                detailsElement.textContent = `${cliente.cedulaCliente || 'Sin cédula'} • ${cliente.edad || 'Sin edad'} años`;
            } else {
                // Virtual cliente from cotización data
                detailsElement.textContent = `${cliente.cedulaCliente || 'Sin cédula'} • (Datos de cotización)`;
            }
        }
        
        // Add auto-populated indicator
        clienteSelectedContainer.classList.add('auto-populated');
        clienteSelectedContainer.style.display = 'block';
        clientePlaceholder.style.display = 'none';
        
        // Add a small indicator text
        const indicator = document.createElement('small');
        indicator.className = 'auto-populated-indicator';
        indicator.innerHTML = '<i class="fas fa-magic me-1"></i>Auto-completado desde cotización';
        
        // Remove any existing indicator
        const existingIndicator = clienteSelectedContainer.querySelector('.auto-populated-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        clienteSelectedContainer.appendChild(indicator);
    }
}

function setupFileUploadHandlers() {
    console.log('🔧 setupFileUploadHandlers called');
    
    document.querySelectorAll('.file-upload-input').forEach(input => {
        input.addEventListener('change', function() {
            const file = this.files[0];
            const requisitoItem = this.closest('.requisito-item');
            const fileSelected = requisitoItem.querySelector('.file-selected');
            const fileName = fileSelected.querySelector('.file-name');
            const uploadLabel = requisitoItem.querySelector('.file-upload-label');
            
            if (file) {
                fileName.textContent = file.name;
                fileSelected.style.display = 'flex';
                uploadLabel.style.display = 'none';
            }
        });
    });
}

function removeFile(button) {
    console.log('🔧 removeFile called');
    
    const requisitoItem = button.closest('.requisito-item');
    const fileSelected = requisitoItem.querySelector('.file-selected');
    const uploadLabel = requisitoItem.querySelector('.file-upload-label');
    const fileInput = requisitoItem.querySelector('.file-upload-input');
    
    fileInput.value = '';
    fileSelected.style.display = 'none';
    uploadLabel.style.display = 'inline-block';
}

// Additional functions that might be missing
window.submitSolicitud = function() {
    console.log('🔧 submitSolicitud called');
    
    const form = document.getElementById('solicitudForm');
    const formData = new FormData(form);
    
    // Validar pipeline - check both form data and locked pipeline
    const pipelineFromForm = formData.get('pipeline');
    const pipelineSelect = document.getElementById('pipelineSelect');
    const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');
    
    let pipelineId = pipelineFromForm;
    
    // If pipeline is locked (hidden), get the value from the select element
    if (!pipelineId && pipelineLockedInfo && pipelineLockedInfo.style.display !== 'none') {
        pipelineId = pipelineSelect ? pipelineSelect.value : null;
        console.log('🔧 Pipeline is locked, using value from select:', pipelineId);
    }
    
    if (!pipelineId) {
        alert('Por favor selecciona un pipeline');
        return;
    }
    
    // If pipeline was locked, add it to form data
    if (!pipelineFromForm && pipelineId) {
        formData.set('pipeline', pipelineId);
        console.log('🔧 Added locked pipeline to form data:', pipelineId);
    }
    
    // Debug: Log all form data
    console.log('🔧 Form data contents:');
    for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    
    // Validar archivos obligatorios si corresponde
    const requiredFiles = document.querySelectorAll('.requisito-item .file-upload-input[required]');
    let hasRequiredFiles = true;
    
    for (let input of requiredFiles) {
        if (!input.files || input.files.length === 0) {
            hasRequiredFiles = false;
            break;
        }
    }
    
    if (!hasRequiredFiles) {
        alert('Por favor sube todos los archivos obligatorios');
        return;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('.drawer-footer .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner"></span> Creando...';
    submitBtn.disabled = true;
    
    fetch('/workflow/nueva-solicitud/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeSolicitudDrawer();
            // Mostrar mensaje de éxito
            showSuccessMessage(data.message);
            // Recargar la página para mostrar la nueva solicitud
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al crear la solicitud');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
};

window.showSuccessMessage = function(message) {
    console.log('🔧 showSuccessMessage called with:', message);
    
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification success';
    toast.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
    `;
    
    document.body.appendChild(toast);
    
    // Show toast
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
};

window.clearCotizacion = function() {
    console.log('🔧 clearCotizacion called');
    document.getElementById('cotizacionId').value = '';
    document.getElementById('cotizacionSelected').style.display = 'none';
    
    // Also clear cliente when cotización is cleared
    console.log('🔧 Also clearing cliente due to cotización clear');
    clearCliente();
};

window.clearCliente = function() {
    console.log('🔧 clearCliente called');
    document.getElementById('clienteId').value = '';
    const clienteSelected = document.getElementById('clienteSelected');
    const clientePlaceholder = document.getElementById('clientePlaceholder');
    
    if (clienteSelected) {
        clienteSelected.style.display = 'none';
        clienteSelected.classList.remove('auto-populated');
        
        // Remove auto-populated indicator
        const indicator = clienteSelected.querySelector('.auto-populated-indicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    if (clientePlaceholder) {
        clientePlaceholder.style.display = 'block';
    }
};
})(); // Close IIFE
</script>

{% endblock %} 