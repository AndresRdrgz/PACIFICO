{% extends 'workflow/base.html' %}
{% load static %}
{% load workflow_filters %}

{% block title %}Negocios - Sistema de Workflow{% endblock %}

{% block extra_css %}
<style>
    /* Profile Picture Optimization Styles */
    .profile-img {
        transition: opacity 0.3s ease, transform 0.2s ease;
        opacity: 0;
        cursor: pointer;
        will-change: opacity, transform;
    }

    .profile-img[src] {
        opacity: 1;
    }

    .fallback-avatar {
        transition: all 0.2s ease;
        will-change: transform, opacity;
    }

    /* Hover effects for better UX */
    .profile-img:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10;
    }

    .fallback-avatar:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Loading state for images */
    .profile-img:not([src]),
    .profile-img[src=""] {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Enhanced Loading Animations */
    .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 200px;
        animation: fadeInLoading 0.3s ease-out;
    }

    @keyframes fadeInLoading {
        from {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
    }

    /* Multi-select Filter Styles */
    .multiselect-wrapper {
        position: relative;
        width: 100%;
        display: inline-block;
    }

    /* === RECONSIDERACIÓN BADGE STYLES === */
    .badge.bg-warning.text-dark {
        background: linear-gradient(135deg, #fff3cd, #ffeeba) !important;
        color: #856404 !important;
        border: 1px solid #ffeaa7;
        font-weight: 600;
        font-size: 0.75rem;
        padding: 0.35rem 0.6rem;
        border-radius: 0.375rem;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
        transition: all 0.2s ease;
    }
    
    .badge.bg-warning.text-dark:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        background: linear-gradient(135deg, #fff8db, #fff2cd) !important;
    }
    
    .badge.bg-warning.text-dark i {
        animation: reconsiderationSpin 2s ease-in-out infinite;
    }
    
    @keyframes reconsiderationSpin {
        0%, 100% { transform: rotate(0deg); }
        50% { transform: rotate(180deg); }
    }

    .multiselect-button {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        min-height: 38px;
        padding: 8px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        color: #374151;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        outline: none;
    }

    .multiselect-button:hover {
        border-color: #cbd5e1;
        background-color: #f9fafb;
    }

    .multiselect-button:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .multiselect-button.active {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .multiselect-chevron {
        margin-left: 8px;
        font-size: 0.75rem;
        transition: transform 0.2s ease;
        color: #6b7280;
    }

    .multiselect-chevron.rotated {
        transform: rotate(180deg);
    }

    .multiselect-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1050;
        margin-top: 4px;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        max-height: 280px;
        overflow: hidden;
        min-width: 200px;
    }

    .multiselect-search {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
    }

    .multiselect-options {
        max-height: 200px;
        overflow-y: auto;
    }

    .multiselect-option {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: 0.875rem;
        border-bottom: 1px solid #f3f4f6;
        user-select: none;
    }

    .multiselect-option:last-child {
        border-bottom: none;
    }

    .multiselect-option:hover {
        background-color: #f3f4f6;
    }

    .multiselect-option.selected {
        background-color: #dbeafe;
        color: #1e40af;
        font-weight: 500;
    }

    .multiselect-checkbox {
        width: 16px;
        height: 16px;
        margin-right: 10px;
        accent-color: #3b82f6;
        cursor: pointer;
    }

    .filter-badge {
        display: inline-flex;
        align-items: center;
        background: #dbeafe;
        color: #1e40af;
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 12px;
        margin: 2px;
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }

    .filter-badge .remove-badge {
        margin-left: 6px;
        cursor: pointer;
        font-weight: bold;
        color: #1e40af;
        opacity: 0.7;
        transition: opacity 0.2s ease;
        padding: 0 2px;
    }

    .filter-badge .remove-badge:hover {
        opacity: 1;
        background-color: rgba(30, 64, 175, 0.1);
        border-radius: 50%;
    }

    /* Hide scrollbar for better appearance */
    .multiselect-options::-webkit-scrollbar {
        width: 6px;
    }

    .multiselect-options::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .multiselect-options::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .multiselect-options::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Table Loading Overlay */
    .table-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(3px);
        z-index: 999;
        display: none;
        border-radius: 8px;
    }

    .table-loading-overlay.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Skeleton loading for table rows */
    .skeleton-row {
        animation: pulse 1.5s ease-in-out infinite;
    }

    .skeleton-cell {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 2s infinite;
        border-radius: 4px;
        height: 20px;
        margin: 4px 0;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Drawer Loading States */
    .drawer-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        z-index: 1001;
        display: none;
        border-radius: 12px;
    }

    .drawer-loading-overlay.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
    }

    .drawer-loading-content {
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        max-width: 300px;
    }

    .drawer-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #28a745;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    .drawer-loading-text {
        color: #495057;
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .drawer-loading-subtext {
        color: #6c757d;
        font-size: 0.85rem;
        line-height: 1.4;
    }

    /* Button loading states */
    .btn-loading {
        position: relative;
        pointer-events: none;
    }

    .btn-loading .btn-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        margin-right: 0.5rem;
    }

    /* Progress indicators */
    .progress-indicator {
        width: 100%;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 1rem;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        border-radius: 2px;
        transition: width 0.3s ease;
    }

    .progress-bar.indeterminate {
        width: 30%;
        animation: indeterminateProgress 2s infinite;
    }

    @keyframes indeterminateProgress {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(300%); }
    }

    /* Stage Change Animation Styles */
    .stage-change-animation {
        position: relative;
        overflow: hidden;
    }

    .stage-change-animation::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(40, 167, 69, 0.1) 25%, 
            rgba(40, 167, 69, 0.3) 50%, 
            rgba(40, 167, 69, 0.1) 75%, 
            transparent 100%
        );
        animation: stageChangeShimmer 2s ease-in-out;
        z-index: 1;
        pointer-events: none;
    }

    @keyframes stageChangeShimmer {
        0% { left: -100%; }
        50% { left: 100%; }
        100% { left: 100%; }
    }

    /* Row highlight animation */
    .row-updating {
        background: linear-gradient(90deg, 
            rgba(255, 255, 255, 1) 0%,
            rgba(40, 167, 69, 0.05) 25%,
            rgba(40, 167, 69, 0.1) 50%,
            rgba(40, 167, 69, 0.05) 75%,
            rgba(255, 255, 255, 1) 100%
        );
        background-size: 200% 100%;
        animation: rowUpdatePulse 1.5s ease-in-out;
        transition: all 0.3s ease;
    }

    @keyframes rowUpdatePulse {
        0% { background-position: 200% 0; }
        50% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    /* Select dropdown animation */
    .select-updating {
        position: relative;
        transform: scale(1.02);
        box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        transition: all 0.3s ease;
    }

    .select-updating::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, 
            transparent 30%, 
            rgba(40, 167, 69, 0.4) 50%, 
            transparent 70%
        );
        border-radius: 6px;
        animation: selectGlow 1s ease-in-out infinite alternate;
        z-index: -1;
    }

    @keyframes selectGlow {
        0% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    /* Success feedback animation */
    .stage-change-success {
        animation: successBounce 0.6s ease-out;
    }

    @keyframes successBounce {
        0% { transform: scale(1); }
        30% { transform: scale(1.05); }
        60% { transform: scale(0.98); }
        100% { transform: scale(1); }
    }

    /* Loading spinner for stage change */
    .stage-change-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #28a745;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 8px;
        vertical-align: middle;
    }

    /* Stage badge transition */
    .stage-badge {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .stage-badge.updating {
        transform: scale(0.95);
        opacity: 0.7;
    }

    .stage-badge.updating::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(255, 255, 255, 0.4), 
            transparent
        );
        animation: badgeShimmer 1.2s ease-in-out infinite;
    }

    @keyframes badgeShimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    /* Floating notification */
    .stage-change-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 9999;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stage-change-notification.show {
        transform: translateX(0);
        opacity: 1;
    }

    .stage-change-notification.hide {
        transform: translateX(400px);
        opacity: 0;
    }

    /* Enhanced table cell transitions */
    .table td, .table th {
        transition: all 0.2s ease;
    }

    .table tbody tr {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.02);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    /* Cell value change animation */
    .cell-updating {
        background: linear-gradient(90deg, 
            rgba(255, 255, 255, 1) 0%,
            rgba(23, 162, 184, 0.1) 50%,
            rgba(255, 255, 255, 1) 100%
        );
        background-size: 200% 100%;
        animation: cellUpdateShimmer 1s ease-in-out;
    }

    @keyframes cellUpdateShimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Select dropdown enhanced styling */
    .form-select {
        transition: all 0.2s ease;
    }

    .form-select:focus {
        transform: scale(1.01);
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }

    /* Smooth loading states for buttons */
    .btn {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
        transform: translateY(0);
    }

    /* Ripple effect for buttons */
    .btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.3s ease, height 0.3s ease;
        pointer-events: none;
    }

    .btn:active::after {
        width: 200px;
        height: 200px;
    }

    /* Optimize for modern browsers */
    @supports (aspect-ratio: 1) {
        .profile-img,
        .fallback-avatar {
            aspect-ratio: 1;
            width: 32px;
            height: auto;
        }
    }

    /* Responsive profile pictures */
    @media (max-width: 768px) {
        .profile-img, .fallback-avatar {
            width: 28px !important;
            height: 28px !important;
            font-size: 0.7rem !important;
        }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
        .profile-img,
        .fallback-avatar {
            border: 3px solid currentColor !important;
        }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        .profile-img,
        .fallback-avatar {
            transition: none !important;
            animation: none !important;
        }
    }
    
    /* ========================================
       ESTILOS PARA ALERTAS EN TABLA DE NEGOCIOS
       ======================================== */
    
    .alertas-documentos-tabla {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .icon-alert-tabla {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.75rem;
        border: 1px solid transparent;
    }
    
    .icon-alert-tabla:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* Estilos específicos para cada tipo de alerta */
    .icon-alert-tabla.asociar-entrevista {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        border-color: #1d4ed8;
    }
    
    .icon-alert-tabla.asociar-entrevista:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .icon-alert-tabla.urgente {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border-color: #dc2626;
    }
    
    .icon-alert-tabla.urgente:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .icon-alert-tabla.pendiente {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border-color: #d97706;
    }
    
    .icon-alert-tabla.pendiente:hover {
        background: linear-gradient(135deg, #d97706, #b45309);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }
    
    /* Estilos para los badges de contador */
    .icon-alert-tabla .count-badge,
    .icon-alert-tabla .status-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #ffffff;
        color: #1f2937;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        font-size: 0.6rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .icon-alert-tabla .status-badge {
        background: #fbbf24;
        color: #92400e;
        border-color: #f59e0b;
    }
    
    /* Responsividad para pantallas pequeñas */
    @media (max-width: 768px) {
        .icon-alert-tabla {
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
        }
        
        .icon-alert-tabla .count-badge,
        .icon-alert-tabla .status-badge {
            width: 12px;
            height: 12px;
            font-size: 0.55rem;
            top: -3px;
            right: -3px;
        }
        
        .alertas-documentos-tabla {
            gap: 2px;
        }
    }
    
    /* Animación sutil para llamar la atención */
    @keyframes pulseAlert {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .icon-alert-tabla.urgente {
        animation: pulseAlert 2s infinite;
    }
    
    /* Desactivar animaciones si el usuario prefiere reducir movimiento */
    @media (prefers-reduced-motion: reduce) {
        .icon-alert-tabla {
            transition: none !important;
            animation: none !important;
        }
        
        .icon-alert-tabla:hover {
            transform: none !important;
        }
    }

    /* ========================================
       🎯 SISTEMA DE ALERTAS PLANO Y LIMPIO
       ======================================== */
    
    .alertas-premium-container {
        min-height: 40px;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    /* === BASE PARA ALERTAS PLANAS === */
    .alerta-premium {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        transition: opacity 0.2s ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .alerta-premium:hover {
        opacity: 0.8;
    }
    
    /* === ICONOS PLANOS === */
    .icono-premium {
        font-size: 14px;
    }
    
    /* === CONTADORES PLANOS === */
    .contador-premium, .indicador-premium {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 16px;
        height: 16px;
        border-radius: 8px;
        font-size: 10px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid white;
        padding: 0 3px;
    }
    
    /* === COLORES PLANOS POR TIPO === */
    
    /* 🔥 URGENTE - ROJO PLANO */
    .urgente-premium {
        background: #dc2626;
        color: white;
    }
    
    .contador-premium.urgente {
        background: #ffffff;
        color: #dc2626;
    }
    
    /* 📋 PENDIENTE - NARANJA PLANO */
    .pendiente-premium {
        background: #f59e0b;
        color: white;
    }
    
    .contador-premium.pendiente {
        background: #ffffff;
        color: #f59e0b;
    }
    
    /* 👤 ENTREVISTA - AZUL PLANO */
    .entrevista-premium {
        background: #2563eb;
        color: white;
    }
    
    .indicador-premium.entrevista {
        background: #ffffff;
        color: #2563eb;
    }
    
    /* ✅ ESTADO PERFECTO - VERDE PLANO */
    .estado-perfecto {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #16a34a;
        color: white;
        cursor: pointer;
        transition: opacity 0.2s ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .estado-perfecto:hover {
        opacity: 0.8;
    }
    
    .icono-ok {
        font-size: 12px;
    }
    
    /* === RESPONSIVE PLANO === */
    @media (max-width: 768px) {
        .alerta-premium {
            width: 28px;
            height: 28px;
            border-radius: 5px;
        }
        
        .icono-premium {
            font-size: 12px;
        }
        
        .contador-premium, .indicador-premium {
            min-width: 14px;
            height: 14px;
            font-size: 9px;
            top: -3px;
            right: -3px;
        }
        
        .estado-perfecto {
            width: 24px;
            height: 24px;
        }
        
        .icono-ok {
            font-size: 10px;
        }
        
        .alertas-premium-container {
            gap: 6px;
            min-height: 32px;
        }
    }
</style>
{% endblock %}

{% block content %}

{% include 'workflow/partials/modalRequisitos.html' %}

{% include 'workflow/partials/drawer.html' %}

<!-- Modal de Confirmación Personalizado -->
<div class="modal fade" id="modalConfirmacionEtapa" tabindex="-1" aria-labelledby="modalConfirmacionEtapaLabel"
    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content"
            style="border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);">
            <!-- Header con gradiente verde -->
            <div class="modal-header"
                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; padding: 24px 32px 20px 32px; position: relative; overflow: hidden;">
                <!-- Decoración de fondo -->
                <div
                    style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; opacity: 0.6;">
                </div>
                <div
                    style="position: absolute; top: 40px; right: 60px; width: 60px; height: 60px; background: rgba(255, 255, 255, 0.08); border-radius: 50%;">
                </div>

                <div class="w-100 text-center position-relative">
                    <h4 class="modal-title text-white fw-bold mb-1" id="modalConfirmacionEtapaLabel"
                        style="font-size: 1.4rem; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <i class="fas fa-exchange-alt me-2" style="font-size: 1.2rem;"></i>
                        Confirmar Cambio de Etapa
                    </h4>
                    <p class="text-white-50 mb-0" style="font-size: 0.9rem; font-weight: 500;">Sistema de
                        Workflow</p>
                </div>
            </div>

            <div class="modal-body" style="padding: 32px;">
                <!-- Icono central -->
                <div class="text-center mb-4">
                    <div
                        style="width: 80px; height: 80px; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.15)); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 24px rgba(40, 167, 69, 0.2);">
                        <i class="fas fa-arrow-right"
                            style="font-size: 2rem; color: #28a745; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"></i>
                    </div>
                </div>

                <!-- Mensaje principal -->
                <div class="text-center mb-4">
                    <h5 class="fw-bold mb-3" style="color: #2d3748; font-size: 1.2rem;">¿Está seguro del cambio?
                    </h5>
                    <p class="text-muted mb-3" style="font-size: 0.95rem;">La solicitud se moverá a la siguiente
                        etapa:
                    </p>

                    <!-- Caja verde con nombre de etapa -->
                    <div class="bg-success bg-opacity-10 border border-success border-opacity-25 rounded-3 p-3 mb-4"
                        style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.08), rgba(32, 201, 151, 0.12)) !important;">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-flag text-success me-2" style="font-size: 1.1rem;"></i>
                            <span id="nombreEtapaDestino" class="fw-bold text-success" style="font-size: 1.1rem;">Nombre
                                de la Etapa</span>
                        </div>
                    </div>

                    <!-- Información del estado (se selecciona automáticamente el primer subestado) -->
                    <div id="informacionSubestado" class="mb-4" style="display: none;">
                        <h6 class="fw-bold mb-3 text-dark" style="font-size: 1rem;">
                            <i class="fas fa-list-ul text-primary me-2"></i>
                            Estado asignado automáticamente:
                        </h6>
                        <div class="bg-white border border-success border-opacity-25 rounded-3 p-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span id="subestadoAsignado" class="fw-bold text-success"
                                    style="font-size: 1rem;">-</span>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Se asignará automáticamente el primer estado disponible
                            </small>
                        </div>
                        <!-- Campo oculto para enviar el ID del subestado -->
                        <input type="hidden" id="subestadoSeleccionado" value="">
                    </div>
                </div>

                <!-- Información del cambio -->
                <div class="bg-light rounded-3 p-3 mb-4" style="border-left: 4px solid #28a745;">
                    <div class="d-flex align-items-start mb-2">
                        <i class="fas fa-info-circle text-primary me-2 mt-1" style="font-size: 1rem;"></i>
                        <div>
                            <h6 class="fw-bold mb-2 text-dark" style="font-size: 0.95rem;">Información del
                                cambio:</h6>
                            <ul class="list-unstyled mb-0"
                                style="font-size: 0.85rem; color: #6c757d; line-height: 1.6;">
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se actualizará el estado de la solicitud
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se registrará en el historial del sistema
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se notificará a los usuarios correspondientes
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer" style="padding: 24px 32px; border: none; background: #f8f9fa;">
                <button type="button" class="btn btn-outline-secondary" id="btnCancelarModal"
                    style="font-weight: 600; padding: 12px 24px; border-radius: 8px; border-width: 2px;">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnAceptarModal"
                    style="font-weight: 600; padding: 12px 24px; border-radius: 8px; background: linear-gradient(135deg, #28a745, #20c997); border: none; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                    <i class="fas fa-check me-2"></i>Aceptar
                </button>
            </div>
        </div>
    </div>
</div>

<div class="mt-0 pt-0">
    <div class="workflow-container">
        {% if not no_access %}
        <!-- Header Estático - Sin Animaciones -->
        <div class="card mb-1" style="border: 1px solid #e0e0e0;">
            <div class="card-header"
                style="background: var(--verde-pacifico); padding: 12px 20px; border-radius: 0; border: none;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0 text-white fw-bold">
                            <i class="fas fa-briefcase me-2"></i>
                            {% if pipeline %}{{ pipeline.nombre }}{% else %}Pipeline de Negocio{% endif %}
                        </h1>
                        <!-- Indicador de Pipeline Guardado -->
                        {% if last_pipeline_saved and pipeline_filter %}
                        <small class="text-white-50 d-block mt-1">
                            <i class="fas fa-bookmark me-1"></i>
                            Pipeline guardado como preferencia
                            <button type="button" class="btn btn-link text-white-50 p-0 ms-1" 
                                    onclick="clearSavedPipeline()" 
                                    title="Eliminar preferencia">
                                <i class="fas fa-times" style="font-size: 0.8rem;"></i>
                            </button>
                        </small>
                        {% endif %}
                        
                        <!-- Access Level Indicator -->
                        {% if user_access_info.access_level != 'admin' %}
                        <small class="text-white-50 d-block mt-1">
                            <i class="fas fa-shield-alt me-1"></i>
                            Nivel de acceso: 
                            {% if user_access_info.access_level == 'restricted' %}
                                <span class="badge bg-warning">Restringido</span>
                            {% elif user_access_info.access_level == 'direct' %}
                                <span class="badge bg-info">Directo</span>
                            {% elif user_access_info.access_level == 'group' %}
                                <span class="badge bg-primary">Grupo</span>
                            {% elif user_access_info.access_level == 'stage' %}
                                <span class="badge bg-secondary">Etapa</span>
                            {% endif %}
                        </small>
                        {% endif %}
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- Selector de Pipeline -->
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownPipeline"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-project-diagram me-1"></i>
                                Pipelines ({{ pipelines|length }})
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownPipeline" style="z-index: 9999;">
                                {% for p in pipelines %}
                                <li>
                                    <a class="dropdown-item {% if pipeline and p.id == pipeline.id %}active{% endif %}"
                                        href="?pipeline={{ p.id }}&view={{ request.GET.view|default:'table' }}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>{{ p.nombre }}</span>
                                            <div class="d-flex gap-1">
                                                {% if p.user_solicitudes_count > 0 %}
                                                <span class="badge bg-primary">{{ p.user_solicitudes_count }}</span>
                                                {% endif %}
                                                {% if p.access_level != 'admin' %}
                                                <span class="badge bg-secondary" style="font-size: 0.7rem;">
                                                    {% if p.access_level == 'direct' %}D{% elif p.access_level == 'group' %}G{% elif p.access_level == 'stage' %}E{% else %}R{% endif %}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </a>
                                </li>
                                {% empty %}
                                <li><span class="dropdown-item-text text-muted">No hay pipelines disponibles</span></li>
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- View selector - only table now -->
                        <div class="btn-group" role="group" aria-label="Vista de tabla">
                            <button type="button" class="btn btn-light btn-sm active" id="btnVistaTabla">
                                <i class="fas fa-table me-1"></i>
                                Tabla
                            </button>
                        </div>

                        <!-- Botón Actualizar -->
                        <button type="button" class="btn btn-warning btn-sm" id="btnActualizar"
                            onclick="actualizarSolicitudes()" title="Actualizar lista de solicitudes"
                            style="background: #ffc107; border-color: #ffc107; color: #212529; font-weight: 600; border: 2px solid #ffc107; transition: all 0.2s ease;"
                            onmouseover="this.style.background='#ffca2c'; this.style.borderColor='#ffca2c';"
                            onmouseout="this.style.background='#ffc107'; this.style.borderColor='#ffc107';">
                            <i class="fas fa-sync-alt me-1"></i>
                            Actualizar
                        </button>

                        <!-- Botón Solicitudes Makito -->
                        <a href="{% url 'workflow:makito_tracking' %}" class="btn btn-warning btn-sm"
                            title="Tracking de Solicitudes Makito (APC y SURA)"
                            style="background: #ffc107; border-color: #ffc107; color: #212529; font-weight: 600; border: 2px solid #ffc107; transition: all 0.2s ease;"
                            onmouseover="this.style.background='#ffca2c'; this.style.borderColor='#ffca2c';"
                            onmouseout="this.style.background='#ffc107'; this.style.borderColor='#ffc107';">
                            <i class="fas fa-robot me-1"></i>
                            Solicitudes Makito
                        </a>

                        <!-- Botón Nueva Solicitud - Solo si tiene permisos -->
                        {% if can_create_solicitudes %}
                        {% if pipeline %}
                        <a href="#" class="btn btn-light btn-sm"
                            onclick="event.preventDefault(); event.stopPropagation(); openSolicitudDrawerWithContext('{{ pipeline.id }}'); return false;">
                            <i class="fas fa-plus me-1"></i>Nueva Solicitud
                        </a>
                        {% else %}
                        <a href="#" class="btn btn-light btn-sm" onclick="event.preventDefault(); event.stopPropagation(); openSolicitudDrawerWithContext(); return false;">
                            <i class="fas fa-plus me-1"></i>Nueva Solicitud
                        </a>
                        {% endif %}
                        {% else %}
                        <button class="btn btn-light btn-sm" disabled title="No tienes permisos para crear solicitudes">
                            <i class="fas fa-plus me-1"></i>Nueva Solicitud
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if no_access %}
        <!-- Mensaje de acceso denegado -->
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-lock fa-4x text-muted mb-3"></i>
                    <h3 class="text-muted mb-3">Acceso Restringido</h3>
                    {% if error_message %}
                    <p class="text-muted mb-4">{{ error_message }}</p>
                    {% else %}
                    <p class="text-muted mb-4">No tienes acceso a ningún pipeline en el sistema de workflow.</p>
                    {% endif %}
                    
                    <!-- Información adicional para superusuarios -->
                    {% if is_superuser %}
                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-info-circle me-2"></i>Información para Administradores</h6>
                        <p class="mb-2">Como superusuario, deberías tener acceso a todos los pipelines. Si no ves ninguno, verifica:</p>
                        <ul class="text-start mb-0">
                            <li>Que existan pipelines creados en el sistema</li>
                            <li>Que los pipelines estén activos</li>
                            <li>La configuración de permisos en el admin</li>
                        </ul>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Botones de acción -->
                <div class="d-flex justify-content-center gap-2">
                    <a href="{% url 'workflow:dashboard' %}" class="btn btn-primary">
                        <i class="fas fa-home me-1"></i>Ir al Dashboard
                    </a>
                    {% if is_superuser %}
                    <a href="{% url 'admin:workflow_pipeline_changelist' %}" class="btn btn-outline-primary">
                        <i class="fas fa-cog me-1"></i>Administrar Pipelines
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if not no_access %}
        <!-- KPIs Estáticos en Fila Horizontal -->
        <div class="card mb-1" id="kpis-section" style="border: 1px solid #e0e0e0;">
            <div class="card-body py-2">
                <div class="row g-2">
                    <div class="col-3">
                        <div class="kpi-card-compact kpi-total">
                            <div class="kpi-icon-compact">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="kpi-content-compact">
                                <p class="kpi-label-compact">Total</p>
                                <h4 class="kpi-number-compact">{{ page_obj.paginator.count }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="kpi-card-compact kpi-activas">
                            <div class="kpi-icon-compact">
                                <i class="fas fa-play-circle"></i>
                            </div>
                            <div class="kpi-content-compact">
                                <p class="kpi-label-compact">Activas</p>
                                <h4 class="kpi-number-compact">{{ solicitudes|filter_activas|length }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="kpi-card-compact kpi-completadas">
                            <div class="kpi-icon-compact">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="kpi-content-compact">
                                <p class="kpi-label-compact">Completadas</p>
                                <h4 class="kpi-number-compact">{{ solicitudes|filter_completadas|length }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="kpi-card-compact kpi-vencidas">
                            <div class="kpi-icon-compact">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="kpi-content-compact">
                                <p class="kpi-label-compact">Vencidas</p>
                                <h4 class="kpi-number-compact">{{ solicitudes|filter_vencidas|length }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if pipeline %}
        <!-- Leyenda SLA Compacta -->
        <small class="text-muted mb-2 d-block" style="font-size: 0.7rem;">
            <i class="fas fa-info-circle me-1"></i>Leyenda SLA:
            <i class="fas fa-circle text-success me-1 ms-2" style="font-size: 0.5rem;"></i>En tiempo
            <i class="fas fa-circle text-warning me-1 ms-2" style="font-size: 0.5rem;"></i>Por vencer
            <i class="fas fa-circle text-danger me-1 ms-2" style="font-size: 0.5rem;"></i>Vencido
        </small>

        <!-- Main Table View -->
        <div class="vista-desktop">
            <!-- Table Container with Filters and Table in Same Container -->
            <div class="apc-table-container"
                style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
                    <h4 class="section-title" style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #333;">
                        <i class="fas fa-list"></i> Solicitudes
                    </h4>
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <!-- Quick Search Bar -->
                        <div class="search-container" style="position: relative; min-width: 300px;">
                            <input type="text" id="quickTableSearch"
                                placeholder="Buscar por cliente, producto, propietario, código..."
                                style="width: 100%; padding: 12px 16px 12px 45px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s ease; background: white; color: #333;"
                                oninput="handleQuickSearch()">
                            <i class="fas fa-search"
                                style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #64748b; pointer-events: none;"></i>
                            <button id="clearQuickSearch" onclick="handleClearSearch()"
                                style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #64748b; cursor: pointer; padding: 4px; border-radius: 50%; transition: all 0.2s ease; display: none;"
                                title="Limpiar búsqueda">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Multi-Select Filters -->
                        <!-- Producto Filter -->
                        <div class="filter-group" style="margin: 0 8px 0 0; position: relative;">
                            <div class="multiselect-wrapper">
                                <button type="button" id="filtroProductoToggle" 
                                    class="multiselect-button"
                                    style="min-width: 160px;"
                                    onclick="toggleMultiSelect('filtroProducto')">
                                    <span id="filtroProductoLabel">Productos</span>
                                    <i class="fas fa-chevron-down multiselect-chevron" id="filtroProductoChevron"></i>
                                </button>
                                <div id="filtroProductoDropdown" class="multiselect-dropdown d-none">
                                    <div class="multiselect-search">
                                        <input type="text" id="filtroProductoSearch" placeholder="Buscar productos..." 
                                            class="form-control form-control-sm"
                                            oninput="filterDropdownOptions('filtroProducto')">
                                    </div>
                                    <div id="filtroProductoOptions" class="multiselect-options">
                                        <!-- Options will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Etapa Filter -->
                        <div class="filter-group" style="margin: 0 8px 0 0; position: relative;">
                            <div class="multiselect-wrapper">
                                <button type="button" id="filtroEtapaToggle" 
                                    class="multiselect-button"
                                    style="min-width: 140px;"
                                    onclick="toggleMultiSelect('filtroEtapa')">
                                    <span id="filtroEtapaLabel">Etapas</span>
                                    <i class="fas fa-chevron-down multiselect-chevron" id="filtroEtapaChevron"></i>
                                </button>
                                <div id="filtroEtapaDropdown" class="multiselect-dropdown d-none">
                                    <div class="multiselect-search">
                                        <input type="text" id="filtroEtapaSearch" placeholder="Buscar etapas..." 
                                            class="form-control form-control-sm"
                                            oninput="filterDropdownOptions('filtroEtapa')">
                                    </div>
                                    <div id="filtroEtapaOptions" class="multiselect-options">
                                        <!-- Options will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Propietario Filter -->
                        <div class="filter-group" style="margin: 0 8px 0 0; position: relative;">
                            <div class="multiselect-wrapper">
                                <button type="button" id="filtroPropietarioToggle" 
                                    class="multiselect-button"
                                    style="min-width: 160px;"
                                    onclick="toggleMultiSelect('filtroPropietario')">
                                    <span id="filtroPropietarioLabel">Propietarios</span>
                                    <i class="fas fa-chevron-down multiselect-chevron" id="filtroPropietarioChevron"></i>
                                </button>
                                <div id="filtroPropietarioDropdown" class="multiselect-dropdown d-none">
                                    <div class="multiselect-search">
                                        <input type="text" id="filtroPropietarioSearch" placeholder="Buscar propietarios..." 
                                            class="form-control form-control-sm"
                                            oninput="filterDropdownOptions('filtroPropietario')">
                                    </div>
                                    <div id="filtroPropietarioOptions" class="multiselect-options">
                                        <!-- Options will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Legacy SLA Filter (kept for compatibility) -->
                        <div class="filter-group" style="margin: 0;">
                            <select id="filtroSLA" onchange="applyFilters()"
                                style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white; color: #333; min-width: 120px;"
                                title="Filtrar por SLA">
                                <option value="">Todos los SLA</option>
                            </select>
                        </div>

                        <!-- Action Buttons -->
                        <button class="refresh-btn" onclick="clearFilters()"
                            style="padding: 8px 12px; font-size: 0.875rem; background: linear-gradient(135deg, #2d5a2d, #1e5f2a); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);"
                            title="Limpiar filtros">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </div>
                </div>

                <!-- Search Results Count -->
                <small class="text-muted" id="searchResultCount"
                    style="display: none; font-size: 0.875rem; margin-bottom: 16px;">
                    <span id="resultCount">0</span> resultados encontrados
                </small>

                <!-- Enhanced Loading Indicator -->
                <div id="loadingIndicator" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p class="loading-text">Cargando solicitudes...</p>
                </div>

                <!-- Table Container -->
                <div id="tableContainer" class="table-responsive" style="position: relative; display: block;">
                    <!-- Table Loading Overlay -->
                    <div id="tableLoadingOverlay" class="table-loading-overlay">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p class="loading-text">Actualizando datos...</p>
                        </div>
                    </div>
                    <!-- Scroll indicators -->
                    <div class="table-scroll-indicator left" id="scrollLeftIndicator">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                    <div class="table-scroll-indicator right" id="scrollRightIndicator">
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <table class="workflow-table apc-table" id="tablaSolicitudes">
                        <thead>
                            <tr>
                                <th style="width: 200px;">Cliente</th>
                                <th style="width: 150px;">Producto</th>
                                <th style="width: 120px;">Monto</th>
                                <th style="width: 150px;">Propietario</th>
                                <th style="width: 120px;">Etapa</th>
                                <th style="width: 100px;">Estado</th>
                                <th style="width: 140px;">Fecha - Etapa</th>
                                <th style="width: 140px;">Fecha - Subestado</th>
                                <th style="width: 200px;">Fecha - SLA</th>
                                <th style="width: 80px;">
                                    <i class="fas fa-bell" title="Recordatorios y Alertas"></i>
                                </th>
                                <th style="width: 120px;">Código</th>
                                {% if user.is_superuser %}
                                <th style="width: 80px;">
                                    <i class="fas fa-trash" title="Acciones"></i>
                                </th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in solicitudes_tabla %}
                            <tr class="align-middle table-row-hover clickable-row {{ s.enriched_sla_bg_class }}"
                                {% if s.id %}data-solicitud-id="{{ s.id }}"{% endif %}
                                data-etapa="{{ s.etapa_actual.nombre|default:'Sin etapa' }}"
                                data-sla="{{ s.enriched_sla_data_attr }}" 
                                {% if s.id %}onclick="handleRowClick(event, {{ s.id }})"{% endif %}
                                style="cursor: {% if s.id %}pointer{% else %}default{% endif %};">
                                <td class="text-dark">
                                    <div>
                                        <div class="fw-semibold">
                                            {% if s.id %}
                                            <a href="#" class="text-decoration-none text-success solicitud-link"
                                                title="Ver detalles de {{ s.cliente_nombre }}"
                                                onclick="event.stopPropagation();">
                                                {{ s.cliente_nombre }}
                                            </a>
                                            {% else %}
                                            <span class="text-danger" title="Solicitud sin ID válido">
                                                {{ s.cliente_nombre }}
                                            </span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">{{ s.cliente_cedula }}</small>
                                    </div>
                                </td>
                                <td class="text-dark">
                                    {{ s.producto_descripcion }}
                                    {% if s.producto_descripcion == "Préstamo de Auto" and s.cotizacion and s.cotizacion.marca %}
                                    <br><small class="text-muted"><i class="fas fa-car me-1"></i>{{ s.cotizacion.marca }} {{ s.cotizacion.modelo|default:"" }}</small>
                                    {% endif %}
                                </td>
                                <td><span class="fw-bold text-success">{{ s.monto_formateado }}</span></td>
                                <td class="text-dark">
                                    <div class="d-flex align-items-center">
                                        {% if s.propietario %}
                                        <!-- Profile picture with lazy loading and fallback -->
                                        <div class="me-2 position-relative">
                                            {% if s.propietario.profile_picture or s.propietario.avatar or s.propietario.photo %}
                                            <!-- Placeholder while loading -->
                                            <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold fallback-avatar"
                                                style="width: 32px; height: 32px; background: linear-gradient(135deg, #6c757d, #495057); font-size: 0.8rem;">
                                                {{ s.propietario.first_name|first|default:s.propietario.username|first|upper }}
                                            </div>
                                            <!-- Actual profile image -->
                                            <img 
                                                class="rounded-circle profile-img"
                                                data-src="{% if s.propietario.profile_picture %}{{ s.propietario.profile_picture.url }}{% elif s.propietario.avatar %}{{ s.propietario.avatar.url }}{% elif s.propietario.photo %}{{ s.propietario.photo.url }}{% endif %}"
                                                alt="{{ s.propietario.get_full_name|default:s.propietario.username }}"
                                                style="width: 32px; height: 32px; object-fit: cover; border: 2px solid #e9ecef; position: absolute; top: 0; left: 0; opacity: 0;"
                                                loading="lazy"
                                                title="Click para ver perfil de {{ s.propietario.get_full_name|default:s.propietario.username }}">
                                            {% else %}
                                            <!-- No profile picture - show initials avatar only -->
                                            <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
                                                style="width: 32px; height: 32px; background: linear-gradient(135deg, #6c757d, #495057); font-size: 0.8rem;"
                                                title="{{ s.propietario.get_full_name|default:s.propietario.username }}">
                                                {{ s.propietario.first_name|first|default:s.propietario.username|first|upper }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <span class="small">
                                            {{ s.propietario.get_full_name|default:s.propietario.username }}
                                        </span>
                                        {% else %}
                                        <div class="me-2 rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
                                            style="width: 32px; height: 32px; background: linear-gradient(135deg, #6c757d, #495057); font-size: 0.8rem;">
                                            ?
                                        </div>
                                        <span class="small">Sin propietario</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if s.etapa_actual and s.etapa_actual.es_bandeja_grupal %}
                                    <!-- Solicitud en bandeja grupal - deshabilitar cambio de etapa -->
                                    <div class="position-relative">
                                        <select class="form-select form-select-sm etapa-select"
                                            {% if s.id %}data-solicitud-id="{{ s.id }}"{% endif %}
                                            data-etapa-actual="{{ s.etapa_actual.id|default:'' }}"
                                            style="min-width: 120px; opacity: 0.6; cursor: not-allowed;" disabled
                                            title="Esta solicitud está en bandeja grupal. Debes esperar a que el equipo la procese antes de poder cambiar la etapa.">
                                            <option value="{{ s.etapa_actual.id }}" selected>
                                                {{ s.etapa_actual.nombre }}
                                            </option>
                                        </select>
                                        <!-- Tooltip informativo -->
                                        <div class="position-absolute top-0 start-100 ms-2" style="z-index: 1000;">
                                            <i class="fas fa-info-circle text-warning" data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="⏳ Bandeja Grupal: Esta solicitud está siendo revisada por el equipo. Debes esperar a que sea asignada o procesada antes de poder cambiar la etapa."></i>
                                        </div>
                                    </div>
                                    {% else %}
                                    <!-- Solicitud normal - permitir cambio de etapa -->
                                    <select class="form-select form-select-sm etapa-select"
                                        {% if s.id %}data-solicitud-id="{{ s.id }}"{% endif %}
                                        data-etapa-actual="{{ s.etapa_actual.id|default:'' }}"
                                        style="min-width: 120px;"
                                        {% if not s.id %}disabled title="Solicitud sin ID válido"{% endif %}>
                                        {% if not s.etapa_actual %}
                                        <option value="" selected>Sin etapa</option>
                                        {% else %}
                                        <option value="{{ s.etapa_actual.id }}" selected>
                                            {{ s.etapa_actual.nombre }}
                                        </option>
                                        {% endif %}
                                    </select>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-1">
                                        <span class="badge bg-{{ s.estado_color }}">{{ s.estado_actual }}</span>
                                        
                                        <!-- Indicador de Reconsideración - Solo en etapas Consulta y Comité de Crédito -->
                                        {% if s.enriched_es_reconsideracion and s.etapa_actual and s.etapa_actual.nombre in "Consulta,Comité de Crédito" %}
                                        <span class="badge bg-warning text-dark" 
                                              title="Solicitud en proceso de reconsideración"
                                              data-bs-toggle="tooltip" 
                                              data-bs-placement="top">
                                            <i class="fas fa-redo-alt me-1"></i>Reconsideración
                                        </span>
                                        {% endif %}
                                        
                                        {% if s.etapa_actual and s.etapa_actual.es_bandeja_grupal %}
                                        <span class="badge bg-warning"
                                            title="Bandeja Grupal - En revisión por el equipo">
                                            <i class="fas fa-users"></i>
                                        </span>
                                        {% endif %}
                                        {% if s.origen == 'Canal Digital' %}
                                        <span class="badge bg-info digital-badge"
                                            title="Solicitud del Canal Digital">
                                            Digital
                                        </span>
                                        {% endif %}
                                    </div>
                                </td>

                                <!-- Nueva columna: Fecha estado -->
                                <td>
                                    <div class="text-center">
                                        {% if s.fecha_estado %}
                                        <div class="fw-bold text-dark" style="font-size: 0.85rem;">
                                            {{ s.fecha_estado|date:"d/m/Y" }}
                                        </div>
                                        <small class="text-muted">
                                            {{ s.fecha_estado|date:"g:i A" }}
                                        </small>
                                        {% else %}
                                        <span class="text-muted small">N/A</span>
                                        {% endif %}
                                    </div>
                                </td>

                                <!-- Nueva columna: Fecha subestado -->
                                <td>
                                    <div class="text-center">
                                        {% if s.fecha_subestado %}
                                        <div class="fw-bold text-dark" style="font-size: 0.85rem;">
                                            {{ s.fecha_subestado|date:"d/m/Y" }}
                                        </div>
                                        <small class="text-muted">
                                            {{ s.fecha_subestado|date:"g:i A" }}
                                        </small>
                                        {% else %}
                                        <span class="text-muted small">N/A</span>
                                        {% endif %}
                                    </div>
                                </td>

                                <td>
                                    <div class="text-center">
                                        <div class="{{ s.sla_color }} fw-bold" title="Tiempo restante">
                                            {{ s.sla_restante }}
                                        </div>
                                        <small class="text-muted">
                                            {{ s.sla_tiempo_restante }}
                                        </small>
                                    </div>
                                </td>

                                <!-- Columna de Recordatorios y Alertas -->
                                <td>
                                    <!-- 🎯 COLUMNA INTEGRADA: RECORDATORIOS + ALERTAS -->
                                    <div class="alertas-premium-container">
                                            
                                            <!-- 🔔 RECORDATORIOS (MÁXIMA PRIORIDAD) -->
                                            {% if s.recordatorios_info.tiene_recordatorios and s.recordatorios_icon %}
                                                <div class="position-relative d-inline-block reminder-indicator">
                                                    <i class="{{ s.recordatorios_icon }} text-{{ s.recordatorios_status }}" 
                                                       title="{{ s.recordatorios_title }}"
                                                       style="font-size: 1.1rem; cursor: pointer;"
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top"
                                                       onclick="event.stopPropagation(); mostrarRecordatorios({{ s.id }})"></i>
                                                    
                                                    {% if s.recordatorios_info.total > 1 %}
                                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-{{ s.recordatorios_status }} text-white"
                                                          style="font-size: 0.6rem; padding: 0.15rem 0.3rem;">
                                                        {{ s.recordatorios_info.total }}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            {% endif %}

                                            <!-- 🔥 DOCUMENTOS URGENTES -->
                                            {% if s.alertas_info.documentos_urgentes > 0 %}
                                                <div class="alerta-premium urgente-premium" 
                                                     title="🚨 {{ s.alertas_info.documentos_urgentes }} documento(s) urgente(s)"
                                                     onclick="event.stopPropagation(); abrirModalSolicitudConTab({{ s.id }}, 'documentos-urgentes')">
                                                    <div class="icono-premium">
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                    </div>
                                                    <div class="contador-premium urgente">{{ s.alertas_info.documentos_urgentes }}</div>
                                                </div>
                                            {% endif %}

                                            <!-- 📋 DOCUMENTOS PENDIENTES -->
                                            {% if s.alertas_info.documentos_pendientes > 0 %}
                                                <div class="alerta-premium pendiente-premium" 
                                                     title="📋 {{ s.alertas_info.documentos_pendientes }} documento(s) pendiente(s)"
                                                     onclick="event.stopPropagation(); abrirModalSolicitudConTab({{ s.id }}, 'documentos-pendientes')">
                                                    <div class="icono-premium">
                                                        <i class="fas fa-clipboard-list"></i>
                                                    </div>
                                                    <div class="contador-premium pendiente">{{ s.alertas_info.documentos_pendientes }}</div>
                                                </div>
                                            {% endif %}

                                            <!-- 👤 ENTREVISTA FALTANTE -->
                                            {% if s.alertas_info.necesita_entrevista %}
                                                <div class="alerta-premium entrevista-premium" 
                                                     title="👤 Asociar entrevista de cliente"
                                                     onclick="event.stopPropagation(); abrirModalSolicitudConTab({{ s.id }}, 'entrevista')">
                                                    <div class="icono-premium">
                                                        <i class="fas fa-user-tie"></i>
                                                    </div>
                                                    <div class="indicador-premium entrevista">!</div>
                                                </div>
                                            {% endif %}
                                            
                                            <!-- ✅ SIN ALERTAS NI RECORDATORIOS -->
                                            {% if not s.recordatorios_info.tiene_recordatorios and not s.alertas_info.tiene_alertas %}
                                                <!-- Sin iconos cuando no hay nada que mostrar -->
                                            {% endif %}
                                        </div>
                                </td>

                                <td>
                                    <div class="text-center">
                                        <span class="badge bg-secondary text-white fw-bold" style="font-size: 0.75rem;">
                                            {{ s.codigo|default:"N/A" }}
                                        </span>
                                    </div>
                                </td>
                                
                                <!-- Columna de Eliminar (solo para superusuarios) -->
                                {% if user.is_superuser %}
                                <td>
                                    <div class="text-center">
                                        {% if s.id %}
                                        <button class="btn btn-outline-danger btn-sm delete-solicitud-btn" 
                                                onclick="event.stopPropagation(); confirmDeleteSolicitud({{ s.id }}, '{{ s.cliente_nombre|escapejs }}', '{{ s.codigo|escapejs }}')"
                                                title="Eliminar solicitud {{ s.codigo }}"
                                                style="padding: 4px 8px; font-size: 0.75rem; border-radius: 4px; transition: all 0.2s ease;">
                                            <i class="fas fa-trash" style="font-size: 0.7rem;"></i>
                                        </button>
                                        {% else %}
                                        <span class="text-muted" style="font-size: 0.8rem;">
                                            <i class="fas fa-ban" title="No disponible"></i>
                                        </span>
                                        {% endif %}
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{% if user.is_superuser %}12{% else %}11{% endif %}" class="text-center py-4">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No hay solicitudes para mostrar</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- Scroll hint -->
                    <div class="scroll-hint" id="scrollHint">
                        <i class="fas fa-arrows-alt-h"></i> Desliza para ver más columnas
                    </div>
                </div>

                <!-- No Data Message -->
                <div id="noDataMessage" class="no-data" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <p>No se encontraron solicitudes con los filtros aplicados</p>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Selección de Pipeline - Diseño Simplificado con Tabla -->
        <div class="card mb-4">
            <div class="card-header py-3">
                <div class="d-flex align-items-center">
                    <i class="fas fa-project-diagram text-primary me-3" style="font-size: 1.5rem;"></i>
                    <div>
                        <h4 class="mb-1 fw-bold">Selecciona un Pipeline</h4>
                        <p class="text-muted mb-0 small">Elige un pipeline para comenzar a gestionar solicitudes</p>
                    </div>
                </div>
            </div>                    <div class="card-body p-0">
                        {% if pipelines %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0 fw-semibold ps-4">Pipeline</th>
                                        <th class="border-0 fw-semibold text-center">Mis Solicitudes</th>
                                        <th class="border-0 fw-semibold text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pipeline in pipelines %}
                                    <tr class="border-bottom">
                                        <td class="ps-4 py-3">
                                            <div>
                                                <h6 class="mb-1 fw-semibold">{{ pipeline.nombre }}</h6>
                                                <p class="text-muted mb-0 small">{{ pipeline.descripcion|default:"Sin descripción"|truncatechars:80 }}</p>
                                            </div>
                                        </td>
                                        <td class="text-center py-3">
                                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2" style="font-size: 0.9rem;">
                                                <i class="fas fa-file-alt me-1"></i>{{ pipeline.user_solicitudes_count }}
                                            </span>
                                        </td>
                                        <td class="text-center py-3">
                                            <a href="?pipeline={{ pipeline.id }}" 
                                               class="btn btn-primary btn-sm" 
                                               title="Ver Solicitudes">
                                                <i class="fas fa-eye me-1"></i>Ver Solicitudes
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted mb-3">No hay pipelines disponibles</h5>
                            <p class="text-muted mb-4">No tienes acceso a ningún pipeline o no se han creado pipelines en el sistema.</p>
                            {% if user.is_superuser %}
                            <a href="{% url 'workflow:admin_pipelines' %}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Crear Primer Pipeline
                            </a>
                            {% else %}
                            <p class="text-muted small">Contacta al administrador para obtener acceso a un pipeline.</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
               
            </div>
        </div> <!-- workflow-container -->
    </div> <!-- additional closing div -->
</div> <!-- additional closing div -->

{% include 'workflow/partials/modalSolicitud.html' %}


{% endblock content %}



{% block extra_js %}
<script>
    // Set current user ID and role globally for use in drawer and other components
    window.currentUserId = {{ request.user.id|default:0 }};
    window.currentUserRole = '{{ request.user.userprofile.rol|default:"Usuario"|escapejs }}';
    window.isSuperuser = {{ request.user.is_superuser|yesno:"true,false" }};
    console.log('🔧 Current user ID set:', window.currentUserId);
    console.log('🔧 Current user role set:', window.currentUserRole);
    console.log('🔧 Is superuser:', window.isSuperuser);

    /*
     * PROFILE PICTURE OPTIMIZATION SYSTEM
     * ===================================
     * 
     * Features implemented:
     * - Lazy loading using Intersection Observer API
     * - Fallback to initials avatars on load failure
     * - Performance optimization with image preloading
     * - Responsive design with media queries
     * - Accessibility support (high contrast, reduced motion)
     * - Dynamic content support via refreshProfilePictures()
     * - Support for multiple field names (profile_picture, avatar, photo)
     * 
     * Performance optimizations:
     * - Uses IntersectionObserver for viewport-based loading
     * - Preloads first 5 images using link prefetch
     * - CSS will-change properties for smooth animations
     * - Shimmer loading effect for better UX
     * 
     * Usage:
     * - Profile pictures load automatically on page load
     * - Call refreshProfilePictures() after dynamic content updates
     * - Click on profile pictures to see user info toast
     */

    // Profile Picture Optimization and Lazy Loading
    document.addEventListener('DOMContentLoaded', function() {
        initializeProfilePictures();
    });

    function initializeProfilePictures() {
        const profileImages = document.querySelectorAll('.profile-img');
        
        // Use Intersection Observer for better performance
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        loadProfileImage(img);
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px', // Start loading 50px before image enters viewport
                threshold: 0.01
            });

            profileImages.forEach(img => {
                if (img.dataset.src) {
                    imageObserver.observe(img);
                }
            });
        } else {
            // Fallback for older browsers - load all images immediately
            profileImages.forEach(img => {
                if (img.dataset.src) {
                    loadProfileImage(img);
                }
            });
        }

        // Add click handler for profile pictures to show user info
        profileImages.forEach(img => {
            img.setAttribute('data-initialized', 'true');
            
            img.addEventListener('click', function() {
                const userName = this.alt || 'Usuario';
                const userInfo = this.closest('tr')?.querySelector('.small')?.textContent || userName;
                
                // Optional: Show user info tooltip or modal
                if (typeof showToast !== 'undefined') {
                    showToast(`👤 ${userInfo}`, 'info', 2000);
                }
            });
        });
    }

    function loadProfileImage(img) {
        const tempImg = new Image();
        const originalSrc = img.dataset.src;
        const fallback = img.previousElementSibling; // The fallback is now the previous sibling
        
        tempImg.onload = function() {
            img.src = originalSrc;
            img.style.opacity = '1';
            // Keep fallback visible behind the image as a border/shadow effect
            if (fallback && fallback.classList.contains('fallback-avatar')) {
                fallback.style.opacity = '0.3';
                fallback.style.transform = 'scale(1.1)';
            }
        };
        
        tempImg.onerror = function() {
            // Keep fallback visible on error
            img.style.display = 'none';
            if (fallback && fallback.classList.contains('fallback-avatar')) {
                fallback.style.opacity = '1';
                fallback.style.transform = 'scale(1)';
            }
        };
        
        // Start loading
        tempImg.src = originalSrc;
    }

    // Preload profile pictures for better performance
    function preloadProfilePictures() {
        const profileImages = document.querySelectorAll('.profile-img[data-src]');
        const imagesToPreload = Array.from(profileImages)
            .slice(0, 5) // Only preload first 5 images
            .map(img => img.dataset.src)
            .filter(src => src);

        imagesToPreload.forEach(src => {
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = src;
            document.head.appendChild(link);
        });
    }

    // Call preload after page load
    window.addEventListener('load', preloadProfilePictures);

    // Utility function to reinitialize profile pictures for dynamically loaded content
    window.refreshProfilePictures = function(container = document) {
        const newProfileImages = container.querySelectorAll('.profile-img:not([data-initialized])');
        
        newProfileImages.forEach(img => {
            img.setAttribute('data-initialized', 'true');
            
            // Add click handler
            img.addEventListener('click', function() {
                const userName = this.alt || 'Usuario';
                const userInfo = this.closest('tr')?.querySelector('.small')?.textContent || userName;
                
                if (typeof showToast !== 'undefined') {
                    showToast(`👤 ${userInfo}`, 'info', 2000);
                }
            });
            
            // Load image if it has data-src
            if (img.dataset.src) {
                loadProfileImage(img);
            }
        });
    };

    // Enhanced loading functions
    function showLoading(show) {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tableLoadingOverlay = document.getElementById('tableLoadingOverlay');
        const tableContainer = document.getElementById('tableContainer');
        const noDataMessage = document.getElementById('noDataMessage');
        
        if (show) {
            if (loadingIndicator) {
                loadingIndicator.style.display = 'flex';
                loadingIndicator.querySelector('.loading-text').textContent = 'Cargando solicitudes...';
            }
            if (tableLoadingOverlay) {
                tableLoadingOverlay.classList.add('show');
            }
            if (tableContainer) tableContainer.style.display = 'none';
            if (noDataMessage) noDataMessage.style.display = 'none';
        } else {
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            if (tableLoadingOverlay) {
                tableLoadingOverlay.classList.remove('show');
            }
        }
    }

    function showTableLoading(message = 'Actualizando datos...') {
        const tableLoadingOverlay = document.getElementById('tableLoadingOverlay');
        if (tableLoadingOverlay) {
            const loadingText = tableLoadingOverlay.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = message;
            }
            tableLoadingOverlay.classList.add('show');
        }
    }

    function hideTableLoading() {
        const tableLoadingOverlay = document.getElementById('tableLoadingOverlay');
        if (tableLoadingOverlay) {
            tableLoadingOverlay.classList.remove('show');
        }
    }

    // Drawer loading functions
    function showDrawerLoading(message = 'Creando solicitud...', subtext = 'Por favor espere mientras procesamos su información') {
        const drawerLoadingOverlay = document.getElementById('drawerLoadingOverlay');
        if (drawerLoadingOverlay) {
            const loadingText = drawerLoadingOverlay.querySelector('.drawer-loading-text');
            const loadingSubtext = drawerLoadingOverlay.querySelector('.drawer-loading-subtext');
            
            if (loadingText) loadingText.textContent = message;
            if (loadingSubtext) loadingSubtext.textContent = subtext;
            
            drawerLoadingOverlay.classList.add('show');
        }
    }

    function hideDrawerLoading() {
        const drawerLoadingOverlay = document.getElementById('drawerLoadingOverlay');
        if (drawerLoadingOverlay) {
            drawerLoadingOverlay.classList.remove('show');
        }
    }

    function hideLoading() {
        showLoading(false);
        hideTableLoading();
        hideDrawerLoading();
    }

    // Función global para manejar clicks en filas de la tabla
    function handleRowClick(event, solicitudId) {
        // Validate solicitud ID
        if (!solicitudId || solicitudId === '' || solicitudId === 'None' || solicitudId === 'undefined') {
            console.warn('⚠️ Cannot handle row click: Invalid solicitud ID:', solicitudId);
            return;
        }
        
        // Prevenir el click si el usuario está interactuando con elementos de formulario
        // Solo verificar si event existe (no es null)
        if (event && event.target && (
            event.target.tagName === 'SELECT' ||
            event.target.tagName === 'BUTTON' ||
            event.target.tagName === 'INPUT' ||
            event.target.closest('select') ||
            event.target.closest('button') ||
            event.target.closest('input') ||
            event.target.closest('.dropdown') ||
            event.target.closest('.menu-dropdown') ||
            event.target.closest('.reminder-indicator'))) {
            return;
        }

        // Mostrar modal con resumen de la solicitud
        if (typeof window.mostrarModalSolicitud === 'function') {
            window.mostrarModalSolicitud(solicitudId);
        } else {
            // Fallback: navegar directamente al detalle si la función modal no está disponible
            window.location.href = `/workflow/solicitud/${solicitudId}/`;
        }
    }

    // Función para mostrar recordatorios de una solicitud
    function mostrarRecordatorios(solicitudId) {
        // Validar que el ID de solicitud sea válido
        if (!solicitudId || solicitudId === '' || solicitudId === 'None' || solicitudId === 'undefined') {
            console.warn('⚠️ Cannot show reminders: Invalid solicitud ID:', solicitudId);
            return;
        }

        console.log('📝 Showing reminders for solicitud:', solicitudId);
        
        // Abrir el modal de solicitud directamente en la pestaña de notas
        if (typeof window.mostrarModalSolicitud === 'function') {
            window.mostrarModalSolicitud(solicitudId, 'notas');
        } else {
            // Fallback: navegar directamente al detalle
            window.location.href = `/workflow/solicitud/${solicitudId}/`;
        }
    }

    // Función para confirmar y eliminar una solicitud (solo superusers)
    function confirmDeleteSolicitud(solicitudId) {
        // Validar que el ID de solicitud sea válido
        if (!solicitudId || solicitudId === '' || solicitudId === 'None' || solicitudId === 'undefined') {
            console.warn('⚠️ Cannot delete: Invalid solicitud ID:', solicitudId);
            return;
        }

        // Mostrar confirmación
        const confirmarEliminar = confirm('¿Estás seguro de que deseas eliminar esta solicitud? Esta acción no se puede deshacer.');
        
        if (confirmarEliminar) {
            // Mostrar loading
            showLoading(true);
            
            fetch(`/workflow/api/solicitud/${solicitudId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.ok) {
                    // Mostrar mensaje de éxito
                    if (typeof mostrarNotificacionExito === 'function') {
                        mostrarNotificacionExito('Solicitud eliminada correctamente');
                    } else {
                        alert('Solicitud eliminada correctamente');
                    }
                    
                    // Recargar la tabla
                    if (typeof actualizarSolicitudes === 'function') {
                        actualizarSolicitudes();
                    } else {
                        location.reload();
                    }
                } else if (response.status === 403) {
                    alert('No tienes permisos para eliminar esta solicitud');
                } else if (response.status === 404) {
                    alert('La solicitud no existe o ya fue eliminada');
                } else {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
            })
            .catch(error => {
                console.error('Error al eliminar solicitud:', error);
                alert('Error al eliminar la solicitud. Por favor, inténtalo de nuevo.');
            })
            .finally(() => {
                hideLoading();
            });
        }
    }

    // Variables globales
    let currentSolicitudes = [];
    let currentFilters = {
        cliente: '',
        producto: '',
        estado: '',
        asignado: '',
        sla: '',
        prioridad: '',
        search: ''
    };

    // Función para obtener el token CSRF
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }

    // Función para inicializar datos de la tabla desde el DOM
    function initializeTableData() {
        console.log('🔄 Initializing table data...');
        
        const tableBody = document.querySelector('#tablaSolicitudes tbody');
        if (!tableBody) {
            console.warn('❌ Table body not found with selector: #tablaSolicitudes tbody');
            // Try alternative selectors
            const altTableBody = document.querySelector('.apc-table-container tbody') || 
                                 document.querySelector('table tbody') || 
                                 document.querySelector('[id*="tabla"] tbody');
            if (altTableBody) {
                console.log('✅ Found alternative table body:', altTableBody);
                tableBody = altTableBody;
            } else {
                console.error('❌ No table body found at all');
                return;
            }
        }

        currentSolicitudes = [];
        const rows = tableBody.querySelectorAll('tr');
        console.log(`🔍 Found ${rows.length} rows in table`);

        rows.forEach((row, index) => {
            if (row.querySelector('td[colspan]')) {
                console.log(`⏭️ Skipping empty row ${index}`);
                return; // Skip empty/no-data rows
            }

            const cells = row.querySelectorAll('td');
            console.log(`📋 Row ${index}: ${cells.length} cells`);
            
            if (cells.length < 8) { // Reduced minimum cell count
                console.warn(`⚠️ Row ${index} has insufficient cells (${cells.length})`);
                return;
            }

            const solicitudId = row.getAttribute('data-solicitud-id');
            if (!solicitudId || solicitudId === '' || solicitudId === 'None') {
                console.warn(`⚠️ Row ${index} with missing or invalid solicitud ID:`, solicitudId);
                return;
            }

            const solicitud = {
                id: solicitudId,
                cliente: cells[0]?.textContent?.trim() || '',
                producto: cells[1]?.textContent?.trim() || '',
                monto: cells[2]?.textContent?.trim() || '',
                propietario: cells[3]?.textContent?.trim() || '',
                etapa: row.getAttribute('data-etapa') || cells[4]?.textContent?.trim() || '',
                estado: cells[5]?.textContent?.trim() || '',
                fechaSla: cells[6]?.textContent?.trim() || '',
                sla: row.getAttribute('data-sla') || cells[7]?.textContent?.trim() || '',
                etiquetas: cells[8]?.textContent?.trim() || '',
                prioridad: cells[9]?.textContent?.trim() || '',
                element: row
            };

            console.log(`✅ Added solicitud ${index}:`, {
                id: solicitud.id,
                cliente: solicitud.cliente,
                producto: solicitud.producto,
                propietario: solicitud.propietario,
                etapa: solicitud.etapa
            });

            currentSolicitudes.push(solicitud);
        });

        console.log('📊 Datos de tabla inicializados:', currentSolicitudes.length, 'solicitudes');
        
        // If no data found, try to re-populate after a short delay
        if (currentSolicitudes.length === 0) {
            console.log('⏱️ No data found, retrying in 1 second...');
            setTimeout(() => {
                initializeTableData();
                setupFilters(); // Re-setup filters after retry
            }, 1000);
        }
    }

    // Función para configurar filtros
    function setupFilters() {
        console.log('🔧 Setting up filters...');
        
        // First try to populate filter options from DOM
        populateFilterOptions();
        
        // If no options were populated from DOM, try template fallback
        setTimeout(() => {
            const productosContainer = document.getElementById('filtroProductoOptions');
            const etapasContainer = document.getElementById('filtroEtapaOptions');
            const propietariosContainer = document.getElementById('filtroPropietarioOptions');
            
            const hasProductos = productosContainer && productosContainer.children.length > 0;
            const hasEtapas = etapasContainer && etapasContainer.children.length > 0;
            const hasPropietarios = propietariosContainer && propietariosContainer.children.length > 0;
            
            if (!hasProductos || !hasEtapas || !hasPropietarios) {
                console.log('⚠️ Some filters are empty, trying template fallback...');
                populateFiltersFromTemplate();
            }
        }, 500);

        // Setup legacy filter event listeners
        const legacyFilterElements = ['filtroSLA'];
        legacyFilterElements.forEach(filterId => {
            const element = document.getElementById(filterId);
            if (element) {
                element.addEventListener('change', applyFilters);
            }
        });

        // Setup multiselect click outside handler
        document.addEventListener('click', function(event) {
            const isMultiselectElement = event.target.closest('.multiselect-wrapper');
            if (!isMultiselectElement) {
                // Close all multiselect dropdowns
                document.querySelectorAll('.multiselect-dropdown').forEach(dropdown => {
                    dropdown.classList.add('d-none');
                });
                document.querySelectorAll('.multiselect-button').forEach(button => {
                    button.classList.remove('active');
                });
                document.querySelectorAll('.multiselect-chevron').forEach(chevron => {
                    chevron.classList.remove('rotated');
                });
            }
        });

        // Botón limpiar filtros
        const clearButton = document.getElementById('limpiarFiltros');
        if (clearButton) {
            clearButton.addEventListener('click', clearFilters);
        }
    }

    // Global filter state for multiselect filters
    const multiSelectFilters = {
        producto: [],
        etapa: [],
        propietario: []
    };

    // Ensure multiSelectFilters is properly initialized
    function ensureFilterState() {
        if (!multiSelectFilters.producto) multiSelectFilters.producto = [];
        if (!multiSelectFilters.etapa) multiSelectFilters.etapa = [];
        if (!multiSelectFilters.propietario) multiSelectFilters.propietario = [];
    }

    // Function to toggle multiselect dropdown
    function toggleMultiSelect(filterType) {
        const dropdown = document.getElementById(`${filterType}Dropdown`);
        const button = document.getElementById(`${filterType}Toggle`);
        const chevron = document.getElementById(`${filterType}Chevron`);

        if (!dropdown || !button || !chevron) return;

        const isOpen = !dropdown.classList.contains('d-none');

        // Close all other dropdowns
        document.querySelectorAll('.multiselect-dropdown').forEach(el => {
            el.classList.add('d-none');
        });
        document.querySelectorAll('.multiselect-button').forEach(el => {
            el.classList.remove('active');
        });
        document.querySelectorAll('.multiselect-chevron').forEach(el => {
            el.classList.remove('rotated');
        });

        if (!isOpen) {
            dropdown.classList.remove('d-none');
            button.classList.add('active');
            chevron.classList.add('rotated');
        }
    }

    // Function to filter dropdown options based on search
    function filterDropdownOptions(filterType) {
        const searchInput = document.getElementById(`${filterType}Search`);
        const optionsContainer = document.getElementById(`${filterType}Options`);
        
        if (!searchInput || !optionsContainer) return;

        const searchTerm = searchInput.value.toLowerCase();
        const options = optionsContainer.querySelectorAll('.multiselect-option');

        options.forEach(option => {
            const text = option.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                option.style.display = 'flex';
            } else {
                option.style.display = 'none';
            }
        });
    }

    // Function to handle option selection
    function handleOptionSelect(filterType, value, checkbox) {
        const selectedValues = multiSelectFilters[filterType];
        const index = selectedValues.indexOf(value);

        if (checkbox.checked && index === -1) {
            selectedValues.push(value);
        } else if (!checkbox.checked && index > -1) {
            selectedValues.splice(index, 1);
        }

        updateFilterLabel(filterType);
        applyMultiSelectFilters();
    }

    // Function to update filter button label
    function updateFilterLabel(filterType) {
        console.log('🏷️ Updating filter label for:', filterType);
        
        // Ensure filter state is properly initialized
        ensureFilterState();
        
        const label = document.getElementById(`${filterType}Label`);
        if (!label) {
            console.warn(`❌ Label not found: ${filterType}Label`);
            return;
        }

        // Map filter IDs to multiSelectFilters keys
        const filterKeyMap = {
            'filtroProducto': 'producto',
            'filtroEtapa': 'etapa', 
            'filtroPropietario': 'propietario',
            'producto': 'producto',
            'etapa': 'etapa',
            'propietario': 'propietario'
        };

        const filterKey = filterKeyMap[filterType];
        if (!filterKey || !multiSelectFilters[filterKey]) {
            console.warn(`❌ Invalid filter type: ${filterType}, filterKey: ${filterKey}`);
            return;
        }

        const selectedValues = multiSelectFilters[filterKey];
        console.log(`📋 Selected values for ${filterType}:`, selectedValues);

        const filterNames = {
            'filtroProducto': 'Productos',
            'filtroEtapa': 'Etapas',
            'filtroPropietario': 'Propietarios',
            'producto': 'Productos',
            'etapa': 'Etapas',
            'propietario': 'Propietarios'
        };

        const baseName = filterNames[filterType] || filterType;

        if (!selectedValues || selectedValues.length === 0) {
            label.innerHTML = baseName;
        } else if (selectedValues.length === 1) {
            label.innerHTML = `${baseName}: ${selectedValues[0]}`;
        } else {
            label.innerHTML = `${baseName} (${selectedValues.length})`;
        }
        
        console.log(`✅ Updated label for ${filterType} to:`, label.innerHTML);
    }

    // Function to apply multiselect filters by navigating to new URL
    function applyMultiSelectFilters() {
        const currentUrl = new URL(window.location);
        const params = currentUrl.searchParams;
        
        // Clear existing multiselect filter params
        params.delete('productos');
        params.delete('etapas');
        params.delete('propietarios');
        
        // Add new multiselect filter params
        if (multiSelectFilters.producto.length > 0) {
            params.set('productos', multiSelectFilters.producto.join(','));
        }
        if (multiSelectFilters.etapa.length > 0) {
            params.set('etapas', multiSelectFilters.etapa.join(','));
        }
        if (multiSelectFilters.propietario.length > 0) {
            params.set('propietarios', multiSelectFilters.propietario.join(','));
        }
        
        // Reset to first page when filters change
        params.delete('page');
        
        // Navigate to new URL with filters
        window.location.href = currentUrl.toString();
    }

    // Function to remove a specific filter value
    function removeFilterValue(filterType, value) {
        console.log('🗑️ Removing filter value:', filterType, value);
        
        // Map filter IDs to multiSelectFilters keys
        const filterKeyMap = {
            'filtroProducto': 'producto',
            'filtroEtapa': 'etapa', 
            'filtroPropietario': 'propietario',
            'producto': 'producto',
            'etapa': 'etapa',
            'propietario': 'propietario'
        };

        const filterKey = filterKeyMap[filterType];
        if (!filterKey || !multiSelectFilters[filterKey]) {
            console.warn(`❌ Invalid filter type: ${filterType}, filterKey: ${filterKey}`);
            return;
        }

        const selectedValues = multiSelectFilters[filterKey];
        const index = selectedValues.indexOf(value);
        
        if (index > -1) {
            selectedValues.splice(index, 1);
            updateFilterLabel(filterType);
            
            // Update checkbox state
            const checkbox = document.querySelector(`#${filterType}Options input[value="${value}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            applyMultiSelectFilters();
        }
    }

    // Function to populate multiselect filter options
    function populateMultiSelectOptions() {
        console.log('🔍 Populating multiselect options...');
        console.log('📊 Current solicitudes count:', currentSolicitudes.length);
        
        const filterConfigs = [
            { id: 'filtroProducto', field: 'producto', type: 'producto' },
            { id: 'filtroEtapa', field: 'etapa', type: 'etapa' },
            { id: 'filtroPropietario', field: 'propietario', type: 'propietario' }
        ];

        filterConfigs.forEach(config => {
            const optionsContainer = document.getElementById(`${config.id}Options`);
            if (!optionsContainer) {
                console.warn(`❌ Options container not found: ${config.id}Options`);
                return;
            }

            const uniqueValues = [...new Set(
                currentSolicitudes.map(s => s[config.field])
                    .filter(value => value && value.trim() !== '' && value !== 'N/A' && value !== 'Sin asignar')
            )].sort();

            console.log(`📋 ${config.type} unique values:`, uniqueValues);

            optionsContainer.innerHTML = '';

            if (uniqueValues.length === 0) {
                // Show a message if no options are available
                const noOptionsDiv = document.createElement('div');
                noOptionsDiv.className = 'multiselect-option';
                noOptionsDiv.style.color = '#6b7280';
                noOptionsDiv.style.fontStyle = 'italic';
                noOptionsDiv.innerHTML = '<span>No hay opciones disponibles</span>';
                optionsContainer.appendChild(noOptionsDiv);
                return;
            }

            uniqueValues.forEach(value => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multiselect-option';
                
                const isSelected = multiSelectFilters[config.type].includes(value);
                if (isSelected) {
                    optionDiv.classList.add('selected');
                }

                optionDiv.innerHTML = `
                    <input type="checkbox" 
                           class="multiselect-checkbox" 
                           value="${value}" 
                           ${isSelected ? 'checked' : ''}
                           onchange="handleOptionSelect('${config.type}', '${value}', this)">
                    <span>${value}</span>
                `;

                optionsContainer.appendChild(optionDiv);
            });
        });
    }

    // Function to populate legacy filter options (for compatibility)
    function populateFilterOptions() {
        populateMultiSelectOptions();
        
        // Populate legacy SLA filter
        const slaSelect = document.getElementById('filtroSLA');
        if (slaSelect) {
            const uniqueSLAValues = [...new Set(
                currentSolicitudes.map(s => s.sla)
                    .filter(value => value && value.trim() !== '')
            )].sort();

            // Clear existing options except first one
            while (slaSelect.children.length > 1) {
                slaSelect.removeChild(slaSelect.lastChild);
            }

            uniqueSLAValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                slaSelect.appendChild(option);
            });
        }
    }

    // Fallback function to get filter options from Django template data
    function populateFiltersFromTemplate() {
        console.log('🔄 Attempting to populate filters from template data...');
        
        // Get unique values from template context if available
        const templateProductos = [
            {% for s in solicitudes %}
                {% if s.producto %}'{{ s.producto|escapejs }}',{% endif %}
            {% endfor %}
        ];
        
        const templateEtapas = [
            {% for s in solicitudes %}
                {% if s.etapa_actual.nombre %}'{{ s.etapa_actual.nombre|escapejs }}',{% endif %}
            {% endfor %}
        ];
        
        const templatePropietarios = [
            {% for s in solicitudes %}
                {% if s.asignada_a.get_full_name %}'{{ s.asignada_a.get_full_name|escapejs }}',{% endif %}
            {% endfor %}
        ];

        // Remove duplicates and empty values
        const uniqueProductos = [...new Set(templateProductos.filter(p => p && p.trim()))];
        const uniqueEtapas = [...new Set(templateEtapas.filter(e => e && e.trim()))];
        const uniquePropietarios = [...new Set(templatePropietarios.filter(p => p && p.trim()))];

        console.log('📋 Template data found:', {
            productos: uniqueProductos,
            etapas: uniqueEtapas,
            propietarios: uniquePropietarios
        });

        // Populate multiselect filters with template data
        const filterConfigs = [
            { id: 'filtroProducto', values: uniqueProductos, type: 'producto' },
            { id: 'filtroEtapa', values: uniqueEtapas, type: 'etapa' },
            { id: 'filtroPropietario', values: uniquePropietarios, type: 'propietario' }
        ];

        filterConfigs.forEach(config => {
            const optionsContainer = document.getElementById(`${config.id}Options`);
            if (!optionsContainer) return;

            optionsContainer.innerHTML = '';

            if (config.values.length === 0) {
                const noOptionsDiv = document.createElement('div');
                noOptionsDiv.className = 'multiselect-option';
                noOptionsDiv.style.color = '#6b7280';
                noOptionsDiv.style.fontStyle = 'italic';
                noOptionsDiv.innerHTML = '<span>No hay opciones disponibles</span>';
                optionsContainer.appendChild(noOptionsDiv);
                return;
            }

            config.values.sort().forEach(value => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multiselect-option';
                
                const isSelected = multiSelectFilters[config.type].includes(value);
                if (isSelected) {
                    optionDiv.classList.add('selected');
                }

                optionDiv.innerHTML = `
                    <input type="checkbox" 
                           class="multiselect-checkbox" 
                           value="${value}" 
                           ${isSelected ? 'checked' : ''}
                           onchange="handleOptionSelect('${config.type}', '${value}', this)">
                    <span>${value}</span>
                `;

                optionsContainer.appendChild(optionDiv);
            });
        });
    }

    // Función para configurar búsqueda global
    function setupGlobalSearch() {
        const searchInput = document.getElementById('busquedaGlobal');
        if (searchInput) {
            searchInput.addEventListener('keyup', function () {
                currentFilters.search = this.value.toLowerCase();
                applyFilters();
            });
        }
    }

    // Función para configurar búsqueda rápida en tabla
    function setupQuickTableSearch() {
        const quickSearchInput = document.getElementById('quickTableSearch');
        const clearButton = document.getElementById('clearQuickSearch');
        const resultCountElement = document.getElementById('searchResultCount');
        const resultNumber = document.getElementById('resultCount');

        if (!quickSearchInput) return;

        function performQuickSearch() {
            const searchTerm = quickSearchInput.value.toLowerCase().trim();
            const tableRows = document.querySelectorAll('#tablaSolicitudes tbody tr[data-solicitud-id]');
            let visibleCount = 0;

            tableRows.forEach(row => {
                if (searchTerm === '') {
                    // If search is empty, show all rows that aren't hidden by other filters
                    if (!row.classList.contains('filter-hidden')) {
                        row.style.display = '';
                        visibleCount++;
                    }
                } else {
                    // Get all searchable text from the row
                    const clienteText = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
                    const productoText = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                    const propietarioText = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
                    const etapaText = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
                    const estadoText = row.querySelector('td:nth-child(6)')?.textContent.toLowerCase() || '';
                    const codigoText = row.querySelector('td:nth-child(13)')?.textContent.toLowerCase() || '';

                    const searchableText = `${clienteText} ${productoText} ${propietarioText} ${etapaText} ${estadoText} ${codigoText}`;

                    if (searchableText.includes(searchTerm) && !row.classList.contains('filter-hidden')) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });

            // Update clear button visibility
            clearButton.style.display = searchTerm ? 'block' : 'none';

            // Update result count
            if (searchTerm) {
                resultNumber.textContent = visibleCount;
                resultCountElement.style.display = 'block';
            } else {
                resultCountElement.style.display = 'none';
            }
        }

        // Event listeners
        quickSearchInput.addEventListener('input', performQuickSearch);
        quickSearchInput.addEventListener('keyup', function (e) {
            if (e.key === 'Escape') {
                this.value = '';
                performQuickSearch();
                this.blur();
            }
        });

        clearButton.addEventListener('click', function () {
            quickSearchInput.value = '';
            performQuickSearch();
            quickSearchInput.focus();
        });
    }

    // New compact search functions
    let searchTimeout;

    const handleQuickSearch = () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchTerm = document.getElementById('quickTableSearch').value.toLowerCase().trim();
            const clearButton = document.getElementById('clearQuickSearch');

            // Show/hide clear button
            if (searchTerm) {
                clearButton.style.display = 'block';
            } else {
                clearButton.style.display = 'none';
            }

            // Filter data
            filterAndRenderData(searchTerm);
        }, 300); // Debounce for 300ms
    };

    const handleClearSearch = () => {
        document.getElementById('quickTableSearch').value = '';
        document.getElementById('clearQuickSearch').style.display = 'none';
        filterAndRenderData('');
    };

    const filterAndRenderData = (searchTerm) => {
        const tableRows = document.querySelectorAll('#tablaSolicitudes tbody tr[data-solicitud-id]');
        let visibleCount = 0;

        tableRows.forEach(row => {
            if (searchTerm === '') {
                // If search is empty, show all rows that aren't hidden by other filters
                if (!row.classList.contains('filter-hidden')) {
                    row.style.display = '';
                    visibleCount++;
                }
            } else {
                // Get all searchable text from the row
                const clienteText = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
                const productoText = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                const propietarioText = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
                const etapaText = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
                const estadoText = row.querySelector('td:nth-child(6)')?.textContent.toLowerCase() || '';
                const codigoText = row.querySelector('td:nth-child(13)')?.textContent.toLowerCase() || '';

                const searchableText = `${clienteText} ${productoText} ${propietarioText} ${etapaText} ${estadoText} ${codigoText}`;

                if (searchableText.includes(searchTerm) && !row.classList.contains('filter-hidden')) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Update result count
        const resultCountElement = document.getElementById('searchResultCount');
        const resultNumber = document.getElementById('resultCount');

        if (searchTerm) {
            resultNumber.textContent = visibleCount;
            resultCountElement.style.display = 'block';
        } else {
            resultCountElement.style.display = 'none';
        }
    };

    // Función para aplicar filtros
    function applyFilters() {
        // Update legacy filters
        const legacyFilterElements = {
            sla: document.getElementById('filtroSLA')
        };

        Object.keys(legacyFilterElements).forEach(key => {
            const element = legacyFilterElements[key];
            if (element) {
                currentFilters[key] = element.value;
            }
        });

        // Filter solicitudes
        const filteredSolicitudes = currentSolicitudes.filter(solicitud => {
            // Multi-select filters
            if (multiSelectFilters.producto.length > 0 && !multiSelectFilters.producto.includes(solicitud.producto)) {
                return false;
            }
            if (multiSelectFilters.etapa.length > 0 && !multiSelectFilters.etapa.includes(solicitud.etapa)) {
                return false;
            }
            if (multiSelectFilters.propietario.length > 0 && !multiSelectFilters.propietario.includes(solicitud.propietario)) {
                return false;
            }

            // Legacy filters
            if (currentFilters.sla && solicitud.sla !== currentFilters.sla) return false;

            // Global search
            if (currentFilters.search) {
                const searchTerms = [
                    solicitud.cliente, solicitud.producto, solicitud.propietario,
                    solicitud.etapa, solicitud.estado, solicitud.etiquetas
                ].join(' ').toLowerCase();

                if (!searchTerms.includes(currentFilters.search)) return false;
            }

            return true;
        });

        // Show/hide rows
        currentSolicitudes.forEach(solicitud => {
            const isVisible = filteredSolicitudes.includes(solicitud);
            if (isVisible) {
                solicitud.element.style.display = '';
                solicitud.element.classList.remove('filter-hidden');
            } else {
                solicitud.element.style.display = 'none';
                solicitud.element.classList.add('filter-hidden');
            }
        });

        // Update results counter
        updateResultsCounter(filteredSolicitudes.length, currentSolicitudes.length);
    }

    // Función para limpiar filtros
    function clearFilters() {
        // Clear all filters by navigating to the base URL
        const currentUrl = new URL(window.location);
        const baseUrl = currentUrl.pathname;
        
        // Keep only the pipeline parameter if it exists
        const pipelineParam = currentUrl.searchParams.get('pipeline');
        let newUrl = baseUrl;
        if (pipelineParam) {
            newUrl += `?pipeline=${pipelineParam}`;
        }
        
        window.location.href = newUrl;
    }

    // Función para actualizar contador de resultados
    function updateResultsCounter(showing, total) {
        const counter = document.getElementById('resultsCounter');
        if (counter) {
            if (showing === total) {
                counter.textContent = `Mostrando ${total} solicitudes`;
            } else {
                counter.textContent = `Mostrando ${showing} de ${total} solicitudes`;
            }
        }
    }

    // Función para configurar scroll de tabla
    function setupTableScroll() {
        const tableContainer = document.getElementById('tableContainer');
        if (!tableContainer) return;

        const leftIndicator = document.getElementById('scrollLeftIndicator');
        const rightIndicator = document.getElementById('scrollRightIndicator');
        const scrollHint = document.getElementById('scrollHint');

        function updateScrollIndicators() {
            const scrollLeft = tableContainer.scrollLeft;
            const scrollWidth = tableContainer.scrollWidth;
            const clientWidth = tableContainer.clientWidth;

            if (leftIndicator) {
                leftIndicator.style.display = scrollLeft > 0 ? 'flex' : 'none';
            }

            if (rightIndicator) {
                rightIndicator.style.display = scrollLeft < (scrollWidth - clientWidth - 5) ? 'flex' : 'none';
            }

            if (scrollHint) {
                scrollHint.style.display = scrollWidth > clientWidth ? 'block' : 'none';
            }
        }

        tableContainer.addEventListener('scroll', updateScrollIndicators);
        window.addEventListener('resize', updateScrollIndicators);

        // Initial check
        setTimeout(updateScrollIndicators, 100);
    }

    // Función para scroll manual de tabla
    function scrollTable(direction) {
        const tableContainer = document.getElementById('tableContainer');
        if (!tableContainer) return;

        const scrollAmount = 300;
        const currentScroll = tableContainer.scrollLeft;

        if (direction === 'left') {
            tableContainer.scrollTo({
                left: currentScroll - scrollAmount,
                behavior: 'smooth'
            });
        } else {
            tableContainer.scrollTo({
                left: currentScroll + scrollAmount,
                behavior: 'smooth'
            });
        }
    }

    // Función para inicializar la aplicación
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Inicializando sistema de tabla mejorado...');

        // =====================================
        // INITIALIZE MULTISELECT FILTERS FROM URL
        // =====================================
        
        // Initialize multiselect filters from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        
        // Load multiselect filter values from URL
        const productosParam = urlParams.get('productos');
        if (productosParam) {
            multiSelectFilters.producto = productosParam.split(',').map(p => p.trim());
        }
        
        const etapasParam = urlParams.get('etapas');
        if (etapasParam) {
            multiSelectFilters.etapa = etapasParam.split(',').map(e => e.trim());
        }
        
        const propietariosParam = urlParams.get('propietarios');
        if (propietariosParam) {
            multiSelectFilters.propietario = propietariosParam.split(',').map(p => p.trim());
        }
        
        // Update filter labels
        updateFilterLabel('filtroProducto');
        updateFilterLabel('filtroEtapa');
        updateFilterLabel('filtroPropietario');

        // =====================================
        // SISTEMA DE REDIRECCIÓN AUTOMÁTICA DE PIPELINE
        // =====================================
        
        // Verificar si hay pipeline seleccionado y guardarlo como preferencia
        const currentPipeline = urlParams.get('pipeline');
        
        // Si hay un pipeline en la URL, mostramos notificación de que se guardó
        if (currentPipeline && currentPipeline !== '' && currentPipeline !== 'null') {
            // Solo mostrar notificación si no es la primera carga desde redirección
            const isRedirect = sessionStorage.getItem('pipeline_redirect_flag');
            if (!isRedirect) {
                setTimeout(() => {
                    if (typeof window.mostrarNotificacionExito === 'function') {
                        window.mostrarNotificacionExito('Pipeline guardado como preferencia. Al regresar a Negocios, serás redirigido automáticamente aquí.');
                    }
                }, 1000);
            }
            // Limpiar flag de redirección
            sessionStorage.removeItem('pipeline_redirect_flag');
        }
        
        // Función para limpiar pipeline guardado (opcional)
        window.clearSavedPipeline = function() {
            fetch('{% url "workflow:api_clear_saved_pipeline" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (typeof window.mostrarNotificacionExito === 'function') {
                        window.mostrarNotificacionExito('Preferencia de pipeline eliminada.');
                    }
                    // Redirigir a negocios sin filtros
                    window.location.href = '{% url "workflow:negocios" %}';
                }
            })
            .catch(error => {
                console.error('Error clearing saved pipeline:', error);
                if (typeof window.mostrarNotificacionError === 'function') {
                    window.mostrarNotificacionError('Error al eliminar preferencia de pipeline.');
                }
            });
        };
        
        // Marcar como redirección si venimos desde redirección automática
        {% if last_pipeline_saved and pipeline_filter %}
        sessionStorage.setItem('pipeline_redirect_flag', 'true');
        {% endif %}

        // Inicializar datos de la tabla desde el DOM
        initializeTableData();

        // Configurar filtros
        setupFilters();

        // Configurar búsqueda global
        setupGlobalSearch();

        // Configurar búsqueda rápida en tabla
        setupQuickTableSearch();

        // Configurar scroll de tabla
        setupTableScroll();

        // Configurar atajos de teclado
        document.addEventListener('keydown', function(e) {
            // F5 o Ctrl+R para actualizar
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                actualizarSolicitudes();
            }
        });

        // Ocultar loading
        hideLoading();

        console.log('✅ Sistema inicializado correctamente');
    });

    document.addEventListener('DOMContentLoaded', function () {

        // =====================================
        // FUNCIONES DE NOTIFICACIÓN PERSONALIZADA
        // =====================================

        function mostrarNotificacionExito(mensaje) {
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion-personalizada notificacion-exito';
            notificacion.innerHTML = `
                <div class="notificacion-contenido">
                    <i class="fas fa-check-circle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            `;

            document.body.appendChild(notificacion);

            // Animar entrada
            setTimeout(() => {
                notificacion.classList.add('show');
            }, 100);

            // Auto-remover después de 4 segundos
            setTimeout(() => {
                notificacion.classList.remove('show');
                setTimeout(() => notificacion.remove(), 300);
            }, 4000);
        }

        // Hacer la función globalmente accesible
        window.mostrarNotificacionExito = mostrarNotificacionExito;

        function mostrarNotificacionError(mensaje) {
            console.log('🚨 Mostrando notificación de error:', mensaje);

            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion-personalizada notificacion-error';
            notificacion.innerHTML = `
                <div class="notificacion-contenido">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            `;

            document.body.appendChild(notificacion);

            // Animar entrada
            setTimeout(() => {
                notificacion.classList.add('show');
            }, 100);

            // Auto-remover después de 5 segundos (más tiempo para errores)
            setTimeout(() => {
                notificacion.classList.remove('show');
                setTimeout(() => notificacion.remove(), 300);
            }, 5000);
        }

        // Hacer la función globalmente accesible
        window.mostrarNotificacionError = mostrarNotificacionError;

        function mostrarNotificacionAdvertencia(mensaje) {
            console.log('⚠️ Mostrando notificación de advertencia:', mensaje);

            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion-personalizada notificacion-advertencia';
            notificacion.innerHTML = `
                <div class="notificacion-contenido">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            `;

            document.body.appendChild(notificacion);

            // Animar entrada
            setTimeout(() => {
                notificacion.classList.add('show');
            }, 100);

            // Auto-remover después de 6 segundos (más tiempo para advertencias)
            setTimeout(() => {
                notificacion.classList.remove('show');
                setTimeout(() => notificacion.remove(), 300);
            }, 6000);
        }

        // Hacer la función globalmente accesible
        window.mostrarNotificacionAdvertencia = mostrarNotificacionAdvertencia;

        // =====================================
        // MODAL DE CONFIRMACIÓN PERSONALIZADO
        // =====================================

        // Variables globales para el modal
        let modalConfirmCallback = null;
        let modalCancelCallback = null;
        let currentEtapaId = null;
        let currentSubestados = [];

        // Función para mostrar modal de confirmación
        window.mostrarModalConfirmacion = function (nombreEtapa, onConfirm, onCancel, opciones) {
            // Opciones por defecto
            var configuracion = {
                titulo: 'Confirmar Cambio de Etapa',
                subtitulo: 'Sistema de Workflow',
                pregunta: '¿Está seguro del cambio?',
                descripcion: 'La solicitud se moverá a la siguiente etapa:',
                icono: 'fas fa-arrow-right',
                tipo: 'cambio_etapa', // cambio_etapa, eliminar, accion_general
                etapaId: null
            };

            // Sobrescribir configuración si se proporcionan opciones
            if (opciones) {
                configuracion = Object.assign(configuracion, opciones);
            }

            // Guardar el ID de etapa actual
            currentEtapaId = configuracion.etapaId;

            // Configurar para diferentes tipos de acción
            if (nombreEtapa === 'Eliminar Solicitud' || configuracion.tipo === 'eliminar') {
                configuracion.titulo = 'Confirmar Eliminación';
                configuracion.pregunta = '¿Está seguro de eliminar esta solicitud?';
                configuracion.descripcion = 'Esta acción no se puede deshacer:';
                configuracion.icono = 'fas fa-trash';
                const nombreEtapaDestino = document.getElementById('nombreEtapaDestino');
                if (nombreEtapaDestino) {
                    nombreEtapaDestino.innerHTML = '<span class="text-danger fw-bold">Esta acción es permanente</span>';
                }
                // Ocultar información de subestado para eliminación
                const informacionSubestado = document.getElementById('informacionSubestado');
                if (informacionSubestado) informacionSubestado.style.display = 'none';
            } else {
                // Para cambio de etapa normal
                const nombreEtapaDestino = document.getElementById('nombreEtapaDestino');
                if (nombreEtapaDestino) {
                    nombreEtapaDestino.textContent = nombreEtapa;
                }

                // Cargar subestados si se proporciona etapaId
                if (currentEtapaId) {
                    cargarSubestados(currentEtapaId);
                } else {
                    const informacionSubestado = document.getElementById('informacionSubestado');
                    if (informacionSubestado) informacionSubestado.style.display = 'none';
                }
            }

            // Actualizar contenido del modal
            const modalLabel = document.getElementById('modalConfirmacionEtapaLabel');
            if (modalLabel) {
                modalLabel.innerHTML = `<i class="${configuracion.icono} me-2"></i>${configuracion.titulo}`;
            }

            const modalSubtitle = modalLabel?.nextElementSibling;
            if (modalSubtitle) {
                modalSubtitle.textContent = configuracion.subtitulo;
            }

            const modalBodyH5 = document.querySelector('.modal-body h5');
            if (modalBodyH5) {
                modalBodyH5.textContent = configuracion.pregunta;
            }

            const modalBodyP = document.querySelector('.modal-body p.text-muted');
            if (modalBodyP) {
                modalBodyP.textContent = configuracion.descripcion;
            }

            const modalIcon = document.querySelector('.modal-body .text-center .fas');
            if (modalIcon) {
                modalIcon.className = configuracion.icono;
                modalIcon.style.fontSize = '2rem';
                modalIcon.style.color = '#28a745';
            }

            // Guardar callbacks
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel || function () { };

            // Mostrar el modal
            const modalElement = document.getElementById('modalConfirmacionEtapa');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Validar formulario inicial cuando se muestre el modal
            modalElement.addEventListener('shown.bs.modal', function () {
                validarFormularioModal();
            });
        };

        // Función para cargar subestados de una etapa
        function cargarSubestados(etapaId) {
            console.log('🔍 Cargando subestados para etapa:', etapaId);

            fetch(`/workflow/api/etapas/${etapaId}/subestados/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.subestados && data.subestados.length > 0) {
                        console.log('✅ Subestados cargados:', data.subestados);
                        currentSubestados = data.subestados;
                        mostrarInformacionSubestado(data.subestados);
                    } else {
                        console.log('ℹ️ No hay subestados para esta etapa');
                        const informacionSubestado = document.getElementById('informacionSubestado');
                        if (informacionSubestado) informacionSubestado.style.display = 'none';
                        currentSubestados = [];
                    }
                })
                .catch(error => {
                    console.error('❌ Error cargando subestados:', error);
                    const informacionSubestado = document.getElementById('informacionSubestado');
                    if (informacionSubestado) informacionSubestado.style.display = 'none';
                    currentSubestados = [];
                });
        }

        // Función para mostrar información del subestado (automáticamente selecciona el primero)
        function mostrarInformacionSubestado(subestados) {
            if (!subestados || subestados.length === 0) {
                const informacionSubestado = document.getElementById('informacionSubestado');
                if (informacionSubestado) informacionSubestado.style.display = 'none';
                return;
            }

            // Seleccionar automáticamente el primer subestado
            const primerSubestado = subestados[0];
            const subestadoAsignado = document.getElementById('subestadoAsignado');
            const subestadoSeleccionado = document.getElementById('subestadoSeleccionado');

            if (subestadoAsignado) {
                subestadoAsignado.textContent = primerSubestado.nombre;
            }

            if (subestadoSeleccionado) {
                subestadoSeleccionado.value = primerSubestado.id;
            }

            const informacionSubestado = document.getElementById('informacionSubestado');
            if (informacionSubestado) informacionSubestado.style.display = 'block';

            console.log('✅ Subestado asignado automáticamente:', primerSubestado);
        }

        // Función para validar el formulario del modal
        function validarFormularioModal() {
            const btnAceptar = document.getElementById('btnAceptarModal');
            if (!btnAceptar) return false;

            // Siempre válido ya que el subestado se selecciona automáticamente si existe
            btnAceptar.disabled = false;
            btnAceptar.innerHTML = '<i class="fas fa-check me-2"></i>Aceptar';
            return true;
        }

        // Event listeners para los botones del modal
        const btnAceptarModal = document.getElementById('btnAceptarModal');
        if (btnAceptarModal) {
            btnAceptarModal.addEventListener('click', function () {
                // Validar formulario antes de proceder
                if (!validarFormularioModal()) {
                    return;
                }

                // Ocultar modal
                const modalElement = document.getElementById('modalConfirmacionEtapa');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) modalInstance.hide();

                // Ejecutar callback de confirmación con datos de subestado
                if (modalConfirmCallback) {
                    const subestadoSeleccionado = document.getElementById('subestadoSeleccionado');
                    const subestadoId = subestadoSeleccionado ? subestadoSeleccionado.value : '';
                    modalConfirmCallback(subestadoId);
                }
            });
        }

        const btnCancelarModal = document.getElementById('btnCancelarModal');
        if (btnCancelarModal) {
            btnCancelarModal.addEventListener('click', function () {
                // Ocultar modal
                const modalElement = document.getElementById('modalConfirmacionEtapa');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) modalInstance.hide();

                // Ejecutar callback de cancelación
                if (modalCancelCallback) {
                    modalCancelCallback();
                }
            });
        }

        // Función para cargar transiciones válidas
        function cargarTransicionesValidas(solicitudId, select, callback) {
            console.log('🔍 Cargando transiciones válidas para solicitud:', solicitudId);

            // Deshabilitar el select mientras se cargan las transiciones
            select.disabled = true;

            // Obtener la etapa actual y opción seleccionada
            var etapaActual = select.getAttribute('data-etapa-actual') || select.dataset.etapaActual;
            var opcionSeleccionada = select.value;

            // Realizar petición AJAX
            fetch(`/workflow/api/solicitudes/${solicitudId}/transiciones-validas/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
                .then(response => {
                    console.log('🔍 DEBUG cargarTransicionesValidas: Response status:', response.status);
                    console.log('🔍 DEBUG cargarTransicionesValidas: Response ok:', response.ok);
                    console.log('🔍 DEBUG cargarTransicionesValidas: Content-Type:', response.headers.get('content-type'));

                    // Verificar si la respuesta es exitosa
                    if (!response.ok) {
                        console.error('❌ ERROR cargarTransicionesValidas: Response not ok, status:', response.status);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    // Verificar si el contenido es JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.error('❌ ERROR cargarTransicionesValidas: Content-Type no es JSON:', contentType);
                        throw new Error('La respuesta no es JSON válido');
                    }
                    console.log('✅ DEBUG cargarTransicionesValidas: Content-Type es JSON, procediendo a parsear');
                    return response.json();
                })
                .then(data => {
                    console.log('🔍 DEBUG cargarTransicionesValidas: Data recibida:', data);
                    if (data.success) {
                        // Limpiar el select
                        select.innerHTML = '';

                        // SIEMPRE agregar la etapa actual primero (si existe)
                        if (data.etapa_actual && data.etapa_actual.id) {
                            const optionActual = document.createElement('option');
                            optionActual.value = data.etapa_actual.id;
                            optionActual.className = 'text-primary fw-bold';
                            optionActual.setAttribute('data-puede-realizar', 'true');
                            optionActual.setAttribute('data-requisitos-faltantes', '0');
                            optionActual.selected = true;
                            optionActual.textContent = `${data.etapa_actual.nombre} (Actual)`;
                            select.appendChild(optionActual);
                        }

                        // Agregar las etapas válidas según las transiciones
                        data.transiciones.forEach(function (transicion) {
                            // No agregar la etapa actual nuevamente si ya está en las transiciones
                            if (data.etapa_actual && transicion.etapa_destino.id === data.etapa_actual.id) {
                                return;
                            }

                            var warningClass = !transicion.puede_realizar ? 'text-warning' : '';
                            var requisitosInfo = transicion.total_requisitos_faltantes > 0 ?
                                ` (${transicion.total_requisitos_faltantes} requisitos faltantes)` : '';

                            const optionTransicion = document.createElement('option');
                            optionTransicion.value = transicion.etapa_destino.id;
                            optionTransicion.className = warningClass;
                            optionTransicion.setAttribute('data-puede-realizar', transicion.puede_realizar);
                            optionTransicion.setAttribute('data-requisitos-faltantes', transicion.total_requisitos_faltantes);
                            optionTransicion.textContent = `${transicion.etapa_destino.nombre}${requisitosInfo}`;
                            select.appendChild(optionTransicion);
                        });

                        // Si no hay etapa actual en los datos pero sí en el select original, agregarla
                        if ((!data.etapa_actual || !data.etapa_actual.id) && etapaActual) {
                            const optionFallback = document.createElement('option');
                            optionFallback.value = etapaActual;
                            optionFallback.className = 'text-primary fw-bold';
                            optionFallback.setAttribute('data-puede-realizar', 'true');
                            optionFallback.setAttribute('data-requisitos-faltantes', '0');
                            optionFallback.selected = true;
                            optionFallback.textContent = `Etapa actual (ID: ${etapaActual})`;
                            select.appendChild(optionFallback);
                        }

                        // Actualizar data attributes
                        select.setAttribute('data-etapa-actual', etapaActual);
                        select.setAttribute('data-transiciones-cargadas', 'true');

                        // Habilitar el select
                        select.disabled = false;

                        console.log('✅ Transiciones válidas cargadas:', data.transiciones);

                        // Ejecutar callback si existe
                        if (typeof callback === 'function') {
                            callback();
                        }
                    } else {
                        console.error('❌ Error al cargar transiciones válidas:', data.error);
                        // Restaurar opciones originales en caso de error
                        restaurarOpcionesOriginales(select, etapaActual, opcionSeleccionada);
                        // Mostrar notificación de error
                        if (typeof showToast !== 'undefined') {
                            showToast('Error al cargar transiciones: ' + (data.error || 'Error desconocido'), 'error', 5000);
                        } else {
                            mostrarNotificacionError('Error al cargar transiciones: ' + (data.error || 'Error desconocido'));
                        }

                        // Ejecutar callback si existe (incluso en error)
                        if (typeof callback === 'function') {
                            callback();
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ Error en la petición de transiciones válidas:', error);
                    // Restaurar opciones originales en caso de error
                    restaurarOpcionesOriginales(select, etapaActual, opcionSeleccionada);
                    // Mostrar notificación de error más específica
                    let mensajeError = 'Error al cargar transiciones válidas';
                    if (error.message.includes('404')) {
                        mensajeError = 'No se encontró la solicitud o no tienes permisos';
                    } else if (error.message.includes('403')) {
                        mensajeError = 'No tienes permisos para ver esta solicitud';
                    } else if (error.message.includes('500')) {
                        mensajeError = 'Error interno del servidor';
                    } else if (error.message.includes('JSON')) {
                        mensajeError = 'Error en el formato de respuesta del servidor';
                    }

                    if (typeof showToast !== 'undefined') {
                        showToast(mensajeError, 'error', 5000);
                    } else {
                        mostrarNotificacionError(mensajeError);
                    }

                    // Ejecutar callback si existe (incluso en error)
                    if (typeof callback === 'function') {
                        callback();
                    }
                });
        }


        // Función auxiliar para restaurar opciones originales en caso de error
        function restaurarOpcionesOriginales(select, etapaActual, opcionSeleccionada) {
            select.disabled = false;
            select.innerHTML = '';

            // Restaurar la opción seleccionada originalmente con mejor formato
            if (etapaActual) {
                const option = document.createElement('option');
                option.value = etapaActual;
                option.selected = true;
                option.className = 'text-primary fw-bold';
                option.textContent = `📍 Etapa actual (ID: ${etapaActual})`;
                select.appendChild(option);
            }

            // Marcar como no cargado para permitir reintentos
            select.setAttribute('data-transiciones-cargadas', 'false');
        }

        // Cargar transiciones válidas inmediatamente al cargar la página
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 Cargando transiciones válidas para todos los selects de etapa...');

            // Mostrar indicador de carga global
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'text-center py-2';
            loadingIndicator.innerHTML = '<small class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Cargando transiciones válidas...</small>';

            const firstSelect = document.querySelector('.etapa-select');
            if (firstSelect) {
                const closestTd = firstSelect.closest('td');
                if (closestTd) {
                    closestTd.parentNode.insertBefore(loadingIndicator, closestTd);
                }
            }

            const etapaSelects = document.querySelectorAll('.etapa-select:not([disabled])');
            const totalSelects = etapaSelects.length;
            var loadedSelects = 0;

            etapaSelects.forEach(function (select) {
                // No cargar transiciones si el select está deshabilitado (bandeja grupal)
                if (select.disabled) {
                    console.log('❌ Select deshabilitado - no cargando transiciones');
                    return;
                }

                var solicitudId = select.getAttribute('data-solicitud-id') || select.dataset.solicitudId;
                if (!solicitudId || solicitudId === '' || solicitudId === 'None' || solicitudId === 'undefined') {
                    console.warn('⚠️ Skipping etapa select with invalid solicitud ID:', solicitudId, select);
                    return;
                }
                console.log('📋 Cargando transiciones para solicitud:', solicitudId);

                // Modificar la función para incluir callback de completado
                cargarTransicionesValidas(solicitudId, select, function () {
                    loadedSelects++;
                    if (loadedSelects >= totalSelects) {
                        // Ocultar indicador de carga cuando todos estén listos
                        loadingIndicator.style.transition = 'opacity 0.3s';
                        loadingIndicator.style.opacity = '0';
                        setTimeout(function () {
                            if (loadingIndicator.parentNode) {
                                loadingIndicator.parentNode.removeChild(loadingIndicator);
                            }
                        }, 300);
                        console.log('✅ Todas las transiciones han sido cargadas');
                    }
                });
            });

            // Si no hay selects para cargar, remover el indicador inmediatamente
            if (totalSelects === 0) {
                if (loadingIndicator.parentNode) {
                    loadingIndicator.parentNode.removeChild(loadingIndicator);
                }
            }
        });

        // Mantener el evento focus como fallback para casos donde se agreguen selects dinámicamente
        document.addEventListener('focus', function (event) {
            if (event.target.classList.contains('etapa-select')) {
                const select = event.target;

                // No cargar transiciones si el select está deshabilitado (bandeja grupal)
                if (select.disabled) {
                    console.log('❌ Select deshabilitado - no cargando transiciones');
                    return;
                }

                // Solo cargar si no se han cargado ya las transiciones (verificar si tiene data-transiciones-cargadas)
                const transicionesCargadas = select.getAttribute('data-transiciones-cargadas') === 'true';
                if (!transicionesCargadas) {
                    var solicitudId = select.getAttribute('data-solicitud-id') || select.dataset.solicitudId;
                    if (!solicitudId || solicitudId === '' || solicitudId === 'None' || solicitudId === 'undefined') {
                        console.warn('⚠️ Cannot load transitions: Invalid solicitud ID:', solicitudId);
                        return;
                    }
                    console.log('📋 Cargando transiciones en focus para solicitud:', solicitudId);
                    cargarTransicionesValidas(solicitudId, select);
                }
            }
        }, true);

        // Manejar cambio de etapa con modal personalizado
        document.addEventListener('change', function (event) {
            if (event.target.classList.contains('etapa-select')) {
                const select = event.target;

                // Verificar si el select está deshabilitado (bandeja grupal)
                if (select.disabled) {
                    console.log('❌ Select deshabilitado - solicitud en bandeja grupal');
                    // Mostrar mensaje informativo
                    if (typeof showToast !== 'undefined') {
                        showToast('⏳ Esta solicitud está en bandeja grupal. Debes esperar a que el equipo la procese antes de poder cambiar la etapa.', 'warning', 6000);
                    } else {
                        mostrarNotificacionAdvertencia('⏳ Esta solicitud está en bandeja grupal. Debes esperar a que el equipo la procese antes de poder cambiar la etapa.');
                    }
                    return; // No permitir cambios
                }

                var solicitudId = select.getAttribute('data-solicitud-id') || select.dataset.solicitudId;
                if (!solicitudId || solicitudId === '' || solicitudId === 'None' || solicitudId === 'undefined') {
                    console.warn('⚠️ Cannot process etapa change: Invalid solicitud ID:', solicitudId);
                    // Reset select to previous value
                    select.selectedIndex = 0;
                    return;
                }
                var etapaActual = select.getAttribute('data-etapa-actual') || select.dataset.etapaActual;
                var nuevaEtapaId = select.value;
                var nombreEtapa = select.options[select.selectedIndex]?.text || '';
                // Limpiar el nombre de la etapa removiendo el texto de requisitos faltantes
                nombreEtapa = nombreEtapa.replace(/\s*\(\d+\s+requisitos?\s+faltantes?\)\s*$/i, '').trim();

                console.log('🔥 CAMBIO DE ETAPA DETECTADO:');
                console.log('- Solicitud ID:', solicitudId);
                console.log('- Etapa Actual:', etapaActual);
                console.log('- Nueva Etapa ID:', nuevaEtapaId);
                console.log('- Nombre Etapa:', nombreEtapa);

                if (nuevaEtapaId === etapaActual.toString() || !nuevaEtapaId) {
                    console.log('❌ No hay cambio de etapa - valores iguales o sin selección');
                    return; // No hay cambio
                }

                // Verificar si hay requisitos faltantes
                const opcionSeleccionada = select.options[select.selectedIndex];
                const puedeRealizar = opcionSeleccionada?.getAttribute('data-puede-realizar') === 'true';
                const requisitosFaltantes = parseInt(opcionSeleccionada?.getAttribute('data-requisitos-faltantes') || '0');

                if (puedeRealizar === false || requisitosFaltantes > 0) {
                    console.log('🔍 Requisitos faltantes detectados, mostrando modal');
                    console.log('📋 Parámetros:', { solicitudId, nuevaEtapaId, nombreEtapa, puedeRealizar, requisitosFaltantes });

                    // Usar la función global correcta que maneja la carga de requisitos
                    if (typeof window.mostrarModalRequisitosFaltantes === 'function') {
                        console.log('✅ Función disponible, llamando con parámetros correctos');
                        try {
                            window.mostrarModalRequisitosFaltantes(solicitudId, nuevaEtapaId, nombreEtapa, function () {
                                // Callback de éxito - proceder con el cambio
                                console.log('✅ Requisitos completados, procediendo con cambio de etapa');
                                window.ejecutarCambioEtapa(solicitudId, nuevaEtapaId, etapaActual, select, null);
                            }, function () {
                                // Callback de cancelación
                                console.log('❌ Cambio de etapa cancelado');
                                select.value = etapaActual; // Revertir selección
                            });
                        } catch (error) {
                            console.error('❌ Error al llamar mostrarModalRequisitosFaltantes:', error);
                            alert('Error al mostrar modal de requisitos: ' + error.message);
                            select.value = etapaActual; // Revertir selección
                        }
                    } else {
                        console.error('❌ Función mostrarModalRequisitosFaltantes no disponible');
                        alert('Error: Función de requisitos no disponible');
                        select.value = etapaActual; // Revertir selección
                    }
                    return;
                }

                // Mostrar modal de confirmación personalizado
                mostrarModalConfirmacion(nombreEtapa, function (subestadoSeleccionado) {
                    // CALLBACK DE CONFIRMACIÓN
                    console.log('✅ Confirmado desde modal personalizado, ejecutando cambio de etapa');
                    console.log('🔍 Subestado seleccionado:', subestadoSeleccionado);
                    window.ejecutarCambioEtapa(solicitudId, nuevaEtapaId, etapaActual, select, subestadoSeleccionado);
                }, function () {
                    // CALLBACK DE CANCELACIÓN
                    console.log('❌ Cancelado desde modal personalizado');
                    select.value = etapaActual; // Revertir selección
                }, {
                    etapaId: nuevaEtapaId
                });
            }
        });

        // Enhanced function to update solicitudes with better loading states
        window.actualizarSolicitudes = function () {
            console.log('🔄 Actualizando lista de solicitudes...');
            
            // Show table loading overlay immediately
            showTableLoading('Actualizando solicitudes...');
            
            // Show loading in the update button
            const btnActualizar = document.getElementById('btnActualizar');
            if (btnActualizar) {
                const originalContent = btnActualizar.innerHTML;
                btnActualizar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualizando...';
                btnActualizar.disabled = true;
                btnActualizar.classList.add('btn-loading');
                
                // Show notification with better styling
                if (typeof window.mostrarNotificacionInfo === 'function') {
                    window.mostrarNotificacionInfo('🔄 Actualizando lista de solicitudes...');
                } else if (typeof window.mostrarNotificacionAdvertencia === 'function') {
                    window.mostrarNotificacionAdvertencia('Actualizando lista de solicitudes...');
                }
                
                // Add smooth transition effect
                const tableContainer = document.getElementById('tableContainer');
                if (tableContainer) {
                    tableContainer.style.transition = 'opacity 0.3s ease';
                    tableContainer.style.opacity = '0.7';
                }
                
                // Reload page after showing loading states
                setTimeout(() => {
                    window.location.reload();
                }, 800); // Slightly longer delay for better UX
            } else {
                // Fallback if button not found
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            }
        };

        // Actualizar estado de botones según vista actual
        document.addEventListener('DOMContentLoaded', function () {
            // Always table view - no need for view switching
            const btnVistaTabla = document.getElementById('btnVistaTabla');
            if (btnVistaTabla) {
                btnVistaTabla.classList.add('active', 'btn-light');
            }
        });
    });
</script>


<!-- incluir estilos de negocios_styles.html -->
{% include "workflow/partials/negocios_styles.html" %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Inicializando sistema de requisitos faltantes');

        // Verificar que todas las funciones estén disponibles
        if (window.verificarFuncionesRequisitos) {
            window.verificarFuncionesRequisitos();
        }

        // Verificar que el modal esté disponible
        const modalElement = document.getElementById('modalRequisitosFaltantes');
        if (modalElement) {
            console.log('✅ Modal de requisitos faltantes encontrado');
        } else {
            console.error('❌ Modal de requisitos faltantes no encontrado');
        }

        // Horizontal scroll functionality for table - Matching APC Tracking
        const tableContainer = document.getElementById('tableContainer');
        const scrollLeftIndicator = document.getElementById('scrollLeftIndicator');
        const scrollRightIndicator = document.getElementById('scrollRightIndicator');
        const scrollHint = document.getElementById('scrollHint');

        if (tableContainer && scrollLeftIndicator && scrollRightIndicator) {
            let scrollHintTimeout;

            // Function to update scroll indicators visibility
            function updateScrollIndicators() {
                const scrollLeft = tableContainer.scrollLeft;
                const scrollWidth = tableContainer.scrollWidth;
                const clientWidth = tableContainer.clientWidth;
                const maxScrollLeft = scrollWidth - clientWidth;

                // Show/hide left indicator
                if (scrollLeft > 10) {
                    scrollLeftIndicator.classList.add('visible');
                } else {
                    scrollLeftIndicator.classList.remove('visible');
                }

                // Show/hide right indicator
                if (scrollLeft < maxScrollLeft - 10) {
                    scrollRightIndicator.classList.add('visible');
                } else {
                    scrollRightIndicator.classList.remove('visible');
                }
            }

            // Function to show scroll hint
            function showScrollHint() {
                if (scrollHint) {
                    scrollHint.classList.add('visible');
                    clearTimeout(scrollHintTimeout);
                    scrollHintTimeout = setTimeout(() => {
                        scrollHint.classList.remove('visible');
                    }, 3000);
                }
            }

            // Update indicators on scroll
            tableContainer.addEventListener('scroll', updateScrollIndicators);

            // Add click handlers for scroll indicators
            scrollLeftIndicator.addEventListener('click', function () {
                window.scrollTable('left');
            });

            scrollRightIndicator.addEventListener('click', function () {
                window.scrollTable('right');
            });

            // Initial check and show hint if scrollable
            setTimeout(() => {
                updateScrollIndicators();
                if (tableContainer.scrollWidth > tableContainer.clientWidth) {
                    showScrollHint();
                }
            }, 500);

            // Update on window resize
            window.addEventListener('resize', updateScrollIndicators);

            // Hide hint on user interaction
            tableContainer.addEventListener('scroll', () => {
                if (scrollHint) {
                    scrollHint.classList.remove('visible');
                }
            });
        }

        // Manejar edición de etiquetas con select
        document.querySelectorAll('.etiquetas-select').forEach(function (select) {
            select.addEventListener('change', function (e) {
                const solicitudId = e.target.dataset.id;
                const nuevaEtiqueta = e.target.value;

                e.target.disabled = true;

                fetch(`/workflow/api/solicitudes/${solicitudId}/actualizar-etiquetas/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ etiquetas_oficial: nuevaEtiqueta })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            e.target.style.borderColor = '#22c55e';
                            setTimeout(() => {
                                e.target.style.borderColor = '';
                            }, 1000);
                        } else {
                            e.target.style.borderColor = '#ef4444';
                            alert(data.error || 'Error al guardar etiqueta');
                        }
                    })
                    .catch(error => {
                        e.target.style.borderColor = '#ef4444';
                        alert('Error de conexión');
                    })
                    .finally(() => {
                        e.target.disabled = false;
                    });
            });
        });

        // Manejar edición de prioridad
        document.querySelectorAll('.prioridad-select').forEach(function (select) {
            select.addEventListener('change', function (e) {
                const solicitudId = e.target.dataset.id;
                const nuevaPrioridad = e.target.value;
                fetch(`/workflow/api/solicitudes/${solicitudId}/actualizar-prioridad/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ prioridad: nuevaPrioridad })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Cambia color del fondo según la prioridad seleccionada
                            if (nuevaPrioridad === 'Alta') {
                                e.target.style.backgroundColor = '#fee2e2';
                                e.target.style.color = '#b91c1c';
                            } else if (nuevaPrioridad === 'Media') {
                                e.target.style.backgroundColor = '#fef9c3';
                                e.target.style.color = '#b45309';
                            } else if (nuevaPrioridad === 'Baja') {
                                e.target.style.backgroundColor = '#dcfce7';
                                e.target.style.color = '#166534';
                            } else {
                                e.target.style.backgroundColor = 'white';
                                e.target.style.color = '#333';
                            }
                        } else {
                            alert(data.error || 'Error al guardar prioridad');
                        }
                    });
            });
        });
    });

    // Table view initialization only
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🎯 Inicializando vista de tabla');
    });

    // All Kanban functions removed - table view only

    // Utility function for debouncing
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Function to scroll table horizontally - Matching APC Tracking
    window.scrollTable = function (direction) {
        const tableContainer = document.getElementById('tableContainer');
        if (tableContainer) {
            const scrollAmount = 300;
            const currentScroll = tableContainer.scrollLeft;

            if (direction === 'left') {
                tableContainer.scrollTo({
                    left: currentScroll - scrollAmount,
                    behavior: 'smooth'
                });
            } else if (direction === 'right') {
                tableContainer.scrollTo({
                    left: currentScroll + scrollAmount,
                    behavior: 'smooth'
                });
            }
        }
    };
</script>







<!-- JavaScript functions for drawer functionality -->
<script>
    // Define functions immediately to ensure they're available
    (function () {
        // Search functionality variables
        let searchTimeout;
        let currentSearchType = '';

        // Debug function to test drawer opening
        window.testDrawer = function() {
            console.log('🧪 Testing drawer functionality...');
            const drawer = document.getElementById('solicitudDrawer');
            console.log('Drawer element:', drawer);
            console.log('Drawer classes:', drawer ? drawer.classList : 'DRAWER NOT FOUND');
            console.log('Drawer display:', drawer ? window.getComputedStyle(drawer).display : 'DRAWER NOT FOUND');
            console.log('Drawer opacity:', drawer ? window.getComputedStyle(drawer).opacity : 'DRAWER NOT FOUND');
            
            if (drawer) {
                drawer.style.display = 'flex';
                drawer.style.opacity = '1';
                drawer.classList.add('active');
                console.log('✅ Drawer should be visible now');
            }
        };

        // Ensure drawer functions are available globally
        window.openSolicitudDrawerWithContext = function (pipelineId = null) {
            console.log('🔧 openSolicitudDrawerWithContext called with pipelineId:', pipelineId);
            console.log('🔍 Document ready state:', document.readyState);

            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                console.log('⏳ Waiting for DOM to be ready...');
                document.addEventListener('DOMContentLoaded', function() {
                    window.openSolicitudDrawerWithContext(pipelineId);
                });
                return;
            }

            // Check if drawer exists
            const drawer = document.getElementById('solicitudDrawer');
            if (!drawer) {
                console.error('❌ Drawer element not found!');
                console.log('🔍 Available elements with "drawer" in ID:', 
                    document.querySelectorAll('[id*="drawer"]'));
                console.log('🔍 All elements with ID starting with "solicitud":', 
                    document.querySelectorAll('[id^="solicitud"]'));
                alert('Error: Drawer not found. Please refresh the page.');
                return;
            }

            console.log('🎯 Drawer element found:', drawer);
            console.log('🔍 Current drawer classes:', Array.from(drawer.classList));
            console.log('🔍 Current drawer display:', window.getComputedStyle(drawer).display);
            console.log('🔍 Current drawer opacity:', window.getComputedStyle(drawer).opacity);
            console.log('🔍 Current drawer z-index:', window.getComputedStyle(drawer).zIndex);

            // Close any open modals first
            const openModals = document.querySelectorAll('.modal.show');
            console.log('🔍 Found open modals:', openModals.length);
            openModals.forEach((modal, index) => {
                console.log(`🔍 Closing modal ${index}:`, modal.id);
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            });

            // Check if there are any modal backdrops that might interfere
            const modalBackdrops = document.querySelectorAll('.modal-backdrop');
            console.log('🔍 Found modal backdrops:', modalBackdrops.length);
            modalBackdrops.forEach((backdrop, index) => {
                console.log(`🔍 Removing modal backdrop ${index}`);
                backdrop.remove();
            });

            // Force immediate display
            drawer.style.display = 'flex';
            drawer.style.opacity = '0';
            console.log('🔧 Set drawer display to flex and opacity to 0');
            
            // Use requestAnimationFrame to ensure proper rendering
            requestAnimationFrame(() => {
                console.log('🎬 Animation frame - adding active class');
                drawer.classList.add('active');
                drawer.style.opacity = '1';
                document.body.style.overflow = 'hidden';

                console.log('🔍 After activation - drawer classes:', Array.from(drawer.classList));
                console.log('🔍 After activation - drawer display:', window.getComputedStyle(drawer).display);
                console.log('🔍 After activation - drawer opacity:', window.getComputedStyle(drawer).opacity);

                // If pipelineId is provided, lock the pipeline selection
                if (pipelineId) {
                    console.log('🔒 Locking pipeline:', pipelineId);
                    setTimeout(() => {
                        if (typeof lockPipeline === 'function') {
                            lockPipeline(pipelineId);
                        } else {
                            console.warn('⚠️ lockPipeline function not found');
                        }
                    }, 100);
                }

                // Update button state after drawer is loaded
                setTimeout(() => {
                    if (typeof window.updateCreateButtonState === 'function') {
                        window.updateCreateButtonState();
                        console.log('🔄 Initial button state updated');
                    } else {
                        console.warn('⚠️ updateCreateButtonState function not found');
                    }
                }, 200);

                console.log('✅ Drawer opened successfully');
            });
        };

        // Also define the base openSolicitudDrawer function
        window.openSolicitudDrawer = function (pipelineId = null) {
            console.log('🔧 openSolicitudDrawer called with pipelineId:', pipelineId);

            const drawer = document.getElementById('solicitudDrawer');
            if (!drawer) {
                console.error('❌ Drawer element not found!');
                return;
            }

            drawer.classList.add('active');
            document.body.style.overflow = 'hidden';

            if (pipelineId) {
                lockPipeline(pipelineId);
            }
        };

        window.lockPipeline = function (pipelineId) {
            console.log('🔒 lockPipeline called with:', pipelineId);

            const pipelineSelect = document.getElementById('pipelineSelect');
            const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');
            const pipelineLockedName = document.getElementById('pipelineLockedName');

            if (!pipelineSelect || !pipelineLockedInfo || !pipelineLockedName) {
                console.error('❌ Pipeline elements not found!');
                return;
            }

            // Set and disable the select
            pipelineSelect.value = pipelineId;
            pipelineSelect.disabled = true;
            pipelineSelect.style.display = 'none';

            console.log('🔒 Pipeline select value set to:', pipelineSelect.value);
            console.log('🔒 Pipeline select disabled:', pipelineSelect.disabled);
            console.log('🔒 Pipeline select display:', pipelineSelect.style.display);

            // Show locked info
            const selectedOption = pipelineSelect.options[pipelineSelect.selectedIndex];
            if (selectedOption) {
                pipelineLockedName.textContent = selectedOption.text;
                pipelineLockedInfo.style.display = 'block';

                console.log('🔒 Pipeline locked info displayed:', pipelineLockedInfo.style.display);
                console.log('🔒 Pipeline locked name:', pipelineLockedName.textContent);

                // Load form data for the locked pipeline
                loadFormularioData(pipelineId);
            }

            console.log('✅ Pipeline locked successfully');
        };

        window.closeSolicitudDrawer = function () {
            console.log('🔧 closeSolicitudDrawer called');

            const drawer = document.getElementById('solicitudDrawer');
            if (drawer) {
                drawer.classList.remove('active');
                drawer.style.opacity = '0';
                
                // Wait for transition to complete before hiding
                setTimeout(() => {
                    drawer.style.display = 'none';
                }, 300);
                
                document.body.style.overflow = '';
                resetForm();
                console.log('✅ Drawer closed successfully');
            }
        };

        window.resetForm = function () {
            console.log('🔧 resetForm called');

            const form = document.getElementById('solicitudForm');
            if (form) {
                form.reset();
            }

            // Reset hidden inputs
            const cotizacionId = document.getElementById('cotizacionId');
            const clienteId = document.getElementById('clienteId');
            if (cotizacionId) cotizacionId.value = '';
            if (clienteId) clienteId.value = '';

            // Reset selected displays
            const cotizacionSelected = document.getElementById('cotizacionSelected');
            const clienteSelected = document.getElementById('clienteSelected');
            const clientePlaceholder = document.getElementById('clientePlaceholder');

            if (cotizacionSelected) cotizacionSelected.style.display = 'none';
            if (clienteSelected) {
                clienteSelected.style.display = 'none';
                clienteSelected.classList.remove('auto-populated');

                // Remove auto-populated indicator
                const indicator = clienteSelected.querySelector('.auto-populated-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            if (clientePlaceholder) {
                clientePlaceholder.style.display = 'block';
            }

            // Clear search inputs
            const cotizacionSearch = document.getElementById('cotizacionSearch');
            if (cotizacionSearch) cotizacionSearch.value = '';

            // Reset campos personalizados
            const camposContainer = document.getElementById('camposContainer');
            if (camposContainer) {
                camposContainer.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                Selecciona un pipeline para ver los campos personalizados
            </div>
        `;
            }

            // Reset requisitos
            const requisitosContainer = document.getElementById('requisitosContainer');
            if (requisitosContainer) {
                requisitosContainer.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                Selecciona un pipeline para ver los requisitos
            </div>
        `;
            }

            // Reset pipeline lock
            const pipelineSelect = document.getElementById('pipelineSelect');
            const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');
            if (pipelineSelect) {
                pipelineSelect.disabled = false;
                pipelineSelect.style.display = 'block';
                console.log('🔧 Pipeline select reset - disabled:', pipelineSelect.disabled, 'display:', pipelineSelect.style.display);
            }
            if (pipelineLockedInfo) {
                pipelineLockedInfo.style.display = 'none';
                console.log('🔧 Pipeline locked info reset - display:', pipelineLockedInfo.style.display);
            }

            // Hide dynamic sections
            const motivoSection = document.getElementById('motivoConsultaSection');
            const comoSeEnteroSection = document.getElementById('comoSeEnteroSection');
            const apcMakitoSection = document.getElementById('apcMakitoSection');
            const suraMakitoSection = document.getElementById('suraMakitoSection');
            const cotizacionFieldsSection = document.getElementById('cotizacionFieldsSection');

            if (motivoSection) {
                motivoSection.classList.remove('show');
            }
            if (comoSeEnteroSection) {
                comoSeEnteroSection.classList.remove('show');
            }
            if (apcMakitoSection) {
                apcMakitoSection.classList.remove('show');
                // Reset APC specific fields
                const apcCheckbox = document.getElementById('descargarApcMakito');
                const apcCamposAdicionales = document.getElementById('apcCamposAdicionales');
                const apcTipoDocumento = document.getElementById('apcTipoDocumento');
                const apcNoCedula = document.getElementById('apcNoCedula');

                if (apcCheckbox) apcCheckbox.checked = false;
                if (apcCamposAdicionales) apcCamposAdicionales.style.display = 'none';
                if (apcTipoDocumento) apcTipoDocumento.value = '';
                if (apcNoCedula) apcNoCedula.value = '';
            }
            if (suraMakitoSection) {
                suraMakitoSection.classList.remove('show');
                // Reset SURA specific fields
                const suraCheckbox = document.getElementById('cotizarSuraMakito');
                const suraCamposAdicionales = document.getElementById('suraCamposAdicionales');
                const suraPrimerNombre = document.getElementById('suraPrimerNombre');
                const suraSegundoNombre = document.getElementById('suraSegundoNombre');
                const suraPrimerApellido = document.getElementById('suraPrimerApellido');
                const suraSegundoApellido = document.getElementById('suraSegundoApellido');
                const suraNoDocumento = document.getElementById('suraNoDocumento');

                if (suraCheckbox) suraCheckbox.checked = false;
                if (suraCamposAdicionales) suraCamposAdicionales.style.display = 'none';
                if (suraPrimerNombre) suraPrimerNombre.value = '';
                if (suraSegundoNombre) suraSegundoNombre.value = '';
                if (suraPrimerApellido) suraPrimerApellido.value = '';
                if (suraSegundoApellido) suraSegundoApellido.value = '';
                if (suraNoDocumento) suraNoDocumento.value = '';
            }
            
            // Hide cotización fields section
            if (cotizacionFieldsSection) {
                cotizacionFieldsSection.style.display = 'none';
                console.log('🔧 Cotización fields section hidden on reset');
            }

            hideSearchResults();
            console.log('✅ Form reset successfully');
        };

        window.loadFormularioData = function (pipelineId) {
            console.log('🔧 loadFormularioData called with pipelineId:', pipelineId);

            fetch(`/workflow/api/formulario-datos/?pipeline_id=${pipelineId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('✅ Form data loaded:', data);
                        renderCamposPersonalizados(data.campos_personalizados);
                        renderRequisitos(data.requisitos);
                    } else {
                        console.error('❌ Error loading form data:', data.error);
                    }
                })
                .catch(error => {
                    console.error('❌ Error loading form data:', error);
                });
        };

        window.hideSearchResults = function (type) {
            if (type) {
                const results = document.getElementById(`${type}Results`);
                if (results) results.classList.remove('show');
            } else {
                const cotizacionResults = document.getElementById('cotizacionResults');
                if (cotizacionResults) cotizacionResults.classList.remove('show');
            }
        };

        // Initialize drawer functionality when page loads
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 Initializing drawer functionality...');

            // Drawer click outside handler disabled - drawer won't close when clicking outside
            const drawer = document.getElementById('solicitudDrawer');
            if (drawer) {
                // Event listener removed to prevent drawer from closing when clicking outside
                console.log('✅ Drawer click outside handler disabled (drawer stays open when clicking outside)');
            }

            // Setup search functionality if elements exist
            const cotizacionSearch = document.getElementById('cotizacionSearch');
            if (cotizacionSearch) {
                setupSearch();
                console.log('✅ Search functionality initialized');
            }

            // Setup APC Makito functionality
            setupApcMakitoToggle();
            console.log('✅ APC Makito functionality initialized');

            // Setup SURA Makito functionality
            setupSuraMakitoToggle();
            console.log('✅ SURA Makito functionality initialized');

            console.log('✅ Drawer functionality initialized successfully');
        });

        // Fallback function in case the drawer functions are not loaded
        window.openSolicitudDrawer = function (pipelineId = null) {
            console.log('🔧 openSolicitudDrawer fallback called with pipelineId:', pipelineId);
            openSolicitudDrawerWithContext(pipelineId);
        };

        // Missing functions that are referenced but not defined
        window.renderCamposPersonalizados = function (campos) {
            console.log('🔧 renderCamposPersonalizados called with:', campos);

            const container = document.getElementById('camposContainer');
            if (!container) {
                console.error('❌ camposContainer not found!');
                return;
            }

            container.innerHTML = '';

            if (!campos || campos.length === 0) {
                container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                No hay campos personalizados para este pipeline
            </div>
        `;
                return;
            }

            campos.forEach(campo => {
                const campoDiv = document.createElement('div');
                campoDiv.className = 'campo-dinamico';

                let inputHtml = '';
                const required = campo.requerido ? 'required' : '';
                const requiredStar = campo.requerido ? '<span class="campo-required">*</span>' : '';

                switch (campo.tipo) {
                    case 'texto':
                        inputHtml = `<input type="text" class="form-control" name="campo_${campo.id}" ${required}>`;
                        break;
                    case 'numero':
                        inputHtml = `<input type="number" step="0.01" class="form-control" name="campo_${campo.id}" ${required}>`;
                        break;
                    case 'entero':
                        inputHtml = `<input type="number" class="form-control" name="campo_${campo.id}" ${required}>`;
                        break;
                    case 'fecha':
                        inputHtml = `<input type="date" class="form-control" name="campo_${campo.id}" ${required}>`;
                        break;
                    case 'booleano':
                        inputHtml = `
                    <select class="form-control" name="campo_${campo.id}" ${required}>
                        <option value="">Seleccionar...</option>
                        <option value="true">Sí</option>
                        <option value="false">No</option>
                    </select>
                `;
                        break;
                }

                campoDiv.innerHTML = `
            <label class="campo-label">
                ${campo.nombre} ${requiredStar}
            </label>
            ${inputHtml}
        `;

                container.appendChild(campoDiv);
            });

            console.log('✅ Campos personalizados rendered successfully');
        };

        window.renderRequisitos = function (requisitos) {
            console.log('🔧 renderRequisitos called with:', requisitos);

            const container = document.getElementById('requisitosContainer');
            if (!container) {
                console.error('❌ requisitosContainer not found!');
                return;
            }

            container.innerHTML = '';

            if (!requisitos || requisitos.length === 0) {
                container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                No hay requisitos para este pipeline
            </div>
        `;
                return;
            }

            requisitos.forEach(requisito => {
                const requisitoDiv = document.createElement('div');
                requisitoDiv.className = 'requisito-item';

                requisitoDiv.innerHTML = `
            <div class="requisito-header">
                <div class="requisito-info">
                    <div class="requisito-nombre">
                        ${requisito.nombre}
                        ${requisito.obligatorio ? '<span class="requisito-obligatorio">(Obligatorio)</span>' : ''}
                    </div>
                    ${requisito.descripcion ? `<div class="requisito-descripcion">${requisito.descripcion}</div>` : ''}
                </div>
            </div>
            <div class="requisito-upload">
                <label class="file-upload-label">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Subir archivo
                    <input type="file" class="file-upload-input" name="archivo_requisito_${requisito.id}" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.zip,.rar">
                </label>
                <div class="file-upload-info">
                    <small class="text-muted">Formatos permitidos: PDF, DOC, DOCX, JPG, PNG, GIF, ZIP, RAR</small>
                </div>
                <div class="file-selected" style="display: none;">
                    <i class="fas fa-file me-2"></i>
                    <span class="file-name"></span>
                    <button type="button" class="btn-remove-file" onclick="removeFile(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;

                container.appendChild(requisitoDiv);
            });

            // Setup file upload handlers after rendering
            setTimeout(() => {
                setupFileUploadHandlers();
            }, 100);

            console.log('✅ Requisitos rendered successfully');
        };

        // Setup APC Makito toggle functionality
        window.setupApcMakitoToggle = function () {
            console.log('🔧 setupApcMakitoToggle called');

            const apcCheckbox = document.getElementById('descargarApcMakito');
            const apcCamposAdicionales = document.getElementById('apcCamposAdicionales');

            if (apcCheckbox && apcCamposAdicionales) {
                apcCheckbox.addEventListener('change', function () {
                    if (this.checked) {
                        apcCamposAdicionales.style.display = 'block';
                        console.log('✅ APC campos adicionales shown');

                        // Auto-populate APC fields if a client is already selected
                        const clienteId = document.getElementById('clienteId')?.value;
                        if (clienteId) {
                            // Get client data from the selected client display
                            const clienteSelected = document.getElementById('clienteSelected');
                            if (clienteSelected && clienteSelected.style.display !== 'none') {
                                const clienteDetails = clienteSelected.querySelector('.selected-details')?.textContent;
                                if (clienteDetails) {
                                    // Extract cedula from the details text (format: "cedula • other info")
                                    const cedulaMatch = clienteDetails.match(/^([^•]+)/);
                                    if (cedulaMatch) {
                                        const cedula = cedulaMatch[1].trim();
                                        if (cedula && cedula !== 'Sin cédula') {
                                            const clienteData = { cedulaCliente: cedula };
                                            if (typeof autoPopulateApcFields === 'function') {
                                                autoPopulateApcFields(clienteData);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } else {
                        apcCamposAdicionales.style.display = 'none';
                        // Clear the fields when hiding
                        if (typeof clearApcFields === 'function') {
                            clearApcFields();
                        } else {
                            // Fallback to direct clearing
                            const tipoDocumento = document.getElementById('apcTipoDocumento');
                            const noCedula = document.getElementById('apcNoCedula');
                            if (tipoDocumento) tipoDocumento.value = '';
                            if (noCedula) noCedula.value = '';
                        }
                        console.log('✅ APC campos adicionales hidden and cleared');
                    }
                });
                console.log('✅ APC checkbox event listener added');
            } else {
                console.log('⚠️ APC elements not found');
            }
        };

        // Setup SURA Makito toggle functionality
        window.setupSuraMakitoToggle = function () {
            console.log('🔧 setupSuraMakitoToggle called');

            const suraCheckbox = document.getElementById('cotizarSuraMakito');
            const suraCamposAdicionales = document.getElementById('suraCamposAdicionales');

            if (suraCheckbox && suraCamposAdicionales) {
                suraCheckbox.addEventListener('change', function () {
                    if (this.checked) {
                        suraCamposAdicionales.style.display = 'block';
                        console.log('✅ SURA campos adicionales shown');
                        console.log('🔧 SURA checkbox checked - checking for cotización data:', window.selectedCotizacionData);

                        // Auto-populate SURA fields if a client is already selected
                        const clienteId = document.getElementById('clienteId')?.value;
                        if (clienteId) {
                            // Get client data from the selected client display
                            const clienteSelected = document.getElementById('clienteSelected');
                            if (clienteSelected && clienteSelected.style.display !== 'none') {
                                const clienteDetails = clienteSelected.querySelector('.selected-details')?.textContent;
                                if (clienteDetails) {
                                    // Extract cedula from the details text (format: "cedula • other info")
                                    const cedulaMatch = clienteDetails.match(/^([^•]+)/);
                                    if (cedulaMatch) {
                                        const cedula = cedulaMatch[1].trim();
                                        if (cedula && cedula !== 'Sin cédula') {
                                            const clienteData = { cedulaCliente: cedula };
                                            if (typeof autoPopulateSuraFields === 'function') {
                                                // Pass both cliente data and stored cotización data
                                                autoPopulateSuraFields(clienteData, window.selectedCotizacionData);
                                            }
                                        }
                                    }
                                }
                            }
                        } else if (window.selectedCotizacionData) {
                            // If no client is selected but we have cotización data, still auto-populate vehicle fields
                            if (typeof autoPopulateSuraFields === 'function') {
                                autoPopulateSuraFields(null, window.selectedCotizacionData);
                            }
                        }
                    } else {
                        suraCamposAdicionales.style.display = 'none';
                        // Clear the fields when hiding
                        if (typeof clearSuraFields === 'function') {
                            clearSuraFields();
                        } else {
                            // Fallback to direct clearing
                            const primerNombre = document.getElementById('suraPrimerNombre');
                            const segundoNombre = document.getElementById('suraSegundoNombre');
                            const primerApellido = document.getElementById('suraPrimerApellido');
                            const segundoApellido = document.getElementById('suraSegundoApellido');
                            const noDocumento = document.getElementById('suraNoDocumento');
                            if (primerNombre) primerNombre.value = '';
                            if (segundoNombre) segundoNombre.value = '';
                            if (primerApellido) primerApellido.value = '';
                            if (segundoApellido) segundoApellido.value = '';
                            if (noDocumento) noDocumento.value = '';
                        }
                        console.log('✅ SURA campos adicionales hidden and cleared');
                    }
                });
                console.log('✅ SURA checkbox event listener added');
            } else {
                console.log('⚠️ SURA elements not found');
            }
        };

        window.setupSearch = function () {
            console.log('🔧 setupSearch called');

            // Cotización search
            const cotizacionSearch = document.getElementById('cotizacionSearch');
            if (cotizacionSearch) {
                cotizacionSearch.addEventListener('input', function (e) {
                    clearTimeout(searchTimeout);
                    const query = e.target.value;
                    if (query.length < 2) {
                        hideSearchResults('cotizacion');
                        return;
                    }
                    searchTimeout = setTimeout(() => {
                        searchCotizaciones(query);
                    }, 300);
                });
            }



            // Pipeline change
            const pipelineSelect = document.getElementById('pipelineSelect');
            if (pipelineSelect) {
                pipelineSelect.addEventListener('change', function (e) {
                    const pipelineId = e.target.value;
                    if (pipelineId) {
                        loadFormularioData(pipelineId);
                    } else {
                        // Reset to placeholder messages
                        const camposContainer = document.getElementById('camposContainer');
                        const requisitosContainer = document.getElementById('requisitosContainer');

                        if (camposContainer) {
                            camposContainer.innerHTML = `
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona un pipeline para ver los campos personalizados
                        </div>
                    `;
                        }

                        if (requisitosContainer) {
                            requisitosContainer.innerHTML = `
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona un pipeline para ver los requisitos
                        </div>
                    `;
                        }
                    }
                });
            }

            console.log('✅ Search functionality setup successfully');
        };

        // Search functions moved to top of IIFE
        function searchCotizaciones(query) {
            console.log('🔧 searchCotizaciones called with query:', query);

            fetch(`/workflow/api/buscar-cotizaciones-drawer/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSearchResults('cotizacion', data.cotizaciones);
                    }
                })
                .catch(error => {
                    console.error('❌ Error searching cotizaciones:', error);
                });
        }

        function showSearchResults(type, results) {
            console.log('🔧 showSearchResults called with type:', type, 'results:', results);

            const resultsContainer = document.getElementById(`${type}Results`);
            if (!resultsContainer) {
                console.error('❌ Results container not found for type:', type);
                return;
            }

            resultsContainer.innerHTML = '';

            if (!results || results.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
            } else {
                results.forEach(item => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.onclick = () => selectItem(type, item);

                    if (type === 'cotizacion') {
                        const montoFinanciado = item.montoFinanciado || item.auxMonto2 || 0;
                        const montoFormateado = typeof montoFinanciado === 'number' ? montoFinanciado.toLocaleString() : '0';
                        const tipoIcon = item.tipoPrestamo === 'auto' ? '🚗' : item.tipoPrestamo === 'personal' ? '👤' : '📝';
                        const tipoLabel = item.tipoPrestamo === 'auto' ? 'Auto' : item.tipoPrestamo === 'personal' ? 'Personal' : 'Sin tipo';
                        resultItem.innerHTML = `
                    <div class="search-result-name">${item.nombreCliente || 'Sin nombre'}</div>
                    <div class="search-result-details">
                        ${item.cedulaCliente || 'Sin cédula'} • 
                        <span class="badge badge-sm ${item.tipoPrestamo === 'auto' ? 'bg-primary' : 'bg-success'}">${tipoIcon} ${tipoLabel}</span> • 
                        Monto Financiado: $${montoFormateado}
                    </div>
                `;
                    } else {
                        resultItem.innerHTML = `
                    <div class="search-result-name">${item.nombreCliente || 'Sin nombre'}</div>
                    <div class="search-result-details">
                        ${item.cedulaCliente || 'Sin cédula'} • 
                        ${item.tipoPrestamo || 'Sin tipo'} • 
                        $${(item.montoPrestamo || 0).toLocaleString()}
                    </div>
                `;
                    }

                    resultsContainer.appendChild(resultItem);
                });
            }

            resultsContainer.classList.add('show');
        }

        function selectItem(type, item) {
            console.log('🔧 selectItem called with type:', type, 'item:', item);

            const idInput = document.getElementById(`${type}Id`);
            const searchInput = document.getElementById(`${type}Search`);
            const selectedContainer = document.getElementById(`${type}Selected`);

            if (idInput) idInput.value = item.id;
            if (searchInput) searchInput.value = '';

            if (selectedContainer) {
                const nameElement = selectedContainer.querySelector('.selected-name');
                const detailsElement = selectedContainer.querySelector('.selected-details');

                if (nameElement) nameElement.textContent = item.nombreCliente || 'Sin nombre';
                if (detailsElement) {
                    if (type === 'cotizacion') {
                        const montoFinanciado = item.montoFinanciado || item.auxMonto2 || 0;
                        const montoFormateado = typeof montoFinanciado === 'number' ? montoFinanciado.toLocaleString() : '0';
                        const tipoIcon = item.tipoPrestamo === 'auto' ? '🚗' : item.tipoPrestamo === 'personal' ? '👤' : '📝';
                        const tipoLabel = item.tipoPrestamo === 'auto' ? 'Auto' : item.tipoPrestamo === 'personal' ? 'Personal' : 'Sin tipo';
                        detailsElement.textContent = `${item.cedulaCliente || 'Sin cédula'} • ${tipoIcon} ${tipoLabel} • Monto Financiado: $${montoFormateado}`;

                        // Show observaciones section and populate with observaciones from cotización
                        const observacionesSection = document.getElementById('observacionesSection');
                        const observacionesSelected = document.getElementById('observacionesSelected');
                        const observacionesPlaceholder = document.getElementById('observacionesPlaceholder');
                        const observacionesText = document.querySelector('.observaciones-text');

                        if (observacionesSection && observacionesSelected && observacionesPlaceholder && observacionesText) {
                            observacionesSection.style.display = 'block';

                            const observaciones = item.observaciones || '';

                            if (observaciones.trim()) {
                                observacionesText.textContent = observaciones;
                                observacionesSelected.style.display = 'block';
                                observacionesPlaceholder.style.display = 'none';
                            } else {
                                observacionesSelected.style.display = 'none';
                                observacionesPlaceholder.style.display = 'block';
                            }
                        }

                        // Show sections conditionally based on loan type
                        const isAutoLoan = item.tipoPrestamo === 'auto';
                        
                        // Show motivo de consulta section only for auto loans
                        const motivoSection = document.getElementById('motivoConsultaSection');
                        const motivoTextarea = document.getElementById('motivoConsulta');

                        if (motivoSection && motivoTextarea) {
                            if (isAutoLoan) {
                                motivoSection.classList.add('show');

                                const observaciones = item.observaciones || '';
                                motivoTextarea.value = observaciones;
                                motivoTextarea.dispatchEvent(new Event('input', { bubbles: true }));

                                if (!observaciones.trim()) {
                                    setTimeout(() => {
                                        motivoTextarea.focus();
                                    }, 100);
                                }
                            } else {
                                motivoSection.classList.remove('show');
                                motivoTextarea.value = '';
                            }
                        }

                        // Show como se entero section for all types
                        const comoSeEnteroSection = document.getElementById('comoSeEnteroSection');
                        if (comoSeEnteroSection) {
                            comoSeEnteroSection.classList.add('show');
                        }

                        // Show APC Makito section for all types
                        const apcMakitoSection = document.getElementById('apcMakitoSection');
                        if (apcMakitoSection) {
                            apcMakitoSection.classList.add('show');
                        }

                        // Show SURA Makito section only for auto loans
                        const suraMakitoSection = document.getElementById('suraMakitoSection');
                        if (suraMakitoSection) {
                            if (isAutoLoan) {
                                suraMakitoSection.classList.add('show');
                            } else {
                                suraMakitoSection.classList.remove('show');
                                // Clear SURA fields for non-auto loans
                                const suraCheckbox = document.getElementById('cotizarSuraMakito');
                                const suraCamposAdicionales = document.getElementById('suraCamposAdicionales');
                                if (suraCheckbox) suraCheckbox.checked = false;
                                if (suraCamposAdicionales) suraCamposAdicionales.style.display = 'none';
                            }
                        }

                        // Auto-populate cliente from cotización
                        autoPopulateClienteFromCotizacion(item);
                        
                        // Store cotización type globally for all types
                        window.selectedCotizacionType = item.tipoPrestamo;
                        console.log('🔧 Stored cotización type:', window.selectedCotizacionType);
                        
                        // Store cotización data globally for SURA auto-population only for auto loans
                        if (isAutoLoan) {
                            window.selectedCotizacionData = {
                                tipoDocumento: item.tipoDocumento,
                                valorAuto: item.valorAuto,
                                yearCarro: item.yearCarro,
                                marca: item.marca,
                                modelo: item.modelo
                            };
                            console.log('🔧 Stored cotización data for SURA (auto loan):', window.selectedCotizacionData);
                        } else {
                            // Clear SURA data for non-auto loans
                            window.selectedCotizacionData = null;
                            console.log('🔧 Cleared SURA data (non-auto loan)');
                            
                            // Additional safety: explicitly hide cotización fields section for personal loans
                            if (typeof window.hideCotizacionFieldsSection === 'function') {
                                console.log('🔧 Explicitly hiding cotización fields section for personal loan');
                                window.hideCotizacionFieldsSection();
                            }
                        }
                        console.log('🔧 Full cotización item data:', item);
                        
                        // Validate cotización fields when cotización is selected
                        if (typeof window.validateCotizacionFields === 'function') {
                            console.log('🔍 About to call validateCotizacionFields with:', {
                                tipoPrestamo: item.tipoPrestamo,
                                id: item.id,
                                nombreCliente: item.nombreCliente
                            });
                            const validation = window.validateCotizacionFields(item);
                            console.log('🔧 Cotización fields validation result:', validation);
                        } else {
                            console.log('⚠️ validateCotizacionFields function not found');
                        }
                    } else {
                        detailsElement.textContent = `${item.cedulaCliente || 'Sin cédula'} • ${item.tipoPrestamo || 'Sin tipo'} • $${(item.montoPrestamo || 0).toLocaleString()}`;
                    }
                }

                selectedContainer.style.display = 'block';
            }

            hideSearchResults(type);
            
            // If this is a cotización selection, validate for duplicates
            if (type === 'cotizacion') {
                validateCotizacionSelection(item);
                
                // Also validate consultation fields - only for auto loans
                const isAutoLoan = item.tipoPrestamo === 'auto';
                if (isAutoLoan && typeof window.validateConsultationFields === 'function') {
                    handleCotizacionConsultationValidation(item.id);
                } else if (!isAutoLoan) {
                    console.log('🔧 Skipping consultation fields validation - not an auto loan');
                } else {
                    console.warn('⚠️ validateConsultationFields function not available');
                }
            }
        }

        async function validateCotizacionSelection(cotizacion) {
            console.log('🔍 Validating cotización selection:', cotizacion);
            
            // Get the current pipeline
            const pipelineSelect = document.getElementById('pipelineSelect');
            const pipelineId = pipelineSelect ? pipelineSelect.value : null;
            
            if (!pipelineId) {
                console.log('⚠️ No pipeline selected, skipping validation');
                return;
            }
            
            try {
                // Call the validation function from drawer.html
                const validation = await window.validateCotizacionDuplicate(cotizacion.id, pipelineId);
                
                if (validation.isDuplicate) {
                    console.log('⚠️ Cotización duplicate detected:', validation);
                    window.showCotizacionDuplicateWarning(validation.existingSolicitud);
                } else {
                    console.log('✅ Cotización is valid, no duplicates');
                    window.hideCotizacionDuplicateWarning();
                }
            } catch (error) {
                console.error('❌ Error validating cotización:', error);
                // Don't block the user if validation fails, just log the error
            }
        }

        // Handle consultation fields validation for selected cotización
        async function handleCotizacionConsultationValidation(cotizacionId) {
            console.log('🔍 Handling consultation validation for cotización:', cotizacionId);
            
            try {
                // Validate consultation fields
                const validationResult = await window.validateConsultationFields(cotizacionId);
                console.log('📋 Consultation validation result:', validationResult);
                
                if (validationResult && typeof window.showConsultationFieldsSection === 'function') {
                    // Show the consultation fields section with results
                    window.showConsultationFieldsSection(validationResult);
                } else {
                    console.error('❌ showConsultationFieldsSection function not available');
                }
            } catch (error) {
                console.error('❌ Error validating consultation fields:', error);
            }
        }



        async function validateCotizacionConsultationFields(cotizacionId) {
            console.log('🔍 Validating consultation fields for cotización:', cotizacionId);
            
            if (!cotizacionId) {
                // Hide consultation fields section if no cotización selected
                if (typeof window.hideConsultationFieldsSection === 'function') {
                    window.hideConsultationFieldsSection();
                }
                return;
            }

            try {
                // Call the validation function from drawer.html
                const validationResult = await window.validateConsultationFields(cotizacionId);
                
                if (validationResult) {
                    console.log('📋 Consultation fields validation result:', validationResult);
                    
                    // Show the consultation fields section with the validation result
                    if (typeof window.showConsultationFieldsSection === 'function') {
                        window.showConsultationFieldsSection(validationResult);
                    }
                } else {
                    console.log('⚠️ No validation result received');
                    
                    // Hide section if validation failed
                    if (typeof window.hideConsultationFieldsSection === 'function') {
                        window.hideConsultationFieldsSection();
                    }
                }
            } catch (error) {
                console.error('❌ Error validating consultation fields:', error);
                
                // Don't block the user if validation fails, just log the error
                // Hide section on error
                if (typeof window.hideConsultationFieldsSection === 'function') {
                    window.hideConsultationFieldsSection();
                }
            }
        }

        // Duplicate functions removed - using the ones defined at the top of IIFE

        function autoPopulateClienteFromCotizacion(cotizacion) {
            console.log('🔧 autoPopulateClienteFromCotizacion called with:', cotizacion);

            // Clear any existing cliente first
            clearCliente();

            // Create a cliente object from cotización data
            const clienteData = {
                id: null, // We'll need to find the actual cliente ID
                nombreCliente: cotizacion.nombreCliente,
                cedulaCliente: cotizacion.cedulaCliente,
                edad: null, // Not available in cotización data
                sexo: null  // Not available in cotización data
            };

            // Search for the actual cliente by cédula
            if (clienteData.cedulaCliente) {
                fetch(`/workflow/api/buscar-clientes-drawer/?q=${encodeURIComponent(clienteData.cedulaCliente)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.clientes.length > 0) {
                            // Use the first matching cliente
                            const cliente = data.clientes[0];
                            console.log('🔧 Found matching cliente:', cliente);
                            selectClienteAutomatically(cliente);
                        } else {
                            // If no cliente found, create a virtual cliente object
                            console.log('🔧 No matching cliente found, using cotización data');
                            selectClienteAutomatically(clienteData);
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error searching for cliente:', error);
                        // Fallback to using cotización data
                        selectClienteAutomatically(clienteData);
                    });
            } else {
                // No cédula available, use cotización data directly
                selectClienteAutomatically(clienteData);
            }
        }

        function selectClienteAutomatically(cliente) {
            console.log('🔧 selectClienteAutomatically called with:', cliente);

            const clienteIdInput = document.getElementById('clienteId');
            const clienteSelectedContainer = document.getElementById('clienteSelected');
            const clientePlaceholder = document.getElementById('clientePlaceholder');

            if (clienteIdInput) clienteIdInput.value = cliente.id || '';

            if (clienteSelectedContainer && clientePlaceholder) {
                const nameElement = clienteSelectedContainer.querySelector('.selected-name');
                const detailsElement = clienteSelectedContainer.querySelector('.selected-details');

                if (nameElement) nameElement.textContent = cliente.nombreCliente || 'Sin nombre';
                if (detailsElement) {
                    if (cliente.id) {
                        // Real cliente with full data
                        detailsElement.textContent = `${cliente.cedulaCliente || 'Sin cédula'} • ${cliente.edad || 'Sin edad'} años`;
                    } else {
                        // Virtual cliente from cotización data
                        detailsElement.textContent = `${cliente.cedulaCliente || 'Sin cédula'} • (Datos de cotización)`;
                    }
                }

                // Add auto-populated indicator
                clienteSelectedContainer.classList.add('auto-populated');
                clienteSelectedContainer.style.display = 'block';
                clientePlaceholder.style.display = 'none';

                // Add a small indicator text
                const indicator = document.createElement('small');
                indicator.className = 'auto-populated-indicator';
                indicator.innerHTML = '<i class="fas fa-magic me-1"></i>Auto-completado desde cotización';

                // Remove any existing indicator
                const existingIndicator = clienteSelectedContainer.querySelector('.auto-populated-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }

                clienteSelectedContainer.appendChild(indicator);
            }

            // Auto-populate APC fields if available
            if (typeof autoPopulateApcFields === 'function') {
                autoPopulateApcFields(cliente);
            }
            
            // Auto-populate SURA fields if available and we have cotización data
            if (typeof autoPopulateSuraFields === 'function' && window.selectedCotizacionData) {
                autoPopulateSuraFields(cliente, window.selectedCotizacionData);
            }
        }

        function setupFileUploadHandlers() {
            console.log('🔧 setupFileUploadHandlers called');

            document.querySelectorAll('.file-upload-input').forEach(input => {
                input.addEventListener('change', function () {
                    const file = this.files[0];
                    const requisitoItem = this.closest('.requisito-item');
                    const fileSelected = requisitoItem.querySelector('.file-selected');
                    const fileName = fileSelected.querySelector('.file-name');
                    const uploadLabel = requisitoItem.querySelector('.file-upload-label');

                    if (file) {
                        fileName.textContent = file.name;
                        fileSelected.style.display = 'flex';
                        uploadLabel.style.display = 'none';
                    }
                });
            });
        }

        function removeFile(button) {
            console.log('🔧 removeFile called');

            const requisitoItem = button.closest('.requisito-item');
            const fileSelected = requisitoItem.querySelector('.file-selected');
            const uploadLabel = requisitoItem.querySelector('.file-upload-label');
            const fileInput = requisitoItem.querySelector('.file-upload-input');

            fileInput.value = '';
            fileSelected.style.display = 'none';
            uploadLabel.style.display = 'inline-block';
        }

        // Additional functions that might be missing
        window.submitSolicitud = function () {
            console.log('🔧 submitSolicitud called');

            const form = document.getElementById('solicitudForm');
            const formData = new FormData(form);

            // Validar pipeline - check both form data and locked pipeline
            const pipelineFromForm = formData.get('pipeline');
            const pipelineSelect = document.getElementById('pipelineSelect');
            const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');

            let pipelineId = pipelineFromForm;

            // If pipeline is locked (hidden), get the value from the select element
            if (!pipelineId && pipelineLockedInfo && pipelineLockedInfo.style.display !== 'none') {
                pipelineId = pipelineSelect ? pipelineSelect.value : null;
                console.log('🔧 Pipeline is locked, using value from select:', pipelineId);
            }

            if (!pipelineId) {
                alert('Por favor selecciona un pipeline');
                return;
            }

            // Validar como se enteró (required field)
            const comoSeEntero = formData.get('como_se_entero');
            if (!comoSeEntero) {
                alert('Por favor selecciona cómo se enteró de nuestros servicios');
                return;
            }

            // Validar campos APC si está activado
            const descargarApc = formData.get('descargar_apc_makito');
            if (descargarApc) {
                const apcTipoDocumento = formData.get('apc_tipo_documento');
                const apcNoCedula = formData.get('apc_no_cedula');

                if (!apcTipoDocumento) {
                    alert('Por favor selecciona el tipo de documento para APC');
                    return;
                }

                if (!apcNoCedula || apcNoCedula.trim() === '') {
                    alert('Por favor ingresa el número de documento para APC');
                    return;
                }
            }

            // If pipeline was locked, add it to form data
            if (!pipelineFromForm && pipelineId) {
                formData.set('pipeline', pipelineId);
                console.log('🔧 Added locked pipeline to form data:', pipelineId);
            }

            // Debug: Log all form data
            console.log('🔧 Form data contents:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }

            // Validar archivos obligatorios si corresponde
            const requiredFiles = document.querySelectorAll('.requisito-item .file-upload-input[required]');
            let hasRequiredFiles = true;

            for (let input of requiredFiles) {
                if (!input.files || input.files.length === 0) {
                    hasRequiredFiles = false;
                    break;
                }
            }

            if (!hasRequiredFiles) {
                alert('Por favor sube todos los archivos obligatorios');
                return;
            }

            // Get submit button and original text before validation
            const submitBtn = document.querySelector('.drawer-footer .btn-primary');
            const originalText = submitBtn.innerHTML;

            // Validate consultation fields if cotización is selected and it's an auto loan
            const cotizacionId = document.getElementById('cotizacionId')?.value;
            const isAutoLoan = window.selectedCotizacionType === 'auto';
            
            if (cotizacionId && isAutoLoan) {
                console.log('🔍 Validating consultation fields before submission (auto loan)');
                const consultationValidation = window.validateMandatoryFieldsBeforeSubmit();
                if (!consultationValidation.isValid) {
                    console.log('❌ Consultation fields validation failed:', consultationValidation.missingFields);
                    
                    const fieldNames = consultationValidation.missingFields.join(', ');
                    alert(`Por favor, complete los siguientes campos obligatorios de la cotización:\n\n${fieldNames}`);
                    
                    // Scroll to the consultation fields section
                    const consultationSection = document.getElementById('cotizacionFieldsSection');
                    if (consultationSection) {
                        consultationSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    
                    return;
                }
                console.log('✅ Consultation fields validation passed');
            } else if (cotizacionId && !isAutoLoan) {
                console.log('🔧 Skipping consultation fields validation - personal loan selected');
            }

            // Validate cotización for duplicates before submitting
            checkCotizacionBeforeSubmit().then(validationResult => {
                if (!validationResult.canProceed) {
                    console.log('🛑 User cancelled submission due to duplicate cotización');
                    return;
                }

                // Continue with form submission
                proceedWithFormSubmission(formData, pipelineId, submitBtn, originalText);
            }).catch(error => {
                console.error('❌ Error validating cotización during submit:', error);
                // Continue with submission if validation fails
                proceedWithFormSubmission(formData, pipelineId, submitBtn, originalText);
            });
        };

        function proceedWithFormSubmission(formData, pipelineId, submitBtn, originalText) {
            // Show enhanced loading states
            submitBtn.innerHTML = '<span class="btn-spinner"></span> Creando...';
            submitBtn.disabled = true;
            submitBtn.classList.add('btn-loading');
            
            // Show drawer loading overlay
            showDrawerLoading('Creando solicitud...', 'Validando información y creando nuevo negocio');

            fetch('/workflow/nueva-solicitud/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update loading message to success
                        showDrawerLoading('¡Solicitud creada!', 'Redirigiendo al listado actualizado...');
                        
                        // Show success message
                        showSuccessMessage(data.message);
                        
                        // Close drawer after a brief delay
                        setTimeout(() => {
                            closeSolicitudDrawer();
                            hideDrawerLoading();
                        }, 800);
                        
                        // Reload page to show new solicitud
                        setTimeout(() => {
                            window.location.reload();
                        }, 1200);
                    } else {
                        hideDrawerLoading();
                        alert('Error: ' + (data.error || 'Error desconocido al crear la solicitud'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    hideDrawerLoading();
                    alert('Error al crear la solicitud: ' + error.message);
                })
                .finally(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('btn-loading');
                });
        }

        window.showSuccessMessage = function (message) {
            console.log('🔧 showSuccessMessage called with:', message);

            // Create a simple toast notification
            const toast = document.createElement('div');
            toast.className = 'toast-notification success';
            toast.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
    `;

            document.body.appendChild(toast);

            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        };

        window.clearCotizacion = function () {
            console.log('🔧 clearCotizacion called');
            document.getElementById('cotizacionId').value = '';
            document.getElementById('cotizacionSelected').style.display = 'none';

            // Clear stored cotización data for SURA
            window.selectedCotizacionData = null;
            window.selectedCotizacionType = null;
            console.log('🔧 Cleared stored cotización data and type');

            // Hide consultation fields section when cotización is cleared
            if (typeof window.hideConsultationFieldsSection === 'function') {
                window.hideConsultationFieldsSection();
                console.log('🔧 Cleared consultation fields section');
            }

            // Also clear cliente when cotización is cleared
            console.log('🔧 Also clearing cliente due to cotización clear');
            clearCliente();
        };

        window.clearCliente = function () {
            console.log('🔧 clearCliente called');
            document.getElementById('clienteId').value = '';
            const clienteSelected = document.getElementById('clienteSelected');
            const clientePlaceholder = document.getElementById('clientePlaceholder');

            if (clienteSelected) {
                clienteSelected.style.display = 'none';
                clienteSelected.classList.remove('auto-populated');

                // Remove auto-populated indicator
                const indicator = clienteSelected.querySelector('.auto-populated-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            if (clientePlaceholder) {
                clientePlaceholder.style.display = 'block';
            }

            // Clear APC fields when client is cleared
            if (typeof clearApcFields === 'function') {
                clearApcFields();
            }
            
            // Clear SURA fields when client is cleared
            if (typeof clearSuraFields === 'function') {
                clearSuraFields();
            }
        };

        // Función para cerrar el modal de requisitos
        // Función unificada para cerrar el modal de requisitos
        window.cerrarModalRequisitos = function () {
            console.log('🚪 Cerrando modal de requisitos');

            const modal = bootstrap.Modal.getInstance(document.getElementById('modalRequisitosFaltantes'));
            if (modal) {
                modal.hide();
            } else {
                // Si no hay instancia, intentar crear una nueva y ocultarla
                const modalElement = document.getElementById('modalRequisitosFaltantes');
                if (modalElement) {
                    const newModal = new bootstrap.Modal(modalElement);
                    newModal.hide();
                }
            }

            // Resetear estado después de cerrar
            setTimeout(() => {
                window.resetearEstadoModal();
            }, 300);
        }

        // Función para mostrar modal de requisitos faltantes
        window.mostrarModalRequisitosFaltantes = function (solicitudId, nuevaEtapaId, nombreEtapa, callbackExito, callbackCancelacion) {
            console.log('🔍 Mostrando modal de requisitos faltantes');
            console.log('📋 Parámetros recibidos:', { solicitudId, nuevaEtapaId, nombreEtapa, callbackExito: typeof callbackExito, callbackCancelacion: typeof callbackCancelacion });

            // Guardar contexto global para uso en modal de agenda de firma
            window.currentSolicitudId = solicitudId;
            window.currentNuevaEtapaId = nuevaEtapaId;
            window.currentNombreEtapa = nombreEtapa;
            window.currentCallbackExito = callbackExito;
            window.currentCallbackCancelacion = callbackCancelacion;

            // Validar parámetros con early return
            if (!solicitudId || !nuevaEtapaId || !nombreEtapa) {
                console.error('❌ Parámetros inválidos:', { solicitudId, nuevaEtapaId, nombreEtapa });
                const errorMessage = 'Error: Parámetros inválidos para mostrar modal de requisitos';

                if (typeof showToast !== 'undefined') {
                    showToast(errorMessage, 'error', 6000);
                } else {
                    alert(errorMessage);
                }
                return;
            }

            // Set current solicitud ID for file uploads
            window.currentSolicitudId = solicitudId;
            console.log('🔧 currentSolicitudId establecido:', window.currentSolicitudId);

            // Resetear estado del modal
            window.resetearEstadoModal();

            // Mostrar loading en el modal
            const listaContainer = document.getElementById('listaRequisitosFaltantes');
            const loadingElement = document.getElementById('loadingRequisitos');

            if (listaContainer) listaContainer.innerHTML = '';
            if (loadingElement) loadingElement.style.display = 'block';

            // Actualizar título del modal (se actualizará con requisitos obligatorios después)
            const etapaDestinoElement = document.getElementById('etapaDestinoNombre');
            if (etapaDestinoElement) {
                etapaDestinoElement.textContent = nombreEtapa;
            }

            // Cargar requisitos faltantes
            fetch(`/workflow/api/solicitudes/${solicitudId}/requisitos-faltantes-detallado/?nueva_etapa_id=${nuevaEtapaId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('📋 Requisitos faltantes recibidos:', data);

                    // Ocultar loading
                    if (loadingElement) loadingElement.style.display = 'none';

                    if (data.success) {
                        // Actualizar título del modal con requisitos obligatorios faltantes
                        const etapaDestinoElement = document.getElementById('etapaDestinoNombre');
                        if (etapaDestinoElement) {
                            const obligatoriosFaltantes = data.total_obligatorios_faltantes || 0;
                            if (obligatoriosFaltantes > 0) {
                                etapaDestinoElement.textContent = `${nombreEtapa} (${obligatoriosFaltantes} requisito${obligatoriosFaltantes > 1 ? 's' : ''} obligatorio${obligatoriosFaltantes > 1 ? 's' : ''} faltante${obligatoriosFaltantes > 1 ? 's' : ''})`;
                            } else {
                                etapaDestinoElement.textContent = nombreEtapa;
                            }
                        }
                        
                        // Llenar la lista de requisitos faltantes
                        window.llenarListaRequisitosFaltantes(data.requisitos, data.total_requisitos, data.requisitos_completos, data);

                        // Configurar event listeners del modal
                        window.configurarEventListenersModal(solicitudId, nuevaEtapaId, callbackExito, callbackCancelacion);

                        // Mostrar modal
                        const modal = new bootstrap.Modal(document.getElementById('modalRequisitosFaltantes'));
                        modal.show();
                    } else {
                        console.error('❌ Error al cargar requisitos faltantes:', data.error);
                        if (typeof showToast !== 'undefined') {
                            showToast('Error al cargar requisitos faltantes: ' + data.error, 'error', 6000);
                        } else {
                            alert('Error al cargar requisitos faltantes: ' + data.error);
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ Error en petición de requisitos faltantes:', error);
                    // Ocultar loading
                    if (loadingElement) loadingElement.style.display = 'none';

                    if (typeof showToast !== 'undefined') {
                        showToast('Error al cargar requisitos faltantes', 'error', 6000);
                    } else {
                        alert('Error al cargar requisitos faltantes');
                    }
                });
        }

        // Función unificada para llenar la lista de requisitos en el modal
        window.llenarListaRequisitosFaltantes = function (requisitos, totalRequisitos, requisitosCompletos, data) {
            const listaContainer = document.getElementById('listaRequisitosFaltantes');
            const btnValidar = document.getElementById('btnValidarYContinuar');

            if (!listaContainer) {
                console.error('❌ No se encontró el contenedor de requisitos');
                return;
            }

            if (!btnValidar) {
                console.error('❌ No se encontró el botón de validar');
                return;
            }

            // Store the data globally for use by verification function
            window.currentRequisitosData = {
                requisitos: requisitos,
                requisitos_obligatorios: data.requisitos_obligatorios || [],
                requisitos_opcionales: data.requisitos_opcionales || [],
                total_requisitos: totalRequisitos,
                total_requisitos_obligatorios: data.total_requisitos_obligatorios || 0,
                total_requisitos_opcionales: data.total_requisitos_opcionales || 0,
                requisitos_completos: requisitosCompletos,
                requisitos_obligatorios_completos: data.requisitos_obligatorios_completos || 0,
                total_obligatorios_faltantes: data.total_obligatorios_faltantes || 0
            };

            // Limpiar contenedor
            listaContainer.innerHTML = '';

            // Check if all mandatory requirements are complete
            const allMandatoryComplete = data.total_obligatorios_faltantes === 0;

            // Update button based on mandatory requirements
            if (allMandatoryComplete) {
                btnValidar.innerHTML = `<i class="fas fa-check me-2"></i>Requisitos Obligatorios Completos - Continuar`;
                btnValidar.className = 'btn btn-success';
                btnValidar.disabled = false;
            } else {
                btnValidar.innerHTML = `<i class="fas fa-check me-2"></i>Validar y Continuar (${data.requisitos_obligatorios_completos}/${data.total_requisitos_obligatorios} obligatorios)`;
                btnValidar.className = 'btn btn-primary';
                btnValidar.disabled = true;
            }

            // Separar requisitos en obligatorios y opcionales
            const requisitosObligatorios = data.requisitos_obligatorios || [];
            const requisitosOpcionales = data.requisitos_opcionales || [];

            // Si hay requisitos obligatorios, mostrar sección
            if (requisitosObligatorios.length > 0) {
                const seccionObligatoriosHtml = `
                    <div class="seccion-requisitos">
                        <div class="seccion-titulo obligatorio">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                    <h6 class="mb-0 fw-bold">Requisitos Obligatorios</h6>
                                </div>
                                <span class="badge badge-obligatorio">${data.requisitos_obligatorios_completos}/${data.total_requisitos_obligatorios}</span>
                            </div>
                            <small class="text-muted d-block mt-1">Estos documentos son necesarios para continuar</small>
                        </div>
                        <div id="requisitos-obligatorios-lista"></div>
                    </div>
                `;
                listaContainer.insertAdjacentHTML('beforeend', seccionObligatoriosHtml);
                
                // Agregar requisitos obligatorios
                const listaObligatorios = document.getElementById('requisitos-obligatorios-lista');
                requisitosObligatorios.forEach(requisito => {
                    const requisitoHtml = buildRequisitoHtml(requisito, true);
                    listaObligatorios.insertAdjacentHTML('beforeend', requisitoHtml);
                });
            }

            // Si hay requisitos opcionales, mostrar sección
            if (requisitosOpcionales.length > 0) {
                const requisitosOpcionalesCompletos = requisitosOpcionales.filter(req => req.esta_cumplido).length;
                const seccionOpcionalesHtml = `
                    <div class="seccion-requisitos">
                        <div class="seccion-titulo opcional">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-plus-circle text-secondary me-2"></i>
                                    <h6 class="mb-0 fw-bold">Requisitos Opcionales</h6>
                                </div>
                                <span class="badge badge-opcional">${requisitosOpcionalesCompletos}/${data.total_requisitos_opcionales}</span>
                            </div>
                            <small class="text-muted d-block mt-1">Documentos adicionales que pueden facilitar el proceso</small>
                        </div>
                        <div id="requisitos-opcionales-lista"></div>
                    </div>
                `;
                listaContainer.insertAdjacentHTML('beforeend', seccionOpcionalesHtml);
                
                // Agregar requisitos opcionales
                const listaOpcionales = document.getElementById('requisitos-opcionales-lista');
                requisitosOpcionales.forEach(requisito => {
                    const requisitoHtml = buildRequisitoHtml(requisito, false);
                    listaOpcionales.insertAdjacentHTML('beforeend', requisitoHtml);
                });
            }

            // Si no hay requisitos de ningún tipo
            if (requisitosObligatorios.length === 0 && requisitosOpcionales.length === 0) {
                listaContainer.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>No hay requisitos específicos para esta transición</div>';
                btnValidar.innerHTML = `<i class="fas fa-check me-2"></i>Continuar`;
                btnValidar.className = 'btn btn-success';
                btnValidar.disabled = false;
                return;
            }

            // Configurar event listeners para los inputs de archivo
            window.configurarEventListenersArchivos();

            // Verificar estado inicial de requisitos
            window.verificarTodosRequisitosCompletos();
        }

        // Función auxiliar para construir HTML de un requisito
        function buildRequisitoHtml(requisito, esObligatorio) {
            const isCompleto = requisito.esta_cumplido;
            const tituloClass = isCompleto ? 'text-success' : (esObligatorio ? 'text-danger' : 'text-secondary');
            const tituloIcon = isCompleto ? 'fa-check-circle' : (esObligatorio ? 'fa-exclamation-triangle' : 'fa-plus-circle');
            const badgeClass = isCompleto ? 'bg-success' : (esObligatorio ? 'bg-danger' : 'bg-secondary');
            const badgeText = isCompleto ? 'Completo' : (esObligatorio ? 'Faltante' : 'Opcional');
            const cardClass = isCompleto ? 'border-success' : (esObligatorio ? 'border-danger' : 'border-secondary');
            const cardExtraClass = esObligatorio ? '' : 'opcional';

            // Lógica especial para requisito de agenda de firma
            if (requisito.tipo_especial === 'agenda_firma') {
                return buildAgendaFirmaHtml(requisito, esObligatorio, isCompleto, tituloClass, tituloIcon, badgeClass, badgeText, cardClass, cardExtraClass);
            }

            return `
            <div class="card mb-3 requisito-card ${cardClass} ${cardExtraClass}" data-requisito-id="${requisito.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="card-title ${tituloClass} mb-1">
                                <i class="fas ${tituloIcon} me-2"></i>
                                ${requisito.nombre}
                                ${esObligatorio ? '' : '<span class="badge bg-secondary ms-2" style="font-size: 0.7rem;">Opcional</span>'}
                            </h6>
                            ${requisito.descripcion ? `<p class="text-muted small mb-2">${requisito.descripcion}</p>` : ''}
                            ${requisito.mensaje_personalizado ? `<p class="text-info small mb-2"><i class="fas fa-info-circle me-1"></i>${requisito.mensaje_personalizado}</p>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>
                    </div>
                    
                    ${requisito.archivo_actual ? `
                        <div class="alert alert-success mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-file-check me-2 mt-1 text-success"></i>
                                <div class="flex-grow-1">
                                    <strong>Archivo subido:</strong> 
                                    <a href="${requisito.archivo_actual.url}" target="_blank" class="text-decoration-none">
                                        ${requisito.archivo_actual.nombre}
                                    </a>
                                    ${!isCompleto ? `
                                        <div class="mt-2 d-flex gap-2">
                                            <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="mostrarUploadParaReemplazo(${requisito.id})" aria-label="Reemplazar archivo">
                                                <i class="fas fa-upload me-1"></i>Reemplazar archivo
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" style="display:none;" id="cancelar-upload-btn-${requisito.id}" onclick="cancelarUploadParaReemplazo(${requisito.id})" aria-label="Cancelar reemplazo">
                                                <i class="fas fa-times me-1"></i>Cancelar
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${!isCompleto ? `
                        <div class="upload-section" style="${requisito.archivo_actual ? 'display: none;' : ''}" id="upload-section-${requisito.id}">
                            <div class="mb-3">
                                <label class="form-label">
                                    ${requisito.archivo_actual ? 'Reemplazar archivo' : 'Subir archivo'} 
                                    ${esObligatorio ? '<span class="text-danger">*</span>' : '<span class="text-secondary">(opcional)</span>'}
                                </label>
                                <input type="file" class="form-control requisito-file-input" 
                                       data-requisito-id="${requisito.id}" 
                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif"
                                       aria-label="${requisito.archivo_actual ? 'Reemplazar archivo' : 'Subir archivo'}">
                                <small class="text-muted">El archivo se subirá automáticamente cuando hagas clic en 'Validar y Continuar'</small>
                            </div>
                        </div>
                    ` : `
                        <div class="alert alert-light border-success">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span class="text-success fw-semibold">Requisito completado</span>
                            </div>
                        </div>
                    `}
                </div>
            </div>
        `;
        }

        // Función específica para generar HTML del requisito de agenda de firma
        function buildAgendaFirmaHtml(requisito, esObligatorio, isCompleto, tituloClass, tituloIcon, badgeClass, badgeText, cardClass, cardExtraClass) {
            const agendaFirma = requisito.agenda_firma || {};
            
            return `
            <div class="card mb-3 requisito-card ${cardClass} ${cardExtraClass}" data-requisito-id="${requisito.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="card-title ${tituloClass} mb-1">
                                <i class="fas ${tituloIcon} me-2"></i>
                                ${requisito.nombre}
                                ${esObligatorio ? '' : '<span class="badge bg-secondary ms-2" style="font-size: 0.7rem;">Opcional</span>'}
                            </h6>
                            ${requisito.descripcion ? `<p class="text-muted small mb-2">${requisito.descripcion}</p>` : ''}
                            ${requisito.mensaje_personalizado ? `<p class="text-info small mb-2"><i class="fas fa-info-circle me-1"></i>${requisito.mensaje_personalizado}</p>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>
                    </div>
                    
                    ${isCompleto && agendaFirma.tiene_cita ? `
                        <div class="alert alert-success mb-3" style="border-radius: 12px; border: none; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(25, 135, 84, 0.15));">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-calendar-check me-3 mt-1 text-success" style="font-size: 1.5rem;"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-2 text-success fw-bold">
                                        <i class="fas fa-check-circle me-2"></i>
                                        Firma Agendada
                                    </h6>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <strong>Fecha:</strong><br>
                                            <span class="text-success">${agendaFirma.fecha_formateada || 'No especificada'}</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Lugar:</strong><br>
                                            <span class="text-success">${agendaFirma.lugar_firma_display || 'No especificado'}</span>
                                        </div>
                                        ${agendaFirma.comentarios ? `
                                        <div class="col-12 mt-2">
                                            <strong>Comentarios:</strong><br>
                                            <span class="text-muted">${agendaFirma.comentarios}</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="alert alert-warning mb-3" style="border-radius: 12px; border: none; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(253, 126, 20, 0.15));">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-calendar-plus me-3 mt-1 text-warning" style="font-size: 1.5rem;"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-2 text-warning fw-bold">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Agenda de Firma Pendiente
                                    </h6>
                                    <p class="mb-3 text-muted">
                                        Es necesario agendar una cita de firma para continuar con el proceso.
                                    </p>
                                    <button type="button" class="btn btn-warning" onclick="abrirModalAgendaFirma(${requisito.id})">
                                        <i class="fas fa-calendar-plus me-2"></i>
                                        Agendar Firma
                                    </button>
                                </div>
                            </div>
                        </div>
                    `}
                </div>
            </div>
            `;
        }

        // Función para mostrar upload para reemplazar archivo
        window.mostrarUploadParaReemplazo = function (requisitoId) {
            const uploadSection = document.getElementById(`upload-section-${requisitoId}`);
            const cancelarBtn = document.getElementById(`cancelar-upload-btn-${requisitoId}`);
            if (uploadSection) {
                uploadSection.style.display = 'block';
                if (cancelarBtn) cancelarBtn.style.display = 'inline-block';
                // Scroll to the upload section
                uploadSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Función para cancelar upload para reemplazo
        window.cancelarUploadParaReemplazo = function (requisitoId) {
            const uploadSection = document.getElementById(`upload-section-${requisitoId}`);
            const cancelarBtn = document.getElementById(`cancelar-upload-btn-${requisitoId}`);
            if (uploadSection) uploadSection.style.display = 'none';
            if (cancelarBtn) cancelarBtn.style.display = 'none';
        }

        // Función para configurar event listeners de archivos
        window.configurarEventListenersArchivos = function () {
            // Los archivos se subirán automáticamente cuando se haga clic en "Validar y Continuar"
            console.log('Event listeners de archivos configurados - los archivos se subirán con "Validar y Continuar"');

            // Actualizar estado del botón cuando se selecciona un archivo
            document.querySelectorAll('.requisito-file-input').forEach(input => {
                input.addEventListener('change', function () {
                    // Verificar estado de requisitos después de seleccionar archivo
                    setTimeout(() => {
                        window.verificarTodosRequisitosCompletos();
                    }, 100);
                });
            });
        }

        /*
         * SISTEMA UNIFICADO DE REQUISITOS FALTANTES
         * =========================================
         * 
         * Este sistema maneja la validación y carga de requisitos faltantes para transiciones
         * de etapa en la vista de tabla.
         * 
         * FUNCIONES PRINCIPALES:
         * - mostrarModalRequisitosFaltantes: Función principal que muestra el modal
         * - llenarListaRequisitosFaltantes: Llena la lista de requisitos en el modal
         * - configurarEventListenersModal: Configura los eventos del modal
         * - verificarTodosRequisitosCompletos: Verifica si todos los requisitos están completos
         * - subirArchivosSecuencialmente: Sube archivos uno por uno con progreso
         * - resetearEstadoModal: Resetea el estado del modal
         * - cerrarModalRequisitos: Cierra el modal de forma segura
         * - ejecutarCambioEtapa: Función para cambiar etapa
         * - verificarFuncionesRequisitos: Verifica que todas las funciones estén disponibles
         * 
         * FLUJO DE TRABAJO:
         * 1. Usuario intenta cambiar etapa en la tabla
         * 2. Se verifica si hay requisitos faltantes
         * 3. Si los hay, se muestra el modal con la lista
         * 4. Usuario sube archivos o confirma requisitos existentes
         * 5. Se validan todos los requisitos
         * 6. Se ejecuta la transición de etapa
         * 7. Se actualiza la UI de la tabla
         */

        // Función para resetear el estado del modal
        window.resetearEstadoModal = function () {
            console.log('🔄 Reseteando estado del modal');

            // Resetear botón de validar
            const btnValidar = document.getElementById('btnValidarYContinuar');
            if (btnValidar) {
                btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Validar y Continuar';
                btnValidar.className = 'btn btn-primary';
                btnValidar.disabled = true;
            }

            // Limpiar contenedor de requisitos
            const listaContainer = document.getElementById('listaRequisitosFaltantes');
            if (listaContainer) {
                listaContainer.innerHTML = '';
            }

            // Ocultar loading
            const loadingElement = document.getElementById('loadingRequisitos');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

            // Limpiar variables globales
            window.currentSolicitudId = null;
            window.currentNuevaEtapaId = null;
        }

        // Función unificada para subir archivos secuencialmente
        window.subirArchivosSecuencialmente = function (archivos, index, callback) {
            // Early return if all files processed
            if (index >= archivos.length) {
                console.log('✅ Todos los archivos procesados');
                if (typeof callback === 'function') {
                    callback(true); // Pass success flag
                }
                return;
            }

            // Update progress in loading overlay (removed to fix recursion error)
            console.log(`📤 Procesando archivo ${index + 1} de ${archivos.length}`);


            const archivo = archivos[index];

            // Validate required data
            if (!archivo.requisitoId || !archivo.file) {
                console.error('❌ Datos de archivo inválidos:', archivo);
                // Continue with next file
                window.subirArchivosSecuencialmente(archivos, index + 1, callback);
                return;
            }

            const formData = new FormData();
            formData.append('requisito_id', archivo.requisitoId);
            formData.append('archivo', archivo.file);

            const solicitudId = window.currentSolicitudId;

            if (!solicitudId) {
                console.error('❌ No se encontró solicitudId para subir archivo');
                // Continue with next file
                window.subirArchivosSecuencialmente(archivos, index + 1, callback);
                return;
            }

            console.log(`📤 Subiendo archivo ${index + 1}/${archivos.length} para requisito ${archivo.requisitoId}`);

            const handleUploadError = (error, isNetworkError = false) => {
                console.error(`❌ Error al subir archivo para requisito ${archivo.requisitoId}:`, error);

                const mensaje = isNetworkError
                    ? `Error de conexión al subir archivo: ${error}`
                    : `Error al subir archivo: ${error}`;

                if (typeof showToast !== 'undefined') {
                    showToast(mensaje, 'error', 5000);
                }

                // Continue with next file even on error
                window.subirArchivosSecuencialmente(archivos, index + 1, callback);
            };

            fetch(`/workflow/api/solicitudes/${solicitudId}/subir-requisito-modal/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log(`✅ Archivo subido exitosamente para requisito ${archivo.requisitoId}`);

                        // Update UI for this requirement
                        const requisitoCard = document.querySelector(`.requisito-card[data-requisito-id="${archivo.requisitoId}"]`);
                        if (requisitoCard) {
                            const uploadSection = requisitoCard.querySelector('.upload-section');
                            const successSection = requisitoCard.querySelector('.success-section');

                            if (uploadSection) uploadSection.style.display = 'none';
                            if (successSection) successSection.style.display = 'block';

                            // Update badge with proper classes
                            const badge = requisitoCard.querySelector('.badge');
                            if (badge) {
                                badge.className = 'badge bg-success';
                                badge.textContent = 'Completo';
                            }
                        }

                        // UPDATE CRITICAL: Update the currentRequisitosData to reflect the completed requirement
                        if (window.currentRequisitosData) {
                            // Find and update the requirement in the obligatorios array
                            if (window.currentRequisitosData.requisitos_obligatorios) {
                                const requisito = window.currentRequisitosData.requisitos_obligatorios.find(req => req.id == archivo.requisitoId);
                                if (requisito) {
                                    requisito.esta_cumplido = true;
                                    console.log(`✅ Updated requisito ${archivo.requisitoId} status to completed`);
                                }
                            }
                            
                            // Find and update the requirement in the opcionales array if not found in obligatorios
                            if (window.currentRequisitosData.requisitos_opcionales) {
                                const requisito = window.currentRequisitosData.requisitos_opcionales.find(req => req.id == archivo.requisitoId);
                                if (requisito) {
                                    requisito.esta_cumplido = true;
                                    console.log(`✅ Updated optional requisito ${archivo.requisitoId} status to completed`);
                                }
                            }

                            // Recalculate counters
                            const obligatoriosCompletos = (window.currentRequisitosData.requisitos_obligatorios || [])
                                .filter(req => req.esta_cumplido).length;
                            const totalObligatorios = (window.currentRequisitosData.requisitos_obligatorios || []).length;
                            
                            window.currentRequisitosData.requisitos_obligatorios_completos = obligatoriosCompletos;
                            window.currentRequisitosData.total_obligatorios_faltantes = totalObligatorios - obligatoriosCompletos;
                            
                            console.log(`📊 Updated counters: ${obligatoriosCompletos}/${totalObligatorios} obligatorios completos`);
                        }

                        // Continue with next file
                        window.subirArchivosSecuencialmente(archivos, index + 1, callback);
                    } else {
                        // Handle server-side error
                        handleUploadError(data.error || 'Error desconocido del servidor');
                    }
                })
                .catch(error => {
                    // Handle network or parsing errors
                    handleUploadError(error.message, true);
                });
        };

        // Función para subir requisito desde el modal (mantenida para compatibilidad)
        window.subirRequisitoModal = function (requisitoId) {
            const fileInput = document.querySelector(`.requisito-file-input[data-requisito-id="${requisitoId}"]`);
            const btnSubir = document.querySelector(`.btn-subir-requisito[data-requisito-id="${requisitoId}"]`);
            const requisitoCard = document.querySelector(`.requisito-card[data-requisito-id="${requisitoId}"]`);

            if (!fileInput.files.length) {
                alert('Por favor selecciona un archivo');
                return;
            }

            const formData = new FormData();
            formData.append('requisito_id', requisitoId);
            formData.append('archivo', fileInput.files[0]);

            // Mostrar estado de carga
            const originalText = btnSubir.innerHTML;
            btnSubir.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Subiendo...';
            btnSubir.disabled = true;

            // Obtener solicitud ID del modal (se puede pasar como parámetro global)
            const solicitudId = window.currentSolicitudId;

            fetch(`/workflow/api/solicitudes/${solicitudId}/subir-requisito-modal/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Ocultar sección de upload y mostrar éxito
                        const uploadSection = requisitoCard.querySelector('.upload-section');
                        const successSection = requisitoCard.querySelector('.success-section');

                        uploadSection.style.display = 'none';
                        successSection.style.display = 'block';

                        // Actualizar badge
                        const badge = requisitoCard.querySelector('.badge');
                        badge.className = 'badge bg-success';
                        badge.textContent = 'Completo';

                        // UPDATE CRITICAL: Update the currentRequisitosData to reflect the completed requirement
                        if (window.currentRequisitosData) {
                            // Find and update the requirement in the obligatorios array
                            if (window.currentRequisitosData.requisitos_obligatorios) {
                                const requisito = window.currentRequisitosData.requisitos_obligatorios.find(req => req.id == requisitoId);
                                if (requisito) {
                                    requisito.esta_cumplido = true;
                                    console.log(`✅ Updated requisito ${requisitoId} status to completed`);
                                }
                            }
                            
                            // Find and update the requirement in the opcionales array if not found in obligatorios
                            if (window.currentRequisitosData.requisitos_opcionales) {
                                const requisito = window.currentRequisitosData.requisitos_opcionales.find(req => req.id == requisitoId);
                                if (requisito) {
                                    requisito.esta_cumplido = true;
                                    console.log(`✅ Updated optional requisito ${requisitoId} status to completed`);
                                }
                            }

                            // Recalculate counters
                            const obligatoriosCompletos = (window.currentRequisitosData.requisitos_obligatorios || [])
                                .filter(req => req.esta_cumplido).length;
                            const totalObligatorios = (window.currentRequisitosData.requisitos_obligatorios || []).length;
                            
                            window.currentRequisitosData.requisitos_obligatorios_completos = obligatoriosCompletos;
                            window.currentRequisitosData.total_obligatorios_faltantes = totalObligatorios - obligatoriosCompletos;
                            
                            console.log(`📊 Updated counters: ${obligatoriosCompletos}/${totalObligatorios} obligatorios completos`);
                        }

                        // Mostrar mensaje de éxito
                        if (typeof showToast !== 'undefined') {
                            showToast(data.mensaje, 'success', 4000);
                        }

                        // Verificar si todos los requisitos están completos
                        window.verificarTodosRequisitosCompletos();

                    } else {
                        alert('Error al subir requisito: ' + data.error);
                        btnSubir.innerHTML = originalText;
                        btnSubir.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al subir requisito');
                    btnSubir.innerHTML = originalText;
                    btnSubir.disabled = false;
                });
        }

        // Función unificada para verificar si todos los requisitos están completos
        window.verificarTodosRequisitosCompletos = function () {
            const btnValidar = document.getElementById('btnValidarYContinuar');

            if (!btnValidar) {
                console.error('❌ No se encontró el botón de validar');
                return false;
            }

            // Use the data from the last API call instead of counting DOM elements
            const requisitosData = window.currentRequisitosData;
            if (!requisitosData) {
                console.warn('⚠️ No hay datos de requisitos disponibles');
                return false;
            }

            // Focus on mandatory requirements only for validation
            const totalRequisitosObligatorios = requisitosData.total_requisitos_obligatorios || 0;
            const requisitosObligatoriosCompletos = requisitosData.requisitos_obligatorios_completos || 0;
            const totalObligatoriosFaltantes = requisitosData.total_obligatorios_faltantes || 0;

            // Count files selected for incomplete mandatory requirements
            let archivosSeleccionadosParaObligatoriosIncompletos = 0;
            const requisitosObligatoriosIncompletos = (requisitosData.requisitos_obligatorios || []).filter(req => !req.esta_cumplido);

            requisitosObligatoriosIncompletos.forEach(requisito => {
                const fileInput = document.querySelector(`.requisito-file-input[data-requisito-id="${requisito.id}"]`);
                if (fileInput && fileInput.files && fileInput.files.length > 0) {
                    // Check if file input is visible (not hidden due to completion)
                    const isVisible = fileInput.offsetParent !== null ||
                        getComputedStyle(fileInput).display !== 'none';
                    if (isVisible) {
                        archivosSeleccionadosParaObligatoriosIncompletos++;
                    }
                }
            });

            console.log('🔍 Verificando requisitos obligatorios:', {
                totalRequisitosObligatorios,
                requisitosObligatoriosCompletos,
                totalObligatoriosFaltantes,
                archivosSeleccionadosParaObligatoriosIncompletos,
                requisitosObligatoriosIncompletos: requisitosObligatoriosIncompletos.length,
                requisitosDataComplete: window.currentRequisitosData
            });

            // Additional debug: Log current state of obligations
            console.log('📋 Estado actual de requisitos obligatorios:');
            (requisitosData.requisitos_obligatorios || []).forEach((req, index) => {
                console.log(`  ${index + 1}. ID: ${req.id}, Cumplido: ${req.esta_cumplido}, Nombre: ${req.nombre || 'Sin nombre'}`);
            });

            // Early return for no mandatory requirements
            if (totalRequisitosObligatorios === 0) {
                btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Continuar';
                btnValidar.className = 'btn btn-success';
                btnValidar.disabled = false;
                return true;
            }

            // All mandatory requirements completed
            if (totalObligatoriosFaltantes === 0) {
                btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Requisitos Obligatorios Completos - Continuar';
                btnValidar.className = 'btn btn-success';
                btnValidar.disabled = false;
                return true;
            }

            // Files selected for incomplete mandatory requirements
            if (archivosSeleccionadosParaObligatoriosIncompletos > 0) {
                btnValidar.innerHTML = `<i class="fas fa-upload me-2"></i>Validar y Continuar (${requisitosObligatoriosCompletos}/${totalRequisitosObligatorios} obligatorios)`;
                btnValidar.className = 'btn btn-primary';
                btnValidar.disabled = false;
                return false; // Not all complete, but can proceed with upload
            }

            // No files selected and mandatory requirements missing
            btnValidar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Completar Requisitos Obligatorios (${requisitosObligatoriosCompletos}/${totalRequisitosObligatorios})`;
            btnValidar.className = 'btn btn-warning';
            btnValidar.disabled = true;
            return false;
        };

        // Función unificada para configurar event listeners del modal
        window.configurarEventListenersModal = function (solicitudId, nuevaEtapaId, callbackExito, callbackCancelacion) {
            console.log('🔧 Configurando event listeners del modal:', { solicitudId, nuevaEtapaId });

            // Guardar para uso global
            window.currentSolicitudId = solicitudId;
            window.currentNuevaEtapaId = nuevaEtapaId;

            // Botón de validar y continuar
            const btnValidar = document.getElementById('btnValidarYContinuar');
            if (!btnValidar) {
                console.error('❌ No se encontró el botón de validar');
                return;
            }

            btnValidar.onclick = function () {
                console.log('🔄 Botón validar clickeado');

                // Early return if button is disabled
                if (btnValidar.disabled) {
                    console.log('⚠️ Botón deshabilitado, ignorando click');
                    return;
                }

                // Disable button immediately to prevent double clicks
                btnValidar.disabled = true;
                const originalHTML = btnValidar.innerHTML;

                // Get current requirements state
                const totalRequisitos = document.querySelectorAll('.requisito-card').length;
                const requisitosCompletos = document.querySelectorAll('.requisito-card .badge.bg-success').length;

                // Get files that need to be uploaded
                const requisitosConArchivos = document.querySelectorAll('.requisito-card .requisito-file-input');
                const archivosParaSubir = [];

                requisitosConArchivos.forEach(input => {
                    if (input.files && input.files.length > 0) {
                        const requisitoCard = input.closest('.requisito-card');
                        const badge = requisitoCard?.querySelector('.badge');

                        // Only upload if not already completed
                        if (badge && !badge.classList.contains('bg-success')) {
                            archivosParaSubir.push({
                                requisitoId: input.dataset.requisitoId,
                                file: input.files[0]
                            });
                        }
                    }
                });

                console.log('📁 Archivos para subir:', archivosParaSubir.length);
                console.log('🔍 Verificando requisitos:', {
                    totalRequisitos,
                    requisitosCompletos,
                    archivosSeleccionados: archivosParaSubir.length
                });

                // Function to handle success completion
                const handleSuccessCompletion = () => {
                    console.log('✅ Todos los requisitos completos, procediendo con transición');
                    
                    // Show success animation on the modal content
                    const modalContent = document.querySelector('#modalRequisitosFaltantes .modal-content');
                    if (modalContent) {
                        modalContent.style.transform = 'scale(1.02)';
                        modalContent.style.boxShadow = '0 0 30px rgba(40, 167, 69, 0.3)';
                        modalContent.style.transition = 'all 0.3s ease';
                        
                        setTimeout(() => {
                            modalContent.style.transform = '';
                            modalContent.style.boxShadow = '';
                        }, 300);
                    }

                    // Show success notification for requirements
                    showStageChangeNotification('Requisitos completados exitosamente', 'success');
                    
                    // Close modal with delay for animation
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalRequisitosFaltantes'));
                        if (modal) {
                            modal.hide();
                        }
                        
                        // Execute callback with slight delay for smooth transition
                        setTimeout(() => {
                            if (callbackExito) {
                                callbackExito();
                            }
                        }, 300);
                    }, 800);
                };

                // Function to handle error/incomplete state
                const handleIncompleteState = (currentCompleted, currentTotal) => {
                    // Only count mandatory requirements for validation
                    const requisitosData = window.currentRequisitosData;
                    const totalObligatorios = requisitosData ? (requisitosData.total_requisitos_obligatorios || 0) : 0;
                    const completedObligatorios = requisitosData ? (requisitosData.requisitos_obligatorios_completos || 0) : 0;
                    const pendingObligatorios = totalObligatorios - completedObligatorios;
                    
                    const mensaje = pendingObligatorios > 0 ? 
                        `Aún faltan ${pendingObligatorios} requisitos obligatorios por completar` :
                        `Aún faltan ${currentTotal - currentCompleted} requisitos por completar`;
                    
                    console.log("HandleIncompleteState - Obligatorios:", {
                        totalObligatorios, 
                        completedObligatorios, 
                        pendingObligatorios,
                        currentTotal, 
                        currentCompleted
                    });

                    btnValidar.innerHTML = totalObligatorios > 0 ? 
                        `<i class="fas fa-exclamation-triangle me-2"></i>Completar Requisitos Obligatorios (${completedObligatorios}/${totalObligatorios})` :
                        `<i class="fas fa-exclamation-triangle me-2"></i>Validar y Continuar (${currentCompleted}/${currentTotal})`;
                    btnValidar.className = 'btn btn-warning';
                    btnValidar.disabled = true;

                    if (typeof showToast !== 'undefined') {
                        showToast(mensaje, 'warning', 6000);
                    } else {
                        alert(mensaje);
                    }
                };

                // If there are files to upload, handle them first
                if (archivosParaSubir.length > 0) {
                    btnValidar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Subiendo archivos...';

                    // Show loading overlay with progress (removed to fix recursion error)
                    console.log(`📤 Iniciando carga de ${archivosParaSubir.length} archivos`);


                    // Upload files sequentially with proper error handling
                    window.subirArchivosSecuencialmente(archivosParaSubir, 0, function (uploadSuccess = true) {
                        // Hide loading overlay (removed to fix recursion error)
                        console.log('📤 Finalizando carga de archivos');


                        // Verify final state after uploads
                        window.verificarTodosRequisitosCompletos();

                        // Count only mandatory requirements for final validation
                        const requisitosData = window.currentRequisitosData;
                        const totalObligatorios = requisitosData ? (requisitosData.total_requisitos_obligatorios || 0) : 0;
                        const obligatoriosFaltantes = requisitosData ? (requisitosData.total_obligatorios_faltantes || 0) : 0;
                        
                        // Alternative counting from DOM as fallback
                        const finalTotalRequisitos = document.querySelectorAll('.requisito-card').length;
                        const finalRequisitosCompletos = document.querySelectorAll('.requisito-card .badge.bg-success').length;

                        // Use mandatory requirements logic if available, otherwise use all requirements
                        if (totalObligatorios > 0) {
                            if (obligatoriosFaltantes === 0 && uploadSuccess) {
                                handleSuccessCompletion();
                            } else {
                                const completedObligatorios = totalObligatorios - obligatoriosFaltantes;
                                handleIncompleteState(completedObligatorios, totalObligatorios);
                            }
                        } else {
                            if (finalTotalRequisitos === finalRequisitosCompletos && uploadSuccess) {
                                handleSuccessCompletion();
                            } else {
                                handleIncompleteState(finalRequisitosCompletos, finalTotalRequisitos);
                            }
                        }
                    });
                } else if (totalRequisitos === requisitosCompletos) {
                    // All requirements already completed, proceed immediately
                    handleSuccessCompletion();
                } else {
                    // Requirements still missing - use mandatory requirements logic
                    const requisitosData = window.currentRequisitosData;
                    const totalObligatorios = requisitosData ? (requisitosData.total_requisitos_obligatorios || 0) : 0;
                    const obligatoriosFaltantes = requisitosData ? (requisitosData.total_obligatorios_faltantes || 0) : 0;
                    
                    if (totalObligatorios > 0) {
                        const completedObligatorios = totalObligatorios - obligatoriosFaltantes;
                        handleIncompleteState(completedObligatorios, totalObligatorios);
                    } else {
                        handleIncompleteState(requisitosCompletos, totalRequisitos);
                    }
                }
            };

            // Configurar evento de cierre del modal
            const modal = document.getElementById('modalRequisitosFaltantes');
            if (modal) {
                modal.addEventListener('hidden.bs.modal', function () {
                    console.log('🚪 Modal cerrado');
                    if (callbackCancelacion) {
                        callbackCancelacion();
                    }
                });
            }
        }

        // Función para verificar que todas las funciones necesarias estén disponibles
        window.verificarFuncionesRequisitos = function () {
            const funcionesNecesarias = [
                'mostrarModalRequisitosFaltantes',
                'llenarListaRequisitosFaltantes',
                'configurarEventListenersModal',
                'verificarTodosRequisitosCompletos',
                'subirArchivosSecuencialmente',
                'resetearEstadoModal',
                'cerrarModalRequisitos',
                'ejecutarCambioEtapa'
            ];

            const funcionesFaltantes = funcionesNecesarias.filter(func => typeof window[func] !== 'function');

            if (funcionesFaltantes.length > 0) {
                console.error('❌ Funciones faltantes:', funcionesFaltantes);
                return false;
            }

            console.log('✅ Todas las funciones de requisitos están disponibles');
            return true;
        }

        // Función de prueba para verificar el sistema completo
        window.probarSistemaRequisitos = function () {
            console.log('🧪 Probando sistema de requisitos faltantes...');

            // Verificar funciones
            const funcionesOk = window.verificarFuncionesRequisitos();
            if (!funcionesOk) {
                console.error('❌ Falló la verificación de funciones');
                return false;
            }

            // Verificar modal
            const modalElement = document.getElementById('modalRequisitosFaltantes');
            if (!modalElement) {
                console.error('❌ Modal no encontrado');
                return false;
            }

            // Verificar elementos del modal
            const elementosNecesarios = [
                'listaRequisitosFaltantes',
                'btnValidarYContinuar',
                'etapaDestinoNombre',
                'loadingRequisitos'
            ];

            const elementosFaltantes = elementosNecesarios.filter(id => !document.getElementById(id));
            if (elementosFaltantes.length > 0) {
                console.error('❌ Elementos del modal faltantes:', elementosFaltantes);
                return false;
            }

            console.log('✅ Sistema de requisitos funcionando correctamente');
            console.log('💡 Para probar el modal, usa: window.mostrarModalRequisitosFaltantes(solicitudId, etapaId, "Nombre Etapa", callback)');
            return true;
        }

        // Función para ejecutar el cambio de etapa (tabla únicamente)
        window.ejecutarCambioEtapa = function (solicitudId, nuevaEtapaId, etapaActual, selectElement, subestadoSeleccionado = null) {
            console.log('🔄 Ejecutando cambio de etapa:', { solicitudId, nuevaEtapaId, etapaActual, subestadoSeleccionado });

            // Find the table row for animation
            const tableRow = selectElement ? selectElement.closest('tr') : null;
            const stageBadge = tableRow ? tableRow.querySelector('.badge, .stage-badge') : null;

            // Start animations
            const startAnimations = () => {
                // Disable select and add loading state
                if (selectElement) {
                    selectElement.disabled = true;
                    selectElement.classList.add('select-updating');
                    
                    // Add loading spinner next to select
                    const spinner = document.createElement('span');
                    spinner.className = 'stage-change-spinner';
                    spinner.id = `spinner-${solicitudId}`;
                    selectElement.parentNode.insertBefore(spinner, selectElement.nextSibling);
                }

                // Animate table row
                if (tableRow) {
                    tableRow.classList.add('row-updating');
                    tableRow.classList.add('stage-change-animation');
                }

                // Animate stage badge
                if (stageBadge) {
                    stageBadge.classList.add('updating');
                }

                // Show floating notification
                showStageChangeNotification('Cambiando etapa...', 'processing');
            };

            // End animations - success
            const endAnimationsSuccess = (message) => {
                // Remove loading states
                if (selectElement) {
                    selectElement.classList.remove('select-updating');
                    const spinner = document.getElementById(`spinner-${solicitudId}`);
                    if (spinner) spinner.remove();
                }

                if (tableRow) {
                    tableRow.classList.remove('row-updating');
                    tableRow.classList.add('stage-change-success');
                    
                    // Remove success class after animation
                    setTimeout(() => {
                        tableRow.classList.remove('stage-change-success');
                        tableRow.classList.remove('stage-change-animation');
                    }, 600);
                }

                if (stageBadge) {
                    stageBadge.classList.remove('updating');
                }

                // Update notification
                showStageChangeNotification(message || 'Etapa cambiada exitosamente', 'success');
            };

            // End animations - error
            const endAnimationsError = (message) => {
                // Remove loading states
                if (selectElement) {
                    selectElement.classList.remove('select-updating');
                    const spinner = document.getElementById(`spinner-${solicitudId}`);
                    if (spinner) spinner.remove();
                }

                if (tableRow) {
                    tableRow.classList.remove('row-updating');
                    tableRow.classList.remove('stage-change-animation');
                }

                if (stageBadge) {
                    stageBadge.classList.remove('updating');
                }

                // Show error notification
                showStageChangeNotification(message || 'Error al cambiar etapa', 'error');
            };

            // Start animations immediately
            startAnimations();

            // Preparar datos de la petición
            const requestData = {
                etapa_id: nuevaEtapaId
            };

            // Agregar subestado si se seleccionó uno
            if (subestadoSeleccionado) {
                requestData.subestado_id = subestadoSeleccionado;
                console.log('🔍 Incluyendo subestado en la petición:', subestadoSeleccionado);
            }

            // Realizar petición AJAX
            fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Respuesta del servidor:', data);
                    if (data.success) {
                        // Actualizar data attribute (solo para tabla)
                        if (selectElement) {
                            selectElement.setAttribute('data-etapa-actual', nuevaEtapaId);
                        }

                        // End animations with success
                        endAnimationsSuccess(data.mensaje);

                        // Show toast message
                        if (typeof showToast !== 'undefined') {
                            showToast(data.mensaje || 'Etapa cambiada exitosamente', 'success', 4000);
                        }

                        // Recargar página para actualizar la vista con delay for animations
                        setTimeout(function () {
                            location.reload();
                        }, 1500);
                    } else {
                        // Handle different error types
                        let errorMessage = 'Error desconocido';
                        
                        if (data.tipo_error === 'transicion_invalida') {
                            errorMessage = 'Transición no válida: ' + data.mensaje;
                        } else if (data.tipo_error === 'requisitos_faltantes') {
                            errorMessage = 'Requisitos faltantes: ' + data.mensaje;
                        } else {
                            errorMessage = 'Error: ' + (data.error || data.mensaje);
                        }

                        // End animations with error
                        endAnimationsError(errorMessage);

                        // Show toast message
                        if (typeof showToast !== 'undefined') {
                            const toastType = data.tipo_error === 'requisitos_faltantes' ? 'warning' : 'error';
                            showToast(errorMessage, toastType, 6000);
                        } else {
                            alert(errorMessage);
                        }

                        // Revertir selección
                        if (selectElement) {
                            selectElement.value = etapaActual;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // End animations with error
                    endAnimationsError('Error de conexión');

                    if (typeof showToast !== 'undefined') {
                        showToast('Error al cambiar etapa', 'error', 6000);
                    } else {
                        alert('Error al cambiar etapa');
                    }

                    // Revertir selección
                    if (selectElement) {
                        selectElement.value = etapaActual;
                    }
                })
                .finally(() => {
                    // Habilitar select
                    if (selectElement) {
                        selectElement.disabled = false;
                    }
                });
        }

        // Helper function to show stage change notifications
        window.showStageChangeNotification = function(message, type = 'success') {
            // Remove existing notification
            const existingNotification = document.querySelector('.stage-change-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'stage-change-notification';
            
            // Set icon based on type
            let icon = '';
            if (type === 'success') {
                icon = '<i class="fas fa-check-circle"></i>';
            } else if (type === 'error') {
                icon = '<i class="fas fa-exclamation-circle"></i>';
            } else if (type === 'processing') {
                icon = '<i class="fas fa-spinner fa-spin"></i>';
            } else {
                icon = '<i class="fas fa-info-circle"></i>';
            }

            notification.innerHTML = `${icon} ${message}`;
            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Auto hide after delay (except for processing)
            if (type !== 'processing') {
                setTimeout(() => {
                    notification.classList.add('hide');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 400);
                }, type === 'error' ? 5000 : 3000);
            }

            return notification;
        }

        // Enhanced modal animation support
        window.enhanceModalAnimations = function() {
            const modal = document.getElementById('modalRequisitosFaltantes');
            if (!modal) return;

            // Add custom animation classes to modal
            modal.addEventListener('show.bs.modal', function () {
                // Add slide-down animation
                const modalDialog = modal.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.style.transform = 'translateY(-50px)';
                    modalDialog.style.opacity = '0';
                    modalDialog.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    
                    setTimeout(() => {
                        modalDialog.style.transform = 'translateY(0)';
                        modalDialog.style.opacity = '1';
                    }, 50);
                }

                // Show processing notification
                showStageChangeNotification('Verificando requisitos...', 'processing');
            });

            modal.addEventListener('hidden.bs.modal', function () {
                // Clean up animations
                const modalDialog = modal.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.style.transform = '';
                    modalDialog.style.opacity = '';
                    modalDialog.style.transition = '';
                }

                // Remove any processing notifications
                const existingNotification = document.querySelector('.stage-change-notification');
                if (existingNotification) {
                    existingNotification.remove();
                }
            });

            // Animate file uploads
            modal.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-subir-requisito')) {
                    const requisitoCard = e.target.closest('.requisito-card');
                    if (requisitoCard) {
                        requisitoCard.style.transform = 'scale(1.02)';
                        requisitoCard.style.transition = 'transform 0.2s ease';
                        
                        setTimeout(() => {
                            requisitoCard.style.transform = '';
                        }, 200);
                    }
                }
            });
        }

        // Initialize modal animations when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            enhanceModalAnimations();
        });

        // Utility function to animate cell content changes
        window.animateCellUpdate = function(cellElement, newContent, type = 'success') {
            if (!cellElement) return;

            // Add updating class
            cellElement.classList.add('cell-updating');

            // Update content after animation starts
            setTimeout(() => {
                if (typeof newContent === 'string') {
                    cellElement.innerHTML = newContent;
                } else if (typeof newContent === 'function') {
                    newContent(cellElement);
                }

                // Add success class if specified
                if (type === 'success') {
                    cellElement.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                    setTimeout(() => {
                        cellElement.style.backgroundColor = '';
                    }, 1000);
                }
            }, 300);

            // Remove updating class
            setTimeout(() => {
                cellElement.classList.remove('cell-updating');
            }, 1000);
        }

        // Utility function to animate row updates
        window.animateRowUpdate = function(rowElement) {
            if (!rowElement) return;

            rowElement.classList.add('stage-change-success');
            setTimeout(() => {
                rowElement.classList.remove('stage-change-success');
            }, 600);
        }

        // Add smooth scrolling to changed elements
        window.scrollToUpdatedElement = function(element) {
            if (!element) return;

            element.scrollIntoView({
                behavior: 'smooth',
                block: 'center',
                inline: 'nearest'
            });

            // Add temporary highlight
            const originalBg = element.style.backgroundColor;
            element.style.backgroundColor = 'rgba(255, 235, 59, 0.3)';
            element.style.transition = 'background-color 0.3s ease';

            setTimeout(() => {
                element.style.backgroundColor = originalBg;
                setTimeout(() => {
                    element.style.transition = '';
                }, 300);
            }, 1500);
        }

        // Función para abrir modal de agenda de firma
        window.abrirModalAgendaFirma = async function(requisitoId) {
        try {
            console.log('📅 Abriendo modal para agendar firma, requisito ID:', requisitoId);
            
            // Obtener información de la solicitud actual desde múltiples fuentes
            let solicitudId = window.currentSolicitudId || 
                             document.querySelector('[data-solicitud-id]')?.getAttribute('data-solicitud-id') ||
                             window.currentModalSolicitudId ||
                             document.querySelector('meta[name="solicitud-id"]')?.getAttribute('content');
            
            // Intentar extraer de la URL si no se encuentra
            if (!solicitudId) {
                const urlParams = new URLSearchParams(window.location.search);
                solicitudId = urlParams.get('solicitud_id');
            }
            
            // Log para debug
            console.log('🔍 Buscando solicitudId:', {
                currentSolicitudId: window.currentSolicitudId,
                dataSolicitudId: document.querySelector('[data-solicitud-id]')?.getAttribute('data-solicitud-id'),
                currentModalSolicitudId: window.currentModalSolicitudId,
                metaContent: document.querySelector('meta[name="solicitud-id"]')?.getAttribute('content'),
                urlParam: new URLSearchParams(window.location.search).get('solicitud_id'),
                finalSolicitudId: solicitudId
            });
            
            if (!solicitudId) {
                console.error('❌ No se encontró ID de solicitud después de todos los intentos');
                if (typeof showToast !== 'undefined') {
                    showToast('Error: No se pudo identificar la solicitud. Por favor, recarga la página.', 'error');
                } else {
                    alert('Error: No se pudo identificar la solicitud. Por favor, recarga la página.');
                }
                return;
            }

            // Crear modal dinámico para agendar firma
            const modalHtml = `
                <div class="modal fade" id="modalAgendaFirma" tabindex="-1" aria-labelledby="modalAgendaFirmaLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content" style="border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);">
                            <!-- Header -->
                            <div class="modal-header" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); border: none; padding: 24px 32px 20px 32px;">
                                <h5 class="modal-title text-white fw-bold" id="modalAgendaFirmaLabel">
                                    <i class="fas fa-calendar-plus me-2"></i>
                                    Agendar Cita de Firma
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            
                            <!-- Body -->
                            <div class="modal-body" style="padding: 32px;">
                                <form id="formAgendaFirma">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="fechaFirma" class="form-label fw-semibold">
                                                <i class="fas fa-calendar me-2 text-primary"></i>
                                                Fecha de la Cita *
                                            </label>
                                            <input type="date" class="form-control" id="fechaFirma" name="fecha" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="horaFirma" class="form-label fw-semibold">
                                                <i class="fas fa-clock me-2 text-primary"></i>
                                                Hora de la Cita *
                                            </label>
                                            <input type="time" class="form-control" id="horaFirma" name="hora" required>
                                        </div>
                                        <div class="col-12">
                                            <label for="lugarFirma" class="form-label fw-semibold">
                                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                                Lugar de la Firma *
                                            </label>
                                            <select class="form-select" id="lugarFirma" name="lugar_firma" required>
                                                <option value="">Seleccionar lugar...</option>
                                                <option value="delivery">Delivery</option>
                                                <option value="apoyo">Apoyo</option>
                                                <option value="casa_matriz">Casa Matriz</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label for="comentariosFirma" class="form-label fw-semibold">
                                                <i class="fas fa-comment me-2 text-secondary"></i>
                                                Comentarios
                                            </label>
                                            <textarea class="form-control" id="comentariosFirma" name="comentarios" rows="3" placeholder="Comentarios adicionales sobre la cita..."></textarea>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Footer -->
                            <div class="modal-footer" style="padding: 24px 32px; border: none; background: #f8f9fa;">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                                <button type="button" class="btn btn-primary" id="btnGuardarCitaFirma">
                                    <i class="fas fa-save me-2"></i>Agendar Cita
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remover modal existente si existe
            const existingModal = document.getElementById('modalAgendaFirma');
            if (existingModal) {
                existingModal.remove();
            }

            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Configurar event listener para guardar
            document.getElementById('btnGuardarCitaFirma').addEventListener('click', async () => {
                await guardarCitaFirma(solicitudId, requisitoId);
            });

            // Obtener referencia del modal
            const modalElement = document.getElementById('modalAgendaFirma');
            
            // Mostrar modal
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Limpiar modal del DOM cuando se cierre (usar once para evitar duplicados)
            modalElement.addEventListener('hidden.bs.modal', function cleanupModal() {
                // Remover event listener para evitar memory leaks
                modalElement.removeEventListener('hidden.bs.modal', cleanupModal);
                // Remover modal del DOM de forma segura
                if (modalElement && modalElement.parentNode) {
                    modalElement.remove();
                }
            }, { once: true });

        } catch (error) {
            console.error('❌ Error al abrir modal de agenda de firma:', error);
            if (typeof showToast !== 'undefined') {
                showToast('Error al abrir el formulario de agenda', 'error');
            } else {
                alert('Error al abrir el formulario de agenda');
            }
        }
        };

        // Función para guardar cita de firma
        async function guardarCitaFirma(solicitudId, requisitoId) {
            console.log('💾 Iniciando guardado de cita de firma:', { solicitudId, requisitoId });
            
            // Obtener referencia del botón y texto original fuera del try
            const btnGuardar = document.getElementById('btnGuardarCitaFirma');
            const textoOriginal = btnGuardar ? btnGuardar.innerHTML : '';
            
            try {
                const form = document.getElementById('formAgendaFirma');
                if (!form) {
                    console.error('❌ No se encontró el formulario formAgendaFirma');
                    throw new Error('No se encontró el formulario');
                }
                
                const formData = new FormData(form);
                
                // Validar campos requeridos
                const fecha = formData.get('fecha');
                const hora = formData.get('hora');
                const lugarFirma = formData.get('lugar_firma');
                const comentarios = formData.get('comentarios') || '';
                
                console.log('📋 Datos del formulario:', { fecha, hora, lugarFirma, comentarios });
                
                if (!fecha || !hora || !lugarFirma) {
                    console.warn('⚠️ Campos faltantes:', { fecha: !!fecha, hora: !!hora, lugarFirma: !!lugarFirma });
                    if (typeof showToast !== 'undefined') {
                        showToast('Por favor completa todos los campos obligatorios', 'warning');
                    } else {
                        alert('Por favor completa todos los campos obligatorios');
                    }
                    return;
                }

                // Combinar fecha y hora
                const fechaHora = `${fecha}T${hora}:00`;
                
                const data = {
                    solicitud_id: parseInt(solicitudId),
                    fecha_hora: fechaHora,
                    lugar_firma: lugarFirma,
                    comentarios: comentarios
                };

                console.log('📤 Datos a enviar:', data);

                // Obtener CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
                
                console.log('🔐 CSRF Token encontrado:', !!csrfToken);

                // Deshabilitar botón mientras se procesa
                if (btnGuardar) {
                    btnGuardar.disabled = true;
                    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                }

            // Enviar solicitud
            console.log('🌐 Enviando petición a API...');
            const response = await fetch('/workflow/api/agenda-firma/crear-cita/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            });

            console.log('📥 Respuesta recibida:', {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok
            });

            const result = await response.json();
            
            console.log('📋 Respuesta del servidor al crear cita:', result);

            if (result.success) {
                if (typeof showToast !== 'undefined') {
                    showToast('Cita de firma agendada exitosamente', 'success');
                } else {
                    alert('Cita de firma agendada exitosamente');
                }
                
                // Cerrar modal de agenda
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAgendaFirma'));
                if (modal) {
                    modal.hide();
                }
                
                // Actualizar solo el requisito de agenda de firma sin recargar todo el modal
                setTimeout(() => {
                    console.log('🔄 Actualizando requisito de agenda de firma sin recargar modal');
                    
                    // Cerrar modal de agenda primero si aún está abierto
                    const modalAgenda = document.getElementById('modalAgendaFirma');
                    if (modalAgenda) {
                        modalAgenda.remove();
                    }
                    
                    // Buscar el requisito específico de agenda de firma y actualizarlo
                    const requisitoCard = document.querySelector(`[data-requisito-id="${requisitoId}"]`);
                    if (requisitoCard) {
                        console.log('✅ Actualizando requisito de agenda de firma en el DOM');
                        
                        // Actualizar el borde de la tarjeta para mostrar que está completa
                        requisitoCard.className = 'card mb-3 requisito-card border-success';
                        
                        // Actualizar el contador en la sección de requisitos obligatorios
                        const seccionTitulo = requisitoCard.closest('.seccion-requisitos');
                        if (seccionTitulo) {
                            const badgeContador = seccionTitulo.querySelector('.badge.badge-obligatorio');
                            if (badgeContador && window.currentRequisitosData) {
                                const obligatoriosCompletos = window.currentRequisitosData.requisitos_obligatorios_completos;
                                const totalObligatorios = window.currentRequisitosData.total_requisitos_obligatorios;
                                badgeContador.textContent = `${obligatoriosCompletos}/${totalObligatorios}`;
                                
                                // Actualizar también el estilo del badge para reflejar el progreso
                                if (obligatoriosCompletos === totalObligatorios) {
                                    badgeContador.className = 'badge badge-obligatorio bg-success text-white';
                                } else if (obligatoriosCompletos > 0) {
                                    badgeContador.className = 'badge badge-obligatorio bg-warning text-dark';
                                } else {
                                    badgeContador.className = 'badge badge-obligatorio bg-danger text-white';
                                }
                            }
                        }
                        
                        // Obtener el título original para usarlo en el nuevo HTML
                        const titulo = requisitoCard.querySelector('.card-title');
                        
                        // Reemplazar completamente el contenido del card-body con la información de la cita agendada
                        const cardBody = requisitoCard.querySelector('.card-body');
                        if (cardBody) {
                            // Crear el HTML completo para el requisito completado
                            const requisitoCompletadoHtml = `
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6 class="card-title text-success mb-1">
                                            <i class="fas fa-check-circle me-2"></i>
                                            ${titulo ? titulo.textContent.replace(/^[^a-zA-Z]*/, '') : 'Agenda de Firma'}
                                        </h6>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-success">Completo</span>
                                    </div>
                                </div>
                                
                                <div class="alert alert-success mb-3" style="border-radius: 12px; border: none; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(25, 135, 84, 0.15));">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-calendar-check me-3 mt-1 text-success" style="font-size: 1.5rem;"></i>
                                        <div class="flex-grow-1">
                                            <h6 class="alert-heading mb-2 text-success fw-bold">
                                                <i class="fas fa-check-circle me-2"></i>
                                                Firma Agendada
                                            </h6>
                                            <div class="row g-2">
                                                <div class="col-md-6">
                                                    <strong>Fecha:</strong><br>
                                                    <span class="text-success">${new Date(fechaHora).toLocaleDateString('es-ES', { 
                                                        year: 'numeric', 
                                                        month: 'long', 
                                                        day: 'numeric' 
                                                    })} a las ${new Date(fechaHora).toLocaleTimeString('es-ES', { 
                                                        hour: '2-digit', 
                                                        minute: '2-digit' 
                                                    })}</span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Lugar:</strong><br>
                                                    <span class="text-success">${lugarFirma === 'casa_matriz' ? 'Casa Matriz' : 
                                                          lugarFirma === 'delivery' ? 'Delivery' : 
                                                          lugarFirma === 'apoyo' ? 'Apoyo' : lugarFirma}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Reemplazar completamente el contenido del card-body
                            cardBody.innerHTML = requisitoCompletadoHtml;
                            
                            // Verificar que no queden elementos del estado anterior
                            const elementosAnteriores = cardBody.querySelectorAll('.alert-warning, .btn-warning');
                            elementosAnteriores.forEach(elemento => {
                                console.log('🗑️ Eliminando elemento del estado anterior:', elemento);
                                elemento.remove();
                            });
                        }
                        
                        // Actualizar el objeto de datos global para reflejar el cambio
                        if (window.currentRequisitosData && window.currentRequisitosData.requisitos_obligatorios) {
                            const requisito = window.currentRequisitosData.requisitos_obligatorios.find(req => req.id == requisitoId);
                            if (requisito) {
                                requisito.esta_cumplido = true;
                                
                                // Recalcular contadores
                                const obligatoriosCompletos = window.currentRequisitosData.requisitos_obligatorios.filter(req => req.esta_cumplido).length;
                                const totalObligatorios = window.currentRequisitosData.requisitos_obligatorios.length;
                                
                                window.currentRequisitosData.requisitos_obligatorios_completos = obligatoriosCompletos;
                                window.currentRequisitosData.total_obligatorios_faltantes = totalObligatorios - obligatoriosCompletos;
                                
                                console.log('📊 Contadores actualizados:', {
                                    obligatoriosCompletos,
                                    totalObligatorios,
                                    faltantes: window.currentRequisitosData.total_obligatorios_faltantes
                                });
                            }
                        }
                        
                        // Actualizar el contador de requisitos obligatorios
                        window.verificarTodosRequisitosCompletos();
                        
                        // Verificar si todos los requisitos obligatorios están completos
                        const todosObligatoriosCompletos = window.currentRequisitosData && 
                            window.currentRequisitosData.total_obligatorios_faltantes === 0;
                        
                        // Actualizar el botón "Validar y Continuar" para mostrar el conteo correcto
                        const btnValidar = document.getElementById('btnValidarYContinuar');
                        if (btnValidar && window.currentRequisitosData) {
                            const obligatoriosCompletos = window.currentRequisitosData.requisitos_obligatorios_completos;
                            const totalObligatorios = window.currentRequisitosData.total_requisitos_obligatorios;
                            
                            if (todosObligatoriosCompletos) {
                                btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Requisitos Obligatorios Completos - Continuar';
                                btnValidar.className = 'btn btn-success';
                                btnValidar.disabled = false;
                                console.log('🎉 Todos los requisitos obligatorios completos, ejecutando callback de éxito');
                                // Solo ejecutar callback si realmente se completaron todos los requisitos
                                if (window.currentCallbackExito && typeof window.currentCallbackExito === 'function') {
                                    setTimeout(() => {
                                        window.currentCallbackExito();
                                    }, 500);
                                }
                            } else {
                                btnValidar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Completar Requisitos Obligatorios (${obligatoriosCompletos}/${totalObligatorios})`;
                                btnValidar.className = 'btn btn-warning';
                                btnValidar.disabled = true;
                                console.log('📋 Aún faltan requisitos obligatorios por completar');
                            }
                        }
                        
                        console.log('✅ Requisito de agenda de firma actualizado exitosamente');
                    } else {
                        console.warn('⚠️ No se encontró el requisito de agenda de firma para actualizar');
                    }
                }, 300);
                
            } else {
                throw new Error(result.error || 'Error desconocido al agendar la cita');
            }

            } catch (error) {
                console.error('❌ Error al guardar cita de firma:', {
                    error: error.message,
                    stack: error.stack,
                    solicitudId,
                    requisitoId,
                    csrfToken: !!csrfToken
                });
                
                let errorMessage = 'Error al agendar la cita';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Error de conexión. Verifica tu conexión a internet.';
                } else if (error.message.includes('CSRF')) {
                    errorMessage = 'Error de seguridad. Por favor, recarga la página.';
                } else {
                    errorMessage = `Error al agendar la cita: ${error.message}`;
                }
                
                if (typeof showToast !== 'undefined') {
                    showToast(errorMessage, 'error');
                } else {
                    alert(errorMessage);
                }
            } finally {
                console.log('🔄 Finalizando función guardarCitaFirma');
                // Restaurar botón
                if (btnGuardar) {
                    btnGuardar.disabled = false;
                    btnGuardar.innerHTML = textoOriginal || '<i class="fas fa-save me-2"></i>Agendar Cita';
                }
            }
        }

        // ========================================
        // NUEVA FUNCIONALIDAD: ALERTAS EN TABLA
        // ========================================
        
        /**
         * Función para abrir el modal de solicitud con un tab específico
         * @param {number} solicitudId - ID de la solicitud
         * @param {string} tabId - ID del tab a activar ('entrevista', 'documentos-urgentes', 'documentos-pendientes')
         */
        window.abrirModalSolicitudConTab = function(solicitudId, tabId) {
            console.log(`🎯 Abriendo modal de solicitud ${solicitudId} con tab: ${tabId}`);
            
            // Abrir el modal de solicitud directamente usando mostrarModalSolicitud
            if (typeof window.mostrarModalSolicitud === 'function') {
                // Abrir modal directamente con el tab específico
                window.mostrarModalSolicitud(solicitudId, tabId);
                
                // Esperar a que el modal se abra y luego cambiar al tab específico
                setTimeout(() => {
                    activarTabEspecifico(tabId);
                }, 500); // Dar tiempo para que el modal se cargue
                
            } else if (typeof handleRowClick === 'function') {
                // Fallback: usar handleRowClick con evento simulado
                const fakeEvent = { target: null, stopPropagation: () => {} };
                handleRowClick(fakeEvent, solicitudId);
                
                setTimeout(() => {
                    activarTabEspecifico(tabId);
                }, 500);
            } else {
                console.error('❌ Funciones de modal no encontradas');
            }
        };
        
        /**
         * Función para activar un tab específico en el modal
         * @param {string} tabId - ID del tab a activar
         */
        /**
         * Función para actualizar los íconos de alertas en la tabla principal
         * después de crear/modificar notas y recordatorios
         */
        function actualizarIconosTablaNegocios() {
            console.log('🔄 Actualizando íconos de la tabla de negocios...');
            
            // Recargar la página para mostrar los nuevos recordatorios
            // TODO: En el futuro, esto se puede optimizar con una llamada AJAX
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
        
        // Hacer la función disponible globalmente
        window.actualizarIconosTablaNegocios = actualizarIconosTablaNegocios;
        
        function activarTabEspecifico(tabId) {
            console.log(`🔄 Intentando activar tab: ${tabId}`);
            
            let tabElement = null;
            let tabContent = null;
            
            // Mapear IDs de tab a elementos reales
            switch(tabId) {
                case 'entrevista':
                    // Para entrevista, activar la funcionalidad de asociar entrevista
                    if (typeof manejarClickEntrevista === 'function') {
                        console.log('🔗 Activando funcionalidad de entrevista');
                        manejarClickEntrevista();
                    } else {
                        console.warn('⚠️ Función manejarClickEntrevista no encontrada');
                    }
                    return;
                    
                case 'documentos-urgentes':
                    tabElement = document.getElementById('documentos-urgentes-tab');
                    tabContent = document.getElementById('documentos-urgentes');
                    break;
                    
                case 'documentos-pendientes':
                    tabElement = document.getElementById('documentos-pendientes-tab');
                    tabContent = document.getElementById('documentos-pendientes');
                    break;
                    
                default:
                    console.warn(`⚠️ Tab ID no reconocido: ${tabId}`);
                    return;
            }
            
            // Activar el tab si se encontró
            if (tabElement) {
                console.log(`✅ Activando tab: ${tabId}`);
                
                // Usar Bootstrap para activar el tab
                if (window.bootstrap && bootstrap.Tab) {
                    const tab = new bootstrap.Tab(tabElement);
                    tab.show();
                } else {
                    // Fallback: activar manualmente
                    tabElement.click();
                }
                
                // Hacer scroll al contenido si es necesario
                if (tabContent) {
                    setTimeout(() => {
                        tabContent.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 200);
                }
            } else {
                console.warn(`⚠️ No se encontró el elemento del tab: ${tabId}`);
            }
        }

    })(); // Close IIFE
</script>



{% endblock %}