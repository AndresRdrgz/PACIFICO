{% extends 'workflow/base.html' %}
{% load static %}
{% load workflow_filters %}

{% block title %}Negocios - Sistema de Workflow{% endblock %}



{% block content %}
<div class="mt-0 pt-0">
    {% if not no_access %}
        <!-- Header Estático - Sin Animaciones -->
        <div class="card mb-1" style="border: 1px solid #e0e0e0;">
            <div class="card-header" style="background: var(--verde-pacifico); padding: 12px 20px; border-radius: 0; border: none;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0 text-white fw-bold">
                            <i class="fas fa-briefcase me-2"></i>
                            {% if pipeline %}{{ pipeline.nombre }}{% else %}Pipeline de Negocio{% endif %}
                        </h1>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- Selector de Pipeline -->
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownPipeline" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-project-diagram me-1"></i>
                                Pipelines
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownPipeline" style="z-index: 9999;">
                                {% for p in pipelines %}
                                <li>
                                    <a class="dropdown-item {% if pipeline and p.id == pipeline.id %}active{% endif %}" 
                                       href="?pipeline={{ p.id }}&view={{ request.GET.view|default:'table' }}">
                                        {{ p.nombre }}
                                    </a>
                                </li>
                                {% empty %}
                                <li><span class="dropdown-item-text text-muted">No hay pipelines disponibles</span></li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <!-- Botones de cambio de vista -->
                        <div class="btn-group" role="group" aria-label="Cambiar vista">
                            <button type="button" class="btn btn-light btn-sm active" id="btnVistaTabla" onclick="cambiarVista('table')">
                                <i class="fas fa-table me-1"></i>
                                Tabla
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm" id="btnVistaKanban" onclick="cambiarVista('kanban')">
                                <i class="fas fa-columns me-1"></i>
                                Kanban
                            </button>
                        </div>
                        
                        {% if pipeline %}
                        <a href="#" class="btn btn-light btn-sm" onclick="openSolicitudDrawerWithContext('{{ pipeline.id }}')">
                            <i class="fas fa-plus me-1"></i>Nueva Solicitud
                        </a>
                        {% else %}
                        <a href="#" class="btn btn-light btn-sm" onclick="openSolicitudDrawerWithContext()">
                            <i class="fas fa-plus me-1"></i>Nueva Solicitud
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% if no_access %}
    <!-- Mensaje de acceso denegado -->
    <div class="card">
        <div class="card-body text-center py-5">
            <div class="mb-4">
                <i class="fas fa-lock fa-4x text-muted mb-3"></i>
                <h3 class="text-muted mb-3">Acceso Restringido</h3>
                {% if error_message %}
                    <p class="text-muted mb-4">{{ error_message }}</p>
                {% else %}
                    <p class="text-muted mb-4">No tienes acceso a ningún pipeline en el sistema de workflow.</p>
                {% endif %}
            </div>
            
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>¿Cómo obtener acceso?</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-user-tie me-2 text-primary"></i>Contacta a tu Administrador</h6>
                                    <p class="small text-muted">Solicita que te asignen permisos para acceder a los pipelines necesarios para tu trabajo.</p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-users me-2 text-success"></i>Únete a un Grupo</h6>
                                    <p class="small text-muted">Pregunta si existe un grupo de usuarios con acceso a los pipelines que necesitas.</p>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-cog me-2 text-warning"></i>Configuración de Permisos</h6>
                                    <p class="small text-muted">Los permisos se configuran en la sección de administración del sistema.</p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-question-circle me-2 text-info"></i>¿Necesitas ayuda?</h6>
                                    <p class="small text-muted">Contacta al equipo de soporte técnico si tienes dudas sobre el acceso.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <a href="{% url 'workflow:dashboard' %}" class="btn btn-primary me-2">
                    <i class="fas fa-tachometer-alt me-2"></i>Ir al Dashboard
                </a>
                <a href="{% url 'main_menu' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-home me-2"></i>Menú Principal
                </a>
            </div>
        </div>
    </div>
    {% else %}

    {% if pipeline %}
        <!-- KPIs Estáticos en Fila Horizontal -->
    <div class="card mb-1" id="kpis-section" style="border: 1px solid #e0e0e0;">
        <div class="card-body py-2">
            <div class="row g-2">
                <div class="col-3">
                    <div class="kpi-card-compact kpi-total">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Total</p>
                            <h4 class="kpi-number-compact">{{ page_obj.paginator.count }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-activas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Activas</p>
                            <h4 class="kpi-number-compact">{{ solicitudes|filter_activas|length }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-completadas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Completadas</p>
                            <h4 class="kpi-number-compact">{{ solicitudes|filter_completadas|length }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-vencidas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Vencidas</p>
                            <h4 class="kpi-number-compact">{{ solicitudes|filter_vencidas|length }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if pipeline %}
    {% if view_type == 'table' %}

    <!-- Leyenda SLA Compacta -->
    <small class="text-muted mb-2 d-block" style="font-size: 0.7rem;">
        <i class="fas fa-info-circle me-1"></i>Leyenda SLA:
        <i class="fas fa-circle text-success me-1 ms-2" style="font-size: 0.5rem;"></i>En tiempo
        <i class="fas fa-circle text-warning me-1 ms-2" style="font-size: 0.5rem;"></i>Por vencer
        <i class="fas fa-circle text-danger me-1 ms-2" style="font-size: 0.5rem;"></i>Vencido
    </small>

    <!-- Vista Móvil Mejorada: Solo visible en pantallas pequeñas -->
    <div class="vista-movil d-block d-sm-none">
        <!-- Barra de búsqueda móvil -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4 border">
            <div class="relative">
                <input type="text" id="busquedaMovil" 
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                       placeholder="Buscar por código, cliente o cédula...">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Tarjetas de solicitudes -->
        <div class="space-y-4" id="solicitudesMovil">
            {% for s in solicitudes_tabla %}
                <div class="solicitud-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow duration-200" 
                     data-prioridad="{{ s.prioridad|lower }}" 
                     data-estado="{{ s.sla_color }}"
                     data-asignado="{% if s.asignado_a == 'Sin asignar' %}sin_asignar{% else %}asignado{% endif %}"
                     data-search="{{ s.codigo|lower }} {{ s.cliente|lower }} {{ s.cedula|lower }}">
                    
                    <!-- Header de la tarjeta -->
                    <div class="p-4 pb-3">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <!-- Indicador de SLA -->
                                <div class="w-3 h-3 rounded-full 
                                    {% if s.sla_color == 'text-danger' %}bg-red-500
                                    {% elif s.sla_color == 'text-warning' %}bg-yellow-500
                                    {% elif s.sla_color == 'text-success' %}bg-green-500
                                    {% else %}bg-gray-400{% endif %}">
                                </div>
                                <h3 class="text-lg font-bold text-gray-900">{{ s.codigo }}</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- Badge de prioridad -->
                                {% if s.prioridad %}
                                <span class="px-2 py-1 rounded-full text-xs font-semibold
                                    {% if s.prioridad == 'Alta' %}bg-red-100 text-red-800
                                    {% elif s.prioridad == 'Media' %}bg-yellow-100 text-yellow-800
                                    {% elif s.prioridad == 'Baja' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ s.prioridad }}
                                </span>
                                {% endif %}
                                <!-- Menú de opciones -->
                                <div class="relative">
                                    <button class="p-1 rounded-full hover:bg-gray-100 transition-colors" onclick="toggleMenu(this)">
                                        <i class="fas fa-ellipsis-v text-gray-400"></i>
                                    </button>
                                    <div class="menu-dropdown absolute right-0 top-8 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10 hidden min-w-40">
                                        <a href="{% url 'workflow:detalle_solicitud' s.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            <i class="fas fa-eye mr-2"></i>Ver Detalle
                                        </a>
                                        <a href="{% url 'workflow:transicion_solicitud' s.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            <i class="fas fa-arrow-right mr-2"></i>Cambiar Etapa
                                        </a>
                                        {% if s.acciones.eliminar %}
                                        <button onclick="eliminarSolicitud('{{ s.id }}')" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                            <i class="fas fa-trash mr-2"></i>Eliminar
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Información principal -->
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Cliente</p>
                                <p class="text-sm font-semibold text-gray-900 truncate">
                                    <a href="{% url 'workflow:detalle_solicitud' s.id %}" 
                                       class="text-decoration-none text-success solicitud-link" 
                                       title="Ver detalles de {{ s.cliente_nombre }}"
                                       onclick="event.stopPropagation();">
                                        {{ s.cliente_nombre }}
                                    </a>
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Monto</p>
                                <p class="text-sm font-bold text-green-600">{{ s.monto_formateado }}</p>
                            </div>
                        </div>

                        <!-- Información secundaria -->
                        <div class="space-y-2 mb-3">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Cédula:</span>
                                <span class="text-gray-900 font-medium">{{ s.cliente_cedula }}</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Producto:</span>
                                <span class="text-gray-900 font-medium truncate ml-2">{{ s.producto_descripcion }}</span>
                            </div>
                                                    <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Propietario:</span>
                            <div class="flex items-center space-x-1">
                                {% if s.propietario_user.userprofile.profile_picture %}
                                    <img src="{{ s.propietario_user.userprofile.profile_picture.url }}" 
                                         alt="{{ s.propietario_user.get_full_name|default:s.propietario_user.username }}"
                                         class="w-4 h-4 rounded-full object-cover border">
                                {% else %}
                                    <div class="w-4 h-4 bg-gray-300 rounded-full flex items-center justify-center text-xs font-medium text-gray-600">
                                        {{ s.propietario_user.first_name|first|default:s.propietario_user.username|first|upper }}
                                    </div>
                                {% endif %}
                                <span class="text-gray-900 font-medium truncate text-xs">{{ s.propietario }}</span>
                            </div>
                        </div>
                        </div>

                        <!-- Asignación -->
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs text-gray-500 uppercase tracking-wide font-medium">Asignado a</span>
                            {% if s.asignado_a != 'Sin asignar' %}
                                <div class="flex items-center space-x-1">
                                    {% if s.asignado_a_user.userprofile.profile_picture %}
                                        <img src="{{ s.asignado_a_user.userprofile.profile_picture.url }}" 
                                             alt="{{ s.asignado_a_user.get_full_name|default:s.asignado_a_user.username }}"
                                             class="w-4 h-4 rounded-full object-cover border">
                                    {% else %}
                                        <div class="w-4 h-4 bg-blue-100 rounded-full flex items-center justify-center text-xs font-medium text-blue-600">
                                            {{ s.asignado_a_user.first_name|first|default:s.asignado_a_user.username|first|upper }}
                                        </div>
                                    {% endif %}
                                    <span class="text-sm font-medium text-gray-900 truncate">{{ s.asignado_a }}</span>
                                </div>
                            {% else %}
                                <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">
                                    <i class="fas fa-user-slash mr-1"></i>Sin asignar
                                </span>
                            {% endif %}
                        </div>

                        <!-- Etapa y Estado -->
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Etapa</p>
                                {% if s.etapa %}
                                <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                    {{ s.etapa }}
                                </span>
                                {% endif %}
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Estado</p>
                                <span class="inline-block px-2 py-1 bg-{{ s.estado_color }} text-white rounded-full text-xs font-medium">
                                    {{ s.estado_actual }}
                                </span>
                            </div>
                        </div>

                        <!-- Etiquetas -->
                        {% if s.etiquetas_oficial %}
                        <div class="mb-3">
                            <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Etiquetas</p>
                            <span class="inline-block px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                                {{ s.etiquetas_oficial }}
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Footer con SLA y fechas -->
                    <div class="px-4 py-3 bg-gray-50 border-t border-gray-100">
                        <div class="flex items-center justify-between text-xs">
                            <div class="flex items-center space-x-4">
                                <div>
                                    <span class="text-gray-500">Creado:</span>
                                    <span class="text-gray-900 font-medium">{{ s.fecha_inicio }}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">SLA:</span>
                                    <span class="font-medium {{ s.sla_color }}">{{ s.sla_restante }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="p-4 pt-3 bg-gray-50">
                        <div class="flex space-x-2">
                            <a href="{% url 'workflow:detalle_solicitud' s.id %}" 
                               class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-eye mr-1"></i>Ver
                            </a>
                            <a href="{% url 'workflow:transicion_solicitud' s.id %}" 
                               class="flex-1 bg-gray-600 hover:bg-gray-700 text-white text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-arrow-right mr-1"></i>Etapa
                            </a>
                            {% if s.acciones.eliminar %}
                            <button onclick="eliminarSolicitud('{{ s.id }}')" 
                                    class="bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-inbox text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No hay solicitudes</h3>
                    <p class="text-gray-500">No se encontraron solicitudes que coincidan con los filtros aplicados.</p>
                </div>
            {% endfor %}
        </div>

        <!-- Paginación móvil -->
        {% if page_obj.has_other_pages %}
        <div class="mt-6 flex justify-center">
            <nav class="flex items-center space-x-1">
                {% if page_obj.has_previous %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {% endif %}
                
                <span class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-gray-300">
                    {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </div>

    <!-- Tabla Desktop Mejorada con DataTable -->
    <div class="vista-desktop d-none d-sm-block">
        <div class="card card-custom">
            <!-- Filtros Responsivos Mejorados -->
            <div class="card-header-custom bg-light" style="border-bottom: 1px solid #dee2e6;">
                <div class="row g-2 align-items-center">
                    <!-- Primera fila: Filtros principales -->
                    <div class="col-12 col-lg-8">
                        <div class="row g-2">
                            <div class="col-6 col-md-6 col-lg-6">
                                <select id="filtroEtapa" class="form-select form-select-sm">
                                    <option value="">Todas las etapas</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-6 col-lg-6">
                                <select id="filtroSLA" class="form-select form-select-sm">
                                    <option value="">Todos los SLA</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Segunda fila: Búsqueda y controles -->
                    <div class="col-12 col-lg-4">
                        <div class="d-flex gap-2 align-items-center justify-content-lg-end">
                            <input type="text" id="busquedaGlobal" class="form-control form-control-sm flex-grow-1" 
                                   placeholder="Buscar..." 
                                   style="max-width: 200px;">
                            <button type="button" class="btn btn-sm btn-outline-success" id="exportarExcel" title="Exportar a Excel">
                                <i class="fas fa-file-excel"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" id="limpiarFiltros" title="Limpiar filtros">
                                <i class="fas fa-filter-circle-xmark"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0" style="border: none;">
                <div class="table-container" style="height: 80vh; overflow: hidden; border: none;">
                    <div class="table-responsive" style="height: 100%; border: none;">
                        <table class="table table-hover workflow-table mb-0" id="tablaSolicitudes" style="border: none;">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th class="fw-bold" style="width: 200px;">Cliente</th>
                                    <th class="fw-bold" style="width: 150px;">Producto</th>
                                    <th class="fw-bold" style="width: 120px;">Monto</th>
                                    <th class="fw-bold" style="width: 150px;">Propietario</th>
                                    <th class="fw-bold" style="width: 120px;">Etapa</th>
                                    <th class="fw-bold" style="width: 100px;">Estado</th>
                                    <th class="fw-bold" style="width: 200px;">Fecha<br>SLA</th>
                                    <th class="fw-bold" style="width: 120px;">SLA</th>
                                    <th class="fw-bold" style="width: 120px;">Etiquetas</th>
                                    <th class="fw-bold" style="width: 100px;">Prioridad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in solicitudes_tabla %}
                                <tr class="align-middle table-row-hover clickable-row {% if s.sla_color == 'text-danger' %}bg-danger bg-opacity-10{% endif %}" 
                                    data-solicitud-id="{{ s.id }}"
                                    data-etapa="{{ s.etapa_actual.nombre|default:'Sin etapa' }}"
                                    data-sla="{% if s.sla_color == 'text-danger' %}vencido{% elif s.sla_color == 'text-warning' %}por vencer{% elif s.sla_color == 'text-success' %}en tiempo{% else %}sin sla{% endif %}"
                                    onclick="handleRowClick(event, {{ s.id }})"
                                    style="cursor: pointer;">
                                    <td class="text-dark">
                                        <div>
                                            <div class="fw-semibold">
                                                <a href="{% url 'workflow:detalle_solicitud' s.id %}" 
                                                   class="text-decoration-none text-success solicitud-link" 
                                                   title="Ver detalles de {{ s.cliente_nombre }}"
                                                   onclick="event.stopPropagation();">
                                                    {{ s.cliente_nombre }}
                                                </a>
                                            </div>
                                            <small class="text-muted">{{ s.cliente_cedula }}</small>
                                        </div>
                                    </td>
                                    <td class="text-dark">{{ s.producto_descripcion }}</td>
                                    <td><span class="fw-bold text-success">{{ s.monto_formateado }}</span></td>
                                    <td class="text-dark">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user me-1 text-muted"></i>
                                            <span class="small">{{ s.propietario }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if s.etapa_actual and s.etapa_actual.es_bandeja_grupal %}
                                            <!-- Solicitud en bandeja grupal - deshabilitar cambio de etapa -->
                                            <div class="position-relative">
                                                <select class="form-select form-select-sm etapa-select" 
                                                        data-solicitud-id="{{ s.id }}" 
                                                        data-etapa-actual="{{ s.etapa_actual.id|default:'' }}"
                                                        style="min-width: 120px; opacity: 0.6; cursor: not-allowed;" 
                                                        disabled
                                                        title="Esta solicitud está en bandeja grupal. Debes esperar a que el equipo la procese antes de poder cambiar la etapa.">
                                                    <option value="{{ s.etapa_actual.id }}" selected>
                                                        {{ s.etapa_actual.nombre }}
                                                    </option>
                                                </select>
                                                <!-- Tooltip informativo -->
                                                <div class="position-absolute top-0 start-100 ms-2" style="z-index: 1000;">
                                                    <i class="fas fa-info-circle text-warning" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top"
                                                       title="⏳ Bandeja Grupal: Esta solicitud está siendo revisada por el equipo. Debes esperar a que sea asignada o procesada antes de poder cambiar la etapa."></i>
                                                </div>
                                            </div>
                                        {% else %}
                                            <!-- Solicitud normal - permitir cambio de etapa -->
                                            <select class="form-select form-select-sm etapa-select" 
                                                    data-solicitud-id="{{ s.id }}" 
                                                    data-etapa-actual="{{ s.etapa_actual.id|default:'' }}"
                                                    style="min-width: 120px;">
                                                {% if not s.etapa %}
                                                    <option value="" selected>Sin etapa</option>
                                                {% endif %}
                                                {% for etapa in pipeline.etapas.all %}
                                                    <option value="{{ etapa.id }}" 
                                                            {% if s.etapa == etapa.nombre %}selected{% endif %}>
                                                        {{ etapa.nombre }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-1">
                                            <span class="badge bg-{{ s.estado_color }}">{{ s.estado_actual }}</span>
                                            {% if s.etapa_actual and s.etapa_actual.es_bandeja_grupal %}
                                                <span class="badge bg-warning" title="Bandeja Grupal - En revisión por el equipo">
                                                    <i class="fas fa-users"></i>
                                                </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-dark" style="max-width: 200px;">
                                        <div style="line-height: 1.3;">
                                            <div class="d-flex align-items-center mb-1">
                                                <small class="text-muted me-1" style="min-width: 25px;">Ini:</small> 
                                                <span style="font-size: 0.85rem;">{{ s.fecha_inicio|date:"d/m" }}</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <small class="text-muted me-1" style="min-width: 25px;">Ven:</small> 
                                                <span style="font-size: 0.85rem;">{% if s.vencimiento_sla %}{{ s.vencimiento_sla|date:"d/m" }}{% else %}N/A{% endif %}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-center">
                                            <div class="{{ s.sla_color }} fw-bold" title="Tiempo restante">
                                                {{ s.sla_restante }}
                                            </div>
                                            <small class="text-muted">
                                                {% if s.sla_color == 'text-success' %}En tiempo
                                                {% elif s.sla_color == 'text-warning' %}Por vencer
                                                {% elif s.sla_color == 'text-danger' %}Vencido
                                                {% else %}N/A{% endif %}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <select class="etiquetas-select form-control form-control-sm" 
                                                data-id="{{ s.id }}" 
                                                style="min-width: 115px; width: 115px;">
                                            <option value="">Seleccionar etiqueta</option>
                                            <option value="no_responde" {% if s.etiquetas_oficial == 'no_responde' %}selected{% endif %}>📞 No responde</option>
                                            <option value="cita_agendada" {% if s.etiquetas_oficial == 'cita_agendada' %}selected{% endif %}>🗓️ Cita agendada</option>
                                            <option value="doc_completo" {% if s.etiquetas_oficial == 'doc_completo' %}selected{% endif %}>✅ Documentos completos</option>
                                            <option value="falta_carta" {% if s.etiquetas_oficial == 'falta_carta' %}selected{% endif %}>📎 Falta carta trabajo</option>
                                            <option value="seguimiento_48h" {% if s.etiquetas_oficial == 'seguimiento_48h' %}selected{% endif %}>🔄 Seguimiento en 48h</option>
                                            <option value="whatsapp_activo" {% if s.etiquetas_oficial == 'whatsapp_activo' %}selected{% endif %}>💬 WhatsApp activo</option>
                                            <option value="cliente_indeciso" {% if s.etiquetas_oficial == 'cliente_indeciso' %}selected{% endif %}>⚠️ Cliente indeciso</option>
                                            <option value="cliente_caliente" {% if s.etiquetas_oficial == 'cliente_caliente' %}selected{% endif %}>🚀 Cliente caliente</option>
                                            <option value="esperando_confirm" {% if s.etiquetas_oficial == 'esperando_confirm' %}selected{% endif %}>🕐 Esperando confirmación</option>
                                            <option value="enviado_credito" {% if s.etiquetas_oficial == 'enviado_credito' %}selected{% endif %}>🧾 Enviado a crédito</option>
                                            <option value="en_validacion" {% if s.etiquetas_oficial == 'en_validacion' %}selected{% endif %}>🔒 En validación</option>
                                            <option value="caso_descartado" {% if s.etiquetas_oficial == 'caso_descartado' %}selected{% endif %}>❌ Caso descartado</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="prioridad-select border rounded px-2 py-1 text-xs w-full"
                                                data-id="{{ s.id }}"
                                                style="background-color: {% if s.prioridad == 'Alta' %}#fee2e2{% elif s.prioridad == 'Media' %}#fef9c3{% elif s.prioridad == 'Baja' %}#dcfce7{% else %}white{% endif %}; color: {% if s.prioridad == 'Alta' %}#b91c1c{% elif s.prioridad == 'Media' %}#b45309{% elif s.prioridad == 'Baja' %}#166534{% else %}#333{% endif %};">
                                          <option value="">-</option>
                                          {% for prioridad in prioridades_posibles %}
                                            <option value="{{ prioridad }}" {% if s.prioridad == prioridad %}selected{% endif %}>{{ prioridad }}</option>
                                          {% endfor %}
                                        </select>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center py-4">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">No hay solicitudes para mostrar</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Paginación -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Paginación de solicitudes" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Anterior</a>
                        </li>
                        {% endif %}
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Siguiente</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>

    {% else %}
    <!-- Vista Kanban Mejorada -->
    
    <!-- Filtros Compactos para Kanban -->
    <div class="card card-custom mb-2">
        <div class="card-body py-2">
            <div class="row g-1 align-items-center">
                <div class="col-6 col-md-3">
                    <select id="kanbanFiltroEtapa" class="form-select form-select-sm">
                        <option value="">Todas las etapas</option>
                    </select>
                </div>
                <div class="col-6 col-md-3">
                    <select id="kanbanFiltroSLA" class="form-select form-select-sm">
                        <option value="">Todos los SLA</option>
                    </select>
                </div>
                <div class="col-12 col-md-5">
                    <input type="text" id="kanbanBusquedaGlobal" class="form-control form-control-sm" 
                           placeholder="Buscar...">
                </div>
                <div class="col-12 col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-info w-100" id="kanbanLimpiarFiltros">
                        <i class="fas fa-filter-circle-xmark"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contenedor Kanban con scroll horizontal -->
    <div class="kanban-container" style="height: calc(100vh - 280px); overflow-y: hidden; min-height: 700px;">
        <div class="kanban-board d-flex" style="overflow-x: auto; gap: 0.75rem; padding-bottom: 1rem;">
            {% for etapa in pipeline.etapas.all %}
            <div class="kanban-column" style="min-width: 320px; width: 320px; flex-shrink: 0;">
                <div class="card shadow h-100" style="border: 2px solid #e9ecef; border-radius: 12px; background: #ffffff;">
                    <!-- Header de etapa con búsqueda -->
                    <div class="card-header text-white" style="background: #28a745; border-radius: 12px 12px 0 0; border: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-bold text-white">
                                <i class="fas fa-list-ul me-2 text-white"></i>
                                {{ etapa.nombre }}
                            </h6>
                            <span class="badge bg-white text-success fw-bold" id="count-etapa-{{ etapa.id }}">
                                {{ solicitudes_por_etapa|get_item:etapa.id|length }}
                            </span>
                        </div>
                        <input type="text" class="form-control form-control-sm etapa-search" 
                               placeholder="Buscar en {{ etapa.nombre }}..." 
                               data-etapa-id="{{ etapa.id }}"
                               style="background: rgba(255,255,255,0.9); border: none;">
                    </div>
                    
                    <!-- Cuerpo de etapa con scroll -->
                    <div class="card-body p-3 kanban-column-body" 
                         style="height: calc(100vh - 380px); overflow-y: auto; background: #f8f9fa;"
                         data-etapa-id="{{ etapa.id }}">
                        
                        {% for s in solicitudes_por_etapa|get_item:etapa.id %}
                        <div class="kanban-card mb-3" 
                             draggable="true" 
                             data-solicitud-id="{{ s.id }}"
                             data-etapa-id="{{ etapa.id }}"
                             data-cliente="{{ s.cliente_nombre|default:'Sin cliente' }}"
                             data-estado="{{ s.estado_actual|default:'Sin estado' }}"
                             data-asignado="{{ s.asignado_a|default:'Sin asignar' }}"
                             data-sla="{% if s.sla_color == 'text-danger' %}vencido{% elif s.sla_color == 'text-warning' %}por vencer{% elif s.sla_color == 'text-success' %}en tiempo{% else %}sin sla{% endif %}"
                             data-search="{{ s.codigo|lower }} {{ s.cliente_nombre|lower }}"
                             data-codigo="{{ s.codigo }}"
                             data-monto="{{ s.monto_formateado }}"
                             data-fecha-inicio="{{ s.fecha_inicio_str|default:s.fecha_inicio }}"
                             data-sla-texto="{{ s.sla_restante }}"
                             style="cursor: grab;">
                             
                                                        <div class="card shadow-sm border-0" 
                                 style="border-left: 4px solid {% if s.sla_color == 'text-danger' %}#dc3545{% elif s.sla_color == 'text-warning' %}#ffc107{% elif s.sla_color == 'text-success' %}#198754{% else %}#6c757d{% endif %} !important; height: 110px; border-radius: 6px; transition: all 0.3s ease; background: white; cursor: pointer;"
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.15)'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'"
                                 onclick="window.location.href='{% url 'workflow:detalle_solicitud' s.id %}'">
                                <div class="card-body p-2" style="height: 100%;">
                                    <!-- Header compacto -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <h6 class="mb-0" style="font-size: 0.9rem;">
                                                <i class="fas fa-user text-muted me-1" style="font-size: 0.75rem; width: 12px;"></i>
                                                <a href="{% url 'workflow:detalle_solicitud' s.id %}" 
                                                   class="text-decoration-none fw-bold text-success solicitud-link-kanban" 
                                                   title="Ver detalles de {{ s.cliente_nombre }}"
                                                   onclick="event.stopPropagation();">
                                                    {{ s.cliente_nombre|truncatechars:15 }}
                                                </a>
                                            </h6>
                                            <small class="text-muted" style="font-size: 0.65rem;">{{ s.codigo }}</small>
                                        </div>
                                        
                                        <!-- Timer y Status -->
                                        <div class="text-end">
                                            <div class="d-flex align-items-center justify-content-end mb-1">
                                                <i class="fas fa-clock text-muted me-1" style="font-size: 0.75rem; width: 12px;"></i>
                                                <span class="{{ s.sla_color }} fw-bold" style="font-size: 0.7rem;">{{ s.sla_restante }}</span>
                                            </div>
                                            <span class="badge bg-{{ s.estado_color }}" style="font-size: 0.6rem; padding: 2px 5px;">{{ s.estado_actual }}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Contenido en 2 columnas -->
                                    <div class="row g-1">
                                        <!-- Columna izquierda -->
                                        <div class="col-7">
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="text-success fw-bold" style="font-size: 0.75rem;">{{ s.monto_formateado }}</span>
                                            </div>
                                            
                                            {% if s.asignado_a != 'Sin asignar' %}
                                            <div class="d-flex align-items-center">
                                                {% if s.asignado_a_user.userprofile.profile_picture %}
                                                    <img src="{{ s.asignado_a_user.userprofile.profile_picture.url }}" 
                                                         alt="{{ s.asignado_a_user.get_full_name|default:s.asignado_a_user.username }}"
                                                         class="w-4 h-4 rounded-full object-cover me-1">
                                                {% else %}
                                                    <div class="w-4 h-4 bg-blue-100 rounded-full flex items-center justify-center text-xs font-medium text-blue-600 me-1">
                                                        {{ s.asignado_a_user.first_name|first|default:s.asignado_a_user.username|first|upper }}
                                                    </div>
                                                {% endif %}
                                                <span style="font-size: 0.7rem; color: #6c757d;">{{ s.asignado_a|truncatechars:10 }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Columna derecha -->
                                        <div class="col-5 text-end">
                                            <div class="d-flex align-items-center justify-content-end">
                                                {% if s.prioridad %}
                                                <span class="badge me-1" 
                                                      style="font-size: 0.55rem; padding: 1px 4px; background-color: {% if s.prioridad == 'Alta' %}#fee2e2{% elif s.prioridad == 'Media' %}#fef9c3{% elif s.prioridad == 'Baja' %}#dcfce7{% else %}white{% endif %}; color: {% if s.prioridad == 'Alta' %}#b91c1c{% elif s.prioridad == 'Media' %}#b45309{% elif s.prioridad == 'Baja' %}#166534{% else %}#333{% endif %};">
                                                    {{ s.prioridad }}
                                                </span>
                                                {% endif %}
                                                <small class="text-muted" style="font-size: 0.65rem;">{{ s.fecha_inicio }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox text-muted mb-2"></i>
                            <p class="text-muted small">Sin solicitudes</p>
                        </div>
                        {% endfor %}
                        
                        <!-- Mensaje cuando no hay solicitudes -->
                        <div class="no-solicitudes text-center py-4" style="display: none;">
                            <i class="fas fa-inbox text-muted mb-2"></i>
                            <p class="text-muted small">Sin solicitudes</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Instrucciones para seleccionar un Pipeline -->
    <div class="card mb-4" style="border: 2px solid #e3f2fd; background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);">
        <div class="card-body text-center py-4">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="mb-4">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #2196f3, #1976d2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 8px 24px rgba(33, 150, 243, 0.3);">
                            <i class="fas fa-project-diagram text-white" style="font-size: 2rem;"></i>
                        </div>
                        <h3 class="text-primary fw-bold mb-3">Selecciona un Pipeline</h3>
                        <p class="text-muted mb-4" style="font-size: 1.1rem;">Para comenzar a gestionar solicitudes, elige uno de los pipelines disponibles a continuación.</p>
                    </div>
                    
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-4">
                            <div class="bg-white rounded-lg p-3 shadow-sm border">
                                <i class="fas fa-table text-primary mb-2" style="font-size: 1.5rem;"></i>
                                <h6 class="fw-bold text-dark mb-2">Vista de Tabla</h6>
                                <p class="text-muted small mb-0">Organiza las solicitudes en una tabla con filtros avanzados y búsqueda.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-white rounded-lg p-3 shadow-sm border">
                                <i class="fas fa-columns text-success mb-2" style="font-size: 1.5rem;"></i>
                                <h6 class="fw-bold text-dark mb-2">Vista Kanban</h6>
                                <p class="text-muted small mb-0">Visualiza el flujo de trabajo con columnas organizadas por etapas.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-white rounded-lg p-3 shadow-sm border">
                                <i class="fas fa-chart-line text-warning mb-2" style="font-size: 1.5rem;"></i>
                                <h6 class="fw-bold text-dark mb-2">KPIs y Métricas</h6>
                                <p class="text-muted small mb-0">Monitorea el rendimiento y el progreso de las solicitudes.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info border-0" style="background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196f3 !important;">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-info-circle text-primary me-3 mt-1" style="font-size: 1.2rem;"></i>
                            <div>
                                <h6 class="fw-bold text-primary mb-2">¿Qué es un Pipeline?</h6>
                                <p class="text-muted mb-2">Un pipeline es un flujo de trabajo que define las etapas y procesos que debe seguir una solicitud desde su creación hasta su finalización.</p>
                                <ul class="text-muted small mb-0">
                                    <li><strong>Etapas:</strong> Define los pasos del proceso</li>
                                    <li><strong>Requisitos:</strong> Documentos o condiciones necesarias</li>
                                    <li><strong>Permisos:</strong> Controla quién puede realizar cada acción</li>
                                    <li><strong>Seguimiento:</strong> Monitorea el progreso y tiempos</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selección de Pipeline -->
    <div class="row">
        {% for pipeline in pipelines %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card card-custom h-100">
                <div class="card-header-custom">
                    <h5 class="mb-0">{{ pipeline.nombre }}</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">{{ pipeline.descripcion|default:"Sin descripción" }}</p>
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="bg-success bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-success">{{ pipeline.solicitud_set.count }}</h6>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-info bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-info">{{ pipeline.etapas.count }}</h6>
                                <small class="text-muted">Etapas</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-warning bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-warning">{{ pipeline.requisitos_pipeline.count }}</h6>
                                <small class="text-muted">Requisitos</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="?pipeline={{ pipeline.id }}&view=table" class="btn btn-pacifico">
                            <i class="fas fa-table me-2"></i>Ver en Tabla
                        </a>
                        <a href="?pipeline={{ pipeline.id }}&view=kanban" class="btn btn-outline-pacifico">
                            <i class="fas fa-columns me-2"></i>Ver en Kanban
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-project-diagram fa-4x text-muted mb-3"></i>
                <h4 class="text-muted mb-3">No hay pipelines disponibles</h4>
                <p class="text-muted mb-4">Crea un pipeline para comenzar a gestionar solicitudes.</p>
                <a href="{% url 'workflow:admin_pipelines' %}" class="btn btn-pacifico">
                    <i class="fas fa-plus me-2"></i>Crear Pipeline
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endif %}
</div>

{% include 'workflow/partials/modalSolicitud.html' %}

{% include 'workflow/partials/modalRequisitos.html' %}

<!-- Modal de Confirmación Personalizado -->
<div class="modal fade" id="modalConfirmacionEtapa" tabindex="-1" aria-labelledby="modalConfirmacionEtapaLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);">
            <!-- Header con gradiente verde -->
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; padding: 24px 32px 20px 32px; position: relative; overflow: hidden;">
                <!-- Decoración de fondo -->
                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; opacity: 0.6;"></div>
                <div style="position: absolute; top: 40px; right: 60px; width: 60px; height: 60px; background: rgba(255, 255, 255, 0.08); border-radius: 50%;"></div>
                
                <div class="w-100 text-center position-relative">
                    <h4 class="modal-title text-white fw-bold mb-1" id="modalConfirmacionEtapaLabel" style="font-size: 1.4rem; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <i class="fas fa-exchange-alt me-2" style="font-size: 1.2rem;"></i>
                        Confirmar Cambio de Etapa
                    </h4>
                    <p class="text-white-50 mb-0" style="font-size: 0.9rem; font-weight: 500;">Sistema de Workflow</p>
                </div>
            </div>
            
            <div class="modal-body" style="padding: 32px;">
                <!-- Icono central -->
                <div class="text-center mb-4">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.15)); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 24px rgba(40, 167, 69, 0.2);">
                        <i class="fas fa-arrow-right" style="font-size: 2rem; color: #28a745; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"></i>
                    </div>
                </div>
                
                <!-- Mensaje principal -->
                <div class="text-center mb-4">
                    <h5 class="fw-bold mb-3" style="color: #2d3748; font-size: 1.2rem;">¿Está seguro del cambio?</h5>
                    <p class="text-muted mb-3" style="font-size: 0.95rem;">La solicitud se moverá a la siguiente etapa:</p>
                    
                    <!-- Caja verde con nombre de etapa -->
                    <div class="bg-success bg-opacity-10 border border-success border-opacity-25 rounded-3 p-3 mb-4" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.08), rgba(32, 201, 151, 0.12)) !important;">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-flag text-success me-2" style="font-size: 1.1rem;"></i>
                            <span id="nombreEtapaDestino" class="fw-bold text-success" style="font-size: 1.1rem;">Nombre de la Etapa</span>
                        </div>
                    </div>
                    
                    <!-- Selector de subestado (mostrar solo si la etapa tiene subestados) -->
                    <div id="selectorSubestado" class="mb-4" style="display: none;">
                        <h6 class="fw-bold mb-3 text-dark" style="font-size: 1rem;">
                            <i class="fas fa-list-ul text-primary me-2"></i>
                            Seleccionar estado específico:
                        </h6>
                        <div class="bg-white border border-success border-opacity-25 rounded-3 p-3">
                            <select id="subestadoSelect" class="form-select form-select-lg" style="border: 2px solid #e9ecef; border-radius: 8px; font-weight: 600;">
                                <option value="">Seleccionar estado...</option>
                            </select>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Este campo es requerido para esta etapa
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Información del cambio -->
                <div class="bg-light rounded-3 p-3 mb-4" style="border-left: 4px solid #28a745;">
                    <div class="d-flex align-items-start mb-2">
                        <i class="fas fa-info-circle text-primary me-2 mt-1" style="font-size: 1rem;"></i>
                        <div>
                            <h6 class="fw-bold mb-2 text-dark" style="font-size: 0.95rem;">Información del cambio:</h6>
                            <ul class="list-unstyled mb-0" style="font-size: 0.85rem; color: #6c757d; line-height: 1.6;">
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se actualizará el estado de la solicitud
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se registrará en el historial del sistema
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-check text-success me-2" style="font-size: 0.75rem;"></i>
                                    Se notificará a los usuarios correspondientes
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 24px 32px; border: none; background: #f8f9fa;">
                <button type="button" class="btn btn-outline-secondary" id="btnCancelarModal" style="font-weight: 600; padding: 12px 24px; border-radius: 8px; border-width: 2px;">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnAceptarModal" style="font-weight: 600; padding: 12px 24px; border-radius: 8px; background: linear-gradient(135deg, #28a745, #20c997); border: none; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                    <i class="fas fa-check me-2"></i>Aceptar
                </button>
            </div>
        </div>
    </div>
</div>
    {% endif %}

{% endblock %}

{% block extra_js %}
<!-- DataTables CSS y JS desde CDN -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>


<script>
// Stub functions to prevent recursion errors
window.showLoading = function(title, message) {
    console.log('📡 Loading:', title, message);
};

window.hideLoading = function() {
    console.log('📡 Loading hidden');
};

// Función global para manejar clicks en filas de la tabla
function handleRowClick(event, solicitudId) {
    // Prevenir el click si el usuario está interactuando con elementos de formulario
    if (event.target.tagName === 'SELECT' || 
        event.target.tagName === 'BUTTON' || 
        event.target.tagName === 'INPUT' ||
        event.target.closest('select') ||
        event.target.closest('button') ||
        event.target.closest('input') ||
        event.target.closest('.dropdown') ||
        event.target.closest('.menu-dropdown')) {
        return;
    }
    
    // Mostrar modal con resumen de la solicitud
    if (typeof window.mostrarModalSolicitud === 'function') {
        window.mostrarModalSolicitud(solicitudId);
    } else {
        // Fallback: navegar directamente al detalle si la función modal no está disponible
        window.location.href = `/workflow/solicitud/${solicitudId}/`;
    }
}

$(document).ready(function() {
    // =====================================
    // CONFIGURACIÓN DE NOTIFICACIONES
    // =====================================
    
    // El sistema de toast regular del workflow ya está disponible
    // No necesitamos configuración adicional para toastr
    
    // =====================================
    // UTILITY FUNCTIONS
    // =====================================
    
    // Función para obtener el token CSRF
    function getCsrfToken() {
        return $('[name=csrfmiddlewaretoken]').val() || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }
    
    // =====================================
    // INICIALIZACIÓN DE DATATABLES
    // =====================================
    
    // Verificar si la tabla existe y tiene datos antes de inicializar DataTables
    var $tabla = $('#tablaSolicitudes');
    var table;
    
    if ($tabla.length > 0) {
        // Only count rows that do NOT have a colspan attribute (i.e., real data rows)
        var hasDataRows = $tabla.find('tbody tr').filter(function() {
            return !$(this).find('td[colspan]').length;
        }).length > 0;

        if (hasDataRows) {
            // Inicializar DataTable con configuración mejorada
            table = $tabla.DataTable({
                paging: true,
                searching: true,
                ordering: true,
                scrollX: true,
                scrollY: '70vh',
                scrollCollapse: true,
                language: {
                    search: 'Buscar:',
                    lengthMenu: 'Mostrar _MENU_ registros',
                    info: 'Mostrando _START_ a _END_ de _TOTAL_ registros',
                    emptyTable: 'No hay solicitudes para mostrar',
                    zeroRecords: 'No se encontraron solicitudes que coincidan con los filtros',
                    paginate: {
                        previous: 'Anterior',
                        next: 'Siguiente'
                    }
                },
                columnDefs: [
                    { orderable: false, targets: [8, 9] }, // Etiquetas y Prioridad no ordenables
                    { width: '200px', targets: 0 }, // Cliente
                    { width: '150px', targets: 1 }, // Producto
                    { width: '120px', targets: 2 }, // Monto
                    { width: '150px', targets: 3 }, // Propietario
                    { width: '120px', targets: 4 }, // Etapa
                    { width: '100px', targets: 5 }, // Estado
                    { width: '150px', targets: 6 }, // Fecha SLA
                    { width: '120px', targets: 7 }, // SLA
                    { width: '180px', targets: 8 }, // Etiquetas
                    { width: '100px', targets: 9 }, // Prioridad
                ],
                autoWidth: false,
                pageLength: 25,
                responsive: false,
                deferRender: true,
                processing: true,
                dom: 'rt<"bottom d-flex justify-content-between align-items-center mt-3"<"d-flex align-items-center gap-2"l<"text-muted small"i>>p><"clear">',
                // Manejar tablas vacías correctamente
                initComplete: function(settings, json) {
                    // Verificar si la tabla está vacía y mostrar mensaje personalizado
                    if (this.api().data().length === 0) {
                        var tbody = this.api().table().body();
                        $(tbody).html('<tr><td colspan="10" class="text-center py-4"><i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i><p class="text-muted">No hay solicitudes para mostrar</p></td></tr>');
                    }
                }
            });

            // Ocultar el buscador nativo de DataTables
            $('.dataTables_filter').hide();
            // Configurar filtros dinámicos solo si la tabla tiene datos
            if (table) {
                setTimeout(function() {
                    configurarFiltros();
                }, 500);
            }
        } else {
            // Si no hay datos, mostrar mensaje personalizado sin DataTables
            console.log('📋 Tabla sin datos - no inicializando DataTables');
        }
    }
    
    // =====================================
    // FUNCIONES DE NOTIFICACIÓN PERSONALIZADA
    // =====================================
    
    function mostrarNotificacionExito(mensaje) {
        var $notificacion = $(`
            <div class="notificacion-personalizada notificacion-exito">
                <div class="notificacion-contenido">
                    <i class="fas fa-check-circle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            </div>
        `);
        
        $('body').append($notificacion);
        
        // Animar entrada
        setTimeout(() => {
            $notificacion.addClass('show');
        }, 100);
        
        // Auto-remover después de 4 segundos
        setTimeout(() => {
            $notificacion.removeClass('show');
            setTimeout(() => $notificacion.remove(), 300);
        }, 4000);
    }
    
    // Hacer la función globalmente accesible
    window.mostrarNotificacionExito = mostrarNotificacionExito;
    
    function mostrarNotificacionError(mensaje) {
        console.log('🚨 Mostrando notificación de error:', mensaje);
        
        var $notificacion = $(`
            <div class="notificacion-personalizada notificacion-error">
                <div class="notificacion-contenido">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            </div>
        `);
        
        $('body').append($notificacion);
        
        // Animar entrada
        setTimeout(() => {
            $notificacion.addClass('show');
        }, 100);
        
        // Auto-remover después de 5 segundos (más tiempo para errores)
        setTimeout(() => {
            $notificacion.removeClass('show');
            setTimeout(() => $notificacion.remove(), 300);
        }, 5000);
    }
    
    // Hacer la función globalmente accesible
    window.mostrarNotificacionError = mostrarNotificacionError;
    
    function mostrarNotificacionAdvertencia(mensaje) {
        console.log('⚠️ Mostrando notificación de advertencia:', mensaje);
        
        var $notificacion = $(`
            <div class="notificacion-personalizada notificacion-advertencia">
                <div class="notificacion-contenido">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${mensaje}</span>
                </div>
            </div>
        `);
        
        $('body').append($notificacion);
        
        // Animar entrada
        setTimeout(() => {
            $notificacion.addClass('show');
        }, 100);
        
        // Auto-remover después de 6 segundos (más tiempo para advertencias)
        setTimeout(() => {
            $notificacion.removeClass('show');
            setTimeout(() => $notificacion.remove(), 300);
        }, 6000);
    }
    
    function configurarFiltros() {
        console.log('Configurando filtros...');
        
        // Obtener valores únicos de cada columna
        var etapas = new Set();
        var slas = new Set();
        
        // Usar selector directo para obtener todas las filas
        $('#tablaSolicitudes tbody tr').each(function() {
            var $row = $(this);
            
            // Extraer datos de los atributos data-*
            var etapa = $row.attr('data-etapa');
            var sla = $row.attr('data-sla');
            
            console.log('Datos de fila:', { etapa, sla });
            
            if (etapa && etapa !== 'Sin etapa') etapas.add(etapa);
            if (sla && sla !== 'sin sla') slas.add(sla);
        });
        
        // Poblar filtros
        poblarFiltro('#filtroEtapa', Array.from(etapas));
        poblarFiltro('#filtroSLA', Array.from(slas));
        
        console.log('Filtros configurados:', {
            etapas: Array.from(etapas),
            slas: Array.from(slas)
        });
    }
    
    function poblarFiltro(selector, valores) {
        var $select = $(selector);
        $select.find('option:not(:first)').remove();
        
        valores.sort().forEach(function(valor) {
            var texto = valor.charAt(0).toUpperCase() + valor.slice(1);
            $select.append('<option value="' + valor + '">' + texto + '</option>');
        });
    }
    
    // Aplicar filtros en tiempo real (solo si la tabla existe)
    $('#filtroEtapa, #filtroSLA').on('change', function() {
        console.log('Filtro cambiado:', $(this).attr('id'), '=', $(this).val());
        if (table) {
            aplicarFiltrosAvanzados();
        }
    });
    
    // Búsqueda global (solo si la tabla existe)
    $('#busquedaGlobal').on('keyup', function() {
        if (table) {
            table.search(this.value).draw();
        }
    });
    
    // Limpiar filtros (solo si la tabla existe)
    $('#limpiarFiltros').on('click', function() {
        $('#filtroCliente, #filtroProducto, #filtroEstado, #filtroAsignado, #filtroSLA, #filtroPrioridad').val('');
        $('#busquedaGlobal').val('');
        if (table) {
            table.search('').draw();
            aplicarFiltrosAvanzados();
        }
    });
    
    // =====================================
    // MODAL DE CONFIRMACIÓN PERSONALIZADO
    // =====================================
    
    // Variables globales para el modal
    let modalConfirmCallback = null;
    let modalCancelCallback = null;
    let currentEtapaId = null;
    let currentSubestados = [];
    
    // Función para mostrar modal de confirmación
    window.mostrarModalConfirmacion = function(nombreEtapa, onConfirm, onCancel, opciones) {
        // Opciones por defecto
        var configuracion = {
            titulo: 'Confirmar Cambio de Etapa',
            subtitulo: 'Sistema de Workflow',
            pregunta: '¿Está seguro del cambio?',
            descripcion: 'La solicitud se moverá a la siguiente etapa:',
            icono: 'fas fa-arrow-right',
            tipo: 'cambio_etapa', // cambio_etapa, eliminar, accion_general
            etapaId: null
        };
        
        // Sobrescribir configuración si se proporcionan opciones
        if (opciones) {
            configuracion = Object.assign(configuracion, opciones);
        }
        
        // Guardar el ID de etapa actual
        currentEtapaId = configuracion.etapaId;
        
        // Configurar para diferentes tipos de acción
        if (nombreEtapa === 'Eliminar Solicitud' || configuracion.tipo === 'eliminar') {
            configuracion.titulo = 'Confirmar Eliminación';
            configuracion.pregunta = '¿Está seguro de eliminar esta solicitud?';
            configuracion.descripcion = 'Esta acción no se puede deshacer:';
            configuracion.icono = 'fas fa-trash';
            $('#nombreEtapaDestino').html('<span class="text-danger fw-bold">Esta acción es permanente</span>');
            // Ocultar selector de subestado para eliminación
            $('#selectorSubestado').hide();
        } else {
            // Para cambio de etapa normal
            $('#nombreEtapaDestino').text(nombreEtapa);
            
            // Cargar subestados si se proporciona etapaId
            if (currentEtapaId) {
                cargarSubestados(currentEtapaId);
            } else {
                $('#selectorSubestado').hide();
            }
        }
        
        // Actualizar contenido del modal
        $('#modalConfirmacionEtapaLabel').html(`<i class="${configuracion.icono} me-2"></i>${configuracion.titulo}`);
        $('#modalConfirmacionEtapaLabel').next('p').text(configuracion.subtitulo);
        $('.modal-body h5').text(configuracion.pregunta);
        $('.modal-body p.text-muted').text(configuracion.descripcion);
        $('.modal-body .text-center .fas').removeClass().addClass(configuracion.icono).css('font-size', '2rem').css('color', '#28a745');
        
        // Guardar callbacks
        modalConfirmCallback = onConfirm;
        modalCancelCallback = onCancel || function() {};
        
        // Mostrar el modal
        var modal = new bootstrap.Modal(document.getElementById('modalConfirmacionEtapa'));
        modal.show();
        
        // Validar formulario inicial cuando se muestre el modal
        $('#modalConfirmacionEtapa').on('shown.bs.modal', function() {
            validarFormularioModal();
        });
    };
    
    // Función para cargar subestados de una etapa
    function cargarSubestados(etapaId) {
        console.log('🔍 Cargando subestados para etapa:', etapaId);
        
        fetch(`/workflow/api/etapas/${etapaId}/subestados/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.subestados && data.subestados.length > 0) {
                console.log('✅ Subestados cargados:', data.subestados);
                currentSubestados = data.subestados;
                mostrarSelectorSubestado(data.subestados);
            } else {
                console.log('ℹ️ No hay subestados para esta etapa');
                $('#selectorSubestado').hide();
                currentSubestados = [];
            }
        })
        .catch(error => {
            console.error('❌ Error cargando subestados:', error);
            $('#selectorSubestado').hide();
            currentSubestados = [];
        });
    }
    
    // Función para mostrar el selector de subestados
    function mostrarSelectorSubestado(subestados) {
        const select = $('#subestadoSelect');
        select.empty();
        select.append('<option value="">Seleccionar estado...</option>');
        
        subestados.forEach(subestado => {
            select.append(`<option value="${subestado.id}">${subestado.nombre}</option>`);
        });
        
        $('#selectorSubestado').show();
        
        // Validar selección al cambiar
        select.on('change', function() {
            validarFormularioModal();
        });
    }
    
    // Función para validar el formulario del modal
    function validarFormularioModal() {
        const btnAceptar = $('#btnAceptarModal');
        
        // Si hay subestados disponibles, debe seleccionar uno
        if (currentSubestados.length > 0) {
            const subestadoSeleccionado = $('#subestadoSelect').val();
            if (!subestadoSeleccionado) {
                btnAceptar.prop('disabled', true);
                btnAceptar.html('<i class="fas fa-exclamation-triangle me-2"></i>Seleccionar Estado');
                return false;
            } else {
                btnAceptar.prop('disabled', false);
                btnAceptar.html('<i class="fas fa-check me-2"></i>Aceptar');
                return true;
            }
        } else {
            // No hay subestados, siempre válido
            btnAceptar.prop('disabled', false);
            btnAceptar.html('<i class="fas fa-check me-2"></i>Aceptar');
            return true;
        }
    }
    
    // Event listeners para los botones del modal
    $('#btnAceptarModal').on('click', function() {
        // Validar formulario antes de proceder
        if (!validarFormularioModal()) {
            return;
        }
        
        // Ocultar modal
        bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionEtapa')).hide();
        
        // Ejecutar callback de confirmación con datos de subestado
        if (modalConfirmCallback) {
            const subestadoSeleccionado = $('#subestadoSelect').val();
            modalConfirmCallback(subestadoSeleccionado);
        }
    });
    
    $('#btnCancelarModal').on('click', function() {
        // Ocultar modal
        bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionEtapa')).hide();
        
        // Ejecutar callback de cancelación
        if (modalCancelCallback) {
            modalCancelCallback();
        }
    });
    
    // Función para cargar transiciones válidas y actualizar dropdown
    function cargarTransicionesValidas(solicitudId, $select, callback) {
        console.log('🔍 DEBUG: cargarTransicionesValidas llamado con solicitudId:', solicitudId);
        console.log('🔍 DEBUG: URL a llamar:', `/workflow/api/solicitudes/${solicitudId}/transiciones-validas/`);
        
        // Verificar si ya se cargaron las transiciones para evitar llamadas duplicadas
        if ($select.data('transiciones-cargadas')) {
            console.log('✅ Transiciones ya cargadas para solicitud:', solicitudId);
            return;
        }
        
        // Mostrar estado de carga
        var etapaActual = $select.data('etapa-actual');
        var opcionSeleccionada = $select.val();
        $select.prop('disabled', true);
        $select.html('<option value="">Cargando transiciones...</option>');
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/transiciones-validas/`)
        .then(response => {
            console.log('🔍 DEBUG cargarTransicionesValidas: Response status:', response.status);
            console.log('🔍 DEBUG cargarTransicionesValidas: Response ok:', response.ok);
            console.log('🔍 DEBUG cargarTransicionesValidas: Content-Type:', response.headers.get('content-type'));
            
            // Verificar si la respuesta es exitosa
            if (!response.ok) {
                console.error('❌ ERROR cargarTransicionesValidas: Response not ok, status:', response.status);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            // Verificar si el contenido es JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                console.error('❌ ERROR cargarTransicionesValidas: Content-Type no es JSON:', contentType);
                throw new Error('La respuesta no es JSON válido');
            }
            console.log('✅ DEBUG cargarTransicionesValidas: Content-Type es JSON, procediendo a parsear');
            return response.json();
        })
        .then(data => {
            console.log('🔍 DEBUG cargarTransicionesValidas: Data recibida:', data);
            if (data.success) {
                // Limpiar el select
                $select.empty();
                
                // SIEMPRE agregar la etapa actual primero (si existe)
                if (data.etapa_actual && data.etapa_actual.id) {
                    $select.append(`<option value="${data.etapa_actual.id}" 
                                            class="text-primary fw-bold"
                                            data-puede-realizar="true"
                                            data-requisitos-faltantes="0"
                                            selected>
                        📍 ${data.etapa_actual.nombre} (Actual)
                    </option>`);
                }
                
                // Agregar las etapas válidas según las transiciones
                data.transiciones.forEach(function(transicion) {
                    // No agregar la etapa actual nuevamente si ya está en las transiciones
                    if (data.etapa_actual && transicion.etapa_destino.id === data.etapa_actual.id) {
                        return;
                    }
                    
                    var warningClass = !transicion.puede_realizar ? 'text-warning' : '';
                    var requisitosInfo = transicion.total_requisitos_faltantes > 0 ? 
                        ` (${transicion.total_requisitos_faltantes} requisitos faltantes)` : '';
                    
                    $select.append(`<option value="${transicion.etapa_destino.id}" 
                                            class="${warningClass}"
                                            data-puede-realizar="${transicion.puede_realizar}"
                                            data-requisitos-faltantes="${transicion.total_requisitos_faltantes}">
                        ➡️ ${transicion.etapa_destino.nombre}${requisitosInfo}
                    </option>`);
                });
                
                // Si no hay etapa actual en los datos pero sí en el select original, agregarla
                if ((!data.etapa_actual || !data.etapa_actual.id) && etapaActual) {
                    $select.append(`<option value="${etapaActual}" 
                                            class="text-primary fw-bold"
                                            data-puede-realizar="true"
                                            data-requisitos-faltantes="0"
                                            selected>
                        📍 Etapa actual (ID: ${etapaActual})
                    </option>`);
                }
                
                // Actualizar data attributes
                $select.data('etapa-actual', etapaActual);
                $select.data('transiciones-cargadas', true);
                
                // Habilitar el select
                $select.prop('disabled', false);
                
                console.log('✅ Transiciones válidas cargadas:', data.transiciones);
                
                // Ejecutar callback si existe
                if (typeof callback === 'function') {
                    callback();
                }
            } else {
                console.error('❌ Error al cargar transiciones válidas:', data.error);
                // Restaurar opciones originales en caso de error
                restaurarOpcionesOriginales($select, etapaActual, opcionSeleccionada);
                // Mostrar notificación de error
                if (typeof showToast !== 'undefined') {
                    showToast('Error al cargar transiciones: ' + (data.error || 'Error desconocido'), 'error', 5000);
                } else {
                    mostrarNotificacionError('Error al cargar transiciones: ' + (data.error || 'Error desconocido'));
                }
                
                // Ejecutar callback si existe (incluso en error)
                if (typeof callback === 'function') {
                    callback();
                }
            }
        })
        .catch(error => {
            console.error('❌ Error en la petición de transiciones válidas:', error);
            // Restaurar opciones originales en caso de error
            restaurarOpcionesOriginales($select, etapaActual, opcionSeleccionada);
            // Mostrar notificación de error más específica
            let mensajeError = 'Error al cargar transiciones válidas';
            if (error.message.includes('404')) {
                mensajeError = 'No se encontró la solicitud o no tienes permisos';
            } else if (error.message.includes('403')) {
                mensajeError = 'No tienes permisos para ver esta solicitud';
            } else if (error.message.includes('500')) {
                mensajeError = 'Error interno del servidor';
            } else if (error.message.includes('JSON')) {
                mensajeError = 'Error en el formato de respuesta del servidor';
            }
            
            if (typeof showToast !== 'undefined') {
                showToast(mensajeError, 'error', 5000);
            } else {
                mostrarNotificacionError(mensajeError);
            }
            
            // Ejecutar callback si existe (incluso en error)
            if (typeof callback === 'function') {
                callback();
            }
        });
    }
    
    // Función auxiliar para restaurar opciones originales en caso de error
    function restaurarOpcionesOriginales($select, etapaActual, opcionSeleccionada) {
        $select.prop('disabled', false);
        $select.empty();
        
        // Restaurar la opción seleccionada originalmente con mejor formato
        if (etapaActual) {
            $select.append(`<option value="${etapaActual}" selected class="text-primary fw-bold">
                📍 Etapa actual (ID: ${etapaActual})
            </option>`);
        }
        
        // Marcar como no cargado para permitir reintentos
        $select.data('transiciones-cargadas', false);
    }
    
    // Cargar transiciones válidas inmediatamente al cargar la página
    $(document).ready(function() {
        console.log('🚀 Cargando transiciones válidas para todos los selects de etapa...');
        
        // Mostrar indicador de carga global
        var $loadingIndicator = $('<div class="text-center py-2"><small class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Cargando transiciones válidas...</small></div>');
        $('.etapa-select').first().closest('td').before($loadingIndicator);
        
        var totalSelects = $('.etapa-select:not(:disabled)').length;
        var loadedSelects = 0;
        
        $('.etapa-select').each(function() {
            var $select = $(this);
            
            // No cargar transiciones si el select está deshabilitado (bandeja grupal)
            if ($select.prop('disabled')) {
                console.log('❌ Select deshabilitado - no cargando transiciones');
                return;
            }
            
            var solicitudId = $select.data('solicitud-id');
            console.log('📋 Cargando transiciones para solicitud:', solicitudId);
            
            // Modificar la función para incluir callback de completado
            cargarTransicionesValidas(solicitudId, $select, function() {
                loadedSelects++;
                if (loadedSelects >= totalSelects) {
                    // Ocultar indicador de carga cuando todos estén listos
                    $loadingIndicator.fadeOut(300, function() {
                        $(this).remove();
                    });
                    console.log('✅ Todas las transiciones han sido cargadas');
                }
            });
        });
        
        // Si no hay selects para cargar, remover el indicador inmediatamente
        if (totalSelects === 0) {
            $loadingIndicator.remove();
        }
    });
    
    // Mantener el evento focus como fallback para casos donde se agreguen selects dinámicamente
    $(document).on('focus', '.etapa-select', function() {
        var $select = $(this);
        
        // No cargar transiciones si el select está deshabilitado (bandeja grupal)
        if ($select.prop('disabled')) {
            console.log('❌ Select deshabilitado - no cargando transiciones');
            return;
        }
        
        // Solo cargar si no se han cargado ya las transiciones (verificar si tiene data-transiciones-cargadas)
        if (!$select.data('transiciones-cargadas')) {
            var solicitudId = $select.data('solicitud-id');
            console.log('📋 Cargando transiciones en focus para solicitud:', solicitudId);
            cargarTransicionesValidas(solicitudId, $select);
        }
    });
    
    // Manejar cambio de etapa con modal personalizado
    $(document).on('change', '.etapa-select', function() {
        var $select = $(this);
        
        // Verificar si el select está deshabilitado (bandeja grupal)
        if ($select.prop('disabled')) {
            console.log('❌ Select deshabilitado - solicitud en bandeja grupal');
            // Mostrar mensaje informativo
            if (typeof showToast !== 'undefined') {
                showToast('⏳ Esta solicitud está en bandeja grupal. Debes esperar a que el equipo la procese antes de poder cambiar la etapa.', 'warning', 6000);
            } else {
                mostrarNotificacionAdvertencia('⏳ Esta solicitud está en bandeja grupal. Debes esperar a que el equipo la procese antes de poder cambiar la etapa.');
            }
            return; // No permitir cambios
        }
        
        var solicitudId = $select.data('solicitud-id');
        var etapaActual = $select.data('etapa-actual');
        var nuevaEtapaId = $select.val();
        var nombreEtapa = $select.find('option:selected').text();
        
        console.log('🔥 CAMBIO DE ETAPA DETECTADO:');
        console.log('- Solicitud ID:', solicitudId);
        console.log('- Etapa Actual:', etapaActual);
        console.log('- Nueva Etapa ID:', nuevaEtapaId);
        console.log('- Nombre Etapa:', nombreEtapa);
        
        if (nuevaEtapaId === etapaActual.toString() || !nuevaEtapaId) {
            console.log('❌ No hay cambio de etapa - valores iguales o sin selección');
            return; // No hay cambio
        }
        
        // Verificar si hay requisitos faltantes
        var $opcionSeleccionada = $select.find('option:selected');
        var puedeRealizar = $opcionSeleccionada.data('puede-realizar');
        var requisitosFaltantes = $opcionSeleccionada.data('requisitos-faltantes');
        
        if (puedeRealizar === false || requisitosFaltantes > 0) {
            console.log('🔍 Requisitos faltantes detectados, mostrando modal');
            console.log('📋 Parámetros:', { solicitudId, nuevaEtapaId, nombreEtapa, puedeRealizar, requisitosFaltantes });
            
            // Usar la función global correcta que maneja la carga de requisitos
            if (typeof window.mostrarModalRequisitosFaltantes === 'function') {
                console.log('✅ Función disponible, llamando con parámetros correctos');
                try {
                    window.mostrarModalRequisitosFaltantes(solicitudId, nuevaEtapaId, nombreEtapa, function() {
                        // Callback de éxito - proceder con el cambio
                        console.log('✅ Requisitos completados, procediendo con cambio de etapa');
                        window.ejecutarCambioEtapa(solicitudId, nuevaEtapaId, etapaActual, $select, null);
                    }, function() {
                        // Callback de cancelación
                        console.log('❌ Cambio de etapa cancelado');
                        $select.val(etapaActual); // Revertir selección
                    });
                } catch (error) {
                    console.error('❌ Error al llamar mostrarModalRequisitosFaltantes:', error);
                    alert('Error al mostrar modal de requisitos: ' + error.message);
                    $select.val(etapaActual); // Revertir selección
                }
            } else {
                console.error('❌ Función mostrarModalRequisitosFaltantes no disponible');
                alert('Error: Función de requisitos no disponible');
                $select.val(etapaActual); // Revertir selección
            }
            return;
        }
        
        // Mostrar modal de confirmación personalizado
        mostrarModalConfirmacion(nombreEtapa, function(subestadoSeleccionado) {
            // CALLBACK DE CONFIRMACIÓN
            console.log('✅ Confirmado desde modal personalizado, ejecutando cambio de etapa');
            console.log('🔍 Subestado seleccionado:', subestadoSeleccionado);
            window.ejecutarCambioEtapa(solicitudId, nuevaEtapaId, etapaActual, $select, subestadoSeleccionado);
        }, function() {
            // CALLBACK DE CANCELACIÓN
            console.log('❌ Cancelado desde modal personalizado');
            $select.val(etapaActual); // Revertir selección
        }, {
            etapaId: nuevaEtapaId
        });
    });
    
    function aplicarFiltrosAvanzados() {
        console.log('Aplicando filtros avanzados...');
        
        // Verificar si la tabla existe antes de aplicar filtros
        if (!table) {
            console.log('📋 Tabla no inicializada - saltando filtros');
            return;
        }
        
        // Limpiar filtros anteriores
        $.fn.dataTable.ext.search.splice(0, $.fn.dataTable.ext.search.length);
        
        var filtros = {
            etapa: $('#filtroEtapa').val(),
            sla: $('#filtroSLA').val()
        };
        
        console.log('Filtros activos:', filtros);
        
        // Solo aplicar filtros si hay valores seleccionados
        var hayFiltros = Object.values(filtros).some(valor => valor !== '');
        
        if (hayFiltros) {
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                // Verificar que estamos en la tabla correcta
                if (settings.nTable.id !== 'tablaSolicitudes') {
                    return true;
                }
                
                // Obtener la fila del DOM usando el API de DataTables
                var row = table.row(dataIndex);
                if (!row.node()) {
                    return true;
                }
                
                var $row = $(row.node());
                var match = true;
                
                if (filtros.etapa) {
                    var dataEtapa = $row.attr('data-etapa');
                    match = match && (dataEtapa === filtros.etapa);
                    console.log('Etapa:', dataEtapa, '===', filtros.etapa, '?', match);
                }
                if (filtros.sla) {
                    var dataSla = $row.attr('data-sla');
                    match = match && (dataSla === filtros.sla);
                    console.log('SLA:', dataSla, '===', filtros.sla, '?', match);
                }
                
                console.log('Fila', dataIndex, 'match final:', match);
                return match;
            });
        }
        
        table.draw();
        console.log('Filtros aplicados, tabla redibujada');
    }
    
    // Función para cambiar entre vistas
    window.cambiarVista = function(vista) {
        console.log('Cambiando a vista:', vista);
        
        // Obtener parámetros actuales de la URL
        var urlParams = new URLSearchParams(window.location.search);
        
        // Actualizar el parámetro de vista
        urlParams.set('view', vista);
        
        // Mantener el pipeline si existe
        {% if pipeline %}
        urlParams.set('pipeline', '{{ pipeline.id }}');
        {% endif %}
        
        // Redirigir con los nuevos parámetros
        var newUrl = window.location.pathname + '?' + urlParams.toString();
        window.location.href = newUrl;
    };
    
    // Actualizar estado de botones según vista actual
    $(document).ready(function() {
        var currentView = '{{ request.GET.view|default:"table" }}';
        
        if (currentView === 'kanban') {
            $('#btnVistaTabla').removeClass('active btn-light').addClass('btn-outline-light');
            $('#btnVistaKanban').removeClass('btn-outline-light').addClass('active btn-light');
        } else {
            $('#btnVistaTabla').removeClass('btn-outline-light').addClass('active btn-light');
            $('#btnVistaKanban').removeClass('active btn-light').addClass('btn-outline-light');
        }
    });
});
</script>


<!-- incluir estilos de negocios_styles.html -->
 {% include "workflow/partials/negocios_styles.html" %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Inicializando sistema de requisitos faltantes');
  
  // Verificar que todas las funciones estén disponibles
  if (window.verificarFuncionesRequisitos) {
    window.verificarFuncionesRequisitos();
  }
  
  // Verificar que el modal esté disponible
  const modalElement = document.getElementById('modalRequisitosFaltantes');
  if (modalElement) {
    console.log('✅ Modal de requisitos faltantes encontrado');
  } else {
    console.error('❌ Modal de requisitos faltantes no encontrado');
  }
  
  // Manejar edición de etiquetas con select
  document.querySelectorAll('.etiquetas-select').forEach(function(select) {
    select.addEventListener('change', function(e) {
      const solicitudId = e.target.dataset.id;
      const nuevaEtiqueta = e.target.value;
      
      e.target.disabled = true;
      
      fetch(`/workflow/api/solicitudes/${solicitudId}/actualizar-etiquetas/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ etiquetas_oficial: nuevaEtiqueta })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          e.target.style.borderColor = '#22c55e';
          setTimeout(() => {
            e.target.style.borderColor = '';
          }, 1000);
        } else {
          e.target.style.borderColor = '#ef4444';
          alert(data.error || 'Error al guardar etiqueta');
        }
      })
      .catch(error => {
        e.target.style.borderColor = '#ef4444';
        alert('Error de conexión');
      })
      .finally(() => {
        e.target.disabled = false;
      });
    });
  });

  // Manejar edición de prioridad
  document.querySelectorAll('.prioridad-select').forEach(function(select) {
    select.addEventListener('change', function(e) {
      const solicitudId = e.target.dataset.id;
      const nuevaPrioridad = e.target.value;
      fetch(`/workflow/api/solicitudes/${solicitudId}/actualizar-prioridad/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ prioridad: nuevaPrioridad })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Cambia color del fondo según la prioridad seleccionada
          if (nuevaPrioridad === 'Alta') {
            e.target.style.backgroundColor = '#fee2e2';
            e.target.style.color = '#b91c1c';
          } else if (nuevaPrioridad === 'Media') {
            e.target.style.backgroundColor = '#fef9c3';
            e.target.style.color = '#b45309';
          } else if (nuevaPrioridad === 'Baja') {
            e.target.style.backgroundColor = '#dcfce7';
            e.target.style.color = '#166534';
          } else {
            e.target.style.backgroundColor = 'white';
            e.target.style.color = '#333';
          }
        } else {
          alert(data.error || 'Error al guardar prioridad');
        }
      });
    });
  });
});
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

<!-- JavaScript para Vista Móvil -->
<script>
// Funcionalidad mejorada para vista móvil
document.addEventListener('DOMContentLoaded', function() {
    // Animaciones de entrada escalonadas
    const cards = document.querySelectorAll('.vista-movil .solicitud-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });

    // Búsqueda móvil mejorada con debounce
    const busquedaMovil = document.getElementById('busquedaMovil');
    if (busquedaMovil) {
        let searchTimeout;
        
        busquedaMovil.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const searchTerm = this.value.toLowerCase();
            
            searchTimeout = setTimeout(() => {
                const cards = document.querySelectorAll('.solicitud-card');
                let visibleCount = 0;
                
                cards.forEach((card, index) => {
                    const searchData = card.getAttribute('data-search');
                    const isVisible = searchData && searchData.includes(searchTerm);
                    
                    if (isVisible) {
                        card.style.display = 'block';
                        card.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s both`;
                        visibleCount++;
                    } else {
                        card.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => {
                            card.style.display = 'none';
                        }, 300);
                    }
                });
                
                // Mostrar mensaje mejorado si no hay resultados
                const noResultsMsg = document.getElementById('noResultsMessage');
                
                if (visibleCount === 0 && searchTerm !== '') {
                    if (!noResultsMsg) {
                        const container = document.getElementById('solicitudesMovil');
                        const msg = document.createElement('div');
                        msg.id = 'noResultsMessage';
                        msg.className = 'empty-state';
                        msg.style.animation = 'fadeInUp 0.5s ease-out';
                        msg.innerHTML = `
                            <div class="empty-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <h3 class="empty-title">Sin resultados para "${searchTerm}"</h3>
                            <p class="empty-subtitle">Intenta con otros términos de búsqueda o revisa los filtros aplicados.</p>
                            <div class="empty-decoration">
                                <div class="decoration-dot"></div>
                                <div class="decoration-dot"></div>
                                <div class="decoration-dot"></div>
                            </div>
                        `;
                        container.appendChild(msg);
                    }
                } else if (noResultsMsg) {
                    noResultsMsg.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => noResultsMsg.remove(), 300);
                }
            }, 300);
        });
        
        // Efecto de foco mejorado
        busquedaMovil.addEventListener('focus', function() {
            this.parentElement.style.transform = 'scale(1.02)';
            this.parentElement.style.boxShadow = '0 8px 25px rgba(0, 156, 60, 0.15)';
        });
        
        busquedaMovil.addEventListener('blur', function() {
            this.parentElement.style.transform = 'scale(1)';
            this.parentElement.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.05)';
        });
    }
    
    // Filtros rápidos móvil mejorados
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Efecto de ripple
            const ripple = document.createElement('span');
            ripple.style.cssText = `
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.6);
                transform: scale(0);
                animation: ripple 0.6s linear;
                width: 20px;
                height: 20px;
                left: 50%;
                top: 50%;
                margin-left: -10px;
                margin-top: -10px;
            `;
            this.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
            
            // Remover clase activa de todos los botones con animación
            filterBtns.forEach(b => {
                b.classList.remove('active');
                b.style.transform = 'scale(1)';
            });
            
            // Agregar clase activa al botón clickeado con animación
            this.classList.add('active');
            this.style.transform = 'scale(1.05)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
            
            const filter = this.getAttribute('data-filter');
            const cards = document.querySelectorAll('.solicitud-card');
            let visibleCount = 0;
            
            cards.forEach((card, index) => {
                let show = false;
                
                switch(filter) {
                    case 'todos':
                        show = true;
                        break;
                    case 'alta':
                        show = card.getAttribute('data-prioridad') === 'alta';
                        break;
                    case 'vencidas':
                        show = card.getAttribute('data-estado') === 'text-danger';
                        break;
                    case 'sin_asignar':
                        show = card.getAttribute('data-asignado') === 'sin_asignar';
                        break;
                }
                
                if (show) {
                    card.style.display = 'block';
                    card.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s both`;
                    visibleCount++;
                } else {
                    card.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => {
                        card.style.display = 'none';
                    }, 300);
                }
            });
            
            // Mostrar contador de resultados
            setTimeout(() => {
                const activeFilter = this.textContent.trim();
                showFilterResults(visibleCount, activeFilter);
            }, 500);
        });
    });
    
    // Función para mostrar resultados de filtro
    function showFilterResults(count, filterName) {
        // Remover mensaje anterior si existe
        const existingMsg = document.querySelector('.filter-results-msg');
        if (existingMsg) existingMsg.remove();
        
        if (count === 0) return;
        
        const container = document.getElementById('solicitudesMovil');
        const msg = document.createElement('div');
        msg.className = 'filter-results-msg';
        msg.style.cssText = `
            background: linear-gradient(135deg, rgba(0, 156, 60, 0.1), rgba(34, 166, 80, 0.15));
            color: #009c3c;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid rgba(0, 156, 60, 0.3);
            animation: slideInDown 0.5s ease-out;
        `;
        msg.innerHTML = `
            <i class="fas fa-filter" style="margin-right: 8px;"></i>
            ${count} solicitud${count !== 1 ? 'es' : ''} ${filterName.toLowerCase()}
        `;
        
        container.insertBefore(msg, container.firstChild);
        
        // Auto-remover después de 3 segundos
        setTimeout(() => {
            if (msg.parentNode) {
                msg.style.animation = 'slideOutUp 0.3s ease-out';
                setTimeout(() => msg.remove(), 300);
            }
        }, 3000);
    }
});

// Función para toggle de menús desplegables
function toggleMenu(button) {
    const menu = button.nextElementSibling;
    const allMenus = document.querySelectorAll('.menu-dropdown');
    
    // Cerrar todos los otros menús
    allMenus.forEach(m => {
        if (m !== menu) {
            m.classList.add('hidden');
        }
    });
    
    // Toggle del menú actual
    menu.classList.toggle('hidden');
    
    // Cerrar menú al hacer click fuera
    if (!menu.classList.contains('hidden')) {
        document.addEventListener('click', function closeMenu(e) {
            if (!button.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeMenu);
            }
        });
    }
}

// Función para eliminar solicitud (reutilizada)
function eliminarSolicitud(id) {
    mostrarModalConfirmacion('Eliminar Solicitud', function() {
        // CALLBACK DE CONFIRMACIÓN PARA ELIMINAR
        console.log('✅ Confirmado eliminar solicitud:', id);
        
        fetch(`/workflow/api/solicitudes/${id}/eliminar/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
        .then(response => {
            if (response.ok) {
                            if (typeof showToast !== 'undefined') {
                showToast('Solicitud eliminada exitosamente', 'success', 4000);
            } else {
                mostrarNotificacionExito('Solicitud eliminada exitosamente');
            }
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                if (typeof toastr !== 'undefined') {
                    toastr.error('Error al eliminar la solicitud');
                } else {
                    mostrarNotificacionError('Error al eliminar la solicitud');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (typeof showToast !== 'undefined') {
                showToast('Error al eliminar la solicitud', 'error', 5000);
            } else {
                mostrarNotificacionError('Error al eliminar la solicitud');
            }
        });
    }, function() {
        // CALLBACK DE CANCELACIÓN
        console.log('❌ Cancelada eliminación de solicitud');
    });
}

// Función para toggle de secciones móviles
function toggleSection(sectionId) {
    let content, toggleBtn;
    
    if (sectionId === 'kpis-section') {
        content = document.querySelector('.kpis-content');
        toggleBtn = document.getElementById('toggle-kpis');
    } else if (sectionId === 'filters-section') {
        content = document.querySelector('.filters-content');
        toggleBtn = document.getElementById('toggle-filters');
    }
    
    const toggleText = toggleBtn.querySelector('.toggle-text');
    const icon = toggleBtn.querySelector('i');
    
    if (content && toggleBtn) {
        if (content.classList.contains('collapsed')) {
            // Mostrar contenido
            content.classList.remove('collapsed');
            toggleBtn.classList.remove('collapsed');
            
            if (sectionId === 'kpis-section') {
                toggleText.textContent = 'Ocultar KPIs';
                icon.className = 'fas fa-chart-bar me-1';
            } else if (sectionId === 'filters-section') {
                toggleText.textContent = 'Ocultar Filtros';
                icon.className = 'fas fa-filter me-1';
            }
        } else {
            // Ocultar contenido
            content.classList.add('collapsed');
            toggleBtn.classList.add('collapsed');
            
            if (sectionId === 'kpis-section') {
                toggleText.textContent = 'Mostrar KPIs';
                icon.className = 'fas fa-chart-bar me-1';
            } else if (sectionId === 'filters-section') {
                toggleText.textContent = 'Mostrar Filtros';
                icon.className = 'fas fa-filter me-1';
            }
        }
        
        // Guardar estado en localStorage
        localStorage.setItem(sectionId + '_collapsed', content.classList.contains('collapsed'));
    }
}

// Restaurar estado de secciones al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    ['kpis-section', 'filters-section'].forEach(sectionId => {
        const isCollapsed = localStorage.getItem(sectionId + '_collapsed') === 'true';
        if (isCollapsed) {
            // Aplicar estado colapsado directamente sin animación
            let content, toggleBtn;
            
            if (sectionId === 'kpis-section') {
                content = document.querySelector('.kpis-content');
                toggleBtn = document.getElementById('toggle-kpis');
            } else if (sectionId === 'filters-section') {
                content = document.querySelector('.filters-content');
                toggleBtn = document.getElementById('toggle-filters');
            }
            
            if (content && toggleBtn) {
                content.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                
                const toggleText = toggleBtn.querySelector('.toggle-text');
                const icon = toggleBtn.querySelector('i');
                
                if (sectionId === 'kpis-section') {
                    toggleText.textContent = 'Mostrar KPIs';
                } else if (sectionId === 'filters-section') {
                    toggleText.textContent = 'Mostrar Filtros';
                }
            }
        }
    });
    
    // ============================================
    // FUNCIONALIDAD KANBAN
    // ============================================
    
    // Configurar filtros Kanban
    function configurarFiltrosKanban() {
        if ($('.kanban-board').length === 0) return; // Solo si estamos en vista Kanban
        
        console.log('Configurando filtros Kanban...');
        
        // Obtener valores únicos de todas las tarjetas
        var clientes = new Set();
        var estados = new Set();
        var asignados = new Set();
        var slas = new Set();
        
        $('.kanban-card').each(function() {
            var $card = $(this);
            
            var cliente = $card.attr('data-cliente');
            var estado = $card.attr('data-estado');
            var asignado = $card.attr('data-asignado');
            var sla = $card.attr('data-sla');
            
            if (cliente && cliente !== 'Sin cliente') clientes.add(cliente);
            if (estado && estado !== 'Sin estado') estados.add(estado);
            if (asignado && asignado !== 'Sin asignar') asignados.add(asignado);
            if (sla && sla !== 'sin sla') slas.add(sla);
        });
        
        // Poblar filtros
        var $filtroCliente = $('#kanbanFiltroCliente');
        var $filtroEstado = $('#kanbanFiltroEstado');
        var $filtroAsignado = $('#kanbanFiltroAsignado');
        var $filtroSLA = $('#kanbanFiltroSLA');
        
        // Limpiar opciones existentes (excepto la primera)
        $filtroCliente.find('option:not(:first)').remove();
        $filtroEstado.find('option:not(:first)').remove();
        $filtroAsignado.find('option:not(:first)').remove();
        $filtroSLA.find('option:not(:first)').remove();
        
        // Agregar nuevas opciones
        Array.from(clientes).sort().forEach(function(cliente) {
            $filtroCliente.append(`<option value="${cliente}">${cliente}</option>`);
        });
        
        Array.from(estados).sort().forEach(function(estado) {
            $filtroEstado.append(`<option value="${estado}">${estado}</option>`);
        });
        
        Array.from(asignados).sort().forEach(function(asignado) {
            $filtroAsignado.append(`<option value="${asignado}">${asignado}</option>`);
        });
        
        Array.from(slas).sort().forEach(function(sla) {
            var texto = sla === 'vencido' ? 'Vencido' : 
                       sla === 'por vencer' ? 'Por vencer' : 
                       sla === 'en tiempo' ? 'En tiempo' : sla;
            $filtroSLA.append(`<option value="${sla}">${texto}</option>`);
        });
        
        console.log('Filtros Kanban configurados:', {
            clientes: clientes.size,
            estados: estados.size,
            asignados: asignados.size,
            slas: slas.size
        });
        
        // Actualizar contadores
        actualizarContadoresKanban();
    }
    
    // Aplicar filtros Kanban
    function aplicarFiltrosKanban() {
        if ($('.kanban-card').length === 0) return;
        
        var filtroCliente = $('#kanbanFiltroCliente').val();
        var filtroEstado = $('#kanbanFiltroEstado').val();
        var filtroAsignado = $('#kanbanFiltroAsignado').val();
        var filtroSLA = $('#kanbanFiltroSLA').val();
        var busquedaGlobal = $('#kanbanBusquedaGlobal').val().toLowerCase();
        
        $('.kanban-card').each(function() {
            var $card = $(this);
            var mostrar = true;
            
            // Filtro cliente
            if (filtroCliente && $card.attr('data-cliente') !== filtroCliente) {
                mostrar = false;
            }
            
            // Filtro estado
            if (filtroEstado && $card.attr('data-estado') !== filtroEstado) {
                mostrar = false;
            }
            
            // Filtro asignado
            if (filtroAsignado && $card.attr('data-asignado') !== filtroAsignado) {
                mostrar = false;
            }
            
            // Filtro SLA
            if (filtroSLA && $card.attr('data-sla') !== filtroSLA) {
                mostrar = false;
            }
            
            // Búsqueda global
            if (busquedaGlobal && !$card.attr('data-search').includes(busquedaGlobal)) {
                mostrar = false;
            }
            
            $card.toggle(mostrar);
        });
        
        // Actualizar contadores y mostrar mensajes cuando no hay solicitudes
        actualizarContadoresKanban();
        mostrarMensajesVacios();
    }
    
    // Actualizar contadores de etapas
    function actualizarContadoresKanban() {
        $('.kanban-column').each(function() {
            var $column = $(this);
            var etapaId = $column.find('.kanban-column-body').attr('data-etapa-id');
            var count = $column.find('.kanban-card:visible').length;
            $('#count-etapa-' + etapaId).text(count);
        });
    }
    
    // Mostrar mensajes cuando no hay solicitudes visibles
    function mostrarMensajesVacios() {
        $('.kanban-column-body').each(function() {
            var $body = $(this);
            var hasVisible = $body.find('.kanban-card:visible').length > 0;
            $body.find('.no-solicitudes').toggle(!hasVisible);
        });
    }
    
    // Búsqueda por etapa
    $('.etapa-search').on('input', function() {
        var $input = $(this);
        var etapaId = $input.attr('data-etapa-id');
        var searchTerm = $input.val().toLowerCase();
        
        $('.kanban-column-body[data-etapa-id="' + etapaId + '"] .kanban-card').each(function() {
            var $card = $(this);
            var searchData = $card.attr('data-search');
            var shouldShow = !searchTerm || searchData.includes(searchTerm);
            $card.toggle(shouldShow);
        });
        
        actualizarContadoresKanban();
        mostrarMensajesVacios();
    });
    
    // Event listeners para filtros Kanban
    $('#kanbanFiltroCliente, #kanbanFiltroEstado, #kanbanFiltroAsignado, #kanbanFiltroSLA').on('change', aplicarFiltrosKanban);
    $('#kanbanBusquedaGlobal').on('input', aplicarFiltrosKanban);
    
    // Limpiar filtros Kanban
    $('#kanbanLimpiarFiltros').on('click', function() {
        $('#kanbanFiltroCliente, #kanbanFiltroEstado, #kanbanFiltroAsignado, #kanbanFiltroSLA').val('');
        $('#kanbanBusquedaGlobal').val('');
        $('.etapa-search').val('');
        $('.kanban-card').show();
        actualizarContadoresKanban();
        mostrarMensajesVacios();
    });
    
    // Cambio de etapa desde dropdown en Kanban
    $(document).on('click', '.cambiar-etapa-kanban', function(e) {
        e.preventDefault();
        
        var $link = $(this);
        var solicitudId = $link.data('solicitud-id');
        var etapaId = $link.data('etapa-id');
        var etapaNombre = $link.data('etapa-nombre');
        
        // Confirmar cambio con modal personalizado
        mostrarModalConfirmacion(etapaNombre, function() {
            // Función que se ejecuta al confirmar - AJAX directo para Kanban
            console.log('Ejecutando cambio de etapa Kanban:', solicitudId, etapaId);
            
            // Realizar petición AJAX para cambiar etapa
            $.ajax({
                url: `/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                data: JSON.stringify({
                    etapa_id: etapaId
                }),
                contentType: 'application/json',
                success: function(response) {
                    console.log('Respuesta del servidor Kanban:', response);
                    if (response.success) {
                        // Mostrar mensaje de éxito
                        if (typeof showToast !== 'undefined') {
                            showToast(response.mensaje || 'Etapa cambiada exitosamente', 'success', 4000);
                        } else {
                            alert('Etapa cambiada exitosamente');
                        }
                        
                        // Recargar la página para mostrar cambios
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        alert('Error: ' + (response.error || 'No se pudo cambiar la etapa'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error AJAX Kanban:', xhr, status, error);
                    var errorMsg = 'Error al cambiar etapa';
                    try {
                        var response = JSON.parse(xhr.responseText);
                        errorMsg = response.error || errorMsg;
                    } catch(e) {
                        errorMsg = 'Error de conexión';
                    }
                    
                    alert(errorMsg);
                }
            });
        });
        return;
    });
    
    function realizarCambioEtapaKanban(solicitudId, etapaId, etapaNombre) {
        console.log('🔄 KANBAN: Iniciando cambio de etapa', {
            solicitudId: solicitudId,
            etapaId: etapaId,
            etapaNombre: etapaNombre
        });
        
        // Agregar indicador visual de carga
        var $card = $(`.kanban-card[data-solicitud-id="${solicitudId}"]`);
        $card.addClass('updating').css('opacity', '0.6');
        
        // Realizar petición AJAX
        $.ajax({
            url: `/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            data: JSON.stringify({
                etapa_id: etapaId
            }),
            contentType: 'application/json',
            success: function(response) {
                console.log('✅ KANBAN: Respuesta exitosa del servidor', response);
                
                if (response.success) {
                    // Mostrar toast de éxito
                    if (typeof toastr !== 'undefined') {
                        toastr.success(response.mensaje || `Solicitud movida a ${etapaNombre}`, 'Etapa Actualizada', {
                            positionClass: 'toast-top-right',
                            timeOut: 3000,
                            showMethod: 'slideDown',
                            hideMethod: 'slideUp'
                        });
                    } else {
                        mostrarNotificacionExito(response.mensaje || `Solicitud movida a ${etapaNombre}`);
                    }
                    
                    console.log('🔄 KANBAN: Actualizando vista...');
                    
                    // Animar movimiento de tarjeta
                    $card.fadeOut(300, function() {
                        // Mover la tarjeta a la nueva columna
                        var $nuevaColumna = $(`.kanban-column-body[data-etapa-id="${etapaId}"]`);
                        
                        // Actualizar atributos de la tarjeta
                        $card.attr('data-etapa-id', etapaId);
                        
                        // Mover físicamente la tarjeta
                        $card.appendTo($nuevaColumna);
                        
                        // Restablecer opacidad y animar aparición
                        $card.css('opacity', '1').removeClass('updating').fadeIn(300);
                        
                        // Actualizar contadores
                        actualizarContadoresKanban();
                        
                        console.log('✅ KANBAN: Vista actualizada correctamente');
                    });
                    
                    // Sincronizar con otras vistas
                    sincronizarCambioEtapa(solicitudId, etapaId, response);
                    
                } else {
                    console.error('❌ KANBAN: Error en respuesta del servidor', response.error);
                    
                    // Mostrar toast de error
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.error || 'Error desconocido', 'Error al Cambiar Etapa', {
                            positionClass: 'toast-top-right',
                            timeOut: 5000
                        });
                    } else {
                        mostrarNotificacionError(response.error || 'Error al cambiar etapa');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('❌ KANBAN: Error AJAX', {
                    status: status,
                    error: error,
                    response: xhr.responseText
                });
                
                var errorMsg = 'Error al cambiar etapa';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.error || errorMsg;
                } catch(e) {
                    errorMsg = 'Error de conexión con el servidor';
                }
                
                // Mostrar toast de error
                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMsg, 'Error de Conexión', {
                        positionClass: 'toast-top-right',
                        timeOut: 5000
                    });
                } else {
                    mostrarNotificacionError(errorMsg);
                }
            },
            complete: function() {
                // Asegurar que se remueva el indicador de carga
                $card.removeClass('updating').css('opacity', '1');
                console.log('🏁 KANBAN: Petición completada');
            }
        });
    }
    
    // Inicializar drag and drop cuando la página esté lista
    if ($('.kanban-board').length > 0) {
        console.log('Inicializando drag and drop para Kanban...');
        inicializarDragAndDrop();
        
        // Solo configurar filtros si existen los elementos de filtro
        if ($('#kanbanFiltroCliente').length > 0) {
            configurarFiltrosKanban();
        }
    }
    
    // ============================================
    // DRAG & DROP FUNCIONALIDAD
    // ============================================
    
    function inicializarDragAndDrop() {
        // Evitar inicialización múltiple
        if ($('.kanban-card').data('drag-initialized')) {
            console.log('Drag and drop ya inicializado, saltando...');
            return;
        }
        
        console.log('Configurando eventos de drag and drop...');
        console.log('Tarjetas Kanban encontradas:', $('.kanban-card').length);
        console.log('Columnas Kanban encontradas:', $('.kanban-column-body').length);
        
        // Marcar como inicializado
        $('.kanban-card').data('drag-initialized', true);
        

        
        // Configurar eventos de drag para las tarjetas
        $('.kanban-card').on('dragstart', function(e) {
            var solicitudId = $(this).attr('data-solicitud-id');
            var etapaActual = $(this).attr('data-etapa-id');
            
            console.log('🔄 Iniciando drag de solicitud:', solicitudId, 'desde etapa:', etapaActual);
            
            var dragData = JSON.stringify({
                solicitudId: solicitudId,
                etapaActual: etapaActual
            });
            
            e.originalEvent.dataTransfer.setData('text/plain', dragData);
            e.originalEvent.dataTransfer.effectAllowed = 'move';
            
            console.log('📦 Datos de drag configurados:', dragData);
            
            $(this).addClass('dragging');
            
            // Agregar efecto visual a las zonas de drop
            $('.kanban-column-body').addClass('drop-zone-active');
        });
        
        $('.kanban-card').on('dragend', function(e) {
            $(this).removeClass('dragging');
            $('.kanban-column-body').removeClass('drop-zone-active');
        });
        
        // Configurar eventos de drop para las columnas
        $('.kanban-column-body').on('dragover', function(e) {
            e.preventDefault();
            
            // Obtener información de la tarjeta que se está arrastrando
            var dragData = null;
            try {
                // Solo intentar obtener datos si hay tipos de datos disponibles
                if (e.originalEvent.dataTransfer.types.includes('text/plain')) {
                    dragData = JSON.parse(e.originalEvent.dataTransfer.getData('text/plain'));
                }
            } catch (e) {
                console.log('No se pudieron obtener datos del drag:', e);
                // Si no hay datos, permitir hover normal
                $(this).addClass('drop-zone-hover');
                return;
            }
            
            var solicitudId = dragData.solicitudId;
            var nuevaEtapaId = $(this).attr('data-etapa-id');
            
            // Simplemente mostrar hover visual sin validación en dragover
            $(this).addClass('drop-zone-hover');
        });
        
        $('.kanban-column-body').on('dragleave', function(e) {
            $(this).removeClass('drop-zone-hover drop-zone-valid drop-zone-invalid');
        });
        
        $('.kanban-column-body').on('drop', function(e) {
            e.preventDefault();
            
            var $dropZone = $(this);
            var nuevaEtapaId = $dropZone.attr('data-etapa-id');
            
            console.log('🎯 Drop detectado en etapa:', nuevaEtapaId);
            
            // Remover clases de hover
            $dropZone.removeClass('drop-zone-hover drop-zone-active');
            $('.kanban-column-body').removeClass('drop-zone-active');
            
            try {
                var data = JSON.parse(e.originalEvent.dataTransfer.getData('text/plain'));
                var solicitudId = data.solicitudId;
                var etapaActual = data.etapaActual;
                
                console.log('📥 Datos de drop recibidos:', data);
                
                // Verificar si es un movimiento válido
                if (nuevaEtapaId === etapaActual) {
                    console.log('Movimiento cancelado: misma etapa');
                    return;
                }
                
                // NUEVO: Validar transición antes de permitir el drop
                validarTransicionKanban(solicitudId, nuevaEtapaId, function(esValida, mensaje, requisitosFaltantes) {
                    if (!esValida) {
                        // Si hay requisitos faltantes, mostrar el modal de requisitos
                        if (requisitosFaltantes && requisitosFaltantes.length > 0) {
                            console.log('📋 Mostrando modal de requisitos faltantes:', requisitosFaltantes);
                            
                            // Obtener nombre de la nueva etapa
                            var nuevaEtapaNombre = $dropZone.closest('.kanban-column').find('.card-header h6').text().trim();
                            nuevaEtapaNombre = nuevaEtapaNombre.replace(/\d+$/, '').trim(); // Remover contador
                            
                            // Usar la función global correcta que maneja la carga de requisitos
                            if (typeof window.mostrarModalRequisitosFaltantes === 'function') {
                                console.log('✅ Función disponible, llamando con parámetros correctos');
                                try {
                                    window.mostrarModalRequisitosFaltantes(solicitudId, nuevaEtapaId, nuevaEtapaNombre, function() {
                                        // Callback de éxito - proceder con el cambio
                                        console.log('✅ Requisitos completados, procediendo con cambio de etapa');
                                        window.ejecutarCambioEtapa(solicitudId, nuevaEtapaId, null, null, null, true, nuevaEtapaNombre);
                                    }, function() {
                                        // Callback de cancelación
                                        console.log('❌ Cambio de etapa cancelado');
                                        // No hacer nada, la tarjeta se queda en su lugar
                                    });
                                } catch (error) {
                                    console.error('❌ Error al llamar mostrarModalRequisitosFaltantes:', error);
                                    if (typeof showToast !== 'undefined') {
                                        showToast('Error al mostrar modal de requisitos: ' + error.message, 'error', 6000);
                                    } else {
                                        alert('Error al mostrar modal de requisitos: ' + error.message);
                                    }
                                }
                            } else {
                                console.error('❌ Función mostrarModalRequisitosFaltantes no disponible');
                                if (typeof showToast !== 'undefined') {
                                    showToast('Error: Función de requisitos no disponible', 'error', 6000);
                                } else {
                                    alert('Error: Función de requisitos no disponible');
                                }
                            }
                        } else {
                            // Mostrar error y cancelar movimiento
                            if (typeof toastr !== 'undefined') {
                                toastr.error(mensaje, 'Transición No Válida', {
                                    positionClass: 'toast-top-right',
                                    timeOut: 5000
                                });
                            } else {
                                mostrarNotificacionError(mensaje);
                            }
                        }
                        return;
                    }
                    
                    // Obtener nombre de la nueva etapa
                    var nuevaEtapaNombre = $dropZone.closest('.kanban-column').find('.card-header h6').text().trim();
                    nuevaEtapaNombre = nuevaEtapaNombre.replace(/\d+$/, '').trim(); // Remover contador
                    
                    // Confirmar movimiento con modal personalizado
                    window.mostrarModalConfirmacion(nuevaEtapaNombre, function() {
                        // Función que se ejecuta al confirmar - usar función unificada
                        console.log('Ejecutando cambio de etapa Drag & Drop:', solicitudId, nuevaEtapaId);
                        window.ejecutarCambioEtapa(solicitudId, nuevaEtapaId, null, null, null, true, nuevaEtapaNombre);
                    });
                });
                return;
                
            } catch (error) {
                console.error('Error al procesar drop:', error);
            }
        });
    }
    
    // Función para mostrar modal de confirmación - REMOVIDA
    // Se usa la función global window.mostrarModalConfirmacion definida anteriormente
    
    // Función para mostrar modal de requisitos faltantes - REMOVIDA
    // Esta función ha sido reemplazada por la versión global más adelante en el código
    
    // Funciones del sistema anterior de requisitos - REMOVIDAS
    // Estas funciones han sido reemplazadas por la versión global más adelante en el código
    
    // Función para cerrar modal de requisitos - REMOVIDA
    // Esta función ha sido reemplazada por la versión global más adelante en el código
    
    // Función para realizar transición después de completar requisitos - REMOVIDA
    // Esta función ha sido reemplazada por el sistema de callbacks en la nueva implementación
    

    
    // Función para validar transiciones en Kanban
    function validarTransicionKanban(solicitudId, nuevaEtapaId, callback) {
        console.log('🔍 Validando transición Kanban:', solicitudId, nuevaEtapaId);
        
        // Validar parámetros
        if (!solicitudId || !nuevaEtapaId || typeof callback !== 'function') {
            console.error('❌ Parámetros inválidos para validarTransicionKanban');
            callback(false, 'Parámetros inválidos', []);
            return;
        }
        
        try {
            fetch(`/workflow/api/solicitudes/${solicitudId}/transiciones-validas/`)
            .then(response => {
                // Verificar si la respuesta es exitosa
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // Verificar si el contenido es JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('La respuesta no es JSON válido');
                }
                return response.json();
            })
        .then(data => {
            if (data.success) {
                // Buscar si la transición es válida
                var transicionValida = data.transiciones.find(function(t) {
                    return t.etapa_destino.id == nuevaEtapaId;
                });
                
                if (transicionValida) {
                    if (transicionValida.puede_realizar) {
                        callback(true, 'Transición válida', []);
                    } else {
                        var mensaje = `No puedes mover a "${transicionValida.etapa_destino.nombre}" porque faltan ${transicionValida.total_requisitos_faltantes} requisito(s) obligatorio(s)`;
                        callback(false, mensaje, transicionValida.requisitos_faltantes);
                    }
                } else {
                    callback(false, 'No existe una transición válida hacia esta etapa', []);
                }
            } else {
                callback(false, 'Error al validar transición: ' + (data.error || 'Error desconocido'), []);
            }
        })
            .catch(error => {
                console.error('❌ Error validando transición Kanban:', error);
                let mensajeError = 'Error de conexión al validar transición';
                if (error.message.includes('404')) {
                    mensajeError = 'No se encontró la solicitud';
                } else if (error.message.includes('403')) {
                    mensajeError = 'No tienes permisos para esta solicitud';
                } else if (error.message.includes('500')) {
                    mensajeError = 'Error interno del servidor';
                } else if (error.message.includes('JSON')) {
                    mensajeError = 'Error en el formato de respuesta';
                }
                
                // Usar callback en lugar de mostrar notificación directamente
                callback(false, mensajeError, []);
            });
        } catch (error) {
            console.error('❌ Error crítico en validarTransicionKanban:', error);
            callback(false, 'Error interno en la validación', []);
        }
    }
    
    // Función realizarCambioEtapaDragDrop - REMOVIDA
    // Esta función ha sido reemplazada por window.ejecutarCambioEtapa unificada
    
    // Nueva función para actualizar kanban tras movimiento sin recargar página
    window.actualizarKanbanTrasMovimiento = function(solicitudId, nuevaEtapaId, etapaNombre) {
        console.log('🔄 Actualizando kanban tras movimiento', {
            solicitudId: solicitudId,
            nuevaEtapaId: nuevaEtapaId,
            etapaNombre: etapaNombre
        });
        
        var $card = $(`.kanban-card[data-solicitud-id="${solicitudId}"]`);
        var $nuevaColumna = $(`.kanban-column-body[data-etapa-id="${nuevaEtapaId}"]`);
        
        if ($card.length && $nuevaColumna.length) {
            // Animar movimiento suave
            $card.fadeOut(300, function() {
                // Actualizar atributos
                $card.attr('data-etapa-id', nuevaEtapaId);
                
                // Mover a nueva columna
                $card.appendTo($nuevaColumna);
                
                // Mostrar con animación
                $card.fadeIn(400);
                
                // Actualizar contadores
                if (typeof actualizarContadoresKanban === 'function') {
                    actualizarContadoresKanban();
                }
                
                console.log('✅ Kanban actualizado dinámicamente');
            });
        } else {
            console.warn('⚠️ No se pudo encontrar la tarjeta o columna para actualizar');
            // Fallback: recargar página después de un breve delay
            setTimeout(() => {
                console.log('🔄 Recargando página como fallback...');
                location.reload();
            }, 1500);
        }
    }
    
    function mostrarNotificacionExito(mensaje) {
        // Crear notificación flotante
        var $notificacion = $(`
            <div class="drag-notification">
                <i class="fas fa-check-circle me-2"></i>
                ${mensaje}
            </div>
        `);
        
        $('body').append($notificacion);
        
        // Animar entrada
        setTimeout(() => {
            $notificacion.addClass('show');
        }, 100);
        
        // Auto-remover después de 3 segundos
        setTimeout(() => {
            $notificacion.removeClass('show');
            setTimeout(() => $notificacion.remove(), 300);
        }, 3000);
    }
    
    // 🏗️ SISTEMA DE SINCRONIZACIÓN CON OTRAS VISTAS
    function sincronizarCambioEtapa(solicitudId, nuevaEtapaId, response) {
        // Comunicación entre pestañas/ventanas usando BroadcastChannel
        if ('BroadcastChannel' in window) {
            if (!window.workflowChannel) {
                window.workflowChannel = new BroadcastChannel('workflow-sync');
            }
            
            // Crear notificación de cambio de etapa
            const notification = {
                type: 'solicitud_cambio_etapa',
                data: {
                    solicitud_id: solicitudId,
                    codigo: response.codigo || 'N/A',
                    etapa_actual: {
                        id: nuevaEtapaId,
                        nombre: response.nueva_etapa.nombre
                    },
                    etapa_anterior: response.etapa_anterior,
                    user_action: {
                        username: 'current_user'
                    },
                    timestamp: new Date().toISOString()
                }
            };
            
            // Enviar notificación a otras pestañas
            window.workflowChannel.postMessage({
                type: 'sync_solicitud',
                notification: notification,
                source: 'tabla-kanban',
                timestamp: new Date().toISOString()
            });
        }
        
        // También usar localStorage como respaldo
        localStorage.setItem('workflow_last_sync', JSON.stringify({
            notification: {
                type: 'solicitud_cambio_etapa',
                data: {
                    solicitud_id: solicitudId,
                    etapa_actual: { id: nuevaEtapaId }
                }
            },
            timestamp: new Date().toISOString()
        }));
    }
    
        
});
</script>

<style>
/* Tamaño intermedio de letra en vista tabla */
.workflow-table {
    font-size: 0.9rem !important;
}

.workflow-table th {
    font-size: 0.85rem !important;
    padding: 0.6rem !important;
}

.workflow-table td {
    font-size: 0.9rem !important;
    padding: 0.6rem !important;
}

.workflow-table .fw-semibold {
    font-size: 0.9rem !important;
}

.workflow-table small {
    font-size: 0.75rem !important;
}

.workflow-table .badge {
    font-size: 0.75rem !important;
}

.workflow-table .form-select-sm {
    font-size: 0.85rem !important;
}

.workflow-table .form-control-sm {
    font-size: 0.85rem !important;
}

.workflow-table .solicitud-link {
    font-size: 0.9rem !important;
}

.workflow-table .text-muted {
    font-size: 0.8rem !important;
}

.workflow-table .fas {
    font-size: 0.8rem !important;
}

/* Eliminar completamente el borde vacío debajo del encabezado */
.workflow-table thead {
    border-bottom: none !important;
    border-collapse: collapse !important;
}

.workflow-table thead tr {
    border-bottom: none !important;
}

.workflow-table thead th {
    border-bottom: none !important;
    border-top: none !important;
    vertical-align: middle !important;
}

.workflow-table thead::after,
.workflow-table thead tr::after,
.workflow-table thead th::after {
    display: none !important;
    content: none !important;
}

/* Eliminar cualquier margen o padding que cause el espacio vacío */
.workflow-table thead {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}

.workflow-table tbody {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

.workflow-table tbody tr:first-child {
    border-top: none !important;
}

.workflow-table tbody tr:first-child td {
    border-top: none !important;
}

/* Forzar que la tabla no tenga separación entre thead y tbody */
.workflow-table {
    border-collapse: collapse !important;
    border-spacing: 0 !important;
}

/* Eliminar todos los bordes del contenedor de tabla */
.table-container {
    border: none !important;
    border-top: none !important;
    border-bottom: none !important;
}

.table-responsive {
    border: none !important;
    border-top: none !important;
    border-bottom: none !important;
}

.card-body {
    border-top: none !important;
}

/* Eliminar cualquier borde superior o inferior de la tabla */
.workflow-table {
    border: none !important;
    border-top: none !important;
    border-bottom: none !important;
}

.workflow-table thead {
    border-top: none !important;
}

.workflow-table tbody {
    border-bottom: none !important;
}

/* Asegurar que los dropdowns Kanban aparezcan al frente */
.kanban-column .dropdown {
    z-index: 1050 !important;
}

.kanban-column .dropdown-menu {
    z-index: 1052 !important;
    position: fixed !important;
    will-change: transform !important;
}

.kanban-column .dropdown-toggle {
    z-index: 1051 !important;
}

/* Hacer más sutil el indicador de ordenamiento */
.workflow-table th {
    position: relative !important;
    padding-right: 1.5rem !important;
}

.workflow-table th.sortable::after {
    content: '⇅' !important;
    position: absolute !important;
    right: 0.5rem !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    font-size: 0.7rem !important;
    color: #6c757d !important;
    opacity: 0.5 !important;
    transition: opacity 0.2s ease !important;
}

.workflow-table th.sortable:hover::after {
    opacity: 1 !important;
    color: #495057 !important;
}

.workflow-table th.sorted-asc::after {
    content: '↑' !important;
    opacity: 1 !important;
    color: var(--verde-pacifico) !important;
}

.workflow-table th.sorted-desc::after {
    content: '↓' !important;
    opacity: 1 !important;
    color: var(--verde-pacifico) !important;
}

/* Toast notification styles */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 10001;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 300px;
    font-weight: 500;
}

.toast-notification.show {
    transform: translateX(0);
}

/* Ensure motivo consulta section is hidden by default */
#motivoConsultaSection {
    display: none !important;
}

#motivoConsultaSection.show {
    display: block !important;
}

.toast-notification.success {
    background: #28a745;
}

.toast-notification.error {
    background: #dc3545;
}

/* Auto-populated indicator styles */
.selected-item.auto-populated {
    border-left: 3px solid #28a745;
    background-color: #f8fff9;
}

.auto-populated-indicator {
    color: #28a745 !important;
    font-size: 0.75rem !important;
    display: block !important;
    margin-top: 4px !important;
    font-style: italic;
}

/* Cliente placeholder styles */
#clientePlaceholder {
    background-color: #f8f9fa;
    border: 1px dashed #dee2e6;
    border-radius: 6px;
    padding: 20px;
    text-align: center;
    color: #6c757d;
    font-size: 0.9rem;
}

#clientePlaceholder i {
    font-size: 1.2rem;
    margin-bottom: 8px;
    display: block;
}
</style>

{% include 'workflow/partials/drawer.html' %}

<!-- JavaScript functions for drawer functionality -->
<script>
// Define functions immediately to ensure they're available
(function() {
    // Search functionality variables
    let searchTimeout;
    let currentSearchType = '';
    
    // Ensure drawer functions are available globally
window.openSolicitudDrawerWithContext = function(pipelineId = null) {
    console.log('🔧 openSolicitudDrawerWithContext called with pipelineId:', pipelineId);
    
    // Check if drawer exists
    const drawer = document.getElementById('solicitudDrawer');
    if (!drawer) {
        console.error('❌ Drawer element not found!');
        alert('Error: Drawer not found. Please refresh the page.');
        return;
    }
    
    // Open drawer
    drawer.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // If pipelineId is provided, lock the pipeline selection
    if (pipelineId) {
        console.log('🔒 Locking pipeline:', pipelineId);
        lockPipeline(pipelineId);
    }
    
    console.log('✅ Drawer opened successfully');
};

// Also define the base openSolicitudDrawer function
window.openSolicitudDrawer = function(pipelineId = null) {
    console.log('🔧 openSolicitudDrawer called with pipelineId:', pipelineId);
    
    const drawer = document.getElementById('solicitudDrawer');
    if (!drawer) {
        console.error('❌ Drawer element not found!');
        return;
    }
    
    drawer.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    if (pipelineId) {
        lockPipeline(pipelineId);
    }
};

window.lockPipeline = function(pipelineId) {
    console.log('🔒 lockPipeline called with:', pipelineId);
    
    const pipelineSelect = document.getElementById('pipelineSelect');
    const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');
    const pipelineLockedName = document.getElementById('pipelineLockedName');
    
    if (!pipelineSelect || !pipelineLockedInfo || !pipelineLockedName) {
        console.error('❌ Pipeline elements not found!');
        return;
    }
    
    // Set and disable the select
    pipelineSelect.value = pipelineId;
    pipelineSelect.disabled = true;
    pipelineSelect.style.display = 'none';
    
    console.log('🔒 Pipeline select value set to:', pipelineSelect.value);
    console.log('🔒 Pipeline select disabled:', pipelineSelect.disabled);
    console.log('🔒 Pipeline select display:', pipelineSelect.style.display);
    
    // Show locked info
    const selectedOption = pipelineSelect.options[pipelineSelect.selectedIndex];
    if (selectedOption) {
        pipelineLockedName.textContent = selectedOption.text;
        pipelineLockedInfo.style.display = 'block';
        
        console.log('🔒 Pipeline locked info displayed:', pipelineLockedInfo.style.display);
        console.log('🔒 Pipeline locked name:', pipelineLockedName.textContent);
        
        // Load form data for the locked pipeline
        loadFormularioData(pipelineId);
    }
    
    console.log('✅ Pipeline locked successfully');
};

window.closeSolicitudDrawer = function() {
    console.log('🔧 closeSolicitudDrawer called');
    
    const drawer = document.getElementById('solicitudDrawer');
    if (drawer) {
        drawer.classList.remove('active');
        document.body.style.overflow = '';
        resetForm();
        console.log('✅ Drawer closed successfully');
    }
};

window.resetForm = function() {
    console.log('🔧 resetForm called');
    
    const form = document.getElementById('solicitudForm');
    if (form) {
        form.reset();
    }
    
    // Reset hidden inputs
    const cotizacionId = document.getElementById('cotizacionId');
    const clienteId = document.getElementById('clienteId');
    if (cotizacionId) cotizacionId.value = '';
    if (clienteId) clienteId.value = '';
    
    // Reset selected displays
    const cotizacionSelected = document.getElementById('cotizacionSelected');
    const clienteSelected = document.getElementById('clienteSelected');
    const clientePlaceholder = document.getElementById('clientePlaceholder');
    
    if (cotizacionSelected) cotizacionSelected.style.display = 'none';
    if (clienteSelected) {
        clienteSelected.style.display = 'none';
        clienteSelected.classList.remove('auto-populated');
        
        // Remove auto-populated indicator
        const indicator = clienteSelected.querySelector('.auto-populated-indicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    if (clientePlaceholder) {
        clientePlaceholder.style.display = 'block';
    }
    
    // Clear search inputs
    const cotizacionSearch = document.getElementById('cotizacionSearch');
    if (cotizacionSearch) cotizacionSearch.value = '';
    
    // Reset campos personalizados
    const camposContainer = document.getElementById('camposContainer');
    if (camposContainer) {
        camposContainer.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                Selecciona un pipeline para ver los campos personalizados
            </div>
        `;
    }
    
    // Reset requisitos
    const requisitosContainer = document.getElementById('requisitosContainer');
    if (requisitosContainer) {
        requisitosContainer.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                Selecciona un pipeline para ver los requisitos
            </div>
        `;
    }
    
    // Reset pipeline lock
    const pipelineSelect = document.getElementById('pipelineSelect');
    const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');
    if (pipelineSelect) {
        pipelineSelect.disabled = false;
        pipelineSelect.style.display = 'block';
        console.log('🔧 Pipeline select reset - disabled:', pipelineSelect.disabled, 'display:', pipelineSelect.style.display);
    }
    if (pipelineLockedInfo) {
        pipelineLockedInfo.style.display = 'none';
        console.log('🔧 Pipeline locked info reset - display:', pipelineLockedInfo.style.display);
    }
    
    hideSearchResults();
    console.log('✅ Form reset successfully');
};

window.loadFormularioData = function(pipelineId) {
    console.log('🔧 loadFormularioData called with pipelineId:', pipelineId);
    
    fetch(`/workflow/api/formulario-datos/?pipeline_id=${pipelineId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ Form data loaded:', data);
                renderCamposPersonalizados(data.campos_personalizados);
                renderRequisitos(data.requisitos);
            } else {
                console.error('❌ Error loading form data:', data.error);
            }
        })
        .catch(error => {
            console.error('❌ Error loading form data:', error);
        });
};

window.hideSearchResults = function(type) {
    if (type) {
        const results = document.getElementById(`${type}Results`);
        if (results) results.classList.remove('show');
    } else {
        const cotizacionResults = document.getElementById('cotizacionResults');
        if (cotizacionResults) cotizacionResults.classList.remove('show');
    }
};

// Initialize drawer functionality when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initializing drawer functionality...');
    
    // Close drawer when clicking outside
    const drawer = document.getElementById('solicitudDrawer');
    if (drawer) {
        drawer.addEventListener('click', function(e) {
            if (e.target === this) {
                closeSolicitudDrawer();
            }
        });
        console.log('✅ Drawer click outside handler initialized');
    }
    
    // Setup search functionality if elements exist
    const cotizacionSearch = document.getElementById('cotizacionSearch');
    if (cotizacionSearch) {
        setupSearch();
        console.log('✅ Search functionality initialized');
    }
    
    console.log('✅ Drawer functionality initialized successfully');
});

// Fallback function in case the drawer functions are not loaded
window.openSolicitudDrawer = function(pipelineId = null) {
    console.log('🔧 openSolicitudDrawer fallback called with pipelineId:', pipelineId);
    openSolicitudDrawerWithContext(pipelineId);
};

// Missing functions that are referenced but not defined
window.renderCamposPersonalizados = function(campos) {
    console.log('🔧 renderCamposPersonalizados called with:', campos);
    
    const container = document.getElementById('camposContainer');
    if (!container) {
        console.error('❌ camposContainer not found!');
        return;
    }
    
    container.innerHTML = '';
    
    if (!campos || campos.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                No hay campos personalizados para este pipeline
            </div>
        `;
        return;
    }
    
    campos.forEach(campo => {
        const campoDiv = document.createElement('div');
        campoDiv.className = 'campo-dinamico';
        
        let inputHtml = '';
        const required = campo.requerido ? 'required' : '';
        const requiredStar = campo.requerido ? '<span class="campo-required">*</span>' : '';
        
        switch (campo.tipo) {
            case 'texto':
                inputHtml = `<input type="text" class="form-control" name="campo_${campo.id}" ${required}>`;
                break;
            case 'numero':
                inputHtml = `<input type="number" step="0.01" class="form-control" name="campo_${campo.id}" ${required}>`;
                break;
            case 'entero':
                inputHtml = `<input type="number" class="form-control" name="campo_${campo.id}" ${required}>`;
                break;
            case 'fecha':
                inputHtml = `<input type="date" class="form-control" name="campo_${campo.id}" ${required}>`;
                break;
            case 'booleano':
                inputHtml = `
                    <select class="form-control" name="campo_${campo.id}" ${required}>
                        <option value="">Seleccionar...</option>
                        <option value="true">Sí</option>
                        <option value="false">No</option>
                    </select>
                `;
                break;
        }
        
        campoDiv.innerHTML = `
            <label class="campo-label">
                ${campo.nombre} ${requiredStar}
            </label>
            ${inputHtml}
        `;
        
        container.appendChild(campoDiv);
    });
    
    console.log('✅ Campos personalizados rendered successfully');
};

window.renderRequisitos = function(requisitos) {
    console.log('🔧 renderRequisitos called with:', requisitos);
    
    const container = document.getElementById('requisitosContainer');
    if (!container) {
        console.error('❌ requisitosContainer not found!');
        return;
    }
    
    container.innerHTML = '';
    
    if (!requisitos || requisitos.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                No hay requisitos para este pipeline
            </div>
        `;
        return;
    }
    
    requisitos.forEach(requisito => {
        const requisitoDiv = document.createElement('div');
        requisitoDiv.className = 'requisito-item';
        
        requisitoDiv.innerHTML = `
            <div class="requisito-header">
                <div class="requisito-info">
                    <div class="requisito-nombre">
                        ${requisito.nombre}
                        ${requisito.obligatorio ? '<span class="requisito-obligatorio">(Obligatorio)</span>' : ''}
                    </div>
                    ${requisito.descripcion ? `<div class="requisito-descripcion">${requisito.descripcion}</div>` : ''}
                </div>
            </div>
            <div class="requisito-upload">
                <label class="file-upload-label">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Subir archivo
                    <input type="file" class="file-upload-input" name="archivo_requisito_${requisito.id}" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.zip,.rar">
                </label>
                <div class="file-upload-info">
                    <small class="text-muted">Formatos permitidos: PDF, DOC, DOCX, JPG, PNG, GIF, ZIP, RAR</small>
                </div>
                <div class="file-selected" style="display: none;">
                    <i class="fas fa-file me-2"></i>
                    <span class="file-name"></span>
                    <button type="button" class="btn-remove-file" onclick="removeFile(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(requisitoDiv);
    });
    
    // Setup file upload handlers after rendering
    setTimeout(() => {
        setupFileUploadHandlers();
    }, 100);
    
    console.log('✅ Requisitos rendered successfully');
};

window.setupSearch = function() {
    console.log('🔧 setupSearch called');
    
    // Cotización search
    const cotizacionSearch = document.getElementById('cotizacionSearch');
    if (cotizacionSearch) {
        cotizacionSearch.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value;
            if (query.length < 2) {
                hideSearchResults('cotizacion');
                return;
            }
            searchTimeout = setTimeout(() => {
                searchCotizaciones(query);
            }, 300);
        });
    }



    // Pipeline change
    const pipelineSelect = document.getElementById('pipelineSelect');
    if (pipelineSelect) {
        pipelineSelect.addEventListener('change', function(e) {
            const pipelineId = e.target.value;
            if (pipelineId) {
                loadFormularioData(pipelineId);
            } else {
                // Reset to placeholder messages
                const camposContainer = document.getElementById('camposContainer');
                const requisitosContainer = document.getElementById('requisitosContainer');
                
                if (camposContainer) {
                    camposContainer.innerHTML = `
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona un pipeline para ver los campos personalizados
                        </div>
                    `;
                }
                
                if (requisitosContainer) {
                    requisitosContainer.innerHTML = `
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona un pipeline para ver los requisitos
                        </div>
                    `;
                }
            }
        });
    }
    
    console.log('✅ Search functionality setup successfully');
};

// Search functions moved to top of IIFE
function searchCotizaciones(query) {
    console.log('🔧 searchCotizaciones called with query:', query);
    
    fetch(`/workflow/api/buscar-cotizaciones-drawer/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSearchResults('cotizacion', data.cotizaciones);
            }
        })
        .catch(error => {
            console.error('❌ Error searching cotizaciones:', error);
        });
}

function showSearchResults(type, results) {
    console.log('🔧 showSearchResults called with type:', type, 'results:', results);
    
    const resultsContainer = document.getElementById(`${type}Results`);
    if (!resultsContainer) {
        console.error('❌ Results container not found for type:', type);
        return;
    }
    
    resultsContainer.innerHTML = '';
    
    if (!results || results.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
    } else {
        results.forEach(item => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.onclick = () => selectItem(type, item);
            
            if (type === 'cotizacion') {
                const montoFinanciado = item.montoFinanciado || item.auxMonto2 || 0;
                const montoFormateado = typeof montoFinanciado === 'number' ? montoFinanciado.toLocaleString() : '0';
                resultItem.innerHTML = `
                    <div class="search-result-name">${item.nombreCliente || 'Sin nombre'}</div>
                    <div class="search-result-details">
                        ${item.cedulaCliente || 'Sin cédula'} • 
                        ${item.tipoPrestamo || 'Sin tipo'} • 
                        Monto Financiado: $${montoFormateado}
                    </div>
                `;
            } else {
                resultItem.innerHTML = `
                    <div class="search-result-name">${item.nombreCliente || 'Sin nombre'}</div>
                    <div class="search-result-details">
                        ${item.cedulaCliente || 'Sin cédula'} • 
                        ${item.tipoPrestamo || 'Sin tipo'} • 
                        $${(item.montoPrestamo || 0).toLocaleString()}
                    </div>
                `;
            }
            
            resultsContainer.appendChild(resultItem);
        });
    }
    
    resultsContainer.classList.add('show');
}

function selectItem(type, item) {
    console.log('🔧 selectItem called with type:', type, 'item:', item);
    
    const idInput = document.getElementById(`${type}Id`);
    const searchInput = document.getElementById(`${type}Search`);
    const selectedContainer = document.getElementById(`${type}Selected`);
    
    if (idInput) idInput.value = item.id;
    if (searchInput) searchInput.value = '';
    
    if (selectedContainer) {
        const nameElement = selectedContainer.querySelector('.selected-name');
        const detailsElement = selectedContainer.querySelector('.selected-details');
        
        if (nameElement) nameElement.textContent = item.nombreCliente || 'Sin nombre';
        if (detailsElement) {
            if (type === 'cotizacion') {
                const montoFinanciado = item.montoFinanciado || item.auxMonto2 || 0;
                const montoFormateado = typeof montoFinanciado === 'number' ? montoFinanciado.toLocaleString() : '0';
                detailsElement.textContent = `${item.cedulaCliente || 'Sin cédula'} • ${item.tipoPrestamo || 'Sin tipo'} • Monto Financiado: $${montoFormateado}`;
                
                // Show observaciones section and populate with observaciones from cotización
                const observacionesSection = document.getElementById('observacionesSection');
                const observacionesSelected = document.getElementById('observacionesSelected');
                const observacionesPlaceholder = document.getElementById('observacionesPlaceholder');
                const observacionesText = document.querySelector('.observaciones-text');
                
                if (observacionesSection && observacionesSelected && observacionesPlaceholder && observacionesText) {
                    observacionesSection.style.display = 'block';
                    
                    const observaciones = item.observaciones || '';
                    
                    if (observaciones.trim()) {
                        observacionesText.textContent = observaciones;
                        observacionesSelected.style.display = 'block';
                        observacionesPlaceholder.style.display = 'none';
                    } else {
                        observacionesSelected.style.display = 'none';
                        observacionesPlaceholder.style.display = 'block';
                    }
                }
                
                // Show motivo de consulta section and populate with observaciones
                const motivoSection = document.getElementById('motivoConsultaSection');
                const motivoTextarea = document.getElementById('motivoConsulta');
                
                if (motivoSection && motivoTextarea) {
                    motivoSection.classList.add('show');
                    
                    const observaciones = item.observaciones || '';
                    motivoTextarea.value = observaciones;
                    motivoTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    if (!observaciones.trim()) {
                        setTimeout(() => {
                            motivoTextarea.focus();
                        }, 100);
                    }
                }
            } else {
                detailsElement.textContent = `${item.cedulaCliente || 'Sin cédula'} • ${item.tipoPrestamo || 'Sin tipo'} • $${(item.montoPrestamo || 0).toLocaleString()}`;
            }
        }
        
        selectedContainer.style.display = 'block';
    }
    
    hideSearchResults(type);
}



// Duplicate functions removed - using the ones defined at the top of IIFE

function autoPopulateClienteFromCotizacion(cotizacion) {
    console.log('🔧 autoPopulateClienteFromCotizacion called with:', cotizacion);
    
    // Clear any existing cliente first
    clearCliente();
    
    // Create a cliente object from cotización data
    const clienteData = {
        id: null, // We'll need to find the actual cliente ID
        nombreCliente: cotizacion.nombreCliente,
        cedulaCliente: cotizacion.cedulaCliente,
        edad: null, // Not available in cotización data
        sexo: null  // Not available in cotización data
    };
    
    // Search for the actual cliente by cédula
    if (clienteData.cedulaCliente) {
        fetch(`/workflow/api/buscar-clientes-drawer/?q=${encodeURIComponent(clienteData.cedulaCliente)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.clientes.length > 0) {
                    // Use the first matching cliente
                    const cliente = data.clientes[0];
                    console.log('🔧 Found matching cliente:', cliente);
                    selectClienteAutomatically(cliente);
                } else {
                    // If no cliente found, create a virtual cliente object
                    console.log('🔧 No matching cliente found, using cotización data');
                    selectClienteAutomatically(clienteData);
                }
            })
            .catch(error => {
                console.error('❌ Error searching for cliente:', error);
                // Fallback to using cotización data
                selectClienteAutomatically(clienteData);
            });
    } else {
        // No cédula available, use cotización data directly
        selectClienteAutomatically(clienteData);
    }
}

function selectClienteAutomatically(cliente) {
    console.log('🔧 selectClienteAutomatically called with:', cliente);
    
    const clienteIdInput = document.getElementById('clienteId');
    const clienteSelectedContainer = document.getElementById('clienteSelected');
    const clientePlaceholder = document.getElementById('clientePlaceholder');
    
    if (clienteIdInput) clienteIdInput.value = cliente.id || '';
    
    if (clienteSelectedContainer && clientePlaceholder) {
        const nameElement = clienteSelectedContainer.querySelector('.selected-name');
        const detailsElement = clienteSelectedContainer.querySelector('.selected-details');
        
        if (nameElement) nameElement.textContent = cliente.nombreCliente || 'Sin nombre';
        if (detailsElement) {
            if (cliente.id) {
                // Real cliente with full data
                detailsElement.textContent = `${cliente.cedulaCliente || 'Sin cédula'} • ${cliente.edad || 'Sin edad'} años`;
            } else {
                // Virtual cliente from cotización data
                detailsElement.textContent = `${cliente.cedulaCliente || 'Sin cédula'} • (Datos de cotización)`;
            }
        }
        
        // Add auto-populated indicator
        clienteSelectedContainer.classList.add('auto-populated');
        clienteSelectedContainer.style.display = 'block';
        clientePlaceholder.style.display = 'none';
        
        // Add a small indicator text
        const indicator = document.createElement('small');
        indicator.className = 'auto-populated-indicator';
        indicator.innerHTML = '<i class="fas fa-magic me-1"></i>Auto-completado desde cotización';
        
        // Remove any existing indicator
        const existingIndicator = clienteSelectedContainer.querySelector('.auto-populated-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        clienteSelectedContainer.appendChild(indicator);
    }
}

function setupFileUploadHandlers() {
    console.log('🔧 setupFileUploadHandlers called');
    
    document.querySelectorAll('.file-upload-input').forEach(input => {
        input.addEventListener('change', function() {
            const file = this.files[0];
            const requisitoItem = this.closest('.requisito-item');
            const fileSelected = requisitoItem.querySelector('.file-selected');
            const fileName = fileSelected.querySelector('.file-name');
            const uploadLabel = requisitoItem.querySelector('.file-upload-label');
            
            if (file) {
                fileName.textContent = file.name;
                fileSelected.style.display = 'flex';
                uploadLabel.style.display = 'none';
            }
        });
    });
}

function removeFile(button) {
    console.log('🔧 removeFile called');
    
    const requisitoItem = button.closest('.requisito-item');
    const fileSelected = requisitoItem.querySelector('.file-selected');
    const uploadLabel = requisitoItem.querySelector('.file-upload-label');
    const fileInput = requisitoItem.querySelector('.file-upload-input');
    
    fileInput.value = '';
    fileSelected.style.display = 'none';
    uploadLabel.style.display = 'inline-block';
}

// Additional functions that might be missing
window.submitSolicitud = function() {
    console.log('🔧 submitSolicitud called');
    
    const form = document.getElementById('solicitudForm');
    const formData = new FormData(form);
    
    // Validar pipeline - check both form data and locked pipeline
    const pipelineFromForm = formData.get('pipeline');
    const pipelineSelect = document.getElementById('pipelineSelect');
    const pipelineLockedInfo = document.getElementById('pipelineLockedInfo');
    
    let pipelineId = pipelineFromForm;
    
    // If pipeline is locked (hidden), get the value from the select element
    if (!pipelineId && pipelineLockedInfo && pipelineLockedInfo.style.display !== 'none') {
        pipelineId = pipelineSelect ? pipelineSelect.value : null;
        console.log('🔧 Pipeline is locked, using value from select:', pipelineId);
    }
    
    if (!pipelineId) {
        alert('Por favor selecciona un pipeline');
        return;
    }
    
    // If pipeline was locked, add it to form data
    if (!pipelineFromForm && pipelineId) {
        formData.set('pipeline', pipelineId);
        console.log('🔧 Added locked pipeline to form data:', pipelineId);
    }
    
    // Debug: Log all form data
    console.log('🔧 Form data contents:');
    for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    
    // Validar archivos obligatorios si corresponde
    const requiredFiles = document.querySelectorAll('.requisito-item .file-upload-input[required]');
    let hasRequiredFiles = true;
    
    for (let input of requiredFiles) {
        if (!input.files || input.files.length === 0) {
            hasRequiredFiles = false;
            break;
        }
    }
    
    if (!hasRequiredFiles) {
        alert('Por favor sube todos los archivos obligatorios');
        return;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('.drawer-footer .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner"></span> Creando...';
    submitBtn.disabled = true;
    
    fetch('/workflow/nueva-solicitud/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeSolicitudDrawer();
            // Mostrar mensaje de éxito
            showSuccessMessage(data.message);
            // Recargar la página para mostrar la nueva solicitud
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al crear la solicitud');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
};

window.showSuccessMessage = function(message) {
    console.log('🔧 showSuccessMessage called with:', message);
    
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification success';
    toast.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
    `;
    
    document.body.appendChild(toast);
    
    // Show toast
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
};

window.clearCotizacion = function() {
    console.log('🔧 clearCotizacion called');
    document.getElementById('cotizacionId').value = '';
    document.getElementById('cotizacionSelected').style.display = 'none';
    
    // Also clear cliente when cotización is cleared
    console.log('🔧 Also clearing cliente due to cotización clear');
    clearCliente();
};

window.clearCliente = function() {
    console.log('🔧 clearCliente called');
    document.getElementById('clienteId').value = '';
    const clienteSelected = document.getElementById('clienteSelected');
    const clientePlaceholder = document.getElementById('clientePlaceholder');
    
    if (clienteSelected) {
        clienteSelected.style.display = 'none';
        clienteSelected.classList.remove('auto-populated');
        
        // Remove auto-populated indicator
        const indicator = clienteSelected.querySelector('.auto-populated-indicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    if (clientePlaceholder) {
        clientePlaceholder.style.display = 'block';
    }
};

// Función para cerrar el modal de requisitos
// Función unificada para cerrar el modal de requisitos
window.cerrarModalRequisitos = function() {
    console.log('🚪 Cerrando modal de requisitos');
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalRequisitosFaltantes'));
    if (modal) {
        modal.hide();
    } else {
        // Si no hay instancia, intentar crear una nueva y ocultarla
        const modalElement = document.getElementById('modalRequisitosFaltantes');
        if (modalElement) {
            const newModal = new bootstrap.Modal(modalElement);
            newModal.hide();
        }
    }
    
    // Resetear estado después de cerrar
    setTimeout(() => {
        window.resetearEstadoModal();
    }, 300);
}

// Función unificada para mostrar modal de requisitos faltantes (funciona para tabla y kanban)
window.mostrarModalRequisitosFaltantes = function(solicitudId, nuevaEtapaId, nombreEtapa, callbackExito, callbackCancelacion) {
    console.log('🔍 Mostrando modal de requisitos faltantes');
    console.log('📋 Parámetros recibidos:', { solicitudId, nuevaEtapaId, nombreEtapa, callbackExito: typeof callbackExito, callbackCancelacion: typeof callbackCancelacion });
    
    // Validar parámetros con early return
    if (!solicitudId || !nuevaEtapaId || !nombreEtapa) {
        console.error('❌ Parámetros inválidos:', { solicitudId, nuevaEtapaId, nombreEtapa });
        const errorMessage = 'Error: Parámetros inválidos para mostrar modal de requisitos';
        
        if (typeof showToast !== 'undefined') {
            showToast(errorMessage, 'error', 6000);
        } else {
            alert(errorMessage);
        }
        return;
    }
    
    // Set current solicitud ID for file uploads
    window.currentSolicitudId = solicitudId;
    console.log('🔧 currentSolicitudId establecido:', window.currentSolicitudId);
    
    // Resetear estado del modal
    window.resetearEstadoModal();
    
    // Mostrar loading en el modal
    const listaContainer = document.getElementById('listaRequisitosFaltantes');
    const loadingElement = document.getElementById('loadingRequisitos');
    
    if (listaContainer) listaContainer.innerHTML = '';
    if (loadingElement) loadingElement.style.display = 'block';
    
    // Actualizar título del modal
    const etapaDestinoElement = document.getElementById('etapaDestinoNombre');
    if (etapaDestinoElement) {
        etapaDestinoElement.textContent = nombreEtapa;
    }
    
    // Cargar requisitos faltantes
    fetch(`/workflow/api/solicitudes/${solicitudId}/requisitos-faltantes-detallado/?nueva_etapa_id=${nuevaEtapaId}`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('📋 Requisitos faltantes recibidos:', data);
        
        // Ocultar loading
        if (loadingElement) loadingElement.style.display = 'none';
        
        if (data.success) {
            // Llenar la lista de requisitos faltantes
            window.llenarListaRequisitosFaltantes(data.requisitos, data.total_requisitos, data.requisitos_completos);
            
            // Configurar event listeners del modal
            window.configurarEventListenersModal(solicitudId, nuevaEtapaId, callbackExito, callbackCancelacion);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalRequisitosFaltantes'));
            modal.show();
        } else {
            console.error('❌ Error al cargar requisitos faltantes:', data.error);
            if (typeof showToast !== 'undefined') {
                showToast('Error al cargar requisitos faltantes: ' + data.error, 'error', 6000);
            } else {
                alert('Error al cargar requisitos faltantes: ' + data.error);
            }
        }
    })
    .catch(error => {
        console.error('❌ Error en petición de requisitos faltantes:', error);
        // Ocultar loading
        if (loadingElement) loadingElement.style.display = 'none';
        
        if (typeof showToast !== 'undefined') {
            showToast('Error al cargar requisitos faltantes', 'error', 6000);
        } else {
            alert('Error al cargar requisitos faltantes');
        }
    });
}

// Función unificada para llenar la lista de requisitos en el modal
window.llenarListaRequisitosFaltantes = function(requisitos, totalRequisitos, requisitosCompletos) {
    const listaContainer = document.getElementById('listaRequisitosFaltantes');
    const btnValidar = document.getElementById('btnValidarYContinuar');
    
    if (!listaContainer) {
        console.error('❌ No se encontró el contenedor de requisitos');
        return;
    }
    
    if (!btnValidar) {
        console.error('❌ No se encontró el botón de validar');
        return;
    }
    
    // Store the data globally for use by verification function
    window.currentRequisitosData = {
        requisitos: requisitos,
        total_requisitos: totalRequisitos,
        requisitos_completos: requisitosCompletos
    };
    
    // Limpiar contenedor
    listaContainer.innerHTML = '';
    
    // Si todos los requisitos están completos, mostrar mensaje de éxito
    if (requisitosCompletos === totalRequisitos) {
        btnValidar.innerHTML = `<i class="fas fa-check me-2"></i>Todos los Requisitos Completos - Continuar`;
        btnValidar.className = 'btn btn-success';
        btnValidar.disabled = false;
        listaContainer.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Todos los requisitos están completos</div>';
        return;
    }
    
    // Validar que requisitos sea un array
    if (!Array.isArray(requisitos)) {
        console.error('❌ requisitos no es un array:', requisitos);
        listaContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error al cargar requisitos</div>';
        btnValidar.disabled = true;
        return;
    }
    
    // Actualizar el botón con el conteo correcto
    btnValidar.innerHTML = `<i class="fas fa-check me-2"></i>Validar y Continuar (${requisitosCompletos}/${totalRequisitos})`;
    if (requisitosCompletos === totalRequisitos) {
        btnValidar.className = 'btn btn-success';
        btnValidar.disabled = false;
    } else {
        btnValidar.className = 'btn btn-primary';
        btnValidar.disabled = true;
    }
    
    if (requisitos.length === 0) {
        listaContainer.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Todos los requisitos están completos</div>';
        return;
    }
    
    requisitos.forEach(requisito => {
        const isCompleto = requisito.esta_cumplido;
        const tituloClass = isCompleto ? 'text-success' : 'text-danger';
        const tituloIcon = isCompleto ? 'fa-check-circle' : 'fa-exclamation-triangle';
        const badgeClass = isCompleto ? 'bg-success' : 'bg-danger';
        const badgeText = isCompleto ? 'Completo' : 'Faltante';
        const cardClass = isCompleto ? 'border-success' : 'border-danger';
        
        const requisitoHtml = `
            <div class="card mb-3 requisito-card ${cardClass}" data-requisito-id="${requisito.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="card-title ${tituloClass} mb-1">
                                <i class="fas ${tituloIcon} me-2"></i>
                                ${requisito.nombre}
                            </h6>
                            ${requisito.descripcion ? `<p class="text-muted small mb-2">${requisito.descripcion}</p>` : ''}
                            ${requisito.mensaje_personalizado ? `<p class="text-info small mb-2"><i class="fas fa-info-circle me-1"></i>${requisito.mensaje_personalizado}</p>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>
                    </div>
                    
                    ${requisito.archivo_actual ? `
                        <div class="alert alert-success mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-file-check me-2 mt-1 text-success"></i>
                                <div class="flex-grow-1">
                                    <strong>Archivo subido:</strong> 
                                    <a href="${requisito.archivo_actual.url}" target="_blank" class="text-decoration-none">
                                        ${requisito.archivo_actual.nombre}
                                    </a>
                                    ${!isCompleto ? `
                                        <div class="mt-2 d-flex gap-2">
                                            <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="mostrarUploadParaReemplazo(${requisito.id})" aria-label="Reemplazar archivo">
                                                <i class="fas fa-upload me-1"></i>Reemplazar archivo
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" style="display:none;" id="cancelar-upload-btn-${requisito.id}" onclick="cancelarUploadParaReemplazo(${requisito.id})" aria-label="Cancelar reemplazo">
                                                <i class="fas fa-times me-1"></i>Cancelar
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${!isCompleto ? `
                        <div class="upload-section" style="${requisito.archivo_actual ? 'display: none;' : ''}" id="upload-section-${requisito.id}">
                            <div class="mb-3">
                                <label class="form-label">
                                    ${requisito.archivo_actual ? 'Reemplazar archivo' : 'Subir archivo'} 
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="file" class="form-control requisito-file-input" 
                                       data-requisito-id="${requisito.id}" 
                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif"
                                       aria-label="${requisito.archivo_actual ? 'Reemplazar archivo' : 'Subir archivo'}">
                                <small class="text-muted">El archivo se subirá automáticamente cuando hagas clic en 'Validar y Continuar'</small>
                            </div>
                        </div>
                    ` : `
                        <div class="alert alert-light border-success">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span class="text-success fw-semibold">Requisito completado</span>
                            </div>
                        </div>
                    `}
                </div>
            </div>
        `;
        
        listaContainer.insertAdjacentHTML('beforeend', requisitoHtml);
    });
    
    // Configurar event listeners para los inputs de archivo
    window.configurarEventListenersArchivos();
    
    // Verificar estado inicial de requisitos
    window.verificarTodosRequisitosCompletos();
}

// Función para mostrar upload para reemplazar archivo
window.mostrarUploadParaReemplazo = function(requisitoId) {
    const uploadSection = document.getElementById(`upload-section-${requisitoId}`);
    const cancelarBtn = document.getElementById(`cancelar-upload-btn-${requisitoId}`);
    if (uploadSection) {
        uploadSection.style.display = 'block';
        if (cancelarBtn) cancelarBtn.style.display = 'inline-block';
        // Scroll to the upload section
        uploadSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// Función para cancelar upload para reemplazo
window.cancelarUploadParaReemplazo = function(requisitoId) {
    const uploadSection = document.getElementById(`upload-section-${requisitoId}`);
    const cancelarBtn = document.getElementById(`cancelar-upload-btn-${requisitoId}`);
    if (uploadSection) uploadSection.style.display = 'none';
    if (cancelarBtn) cancelarBtn.style.display = 'none';
}

// Función para configurar event listeners de archivos
window.configurarEventListenersArchivos = function() {
    // Los archivos se subirán automáticamente cuando se haga clic en "Validar y Continuar"
    console.log('Event listeners de archivos configurados - los archivos se subirán con "Validar y Continuar"');
    
    // Actualizar estado del botón cuando se selecciona un archivo
    document.querySelectorAll('.requisito-file-input').forEach(input => {
        input.addEventListener('change', function() {
            // Verificar estado de requisitos después de seleccionar archivo
            setTimeout(() => {
                window.verificarTodosRequisitosCompletos();
            }, 100);
        });
    });
}

/*
 * SISTEMA UNIFICADO DE REQUISITOS FALTANTES
 * =========================================
 * 
 * Este sistema maneja la validación y carga de requisitos faltantes para transiciones
 * de etapa tanto en vista de tabla como en vista Kanban.
 * 
 * FUNCIONES PRINCIPALES:
 * - mostrarModalRequisitosFaltantes: Función principal que muestra el modal
 * - llenarListaRequisitosFaltantes: Llena la lista de requisitos en el modal
 * - configurarEventListenersModal: Configura los eventos del modal
 * - verificarTodosRequisitosCompletos: Verifica si todos los requisitos están completos
 * - subirArchivosSecuencialmente: Sube archivos uno por uno con progreso
 * - resetearEstadoModal: Resetea el estado del modal
 * - cerrarModalRequisitos: Cierra el modal de forma segura
 * - ejecutarCambioEtapa: Función unificada para cambiar etapa
 * - verificarFuncionesRequisitos: Verifica que todas las funciones estén disponibles
 * 
 * FLUJO DE TRABAJO:
 * 1. Usuario intenta cambiar etapa (tabla o kanban)
 * 2. Se verifica si hay requisitos faltantes
 * 3. Si los hay, se muestra el modal con la lista
 * 4. Usuario sube archivos o confirma requisitos existentes
 * 5. Se validan todos los requisitos
 * 6. Se ejecuta la transición de etapa
 * 7. Se actualiza la UI según la vista (tabla o kanban)
 */

// Función para resetear el estado del modal
window.resetearEstadoModal = function() {
    console.log('🔄 Reseteando estado del modal');
    
    // Resetear botón de validar
    const btnValidar = document.getElementById('btnValidarYContinuar');
    if (btnValidar) {
        btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Validar y Continuar';
        btnValidar.className = 'btn btn-primary';
        btnValidar.disabled = true;
    }
    
    // Limpiar contenedor de requisitos
    const listaContainer = document.getElementById('listaRequisitosFaltantes');
    if (listaContainer) {
        listaContainer.innerHTML = '';
    }
    
    // Ocultar loading
    const loadingElement = document.getElementById('loadingRequisitos');
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
    
    // Limpiar variables globales
    window.currentSolicitudId = null;
    window.currentNuevaEtapaId = null;
}

// Función unificada para subir archivos secuencialmente
window.subirArchivosSecuencialmente = function(archivos, index, callback) {
    // Early return if all files processed
    if (index >= archivos.length) {
        console.log('✅ Todos los archivos procesados');
        if (typeof callback === 'function') {
            callback(true); // Pass success flag
        }
        return;
    }
    
    // Update progress in loading overlay (removed to fix recursion error)
    console.log(`📤 Procesando archivo ${index + 1} de ${archivos.length}`);
    
    
    const archivo = archivos[index];
    
    // Validate required data
    if (!archivo.requisitoId || !archivo.file) {
        console.error('❌ Datos de archivo inválidos:', archivo);
        // Continue with next file
        window.subirArchivosSecuencialmente(archivos, index + 1, callback);
        return;
    }
    
    const formData = new FormData();
    formData.append('requisito_id', archivo.requisitoId);
    formData.append('archivo', archivo.file);
    
    const solicitudId = window.currentSolicitudId;
    
    if (!solicitudId) {
        console.error('❌ No se encontró solicitudId para subir archivo');
        // Continue with next file
        window.subirArchivosSecuencialmente(archivos, index + 1, callback);
        return;
    }
    
    console.log(`📤 Subiendo archivo ${index + 1}/${archivos.length} para requisito ${archivo.requisitoId}`);
    
    const handleUploadError = (error, isNetworkError = false) => {
        console.error(`❌ Error al subir archivo para requisito ${archivo.requisitoId}:`, error);
        
        const mensaje = isNetworkError 
            ? `Error de conexión al subir archivo: ${error}`
            : `Error al subir archivo: ${error}`;
            
        if (typeof showToast !== 'undefined') {
            showToast(mensaje, 'error', 5000);
        }
        
        // Continue with next file even on error
        window.subirArchivosSecuencialmente(archivos, index + 1, callback);
    };
    
    fetch(`/workflow/api/solicitudes/${solicitudId}/subir-requisito-modal/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log(`✅ Archivo subido exitosamente para requisito ${archivo.requisitoId}`);
            
            // Update UI for this requirement
            const requisitoCard = document.querySelector(`.requisito-card[data-requisito-id="${archivo.requisitoId}"]`);
            if (requisitoCard) {
                const uploadSection = requisitoCard.querySelector('.upload-section');
                const successSection = requisitoCard.querySelector('.success-section');
                
                if (uploadSection) uploadSection.style.display = 'none';
                if (successSection) successSection.style.display = 'block';
                
                // Update badge with proper classes
                const badge = requisitoCard.querySelector('.badge');
                if (badge) {
                    badge.className = 'badge bg-success';
                    badge.textContent = 'Completo';
                }
            }
            
            // Continue with next file
            window.subirArchivosSecuencialmente(archivos, index + 1, callback);
        } else {
            // Handle server-side error
            handleUploadError(data.error || 'Error desconocido del servidor');
        }
    })
    .catch(error => {
        // Handle network or parsing errors
        handleUploadError(error.message, true);
    });
};

// Función para subir requisito desde el modal (mantenida para compatibilidad)
window.subirRequisitoModal = function(requisitoId) {
    const fileInput = document.querySelector(`.requisito-file-input[data-requisito-id="${requisitoId}"]`);
    const btnSubir = document.querySelector(`.btn-subir-requisito[data-requisito-id="${requisitoId}"]`);
    const requisitoCard = document.querySelector(`.requisito-card[data-requisito-id="${requisitoId}"]`);
    
    if (!fileInput.files.length) {
        alert('Por favor selecciona un archivo');
        return;
    }
    
    const formData = new FormData();
    formData.append('requisito_id', requisitoId);
    formData.append('archivo', fileInput.files[0]);
    
    // Mostrar estado de carga
    const originalText = btnSubir.innerHTML;
    btnSubir.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Subiendo...';
    btnSubir.disabled = true;
    
    // Obtener solicitud ID del modal (se puede pasar como parámetro global)
    const solicitudId = window.currentSolicitudId;
    
    fetch(`/workflow/api/solicitudes/${solicitudId}/subir-requisito-modal/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ocultar sección de upload y mostrar éxito
            const uploadSection = requisitoCard.querySelector('.upload-section');
            const successSection = requisitoCard.querySelector('.success-section');
            
            uploadSection.style.display = 'none';
            successSection.style.display = 'block';
            
            // Actualizar badge
            const badge = requisitoCard.querySelector('.badge');
            badge.className = 'badge bg-success';
            badge.textContent = 'Completo';
            
            // Mostrar mensaje de éxito
            if (typeof showToast !== 'undefined') {
                showToast(data.mensaje, 'success', 4000);
            }
            
            // Verificar si todos los requisitos están completos
            window.verificarTodosRequisitosCompletos();
            
        } else {
            alert('Error al subir requisito: ' + data.error);
            btnSubir.innerHTML = originalText;
            btnSubir.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al subir requisito');
        btnSubir.innerHTML = originalText;
        btnSubir.disabled = false;
    });
}

// Función unificada para verificar si todos los requisitos están completos
window.verificarTodosRequisitosCompletos = function() {
    const btnValidar = document.getElementById('btnValidarYContinuar');
    
    if (!btnValidar) {
        console.error('❌ No se encontró el botón de validar');
        return false;
    }
    
    // Use the data from the last API call instead of counting DOM elements
    const requisitosData = window.currentRequisitosData;
    if (!requisitosData) {
        console.warn('⚠️ No hay datos de requisitos disponibles');
        return false;
    }
    
    const totalRequisitos = requisitosData.total_requisitos;
    const requisitosCompletos = requisitosData.requisitos_completos;
    
    // Count files selected for incomplete requirements
    let archivosSeleccionadosParaIncompletos = 0;
    const requisitosIncompletos = requisitosData.requisitos.filter(req => !req.esta_cumplido);
    
    requisitosIncompletos.forEach(requisito => {
        const fileInput = document.querySelector(`.requisito-file-input[data-requisito-id="${requisito.id}"]`);
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
            // Check if file input is visible (not hidden due to completion)
            const isVisible = fileInput.offsetParent !== null || 
                              getComputedStyle(fileInput).display !== 'none';
            if (isVisible) {
                archivosSeleccionadosParaIncompletos++;
            }
        }
    });
    
    console.log('🔍 Verificando requisitos:', { 
        totalRequisitos, 
        requisitosCompletos, 
        archivosSeleccionadosParaIncompletos,
        requisitosIncompletos: requisitosIncompletos.length,
        requisitosData: requisitosData
    });
    
    // Early return for no requirements
    if (totalRequisitos === 0) {
        btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Continuar';
        btnValidar.className = 'btn btn-success';
        btnValidar.disabled = false;
        return true;
    }
    
    // All requirements completed
    if (totalRequisitos === requisitosCompletos && totalRequisitos > 0) {
        btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Todos los Requisitos Completos - Continuar';
        btnValidar.className = 'btn btn-success';
        btnValidar.disabled = false;
        return true;
    }
    
    // Files selected for incomplete requirements
    if (archivosSeleccionadosParaIncompletos > 0) {
        btnValidar.innerHTML = `<i class="fas fa-upload me-2"></i>Validar y Continuar (${requisitosCompletos}/${totalRequisitos})`;
        btnValidar.className = 'btn btn-primary';
        btnValidar.disabled = false;
        return false; // Not all complete, but can proceed with upload
    }
    
    // No files selected and requirements missing
    btnValidar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Validar y Continuar (${requisitosCompletos}/${totalRequisitos})`;
    btnValidar.className = 'btn btn-warning';
    btnValidar.disabled = true;
    return false;
};

// Función unificada para configurar event listeners del modal
window.configurarEventListenersModal = function(solicitudId, nuevaEtapaId, callbackExito, callbackCancelacion) {
    console.log('🔧 Configurando event listeners del modal:', { solicitudId, nuevaEtapaId });
    
    // Guardar para uso global
    window.currentSolicitudId = solicitudId;
    window.currentNuevaEtapaId = nuevaEtapaId;
    
    // Botón de validar y continuar
    const btnValidar = document.getElementById('btnValidarYContinuar');
    if (!btnValidar) {
        console.error('❌ No se encontró el botón de validar');
        return;
    }
    
    btnValidar.onclick = function() {
        console.log('🔄 Botón validar clickeado');
        
        // Early return if button is disabled
        if (btnValidar.disabled) {
            console.log('⚠️ Botón deshabilitado, ignorando click');
            return;
        }
        
        // Disable button immediately to prevent double clicks
        btnValidar.disabled = true;
        const originalHTML = btnValidar.innerHTML;
        
        // Get current requirements state
        const totalRequisitos = document.querySelectorAll('.requisito-card').length;
        const requisitosCompletos = document.querySelectorAll('.requisito-card .badge.bg-success').length;
        
        // Get files that need to be uploaded
        const requisitosConArchivos = document.querySelectorAll('.requisito-card .requisito-file-input');
        const archivosParaSubir = [];
        
        requisitosConArchivos.forEach(input => {
            if (input.files && input.files.length > 0) {
                const requisitoCard = input.closest('.requisito-card');
                const badge = requisitoCard?.querySelector('.badge');
                
                // Only upload if not already completed
                if (badge && !badge.classList.contains('bg-success')) {
                    archivosParaSubir.push({
                        requisitoId: input.dataset.requisitoId,
                        file: input.files[0]
                    });
                }
            }
        });
        
        console.log('📁 Archivos para subir:', archivosParaSubir.length);
        console.log('🔍 Verificando requisitos:', {
            totalRequisitos,
            requisitosCompletos,
            archivosSeleccionados: archivosParaSubir.length
        });
        
        // Function to handle success completion
        const handleSuccessCompletion = () => {
            console.log('✅ Todos los requisitos completos, procediendo con transición');
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalRequisitosFaltantes'));
            if (modal) {
                modal.hide();
            }
            if (callbackExito) {
                callbackExito();
            }
        };
        
        // Function to handle error/incomplete state
        const handleIncompleteState = (currentCompleted, currentTotal) => {
            const pendingCount = currentTotal - currentCompleted;
            const mensaje = `Aún faltan ${pendingCount} requisitos por completar`;
            
            btnValidar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Validar y Continuar (${currentCompleted}/${currentTotal})`;
            btnValidar.className = 'btn btn-warning';
            btnValidar.disabled = true;
            
            if (typeof showToast !== 'undefined') {
                showToast(mensaje, 'warning', 6000);
            } else {
                alert(mensaje);
            }
        };
        
        // If there are files to upload, handle them first
        if (archivosParaSubir.length > 0) {
            btnValidar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Subiendo archivos...';
            
            // Show loading overlay with progress (removed to fix recursion error)
            console.log(`📤 Iniciando carga de ${archivosParaSubir.length} archivos`);
            
            
            // Upload files sequentially with proper error handling
            window.subirArchivosSecuencialmente(archivosParaSubir, 0, function(uploadSuccess = true) {
                // Hide loading overlay (removed to fix recursion error)
                console.log('📤 Finalizando carga de archivos');
                
                
                // Verify final state after uploads
                window.verificarTodosRequisitosCompletos();
                
                const finalTotalRequisitos = document.querySelectorAll('.requisito-card').length;
                const finalRequisitosCompletos = document.querySelectorAll('.requisito-card .badge.bg-success').length;
                
                if (finalTotalRequisitos === finalRequisitosCompletos && uploadSuccess) {
                    handleSuccessCompletion();
                } else {
                    handleIncompleteState(finalRequisitosCompletos, finalTotalRequisitos);
                }
            });
        } else if (totalRequisitos === requisitosCompletos) {
            // All requirements already completed, proceed immediately
            handleSuccessCompletion();
        } else {
            // Requirements still missing
            handleIncompleteState(requisitosCompletos, totalRequisitos);
        }
    };
    
    // Configurar evento de cierre del modal
    const modal = document.getElementById('modalRequisitosFaltantes');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            console.log('🚪 Modal cerrado');
            if (callbackCancelacion) {
                callbackCancelacion();
            }
        });
    }
}

// Función para verificar que todas las funciones necesarias estén disponibles
window.verificarFuncionesRequisitos = function() {
    const funcionesNecesarias = [
        'mostrarModalRequisitosFaltantes',
        'llenarListaRequisitosFaltantes',
        'configurarEventListenersModal',
        'verificarTodosRequisitosCompletos',
        'subirArchivosSecuencialmente',
        'resetearEstadoModal',
        'cerrarModalRequisitos',
        'ejecutarCambioEtapa'
    ];
    
    const funcionesFaltantes = funcionesNecesarias.filter(func => typeof window[func] !== 'function');
    
    if (funcionesFaltantes.length > 0) {
        console.error('❌ Funciones faltantes:', funcionesFaltantes);
        return false;
    }
    
    console.log('✅ Todas las funciones de requisitos están disponibles');
    return true;
}

// Función de prueba para verificar el sistema completo
window.probarSistemaRequisitos = function() {
    console.log('🧪 Probando sistema de requisitos faltantes...');
    
    // Verificar funciones
    const funcionesOk = window.verificarFuncionesRequisitos();
    if (!funcionesOk) {
        console.error('❌ Falló la verificación de funciones');
        return false;
    }
    
    // Verificar modal
    const modalElement = document.getElementById('modalRequisitosFaltantes');
    if (!modalElement) {
        console.error('❌ Modal no encontrado');
        return false;
    }
    
    // Verificar elementos del modal
    const elementosNecesarios = [
        'listaRequisitosFaltantes',
        'btnValidarYContinuar',
        'etapaDestinoNombre',
        'loadingRequisitos'
    ];
    
    const elementosFaltantes = elementosNecesarios.filter(id => !document.getElementById(id));
    if (elementosFaltantes.length > 0) {
        console.error('❌ Elementos del modal faltantes:', elementosFaltantes);
        return false;
    }
    
    console.log('✅ Sistema de requisitos funcionando correctamente');
    console.log('💡 Para probar el modal, usa: window.mostrarModalRequisitosFaltantes(solicitudId, etapaId, "Nombre Etapa", callback)');
    return true;
}

// Función unificada para ejecutar el cambio de etapa (funciona para tabla y kanban)
window.ejecutarCambioEtapa = function(solicitudId, nuevaEtapaId, etapaActual, $select, subestadoSeleccionado = null, esKanban = false, etapaNombre = null) {
    console.log('🔄 Ejecutando cambio de etapa:', { solicitudId, nuevaEtapaId, etapaActual, subestadoSeleccionado, esKanban, etapaNombre });
    
    // Deshabilitar select mientras se procesa (solo para tabla)
    if ($select && !esKanban) {
        $select.prop('disabled', true);
    }
    
    // Preparar datos de la petición
    const requestData = {
        etapa_id: nuevaEtapaId
    };
    
    // Agregar subestado si se seleccionó uno
    if (subestadoSeleccionado) {
        requestData.subestado_id = subestadoSeleccionado;
        console.log('🔍 Incluyendo subestado en la petición:', subestadoSeleccionado);
    }
    
    // Realizar petición AJAX
    fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Respuesta del servidor:', data);
        if (data.success) {
            // Actualizar data attribute (solo para tabla)
            if ($select && !esKanban) {
                $select.data('etapa-actual', nuevaEtapaId);
            }
            
            // Mostrar mensaje de éxito
            if (typeof showToast !== 'undefined') {
                showToast(data.mensaje || 'Etapa cambiada exitosamente', 'success', 4000);
            } else {
                alert(data.mensaje || 'Etapa cambiada exitosamente');
            }
            
            if (esKanban) {
                // Para Kanban: actualizar UI dinámicamente
                console.log('🔄 Actualizando Kanban dinámicamente...');
                actualizarKanbanTrasMovimiento(solicitudId, nuevaEtapaId, etapaNombre);
            } else {
                // Para tabla: recargar página
                setTimeout(function() {
                    location.reload();
                }, 1000);
            }
        } else {
            // Manejar errores específicos
            if (data.tipo_error === 'transicion_invalida') {
                if (typeof showToast !== 'undefined') {
                    showToast('Transición no válida: ' + data.mensaje, 'error', 6000);
                } else {
                    alert('Transición no válida: ' + data.mensaje);
                }
            } else if (data.tipo_error === 'requisitos_faltantes') {
                if (typeof showToast !== 'undefined') {
                    showToast('Requisitos faltantes: ' + data.mensaje, 'warning', 6000);
                } else {
                    alert('Requisitos faltantes: ' + data.mensaje);
                }
            } else {
                if (typeof showToast !== 'undefined') {
                    showToast('Error: ' + data.error, 'error', 6000);
                } else {
                    alert('Error: ' + data.error);
                }
            }
            
            // Revertir selección
            if ($select && !esKanban) {
                $select.val(etapaActual);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (typeof showToast !== 'undefined') {
            showToast('Error al cambiar etapa', 'error', 6000);
        } else {
            alert('Error al cambiar etapa');
        }
        
        // Revertir selección
        if ($select && !esKanban) {
            $select.val(etapaActual);
        }
    })
    .finally(() => {
        // Habilitar select (solo para tabla)
        if ($select && !esKanban) {
            $select.prop('disabled', false);
        }
    });
}

})(); // Close IIFE

// Fallback: Asegurar que el drag and drop se inicialice si no se hizo antes
setTimeout(function() {
    if ($('.kanban-board').length > 0 && $('.kanban-card').length > 0) {
        console.log('Fallback: Verificando drag and drop...');
        if (!$('.kanban-card').data('drag-initialized')) {
            console.log('Fallback: Inicializando drag and drop...');
            inicializarDragAndDrop();
            $('.kanban-card').data('drag-initialized', true);
        }
    }
}, 1000);
</script>



{% endblock %} 