{% extends 'workflow/base.html' %}
{% load static %}
{% load workflow_filters %}

{% block title %}Negocios - Sistema de Workflow{% endblock %}

{% block content %}
<div class="fade-in-up">
        <!-- Header con Cinta -->
    <div class="card card-custom mb-4">
        <div class="card-header-custom" style="background: var(--verde-pacifico); padding: 20px; border-radius: 12px;">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="ribbon-content mb-2 mb-md-0">
                    <h1 class="h2 mb-1 text-white fw-bold">
                        <i class="fas fa-briefcase me-2"></i>
                        Negocios
                    </h1>
                    <p class="text-white-50 mb-0">Gestiona todas las solicitudes de tus pipelines</p>
                </div>
                <div class="ribbon-actions d-flex gap-2 align-items-center flex-shrink-0">
                    <a href="{% url 'workflow:nueva_solicitud' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-plus me-2"></i>Nueva Solicitud
                    </a>
                    <a href="{% url 'workflow:dashboard' %}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>



    {% if pipeline %}
        <!-- Información del Pipeline Mejorada -->
    <div class="card card-custom mb-4" id="kpis-section">
        <div class="card-body">
            <div class="row align-items-start mb-4">
                <div class="col-md-8">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h4 class="mb-2 fw-bold" style="color: var(--verde-pacifico);">
                                <i class="fas fa-project-diagram me-2"></i>
                                {{ pipeline.nombre }}
                            </h4>
                        </div>
                        <!-- Toggle KPIs para todas las pantallas -->
                        <button class="btn btn-sm btn-outline-success toggle-btn ms-3" onclick="toggleSection('kpis-section')" id="toggle-kpis">
                            <i class="fas fa-chart-bar me-1"></i>
                            <span class="toggle-text">Ocultar KPIs</span>
                        </button>
                    </div>
                    <p class="text-muted mb-0 fs-6">{{ pipeline.descripcion|default:"Sin descripción" }}</p>
                </div>
            </div>
            
            <!-- KPIs Mejorados - Contenido colapsable -->
            <div class="kpis-content">
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <div class="kpi-card kpi-total">
                            <div class="kpi-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="kpi-content">
                                <p class="kpi-label">Total Solicitudes</p>
                                <h3 class="kpi-number">{{ page_obj.paginator.count }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="kpi-card kpi-activas">
                            <div class="kpi-icon">
                                <i class="fas fa-play-circle"></i>
                            </div>
                            <div class="kpi-content">
                                <p class="kpi-label">Activas</p>
                                <h3 class="kpi-number">{{ solicitudes|filter_activas|length }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="kpi-card kpi-completadas">
                            <div class="kpi-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="kpi-content">
                                <p class="kpi-label">Completadas</p>
                                <h3 class="kpi-number">{{ solicitudes|filter_completadas|length }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="kpi-card kpi-vencidas">
                            <div class="kpi-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="kpi-content">
                                <p class="kpi-label">Vencidas</p>
                                <h3 class="kpi-number">{{ solicitudes|filter_vencidas|length }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if view_type == 'table' %}
    <!-- Filtros de Solicitudes -->
    <div class="card card-custom mb-4" id="filters-section">
        <div class="card-header-custom d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>
                Filtros de Solicitudes
            </h5>
            <div class="d-flex gap-2 align-items-center">
                <!-- Toggle Filtros para todas las pantallas -->
                <button class="btn btn-sm btn-outline-success toggle-btn" onclick="toggleSection('filters-section')" id="toggle-filters">
                    <i class="fas fa-filter me-1"></i>
                    <span class="toggle-text">Ocultar Filtros</span>
                </button>
                <button type="submit" form="filtrosForm" class="btn btn-light btn-sm">
                    <i class="fas fa-search me-1"></i>Aplicar Filtros
                </button>
                <a href="?pipeline={{ pipeline.id }}&view=table" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-times me-1"></i>Limpiar Filtros
                </a>
            </div>
        </div>
        <div class="card-body">
            <!-- Contenido de filtros colapsable -->
            <div class="filters-content">
                <form method="GET" id="filtrosForm" class="row g-3 align-items-end">
                    <input type="hidden" name="pipeline" value="{{ pipeline.id }}">
                    <input type="hidden" name="view" value="table">
                    
                    <div class="col-md-2">
                        <label for="estado" class="form-label fw-semibold">Estado</label>
                        <select name="estado" id="estado" class="form-select form-control-custom {% if request.GET.estado %}filtro-activo{% endif %}">
                            <option value="">Todos los estados</option>
                            <option value="activas" {% if request.GET.estado == 'activas' %}selected{% endif %}>Activas</option>
                            <option value="completadas" {% if request.GET.estado == 'completadas' %}selected{% endif %}>Completadas</option>
                            <option value="vencidas" {% if request.GET.estado == 'vencidas' %}selected{% endif %}>Vencidas</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="asignado" class="form-label fw-semibold">Asignación</label>
                        <select name="asignado" id="asignado" class="form-select form-control-custom {% if request.GET.asignado %}filtro-activo{% endif %}">
                            <option value="">Todas las asignaciones</option>
                            <option value="asignadas" {% if request.GET.asignado == 'asignadas' %}selected{% endif %}>Asignadas</option>
                            <option value="sin_asignar" {% if request.GET.asignado == 'sin_asignar' %}selected{% endif %}>Sin Asignar</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="fecha" class="form-label fw-semibold">Fecha</label>
                        <select name="fecha" id="fecha" class="form-select form-control-custom {% if request.GET.fecha %}filtro-activo{% endif %}">
                            <option value="">Todas las fechas</option>
                            <option value="hoy" {% if request.GET.fecha == 'hoy' %}selected{% endif %}>Hoy</option>
                            <option value="semana" {% if request.GET.fecha == 'semana' %}selected{% endif %}>Esta Semana</option>
                            <option value="mes" {% if request.GET.fecha == 'mes' %}selected{% endif %}>Este Mes</option>
                        </select>
                            </div>
                    
                    <div class="col-md-2">
                        <label for="sla" class="form-label fw-semibold">SLA</label>
                        <select name="sla" id="sla" class="form-select form-control-custom {% if request.GET.sla %}filtro-activo{% endif %}">
                            <option value="">Todos los SLAs</option>
                            <option value="vencido" {% if request.GET.sla == 'vencido' %}selected{% endif %}>Vencido</option>
                            <option value="proximo" {% if request.GET.sla == 'proximo' %}selected{% endif %}>Próximo a vencer</option>
                            <option value="ok" {% if request.GET.sla == 'ok' %}selected{% endif %}>En tiempo</option>
                        </select>
                        </div>
                    
                    <div class="col-md-2">
                        <label for="prioridad" class="form-label fw-semibold">Prioridad</label>
                        <select name="prioridad" id="prioridad" class="form-select form-control-custom {% if request.GET.prioridad %}filtro-activo{% endif %}">
                            <option value="">Todas las prioridades</option>
                            <option value="alta" {% if request.GET.prioridad == 'alta' %}selected{% endif %}>Alta</option>
                            <option value="media" {% if request.GET.prioridad == 'media' %}selected{% endif %}>Media</option>
                            <option value="baja" {% if request.GET.prioridad == 'baja' %}selected{% endif %}>Baja</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="ordenar" class="form-label fw-semibold">Ordenar por</label>
                        <select name="ordenar" id="ordenar" class="form-select form-control-custom {% if request.GET.ordenar %}filtro-activo{% endif %}">
                            <option value="fecha_creacion" {% if request.GET.ordenar == 'fecha_creacion' %}selected{% endif %}>Fecha Creación</option>
                            <option value="fecha_ultima_actualizacion" {% if request.GET.ordenar == 'fecha_ultima_actualizacion' %}selected{% endif %}>Última Actualización</option>
                            <option value="codigo" {% if request.GET.ordenar == 'codigo' %}selected{% endif %}>Código</option>
                            <option value="etapa" {% if request.GET.ordenar == 'etapa' %}selected{% endif %}>Etapa</option>
                        </select>
                </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Leyenda de colores de SLA Mejorada -->
    <div class="sla-legend-card mb-4">
        <div class="sla-legend-header">
            <i class="fas fa-info-circle me-2"></i>
            <span>Leyenda de Estados SLA</span>
        </div>
        <div class="sla-legend-items">
            <div class="sla-legend-item sla-success">
                <div class="sla-dot"></div>
                <span>En tiempo</span>
            </div>
            <div class="sla-legend-item sla-warning">
                <div class="sla-dot"></div>
                <span>Por vencer</span>
            </div>
            <div class="sla-legend-item sla-danger">
                <div class="sla-dot"></div>
                <span>Vencido</span>
            </div>
        </div>
    </div>

    <!-- Vista Móvil Mejorada: Solo visible en pantallas pequeñas -->
    <div class="vista-movil d-block d-sm-none">
        <!-- Barra de búsqueda móvil -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4 border">
            <div class="relative">
                <input type="text" id="busquedaMovil" 
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                       placeholder="Buscar por código, cliente o cédula...">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Tarjetas de solicitudes -->
        <div class="space-y-4" id="solicitudesMovil">
            {% for s in solicitudes_tabla %}
                <div class="solicitud-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow duration-200" 
                     data-prioridad="{{ s.prioridad|lower }}" 
                     data-estado="{{ s.sla_color }}"
                     data-asignado="{% if s.asignado_a == 'Sin asignar' %}sin_asignar{% else %}asignado{% endif %}"
                     data-search="{{ s.codigo|lower }} {{ s.cliente|lower }} {{ s.cedula|lower }}">
                    
                    <!-- Header de la tarjeta -->
                    <div class="p-4 pb-3">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <!-- Indicador de SLA -->
                                <div class="w-3 h-3 rounded-full 
                                    {% if s.sla_color == 'text-danger' %}bg-red-500
                                    {% elif s.sla_color == 'text-warning' %}bg-yellow-500
                                    {% elif s.sla_color == 'text-success' %}bg-green-500
                                    {% else %}bg-gray-400{% endif %}">
                                </div>
                                <h3 class="text-lg font-bold text-gray-900">{{ s.codigo }}</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- Badge de prioridad -->
                                {% if s.prioridad %}
                                <span class="px-2 py-1 rounded-full text-xs font-semibold
                                    {% if s.prioridad == 'Alta' %}bg-red-100 text-red-800
                                    {% elif s.prioridad == 'Media' %}bg-yellow-100 text-yellow-800
                                    {% elif s.prioridad == 'Baja' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ s.prioridad }}
                                </span>
                                {% endif %}
                                <!-- Menú de opciones -->
                                <div class="relative">
                                    <button class="p-1 rounded-full hover:bg-gray-100 transition-colors" onclick="toggleMenu(this)">
                                        <i class="fas fa-ellipsis-v text-gray-400"></i>
                                    </button>
                                    <div class="menu-dropdown absolute right-0 top-8 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10 hidden min-w-40">
                                        <a href="{% url 'workflow:detalle_solicitud' s.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            <i class="fas fa-eye mr-2"></i>Ver Detalle
                                        </a>
                                        <a href="{% url 'workflow:transicion_solicitud' s.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            <i class="fas fa-arrow-right mr-2"></i>Cambiar Etapa
                                        </a>
                                        {% if s.acciones.eliminar %}
                                        <button onclick="eliminarSolicitud({{ s.id }})" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                            <i class="fas fa-trash mr-2"></i>Eliminar
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Información principal -->
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Cliente</p>
                                <p class="text-sm font-semibold text-gray-900 truncate">{{ s.cliente }}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Monto</p>
                                <p class="text-sm font-bold text-green-600">{{ s.monto }}</p>
                            </div>
                        </div>

                        <!-- Información secundaria -->
                        <div class="space-y-2 mb-3">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Cédula:</span>
                                <span class="text-gray-900 font-medium">{{ s.cedula }}</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Producto:</span>
                                <span class="text-gray-900 font-medium truncate ml-2">{{ s.producto }}</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Propietario:</span>
                                <span class="text-gray-900 font-medium truncate ml-2">{{ s.propietario }}</span>
                            </div>
                        </div>

                        <!-- Asignación -->
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs text-gray-500 uppercase tracking-wide font-medium">Asignado a</span>
                            {% if s.asignado_a != 'Sin asignar' %}
                                <div class="flex items-center space-x-2">
                                    <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-blue-600 text-xs"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-900 truncate">{{ s.asignado_a }}</span>
                                </div>
                            {% else %}
                                <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">
                                    <i class="fas fa-user-slash mr-1"></i>Sin asignar
                                </span>
                            {% endif %}
                        </div>

                        <!-- Etapa y Estado -->
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Etapa</p>
                                {% if s.etapa %}
                                <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                    {{ s.etapa }}
                                </span>
                                {% endif %}
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium">Estado</p>
                                <span class="inline-block px-2 py-1 bg-{{ s.estado_color }} text-white rounded-full text-xs font-medium">
                                    {{ s.estado_actual }}
                                </span>
                            </div>
                        </div>

                        <!-- Etiquetas -->
                        {% if s.etiquetas_oficial %}
                        <div class="mb-3">
                            <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Etiquetas</p>
                            <span class="inline-block px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                                {{ s.etiquetas_oficial }}
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Footer con SLA y fechas -->
                    <div class="px-4 py-3 bg-gray-50 border-t border-gray-100">
                        <div class="flex items-center justify-between text-xs">
                            <div class="flex items-center space-x-4">
                                <div>
                                    <span class="text-gray-500">Creado:</span>
                                    <span class="text-gray-900 font-medium">{{ s.fecha_inicio }}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">SLA:</span>
                                    <span class="font-medium {{ s.sla_color }}">{{ s.sla_restante }}</span>
                                </div>
                            </div>
                            {% for alerta in s.alertas %}
                                <i class="fas {{ alerta.icon }} text-{{ alerta.color }}" title="{{ alerta.tooltip }}"></i>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="p-4 pt-3 bg-gray-50">
                        <div class="flex space-x-2">
                            <a href="{% url 'workflow:detalle_solicitud' s.id %}" 
                               class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-eye mr-1"></i>Ver
                            </a>
                            <a href="{% url 'workflow:transicion_solicitud' s.id %}" 
                               class="flex-1 bg-gray-600 hover:bg-gray-700 text-white text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-arrow-right mr-1"></i>Etapa
                            </a>
                            {% if s.acciones.eliminar %}
                            <button onclick="eliminarSolicitud({{ s.id }})" 
                                    class="bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-inbox text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No hay solicitudes</h3>
                    <p class="text-gray-500">No se encontraron solicitudes que coincidan con los filtros aplicados.</p>
                </div>
            {% endfor %}
        </div>

        <!-- Paginación móvil -->
        {% if page_obj.has_other_pages %}
        <div class="mt-6 flex justify-center">
            <nav class="flex items-center space-x-1">
                {% if page_obj.has_previous %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {% endif %}
                
                <span class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-gray-300">
                    {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </div>

    <!-- Tabla Desktop: Solo visible en pantallas medianas y grandes -->
    <div class="vista-desktop d-none d-sm-block">
        <!-- Vista Tabla Mejorada -->
        <div class="card card-custom">
            <div class="card-header-custom d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Solicitudes en Tabla
                </h5>
                <div class="d-flex gap-2 align-items-center">
                    <div class="d-flex align-items-center">
                        <label for="busquedaTabla" class="form-label mb-0 me-2 small fw-semibold text-white">Buscar:</label>
                        <input type="text" id="busquedaTabla" class="form-control form-control-sm" 
                               placeholder="Código, cliente, usuario..." 
                               style="width: 250px;"
                               value="{{ filtros.busqueda }}">
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-success" id="exportarExcel" title="Exportar a Excel">
                        <i class="fas fa-file-excel"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover workflow-table" id="tablaSolicitudes">
                        <thead class="table-light">
                            <tr>
                                <th class="fw-bold">Nº</th>
                                <th class="fw-bold">Cliente</th>
                                <th class="fw-bold">Cédula</th>
                                <th class="fw-bold">Producto</th>
                                <th class="fw-bold">Monto Solicitado</th>
                                <th class="fw-bold">Propietario</th>
                                <th class="fw-bold">Asignado a</th>
                                <th class="fw-bold">Etapa</th>
                                <th class="fw-bold">Estado Actual</th>
                                <th class="fw-bold">Fecha Inicio</th>
                                <th class="fw-bold">Vencimiento de SLA</th>
                                <th class="fw-bold">SLA Restante</th>
                                <th class="fw-bold">Alertas</th>
                                <th class="fw-bold">Etiquetas Oficial</th>
                                <th class="fw-bold">Prioridad</th>
                                <th class="fw-bold">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in solicitudes_tabla %}
                            <tr class="align-middle table-row-hover {% if s.sla_color == 'text-danger' %}bg-danger bg-opacity-10{% endif %}">
                                <td class="text-dark">
                                    {% if s.sla_color == 'text-danger' %}
                                        <span class="me-1" title="Vencido"><i class="fas fa-circle text-danger"></i></span>
                                    {% elif s.sla_color == 'text-warning' %}
                                        <span class="me-1" title="Por vencer"><i class="fas fa-circle text-warning"></i></span>
                                    {% elif s.sla_color == 'text-success' %}
                                        <span class="me-1" title="En tiempo"><i class="fas fa-circle text-success"></i></span>
                                    {% endif %}
                                    {{ s.codigo }}
                                </td>
                                <td class="text-dark">{{ s.cliente }}</td>
                                <td class="text-dark">{{ s.cedula }}</td>
                                <td class="text-dark">{{ s.producto }}</td>
                                <td><span class="fw-bold text-success">{{ s.monto }}</span></td>
                                <td class="text-dark"><i class="fas fa-user me-1 text-muted"></i> {{ s.propietario }}</td>
                                <td>
                                    {% if s.asignado_a != 'Sin asignar' %}
                                        <i class="fas fa-user me-1 text-success"></i> <span class="text-dark">{{ s.asignado_a }}</span>
                                    {% else %}
                                        <i class="fas fa-user-slash me-1 text-muted"></i> <span class="text-muted">{{ s.asignado_a }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if s.etapa %}
                                    <span class="badge {{ s.etapa_color }} bg-opacity-25 text-dark text-start" style="text-align: left;">
                                        {{ s.etapa|break_words|safe }}
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ s.estado_color }}">{{ s.estado_actual }}</span>
                                </td>
                                <td class="text-dark">{{ s.fecha_inicio }}</td>
                                <td class="text-dark">{{ s.vencimiento_sla }}</td>
                                <td>
                                    <div class="text-center">
                                        <div class="{{ s.sla_color }} fw-bold" title="Tiempo restante para cumplir el SLA">
                                            {{ s.sla_restante }}
                                        </div>
                                        <div class="mt-1">
                                            {% if s.sla_color == 'text-success' %}
                                                <span class="text-success fw-semibold" style="font-size: 0.9rem;">En tiempo</span>
                                            {% elif s.sla_color == 'text-warning' %}
                                                <span class="text-warning fw-semibold" style="font-size: 0.9rem;">Por vencer</span>
                                            {% elif s.sla_color == 'text-danger' %}
                                                <span class="text-danger fw-semibold" style="font-size: 0.9rem;">Vencido</span>
                                            {% else %}
                                                <span class="text-secondary fw-semibold" style="font-size: 0.9rem;">N/A</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% for alerta in s.alertas %}
                                    <i class="fas {{ alerta.icon }} text-{{ alerta.color }}" title="{{ alerta.tooltip }}"></i>
                                    {% endfor %}
                                </td>
                                <td>
                                    <!-- Campo desplegable de etiquetas -->
                                    <select class="etiquetas-select form-control form-control-sm" 
                                            data-id="{{ s.id }}" 
                                            style="min-width: 180px;">
                                        <option value="">Seleccionar etiqueta</option>
                                        <option value="no_responde" {% if s.etiquetas_oficial == 'no_responde' %}selected{% endif %}>📞 No responde</option>
                                        <option value="cita_agendada" {% if s.etiquetas_oficial == 'cita_agendada' %}selected{% endif %}>🗓️ Cita agendada</option>
                                        <option value="doc_completo" {% if s.etiquetas_oficial == 'doc_completo' %}selected{% endif %}>✅ Documentos completos</option>
                                        <option value="falta_carta" {% if s.etiquetas_oficial == 'falta_carta' %}selected{% endif %}>📎 Falta carta trabajo</option>
                                        <option value="seguimiento_48h" {% if s.etiquetas_oficial == 'seguimiento_48h' %}selected{% endif %}>🔄 Seguimiento en 48h</option>
                                        <option value="whatsapp_activo" {% if s.etiquetas_oficial == 'whatsapp_activo' %}selected{% endif %}>💬 WhatsApp activo</option>
                                        <option value="cliente_indeciso" {% if s.etiquetas_oficial == 'cliente_indeciso' %}selected{% endif %}>⚠️ Cliente indeciso</option>
                                        <option value="cliente_caliente" {% if s.etiquetas_oficial == 'cliente_caliente' %}selected{% endif %}>🚀 Cliente caliente</option>
                                        <option value="esperando_confirm" {% if s.etiquetas_oficial == 'esperando_confirm' %}selected{% endif %}>🕐 Esperando confirmación</option>
                                        <option value="enviado_credito" {% if s.etiquetas_oficial == 'enviado_credito' %}selected{% endif %}>🧾 Enviado a crédito</option>
                                        <option value="en_validacion" {% if s.etiquetas_oficial == 'en_validacion' %}selected{% endif %}>🔒 En validación</option>
                                        <option value="caso_descartado" {% if s.etiquetas_oficial == 'caso_descartado' %}selected{% endif %}>❌ Caso descartado</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="prioridad-select border rounded px-2 py-1 text-xs w-full"
                                            data-id="{{ s.id }}"
                                            style="background-color:
                                              {% if s.prioridad == 'Alta' %}#fee2e2
                                              {% elif s.prioridad == 'Media' %}#fef9c3
                                              {% elif s.prioridad == 'Baja' %}#dcfce7
                                              {% else %}white{% endif %};
                                              color:
                                              {% if s.prioridad == 'Alta' %}#b91c1c
                                              {% elif s.prioridad == 'Media' %}#b45309
                                              {% elif s.prioridad == 'Baja' %}#166534
                                              {% else %}#333{% endif %};">
                                      <option value="">-</option>
                                      {% for prioridad in prioridades_posibles %}
                                        <option value="{{ prioridad }}" {% if s.prioridad == prioridad %}selected{% endif %}>{{ prioridad }}</option>
                                      {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if s.acciones.ver %}
                                        <a href="{% url 'workflow:detalle_solicitud' s.id %}" class="btn btn-outline-pacifico" title="Ver Detalle">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% endif %}
                                        {% if s.acciones.cambiar_etapa %}
                                        <a href="{% url 'workflow:transicion_solicitud' s.id %}" class="btn btn-outline-secondary" title="Cambiar Etapa">
                                            <i class="fas fa-arrow-right"></i>
                                        </a>
                                        {% endif %}
                                        {% if s.acciones.exportar %}
                                        <a href="#" class="btn btn-outline-success" title="Exportar">
                                            <i class="fas fa-upload"></i>
                                        </a>
                                        {% endif %}
                                        {% if s.acciones.eliminar %}
                                        <button type="button" class="btn btn-outline-danger" title="Eliminar" onclick="eliminarSolicitud({{ s.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="14" class="text-center py-4">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No hay solicitudes para mostrar</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- Paginación -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Paginación de solicitudes" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Anterior</a>
                        </li>
                        {% endif %}
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Siguiente</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>

    {% else %}
    <!-- Vista Kanban -->
    <div class="kanban-container">
        <div class="row">
            {% for etapa in etapas_kanban %}
            <div class="col-md-3 mb-4">
                <div class="card card-custom h-100">
                    <div class="card-header-custom">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            {{ etapa.nombre }}
                            <span class="badge badge-pacifico float-end">{{ solicitudes_por_etapa|get_etapa_count:etapa }}</span>
                        </h6>
                    </div>
                    <div class="card-body kanban-column">
                        {% for solicitud in solicitudes_por_etapa|get_etapa_solicitudes:etapa %}
                        <div class="kanban-card mb-3" draggable="true" data-solicitud-id="{{ solicitud.id }}">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0">
                                            <a href="{% url 'workflow:detalle_solicitud' solicitud.id %}" class="text-decoration-none">
                                                {{ solicitud.codigo }}
                                            </a>
                                        </h6>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{% url 'workflow:detalle_solicitud' solicitud.id %}">
                                                    <i class="fas fa-eye me-2"></i>Ver Detalle
                                                </a></li>
                                                {% if not solicitud.asignada_a %}
                                                <li><a class="dropdown-item" href="{% url 'workflow:auto_asignar_solicitud' solicitud.id %}">
                                                    <i class="fas fa-user-plus me-2"></i>Auto Asignar
                                                </a></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <small class="text-muted">Creado por:</small><br>
                                        <span class="small">{{ solicitud.creada_por.get_full_name|default:solicitud.creada_por.username }}</span>
                                    </div>
                                    
                                    {% if solicitud.asignada_a %}
                                    <div class="mb-2">
                                        <small class="text-muted">Asignado a:</small><br>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-1">
                                                <img src="{{ solicitud.asignada_a.profile.avatar.url|default:'/static/images/default-avatar.png' }}" 
                                                     class="rounded-circle" width="16" height="16" alt="Avatar">
                                            </div>
                                            <span class="small">{{ solicitud.asignada_a.get_full_name|default:solicitud.asignada_a.username }}</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">{{ solicitud.fecha_creacion|date:"d/m/Y" }}</small>
                                        {% if solicitud|is_vencida %}
                                        <span class="badge bg-danger">Vencida</span>
                                        {% else %}
                                        <span class="badge bg-success">En Proceso</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox text-muted mb-2"></i>
                            <p class="text-muted small">Sin solicitudes</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Columna de Completadas -->
            {% if solicitudes_por_etapa.completadas %}
            <div class="col-md-3 mb-4">
                <div class="card card-custom h-100">
                    <div class="card-header-custom">
                        <h6 class="mb-0">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            Completadas
                            <span class="badge bg-success float-end">{{ solicitudes_por_etapa.completadas.count }}</span>
                        </h6>
                    </div>
                    <div class="card-body kanban-column">
                        {% for solicitud in solicitudes_por_etapa.completadas %}
                        <div class="kanban-card mb-3" draggable="true" data-solicitud-id="{{ solicitud.id }}">
                            <div class="card border-success">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0">
                                            <a href="{% url 'workflow:detalle_solicitud' solicitud.id %}" class="text-decoration-none">
                                                {{ solicitud.codigo }}
                                            </a>
                                        </h6>
                                        <span class="badge bg-success">Completada</span>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <small class="text-muted">Creado por:</small><br>
                                        <span class="small">{{ solicitud.creada_por.get_full_name|default:solicitud.creada_por.username }}</span>
                                    </div>
                                    
                                    <small class="text-muted">{{ solicitud.fecha_creacion|date:"d/m/Y" }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Selección de Pipeline -->
    <div class="row">
        {% for pipeline in pipelines %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card card-custom h-100">
                <div class="card-header-custom">
                    <h5 class="mb-0">{{ pipeline.nombre }}</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">{{ pipeline.descripcion|default:"Sin descripción" }}</p>
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="bg-success bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-success">{{ pipeline.solicitud_set.count }}</h6>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-info bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-info">{{ pipeline.etapas.count }}</h6>
                                <small class="text-muted">Etapas</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-warning bg-opacity-10 rounded p-2">
                                <h6 class="mb-0 text-warning">{{ pipeline.requisitos_pipeline.count }}</h6>
                                <small class="text-muted">Requisitos</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="?pipeline={{ pipeline.id }}&view=table" class="btn btn-pacifico">
                            <i class="fas fa-table me-2"></i>Ver en Tabla
                        </a>
                        <a href="?pipeline={{ pipeline.id }}&view=kanban" class="btn btn-outline-pacifico">
                            <i class="fas fa-columns me-2"></i>Ver en Kanban
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-project-diagram fa-4x text-muted mb-3"></i>
                <h4 class="text-muted mb-3">No hay pipelines disponibles</h4>
                <p class="text-muted mb-4">Crea un pipeline para comenzar a gestionar solicitudes.</p>
                <a href="{% url 'workflow:admin_pipelines' %}" class="btn btn-pacifico">
                    <i class="fas fa-plus me-2"></i>Crear Pipeline
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables CSS y JS desde CDN -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/colresize/1.0.0/dataTables.colResize.css">
<link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/colresize/1.0.0/dataTables.colResize.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar DataTable con configuración optimizada
    var table = $('#tablaSolicitudes').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        colResize: true,
        scrollX: true,
        scrollCollapse: true,
        fixedColumns: {
            left: 1,
            heightMatch: 'auto'
        },
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json',
            search: 'Buscar:',
            lengthMenu: 'Mostrar _MENU_ registros',
            info: 'Mostrando _START_ a _END_ de _TOTAL_ registros',
            paginate: {
                previous: 'Anterior',
                next: 'Siguiente'
            }
        },
        columnDefs: [
            { orderable: false, targets: -1 },
            { orderable: false, targets: -2 },
            { width: '80px', targets: 0 }, // Columna Nº
            { width: '120px', targets: 1 }, // Cliente
            { width: '100px', targets: 2 }, // Cédula
            { width: '120px', targets: 3 }, // Producto
            { width: '130px', targets: 4 }, // Monto
            { width: '120px', targets: 5 }, // Propietario
            { width: '180px', targets: 6 }, // Asignado a
            { width: '100px', targets: 7 }, // Etapa
            { width: '100px', targets: 8 }, // Estado
            { width: '100px', targets: 9 }, // Fecha Inicio
            { width: '130px', targets: 10 }, // Vencimiento SLA
            { width: '100px', targets: 11 }, // SLA Restante
            { width: '80px', targets: 12 }, // Alertas
            { width: '150px', targets: 13 }, // Acciones
        ],
        autoWidth: false,
        pageLength: 25,
        responsive: false,
        deferRender: true,
        processing: true
    });

    // Mover controles abajo
    var wrapper = $('.dataTables_wrapper');
    var length = wrapper.find('.dataTables_length');
    var paginate = wrapper.find('.dataTables_paginate');
    if (length.length && paginate.length && wrapper.find('.dt-bottom-controls').length === 0) {
        var bottomControls = $('<div class="dt-bottom-controls"></div>');
        length.appendTo(bottomControls);
        paginate.appendTo(bottomControls);
        wrapper.append(bottomControls);
    }

    // Ajustar altura de la columna fija después de la inicialización
    table.fixedColumns().relayout();
    
    // Debug ColResize
    console.log('ColResize:', typeof $.fn.dataTable.ColResize);
    console.log('FixedColumns:', typeof $.fn.dataTable.FixedColumns);
    
    // Debug: Verificar datos de asignación
    console.log('Datos de la tabla:', {{ solicitudes_tabla|safe }});
    
    // Verificar cada fila para asignación
    $('#tablaSolicitudes tbody tr').each(function(index) {
        var asignado = $(this).find('td:eq(6)').text().trim();
        console.log('Fila', index + 1, 'Asignado a:', asignado);
    });
    
    // Función para aplicar búsqueda avanzada
    window.aplicarBusqueda = function() {
        var busqueda = $('#busqueda').val();
        var prioridad = $('#prioridad').val();
        
        // Construir URL con parámetros
        var url = new URL(window.location);
        if (busqueda) url.searchParams.set('busqueda', busqueda);
        if (prioridad) url.searchParams.set('prioridad', prioridad);
        
        // Mantener otros filtros existentes
        url.searchParams.set('pipeline', '{{ pipeline.id }}');
        url.searchParams.set('view', 'table');
        
        window.location.href = url.toString();
    };
    
    // Aplicar búsqueda al presionar Enter
    $('#busqueda').on('keypress', function(e) {
        if (e.which === 13) {
            aplicarBusqueda();
        }
    });
    
    // Búsqueda personalizada en DataTable
    $('#busquedaTabla').on('keyup', function() {
        table.search(this.value).draw();
    });
    
    // Limpiar búsqueda de DataTable
    $('#busquedaTabla').on('input', function() {
        if (this.value === '') {
            table.search('').draw();
        }
    });
    
    // Ocultar el buscador nativo de DataTables
    $('.dataTables_filter').hide();
    
    // Los filtros ahora funcionan con formularios HTML tradicionales
    // No se necesita JavaScript adicional para los filtros
    
    // Función para mostrar contador de resultados filtrados
    function mostrarContadorFiltrado(visibles, total) {
        // Crear o actualizar contador
        if ($('#contadorFiltrado').length) {
            $('#contadorFiltrado').remove();
        }
        
        if (visibles < total) {
            $('.card-header-custom h5').after('<small id="contadorFiltrado" class="text-white ms-2">(' + visibles + ' de ' + total + ' resultados)</small>');
        }
    }
    
    // Los filtros ahora funcionan con formularios HTML tradicionales
    // El botón "Limpiar Filtros" es un enlace que recarga la página sin filtros
});
</script>

<!-- Mantener estilos PACIFICO para badges y botones -->
<style>
/* Responsividad para vistas móvil y desktop */
.vista-movil {
    display: block !important;
}

.vista-desktop {
    display: none !important;
}

/* En pantallas pequeñas (sm y superiores - ≥576px) */
@media (min-width: 576px) {
    .vista-movil {
        display: none !important;
    }
    
    .vista-desktop {
        display: block !important;
    }
}

/* Estilos específicos para la vista móvil usando Tailwind-like classes pero con CSS tradicional */
.vista-movil .bg-white { background-color: white; }
.vista-movil .rounded-lg { border-radius: 0.5rem; }
.vista-movil .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
.vista-movil .border { border: 1px solid #e5e7eb; }
.vista-movil .p-4 { padding: 1rem; }
.vista-movil .mb-4 { margin-bottom: 1rem; }
.vista-movil .w-full { width: 100%; }
.vista-movil .pl-10 { padding-left: 2.5rem; }
.vista-movil .pr-4 { padding-right: 1rem; }
.vista-movil .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
.vista-movil .border-gray-300 { border-color: #d1d5db; }
.vista-movil .rounded-lg { border-radius: 0.5rem; }
.vista-movil .focus\:ring-2:focus { outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
.vista-movil .focus\:ring-blue-500:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
.vista-movil .focus\:border-transparent:focus { border-color: transparent; }
.vista-movil .absolute { position: absolute; }
.vista-movil .inset-y-0 { top: 0; bottom: 0; }
.vista-movil .left-0 { left: 0; }
.vista-movil .pl-3 { padding-left: 0.75rem; }
.vista-movil .flex { display: flex; }
.vista-movil .items-center { align-items: center; }
.vista-movil .text-gray-400 { color: #9ca3af; }
.vista-movil .gap-2 { gap: 0.5rem; }
.vista-movil .overflow-x-auto { overflow-x: auto; }
.vista-movil .pb-2 { padding-bottom: 0.5rem; }
.vista-movil .whitespace-nowrap { white-space: nowrap; }
.vista-movil .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
.vista-movil .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
.vista-movil .rounded-full { border-radius: 9999px; }
.vista-movil .text-xs { font-size: 0.75rem; line-height: 1rem; }
.vista-movil .font-medium { font-weight: 500; }
.vista-movil .bg-blue-100 { background-color: #dbeafe; }
.vista-movil .text-blue-800 { color: #1e40af; }
.vista-movil .border-blue-200 { border-color: #bfdbfe; }
.vista-movil .bg-gray-100 { background-color: #f3f4f6; }
.vista-movil .text-gray-700 { color: #374151; }
.vista-movil .border-gray-200 { border-color: #e5e7eb; }
.vista-movil .space-y-4 > * + * { margin-top: 1rem; }
.vista-movil .rounded-xl { border-radius: 0.75rem; }
.vista-movil .overflow-hidden { overflow: hidden; }
.vista-movil .hover\:shadow-md:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
.vista-movil .transition-shadow { transition-property: box-shadow; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
.vista-movil .duration-200 { transition-duration: 200ms; }
.vista-movil .pb-3 { padding-bottom: 0.75rem; }
.vista-movil .items-start { align-items: flex-start; }
.vista-movil .justify-between { justify-content: space-between; }
.vista-movil .mb-3 { margin-bottom: 0.75rem; }
.vista-movil .space-x-2 > * + * { margin-left: 0.5rem; }
.vista-movil .w-3 { width: 0.75rem; }
.vista-movil .h-3 { height: 0.75rem; }
.vista-movil .bg-red-500 { background-color: #ef4444; }
.vista-movil .bg-yellow-500 { background-color: #eab308; }
.vista-movil .bg-green-500 { background-color: #22c55e; }
.vista-movil .bg-gray-400 { background-color: #9ca3af; }
.vista-movil .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
.vista-movil .font-bold { font-weight: 700; }
.vista-movil .text-gray-900 { color: #111827; }
.vista-movil .font-semibold { font-weight: 600; }
.vista-movil .bg-red-100 { background-color: #fee2e2; }
.vista-movil .text-red-800 { color: #991b1b; }
.vista-movil .bg-yellow-100 { background-color: #fef3c7; }
.vista-movil .text-yellow-800 { color: #92400e; }
.vista-movil .bg-green-100 { background-color: #dcfce7; }
.vista-movil .text-green-800 { color: #166534; }
.vista-movil .bg-gray-800 { color: #1f2937; }
.vista-movil .relative { position: relative; }
.vista-movil .p-1 { padding: 0.25rem; }
.vista-movil .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
.vista-movil .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
.vista-movil .right-0 { right: 0; }
.vista-movil .top-8 { top: 2rem; }
.vista-movil .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
.vista-movil .z-10 { z-index: 10; }
.vista-movil .hidden { display: none; }
.vista-movil .min-w-40 { min-width: 10rem; }
.vista-movil .block { display: block; }
.vista-movil .px-4 { padding-left: 1rem; padding-right: 1rem; }
.vista-movil .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
.vista-movil .hover\:bg-gray-50:hover { background-color: #f9fafb; }
.vista-movil .w-full { width: 100%; }
.vista-movil .text-left { text-align: left; }
.vista-movil .text-red-600 { color: #dc2626; }
.vista-movil .hover\:bg-red-50:hover { background-color: #fef2f2; }
.vista-movil .grid { display: grid; }
.vista-movil .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
.vista-movil .gap-3 { gap: 0.75rem; }
.vista-movil .text-gray-500 { color: #6b7280; }
.vista-movil .uppercase { text-transform: uppercase; }
.vista-movil .tracking-wide { letter-spacing: 0.025em; }
.vista-movil .text-green-600 { color: #16a34a; }
.vista-movil .space-y-2 > * + * { margin-top: 0.5rem; }
.vista-movil .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.vista-movil .ml-2 { margin-left: 0.5rem; }
.vista-movil .w-6 { width: 1.5rem; }
.vista-movil .h-6 { height: 1.5rem; }
.vista-movil .text-blue-600 { color: #2563eb; }
.vista-movil .bg-orange-100 { background-color: #fed7aa; }
.vista-movil .text-orange-800 { color: #9a3412; }
.vista-movil .mr-1 { margin-right: 0.25rem; }
.vista-movil .inline-block { display: inline-block; }
.vista-movil .bg-purple-100 { background-color: #f3e8ff; }
.vista-movil .text-purple-800 { color: #6b21a8; }
.vista-movil .mb-1 { margin-bottom: 0.25rem; }
.vista-movil .bg-gray-50 { background-color: #f9fafb; }
.vista-movil .border-t { border-top-width: 1px; }
.vista-movil .border-gray-100 { border-color: #f3f4f6; }
.vista-movil .space-x-4 > * + * { margin-left: 1rem; }
.vista-movil .pt-3 { padding-top: 0.75rem; }
.vista-movil .text-center { text-align: center; }
.vista-movil .bg-blue-600 { background-color: #2563eb; }
.vista-movil .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
.vista-movil .text-white { color: white; }
.vista-movil .rounded-lg { border-radius: 0.5rem; }
.vista-movil .bg-gray-600 { background-color: #4b5563; }
.vista-movil .hover\:bg-gray-700:hover { background-color: #374151; }
.vista-movil .bg-red-600 { background-color: #dc2626; }
.vista-movil .hover\:bg-red-700:hover { background-color: #b91c1c; }
.vista-movil .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
.vista-movil .w-16 { width: 4rem; }
.vista-movil .h-16 { height: 4rem; }
.vista-movil .mx-auto { margin-left: auto; margin-right: auto; }
.vista-movil .text-2xl { font-size: 1.5rem; line-height: 2rem; }
.vista-movil .mb-2 { margin-bottom: 0.5rem; }
.vista-movil .mt-6 { margin-top: 1.5rem; }
.vista-movil .justify-center { justify-content: center; }
.vista-movil .space-x-1 > * + * { margin-left: 0.25rem; }
.vista-movil .rounded-l-md { border-top-left-radius: 0.375rem; border-bottom-left-radius: 0.375rem; }
.vista-movil .hover\:bg-gray-50:hover { background-color: #f9fafb; }
.vista-movil .border-t { border-top-width: 1px; }
.vista-movil .border-b { border-bottom-width: 1px; }
.vista-movil .rounded-r-md { border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem; }

/* Ocultar buscador nativo de DataTables */
.dataTables_filter {
    display: none !important;
}

/* === ESTILOS PARA KPIs MEJORADOS === */
.kpi-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    border: 1px solid rgba(0, 156, 60, 0.1);
    position: relative;
    transition: all 0.3s ease;
    height: 100%;
}

.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    border-color: rgba(0, 156, 60, 0.2);
}

.kpi-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    float: left;
    margin-right: 12px;
}

.kpi-content {
    overflow: hidden;
}

.kpi-label {
    font-size: 0.75rem;
    font-weight: 600;
    margin: 0 0 4px 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.7;
    line-height: 1;
}

.kpi-number {
    font-size: 1.5rem;
    font-weight: 800;
    margin: 0;
    line-height: 1;
}

/* Variantes de KPIs */
.kpi-total .kpi-icon {
    background: linear-gradient(135deg, #009c3c, #22a650);
    color: white;
}

.kpi-total .kpi-number {
    color: #009c3c;
}

.kpi-activas .kpi-icon {
    background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    color: white;
}

.kpi-activas .kpi-number {
    color: #0d6efd;
}

.kpi-completadas .kpi-icon {
    background: linear-gradient(135deg, #ffc107, #ffb84d);
    color: #000;
}

.kpi-completadas .kpi-number {
    color: #ffc107;
}

.kpi-vencidas .kpi-icon {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.kpi-vencidas .kpi-number {
    color: #dc3545;
}

/* === ESTILOS PARA LEYENDA SLA === */
.sla-legend-card {
    background: rgba(0, 156, 60, 0.02);
    border: 1px solid rgba(0, 156, 60, 0.1);
    border-radius: 12px;
    padding: 16px;
}

.sla-legend-header {
    display: flex;
    align-items: center;
    font-weight: 600;
    color: #009c3c;
    font-size: 0.875rem;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.sla-legend-items {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
}

.sla-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    font-weight: 500;
}

.sla-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    position: relative;
}

.sla-dot::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: white;
    opacity: 0.8;
}

.sla-success .sla-dot {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
}

.sla-warning .sla-dot {
    background: linear-gradient(135deg, #ffc107, #f59e0b);
    box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
}

.sla-danger .sla-dot {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

/* Responsive para KPIs */
@media (max-width: 768px) {
    .kpi-card {
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 8px;
    }
    
    .kpi-number {
        font-size: 1.25rem;
    }
    
    .kpi-label {
        font-size: 0.7rem;
    }
    
    .kpi-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
        margin-right: 8px;
    }
    
    .sla-legend-items {
        gap: 16px;
    }
}

/* Estilos para el buscador personalizado en el header */
#busquedaTabla {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

#busquedaTabla:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}
.dataTables_info {
    display: none !important;
}
/* Oculta solo el selector de cantidad de registros de la parte superior, pero no el de abajo */
.dataTables_wrapper > .dataTables_length:first-child {
    display: none !important;
}
.dataTables_length {
    float: none !important;
    display: inline-block !important;
    margin: 0 1rem 0 0 !important;
    vertical-align: middle;
}
.dataTables_wrapper .dt-bottom-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}

/* Estilos para columna fija */
.DTFC_LeftWrapper {
    background: #f8f9fa;
    border-right: 2px solid #dee2e6;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

.DTFC_LeftWrapper table {
    background: white;
}

.DTFC_LeftWrapper th,
.DTFC_LeftWrapper td {
    background: white !important;
    border-right: 1px solid #dee2e6;
}

/* Mejorar la separación visual */
.DTFC_LeftWrapper th:last-child,
.DTFC_LeftWrapper td:last-child {
    border-right: 2px solid #007bff;
}

/* Centrar encabezados de columnas */
#tablaSolicitudes thead th {
    text-align: center !important;
    vertical-align: middle !important;
    font-weight: 600 !important;
    background-color: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6 !important;
}

/* Centrar también los encabezados en la columna fija */
.DTFC_LeftWrapper thead th {
    text-align: center !important;
    vertical-align: middle !important;
    font-weight: 600 !important;
    background-color: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6 !important;
}

/* Mejorar la apariencia general de la tabla */
#tablaSolicitudes {
    border-collapse: collapse !important;
    width: 100% !important;
}

#tablaSolicitudes tbody tr:hover {
    background-color: #f8f9fa !important;
    transition: background-color 0.2s ease;
}

#tablaSolicitudes tbody td {
    vertical-align: middle !important;
    padding: 0.75rem 0.5rem !important;
    border-bottom: 1px solid #dee2e6 !important;
}

/* Estilos para la columna fija mejorados */
.DTFC_LeftWrapper {
    background: #f8f9fa !important;
    border-right: 3px solid #007bff !important;
    box-shadow: 3px 0 8px rgba(0,0,0,0.15) !important;
    z-index: 1000 !important;
}

.DTFC_LeftWrapper table {
    background: white !important;
    border-collapse: collapse !important;
}

.DTFC_LeftWrapper th,
.DTFC_LeftWrapper td {
    background: white !important;
    border-right: 1px solid #dee2e6 !important;
    padding: 0.75rem 0.5rem !important;
}

.DTFC_LeftWrapper tbody tr:hover {
    background-color: #e3f2fd !important;
}

/* Mejorar la separación visual de la columna fija */
.DTFC_LeftWrapper th:last-child,
.DTFC_LeftWrapper td:last-child {
    border-right: 3px solid #007bff !important;
    position: relative;
}

.DTFC_LeftWrapper th:last-child::after,
.DTFC_LeftWrapper td:last-child::after {
    content: '';
    position: absolute;
    right: -3px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(90deg, #007bff, #0056b3);
}

/* Estilos para el scroll horizontal */
.dataTables_scrollBody {
    border: 1px solid #dee2e6 !important;
    border-radius: 0.375rem !important;
}

.dataTables_scrollHead {
    border: 1px solid #dee2e6 !important;
    border-bottom: none !important;
    border-radius: 0.375rem 0.375rem 0 0 !important;
}

/* Estilos para los filtros mejorados */
.form-control-custom {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

/* Estilos para filtros compactos en una fila */
.form-select-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 0.25rem;
}

.form-control-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 0.25rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 0.25rem;
}

.small {
    font-size: 0.75rem;
    margin-bottom: 0.25rem;
}

/* Espaciado compacto para filtros */
.row.g-2 {
    --bs-gutter-x: 0.5rem;
    --bs-gutter-y: 0.5rem;
}

/* Alineación de elementos en filtros */
.align-items-end {
    align-items: end !important;
}

.form-control-custom:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.form-label.fw-semibold {
    color: #495057;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

/* Estilos para botones de filtros */
.btn-pacifico {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

.btn-pacifico:hover {
    background-color: #0056b3;
    border-color: #0056b3;
    color: white;
}

.btn-outline-pacifico {
    color: #007bff;
    border-color: #007bff;
}

.btn-outline-pacifico:hover {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

/* Estilos para botones en el header de filtros */
.card-header-custom .btn-light {
    background-color: rgba(255, 255, 255, 0.9);
    border-color: rgba(255, 255, 255, 0.3);
    color: #495057;
    font-weight: 500;
    transition: all 0.2s ease;
}

.card-header-custom .btn-light:hover {
    background-color: rgba(255, 255, 255, 1);
    border-color: rgba(255, 255, 255, 0.5);
    color: #212529;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.card-header-custom .btn-outline-light {
    background-color: transparent;
    border-color: rgba(255, 255, 255, 0.5);
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    transition: all 0.2s ease;
}

.card-header-custom .btn-outline-light:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.8);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Animación para los filtros */
.card-custom {
    transition: all 0.3s ease;
}

.card-custom:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

/* Estilos para filtros activos */
.filtro-activo {
    background-color: #e3f2fd !important;
    border-color: #2196f3 !important;
    box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25) !important;
}

.filtro-activo:focus {
    background-color: #e3f2fd !important;
    border-color: #1976d2 !important;
    box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25) !important;
}

/* Indicador visual para filtros activos */
.filtro-activo::before {
    content: '✓';
    position: absolute;
    top: -8px;
    right: -8px;
    background: #2196f3;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    z-index: 10;
}

/* Contenedor relativo para el indicador */
.col-md-2 {
    position: relative;
}

/* Estilos para la cinta (ribbon) */
.ribbon-container {
    position: relative;
    margin-bottom: 2rem;
}

.ribbon {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 1.5rem 2rem;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    position: relative;
    overflow: hidden;
}

.ribbon::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ffc107, #fd7e14, #e83e8c, #6f42c1);
    border-radius: 8px 8px 0 0;
}

.ribbon-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.ribbon-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.ribbon h1 {
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.ribbon p {
    margin: 0;
    opacity: 0.9;
}

/* Responsive para la cinta */
@media (max-width: 768px) {
    .ribbon-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .ribbon-actions {
        margin-top: 1rem;
    }
}

.table-row-hover:hover {
    background-color: #f5f9f6 !important;
    transition: background 0.2s;
}

/* MEJORAS PREMIUM PARA VISTA MÓVIL - ESTILO PACIFICO */
.vista-movil .solicitud-card {
    background: #ffffff !important;
    border-radius: 16px !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08) !important;
    border: 2px solid rgba(0, 156, 60, 0.2) !important;
    margin-bottom: 20px !important;
    overflow: hidden !important;
    transition: all 0.3s ease !important;
    position: relative !important;
}

.vista-movil .solicitud-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #009c3c, #22a650, #00d46a);
    z-index: 1;
}

.vista-movil .solicitud-card:hover {
    transform: translateY(-4px) !important;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12) !important;
    border-color: rgba(0, 156, 60, 0.4) !important;
}

.vista-movil .solicitud-card .p-4:first-child {
    background: #ffffff !important;
    color: #2d3748 !important;
    padding: 24px !important;
    position: relative;
    overflow: hidden;
    border-bottom: 2px solid rgba(0, 156, 60, 0.1) !important;
}

.vista-movil .solicitud-card .text-lg {
    font-size: 20px !important;
    font-weight: 800 !important;
    color: #009c3c !important;
    text-shadow: none !important;
}

.vista-movil .solicitud-card .w-3.h-3 {
    width: 14px !important;
    height: 14px !important;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3) !important;
    animation: pulse 2s infinite !important;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.1); }
}

.vista-movil .solicitud-card .bg-red-500 {
    background: linear-gradient(45deg, #ef4444, #dc2626) !important;
}

.vista-movil .solicitud-card .bg-yellow-500 {
    background: linear-gradient(45deg, #f59e0b, #d97706) !important;
}

.vista-movil .solicitud-card .bg-green-500 {
    background: linear-gradient(45deg, #10b981, #059669) !important;
}

.vista-movil .solicitud-card .rounded-full {
    border-radius: 25px !important;
    padding: 8px 16px !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    font-size: 11px !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
}

.vista-movil .solicitud-card .bg-red-100 {
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.9), rgba(200, 35, 51, 0.9)) !important;
    color: white !important;
}

.vista-movil .solicitud-card .bg-yellow-100 {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.9), rgba(255, 179, 77, 0.9)) !important;
    color: #000 !important;
}

.vista-movil .solicitud-card .bg-green-100 {
    background: linear-gradient(135deg, rgba(0, 156, 60, 0.9), rgba(34, 166, 80, 0.9)) !important;
    color: white !important;
}

.vista-movil .solicitud-card .grid {
    background: rgba(0, 156, 60, 0.05) !important;
    border-radius: 12px !important;
    padding: 16px !important;
    border: 1px solid rgba(0, 156, 60, 0.1) !important;
    margin-top: 16px !important;
}

.vista-movil .solicitud-card .text-green-600 {
    background: linear-gradient(135deg, #10b981, #059669) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    font-weight: 800 !important;
    font-size: 16px !important;
}

.vista-movil .solicitud-card .bg-gray-50:last-child {
    background: rgba(0, 156, 60, 0.02) !important;
    border-top: 1px solid rgba(0, 156, 60, 0.1) !important;
}

.vista-movil .solicitud-card .bg-blue-600 {
    background: linear-gradient(135deg, #009c3c, #22a650) !important;
    box-shadow: 0 4px 12px rgba(0, 156, 60, 0.3) !important;
    border-radius: 12px !important;
    padding: 12px 20px !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
}

.vista-movil .solicitud-card .bg-blue-600:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 20px rgba(0, 156, 60, 0.4) !important;
}

.vista-movil .solicitud-card .bg-gray-600 {
    background: linear-gradient(135deg, #6c757d, #495057) !important;
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3) !important;
    border-radius: 12px !important;
    padding: 12px 20px !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
}

.vista-movil .solicitud-card .bg-red-600 {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3) !important;
    border-radius: 12px !important;
    padding: 12px 20px !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
}

.vista-movil .solicitud-card .text-xs {
    font-size: 12px !important;
    font-weight: 600 !important;
    color: #009c3c !important;
    text-transform: uppercase !important;
    letter-spacing: 0.8px !important;
}

.vista-movil .solicitud-card .bg-blue-100 {
    background: linear-gradient(135deg, rgba(0, 156, 60, 0.1), rgba(34, 166, 80, 0.15)) !important;
    color: #009c3c !important;
    border-radius: 20px !important;
    padding: 8px 16px !important;
    font-weight: 700 !important;
    border: 1px solid rgba(0, 156, 60, 0.3) !important;
}

.vista-movil .solicitud-card .bg-purple-100 {
    background: linear-gradient(135deg, rgba(108, 117, 125, 0.1), rgba(73, 80, 87, 0.15)) !important;
    color: #495057 !important;
    border-radius: 20px !important;
    padding: 8px 16px !important;
    font-weight: 700 !important;
    border: 1px solid rgba(108, 117, 125, 0.3) !important;
}

.vista-movil .empty-state {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0) !important;
    border-radius: 25px !important;
    border: 3px dashed #cbd5e1 !important;
    padding: 60px 30px !important;
    text-align: center !important;
}

.vista-movil .empty-state .w-16 {
    background: linear-gradient(135deg, #e2e8f0, #cbd5e1) !important;
    width: 100px !important;
    height: 100px !important;
    border-radius: 50% !important;
    margin: 0 auto 25px !important;
    animation: bounce 3s infinite !important;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
}

/* Mejoras adicionales para micro-interacciones */
.vista-movil .solicitud-card .p-4:first-child::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 50% 50%, rgba(0, 156, 60, 0.05) 0%, transparent 60%);
    animation: shimmer 4s infinite;
}

@keyframes shimmer {
    0%, 100% { opacity: 0; transform: rotate(0deg); }
    50% { opacity: 1; transform: rotate(180deg); }
}

.vista-movil .solicitud-card .menu-dropdown {
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(20px) !important;
    border-radius: 15px !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.vista-movil .solicitud-card .menu-dropdown a:hover,
.vista-movil .solicitud-card .menu-dropdown button:hover {
    background: linear-gradient(90deg, #f3f4f6, #e5e7eb) !important;
    border-radius: 10px !important;
    margin: 2px !important;
}

.vista-movil .solicitud-card .text-sm.font-semibold {
    font-size: 15px !important;
    font-weight: 700 !important;
    color: #2d3748 !important;
    text-shadow: none !important;
}

.vista-movil .solicitud-card .text-sm.font-medium {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #2d3748 !important;
}

.vista-movil .solicitud-card .text-sm.font-bold {
    color: #10b981 !important;
    font-weight: 800 !important;
    font-size: 16px !important;
}

/* Mejoras para filtros móviles */
.vista-movil .filter-btn {
    transition: all 0.3s ease !important;
    position: relative !important;
    overflow: hidden !important;
}

.vista-movil .filter-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s ease;
}

.vista-movil .filter-btn:hover::before {
    left: 100%;
}

.vista-movil .filter-btn.active {
    background: linear-gradient(135deg, #009c3c, #22a650) !important;
    color: white !important;
    border: 1px solid #009c3c !important;
    box-shadow: 0 4px 12px rgba(0, 156, 60, 0.3) !important;
}

/* Mejoras para el buscador móvil */
.vista-movil input[type="text"] {
    background: rgba(255, 255, 255, 0.9) !important;
    border: 2px solid rgba(0, 156, 60, 0.1) !important;
    border-radius: 12px !important;
    padding: 12px 16px 12px 40px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    backdrop-filter: blur(10px) !important;
    transition: all 0.3s ease !important;
}

.vista-movil input[type="text"]:focus {
    border-color: #009c3c !important;
    box-shadow: 0 0 0 3px rgba(0, 156, 60, 0.1) !important;
    background: white !important;
}

.vista-movil .relative .absolute {
    color: #4a5568 !important;
    font-size: 16px !important;
}

/* Estilos para el header de Negocios */
.ribbon {
    overflow: hidden;
    position: relative;
}

.ribbon-container {
    padding: 0 15px;
}

.ribbon-actions {
    white-space: nowrap;
}

.ribbon-actions .btn {
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    white-space: nowrap;
}

.ribbon-actions .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.ribbon-actions .btn-light:hover {
    background-color: #f8f9fa;
    border-color: #f8f9fa;
}

.ribbon-actions .btn-outline-light:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
}

/* Responsive para móvil */
@media (max-width: 767px) {
    .ribbon-actions {
        width: 100%;
        justify-content: center;
        margin-top: 10px;
    }
    
    .ribbon-actions .btn {
        flex: 1;
        max-width: 150px;
    }
}

/* Estilos para controles móviles */
.mobile-controls {
    background: rgba(0, 156, 60, 0.02);
    border-radius: 12px;
    padding: 12px;
    border: 1px solid rgba(0, 156, 60, 0.1);
}

.toggle-btn {
    border-color: #009c3c !important;
    color: #009c3c !important;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.toggle-btn:hover {
    background-color: #009c3c !important;
    color: white !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 156, 60, 0.3);
}

.toggle-btn.collapsed {
    background-color: #f8f9fa !important;
    color: #6c757d !important;
    border-color: #dee2e6 !important;
}

.toggle-btn.collapsed:hover {
    background-color: #009c3c !important;
    color: white !important;
    border-color: #009c3c !important;
}

/* Estilo especial para toggle en header de filtros */
.card-header-custom .toggle-btn {
    background-color: rgba(255, 255, 255, 0.9) !important;
    color: #009c3c !important;
    border-color: rgba(255, 255, 255, 0.9) !important;
    font-weight: 600;
}

.card-header-custom .toggle-btn:hover {
    background-color: white !important;
    color: #007529 !important;
    border-color: white !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.card-header-custom .toggle-btn.collapsed {
    background-color: rgba(255, 255, 255, 0.7) !important;
    color: #6c757d !important;
    border-color: rgba(255, 255, 255, 0.7) !important;
}

.card-header-custom .toggle-btn.collapsed:hover {
    background-color: white !important;
    color: #009c3c !important;
    border-color: white !important;
}

/* Contenidos colapsables */
.kpis-content, .filters-content {
    transition: all 0.4s ease;
    overflow: hidden;
    opacity: 1;
    max-height: 2000px;
}

.kpis-content.collapsed, .filters-content.collapsed {
    opacity: 0;
    max-height: 0;
    margin: 0;
    padding: 0;
    transform: translateY(-10px);
}

/* Solo en móvil mostrar controles */
@media (min-width: 576px) {
    .mobile-controls {
        display: none !important;
    }
}

/* Animaciones de entrada */
.vista-movil .solicitud-card {
    animation: fadeInUp 0.5s ease-out !important;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-20px);
    }
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideOutUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-30px);
    }
}

@keyframes ripple {
    to {
        transform: scale(4);
        opacity: 0;
    }
}

/* Mejoras para paginación móvil */
.vista-movil nav a,
.vista-movil nav span {
    background: rgba(255, 255, 255, 0.9) !important;
    border: 1px solid rgba(0, 156, 60, 0.2) !important;
    border-radius: 12px !important;
    padding: 12px 16px !important;
    font-weight: 600 !important;
    color: #2d3748 !important;
    backdrop-filter: blur(10px) !important;
    transition: all 0.3s ease !important;
}

.vista-movil nav a:hover {
    background: linear-gradient(135deg, #009c3c, #22a650) !important;
    color: white !important;
    border-color: #009c3c !important;
    box-shadow: 0 4px 12px rgba(0, 156, 60, 0.3) !important;
    transform: translateY(-2px) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Manejar edición de etiquetas con select
  document.querySelectorAll('.etiquetas-select').forEach(function(select) {
    select.addEventListener('change', function(e) {
      const solicitudId = e.target.dataset.id;
      const nuevaEtiqueta = e.target.value;
      
      e.target.disabled = true;
      
      fetch(`/workflow/api/solicitudes/${solicitudId}/actualizar-etiquetas/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ etiquetas_oficial: nuevaEtiqueta })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          e.target.style.borderColor = '#22c55e';
          setTimeout(() => {
            e.target.style.borderColor = '';
          }, 1000);
        } else {
          e.target.style.borderColor = '#ef4444';
          alert(data.error || 'Error al guardar etiqueta');
        }
      })
      .catch(error => {
        e.target.style.borderColor = '#ef4444';
        alert('Error de conexión');
      })
      .finally(() => {
        e.target.disabled = false;
      });
    });
  });

  // Manejar edición de prioridad
  document.querySelectorAll('.prioridad-select').forEach(function(select) {
    select.addEventListener('change', function(e) {
      const solicitudId = e.target.dataset.id;
      const nuevaPrioridad = e.target.value;
      fetch(`/workflow/api/solicitudes/${solicitudId}/actualizar-prioridad/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ prioridad: nuevaPrioridad })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Cambia color del fondo según la prioridad seleccionada
          if (nuevaPrioridad === 'Alta') {
            e.target.style.backgroundColor = '#fee2e2';
            e.target.style.color = '#b91c1c';
          } else if (nuevaPrioridad === 'Media') {
            e.target.style.backgroundColor = '#fef9c3';
            e.target.style.color = '#b45309';
          } else if (nuevaPrioridad === 'Baja') {
            e.target.style.backgroundColor = '#dcfce7';
            e.target.style.color = '#166534';
          } else {
            e.target.style.backgroundColor = 'white';
            e.target.style.color = '#333';
          }
        } else {
          alert(data.error || 'Error al guardar prioridad');
        }
      });
    });
  });
});
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

<!-- JavaScript para Vista Móvil -->
<script>
// Funcionalidad mejorada para vista móvil
document.addEventListener('DOMContentLoaded', function() {
    // Animaciones de entrada escalonadas
    const cards = document.querySelectorAll('.vista-movil .solicitud-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });

    // Búsqueda móvil mejorada con debounce
    const busquedaMovil = document.getElementById('busquedaMovil');
    if (busquedaMovil) {
        let searchTimeout;
        
        busquedaMovil.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const searchTerm = this.value.toLowerCase();
            
            searchTimeout = setTimeout(() => {
                const cards = document.querySelectorAll('.solicitud-card');
                let visibleCount = 0;
                
                cards.forEach((card, index) => {
                    const searchData = card.getAttribute('data-search');
                    const isVisible = searchData && searchData.includes(searchTerm);
                    
                    if (isVisible) {
                        card.style.display = 'block';
                        card.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s both`;
                        visibleCount++;
                    } else {
                        card.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => {
                            card.style.display = 'none';
                        }, 300);
                    }
                });
                
                // Mostrar mensaje mejorado si no hay resultados
                const noResultsMsg = document.getElementById('noResultsMessage');
                
                if (visibleCount === 0 && searchTerm !== '') {
                    if (!noResultsMsg) {
                        const container = document.getElementById('solicitudesMovil');
                        const msg = document.createElement('div');
                        msg.id = 'noResultsMessage';
                        msg.className = 'empty-state';
                        msg.style.animation = 'fadeInUp 0.5s ease-out';
                        msg.innerHTML = `
                            <div class="empty-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <h3 class="empty-title">Sin resultados para "${searchTerm}"</h3>
                            <p class="empty-subtitle">Intenta con otros términos de búsqueda o revisa los filtros aplicados.</p>
                            <div class="empty-decoration">
                                <div class="decoration-dot"></div>
                                <div class="decoration-dot"></div>
                                <div class="decoration-dot"></div>
                            </div>
                        `;
                        container.appendChild(msg);
                    }
                } else if (noResultsMsg) {
                    noResultsMsg.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => noResultsMsg.remove(), 300);
                }
            }, 300);
        });
        
        // Efecto de foco mejorado
        busquedaMovil.addEventListener('focus', function() {
            this.parentElement.style.transform = 'scale(1.02)';
            this.parentElement.style.boxShadow = '0 8px 25px rgba(0, 156, 60, 0.15)';
        });
        
        busquedaMovil.addEventListener('blur', function() {
            this.parentElement.style.transform = 'scale(1)';
            this.parentElement.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.05)';
        });
    }
    
    // Filtros rápidos móvil mejorados
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Efecto de ripple
            const ripple = document.createElement('span');
            ripple.style.cssText = `
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.6);
                transform: scale(0);
                animation: ripple 0.6s linear;
                width: 20px;
                height: 20px;
                left: 50%;
                top: 50%;
                margin-left: -10px;
                margin-top: -10px;
            `;
            this.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
            
            // Remover clase activa de todos los botones con animación
            filterBtns.forEach(b => {
                b.classList.remove('active');
                b.style.transform = 'scale(1)';
            });
            
            // Agregar clase activa al botón clickeado con animación
            this.classList.add('active');
            this.style.transform = 'scale(1.05)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
            
            const filter = this.getAttribute('data-filter');
            const cards = document.querySelectorAll('.solicitud-card');
            let visibleCount = 0;
            
            cards.forEach((card, index) => {
                let show = false;
                
                switch(filter) {
                    case 'todos':
                        show = true;
                        break;
                    case 'alta':
                        show = card.getAttribute('data-prioridad') === 'alta';
                        break;
                    case 'vencidas':
                        show = card.getAttribute('data-estado') === 'text-danger';
                        break;
                    case 'sin_asignar':
                        show = card.getAttribute('data-asignado') === 'sin_asignar';
                        break;
                }
                
                if (show) {
                    card.style.display = 'block';
                    card.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s both`;
                    visibleCount++;
                } else {
                    card.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => {
                        card.style.display = 'none';
                    }, 300);
                }
            });
            
            // Mostrar contador de resultados
            setTimeout(() => {
                const activeFilter = this.textContent.trim();
                showFilterResults(visibleCount, activeFilter);
            }, 500);
        });
    });
    
    // Función para mostrar resultados de filtro
    function showFilterResults(count, filterName) {
        // Remover mensaje anterior si existe
        const existingMsg = document.querySelector('.filter-results-msg');
        if (existingMsg) existingMsg.remove();
        
        if (count === 0) return;
        
        const container = document.getElementById('solicitudesMovil');
        const msg = document.createElement('div');
        msg.className = 'filter-results-msg';
        msg.style.cssText = `
            background: linear-gradient(135deg, rgba(0, 156, 60, 0.1), rgba(34, 166, 80, 0.15));
            color: #009c3c;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid rgba(0, 156, 60, 0.3);
            animation: slideInDown 0.5s ease-out;
        `;
        msg.innerHTML = `
            <i class="fas fa-filter" style="margin-right: 8px;"></i>
            ${count} solicitud${count !== 1 ? 'es' : ''} ${filterName.toLowerCase()}
        `;
        
        container.insertBefore(msg, container.firstChild);
        
        // Auto-remover después de 3 segundos
        setTimeout(() => {
            if (msg.parentNode) {
                msg.style.animation = 'slideOutUp 0.3s ease-out';
                setTimeout(() => msg.remove(), 300);
            }
        }, 3000);
    }
});

// Función para toggle de menús desplegables
function toggleMenu(button) {
    const menu = button.nextElementSibling;
    const allMenus = document.querySelectorAll('.menu-dropdown');
    
    // Cerrar todos los otros menús
    allMenus.forEach(m => {
        if (m !== menu) {
            m.classList.add('hidden');
        }
    });
    
    // Toggle del menú actual
    menu.classList.toggle('hidden');
    
    // Cerrar menú al hacer click fuera
    if (!menu.classList.contains('hidden')) {
        document.addEventListener('click', function closeMenu(e) {
            if (!button.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeMenu);
            }
        });
    }
}

// Función para eliminar solicitud (reutilizada)
function eliminarSolicitud(id) {
    if (confirm('¿Estás seguro de que deseas eliminar esta solicitud?')) {
        fetch(`/workflow/api/solicitudes/${id}/eliminar/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error al eliminar la solicitud');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar la solicitud');
        });
    }
}

// Función para toggle de secciones móviles
function toggleSection(sectionId) {
    let content, toggleBtn;
    
    if (sectionId === 'kpis-section') {
        content = document.querySelector('.kpis-content');
        toggleBtn = document.getElementById('toggle-kpis');
    } else if (sectionId === 'filters-section') {
        content = document.querySelector('.filters-content');
        toggleBtn = document.getElementById('toggle-filters');
    }
    
    const toggleText = toggleBtn.querySelector('.toggle-text');
    const icon = toggleBtn.querySelector('i');
    
    if (content && toggleBtn) {
        if (content.classList.contains('collapsed')) {
            // Mostrar contenido
            content.classList.remove('collapsed');
            toggleBtn.classList.remove('collapsed');
            
            if (sectionId === 'kpis-section') {
                toggleText.textContent = 'Ocultar KPIs';
                icon.className = 'fas fa-chart-bar me-1';
            } else if (sectionId === 'filters-section') {
                toggleText.textContent = 'Ocultar Filtros';
                icon.className = 'fas fa-filter me-1';
            }
        } else {
            // Ocultar contenido
            content.classList.add('collapsed');
            toggleBtn.classList.add('collapsed');
            
            if (sectionId === 'kpis-section') {
                toggleText.textContent = 'Mostrar KPIs';
                icon.className = 'fas fa-chart-bar me-1';
            } else if (sectionId === 'filters-section') {
                toggleText.textContent = 'Mostrar Filtros';
                icon.className = 'fas fa-filter me-1';
            }
        }
        
        // Guardar estado en localStorage
        localStorage.setItem(sectionId + '_collapsed', content.classList.contains('collapsed'));
    }
}

// Restaurar estado de secciones al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    ['kpis-section', 'filters-section'].forEach(sectionId => {
        const isCollapsed = localStorage.getItem(sectionId + '_collapsed') === 'true';
        if (isCollapsed) {
            // Aplicar estado colapsado directamente sin animación
            let content, toggleBtn;
            
            if (sectionId === 'kpis-section') {
                content = document.querySelector('.kpis-content');
                toggleBtn = document.getElementById('toggle-kpis');
            } else if (sectionId === 'filters-section') {
                content = document.querySelector('.filters-content');
                toggleBtn = document.getElementById('toggle-filters');
            }
            
            if (content && toggleBtn) {
                content.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                
                const toggleText = toggleBtn.querySelector('.toggle-text');
                const icon = toggleBtn.querySelector('i');
                
                if (sectionId === 'kpis-section') {
                    toggleText.textContent = 'Mostrar KPIs';
                } else if (sectionId === 'filters-section') {
                    toggleText.textContent = 'Mostrar Filtros';
                }
            }
        }
    });
});
</script>
{% endblock %} 