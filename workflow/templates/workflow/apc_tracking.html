{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}Tracking APC Makito{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2d5a2d;
        --primary-hover: #1e5f2a;
        --background-color: #f8fafc;
        --card-background: #ffffff;
        --border-color: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --border-radius: 12px;
        --border-radius-sm: 8px;
    }

    /* Override with Pacifico green if available */
    .apc-tracking-container {
        --primary-color: var(--verde-pacifico, #2d5a2d) !important;
    }

    /* Ensure styles are applied with higher specificity */
    body .apc-tracking-container {
        padding: 24px;
        background: var(--background-color);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    body .apc-header {
        background: var(--card-background) !important;
        border-radius: var(--border-radius);
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    body .apc-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
    }
    
    body .apc-filters {
        background: var(--card-background) !important;
        border-radius: var(--border-radius);
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }
    
    body .apc-table-container {
        background: var(--card-background) !important;
        border-radius: var(--border-radius);
        padding: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        transition: all 0.2s ease;
        white-space: nowrap;
        max-width: 140px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .status-pending {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        border: 1px solid #f59e0b;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
    }
    
    .status-in_progress {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        border: 1px solid #3b82f6;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        animation: pulse 2s infinite;
    }
    
    .status-completed {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #065f46;
        border: 1px solid #10b981;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }
    
    .status-error {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
        border: 1px solid #ef4444;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .apc-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 16px;
        border-radius: var(--border-radius-sm);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }
    
    .apc-table th,
    .apc-table td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    .apc-table th {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        font-weight: 700;
        color: var(--text-primary);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .apc-table th:first-child {
        border-top-left-radius: var(--border-radius-sm);
    }

    .apc-table th:last-child {
        border-top-right-radius: var(--border-radius-sm);
    }
    
    .apc-table tbody tr {
        transition: all 0.2s ease;
    }

    .apc-table tbody tr:hover {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
        cursor: pointer;
    }

    .apc-table tbody tr {
        transition: all 0.2s ease;
        position: relative;
    }

    .apc-table tbody tr::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(45, 90, 45, 0.05), rgba(45, 90, 45, 0.02));
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
    }

    .apc-table tbody tr:hover::after {
        opacity: 1;
    }

    .apc-table tbody tr:active {
        transform: translateY(0);
        box-shadow: var(--shadow-sm);
    }

    .apc-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    body .refresh-btn {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)) !important;
        color: white !important;
        border: none;
        padding: 12px 20px;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: var(--shadow-sm);
    }
    
    body .refresh-btn:hover {
        background: linear-gradient(135deg, var(--primary-hover), #155a15) !important;
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        color: white !important;
    }

    body .refresh-btn:active {
        transform: translateY(0);
        box-shadow: var(--shadow-sm);
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        align-items: end;
    }

    @media (max-width: 768px) {
        .filter-row {
            grid-template-columns: 1fr;
        }
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-primary);
        font-size: 0.875rem;
    }
    
    .filter-group select,
    .filter-group input {
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: var(--card-background);
        color: var(--text-primary);
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .filter-group select:hover,
    .filter-group input:hover {
        border-color: var(--primary-color);
    }

    /* Quick Search Styles */
    .search-container input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .search-container input:hover {
        border-color: var(--primary-color);
    }

    #clearSearch:hover {
        background: var(--border-color);
        color: var(--text-primary);
    }

    /* Search Results Highlighting */
    .search-highlight {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        padding: 2px 4px;
        border-radius: 4px;
        font-weight: 600;
    }
    
    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
        font-style: italic;
    }

    .no-data i {
        font-size: 4rem;
        color: var(--border-color);
        margin-bottom: 20px;
        display: block;
    }

    .no-data p {
        font-size: 1.125rem;
        margin: 0;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
    }

    @media (max-width: 768px) {
        .stats-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .stats-row {
            grid-template-columns: 1fr;
        }
    }
    
    body .stat-card {
        background: var(--card-background) !important;
        border-radius: var(--border-radius);
        padding: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    body .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
    }

    body .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }
    
    body .stat-number {
        font-size: 3rem !important;
        font-weight: 800 !important;
        color: var(--primary-color) !important;
        line-height: 1;
        margin-bottom: 8px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    body .stat-label {
        color: var(--text-secondary) !important;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin: 0;
    }
    
    .loading {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
    }
    
    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .section-title {
        margin: 0 0 20px 0;
        color: var(--text-primary);
        font-size: 1.25rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-title i {
        color: var(--primary-color);
        font-size: 1.125rem;
    }

    .header-title {
        margin: 0;
        color: var(--primary-color);
        font-size: 2rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .header-subtitle {
        margin: 8px 0 0 0;
        color: var(--text-secondary);
        font-size: 1rem;
        font-weight: 400;
    }

    .btn-action {
        background: var(--card-background);
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        padding: 8px 12px;
        border-radius: var(--border-radius-sm);
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .btn-action:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
        text-decoration: none;
    }
    
    .btn-action.warning {
        background: #f39c12;
        color: white;
        border: 1px solid #e67e22;
    }
    
    .btn-action.warning:hover {
        background: #e67e22;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
    }

    .table-responsive {
        border-radius: var(--border-radius-sm);
        overflow-x: auto;
        overflow-y: hidden;
        box-shadow: var(--shadow-sm);
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: var(--primary-color) var(--border-color);
    }

    /* Custom scrollbar styling for webkit browsers */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: var(--border-color);
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 4px;
        transition: background 0.2s ease;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: var(--primary-hover);
    }

    /* Ensure table maintains minimum width for scrolling */
    .apc-table {
        min-width: 1300px; /* Increased minimum width to accommodate wider columns */
        width: 100%;
        table-layout: fixed; /* Better column width control */
    }

    /* Column width optimization for better responsive behavior */
    .apc-table th:nth-child(1), .apc-table td:nth-child(1) { /* Código */
        width: 120px;
        min-width: 120px;
    }
    
    .apc-table th:nth-child(2), .apc-table td:nth-child(2) { /* Cliente */
        width: 150px;
        min-width: 150px;
    }
    
    .apc-table th:nth-child(3), .apc-table td:nth-child(3) { /* Documento */
        width: 120px;
        min-width: 120px;
    }
    
    .apc-table th:nth-child(4), .apc-table td:nth-child(4) { /* Estado */
        width: 160px;
        min-width: 160px;
        padding-right: 20px;
    }
    
    .apc-table th:nth-child(5), .apc-table td:nth-child(5) { /* Pipeline */
        width: 140px;
        min-width: 140px;
        padding-left: 8px;
    }
    
    .apc-table th:nth-child(6), .apc-table td:nth-child(6) { /* Solicitado por */
        width: 180px;
        min-width: 180px;
    }
    
    .apc-table th:nth-child(7), .apc-table td:nth-child(7) { /* Fecha Solicitud */
        width: 140px;
        min-width: 140px;
    }
    
    .apc-table th:nth-child(8), .apc-table td:nth-child(8) { /* Fecha Inicio */
        width: 140px;
        min-width: 140px;
    }
    
    .apc-table th:nth-child(9), .apc-table td:nth-child(9) { /* Fecha Completado */
        width: 140px;
        min-width: 140px;
    }
    
    .apc-table th:nth-child(10), .apc-table td:nth-child(10) { /* Archivo APC */
        width: 120px;
        min-width: 120px;
    }
    
    .apc-table th:nth-child(11), .apc-table td:nth-child(11) { /* Observaciones */
        width: 200px;
        min-width: 200px;
    }
    
    .apc-table th:nth-child(12), .apc-table td:nth-child(12) { /* Acciones */
        width: 100px;
        min-width: 100px;
    }

    /* Add visual indicators for horizontal scroll */
    .table-scroll-indicator {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 32px;
        height: 32px;
        background: rgba(45, 90, 45, 0.9);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        z-index: 20;
        opacity: 0;
        transition: all 0.3s ease;
        pointer-events: auto;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(4px);
    }

    .table-scroll-indicator:hover {
        background: rgba(45, 90, 45, 1);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .table-scroll-indicator:active {
        transform: translateY(-50%) scale(0.95);
    }

    .table-scroll-indicator.left {
        left: 8px;
    }

    .table-scroll-indicator.right {
        right: 8px;
    }

    .table-scroll-indicator.visible {
        opacity: 1;
    }

    /* Add scroll hint for users */
    .scroll-hint {
        position: absolute;
        bottom: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--card-background);
        color: var(--text-secondary);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 10;
    }

    .scroll-hint.visible {
        opacity: 1;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        animation: fadeIn 0.3s ease;
    }

    .modal-container {
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    .modal-title {
        margin: 0;
        color: var(--primary-color);
        font-size: 1.25rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }

    .modal-close:hover {
        background: var(--border-color);
        color: var(--text-primary);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .modal-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        padding: 40px 20px;
        color: var(--text-secondary);
    }

    .modal-section {
        margin-bottom: 32px;
    }

    .modal-section:last-child {
        margin-bottom: 0;
    }

    .section-subtitle {
        margin: 0 0 16px 0;
        color: var(--text-primary);
        font-size: 1.125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--border-color);
    }

    .section-subtitle i {
        color: var(--primary-color);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .info-item label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .info-item span {
        color: var(--text-primary);
        font-size: 1rem;
    }

    /* Timeline Styles */
    .timeline {
        position: relative;
        padding-left: 32px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 16px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 24px;
        padding: 16px;
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-sm);
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -24px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary-color);
        border: 3px solid var(--card-background);
        box-shadow: 0 0 0 2px var(--primary-color);
    }

    .timeline-item:last-child {
        margin-bottom: 0;
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .timeline-title {
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .timeline-date {
        color: var(--text-secondary);
        font-size: 0.875rem;
        white-space: nowrap;
    }

    .timeline-description {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin: 0;
    }

    /* File Actions */
    .file-actions {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .btn-preview,
    .btn-download {
        background: var(--card-background);
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        padding: 12px 20px;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
    }

    .btn-preview:hover,
    .btn-download:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .btn-download {
        background: var(--primary-color);
        color: white;
    }

    .btn-download:hover {
        background: var(--primary-hover);
    }

    /* PDF Preview */
    .pdf-preview {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        overflow: hidden;
        background: #f8f9fa;
    }

    .pdf-preview iframe {
        border: none;
        background: white;
    }

    /* Observaciones */
    .observaciones-content {
        background: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        padding: 16px;
        color: var(--text-primary);
        line-height: 1.6;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(20px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive Modal */
    @media (max-width: 768px) {
        .modal-overlay {
            padding: 10px;
        }

        .modal-container {
            max-height: 95vh;
        }

        .modal-header {
            padding: 16px;
        }

        .modal-body {
            padding: 16px;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }

        .file-actions {
            flex-direction: column;
        }

        .timeline {
            padding-left: 24px;
        }

        .timeline-item::before {
            left: -16px;
        }
    }

    /* Enhanced responsive design */
    @media (max-width: 768px) {
        .apc-tracking-container {
            padding: 16px;
        }

        .apc-header {
            padding: 20px;
        }

        .apc-table-container {
            padding: 20px;
        }

        .header-title {
            font-size: 1.5rem;
        }

        .apc-table th,
        .apc-table td {
            padding: 12px 8px;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        /* Ensure table container shows scroll indicators on mobile */
        .apc-table-container {
            position: relative;
        }

        /* Compact filters responsive */
        .apc-table-container > div:first-child > div:last-child {
            flex-direction: column;
            align-items: stretch !important;
            gap: 12px !important;
        }

        .filter-group {
            width: 100%;
        }

        .search-container {
            min-width: 100% !important;
        }

        .apc-table-container > div:first-child {
            flex-direction: column;
            align-items: stretch !important;
        }
    }

    @media (max-width: 480px) {
        .apc-table th,
        .apc-table td {
            padding: 8px 6px;
            font-size: 0.75rem;
        }

        .apc-table {
            min-width: 1000px; /* Slightly smaller minimum width for very small screens */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="apc-tracking-container">
    <!-- Header -->
    <div class="apc-header">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div>
                <h2 class="header-title">
                    <i class="fas fa-robot"></i>APC Makito
                </h2>
                <p class="header-subtitle">
                    Seguimiento de solicitudes de APC procesadas por Makito RPA
                </p>
            </div>
            <button class="refresh-btn" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
        </div>
    </div>
    
    <!-- Estadísticas -->
    <div class="stats-row" id="statsContainer">
        <div class="stat-card">
            <div class="stat-number" id="totalCount">-</div>
            <div class="stat-label">Total APC</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingCount">-</div>
            <div class="stat-label">Pendientes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="inProgressCount">-</div>
            <div class="stat-label">En Proceso</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="completedCount">-</div>
            <div class="stat-label">Completados</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="avgTimeCount">-</div>
            <div class="stat-label">Tiempo Promedio de Descarga (min)</div>
        </div>
    </div>
    
    <!-- Tabla de solicitudes -->
    <div class="apc-table-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
            <h4 class="section-title" style="margin: 0;">
                <i class="fas fa-list"></i> Solicitudes APC
            </h4>
            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                <!-- Buscador -->
                <div class="search-container" style="position: relative; min-width: 300px;">
                    <input 
                        type="text" 
                        id="quickSearch" 
                        placeholder="Buscar por código, cliente, documento, pipeline..."
                        style="width: 100%; padding: 12px 16px 12px 45px; border: 2px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 0.875rem; transition: all 0.2s ease; background: var(--card-background); color: var(--text-primary);"
                        oninput="handleQuickSearch()"
                    >
                    <i class="fas fa-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none;"></i>
                    <button 
                        id="clearSearch" 
                        onclick="handleClearSearch()"
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px; border-radius: 50%; transition: all 0.2s ease; display: none;"
                        title="Limpiar búsqueda"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <!-- Filtros compactos -->
                <div class="filter-group" style="margin: 0;">
                    <select id="statusFilter" onchange="applyFilters()" style="padding: 8px 12px; border: 2px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 0.875rem; background: var(--card-background); color: var(--text-primary); min-width: 140px;" title="Filtrar por estado">
                        <option value="">Todos los estados</option>
                        <option value="pending">Pendiente</option>
                        <option value="in_progress">En Proceso</option>
                        <option value="completed">Completado</option>
                        <option value="error">Error</option>
                    </select>
                </div>
                <div class="filter-group" style="margin: 0;">
                    <input type="date" id="fechaDesde" onchange="applyFilters()" style="padding: 8px 12px; border: 2px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 0.875rem; background: var(--card-background); color: var(--text-primary);" title="Fecha desde">
                </div>
                <div class="filter-group" style="margin: 0;">
                    <input type="date" id="fechaHasta" onchange="applyFilters()" style="padding: 8px 12px; border: 2px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 0.875rem; background: var(--card-background); color: var(--text-primary);" title="Fecha hasta">
                </div>
                <button class="refresh-btn" onclick="clearFilters()" style="padding: 8px 12px; font-size: 0.875rem;" title="Limpiar filtros">
                    <i class="fas fa-times"></i> Limpiar
                </button>
            </div>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>Cargando datos...</span>
        </div>
        
        <div id="tableContainer" class="table-responsive" style="position: relative;">
            <!-- Scroll indicators -->
            <div class="table-scroll-indicator left" id="scrollLeftIndicator">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="table-scroll-indicator right" id="scrollRightIndicator">
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <table class="apc-table">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Cliente</th>
                        <th>Documento</th>
                        <th>Estado</th>
                        <th>Pipeline</th>
                        <th>Solicitado por</th>
                        <th>Fecha Solicitud</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Completado</th>
                        <th>Archivo APC</th>
                        <th>Observaciones</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="apcTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            
            <!-- Scroll hint -->
            <div class="scroll-hint" id="scrollHint">
                <i class="fas fa-arrows-alt-h"></i> Desliza para ver más columnas
            </div>
        </div>
        
        <div id="noDataMessage" class="no-data" style="display: none;">
            <i class="fas fa-inbox"></i>
            <p>No se encontraron solicitudes APC con los filtros aplicados</p>
        </div>
    </div>
</div>

<!-- Modal para detalles de APC -->
<div id="apcDetailModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-file-alt"></i> Detalles APC
            </h3>
            <button class="modal-close" onclick="closeApcModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div id="modalLoading" class="modal-loading">
                <div class="spinner"></div>
                <span>Cargando detalles...</span>
            </div>
            
            <div id="modalContent" style="display: none;">
                <!-- Información básica -->
                <div class="modal-section">
                    <h4 class="section-subtitle">
                        <i class="fas fa-info-circle"></i> Información General
                    </h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Código:</label>
                            <span id="modalCodigo"></span>
                        </div>
                        <div class="info-item">
                            <label>Cliente:</label>
                            <span id="modalCliente"></span>
                        </div>
                        <div class="info-item">
                            <label>Documento:</label>
                            <span id="modalDocumento"></span>
                        </div>
                        <div class="info-item">
                            <label>Pipeline:</label>
                            <span id="modalPipeline"></span>
                        </div>
                        <div class="info-item">
                            <label>Solicitado por:</label>
                            <span id="modalSolicitadoPor"></span>
                        </div>
                        <div class="info-item">
                            <label>Estado:</label>
                            <span id="modalEstado"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Acciones de Administrador (Solo Superusuarios) -->
                <div class="modal-section" id="modalAdminActions" style="display: none;">
                    <h4 class="section-subtitle">
                        <i class="fas fa-cog"></i> Acciones de Administrador
                    </h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn-action warning" id="reenviarSolicitudBtn" onclick="reenviarSolicitudApc()" title="Reenviar la solicitud de APC a Makito RPA">
                            <i class="fas fa-paper-plane"></i> Reenviar Solicitud a Makito
                        </button>
                    </div>
                </div>
                
                <!-- Timeline de eventos -->
                <div class="modal-section">
                    <h4 class="section-subtitle">
                        <i class="fas fa-history"></i> Timeline de Eventos
                    </h4>
                    <div class="timeline" id="modalTimeline">
                        <!-- Timeline items will be loaded here -->
                    </div>
                </div>
                
                <!-- Archivo APC -->
                <div class="modal-section" id="modalArchivoSection" style="display: none;">
                    <h4 class="section-subtitle">
                        <i class="fas fa-file-pdf"></i> Archivo APC
                    </h4>
                    <div class="file-actions">
                        <button class="btn-preview" onclick="previewApcFile()">
                            <i class="fas fa-eye"></i> Vista Previa
                        </button>
                        <button class="btn-download" onclick="downloadApcFile()">
                            <i class="fas fa-download"></i> Descargar
                        </button>
                    </div>
                    <div id="pdfPreview" class="pdf-preview" style="display: none;">
                        <iframe id="pdfViewer" src="" width="100%" height="500px"></iframe>
                    </div>
                </div>
                
                <!-- Observaciones -->
                <div class="modal-section" id="modalObservacionesSection" style="display: none;">
                    <h4 class="section-subtitle">
                        <i class="fas fa-comment"></i> Observaciones
                    </h4>
                    <div class="observaciones-content" id="modalObservaciones">
                        <!-- Observaciones will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentData = [];
const isUserSuperuser = {{ user.is_superuser|yesno:"true,false" }};

// Función para cargar datos iniciales
document.addEventListener('DOMContentLoaded', function() {
    loadApcData();
});

// Función para cargar datos de APC
async function loadApcData() {
    showLoading(true);
    
    try {
        const params = new URLSearchParams();
        
        // Aplicar filtros
        const statusFilter = document.getElementById('statusFilter').value;
        const fechaDesde = document.getElementById('fechaDesde').value;
        const fechaHasta = document.getElementById('fechaHasta').value;
        
        if (statusFilter) params.append('status', statusFilter);
        if (fechaDesde) params.append('fecha_desde', fechaDesde);
        if (fechaHasta) params.append('fecha_hasta', fechaHasta);
        
        const response = await fetch(`/workflow/api/apc/list/?${params.toString()}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentData = data.solicitudes;
            allData = data.solicitudes; // Store all data for client-side filtering
            
            // Apply quick search if active
            const searchTerm = document.getElementById('quickSearch').value.toLowerCase().trim();
            if (searchTerm) {
                filterAndRenderData(searchTerm);
            } else {
                updateStats(data.solicitudes);
                renderTable(data.solicitudes);
            }
        } else {
            console.error('Error al cargar datos:', data.error);
            showError('Error al cargar los datos: ' + data.error);
        }
        
    } catch (error) {
        console.error('Error:', error);
        showError('Error de conexión al cargar los datos');
    } finally {
        showLoading(false);
    }
}

// Función para mostrar/ocultar loading
function showLoading(show) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const tableContainer = document.getElementById('tableContainer');
    const noDataMessage = document.getElementById('noDataMessage');
    
    if (show) {
        loadingIndicator.style.display = 'block';
        tableContainer.style.display = 'none';
        noDataMessage.style.display = 'none';
    } else {
        loadingIndicator.style.display = 'none';
    }
}

// Función para actualizar estadísticas
function updateStats(solicitudes) {
    const total = solicitudes.length;
    const pending = solicitudes.filter(s => s.apc_status === 'pending').length;
    const inProgress = solicitudes.filter(s => s.apc_status === 'in_progress').length;
    const completed = solicitudes.filter(s => s.apc_status === 'completed').length;
    
    // Calcular tiempo promedio de descarga SOLO para solicitudes completadas
    const completedSolicitudes = solicitudes.filter(s => {
        const isCompleted = s.apc_status === 'completed';
        const hasSolicitudDate = s.apc_fecha_solicitud && s.apc_fecha_solicitud !== '-' && s.apc_fecha_solicitud !== null;
        const hasCompletedDate = s.apc_fecha_completado && s.apc_fecha_completado !== '-' && s.apc_fecha_completado !== null;
        
        // Log for debugging
        if (!isCompleted) {
            console.log(`Excluding solicitud ${s.codigo}: status is ${s.apc_status}, not completed`);
        }
        
        return isCompleted && hasSolicitudDate && hasCompletedDate;
    });
    
    let avgTime = '-';
    console.log(`Total solicitudes: ${solicitudes.length}`);
    console.log(`Completed solicitudes with valid dates: ${completedSolicitudes.length}`);
    
    if (completedSolicitudes.length > 0) {
        console.log('Processing completed solicitudes for average time calculation:');
        completedSolicitudes.forEach(s => {
            console.log(`- ${s.codigo}: ${s.apc_status} | ${s.apc_fecha_solicitud} -> ${s.apc_fecha_completado}`);
        });
        
        let validCalculations = 0;
        const totalMinutes = completedSolicitudes.reduce((sum, s) => {
            try {
                // Parse dates in DD/MM/YYYY HH:MM format
                const parseDate = (dateStr) => {
                    if (!dateStr || dateStr === '-' || dateStr === null) {
                        return null;
                    }
                    
                                    // Handle DD/MM/YYYY HH:MM format
                const match = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})/);
                if (match) {
                    const [, day, month, year, hour, minute] = match;
                    // Create date in MM/DD/YYYY format for JavaScript
                    const date = new Date(`${month}/${day}/${year} ${hour}:${minute}`);
                    console.log(`Parsed date: "${dateStr}" -> ${date}`);
                    return date;
                }
                    
                    // Fallback to direct parsing
                    return new Date(dateStr);
                };
                
                const inicio = parseDate(s.apc_fecha_solicitud);
                const fin = parseDate(s.apc_fecha_completado);
                
                // Debug parsing
                console.log(`Parsing dates for ${s.codigo}:`, {
                    original_solicitud: s.apc_fecha_solicitud,
                    parsed_inicio: inicio,
                    original_completado: s.apc_fecha_completado,
                    parsed_fin: fin
                });
                
                // Validate dates
                if (!inicio || !fin || isNaN(inicio.getTime()) || isNaN(fin.getTime())) {
                    console.warn('Invalid dates for solicitud:', s.codigo, s.apc_fecha_solicitud, s.apc_fecha_completado);
                    return sum;
                }
                
                // Check if end date is after start date
                if (fin <= inicio) {
                    console.warn('End date before start date for solicitud:', s.codigo);
                    return sum;
                }
                
                const diffMinutes = (fin - inicio) / (1000 * 60); // Diferencia en minutos
                
                // Validate the calculation result
                if (isNaN(diffMinutes) || diffMinutes < 0) {
                    console.warn('Invalid time difference for solicitud:', s.codigo, diffMinutes);
                    return sum;
                }
                
                validCalculations++;
                console.log(`Solicitud ${s.codigo}: ${diffMinutes} minutes`);
                return sum + diffMinutes;
            } catch (error) {
                console.error('Error calculating time for solicitud:', s.codigo, error);
                return sum;
            }
        }, 0);
        
        if (validCalculations > 0) {
            const avgMinutes = totalMinutes / validCalculations;
            console.log('Average minutes:', avgMinutes, 'from', validCalculations, 'valid calculations');
            
            // Validate final average
            if (!isNaN(avgMinutes) && avgMinutes > 0) {
                // Mostrar el tiempo promedio en minutos
                avgTime = `${Math.round(avgMinutes)} min`;
            } else {
                console.warn('Invalid average minutes:', avgMinutes);
                avgTime = 'N/A';
            }
        } else {
            console.warn('No valid calculations available - no completed solicitudes with valid dates');
            avgTime = 'N/A';
        }
    } else {
        console.log('No completed solicitudes found for average time calculation');
        avgTime = '-';
    }
    
    console.log('Final avgTime:', avgTime);
    
    document.getElementById('totalCount').textContent = total;
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('inProgressCount').textContent = inProgress;
    document.getElementById('completedCount').textContent = completed;
    document.getElementById('avgTimeCount').textContent = avgTime;
}

// Función para renderizar la tabla
function renderTable(solicitudes, searchTerm = '') {
    const tbody = document.getElementById('apcTableBody');
    const tableContainer = document.getElementById('tableContainer');
    const noDataMessage = document.getElementById('noDataMessage');
    
    if (solicitudes.length === 0) {
        tableContainer.style.display = 'none';
        noDataMessage.style.display = 'block';
        
        // Update no data message based on search
        const noDataIcon = noDataMessage.querySelector('i');
        const noDataText = noDataMessage.querySelector('p');
        
        if (searchTerm) {
            noDataIcon.className = 'fas fa-search';
            noDataText.textContent = `No se encontraron solicitudes que coincidan con "${searchTerm}"`;
        } else {
            noDataIcon.className = 'fas fa-inbox';
            noDataText.textContent = 'No se encontraron solicitudes APC con los filtros aplicados';
        }
        return;
    }
    
    tableContainer.style.display = 'block';
    noDataMessage.style.display = 'none';
    
    tbody.innerHTML = '';
    
    solicitudes.forEach(solicitud => {
        const row = document.createElement('tr');
        
        // Make row clickable
        row.style.cursor = 'pointer';
        row.addEventListener('click', function(e) {
            // Don't open modal if clicking on action buttons or links
            if (e.target.closest('button') || e.target.closest('a')) {
                return;
            }
            openApcModal(solicitud.codigo);
        });
        
        // Apply highlighting if search term exists
        const highlightedCodigo = highlightSearchTerm(solicitud.codigo, searchTerm);
        const highlightedCliente = highlightSearchTerm(solicitud.cliente_nombre || 'Sin cliente', searchTerm);
        const highlightedTipoDoc = highlightSearchTerm(solicitud.apc_tipo_documento, searchTerm);
        const highlightedCedula = highlightSearchTerm(solicitud.apc_no_cedula, searchTerm);
        const highlightedPipeline = highlightSearchTerm(solicitud.pipeline, searchTerm);
        const highlightedCreadaPor = highlightSearchTerm(solicitud.creada_por, searchTerm);
        const highlightedEmail = highlightSearchTerm(solicitud.creada_por_email, searchTerm);
        const highlightedStatus = highlightSearchTerm(solicitud.apc_status_display, searchTerm);
        const highlightedObservaciones = solicitud.apc_observaciones ? 
            highlightSearchTerm(solicitud.apc_observaciones.substring(0, 50) + (solicitud.apc_observaciones.length > 50 ? '...' : ''), searchTerm) : '-';
        
        row.innerHTML = `
            <td>
                <strong>${highlightedCodigo}</strong>
            </td>
            <td>${highlightedCliente}</td>
            <td>
                ${highlightedTipoDoc} <br>
                <small class="text-muted">${highlightedCedula}</small>
            </td>
            <td>
                <span class="status-badge status-${solicitud.apc_status}">
                    ${getStatusIcon(solicitud.apc_status)} ${highlightedStatus}
                </span>
            </td>
            <td>${highlightedPipeline}</td>
            <td>
                ${highlightedCreadaPor}<br>
                <small class="text-muted">${highlightedEmail}</small>
            </td>
            <td>${solicitud.apc_fecha_solicitud || '-'}</td>
            <td>${solicitud.apc_fecha_inicio || '-'}</td>
            <td>${solicitud.apc_fecha_completado || '-'}</td>
            <td>
                ${solicitud.apc_archivo_disponible ? 
                    `<a href="${solicitud.apc_archivo_url}" class="btn-action" target="_blank" title="Descargar APC" onclick="event.stopPropagation();">
                        <i class="fas fa-download"></i> Descargar
                    </a>` 
                    : '<span class="text-muted">No disponible</span>'}
            </td>
            <td>
                ${solicitud.apc_observaciones ? 
                    `<span title="${solicitud.apc_observaciones}">${highlightedObservaciones}</span>` 
                    : '-'}
            </td>
            <td>
                <button class="btn-action" onclick="event.stopPropagation(); openApcModal('${solicitud.codigo}')" title="Ver detalles">
                    <i class="fas fa-eye"></i> Ver
                </button>
                <i class="fas fa-chevron-right" style="color: var(--text-muted); font-size: 0.75rem; margin-left: 8px;"></i>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Función para obtener ícono de estado
function getStatusIcon(status) {
    const icons = {
        'pending': '<i class="fas fa-clock"></i>',
        'in_progress': '<i class="fas fa-cog fa-spin"></i>',
        'completed': '<i class="fas fa-check-circle"></i>',
        'error': '<i class="fas fa-exclamation-triangle"></i>'
    };
    return icons[status] || '<i class="fas fa-question"></i>';
}

// Función para aplicar filtros
function applyFilters() {
    loadApcData();
}

// Función para limpiar filtros
function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('fechaDesde').value = '';
    document.getElementById('fechaHasta').value = '';
    // Clear search as well
    document.getElementById('quickSearch').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    loadApcData();
}

// Quick Search Functionality
let searchTimeout;
let allData = []; // Store all data for client-side filtering

const handleQuickSearch = () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const searchTerm = document.getElementById('quickSearch').value.toLowerCase().trim();
        const clearButton = document.getElementById('clearSearch');
        
        // Show/hide clear button
        if (searchTerm) {
            clearButton.style.display = 'block';
        } else {
            clearButton.style.display = 'none';
        }
        
        // Filter data client-side for instant results
        filterAndRenderData(searchTerm);
    }, 300); // Debounce for 300ms
};

const handleClearSearch = () => {
    document.getElementById('quickSearch').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    filterAndRenderData('');
};

const filterAndRenderData = (searchTerm) => {
    let filteredData = allData;
    
    if (searchTerm) {
        filteredData = allData.filter(solicitud => {
            const searchFields = [
                solicitud.codigo || '',
                solicitud.cliente_nombre || 'Sin cliente',
                solicitud.apc_tipo_documento || '',
                solicitud.apc_no_cedula || '',
                solicitud.pipeline || '',
                solicitud.creada_por || '',
                solicitud.creada_por_email || '',
                solicitud.apc_status_display || '',
                solicitud.apc_observaciones || ''
            ];
            
            return searchFields.some(field => 
                field.toLowerCase().includes(searchTerm)
            );
        });
    }
    
    // Update stats with filtered data
    updateStats(filteredData);
    
    // Render filtered table with highlighting
    renderTable(filteredData, searchTerm);
};

const highlightSearchTerm = (text, searchTerm) => {
    if (!searchTerm || !text) return text;
    
    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
};

// Función para refrescar datos
function refreshData() {
    loadApcData();
}

// Función para mostrar errores
function showError(message) {
    // Crear toast de error
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
        padding: 16px 20px;
        border-radius: 12px;
        border: 1px solid #ef4444;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        max-width: 400px;
        animation: slideIn 0.3s ease;
    `;
    
    toast.innerHTML = `
        <i class="fas fa-exclamation-circle" style="color: #ef4444;"></i>
        ${message}
    `;
    
    // Add slide-in animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => {
            toast.remove();
            style.remove();
        }, 300);
    }, 5000);
}

// Auto-refresh cada 30 segundos
setInterval(() => {
    refreshData();
}, 30000);

// Horizontal scroll functionality
document.addEventListener('DOMContentLoaded', function() {
    const tableContainer = document.getElementById('tableContainer');
    const scrollLeftIndicator = document.getElementById('scrollLeftIndicator');
    const scrollRightIndicator = document.getElementById('scrollRightIndicator');
    const scrollHint = document.getElementById('scrollHint');
    
    if (tableContainer && scrollLeftIndicator && scrollRightIndicator) {
        let scrollHintTimeout;
        
        // Function to update scroll indicators
        function updateScrollIndicators() {
            const { scrollLeft, scrollWidth, clientWidth } = tableContainer;
            
            // Show/hide left indicator
            if (scrollLeft > 0) {
                scrollLeftIndicator.classList.add('visible');
            } else {
                scrollLeftIndicator.classList.remove('visible');
            }
            
            // Show/hide right indicator
            if (scrollLeft < scrollWidth - clientWidth - 1) {
                scrollRightIndicator.classList.add('visible');
            } else {
                scrollRightIndicator.classList.remove('visible');
            }
            
            // Show scroll hint if table is scrollable and user hasn't scrolled yet
            if (scrollWidth > clientWidth && scrollLeft === 0 && scrollHint) {
                clearTimeout(scrollHintTimeout);
                scrollHintTimeout = setTimeout(() => {
                    scrollHint.classList.add('visible');
                    setTimeout(() => {
                        scrollHint.classList.remove('visible');
                    }, 3000);
                }, 1000);
            }
        }
        
        // Add scroll event listener
        tableContainer.addEventListener('scroll', function() {
            updateScrollIndicators();
            
            // Hide scroll hint when user starts scrolling
            if (scrollHint) {
                scrollHint.classList.remove('visible');
            }
        });
        
        // Add click handlers for scroll indicators
        scrollLeftIndicator.addEventListener('click', function() {
            tableContainer.scrollBy({
                left: -300,
                behavior: 'smooth'
            });
        });
        
        scrollRightIndicator.addEventListener('click', function() {
            tableContainer.scrollBy({
                left: 300,
                behavior: 'smooth'
            });
        });
        
        // Add keyboard navigation support
        tableContainer.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                tableContainer.scrollBy({
                    left: -100,
                    behavior: 'smooth'
                });
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                tableContainer.scrollBy({
                    left: 100,
                    behavior: 'smooth'
                });
            }
        });
        
        // Make table container focusable for keyboard navigation
        tableContainer.setAttribute('tabindex', '0');
        
        // Initial check for scroll indicators
        updateScrollIndicators();
        
        // Update indicators when window resizes
        window.addEventListener('resize', updateScrollIndicators);
        
        // Update indicators when data is loaded
        const originalRenderTable = window.renderTable;
        window.renderTable = function(solicitudes) {
            if (originalRenderTable) {
                originalRenderTable(solicitudes);
            }
            // Update scroll indicators after table is rendered
            setTimeout(updateScrollIndicators, 100);
        };
    }
});

// Modal functionality
let currentModalData = null;

// Function to open APC modal
async function openApcModal(codigo) {
    const modal = document.getElementById('apcDetailModal');
    const modalLoading = document.getElementById('modalLoading');
    const modalContent = document.getElementById('modalContent');
    
    // Show modal and loading
    modal.style.display = 'flex';
    modalLoading.style.display = 'flex';
    modalContent.style.display = 'none';
    
    try {
        // Find the solicitud data from current data
        const solicitud = currentData.find(s => s.codigo === codigo);
        if (!solicitud) {
            throw new Error('Solicitud no encontrada');
        }
        
        // Load detailed data from API
        const response = await fetch(`/workflow/api/apc/detail/${codigo}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentModalData = data.solicitud;
            populateModal(data.solicitud);
        } else {
            throw new Error(data.error || 'Error al cargar los detalles');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showError('Error al cargar los detalles: ' + error.message);
        closeApcModal();
    }
}

// Function to populate modal with data
function populateModal(solicitud) {
    const modalLoading = document.getElementById('modalLoading');
    const modalContent = document.getElementById('modalContent');
    
    // Hide loading, show content
    modalLoading.style.display = 'none';
    modalContent.style.display = 'block';
    
    // Populate basic information
    document.getElementById('modalCodigo').textContent = solicitud.codigo;
    document.getElementById('modalCliente').textContent = solicitud.cliente_nombre || 'Sin cliente';
    document.getElementById('modalDocumento').textContent = `${solicitud.apc_tipo_documento} - ${solicitud.apc_no_cedula}`;
    document.getElementById('modalPipeline').textContent = solicitud.pipeline;
    document.getElementById('modalSolicitadoPor').textContent = `${solicitud.creada_por} (${solicitud.creada_por_email})`;
    
    // Populate status with badge
    const statusElement = document.getElementById('modalEstado');
    statusElement.innerHTML = `
        <span class="status-badge status-${solicitud.apc_status}">
            ${getStatusIcon(solicitud.apc_status)} ${solicitud.apc_status_display}
        </span>
    `;
    
    // Populate timeline
    populateTimeline(solicitud);
    
    // Show/hide file section
    const archivoSection = document.getElementById('modalArchivoSection');
    if (solicitud.apc_archivo_disponible) {
        archivoSection.style.display = 'block';
    } else {
        archivoSection.style.display = 'none';
    }
    
    // Show/hide observaciones section
    const observacionesSection = document.getElementById('modalObservacionesSection');
    if (solicitud.apc_observaciones) {
        observacionesSection.style.display = 'block';
        document.getElementById('modalObservaciones').textContent = solicitud.apc_observaciones;
    } else {
        observacionesSection.style.display = 'none';
    }
    
    // Show/hide admin actions section (only for superusers)
    const adminActionsSection = document.getElementById('modalAdminActions');
    if (isUserSuperuser) {
        adminActionsSection.style.display = 'block';
        
        // Update button state based on APC status
        const reenviarBtn = document.getElementById('reenviarSolicitudBtn');
        if (solicitud.apc_status === 'completed') {
            reenviarBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Reenviar Solicitud a Makito';
            reenviarBtn.title = 'Reenviar la solicitud de APC a Makito RPA';
        } else {
            reenviarBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Reenviar Solicitud a Makito';
            reenviarBtn.title = 'Reenviar la solicitud de APC a Makito RPA';
        }
    } else {
        adminActionsSection.style.display = 'none';
    }
}

// Function to populate timeline
function populateTimeline(solicitud) {
    const timeline = document.getElementById('modalTimeline');
    const events = [];
    
    // Add creation event
    if (solicitud.fecha_creacion) {
        events.push({
            title: 'Solicitud Creada',
            date: solicitud.fecha_creacion,
            description: `Solicitud creada por ${solicitud.creada_por}`,
            icon: 'fas fa-plus-circle'
        });
    }
    
    // Add APC request event
    if (solicitud.apc_fecha_solicitud) {
        events.push({
            title: 'APC Solicitado',
            date: solicitud.apc_fecha_solicitud,
            description: 'Solicitud de APC enviada a Makito RPA',
            icon: 'fas fa-paper-plane'
        });
    }
    
    // Add processing start event
    if (solicitud.apc_fecha_inicio) {
        events.push({
            title: 'Procesamiento Iniciado',
            date: solicitud.apc_fecha_inicio,
            description: 'Makito RPA inició el procesamiento del APC',
            icon: 'fas fa-cog'
        });
    }
    
    // Add completion event
    if (solicitud.apc_fecha_completado) {
        events.push({
            title: 'APC Completado',
            date: solicitud.apc_fecha_completado,
            description: 'Proceso de APC completado exitosamente',
            icon: 'fas fa-check-circle'
        });
    }
    
    // Sort events by date
    events.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // Render timeline
    timeline.innerHTML = events.map(event => `
        <div class="timeline-item">
            <div class="timeline-header">
                <h5 class="timeline-title">
                    <i class="${event.icon}"></i> ${event.title}
                </h5>
                <span class="timeline-date">${formatDate(event.date)}</span>
            </div>
            <p class="timeline-description">${event.description}</p>
        </div>
    `).join('');
    
    if (events.length === 0) {
        timeline.innerHTML = `
            <div class="timeline-item">
                <div class="timeline-header">
                    <h5 class="timeline-title">
                        <i class="fas fa-info-circle"></i> Sin eventos registrados
                    </h5>
                </div>
                <p class="timeline-description">No hay eventos registrados para esta solicitud.</p>
            </div>
        `;
    }
}

// Function to format date
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Function to close modal
function closeApcModal() {
    const modal = document.getElementById('apcDetailModal');
    modal.style.display = 'none';
    currentModalData = null;
    
    // Hide PDF preview
    const pdfPreview = document.getElementById('pdfPreview');
    pdfPreview.style.display = 'none';
}

// Function to preview APC file
function previewApcFile() {
    if (!currentModalData || !currentModalData.apc_archivo_disponible) {
        showError('Archivo APC no disponible');
        return;
    }
    
    const pdfPreview = document.getElementById('pdfPreview');
    const pdfViewer = document.getElementById('pdfViewer');
    
    pdfViewer.src = currentModalData.apc_archivo_url;
    pdfPreview.style.display = 'block';
    
    // Scroll to PDF preview
    pdfPreview.scrollIntoView({ behavior: 'smooth' });
}

// Function to download APC file
function downloadApcFile() {
    if (!currentModalData || !currentModalData.apc_archivo_disponible) {
        showError('Archivo APC no disponible');
        return;
    }
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = currentModalData.apc_archivo_url;
    link.download = `APC_${currentModalData.codigo}.pdf`;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Function to resend APC request to Makito
async function reenviarSolicitudApc() {
    if (!currentModalData) {
        showError('No hay datos de solicitud disponibles');
        return;
    }
    
    // Confirm action
    if (!confirm(`¿Estás seguro de que quieres reenviar la solicitud de APC para ${currentModalData.codigo} a Makito RPA?\n\nEsto enviará nuevamente el correo con las instrucciones y datos de extracción.`)) {
        return;
    }
    
    const reenviarBtn = document.getElementById('reenviarSolicitudBtn');
    const originalHtml = reenviarBtn.innerHTML;
    
    try {
        // Disable button and show loading
        reenviarBtn.disabled = true;
        reenviarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reenviando...';
        
        // Send request to resend APC email
        const response = await fetch(`/workflow/api/apc/reenviar/${currentModalData.codigo}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success message
            showSuccess('✅ Solicitud reenviada exitosamente a Makito RPA');
            
            // Refresh modal data to show updated timeline
            setTimeout(() => {
                openApcModal(currentModalData.codigo);
            }, 1000);
            
            // Refresh main data
            setTimeout(() => {
                refreshData();
            }, 2000);
            
        } else {
            throw new Error(data.error || 'Error al reenviar la solicitud');
        }
        
    } catch (error) {
        console.error('Error al reenviar solicitud APC:', error);
        showError('❌ Error al reenviar la solicitud: ' + error.message);
    } finally {
        // Re-enable button
        reenviarBtn.disabled = false;
        reenviarBtn.innerHTML = originalHtml;
    }
}

// Helper function to get CSRF token
function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        return csrfToken.value;
    }
    
    // Alternative method to get CSRF token from cookies
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return decodeURIComponent(value);
        }
    }
    
    return '';
}

// Helper function to show success messages
function showSuccess(message) {
    // Create a temporary success message element
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        z-index: 10000;
        font-weight: 500;
        max-width: 400px;
        word-wrap: break-word;
        animation: slideIn 0.3s ease-out;
    `;
    successDiv.textContent = message;
    
    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(successDiv);
    
    // Remove after 5 seconds
    setTimeout(() => {
        successDiv.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 300);
    }, 5000);
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('apcDetailModal');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeApcModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeApcModal();
        }
    });
});
</script>
{% endblock %}
