{% extends "workflow/base.html" %}
{% load static %}
{% load workflow_filters %}

{% block title %}Back Office - Detalle de Solicitud - Sistema de Workflow{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'workflow/css/detalleSolicitud.css' %}" />
{% include "workflow/partials/backoffice_styles.html" %}
<style>
/* Estilos para pesta√±as con validaci√≥n secuencial */
.tab-modern.tab-blocked {
  opacity: 0.5;
  cursor: not-allowed !important;
  pointer-events: auto; /* Permitir eventos para mostrar mensaje */
  filter: grayscale(0.8);
  position: relative;
}

.tab-modern.tab-blocked:hover {
  opacity: 0.6;
  background-color: #f8f9fa !important;
  border-color: #dee2e6 !important;
}

.tab-modern.tab-blocked .tab-content-wrapper {
  position: relative;
}

.tab-modern.tab-blocked .tab-content-wrapper::after {
  content: '\f023'; /* Icono de candado */
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  position: absolute;
  top: 50%;
  right: 8px;
  transform: translateY(-50%);
  color: #6c757d;
  font-size: 0.8em;
}

.tab-modern.tab-blocked .tab-status {
  color: #6c757d !important;
}

.tab-modern.tab-available {
  box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
  animation: pulse-available 2s infinite;
  border-color: #0d6efd !important;
}

.tab-modern.tab-available:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
}

@keyframes pulse-available {
  0% {
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
  }
  50% {
    box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15);
  }
  100% {
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
  }
}

.tab-modern.tab-completed {
  background: linear-gradient(135deg, #d1edff 0%, #e8f7ff 100%);
  border-color: #198754 !important;
  position: relative;
}

.tab-modern.tab-completed .tab-number {
  background: #198754;
  color: white;
  position: relative;
}

.tab-modern.tab-completed .tab-number::before {
  content: '\f00c'; /* Icono de check */
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 0.7em;
}

.tab-modern.tab-completed .tab-status {
  color: #198754 !important;
  font-weight: 500;
}

/* Efecto de bloqueo visual m√°s fuerte */
.tab-modern.tab-blocked::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 2px,
    rgba(108, 117, 125, 0.1) 2px,
    rgba(108, 117, 125, 0.1) 4px
  );
  z-index: 1;
  pointer-events: none;
}

.tab-modern.tab-blocked .tab-content-wrapper {
  position: relative;
  z-index: 2;
}

/* Tooltip personalizado para pesta√±as bloqueadas */
.tab-blocked-tooltip {
  position: absolute;
  background: #dc3545;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.8em;
  white-space: nowrap;
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.tab-blocked-tooltip.show {
  opacity: 1;
}

.tab-blocked-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #dc3545 transparent transparent transparent;
}

/* Mejora visual para pesta√±a actual */
.tab-modern.active {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}

/* Transiciones suaves */
.tab-modern {
  transition: all 0.3s ease;
}

/* Indicador de proceso secuencial */
.sequential-indicator {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ffc107;
  color: #000;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 0.7em;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  animation: bounce 1s infinite;
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-3px);
  }
  60% {
    transform: translateY(-2px);
  }
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <!-- Header Principal -->
      <div class="card mb-4">
        <div class="backoffice-header">
          <div class="row align-items-center">
            <div class="col-lg-8 col-md-7 col-sm-12">
              <h2 class="mb-2">
                <i class="fas fa-building me-2"></i>
                Back Office - Etapa Especializada
              </h2>
              <p class="mb-0 opacity-75">
                <i class="fas fa-file-alt me-1"></i>
                Solicitud {{ solicitud.codigo }} - {{ solicitud.etapa_actual.nombre }}
              </p>
            </div>
            <div class="col-lg-4 col-md-5 col-sm-12 text-md-end text-center mt-2 mt-md-0">
              <div class="d-flex align-items-center justify-content-md-end justify-content-center flex-wrap gap-2">
                {% if solicitud.prioridad %}
                <span class="badge bg-warning text-dark px-3 py-2">
                  <i class="fas fa-star"></i> {{ solicitud.prioridad }}
                </span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Informaci√≥n del Cliente -->
        <div class="card-body">
          <h5 class="mb-3">
            <i class="fas fa-user-circle"></i> Informaci√≥n del Cliente
          </h5>
          <div class="client-info-grid">
            <div class="info-item">
              <div class="info-label">Cliente</div>
              <div class="info-value {% if not solicitud.cliente_nombre_completo %}empty{% endif %}">
                {{ solicitud.cliente_nombre_completo|default:"Sin especificar" }}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">C√©dula</div>
              <div class="info-value {% if not solicitud.cliente_cedula_completa %}empty{% endif %}">
                {{ solicitud.cliente_cedula_completa|default:"Sin especificar" }}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">Producto</div>
              <div class="info-value {% if not solicitud.producto_solicitado %}empty{% endif %}">
                {{ solicitud.producto_solicitado|default:"Sin especificar" }}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">Monto Solicitado</div>
              <div class="info-value {% if not solicitud.monto_solicitado %}empty{% endif %}">
                {% if solicitud.monto_solicitado %}B/. {{ solicitud.monto_solicitado|floatformat:2 }}{% else %}No
                especificado{% endif %}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">Tel√©fono</div>
              <div class="info-value {% if not solicitud.cliente_telefono %}empty{% endif %}">
                {{ solicitud.cliente_telefono|default:"Sin especificar" }}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">Email</div>
              <div class="info-value {% if not solicitud.cliente_email %}empty{% endif %}">
                {{ solicitud.cliente_email|default:"Sin especificar" }}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">Estado Actual</div>
              <div class="info-value {% if not solicitud.estado_actual %}empty{% endif %}">
                {{ solicitud.estado_actual|default:"Sin especificar" }}
              </div>
            </div>
            <!-- Campo Asignado a temporalmente removido -->
          </div>
        </div>
      </div>

      <!-- Subestados de Back Office -->
      <div class="card processes-card">
        <div class="card-header processes-header">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <div class="process-icon-container">
                <i class="fas fa-tasks"></i>
              </div>
              <div class="ms-3">
                <h5 class="mb-0 process-title">Procesos de Back Office</h5>
                <small class="process-subtitle">Gesti√≥n completa del flujo de trabajo</small>
              </div>
            </div>
            <div class="process-badge">
              <span class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>
                {{ solicitud.etapa_actual.subestados.count }} Etapas
              </span>
            </div>
          </div>
        </div>

        <div class="card-body p-0">
          <!-- Pesta√±as de Navegaci√≥n Mejoradas -->
          <div class="nav-tabs-container">
            <ul class="nav nav-tabs nav-tabs-modern d-flex flex-column flex-md-row" id="backoffice-tabs" role="tablist">
              {% for subestado in solicitud.etapa_actual.subestados.all %}
              <li class="nav-item" role="presentation">
                <button class="nav-link tab-modern {% if subestado.id == solicitud.subestado_actual.id %}active{% endif %}" id="tab-{{ subestado.id }}"
                  data-bs-toggle="tab" data-bs-target="#content-{{ subestado.id }}" type="button" role="tab"
                  aria-controls="content-{{ subestado.id }}"
                  aria-selected="{% if subestado.id == solicitud.subestado_actual.id %}true{% else %}false{% endif %}"
                  data-subestado-orden="{{ subestado.orden }}"
                  data-subestado-id="{{ subestado.id }}">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">{{ forloop.counter }}</div>
                    <div class="tab-text">
                      <span class="tab-title">{{ subestado.nombre }}</span>
                      <span class="tab-status">{% if subestado.id == solicitud.subestado_actual.id %}Activo{% else %}En proceso{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </button>
              </li>
              {% empty %}
              <li class="nav-item" role="presentation">
                <button class="nav-link tab-modern active" disabled>
                  <div class="tab-content-wrapper">
                    <div class="tab-number">!</div>
                    <div class="tab-text">
                      <span class="tab-title">Sin Procesos</span>
                      <span class="tab-status">No configurado</span>
                    </div>
                  </div>
                </button>
              </li>
              {% endfor %}
            </ul>
          </div>

          <!-- Contenido de las Pesta√±as -->
          <div class="tab-content" id="backoffice-content">
            {% for subestado in solicitud.etapa_actual.subestados.all %}
            <div class="tab-pane fade {% if subestado.id == solicitud.subestado_actual.id %}show active{% endif %}" id="content-{{ subestado.id }}"
              role="tabpanel" aria-labelledby="tab-{{ subestado.id }}">
              <div class="subestado-content-modern">
                <div class="process-step-header">
                  <div class="step-indicator">
                    <span class="step-number">{{ forloop.counter }}</span>
                    <span class="step-total">/ {{ solicitud.etapa_actual.subestados.count }}</span>
                  </div>
                  <div class="subestado-icon">
                    <i class="fas fa-folder-open"></i>
                  </div>
                  <div class="step-status">
                    <span class="badge bg-primary">
                      <i class="fas fa-cog me-1"></i>Procesando
                    </span>
                  </div>
                </div>



                <!-- Archivos Requeridos Din√°micos -->
                {% if archivos_por_subestado and subestado.id in archivos_por_subestado %}
                {% with archivos=archivos_por_subestado|get_item:subestado.id %}
                {% if archivos|length > 0 %}

                <div class="process-details">
                  {% for archivo_info in archivos %}
                  <div class="detail-card archivo-card-mejorada-backoffice"
                    data-requisito-id="{% if archivo_info.archivo_actual %}{{ archivo_info.archivo_actual.id }}{% else %}{{ archivo_info.requisito.id }}{% endif %}">
                    <!-- Header del archivo -->
                    <div class="archivo-header-backoffice">
                      <!-- IZQUIERDA: Informaci√≥n del documento -->
                      <div class="archivo-info-basica-backoffice">
                        <div class="detail-icon archivo-icon-backoffice">
                          {% if archivo_info.esta_cumplido %}
                          <i class="fas fa-check-circle text-success"></i>
                          {% else %}
                          <i class="fas fa-file-upload text-warning"></i>
                          {% endif %}
                        </div>
                        <div class="detail-content-backoffice">
                          <h6>{{ archivo_info.requisito.nombre }}</h6>
                          <p class="mb-1">{{ archivo_info.requisito.descripcion|default:"Sin descripci√≥n disponible" }}
                          </p>

                          {% if archivo_info.esta_cumplido and archivo_info.archivo_actual %}
                          <div class="archivo-info-backoffice mt-2">
                            <span class="badge bg-success me-2">
                              <i class="fas fa-check me-1"></i>Completo
                            </span>
                            <small class="text-muted">
                              Archivo: {{ archivo_info.archivo_actual.archivo.name|slice:"10:" }}
                            </small>
                          </div>
                          {% else %}
                          <div class="archivo-info-backoffice mt-2">
                            <span class="badge bg-warning me-2">
                              <i class="fas fa-exclamation-triangle me-1"></i>Pendiente
                            </span>
                            {% if archivo_info.obligatorio %}
                            <small class="text-danger">Obligatorio</small>
                            {% else %}
                            <small class="text-muted">Opcional</small>
                            {% endif %}
                          </div>
                          {% endif %}

                          {% if archivo_info.mensaje_personalizado %}
                          <div class="mensaje-personalizado mt-2">
                            <small class="text-info">
                              <i class="fas fa-info-circle me-1"></i>
                              {{ archivo_info.mensaje_personalizado }}
                            </small>
                          </div>
                          {% endif %}
                        </div>
                      </div>

                      <!-- CENTRO: Botones Ver/Descargar -->
                      {% if archivo_info.esta_cumplido and archivo_info.archivo_actual.archivo %}
                      <div class="seccion-ver-descargar-backoffice">
                        <div class="btn-group">
                          {% if archivo_info.archivo_actual.archivo.name|slice:"-5:" == ".docx" or archivo_info.archivo_actual.archivo.name|slice:"-4:" == ".doc" or archivo_info.archivo_actual.archivo.name|slice:"-4:" == ".pdf" or archivo_info.archivo_actual.archivo.name|slice:"-4:" == ".xls" or archivo_info.archivo_actual.archivo.name|slice:"-5:" == ".xlsx" or archivo_info.archivo_actual.archivo.name|slice:"-4:" == ".ppt" or archivo_info.archivo_actual.archivo.name|slice:"-5:" == ".pptx" %}
                          <a href="https://docs.google.com/viewer?url={{ request.build_absolute_uri }}{{ archivo_info.archivo_actual.archivo.url }}&embedded=true" target="_blank"
                            rel="noopener noreferrer" class="btn btn-outline-primary"
                            title="Ver documento en Google Viewer">
                            <i class="fas fa-eye"></i> Ver
                          </a>
                          {% else %}
                          <a href="{{ archivo_info.archivo_actual.archivo.url }}" target="_blank"
                            rel="noopener noreferrer" class="btn btn-outline-primary"
                            title="Ver archivo en nueva pesta√±a">
                            <i class="fas fa-eye"></i> Ver
                          </a>
                          {% endif %}
                          <a href="{{ archivo_info.archivo_actual.archivo.url }}" download
                            class="btn btn-outline-success" title="Descargar archivo">
                            <i class="fas fa-download"></i> Descargar
                          </a>
                        </div>
                      </div>
                      {% endif %}

                      <!-- DERECHA: Botones de calificaci√≥n -->
                      <div class="seccion-acciones-derecha-backoffice">
                        <!-- Botones de Calificaci√≥n -->
                        <div class="botones-calificacion-backoffice">
                          <!-- Bueno -->
                          <button type="button" class="btn calificar-btn-backoffice" data-estado="bueno"
                            data-requisito="{% if archivo_info.archivo_actual %}{{ archivo_info.archivo_actual.id }}{% endif %}"
                            title="Marcar como bueno"
                            {% if not archivo_info.archivo_actual %}disabled{% endif %}>
                            <i class="fas fa-thumbs-up"></i>
                            <span>Bueno</span>
                          </button>
                          <!-- Malo -->
                          <button type="button" class="btn calificar-btn-backoffice" data-estado="malo"
                            data-requisito="{% if archivo_info.archivo_actual %}{{ archivo_info.archivo_actual.id }}{% endif %}"
                            title="Marcar como malo"
                            {% if not archivo_info.archivo_actual %}disabled{% endif %}>
                            <i class="fas fa-thumbs-down"></i>
                            <span>Malo</span>
                          </button>
                          <!-- Comentarios -->
                          <button type="button" class="btn comentario-btn-backoffice"
                            data-requisito="{% if archivo_info.archivo_actual %}{{ archivo_info.archivo_actual.id }}{% endif %}"
                            title="Ver/Agregar comentarios"
                            {% if not archivo_info.archivo_actual %}disabled{% endif %}>
                            <i class="fas fa-comment"></i>
                            <span>Comentar</span>
                            <span class="badge">{{ archivo_info.comentarios_backoffice|length }}</span>
                          </button>
                        </div>
                        <!-- Opciones -->
                        <div class="seccion-opciones">
                          <button class="btn opciones-dropdown-btn-backoffice" type="button"
                            onclick="mostrarModalOpciones('{% if archivo_info.archivo_actual %}{{ archivo_info.archivo_actual.id }}{% endif %}', '{{ archivo_info.requisito.nombre }}')"
                            title="Opciones adicionales">
                            <i class="fas fa-ellipsis-v"></i>
                            <span>Opciones</span>
                          </button>
                        </div>
                      </div>
                    </div>



                  </div>
                  {% endfor %}
                </div>

                <!-- Asociaci√≥n de Entrevista de Cliente -->
                {% if solicitud.entrevista_cliente %}
                <div class="alert alert-success">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check-circle text-success me-3" style="font-size: 1.5rem;"></i>
                    <div>
                      <strong>Entrevista Asociada</strong><br />
                      <small>Cliente: {{ solicitud.entrevista_cliente.primer_nombre }} {{ solicitud.entrevista_cliente.primer_apellido }} - {{ solicitud.entrevista_cliente.email }}</small>
                    </div>
                    <div class="ms-auto">
                      <button type="button" class="btn btn-outline-secondary btn-sm" onclick="desasociarEntrevista()">
                        <i class="fas fa-unlink me-1"></i> Desasociar
                      </button>
                    </div>
                  </div>
                  <!-- Botones de acciones para la entrevista -->
                  <div class="border-top pt-2">
                    <div class="d-flex gap-2 flex-wrap">
                      <a href="{% url 'descargar_entrevista_excel' solicitud.entrevista_cliente.id %}" 
                         class="btn btn-outline-success btn-sm d-flex align-items-center justify-content-center" 
                         style="min-width: 80px; height: 32px;"
                         title="Descargar entrevista en Excel">
                        <i class="fa-solid fa-file-excel me-1"></i>
                        <span>Excel</span>
                      </a>
                      <a href="{% url 'entrevista_admin' solicitud.entrevista_cliente.id %}" 
                         class="btn btn-outline-primary btn-sm d-flex align-items-center justify-content-center" 
                         style="min-width: 80px; height: 32px;"
                         target="_blank" 
                         title="Modo Administrador - Control de Calidad">
                        <i class="fa-solid fa-user-gear me-1"></i>
                        <span>Admin</span>
                      </a>
                      <button onclick="enviarAAAPX({{ solicitud.entrevista_cliente.id }}, '{{ solicitud.entrevista_cliente.primer_nombre }} {{ solicitud.entrevista_cliente.primer_apellido }}')" 
                              class="btn btn-outline-warning btn-sm d-flex align-items-center justify-content-center" 
                              style="min-width: 80px; height: 32px;"
                              title="Enviar al Sistema Core APPX">
                        <i class="fa-solid fa-paper-plane me-1"></i>
                        <span>APPX</span>
                      </button>
                      <a href="{% url 'descargar_entrevista_pdf' solicitud.entrevista_cliente.id %}" 
                         class="btn btn-outline-danger btn-sm d-flex align-items-center justify-content-center" 
                         style="min-width: 80px; height: 32px;"
                         title="Descargar entrevista en PDF">
                        <i class="fa-solid fa-file-pdf me-1"></i>
                        <span>PDF</span>
                      </a>
                    </div>
                  </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-user-edit text-info me-3" style="font-size: 1.5rem;"></i>
                    <div>
                      <strong>Asociar Entrevista de Cliente</strong><br />
                      <small>Vincule los datos generales del cliente con esta solicitud.</small>
                    </div>
                    <div class="ms-auto">
                      <button type="button" class="btn btn-outline-info btn-sm" onclick="mostrarModalEntrevista()">
                        <i class="fas fa-link me-1"></i> Asociar
                      </button>
                    </div>
                  </div>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong>Sin Archivos Espec√≠ficos</strong><br />
                  No hay archivos espec√≠ficos requeridos para esta etapa.
                </div>
                {% endif %}
                {% endwith %}
                {% else %}
                <div class="alert alert-secondary">
                  <i class="fas fa-file-alt me-2"></i>
                  <strong>Configuraci√≥n Pendiente</strong><br />
                  Los requisitos para esta etapa a√∫n no han sido configurados.
                </div>
                {% endif %}

                <div class="action-buttons">
                  <button class="btn btn-primary me-2" onclick="refreshFiles({{ subestado.id }})">
                    <i class="fas fa-sync me-1"></i>Actualizar Estado
                  </button>
                  <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAvanzarEtapa">
                    <i class="fas fa-arrow-right me-1"></i>
                    Avanzar Etapa
                  </button>
                </div>
              </div>
            </div>
            {% empty %}
            <div class="tab-pane fade show active">
              <div class="subestado-content-modern">
                <div class="alert alert-warning text-center">
                  <div class="subestado-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                  </div>
                  <h3 class="subestado-title">Sin Procesos Configurados</h3>
                  <p class="subestado-description">
                    No hay subestados configurados para esta etapa de Back Office.
                  </p>
                  <div class="action-buttons">
                    <button class="btn btn-outline-primary">
                      <i class="fas fa-cog me-1"></i>Configurar Procesos
                    </button>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Barra de Progreso del Workflow -->
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-chart-line"></i> Progreso del Workflow
          </h5>
        </div>
        <div class="card-body">
          <div class="workflow-progress">
            <div class="progress-info mb-3">
              <div class="d-flex justify-content-between">
                <span class="fw-bold">Progreso Actual</span>
                <span class="text-muted">{{ solicitud.subestado_actual.orden|default:1 }} de {{ solicitud.etapa_actual.subestados.count }}
                  procesos</span>
              </div>
            </div>
            <div class="progress progress-custom mb-3">
              <div class="progress-bar bg-success" role="progressbar"
                style="width: {% widthratio solicitud.subestado_actual.orden|default:1 solicitud.etapa_actual.subestados.count 100 %}%"
                aria-valuenow="{% widthratio solicitud.subestado_actual.orden|default:1 solicitud.etapa_actual.subestados.count 100 %}" aria-valuemin="0"
                aria-valuemax="100"></div>
            </div>
            <div class="progress-steps">
              {% for subestado in solicitud.etapa_actual.subestados.all %}
              <div class="step-item {% if subestado.id == solicitud.subestado_actual.id %}active{% elif subestado.orden < solicitud.subestado_actual.orden %}completed{% endif %}">
                <div class="step-circle">
                  {% if subestado.id == solicitud.subestado_actual.id %}
                  <i class="fas fa-check"></i>
                  {% elif subestado.orden < solicitud.subestado_actual.orden %}
                  <i class="fas fa-check"></i>
                  {% else %} 
                  {{ forloop.counter }} 
                  {% endif %}
                </div>
                <div class="step-label">
                  {{ subestado.nombre|truncatechars:20 }}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Informaci√≥n Adicional -->
      <div class="row mt-4">
        <div class="col-lg-6 col-md-12 mb-3">
          <div class="card info-card">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-clock"></i> Tiempo de Procesamiento
              </h6>
            </div>
            <div class="card-body">
              <div class="time-info">
                <div class="time-item">
                  <div class="time-label">Tiempo Transcurrido</div>
                  <div class="time-value">
                    {{ solicitud.fecha_creacion|timesince }}
                  </div>
                </div>
                <div class="time-item">
                  <div class="time-label">√öltima Actualizaci√≥n</div>
                  <div class="time-value">
                    {{ solicitud.fecha_actualizacion|timesince }} atr√°s
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6 col-md-12 mb-3">
          <div class="card info-card">
            <div class="card-header">
              <h6 class="mb-0"><i class="fas fa-users"></i> Equipo Asignado</h6>
            </div>
            <div class="card-body">
              <div class="team-info">
                <div class="team-member">
                  <div class="member-avatar">
                    <i class="fas fa-user"></i>
                  </div>
                  <div class="member-details">
                    <div class="member-name">
                      {{ solicitud.asignado_a|default:"Sin asignar" }}
                    </div>
                    <div class="member-role">Analista Back Office</div>
                  </div>
                </div>
                <div class="team-stats">
                  <small class="text-muted">
                    <i class="fas fa-building me-1"></i>Departamento: Back
                    Office
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Funciones JavaScript para el backoffice
  function refreshFiles(subestadoId) {
    console.log('Actualizando archivos para subestado:', subestadoId);

    // Mostrar spinner de carga
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualizando...';
    button.disabled = true;

    // Simular actualizaci√≥n (en implementaci√≥n real ser√≠a una llamada AJAX)
    setTimeout(() => {
      button.innerHTML = originalText;
      button.disabled = false;

      // Mostrar notificaci√≥n de √©xito
      showToast('Estado de archivos actualizado correctamente', 'success');

      // Recargar la p√°gina para mostrar datos actualizados
      location.reload();
    }, 2000);
  }

  function generateReport(subestadoId) {
    console.log('Generando reporte para subestado:', subestadoId);

    // Mostrar spinner de carga
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando...';
    button.disabled = true;

    // Simular generaci√≥n de reporte
    setTimeout(() => {
      button.innerHTML = originalText;
      button.disabled = false;

      showToast('Reporte generado y descargado', 'success');
    }, 3000);
  }

  function showToast(message, type = 'info') {
    // Crear toast notification
    const toastContainer = document.getElementById('toast-container') || createToastContainer();

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toast);

    // Mostrar toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // Remover toast despu√©s de que se oculte
    toast.addEventListener('hidden.bs.toast', () => {
      toast.remove();
    });
  }

  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
  }

  // Inicializaci√≥n cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function () {
    console.log('üîß Backoffice con visualizaci√≥n de archivos inicializado');

    // Aplicar validaci√≥n secuencial a las pesta√±as
    aplicarValidacionSecuencialTabs();

    // Agregar tooltips a los botones de archivo
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Agregar hover effects a las cards de archivo
    const archivoCards = document.querySelectorAll('.archivo-card');
    archivoCards.forEach(card => {
      card.addEventListener('mouseenter', function () {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 8px 25px rgba(74, 124, 89, 0.15)';
      });

      card.addEventListener('mouseleave', function () {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.05)';
      });
    });
  });

  // =======================================================
  // VALIDACI√ìN SECUENCIAL PARA PESTA√ëAS
  // =======================================================

  function aplicarValidacionSecuencialTabs() {
    const subestadoActualId = {{ solicitud.subestado_actual.id|default:"null" }};
    const subestadoActualOrden = {{ solicitud.subestado_actual.orden|default:"1" }};
    
    console.log('Aplicando validaci√≥n secuencial a pesta√±as');
    console.log('Subestado actual ID:', subestadoActualId);
    console.log('Subestado actual orden:', subestadoActualOrden);

    const tabs = document.querySelectorAll('#backoffice-tabs .nav-link.tab-modern');
    
    tabs.forEach(tab => {
      const subestadoId = parseInt(tab.getAttribute('data-subestado-id'));
      const subestadoOrden = parseInt(tab.getAttribute('data-subestado-orden'));
      
      if (!subestadoId || !subestadoOrden) return;
      
      console.log(`Procesando tab: ID=${subestadoId}, Orden=${subestadoOrden}`);
      
      // Determinar el estado de la pesta√±a
      const esActual = subestadoId === subestadoActualId;
      const esCompletado = subestadoOrden < subestadoActualOrden;
      const esDisponible = subestadoOrden === subestadoActualOrden + 1;
      const esBloqueado = subestadoOrden > subestadoActualOrden + 1;
      
      console.log(`Tab ${subestadoOrden}: actual=${esActual}, completado=${esCompletado}, disponible=${esDisponible}, bloqueado=${esBloqueado}`);
      
      // Limpiar clases previas
      tab.classList.remove('tab-blocked', 'tab-available', 'tab-completed');
      
      // Remover listeners previos para evitar duplicados
      tab.removeEventListener('click', bloquearClickInvalido);
      tab.removeEventListener('shown.bs.tab', manejarCambioTab);
      tab.removeEventListener('shown.bs.tab', manejarRetrocesoTab);
      
      // Aplicar estilos seg√∫n el estado
      if (esActual) {
        // Pesta√±a actual - mantener estilo activo
        console.log(`Tab ${subestadoOrden}: Configurado como ACTUAL`);
        tab.setAttribute('data-tab-state', 'actual');
      } else if (esCompletado) {
        // Pesta√±as completadas - permitir acceso COMPLETO (navegaci√≥n libre)
        tab.classList.add('tab-completed');
        tab.setAttribute('data-tab-state', 'completado');
        
        // Mantener funcionalidad de Bootstrap para pesta√±as completadas (NAVEGACI√ìN LIBRE)
        tab.setAttribute('data-bs-toggle', 'tab');
        tab.setAttribute('data-bs-target', `#content-${subestadoId}`);
        tab.removeAttribute('tabindex');
        
        const statusSpan = tab.querySelector('.tab-status');
        if (statusSpan) {
          statusSpan.textContent = 'Completado';
        }
        
        // Agregar listener para manejar retrocesos autom√°ticos
        tab.addEventListener('shown.bs.tab', manejarRetrocesoTab);
        console.log(`Tab ${subestadoOrden}: Configurado como COMPLETADO (navegaci√≥n libre)`);
      } else if (esDisponible) {
        // Siguiente pesta√±a disponible - destacar y permitir avance
        tab.classList.add('tab-available');
        tab.setAttribute('data-tab-state', 'disponible');
        
        // Mantener funcionalidad de Bootstrap pero agregar handler personalizado
        tab.setAttribute('data-bs-toggle', 'tab');
        tab.setAttribute('data-bs-target', `#content-${subestadoId}`);
        tab.removeAttribute('tabindex');
        
        const statusSpan = tab.querySelector('.tab-status');
        if (statusSpan) {
          statusSpan.textContent = 'Disponible';
        }
        
        // Agregar listener para manejar el avance autom√°tico
        tab.addEventListener('shown.bs.tab', manejarCambioTab);
        console.log(`Tab ${subestadoOrden}: Configurado como DISPONIBLE`);
      } else if (esBloqueado) {
        // Pesta√±as bloqueadas - SOLO para avanzar m√°s all√° de lo permitido
        tab.classList.add('tab-blocked');
        tab.setAttribute('aria-disabled', 'true');
        tab.setAttribute('title', 'No puede avanzar m√°s all√° del siguiente subestado disponible');
        tab.setAttribute('data-tab-state', 'bloqueado');
        
        // Deshabilitar funcionalidad de Bootstrap
        tab.removeAttribute('data-bs-toggle');
        tab.removeAttribute('data-bs-target');
        tab.setAttribute('tabindex', '-1');
        tab.setAttribute('role', 'button');
        
        const statusSpan = tab.querySelector('.tab-status');
        if (statusSpan) {
          statusSpan.textContent = 'Bloqueado';
        }
        
        // Agregar evento para bloquear clicks inv√°lidos
        tab.addEventListener('click', bloquearClickInvalido);
        
        console.log(`Tab ${subestadoOrden}: Configurado como BLOQUEADO`);
      }
    });
  }

  // Funci√≥n para bloquear clicks en pesta√±as no disponibles
  function bloquearClickInvalido(e) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    
    const tab = e.currentTarget;
    const tabState = tab.getAttribute('data-tab-state');
    const subestadoOrden = tab.getAttribute('data-subestado-orden');
    
    if (tabState === 'bloqueado') {
      // Mostrar tooltip personalizado en la posici√≥n del click
      mostrarTooltipBloqueo(e, `Etapa ${subestadoOrden} bloqueada. No puede avanzar m√°s all√° del siguiente subestado disponible.`);
      
      // Tambi√©n mostrar mensaje general
      mostrarMensaje('No puede avanzar m√°s all√° del siguiente subestado disponible. Complete primero la etapa actual.', 'warning');
    }
    
    return false;
  }

  // Funci√≥n para mostrar tooltip de bloqueo
  function mostrarTooltipBloqueo(event, mensaje) {
    // Remover tooltip anterior si existe
    const tooltipAnterior = document.querySelector('.tab-blocked-tooltip');
    if (tooltipAnterior) {
      tooltipAnterior.remove();
    }
    
    // Crear nuevo tooltip
    const tooltip = document.createElement('div');
    tooltip.className = 'tab-blocked-tooltip';
    tooltip.textContent = mensaje;
    
    // Posicionar tooltip
    tooltip.style.position = 'fixed';
    tooltip.style.left = event.clientX + 'px';
    tooltip.style.top = (event.clientY - 40) + 'px';
    tooltip.style.zIndex = '9999';
    
    document.body.appendChild(tooltip);
    
    // Mostrar tooltip con animaci√≥n
    setTimeout(() => {
      tooltip.classList.add('show');
    }, 10);
    
    // Remover tooltip despu√©s de 3 segundos
    setTimeout(() => {
      if (tooltip.parentNode) {
        tooltip.classList.remove('show');
        setTimeout(() => {
          if (tooltip.parentNode) {
            tooltip.remove();
          }
        }, 300);
      }
    }, 3000);
  }

  // Funci√≥n para manejar cambio de pesta√±a disponible
  function manejarCambioTab(e) {
    const tab = e.target;
    const subestadoId = parseInt(tab.getAttribute('data-subestado-id'));
    const tabState = tab.getAttribute('data-tab-state');
    
    console.log(`Cambio de tab detectado: ID=${subestadoId}, Estado=${tabState}`);
    
    if (tabState === 'disponible' && subestadoId) {
      // Avanzar autom√°ticamente al subestado cuando se hace clic en pesta√±a disponible
      console.log(`Avanzando autom√°ticamente al subestado ${subestadoId}`);
      avanzarSubestadoAutomatico(subestadoId);
    }
  }

  // Funci√≥n para manejar clicks en pesta√±as completadas (retrocesos)
  function manejarRetrocesoTab(e) {
    const tab = e.target;
    const subestadoId = parseInt(tab.getAttribute('data-subestado-id'));
    const tabState = tab.getAttribute('data-tab-state');
    
    console.log(`Retroceso de tab detectado: ID=${subestadoId}, Estado=${tabState}`);
    
    if (tabState === 'completado' && subestadoId) {
      // Retroceder autom√°ticamente al subestado cuando se hace clic en pesta√±a completada
      console.log(`Retrocediendo autom√°ticamente al subestado ${subestadoId}`);
      avanzarSubestadoAutomatico(subestadoId, 'retroceso');
    }
  }

  // Funci√≥n para avanzar subestado autom√°ticamente desde pesta√±a
  async function avanzarSubestadoAutomatico(subestadoId, accion = 'avance') {
    const solicitudId = {{ solicitud.id }};
    
    console.log(`Navegaci√≥n autom√°tica (${accion}): solicitud=${solicitudId}, subestado=${subestadoId}`);
    
    try {
      const response = await fetch(`/workflow/api/avanzar-subestado/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          solicitud_id: solicitudId,
          subestado_id: subestadoId
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        console.log(`${accion} autom√°tico exitoso`);
        const mensajeAccion = accion === 'retroceso' ? 'Retrocediendo a subestado anterior...' : 'Avanzando al siguiente subestado...';
        mostrarMensaje(data.message || mensajeAccion, 'success');
        
        // Actualizar pesta√±as y recargar despu√©s de un breve delay
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        console.error(`Error en ${accion} autom√°tico:`, data.message);
        mostrarMensaje(data.message || `Error al ${accion === 'retroceso' ? 'retroceder' : 'avanzar'} subestado`, 'error');
        
        // Volver a la pesta√±a anterior
        const pesta√±aActual = document.querySelector('#backoffice-tabs .nav-link.active');
        if (pesta√±aActual) {
          const tab = new bootstrap.Tab(pesta√±aActual);
          tab.show();
        }
      }
    } catch (error) {
      console.error(`Error de conexi√≥n en ${accion} autom√°tico:`, error);
      mostrarMensaje(`Error de conexi√≥n al ${accion === 'retroceso' ? 'retroceder' : 'avanzar'} subestado`, 'error');
      
      // Volver a la pesta√±a anterior
      const pesta√±aActual = document.querySelector('#backoffice-tabs .nav-link.active');
      if (pesta√±aActual) {
        const tab = new bootstrap.Tab(pesta√±aActual);
        tab.show();
      }
    }
  }

  // Funci√≥n para actualizar las pesta√±as despu√©s de avanzar subestado
  function actualizarPestanasSecuenciales() {
    setTimeout(() => {
      aplicarValidacionSecuencialTabs();
    }, 100);
  }

  // =======================================================
  // FUNCIONALIDAD DE CALIFICACI√ìN DE DOCUMENTOS
  // =======================================================

  // Variables globales
  let currentRequisitoId = null;

  // Funci√≥n para verificar y preservar estados de botones
  function preservarEstadosBotones() {
    console.log('üîÑ Preservando estados de botones...');
    
    // Recorrer todas las cards de requisitos
    const cards = document.querySelectorAll('.card[data-requisito-id]');
    console.log(`üìã Encontradas ${cards.length} cards para preservar estados`);
    
    cards.forEach(card => {
      const requisitoId = card.getAttribute('data-requisito-id');
      console.log(`üîç Verificando estado para requisito ${requisitoId}`);
      
      // Buscar todos los botones de calificaci√≥n en esta card
      const botonesBueno = card.querySelectorAll('.calificar-btn-backoffice[data-estado="bueno"]');
      const botonesMalo = card.querySelectorAll('.calificar-btn-backoffice[data-estado="malo"]');
      
      console.log(`üìä Requisito ${requisitoId}: ${botonesBueno.length} botones buenos, ${botonesMalo.length} botones malos`);
      
      // Verificar si debe estar marcado como bueno o malo basado en el estado guardado
      // Esta funci√≥n se ejecutar√° despu√©s de que actualizarEstadoCalificacion haya hecho su trabajo
      setTimeout(() => {
        const botonesActivos = card.querySelectorAll('.calificar-btn-backoffice.activo');
        console.log(`‚ú® Requisito ${requisitoId}: ${botonesActivos.length} botones con clase activo despu√©s de delay`);
        
        botonesActivos.forEach(btn => {
          const estado = btn.dataset.estado;
          console.log(`üéØ Bot√≥n ${estado} mantiene clase activo para requisito ${requisitoId}`);
        });
      }, 50);
    });
  }

  // Funci√≥n para calificar documento
  function calificarDocumento(requisitoId, estado, opcionId = null) {
    console.log(`Calificando documento: requisitoId=${requisitoId}, estado=${estado}, opcionId=${opcionId}`);
    
    const data = {
      requisito_solicitud_id: requisitoId,
      estado: estado,
      opcion_desplegable_id: opcionId
    };

    fetch('/workflow/api/documento/calificar/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify(data)
    })
      .then(response => {
        console.log('Respuesta del servidor calificar:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Datos recibidos de calificaci√≥n:', data);
        if (data.success) {
          // Actualizar interfaz
          console.log('Llamando a actualizarEstadoCalificacion...');
          actualizarEstadoCalificacion(requisitoId, estado, data.data || { usuario: 'Usuario actual' });
          
          // Preservar estado despu√©s de un breve delay
          setTimeout(() => {
            console.log('Preservando estado despu√©s de calificaci√≥n...');
            preservarEstadosBotones();
          }, 100);
          
          mostrarMensaje('Calificaci√≥n guardada exitosamente', 'success');
        } else {
          mostrarMensaje('Error al guardar calificaci√≥n: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('Error en calificarDocumento:', error);
        mostrarMensaje('Error de conexi√≥n', 'error');
      });
  }

  // Funci√≥n para agregar comentario
  function agregarComentario(requisitoId, comentario) {
    const data = {
      requisito_solicitud_id: requisitoId,
      comentario: comentario
    };

    fetch('/workflow/api/documento/comentar/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar modal de comentarios
          actualizarModalComentarios(requisitoId);
          mostrarMensaje('Comentario agregado exitosamente', 'success');
        } else {
          mostrarMensaje('Error al agregar comentario: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error de conexi√≥n', 'error');
      });
  }

  // Funci√≥n para obtener comentarios
  function obtenerComentarios(requisitoId) {
    return fetch(`/workflow/api/documento/${requisitoId}/comentarios/`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          return data.data;
        } else {
          throw new Error(data.error);
        }
      });
  }

  // Funci√≥n para actualizar estado de calificaci√≥n en la interfaz
  function actualizarEstadoCalificacion(requisitoId, estado, data) {
    console.log(`üéØ Actualizando estado: requisito=${requisitoId}, estado=${estado}`);
    
    if (!requisitoId) {
      console.warn('‚ö†Ô∏è requisitoId es null o undefined');
      return;
    }

    const card = document.querySelector(`[data-requisito-id="${requisitoId}"]`);
    if (!card) {
      console.warn(`‚ö†Ô∏è No se encontr√≥ la card para el requisito ${requisitoId}`);
      return;
    }

    console.log(`‚úÖ Card encontrada para requisito ${requisitoId}`);

    // Actualizar botones de calificaci√≥n
    const botones = card.querySelectorAll('.calificar-btn-backoffice');
    console.log(`üîò Encontrados ${botones.length} botones de calificaci√≥n`);

    botones.forEach((btn, index) => {
      const btnEstado = btn.dataset.estado;
      const esteEsElBotonActivo = btnEstado === estado;
      
      console.log(`üîò Bot√≥n ${index + 1}: estado="${btnEstado}", debe estar activo: ${esteEsElBotonActivo}`);
      
      // Limpiar estado anterior
      btn.classList.remove('activo');
      
      // Activar solo el bot√≥n correspondiente
      if (esteEsElBotonActivo) {
        btn.classList.add('activo');
        console.log(`‚ú® Clase 'activo' agregada al bot√≥n ${btnEstado}`);
        
        // Forzar estilo inline para asegurar que se vea - M√ÅS FUERTE
        if (estado === 'bueno') {
          btn.style.backgroundColor = '#198754 !important';
          btn.style.borderColor = '#198754 !important';
          btn.style.color = 'white !important';
          btn.style.fontWeight = 'bold';
          btn.style.boxShadow = '0 0 10px rgba(25, 135, 84, 0.5)';
        } else {
          btn.style.backgroundColor = '#dc3545 !important';
          btn.style.borderColor = '#dc3545 !important';
          btn.style.color = 'white !important';
          btn.style.fontWeight = 'bold';
          btn.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.5)';
        }
        
        // FORZAR que se mantenga as√≠ para siempre
        btn.setAttribute('data-calificado', estado);
        
        // Verificar que la clase se agreg√≥ correctamente
        setTimeout(() => {
          const tieneActivo = btn.classList.contains('activo');
          console.log(`üîç Verificaci√≥n: bot√≥n ${btnEstado} tiene clase activo: ${tieneActivo}`);
          console.log(`üìù Clases finales del bot√≥n: ${btn.className}`);
        }, 10);
      } else {
        // Resetear estilo para botones no activos
        btn.style.backgroundColor = '';
        btn.style.borderColor = '';
        btn.style.color = '';
      }
    });

    console.log(`üèÅ Estado visual actualizado para requisito ${requisitoId}`);
  }

  // Funci√≥n para actualizar modal de comentarios
  function actualizarModalComentarios(requisitoId) {
    obtenerComentarios(requisitoId)
      .then(comentarios => {
        const comentariosContainer = document.getElementById('comentarios-container');
        if (!comentariosContainer) return;

        comentariosContainer.innerHTML = '';

        if (comentarios.length === 0) {
          comentariosContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comment-slash fa-2x mb-2"></i>
                        <p>No hay comentarios a√∫n</p>
                    </div>
                `;
          return;
        }

        comentarios.forEach(comentario => {
          const comentarioDiv = document.createElement('div');
          comentarioDiv.className = 'comentario-item';

          // Obtener informaci√≥n adicional del contexto
          const solicitudCodigo = '{{ solicitud.codigo|default:"Sin c√≥digo" }}';

          // Usar la informaci√≥n que viene del backend
          const currentEtapa = comentario.etapa || 'Sin etapa';
          const currentSubestado = comentario.subestado || 'Sin subestado';

          // Calcular tiempo transcurrido
          const fechaComentario = new Date(comentario.fecha);
          const ahora = new Date();
          const diffMs = ahora - fechaComentario;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);

          let tiempoTranscurrido = '';
          if (diffDays > 0) {
            tiempoTranscurrido = `hace ${diffDays} d√≠a${diffDays > 1 ? 's' : ''}`;
          } else if (diffHours > 0) {
            tiempoTranscurrido = `hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
          } else if (diffMins > 0) {
            tiempoTranscurrido = `hace ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
          } else {
            tiempoTranscurrido = 'hace unos segundos';
          }

          comentarioDiv.innerHTML = `
                    <div class="comentario-header">
                        <div class="comentario-info-principal">
                            <div class="comentario-autor-info">
                                <div class="comentario-avatar">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="comentario-details">
                                    <div class="comentario-autor">${comentario.usuario_nombre}</div>
                                    <div class="comentario-meta">
                                        <span class="comentario-etapa">
                                            <i class="fas fa-layer-group me-1"></i>
                                            ${currentEtapa}
                                        </span>
                                        <span class="comentario-subestado">
                                            <i class="fas fa-tag me-1"></i>
                                            ${currentSubestado}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="comentario-tiempo">
                                <div class="comentario-fecha">${comentario.fecha}</div>
                                <div class="comentario-tiempo-transcurrido">${tiempoTranscurrido}</div>
                            </div>
                        </div>
                        ${comentario.puede_editar ? `
                            <div class="comentario-acciones">
                                <button class="btn btn-sm btn-outline-primary btn-editar-comentario" 
                                        onclick="editarComentario(${comentario.id}, '${comentario.comentario}')"
                                        title="Editar comentario">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="comentario-content">
                        <div class="comentario-texto">${comentario.comentario}</div>
                        <div class="comentario-footer">
                            <div class="comentario-solicitud">
                                <i class="fas fa-file-alt me-1"></i>
                                Solicitud: ${solicitudCodigo}
                            </div>
                            <div class="comentario-id">
                                <i class="fas fa-hashtag me-1"></i>
                                Comentario #${comentario.id}
                            </div>
                        </div>
                    </div>
                `;
          comentariosContainer.appendChild(comentarioDiv);
        });

        // Actualizar contador de comentarios en el bot√≥n
        const comentarioBtn = document.querySelector(`[data-requisito="${requisitoId}"].comentario-btn-backoffice`);
        if (comentarioBtn) {
          const badge = comentarioBtn.querySelector('.badge');
          if (badge) {
            badge.textContent = comentarios.length;
          }
        }
      })
      .catch(error => {
        console.error('Error al obtener comentarios:', error);
      });
  }

  // Funci√≥n para mostrar modal de comentarios
  function mostrarModalComentarios(requisitoId) {
    currentRequisitoId = requisitoId;

    // Actualizar contenido del modal
    actualizarModalComentarios(requisitoId);

    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalComentarios'));
    modal.show();
  }

  // Funci√≥n para cargar estados iniciales de calificaciones
  function cargarEstadosInicialesCalificaciones() {
    console.log('Cargando estados iniciales de calificaciones...');

    // Obtener todos los requisitos que tienen calificaciones
    const requisitos = document.querySelectorAll('[data-requisito-id]');
    console.log(`Encontrados ${requisitos.length} requisitos con data-requisito-id`);

    requisitos.forEach(requisito => {
      const requisitoId = requisito.getAttribute('data-requisito-id');
      console.log(`Procesando requisito ID: ${requisitoId}`);
      
      if (requisitoId && requisitoId !== 'null' && requisitoId !== 'undefined') {
        // Validar que el ID sea un n√∫mero v√°lido
        const numericId = parseInt(requisitoId);
        if (isNaN(numericId) || numericId <= 0) {
          console.warn(`ID de requisito inv√°lido: ${requisitoId}`);
          return;
        }
        
        // Obtener calificaciones para este requisito
        fetch(`/workflow/api/documento/${requisitoId}/calificaciones/`)
          .then(response => {
            console.log(`Respuesta para requisito ${requisitoId}: status ${response.status}`);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log(`Datos recibidos para requisito ${requisitoId}:`, data);
            if (data.success && data.data && data.data.length > 0) {
              // Tomar la calificaci√≥n m√°s reciente
              const ultimaCalificacion = data.data[0];
              console.log(`Calificaci√≥n encontrada para requisito ${requisitoId}:`, ultimaCalificacion);

              // Actualizar el estado visual
              actualizarEstadoCalificacion(requisitoId, ultimaCalificacion.estado, {
                usuario: ultimaCalificacion.usuario_nombre || 'Usuario'
              });
            } else {
              console.log(`No hay calificaciones para requisito ${requisitoId}`);
            }
          })
          .catch(error => {
            console.error(`Error al cargar calificaciones para requisito ${requisitoId}:`, error);
            // No mostrar mensaje de error al usuario para evitar spam de errores
            // Solo loggear en consola para debugging
          });
      } else {
        console.warn(`RequisitoId inv√°lido o vac√≠o: ${requisitoId}`);
      }
    });
    
    // Preservar estados despu√©s de cargar todos los requisitos
    setTimeout(() => {
      console.log('Preservando estados despu√©s de cargar todos los requisitos...');
      preservarEstadosBotones();
    }, 500);
  }

  // Funci√≥n para obtener CSRF token
  function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  // Funci√≥n para mostrar mensajes
  function mostrarMensaje(mensaje, tipo) {
    // Crear elemento de alerta
    const alertDiv = document.createElement('div');
    let alertClass = 'alert alert-dismissible fade show';
    let iconClass = '';
    
    switch(tipo) {
      case 'success':
        alertClass += ' alert-success';
        iconClass = 'fas fa-check-circle';
        break;
      case 'warning':
        alertClass += ' alert-warning';
        iconClass = 'fas fa-exclamation-triangle';
        break;
      case 'info':
        alertClass += ' alert-info';
        iconClass = 'fas fa-info-circle';
        break;
      case 'error':
      default:
        alertClass += ' alert-danger';
        iconClass = 'fas fa-exclamation-circle';
        break;
    }
    
    alertDiv.className = alertClass;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.maxWidth = '400px';
    alertDiv.innerHTML = `
        <i class="${iconClass} me-2"></i>${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // Auto-remover despu√©s de 5 segundos para warnings, 3 para otros
    const timeout = tipo === 'warning' ? 5000 : 3000;
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, timeout);
  }

  // Event listeners cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function () {
    // Cargar estados iniciales de calificaciones
    cargarEstadosInicialesCalificaciones();

    // VERIFICAR Y MARCAR BOTONES QUE YA EST√ÅN CALIFICADOS
    setTimeout(() => {
      const todosBotones = document.querySelectorAll('.calificar-btn-backoffice[data-calificado]');
      console.log(`üîç Encontrados ${todosBotones.length} botones que deber√≠an estar marcados`);
      
      todosBotones.forEach(btn => {
        const estado = btn.getAttribute('data-calificado');
        console.log(`üéØ Forzando estilo para bot√≥n ${estado}`);
        
        if (estado === 'bueno') {
          btn.style.backgroundColor = '#198754 !important';
          btn.style.borderColor = '#198754 !important';
          btn.style.color = 'white !important';
          btn.style.fontWeight = 'bold';
          btn.style.boxShadow = '0 0 10px rgba(25, 135, 84, 0.5)';
        } else if (estado === 'malo') {
          btn.style.backgroundColor = '#dc3545 !important';
          btn.style.borderColor = '#dc3545 !important';
          btn.style.color = 'white !important';
          btn.style.fontWeight = 'bold';
          btn.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.5)';
        }
      });
    }, 1000);

    // Botones de calificaci√≥n
    document.addEventListener('click', function (e) {
      if (e.target.closest('.calificar-btn-backoffice')) {
        const btn = e.target.closest('.calificar-btn-backoffice');
        const requisitoId = btn.dataset.requisito;
        const estado = btn.dataset.estado;

        if (requisitoId && estado && !btn.disabled) {
          calificarDocumento(requisitoId, estado);
        } else if (!requisitoId) {
          mostrarMensaje('No se puede calificar: archivo no subido todav√≠a', 'warning');
        }
      }

      // Bot√≥n de comentarios
      if (e.target.closest('.comentario-btn-backoffice')) {
        const btn = e.target.closest('.comentario-btn-backoffice');
        const requisitoId = btn.dataset.requisito;

        if (requisitoId && !btn.disabled) {
          mostrarModalComentarios(requisitoId);
        } else if (!requisitoId) {
          mostrarMensaje('No se pueden agregar comentarios: archivo no subido todav√≠a', 'warning');
        }
      }

    });

    // Formulario de nuevo comentario
    const formComentario = document.getElementById('form-nuevo-comentario');
    if (formComentario) {
      formComentario.addEventListener('submit', function (e) {
        e.preventDefault();

        const textarea = this.querySelector('textarea[name="comentario"]');
        const comentario = textarea.value.trim();

        if (comentario && currentRequisitoId) {
          agregarComentario(currentRequisitoId, comentario);
          textarea.value = '';
        }
      });
    }

    // Modal Avanzar Etapa
    const modalAvanzarEtapa = document.getElementById('modalAvanzarEtapa');
    if (modalAvanzarEtapa) {
      modalAvanzarEtapa.addEventListener('show.bs.modal', function (event) {
        cargarOpcionesAvance();
      });
    }
  });

  // =======================================================
  // FUNCIONALIDAD DEL MODAL DE OPCIONES
  // =======================================================

  // Variable global para almacenar el requisito actual
  let currentRequisitoForOpciones = null;

  // Funci√≥n para mostrar el modal de opciones
  function mostrarModalOpciones(requisitoId, documentoNombre) {
    currentRequisitoForOpciones = requisitoId;

    // Actualizar el nombre del documento en el modal
    document.getElementById('opciones-documento-nombre').textContent = documentoNombre;

    // Cargar las opciones disponibles
    cargarOpcionesDisponibles();

    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalOpciones'));
    modal.show();
  }

  // Funci√≥n para cargar las opciones disponibles
  function cargarOpcionesDisponibles() {
    const opcionesContainer = document.getElementById('opciones-container');

    // Opciones predefinidas (puedes obtenerlas del backend si es necesario)
    const opciones = [
      { id: 1, nombre: 'Documento ilegible o borroso' },
      { id: 2, nombre: 'Documento incompleto o faltante' },
      { id: 3, nombre: 'Documento vencido o desactualizado' },
      { id: 4, nombre: 'Documento no corresponde al solicitado' },
      { id: 5, nombre: 'Documento con informaci√≥n incorrecta' },
      { id: 6, nombre: 'Documento de baja calidad' },
      { id: 7, nombre: 'Otro problema' }
    ];

    opcionesContainer.innerHTML = '';

    opciones.forEach(opcion => {
      const opcionDiv = document.createElement('div');
      opcionDiv.className = 'opcion-item-modal mb-2 p-3 border rounded cursor-pointer';
      opcionDiv.style.cursor = 'pointer';
      opcionDiv.style.transition = 'all 0.2s ease';
      opcionDiv.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fas fa-exclamation-circle text-warning me-3"></i>
          <div class="flex-grow-1">
            <strong>${opcion.nombre}</strong>
          </div>
          <i class="fas fa-chevron-right text-muted"></i>
        </div>
      `;

      // Agregar efectos hover
      opcionDiv.addEventListener('mouseenter', function () {
        this.style.backgroundColor = '#f8f9fa';
        this.style.borderColor = '#4a7c59';
      });

      opcionDiv.addEventListener('mouseleave', function () {
        this.style.backgroundColor = '';
        this.style.borderColor = '';
      });

      // Agregar evento click
      opcionDiv.addEventListener('click', function () {
        seleccionarOpcion(opcion.id, opcion.nombre);
      });

      opcionesContainer.appendChild(opcionDiv);
    });
  }

  // Funci√≥n para seleccionar una opci√≥n
  function seleccionarOpcion(opcionId, opcionNombre) {
    if (!currentRequisitoForOpciones) {
      console.error('No hay requisito seleccionado');
      return;
    }

    // Calificar como malo con la opci√≥n seleccionada
    calificarDocumento(currentRequisitoForOpciones, 'malo', opcionId);

    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalOpciones'));
    if (modal) {
      modal.hide();
    }

    // Mostrar mensaje de confirmaci√≥n
    mostrarMensaje(`Documento calificado como malo: ${opcionNombre}`, 'success');
  }

  // =====================================================
  // FUNCIONES PARA AVANZAR ETAPA
  // =====================================================

  async function cargarOpcionesAvance() {
    const solicitudId = {{ solicitud.id }};
    console.log('Cargando opciones de avance para solicitud:', solicitudId);
    
    try {
      // Cargar subestados disponibles
      console.log('Llamando a API de subestados...');
      const responseSubestados = await fetch(`/workflow/api/subestados-disponibles/${solicitudId}/`);
      console.log('Respuesta subestados status:', responseSubestados.status);
      const dataSubestados = await responseSubestados.json();
      console.log('Data subestados:', dataSubestados);
      
      // Cargar transiciones disponibles
      console.log('Llamando a API de transiciones...');
      const responseTransiciones = await fetch(`/workflow/api/transiciones-disponibles/${solicitudId}/`);
      console.log('Respuesta transiciones status:', responseTransiciones.status);
      const dataTransiciones = await responseTransiciones.json();
      console.log('Data transiciones:', dataTransiciones);
      
      // Renderizar opciones
      renderizarSubestados(dataSubestados);
      renderizarTransiciones(dataTransiciones);
      
    } catch (error) {
      console.error('Error cargando opciones de avance:', error);
      mostrarMensaje('Error al cargar las opciones de avance', 'error');
    }
  }

  function renderizarSubestados(data) {
    console.log('Renderizando subestados con validaci√≥n secuencial:', data);
    const container = document.getElementById('subestados-container');
    
    if (!data.success) {
      container.innerHTML = `<div class="alert alert-warning">${data.message || 'Error al cargar subestados'}</div>`;
      return;
    }
    
    if (!data.subestados || data.subestados.length === 0) {
      container.innerHTML = '<p class="text-muted">No hay subestados disponibles para avanzar.</p>';
      return;
    }
    
    let html = '';
    
    // Agregar informaci√≥n sobre validaci√≥n secuencial
    if (data.validacion_secuencial) {
      if (data.navegacion_libre_atras && data.bloqueo_solo_avance) {
        html += `
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Navegaci√≥n Flexible:</strong> Puedes retroceder a etapas completadas o avanzar al siguiente subestado disponible.
          </div>
        `;
      } else {
        html += `
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Navegaci√≥n Secuencial:</strong> Solo puedes avanzar al siguiente subestado en orden.
          </div>
        `;
      }
    }
    
    data.subestados.forEach(subestado => {
      const isActual = subestado.es_actual || subestado.id === data.subestado_actual_id;
      const esCompletado = subestado.es_completado;
      const puedeAvanzar = subestado.puede_avanzar;
      const estaBloqueado = subestado.esta_bloqueado;
      
      let cardClass = 'card mb-2';
      let btnClass = 'btn btn-sm';
      let btnText = '';
      let disabled = '';
      let statusBadge = '';
      let reasonMessage = '';
      
      if (isActual) {
        cardClass += ' border-success bg-light';
        btnClass += ' btn-outline-secondary';
        btnText = 'Actual';
        disabled = 'disabled';
        statusBadge = '<span class="badge bg-success ms-2">Actual</span>';
      } else if (esCompletado) {
        // Subestados completados - navegaci√≥n libre permitida
        cardClass += ' border-warning bg-light';
        btnClass += ' btn-warning';
        btnText = 'Regresar';
        statusBadge = '<span class="badge bg-warning ms-2">Completado</span>';
      } else if (puedeAvanzar) {
        // Siguiente subestado disponible
        cardClass += ' border-primary';
        btnClass += ' btn-primary';
        btnText = 'Avanzar';
        statusBadge = '<span class="badge bg-primary ms-2">Disponible</span>';
      } else if (estaBloqueado) {
        // Subestados bloqueados (saltos hacia adelante)
        cardClass += ' border-secondary';
        btnClass += ' btn-outline-secondary';
        btnText = 'Bloqueado';
        disabled = 'disabled';
        statusBadge = '<span class="badge bg-secondary ms-2">Bloqueado</span>';
        if (subestado.razon_bloqueado) {
          reasonMessage = `<small class="text-muted d-block mt-1"><i class="fas fa-lock me-1"></i>${subestado.razon_bloqueado}</small>`;
        }
      }
      
      html += `
        <div class="${cardClass}">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="flex-grow-1">
                <h6 class="mb-1">
                  <span class="badge bg-dark me-2">${subestado.orden}</span>
                  ${subestado.nombre}
                  ${statusBadge}
                </h6>
                ${isActual ? '<small class="text-success"><i class="fas fa-check-circle me-1"></i>Subestado activo actualmente</small>' : ''}
                ${esCompletado ? '<small class="text-warning"><i class="fas fa-undo me-1"></i>Puedes regresar a esta etapa completada</small>' : ''}
                ${puedeAvanzar && !isActual ? '<small class="text-primary"><i class="fas fa-arrow-right me-1"></i>Siguiente subestado disponible</small>' : ''}
                ${estaBloqueado ? '<small class="text-muted"><i class="fas fa-ban me-1"></i>No puede saltar a esta etapa</small>' : ''}
                ${reasonMessage}
              </div>
              <button class="${btnClass}" ${disabled} 
                      onclick="avanzarSubestado(${subestado.id})"
                      data-subestado-id="${subestado.id}"
                      title="${isActual ? 'Subestado actual' : esCompletado ? 'Regresar a esta etapa completada' : puedeAvanzar ? 'Avanzar a este subestado' : subestado.razon_bloqueado || 'No disponible'}">
                <i class="fas fa-${isActual ? 'check' : esCompletado ? 'undo' : puedeAvanzar ? 'arrow-right' : 'lock'} me-1"></i>${btnText}
              </button>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  function renderizarTransiciones(data) {
    console.log('Renderizando transiciones:', data);
    const container = document.getElementById('transiciones-container');
    
    if (!data.success) {
      container.innerHTML = `<div class="alert alert-warning">${data.message || 'Error al cargar transiciones'}</div>`;
      return;
    }
    
    if (!data.transiciones || data.transiciones.length === 0) {
      container.innerHTML = '<p class="text-muted">No hay transiciones disponibles.</p>';
      return;
    }
    
    let html = '';
    data.transiciones.forEach(transicion => {
      html += `
        <div class="card mb-2">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">${transicion.nombre}</h6>
                <small class="text-muted">
                  ${transicion.etapa_origen} ‚Üí ${transicion.etapa_destino}
                </small>
              </div>
              <button class="btn btn-sm btn-outline-success" 
                      onclick="ejecutarTransicion(${transicion.id})">
                <i class="fas fa-exchange-alt me-1"></i>Ejecutar
              </button>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  async function avanzarSubestado(subestadoId) {
    const solicitudId = {{ solicitud.id }};
    
    console.log(`Intentando avanzar subestado: solicitud=${solicitudId}, subestado=${subestadoId}`);
    
    try {
      // Deshabilitar todos los botones temporalmente
      const buttons = document.querySelectorAll('#subestados-container button');
      const targetButton = document.querySelector(`button[data-subestado-id="${subestadoId}"]`);
      
      buttons.forEach(btn => {
        btn.disabled = true;
      });

      if (targetButton) {
        targetButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
      }

      const response = await fetch(`/workflow/api/avanzar-subestado/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          solicitud_id: solicitudId,
          subestado_id: subestadoId
        })
      });
      
      console.log('Respuesta del servidor:', response.status);
      const data = await response.json();
      console.log('Data recibida:', data);
      
      if (data.success) {
        mostrarMensaje(data.message || 'Subestado avanzado correctamente', 'success');
        
        // Actualizar pesta√±as secuenciales
        actualizarPestanasSecuenciales();
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAvanzarEtapa'));
        if (modal) {
          modal.hide();
        }
        
        // Mostrar mensaje de recarga
        mostrarMensaje('Recargando p√°gina para reflejar los cambios...', 'info');
        
        // Recargar p√°gina despu√©s de un breve delay
        setTimeout(() => {
          console.log('Recargando p√°gina...');
          window.location.reload();
        }, 2000);
      } else {
        // Manejar diferentes tipos de errores
        let tipoMensaje = 'error';
        
        // Si es un error de validaci√≥n secuencial, usar tipo 'warning'
        if (data.message && (
          data.message.includes('secuencialmente') || 
          data.message.includes('siguiente subestado') ||
          data.message.includes('retroceder') ||
          data.message.includes('mismo subestado')
        )) {
          tipoMensaje = 'warning';
        }
        
        mostrarMensaje(data.message || 'Error al avanzar subestado', tipoMensaje);
        
        // Rehabilitar botones
        buttons.forEach(btn => {
          // Solo rehabilitar botones que no est√°n marcados como "actual"
          if (!btn.innerHTML.includes('Actual')) {
            btn.disabled = false;
          }
        });
        
        // Restaurar texto original del bot√≥n espec√≠fico
        if (targetButton && !targetButton.innerHTML.includes('Actual')) {
          const isBlocked = targetButton.innerHTML.includes('Bloqueado');
          if (isBlocked) {
            targetButton.innerHTML = '<i class="fas fa-lock me-1"></i>Bloqueado';
            targetButton.disabled = true;
          } else {
            targetButton.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Avanzar';
            targetButton.disabled = false;
          }
        }
      }
    } catch (error) {
      console.error('Error avanzando subestado:', error);
      mostrarMensaje('Error de conexi√≥n al avanzar subestado', 'error');
      
      // Rehabilitar botones en caso de error
      const buttons = document.querySelectorAll('#subestados-container button');
      buttons.forEach(btn => {
        if (!btn.innerHTML.includes('Actual')) {
          btn.disabled = false;
        }
      });
      
      if (targetButton && !targetButton.innerHTML.includes('Actual')) {
        targetButton.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Avanzar';
        targetButton.disabled = false;
      }
    }
  }

  async function ejecutarTransicion(transicionId) {
    const solicitudId = {{ solicitud.id }};
    
    try {
      const response = await fetch(`/workflow/api/ejecutar-transicion/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          solicitud_id: solicitudId,
          transicion_id: transicionId
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        mostrarMensaje('Transici√≥n ejecutada correctamente', 'success');
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAvanzarEtapa'));
        modal.hide();
        // Redirigir a la nueva etapa
        setTimeout(() => window.location.href = data.redirect_url || window.location.href, 1000);
      } else {
        mostrarMensaje(data.message || 'Error al ejecutar transici√≥n', 'error');
      }
    } catch (error) {
      console.error('Error ejecutando transici√≥n:', error);
      mostrarMensaje('Error al ejecutar transici√≥n', 'error');
    }
  }

  // =======================================================
  // FUNCIONALIDAD PARA ASOCIAR ENTREVISTA DE CLIENTE
  // =======================================================

  let entrevistaSeleccionadaId = null;

  function mostrarModalEntrevista() {
    const modal = new bootstrap.Modal(document.getElementById('modalAsociarEntrevista'));
    modal.show();
    // Limpiar b√∫squeda anterior
    document.getElementById('buscarEntrevista').value = '';
    document.getElementById('resultadosEntrevistas').innerHTML = '';
    document.getElementById('entrevistaSeleccionada').style.display = 'none';
    document.getElementById('btnConfirmarAsociacion').disabled = true;
    entrevistaSeleccionadaId = null;
  }

  function buscarEntrevistas() {
    const termino = document.getElementById('buscarEntrevista').value.trim();
    
    if (termino.length < 3) {
      document.getElementById('resultadosEntrevistas').innerHTML = 
        '<div class="text-muted">Escriba al menos 3 caracteres para buscar...</div>';
      return;
    }
    
    // Mostrar loading
    document.getElementById('resultadosEntrevistas').innerHTML = 
      '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';
    
    // Realizar b√∫squeda AJAX
    fetch(`/workflow/buscar-entrevistas/?q=${encodeURIComponent(termino)}`)
      .then(response => response.json())
      .then(data => {
        mostrarResultadosEntrevistas(data.entrevistas);
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('resultadosEntrevistas').innerHTML = 
          '<div class="alert alert-danger">Error al buscar entrevistas</div>';
      });
  }

  function mostrarResultadosEntrevistas(entrevistas) {
    const container = document.getElementById('resultadosEntrevistas');
    
    if (entrevistas.length === 0) {
      container.innerHTML = '<div class="text-muted">No se encontraron entrevistas</div>';
      return;
    }
    
    let html = '<div class="list-group">';
    entrevistas.forEach(entrevista => {
      html += `
        <div class="list-group-item list-group-item-action" onclick="seleccionarEntrevista(${entrevista.id}, '${entrevista.nombre_completo}')">
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1">${entrevista.nombre_completo}</h6>
            <small>${entrevista.fecha_entrevista}</small>
          </div>
          <p class="mb-1">
            <strong>C√©dula:</strong> ${entrevista.cedula} | 
            <strong>Email:</strong> ${entrevista.email} | 
            <strong>Tel√©fono:</strong> ${entrevista.telefono}
          </p>
          <small><strong>Producto:</strong> ${entrevista.tipo_producto}</small>
        </div>
      `;
    });
    html += '</div>';
    
    container.innerHTML = html;
  }

  function seleccionarEntrevista(id, nombre) {
    entrevistaSeleccionadaId = id;
    
    // Mostrar entrevista seleccionada
    document.getElementById('nombreEntrevistaSeleccionada').textContent = nombre;
    document.getElementById('entrevistaSeleccionada').style.display = 'block';
    
    // Habilitar bot√≥n de confirmaci√≥n
    document.getElementById('btnConfirmarAsociacion').disabled = false;
    
    // Resaltar selecci√≥n
    document.querySelectorAll('.list-group-item').forEach(item => {
      item.classList.remove('active');
    });
    event.target.closest('.list-group-item').classList.add('active');
  }

  function confirmarAsociacion() {
    if (!entrevistaSeleccionadaId) return;
    
    const solicitudId = {{ solicitud.id }};
    
    // Mostrar loading en el bot√≥n
    const btn = document.getElementById('btnConfirmarAsociacion');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Asociando...';
    btn.disabled = true;
    
    // Realizar asociaci√≥n AJAX
    fetch('/workflow/asociar-entrevista/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({
        solicitud_id: solicitudId,
        entrevista_id: entrevistaSeleccionadaId,
        accion: 'asociar'
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('modalAsociarEntrevista')).hide();
        
        // Mostrar mensaje de √©xito
        mostrarMensaje('Entrevista asociada correctamente', 'success');
        
        // Recargar la p√°gina para mostrar la entrevista asociada
        setTimeout(() => {
          location.reload();
        }, 1500);
        
      } else {
        mostrarMensaje(data.error || 'Error al asociar entrevista', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      mostrarMensaje('Error al asociar entrevista', 'error');
    })
    .finally(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  }

  function desasociarEntrevista() {
    const solicitudId = {{ solicitud.id }};
    
    if (!confirm('¬øEst√° seguro de que desea desasociar la entrevista de esta solicitud?')) {
      return;
    }
    
    fetch('/workflow/asociar-entrevista/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({
        solicitud_id: solicitudId,
        accion: 'desasociar'
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        mostrarMensaje('Entrevista desasociada correctamente', 'success');
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        mostrarMensaje(data.error || 'Error al desasociar entrevista', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      mostrarMensaje('Error al desasociar entrevista', 'error');
    });
  }

  function verDetallesEntrevista(entrevistaId) {
    // Abrir modal o p√°gina con detalles de la entrevista
    window.open(`/workflow/entrevista/${entrevistaId}/`, '_blank');
  }

  // Funci√≥n para devolver solicitud a bandeja grupal
  async function devolverABandejaGrupal() {
    const solicitudId = {{ solicitud.id }};
    
    console.log('Devolviendo solicitud a bandeja grupal:', solicitudId);
    
    // Confirmar acci√≥n con el usuario
    if (!confirm('¬øEst√°s seguro de que deseas devolver esta solicitud a la bandeja grupal?\n\nOtros usuarios podr√°n tomarla y continuar con el proceso.')) {
      return;
    }
    
    try {
      // Deshabilitar bot√≥n mientras se procesa
      const btn = document.getElementById('btn-devolver-bandeja');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Devolviendo...';
      
      const response = await fetch(`/workflow/api/devolver-bandeja-grupal/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          solicitud_id: solicitudId
        })
      });
      
      console.log('Respuesta devolver bandeja:', response.status);
      const data = await response.json();
      console.log('Data devolver bandeja:', data);
      
      if (data.success) {
        mostrarMensaje('Solicitud devuelta a bandeja grupal exitosamente', 'success');
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAvanzarEtapa'));
        if (modal) {
          modal.hide();
        }
        
        // Mostrar mensaje informativo
        mostrarMensaje('Redirigiendo a la bandeja grupal...', 'info');
        
        // Redirigir a la bandeja grupal despu√©s de un breve delay
        setTimeout(() => {
          // Redirigir a la vista de bandeja grupal o dashboard
          window.location.href = data.redirect_url || '/workflow/bandeja-grupal/';
        }, 2000);
        
      } else {
        mostrarMensaje(data.message || 'Error al devolver solicitud a bandeja grupal', 'error');
        
        // Rehabilitar bot√≥n
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
      
    } catch (error) {
      console.error('Error devolviendo a bandeja grupal:', error);
      mostrarMensaje('Error de conexi√≥n al devolver solicitud', 'error');
      
      // Rehabilitar bot√≥n en caso de error
      const btn = document.getElementById('btn-devolver-bandeja');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-share me-1"></i>Devolver a Bandeja Grupal';
    }
  }

  // =======================================================
  // FUNCIONALIDAD PARA ENVIAR ENTREVISTA A APPX
  // =======================================================

  // Funci√≥n para enviar entrevista a APPX
  function enviarAAAPX(entrevistaId, nombreCliente) {
    // Confirmar antes de enviar
    if (confirm(`¬øEst√° seguro que desea enviar la entrevista de ${nombreCliente} al sistema APPX Core?\n\nEsta acci√≥n enviar√° todos los datos de la entrevista al sistema central.`)) {
      
      // Deshabilitar el bot√≥n mientras se procesa
      const boton = event.target.closest('button');
      const textoOriginal = boton.innerHTML;
      boton.disabled = true;
      boton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
      
      // Obtener el token CSRF
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                       document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                       getCookie('csrftoken');
      
      // Hacer la petici√≥n AJAX
      fetch(`/workflow/api/entrevistas/${entrevistaId}/enviar-appx/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // √âxito
          alert(`‚úÖ √âXITO: ${data.message}\n\nTimestamp: ${data.timestamp}`);
          
          // Opcional: Marcar visualmente la entrevista como enviada
          boton.innerHTML = '<i class="fa-solid fa-check"></i> ENVIADO';
          boton.classList.remove('btn-outline-warning');
          boton.classList.add('btn-success');
          boton.disabled = true;
          
        } else {
          // Error
          alert(`‚ùå ERROR: ${data.message}\n\nDetalles: ${data.error_details || 'No disponible'}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert(`‚ùå ERROR DE CONEXI√ìN: No se pudo enviar la entrevista.\n\nError t√©cnico: ${error.message}`);
      })
      .finally(() => {
        // Solo restaurar el bot√≥n si no fue exitoso
        if (!boton.classList.contains('btn-success')) {
          boton.disabled = false;
          boton.innerHTML = textoOriginal;
        }
      });
    }
  }

  // Funci√≥n auxiliar para obtener el CSRF token de las cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

</script>

<!-- Modal para Comentarios -->
<div class="modal fade" id="modalComentarios" tabindex="-1" aria-labelledby="modalComentariosLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalComentariosLabel">
          <i class="fas fa-comments me-2"></i>Comentarios del Documento
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body modal-comentarios">
        <!-- Contenedor de comentarios con scroll -->
        <div id="comentarios-container">
          <!-- Los comentarios se cargan din√°micamente aqu√≠ -->
        </div>

        <!-- Formulario para nuevo comentario (fijo en la parte inferior) -->
        <div class="form-nuevo-comentario-section">
          <h6 class="mb-3">Agregar Comentario</h6>
          <form id="form-nuevo-comentario">
            {% csrf_token %}
            <div class="mb-3">
              <textarea class="form-control" name="comentario" rows="3" placeholder="Escribe tu comentario aqu√≠..."
                required></textarea>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Agregar Comentario
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Opciones -->
<div class="modal fade" id="modalOpciones" tabindex="-1" aria-labelledby="modalOpcionesLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalOpcionesLabel">
          <i class="fas fa-cog me-2"></i>Opciones de Calificaci√≥n
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>Documento:</strong> <span id="opciones-documento-nombre"></span>
        </div>
        <div class="mb-3">
          <p class="text-muted">Selecciona una opci√≥n para calificar este documento como "malo":</p>
        </div>
        <div id="opciones-container">
          <!-- Las opciones se cargan din√°micamente aqu√≠ -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Avanzar Etapa -->
<div class="modal fade" id="modalAvanzarEtapa" tabindex="-1" aria-labelledby="modalAvanzarEtapaLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAvanzarEtapaLabel">
          <i class="fas fa-arrow-right me-2"></i>Avanzar Etapa
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Columna de Subestados -->
          <div class="col-md-4">
            <h6 class="border-bottom pb-2 mb-3">
              <i class="fas fa-list-ol me-2"></i>Avanzar Subestado
            </h6>
            <p class="text-muted small">Avanza al siguiente subestado dentro de la etapa actual:</p>
            
            <div id="subestados-container">
              <!-- Los subestados se cargan din√°micamente aqu√≠ -->
            </div>
          </div>
          
          <!-- Columna de Transiciones -->
          <div class="col-md-4">
            <h6 class="border-bottom pb-2 mb-3">
              <i class="fas fa-exchange-alt me-2"></i>Cambiar Etapa
            </h6>
            <p class="text-muted small">Cambia a una etapa diferente seg√∫n las transiciones configuradas:</p>
            
            <div id="transiciones-container">
              <!-- Las transiciones se cargan din√°micamente aqu√≠ -->
            </div>
          </div>
          
          <!-- Columna de Bandeja Grupal -->
          <div class="col-md-4">
            <h6 class="border-bottom pb-2 mb-3">
              <i class="fas fa-users me-2"></i>Bandeja Grupal
            </h6>
            <p class="text-muted small">Devuelve la solicitud a la bandeja grupal para que otros usuarios la puedan tomar:</p>
            
            <div id="bandeja-grupal-container">
              <div class="card border-info">
                <div class="card-body p-3">
                  <div class="text-center">
                    <div class="mb-3">
                      <i class="fas fa-inbox fa-2x text-info mb-2"></i>
                      <h6 class="mb-1">Devolver a Bandeja Grupal</h6>
                      <small class="text-muted">
                        Permite que otros usuarios contin√∫en con el siguiente subestado
                      </small>
                    </div>
                    
                    <div class="mb-3">
                      <div class="badge bg-info mb-2">
                        <i class="fas fa-info-circle me-1"></i>
                        Subestado Actual: <span id="subestado-actual-nombre">{{ solicitud.subestado_actual.nombre|default:"Sin subestado" }}</span>
                      </div>
                      <br>
                      <small class="text-muted d-block">
                        Al devolver a bandeja grupal, la solicitud estar√° disponible para que cualquier usuario autorizado la tome y contin√∫e con el flujo.
                      </small>
                    </div>
                    
                    <button class="btn btn-info btn-sm w-100" 
                            onclick="devolverABandejaGrupal()"
                            id="btn-devolver-bandeja">
                      <i class="fas fa-share me-1"></i>Devolver a Bandeja Grupal
                    </button>
                    
                    <div class="mt-2">
                      <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        √ötil cuando has completado tu parte del proceso y quieres que otro usuario contin√∫e.
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Asociar Entrevista -->
<div class="modal fade" id="modalAsociarEntrevista" tabindex="-1" aria-labelledby="modalAsociarEntrevistaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAsociarEntrevistaLabel">
          <i class="fas fa-user-edit me-2"></i>Asociar Entrevista de Cliente
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12 mb-3">
            <label for="buscarEntrevista" class="form-label">Buscar Entrevista</label>
            <input type="text" class="form-control" id="buscarEntrevista" 
                   placeholder="Escriba nombre, apellido, c√©dula o email del cliente..."
                   onkeyup="buscarEntrevistas()">
          </div>
        </div>
        
        <div id="resultadosEntrevistas" class="mt-3">
          <!-- Aqu√≠ se cargar√°n los resultados -->
        </div>
        
        <div id="entrevistaSeleccionada" class="mt-3" style="display: none;">
          <div class="alert alert-success">
            <i class="fas fa-check me-2"></i>
            <strong>Entrevista seleccionada:</strong>
            <span id="nombreEntrevistaSeleccionada"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnConfirmarAsociacion" onclick="confirmarAsociacion()" disabled>
          <i class="fas fa-link me-1"></i> Confirmar Asociaci√≥n
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}