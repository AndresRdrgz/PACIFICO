{% extends "workflow/base.html" %}
{% load static %}
{% load workflow_filters %}

{% block title %}Back Office - Detalle de Solicitud - Sistema de Workflow{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'workflow/css/detalleSolicitud.css' %}" />
{% include "workflow/partials/backoffice_styles.html" %}
<style>
/* Estilos para pestañas con validación secuencial */
.tab-modern.tab-blocked {
  opacity: 0.5;
  cursor: not-allowed !important;
  pointer-events: auto; /* Permitir eventos para mostrar mensaje */
  filter: grayscale(0.8);
  position: relative;
}

/* Estilos para modal de entrevistas */
.modal-entrevistas {
  max-width: 90%;
  margin: 2rem auto;
}

/* Estilos para documentos pendientes de calificar */
.documento-pendiente {
    border: 2px solid #ff6b6b !important;
    box-shadow: 0 0 10px rgba(255, 107, 107, 0.5) !important;
    position: relative;
    animation: pulse-border 1s infinite;
}

@keyframes pulse-border {
    0% {
        box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
    }
}

.documento-pendiente::after {
    content: "¡Pendiente de calificar!";
    position: absolute;
    top: 0;
    right: 0;
    background-color: #ff6b6b;
    color: white;
    padding: 2px 8px;
    font-size: 0.75rem;
    border-bottom-left-radius: 5px;
    z-index: 10;
}

/* Estilos para botón pulsante de avanzar */
.btn-pulsating {
    animation: btn-pulse 1s infinite;
    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
}

@keyframes btn-pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
    }
}
#entrevistaSeleccionada {
  transition: all 0.3s ease-in-out;
}

.modal-body {
  scrollbar-width: thin;
  scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

.modal-body::-webkit-scrollbar {
  width: 8px;
}

.modal-body::-webkit-scrollbar-track {
  background: transparent;
}

.modal-body::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.2);
  border-radius: 20px;
}

.sticky-top {
  position: sticky;
  top: 0;
  z-index: 100;
}

.sticky-bottom {
  position: sticky;
  bottom: 0;
  z-index: 100;
}

.tab-modern.tab-blocked:hover {
  opacity: 0.6;
  background-color: #f8f9fa !important;
  border-color: #dee2e6 !important;
}

.tab-modern.tab-blocked .tab-content-wrapper {
  position: relative;
}

.tab-modern.tab-blocked .tab-content-wrapper::after {
  content: '\f023'; /* Icono de candado */
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  position: absolute;
  top: 50%;
  right: 8px;
  transform: translateY(-50%);
  color: #6c757d;
  font-size: 0.8em;
}

.tab-modern.tab-blocked .tab-status {
  color: #6c757d !important;
}

.tab-modern.tab-available {
  box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
  animation: pulse-available 2s infinite;
  border-color: #0d6efd !important;
}

.tab-modern.tab-available:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
}

.tab-modern.tab-highlighted {
  animation: tab-highlight-pulse 2s infinite;
  box-shadow: 0 0 15px rgba(25, 135, 84, 0.6);
  transform: translateY(-3px);
  transition: all 0.5s ease;
  border-color: #198754 !important;
}

@keyframes tab-highlight-pulse {
  0% {
    box-shadow: 0 0 5px rgba(25, 135, 84, 0.6);
  }
  50% {
    box-shadow: 0 0 20px rgba(25, 135, 84, 0.8);
  }
  100% {
    box-shadow: 0 0 5px rgba(25, 135, 84, 0.6);
  }
}

@keyframes pulse-available {
  0% {
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
  }
  50% {
    box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15);
  }
  100% {
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
  }
}

.tab-modern.tab-completed {
  background: linear-gradient(135deg, #d1edff 0%, #e8f7ff 100%);
  border-color: #198754 !important;
  position: relative;
}

.tab-modern.tab-completed .tab-number {
  background: #198754;
  color: white;
  position: relative;
}

.tab-modern.tab-completed .tab-number::before {
  content: '\f00c'; /* Icono de check */
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 0.7em;
}

.tab-modern.tab-completed .tab-status {
  color: #198754 !important;
  font-weight: 500;
}

/* Efecto de bloqueo visual más fuerte */
.tab-modern.tab-blocked::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 2px,
    rgba(108, 117, 125, 0.1) 2px,
    rgba(108, 117, 125, 0.1) 4px
  );
  z-index: 1;
  pointer-events: none;
}

.tab-modern.tab-blocked .tab-content-wrapper {
  position: relative;
  z-index: 2;
}

/* Tooltip personalizado para pestañas bloqueadas */
.tab-blocked-tooltip {
  position: absolute;
  background: #dc3545;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.8em;
  white-space: nowrap;
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.tab-blocked-tooltip.show {
  opacity: 1;
}

/* Estilos para información prominente del cliente */
.client-info-prominent {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.client-name {
  font-size: 1.1rem;
  color: #ffffff !important;
  display: flex;
  align-items: center;
  font-weight: 700;
}

.client-name strong {
  font-size: 1.15rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #ffffff !important;
  font-weight: 700;
}

.client-id {
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  color: #ffffff !important;
}

.client-id span {
  font-family: 'Courier New', monospace;
  font-weight: 700;
  font-size: 0.9rem;
  color: #ffffff !important;
}

/* Estilos para mini-badges de SLA */
.mini-badge-danger {
  background: linear-gradient(135deg, #dc3545, #c82333) !important;
  color: white !important;
  animation: pulse-danger 2s infinite;
}

.mini-badge-success {
  background: linear-gradient(135deg, #198754, #157347) !important;
  color: white !important;
}

@keyframes pulse-danger {
  0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
  100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

.tab-blocked-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #dc3545 transparent transparent transparent;
}

/* Mejora visual para pestaña actual */
.tab-modern.active {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}

/* Transiciones suaves */
.tab-modern {
  transition: all 0.3s ease;
  cursor: pointer;
  text-decoration: none;
}

.tab-modern:hover {
  text-decoration: none;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.tab-modern:focus {
  outline: none;
  text-decoration: none;
}

/* Indicador de proceso secuencial */
.sequential-indicator {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ffc107;
  color: #000;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 0.7em;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  animation: bounce 1s infinite;
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-3px);
  }
  60% {
    transform: translateY(-2px);
  }
}

/* Estilos para enlaces de referencia rápida */
.quick-links-section {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 1.5rem;
  border: 1px solid #dee2e6;
}

.quick-link-card {
  display: block;
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 10px;
  padding: 1rem;
  text-decoration: none;
  color: inherit;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.quick-link-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  text-decoration: none;
  color: inherit;
  border-color: #ced4da;
}

.quick-link-icon {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.1rem;
  margin-right: 1rem;
  flex-shrink: 0;
}

.quick-link-content {
  flex-grow: 1;
}

.quick-link-title {
  font-weight: 600;
  font-size: 0.95rem;
  color: #495057;
  margin-bottom: 2px;
}

.quick-link-subtitle {
  font-size: 0.85rem;
  color: #6c757d;
  font-weight: 400;
}

.quick-link-arrow {
  color: #adb5bd;
  font-size: 0.9rem;
  margin-left: 0.5rem;
  transition: all 0.3s ease;
}

.quick-link-card:hover .quick-link-arrow {
  color: #495057;
  transform: translateX(2px);
}

.quick-link-card-disabled {
  display: block;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 10px;
  padding: 1rem;
  color: #6c757d;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  opacity: 0.7;
}

/* Estilos para información del cliente en header */
.client-header-info {
  font-size: 0.9rem;
  opacity: 0.9;
}

.header-info-badge {
  display: inline-block;
}

.header-info-badge .badge {
  font-size: 0.85rem;
  font-weight: 500;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <!-- Header Principal -->
      <div class="card mb-4">



      <!-- Subestados de Back Office -->
      <div class="card processes-card">
        <div class="card-header processes-header">
          <div class="d-flex align-items-center justify-content-between">
            <!-- Sección Izquierda: Icono, Títulos y Cliente -->
            <div class="d-flex align-items-center">
              <div class="process-icon-container">
                <i class="fas fa-tasks text-white"></i>
              </div>
              <div class="ms-3">
                <h5 class="mb-0 process-title text-white fw-bold">Procesos de Back Office</h5>
                <small class="process-subtitle text-white-50">Gestión completa del flujo de trabajo</small>
              </div>
              
              <!-- Información prominente del cliente -->
              <div class="ms-4 ps-4 border-start border-primary border-2">
                <div class="client-info-prominent">
                  {% if solicitud.cliente_nombre_completo or solicitud.cotizacion.nombreCliente %}
                                    <div class="client-name">
                    <i class="fas fa-user-circle text-white me-2"></i>
                    <strong>{{ solicitud.cliente_nombre_completo|default:solicitud.cotizacion.nombreCliente }}</strong>
                  </div>
                  {% endif %}

                  {% if solicitud.cotizacion.cedulaCliente %}
                  <div class="client-id">
                    <i class="fas fa-id-card text-white me-2"></i>
                    <span>{{ solicitud.cotizacion.cedulaCliente }}</span>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Sección Central: Información del Negocio -->
            <div class="d-flex align-items-center justify-content-center flex-wrap gap-2">
              <!-- Oficial creador -->
              {% if solicitud.creada_por %}
              <span class="mini-badge mini-badge-primary">
                <i class="fas fa-user-tie"></i>
                {{ solicitud.creada_por.get_full_name|default:solicitud.creada_por.username }}
              </span>
              {% endif %}
              
              <!-- Estado SLA -->
              {% if solicitud.etapa_actual and solicitud.etapa_actual.sla %}
              {% load workflow_filters %}
              {% with horas_transcurridas=solicitud|dias_en_etapa sla_horas=solicitud.etapa_actual.sla|sla_to_horas sla_80=solicitud.etapa_actual.sla|sla_to_horas|sla_80_percent %}
              {% if horas_transcurridas > sla_horas %}
                <span class="mini-badge mini-badge-danger">
                  <i class="fas fa-exclamation-triangle"></i>
                  SLA Vencido ({{ solicitud|tiempo_en_subestado_texto }})
                </span>
              {% elif horas_transcurridas > sla_80 %}
                <span class="mini-badge mini-badge-warning">
                  <i class="fas fa-clock"></i>
                  SLA Próximo ({{ solicitud|tiempo_en_subestado_texto }})
                </span>
              {% endif %}
              {% endwith %}
              {% endif %}
              
              {% if solicitud.cotizacion.montoPrestamo %}
              <span class="mini-badge mini-badge-warning">
                <i class="fas fa-dollar-sign"></i>
                B/. {{ solicitud.cotizacion.montoPrestamo|floatformat:0 }}
              </span>
              {% endif %}
              
              {% if solicitud.cotizacion.tipoPrestamo %}
              <span class="mini-badge mini-badge-info">
                <i class="fas fa-briefcase"></i>
                {{ solicitud.cotizacion.get_tipoPrestamo_display|default:solicitud.cotizacion.tipoPrestamo|title }}
              </span>
              {% endif %}
              
              <span class="mini-badge mini-badge-success">
                <i class="fas fa-file-alt"></i>
                {{ solicitud.codigo }}
              </span>
            </div>

            <!-- Sección Derecha: Badge de Etapas -->
            <div class="process-badge">
              <span class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>
                6 Etapas
              </span>
            </div>
          </div>
        </div>

        <div class="card-body p-0">
          <!-- Pestañas de Navegación Mejoradas -->
          <div class="nav-tabs-container">
            <ul class="nav nav-tabs nav-tabs-modern d-flex flex-column flex-md-row" id="backoffice-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <div class="nav-link tab-modern {% if solicitud.subestado_actual.nombre == 'Checklist' %}active{% endif %}" 
                     style="cursor: default; pointer-events: none;">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">1</div>
                    <div class="tab-text">
                      <span class="tab-title">Checklist</span>
                      <span class="tab-status">{% if solicitud.subestado_actual.nombre == 'Checklist' %}Activo{% else %}Disponible{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </div>
              </li>
              <li class="nav-item" role="presentation">
                <div class="nav-link tab-modern {% if solicitud.subestado_actual.nombre == 'Captura' %}active{% endif %}"
                     style="cursor: default; pointer-events: none;">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">2</div>
                    <div class="tab-text">
                      <span class="tab-title">Captura</span>
                      <span class="tab-status">{% if solicitud.subestado_actual.nombre == 'Captura' %}Activo{% else %}Disponible{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </div>
              </li>
              <li class="nav-item" role="presentation">
                <div class="nav-link tab-modern {% if solicitud.subestado_actual.nombre == 'Firma' %}active{% endif %}"
                     style="cursor: default; pointer-events: none;">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">3</div>
                    <div class="tab-text">
                      <span class="tab-title">Firma</span>
                      <span class="tab-status">{% if solicitud.subestado_actual.nombre == 'Firma' %}Activo{% else %}Disponible{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </div>
              </li>
              <li class="nav-item" role="presentation">
                <div class="nav-link tab-modern {% if solicitud.subestado_actual.nombre == 'Orden del expediente' %}active{% endif %}"
                     style="cursor: default; pointer-events: none;">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">4</div>
                    <div class="tab-text">
                      <span class="tab-title">Orden del expediente</span>
                      <span class="tab-status">{% if solicitud.subestado_actual.nombre == 'Orden del expediente' %}Activo{% else %}Disponible{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </div>
              </li>
              <li class="nav-item" role="presentation">
                <div class="nav-link tab-modern {% if solicitud.subestado_actual.nombre == 'Trámite' %}active{% endif %}"
                     style="cursor: default; pointer-events: none;">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">5</div>
                    <div class="tab-text">
                      <span class="tab-title">Trámite</span>
                      <span class="tab-status">{% if solicitud.subestado_actual.nombre == 'Trámite' %}Activo{% else %}Disponible{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </div>
              </li>
              <li class="nav-item" role="presentation">
                <div class="nav-link tab-modern {% if solicitud.subestado_actual.nombre == 'Subsanación de pendientes Trámite' %}active{% endif %}"
                     style="cursor: default; pointer-events: none;">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">6</div>
                    <div class="tab-text">
                      <span class="tab-title">Subsanación</span>
                      <span class="tab-status">{% if solicitud.subestado_actual.nombre == 'Subsanación de pendientes Trámite' %}Activo{% else %}Disponible{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <!-- Contenido del Subestado Actual -->
          {% if solicitud.etapa_actual.subestados.exists %}
          <div class="subestado-content-modern">
            <div class="process-step-header">
              <div class="step-indicator">
                <span class="step-number">1</span>
                <span class="step-total">/ 6</span>
              </div>
              <div class="subestado-icon">
                <i class="fas fa-folder-open"></i>
              </div>
              <div class="step-status">
                <span class="badge bg-primary">
                  <i class="fas fa-cog me-1"></i>Procesando
                </span>
              </div>
            </div>

            <!-- Enlaces de Referencia Rápida -->
            <div class="quick-links-section mb-4">
              <div class="row">
                {% if solicitud.cotizacion %}
                <div class="col-md-6 mb-2">
                  <a href="{% url 'cotizacion_detail' solicitud.cotizacion.id %}" class="quick-link-card" target="_blank">
                    <div class="d-flex align-items-center">
                      <div class="quick-link-icon bg-primary">
                        <i class="fas fa-calculator"></i>
                      </div>
                      <div class="quick-link-content">
                        <div class="quick-link-title">Ver Cotización</div>
                        <div class="quick-link-subtitle">{{ solicitud.cotizacion.codigo|default:"Sin código" }}</div>
                      </div>
                      <div class="quick-link-arrow">
                        <i class="fas fa-external-link-alt"></i>
                      </div>
                    </div>
                  </a>
                </div>
                {% endif %}
                
                {% if solicitud.cliente %}
                <div class="col-md-6 mb-2">
                  <a href="{% url 'cliente_profile' solicitud.cliente.id %}" class="quick-link-card" target="_blank">
                    <div class="d-flex align-items-center">
                      <div class="quick-link-icon bg-success">
                        <i class="fas fa-user"></i>
                      </div>
                      <div class="quick-link-content">
                        <div class="quick-link-title">Ver Cliente</div>
                        <div class="quick-link-subtitle">{{ solicitud.cliente.nombreCliente|default:"Sin nombre" }}</div>
                      </div>
                      <div class="quick-link-arrow">
                        <i class="fas fa-external-link-alt"></i>
                      </div>
                    </div>
                  </a>
                </div>
                {% endif %}
                
                {% if solicitud.cotizacion and solicitud.cotizacion.nombreCliente and not solicitud.cliente %}
                <div class="col-md-6 mb-2">
                  <div class="quick-link-card-disabled">
                    <div class="d-flex align-items-center">
                      <div class="quick-link-icon bg-info">
                        <i class="fas fa-user-tie"></i>
                      </div>
                      <div class="quick-link-content">
                        <div class="quick-link-title">Cliente (Cotización)</div>
                        <div class="quick-link-subtitle">{{ solicitud.cotizacion.nombreCliente }}</div>
                      </div>
                      <div class="quick-link-arrow">
                        <i class="fas fa-info-circle"></i>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>

                <!-- Archivos Requeridos Dinámicos -->
                {% if archivos_por_subestado and solicitud.subestado_actual.id in archivos_por_subestado %}
                {% with archivos=archivos_por_subestado|get_item:solicitud.subestado_actual.id %}
                {% if archivos|length > 0 %}

                <div class="process-details">
                  {% for archivo_info in archivos %}
                  <div class="detail-card archivo-card-mejorada-backoffice"
                    data-requisito-id="{{ archivo_info.archivo_actual.id }}">
                    <!-- Header del archivo -->
                    <div class="archivo-header-backoffice">
                      <!-- IZQUIERDA: Información del documento -->
                      <div class="archivo-info-basica-backoffice">
                        <div class="detail-icon archivo-icon-backoffice">
                          {% if archivo_info.esta_cumplido %}
                          <i class="fas fa-check-circle text-success"></i>
                          {% else %}
                          <i class="fas fa-file-upload text-warning"></i>
                          {% endif %}
                        </div>
                        <div class="detail-content-backoffice">
                          <h6>{{ archivo_info.requisito.nombre }}</h6>
                          <p class="mb-1">{{ archivo_info.requisito.descripcion|default:"Sin descripción disponible" }}
                          </p>

                          {% if archivo_info.esta_cumplido and archivo_info.archivo_actual %}
                          <div class="archivo-info-backoffice mt-2">
                            <span class="badge bg-success me-2">
                              <i class="fas fa-check me-1"></i>Completo
                            </span>
                            
                            <!-- ✅ Badge de Subsanado en amarillo cuando está marcado como subsanado -->
                            {% if archivo_info.ultima_calificacion and archivo_info.ultima_calificacion.subsanado %}
                            <span class="badge bg-warning me-2">
                              <i class="fas fa-tools me-1"></i>Subsanado
                            </span>
                            {% endif %}
                            
                            {% if archivo_info.obligatorio %}
                            <span class="badge bg-danger me-2">
                              <i class="fas fa-exclamation-circle me-1"></i>Obligatorio
                            </span>
                            {% else %}
                            <span class="badge bg-secondary me-2">
                              <i class="fas fa-info-circle me-1"></i>Opcional
                            </span>
                            {% endif %}
                            <small class="text-muted">
                              Archivo: {{ archivo_info.archivo_actual.archivo.name|slice:"10:" }}
                            </small>
                          </div>
                          {% else %}
                          <div class="archivo-info-backoffice mt-2">
                            <span class="badge bg-warning me-2">
                              <i class="fas fa-exclamation-triangle me-1"></i>Pendiente
                            </span>
                            
                            <!-- ✅ Badge de Subsanado también para documentos pendientes -->
                            {% if archivo_info.ultima_calificacion and archivo_info.ultima_calificacion.subsanado %}
                            <span class="badge bg-warning me-2" style="background-color: #ffc107 !important;">
                              <i class="fas fa-tools me-1"></i>Subsanado
                            </span>
                            {% endif %}
                            
                            {% if archivo_info.obligatorio %}
                            <small class="text-danger">Obligatorio</small>
                            {% else %}
                            <small class="text-muted">Opcional</small>
                            {% endif %}
                          </div>
                          {% endif %}

                          {% if archivo_info.mensaje_personalizado %}
                          <div class="mensaje-personalizado mt-2">
                            <small class="text-info">
                              <i class="fas fa-info-circle me-1"></i>
                              {{ archivo_info.mensaje_personalizado }}
                            </small>
                          </div>
                          {% endif %}
                        </div>
                      </div>

                      <!-- CENTRO: Botones Ver/Descargar -->
                      {% if archivo_info.esta_cumplido and archivo_info.archivo_actual.archivo %}
                      <div class="seccion-ver-descargar-backoffice">
                        <div class="btn-group">
                          <!-- ✅ CORREGIDO: Abrir directamente en el navegador (sin Google Viewer) -->
                          <a href="{{ archivo_info.archivo_actual.archivo.url }}" target="_blank"
                            rel="noopener noreferrer" class="btn btn-outline-primary"
                            title="Ver documento en nueva pestaña">
                            <i class="fas fa-eye"></i> Ver
                          </a>
                          <a href="{{ archivo_info.archivo_actual.archivo.url }}" download
                            class="btn btn-outline-success" title="Descargar archivo">
                            <i class="fas fa-download"></i> Descargar
                          </a>
                        </div>
                      </div>
                      {% endif %}

                      <!-- DERECHA: Botones de calificación -->
                      <div class="seccion-acciones-derecha-backoffice">
                        <!-- Botones de Calificación Optimizados para Checklist -->
                        <div class="botones-calificacion-backoffice botones-checklist-optimizado">
                          {% if archivo_info.archivo_actual.archivo %}
                            <!-- Si tiene archivo: Solo Bueno/Malo (sin Pendiente para ningún tipo) -->
                            <!-- Bueno -->
                            <button type="button" class="btn calificar-btn-backoffice {% if archivo_info.ultima_calificacion and archivo_info.ultima_calificacion.estado == 'bueno' %}activo{% endif %}" data-estado="bueno"
                              data-requisito="{{ archivo_info.archivo_actual.id }}"
                              title="Marcar como bueno">
                              <i class="fas fa-thumbs-up"></i>
                              <span>Bueno</span>
                            </button>
                            
                            <!-- Malo - Abre modal directamente -->
                            <button type="button" class="btn calificar-btn-backoffice {% if archivo_info.ultima_calificacion and archivo_info.ultima_calificacion.estado == 'malo' %}activo{% endif %}" data-estado="malo"
                              title="Marcar como malo"
                              onclick="mostrarModalOpciones('{{ archivo_info.archivo_actual.id }}', '{{ archivo_info.requisito.nombre }}').catch(console.error)">
                              <i class="fas fa-thumbs-down"></i>
                              <span>Malo</span>
                            </button>
                            
                            <!-- Subsanado - Siempre disponible -->
                            <button type="button" class="btn calificar-btn-backoffice {% if archivo_info.ultima_calificacion and archivo_info.ultima_calificacion.subsanado %}activo{% endif %}" data-estado="subsanado"
                              data-requisito="{{ archivo_info.archivo_actual.id }}"
                              title="Marcar como subsanado">
                              <i class="fas fa-check-circle"></i>
                              <span>Subsanado</span>
                            </button>
                            
                            <!-- PENDIENTE - Eliminado: Con archivo no se permite Pendiente -->
                            
                            <!-- Comentarios -->
                            <button type="button" class="btn comentario-btn-backoffice"
                              data-requisito="{{ archivo_info.archivo_actual.id }}"
                              title="Ver/Agregar comentarios">
                              <i class="fas fa-comment"></i>
                              <span>Comentar</span>
                              <span class="badge">{{ archivo_info.comentarios_backoffice|length }}</span>
                            </button>
                          {% else %}
                            <!-- Si NO tiene archivo: Comportamiento según obligatoriedad -->
                            <!-- Bueno - Deshabilitado -->
                            <button type="button" class="btn calificar-btn-backoffice" data-estado="bueno"
                              disabled title="Debe subir archivo para calificar como bueno">
                              <i class="fas fa-thumbs-up"></i>
                              <span>Bueno</span>
                            </button>
                            
                            <!-- Malo - Deshabilitado -->
                            <button type="button" class="btn calificar-btn-backoffice" data-estado="malo"
                              disabled title="Debe subir archivo para calificar como malo">
                              <i class="fas fa-thumbs-down"></i>
                              <span>Malo</span>
                            </button>
                            
                            <!-- Subsanado - Siempre disponible -->
                            <button type="button" class="btn calificar-btn-backoffice {% if archivo_info.ultima_calificacion and archivo_info.ultima_calificacion.subsanado %}activo{% endif %}" data-estado="subsanado"
                              data-requisito="{{ archivo_info.archivo_actual.id }}"
                              title="Marcar como subsanado">
                              <i class="fas fa-check-circle"></i>
                              <span>Subsanado</span>
                            </button>
                            
                            <!-- Pendiente - Solo para documentos opcionales -->
                            {% if not archivo_info.obligatorio %}
                            <button type="button" class="btn calificar-btn-backoffice activo" data-estado="pendiente"
                              data-requisito="{{ archivo_info.archivo_actual.id }}"
                              title="Pendiente (Sin archivo)"
                              data-calificado="pendiente"
                              style="background-color: #ffc107 !important; border-color: #ffc107 !important; color: #212529 !important; font-weight: bold; box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);">
                              <i class="fas fa-clock"></i>
                              <span>Pendiente</span>
                            </button>
                            {% endif %}
                            
                            <!-- Comentarios -->
                            <button type="button" class="btn comentario-btn-backoffice"
                              data-requisito="{{ archivo_info.archivo_actual.id }}"
                              title="Ver/Agregar comentarios">
                              <i class="fas fa-comment"></i>
                              <span>Comentar</span>
                              <span class="badge">{{ archivo_info.comentarios_backoffice|length }}</span>
                            </button>
                            
                            <!-- Información adicional -->
                            <div class="mt-2">
                              {% if not archivo_info.obligatorio %}
                                <small class="text-warning"><i class="fas fa-info-circle me-1"></i>Sin archivo - Marcado automáticamente como pendiente</small>
                                <br>
                                <small class="text-muted">Documento opcional</small>
                              {% else %}
                                <small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Sin archivo - Requiere subir documento</small>
                                <br>
                                <small class="text-danger">Documento requerido</small>
                              {% endif %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>



                  </div>
                  {% endfor %}
                </div>

                <!-- Asociación de Entrevista de Cliente -->
                {% if solicitud.entrevista_cliente %}
                <div class="alert alert-success">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check-circle text-success me-3" style="font-size: 1.5rem;"></i>
                    <div>
                      <strong>Entrevista Asociada</strong><br />
                      <small>Cliente: {{ solicitud.entrevista_cliente.primer_nombre }} {{ solicitud.entrevista_cliente.primer_apellido }} - {{ solicitud.entrevista_cliente.email }}</small>
                    </div>
                    <div class="ms-auto">
                      <button type="button" class="btn btn-outline-secondary btn-sm" onclick="desasociarEntrevista()">
                        <i class="fas fa-unlink me-1"></i> Desasociar
                      </button>
                    </div>
                  </div>
                  <!-- Botones de acciones para la entrevista -->
                  <div class="border-top pt-2">
                    <div class="d-flex gap-2 flex-wrap">
                      <a href="{% url 'descargar_entrevista_excel' solicitud.entrevista_cliente.id %}" 
                         class="btn btn-outline-success btn-sm d-flex align-items-center justify-content-center" 
                         style="min-width: 80px; height: 32px;"
                         title="Descargar entrevista en Excel">
                        <i class="fa-solid fa-file-excel me-1"></i>
                        <span>Excel</span>
                      </a>
                      <a href="{% url 'entrevista_admin' solicitud.entrevista_cliente.id %}" 
                         class="btn btn-outline-primary btn-sm d-flex align-items-center justify-content-center" 
                         style="min-width: 80px; height: 32px;"
                         target="_blank" 
                         title="Modo Administrador - Control de Calidad">
                        <i class="fa-solid fa-user-gear me-1"></i>
                        <span>Admin</span>
                      </a>
                      <button onclick="enviarAAAPX({{ solicitud.entrevista_cliente.id }}, '{{ solicitud.entrevista_cliente.primer_nombre }} {{ solicitud.entrevista_cliente.primer_apellido }}')" 
                              class="btn btn-outline-warning btn-sm d-flex align-items-center justify-content-center" 
                              style="min-width: 80px; height: 32px;"
                              title="Enviar al Sistema Core APPX">
                        <i class="fa-solid fa-paper-plane me-1"></i>
                        <span>APPX</span>
                      </button>
                      <a href="{% url 'descargar_entrevista_pdf' solicitud.entrevista_cliente.id %}" 
                         class="btn btn-outline-danger btn-sm d-flex align-items-center justify-content-center" 
                         style="min-width: 80px; height: 32px;"
                         title="Descargar entrevista en PDF">
                        <i class="fa-solid fa-file-pdf me-1"></i>
                        <span>PDF</span>
                      </a>
                    </div>
                  </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-user-edit text-info me-3" style="font-size: 1.5rem;"></i>
                    <div>
                      <strong>Asociar Entrevista de Cliente</strong><br />
                      <small>Vincule los datos generales del cliente con esta solicitud.</small>
                    </div>
                    <div class="ms-auto">
                      <button type="button" class="btn btn-outline-info btn-sm" onclick="mostrarModalEntrevista()">
                        <i class="fas fa-link me-1"></i> Asociar
                      </button>
                    </div>
                  </div>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong>Sin Archivos Específicos</strong><br />
                  No hay archivos específicos requeridos para esta etapa.
                </div>
                {% endif %}
                {% endwith %}
                {% else %}
                <div class="alert alert-secondary">
                  <i class="fas fa-file-alt me-2"></i>
                  <strong>Configuración Pendiente</strong><br />
                  Los requisitos para esta etapa aún no han sido configurados.
                </div>
                {% endif %}

                <div class="action-buttons">
                  <!-- Botón Devolver a Oficial - se muestra solo si hay transiciones negativas -->
                  <button id="btn-devolver-oficial" type="button" class="btn btn-warning btn-lg" style="display: none;" onclick="mostrarModalDevolucion()">
                    <i class="fas fa-arrow-left me-2"></i>
                    <span>Devolver a Oficial</span>
                  </button>
                  
                  <!-- Botón de avance - se habilita automáticamente al calificar todos los documentos -->
                  <button id="btn-avanzar-subestado" type="button" class="btn btn-success btn-lg ms-2" onclick="validarDocumentosYAvanzar()" disabled title="Debes calificar todos los documentos antes de avanzar">
                    <i class="fas fa-arrow-right me-2"></i>
                    <span id="btn-avanzar-texto">Avanzar</span>
                  </button>
                  
                  <!-- Indicador de estado de validación -->
                  <div id="validacion-estado" class="mt-2">
                    <small class="text-muted">
                      <i class="fas fa-check-circle text-success me-1"></i>
                      <span id="validacion-mensaje">Listo para avanzar</span>
                    </small>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="subestado-content-modern">
                <div class="alert alert-warning text-center">
                  <div class="subestado-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                  </div>
                  <h3 class="subestado-title">Sin Procesos Configurados</h3>
                  <p class="subestado-description">
                    No hay subestados configurados para esta etapa de Back Office.
                  </p>
                  <div class="action-buttons">
                    <button class="btn btn-outline-primary">
                      <i class="fas fa-cog me-1"></i>Configurar Procesos
                    </button>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Información Adicional -->
      <div class="row mt-4">
        <div class="col-lg-6 col-md-12 mb-3">
          <div class="card info-card">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-clock"></i> Tiempo de Procesamiento
              </h6>
            </div>
            <div class="card-body">
              <div class="time-info">
                <div class="time-item">
                  <div class="time-label">Tiempo Transcurrido</div>
                  <div class="time-value">
                    {{ solicitud.fecha_creacion|timesince }}
                  </div>
                </div>
                <div class="time-item">
                  <div class="time-label">Última Actualización</div>
                  <div class="time-value">
                    {{ solicitud.fecha_actualizacion|timesince }} atrás
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6 col-md-12 mb-3">
          <div class="card info-card">
            <div class="card-header">
              <h6 class="mb-0"><i class="fas fa-users"></i> Equipo Asignado</h6>
            </div>
            <div class="card-body">
              <div class="team-info">
                <div class="team-member">
                  <div class="member-avatar">
                    <i class="fas fa-user"></i>
                  </div>
                  <div class="member-details">
                    <div class="member-name">
                      {{ solicitud.asignada_a|default:"Sin asignar" }}
                    </div>
                    <div class="member-role">Analista Back Office</div>
                  </div>
                </div>
                <div class="team-stats">
                  <small class="text-muted">
                    <i class="fas fa-building me-1"></i>Departamento: Back
                    Office
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Funciones JavaScript para el backoffice
  function refreshFiles(subestadoId) {
    console.log('Actualizando archivos para subestado:', subestadoId);

    // Mostrar spinner de carga
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualizando...';
    button.disabled = true;

    // Simular actualización (en implementación real sería una llamada AJAX)
    setTimeout(() => {
      button.innerHTML = originalText;
      button.disabled = false;

      // Mostrar notificación de éxito
      showToast('Estado de archivos actualizado correctamente', 'success');

      // Mostrar mensaje y recargar
      mostrarMensaje('Estado de archivos actualizado correctamente', 'success');
      setTimeout(() => {
        location.reload();
      }, 800);
    }, 2000); // Simular actualización
  }
  
  function marcarControlCalidad() {
    console.log('Marcando control de calidad como realizado');

    // Mostrar spinner de carga
    const button = document.getElementById('btn-control-calidad');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
    button.disabled = true;

    // Simular proceso (en implementación real sería una validación de los documentos)
    setTimeout(() => {
      // Cambiar el estado del botón de control de calidad
      button.innerHTML = '<i class="fas fa-check-circle me-1"></i>Control de Calidad Completado';
      button.classList.remove('btn-primary');
      button.classList.add('btn-success');
      button.disabled = true;
      
      // Habilitar el botón de avanzar etapa
      const botonAvanzar = document.getElementById('btn-avanzar-etapa');
      botonAvanzar.removeAttribute('disabled');
      botonAvanzar.classList.add('btn-pulsating');
      
      // Habilitar la navegación a la siguiente pestaña disponible
      const tabDisponible = document.querySelector('.tab-modern.tab-available');
      if (tabDisponible) {
        // Habilitar la navegación con Bootstrap
        tabDisponible.setAttribute('data-bs-toggle', 'tab');
        tabDisponible.setAttribute('data-bs-target', `#content-${tabDisponible.getAttribute('data-subestado-id')}`);
        tabDisponible.removeAttribute('aria-disabled');
        tabDisponible.setAttribute('role', 'tab');
        tabDisponible.removeEventListener('click', alertaControlCalidad);
        tabDisponible.addEventListener('shown.bs.tab', manejarCambioTab);
        tabDisponible.classList.add('tab-highlighted');
        tabDisponible.setAttribute('title', 'Haga clic para navegar a esta etapa');
      }
      
      // Mostrar notificación de éxito
      showToast('Control de calidad completado correctamente. Ahora puede avanzar a la siguiente etapa o pestaña.', 'success');
    }, 1500);
  }

  function generateReport(subestadoId) {
    console.log('Generando reporte para subestado:', subestadoId);

    // Mostrar spinner de carga
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando...';
    button.disabled = true;

    // Simular generación de reporte
    setTimeout(() => {
      button.innerHTML = originalText;
      button.disabled = false;

      showToast('Reporte generado y descargado', 'success');
    }, 3000);
  }

  function showToast(message, type = 'info') {
    // Crear toast notification
    const toastContainer = document.getElementById('toast-container') || createToastContainer();

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toast);

    // Mostrar toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // Remover toast después de que se oculte
    toast.addEventListener('hidden.bs.toast', () => {
      toast.remove();
    });
  }

  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
  }

  // Inicialización cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', function () {
    console.log('🔧 Backoffice con visualización de archivos inicializado');

    // Aplicar validación secuencial a las pestañas
    aplicarValidacionSecuencialTabs();
    
    // Inicialmente deshabilitar navegación a la siguiente pestaña hasta que se complete el control de calidad
    const tabDisponible = document.querySelector('.tab-modern.tab-available');
    if (tabDisponible) {
      // Al inicio, la pestaña disponible solo muestra que es la siguiente, pero no se puede hacer clic hasta control de calidad
      tabDisponible.removeAttribute('data-bs-toggle');
      tabDisponible.removeAttribute('data-bs-target');
      tabDisponible.setAttribute('aria-disabled', 'true');
      tabDisponible.setAttribute('role', 'button');
      tabDisponible.setAttribute('title', 'Complete el Control de Calidad primero');
      tabDisponible.addEventListener('click', alertaControlCalidad);
    }

    // Agregar tooltips a los botones de archivo
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Verificar estado de calificación de documentos
    setTimeout(() => {
      const verificacion = verificarDocumentosPendientes();
      
      // Resaltar documentos pendientes si los hay
      if (!verificacion.todoCalificado) {
        verificacion.pendientes.forEach(req => {
          if (req.elemento) {
            req.elemento.classList.add('documento-pendiente');
          }
        });
        
        // Mostrar mensaje informativo solo si hay subestados disponibles para avanzar
        const btnAvanzar = document.querySelector('#subestados-container button:not([disabled])');
        if (btnAvanzar && verificacion.pendientes.length > 0) {
          mostrarMensaje(`Recuerde calificar todos los documentos antes de avanzar (${verificacion.pendientes.length} pendientes)`, 'info');
        }
      }
    }, 1500);

    // Agregar hover effects a las cards de archivo
    const archivoCards = document.querySelectorAll('.archivo-card');
    archivoCards.forEach(card => {
      card.addEventListener('mouseenter', function () {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 8px 25px rgba(74, 124, 89, 0.15)';
      });

      card.addEventListener('mouseleave', function () {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.05)';
      });
    });
  });

  // =======================================================
  // VALIDACIÓN SECUENCIAL PARA PESTAÑAS
  // =======================================================

  function aplicarValidacionSecuencialTabs() {
    const subestadoActualId = {{ solicitud.subestado_actual.id|default:"null" }};
    const subestadoActualOrden = {{ solicitud.subestado_actual.orden|default:"1" }};
    
    console.log('Aplicando validación secuencial a pestañas');
    console.log('Subestado actual ID:', subestadoActualId);
    console.log('Subestado actual orden:', subestadoActualOrden);

    const tabs = document.querySelectorAll('#backoffice-tabs .nav-link.tab-modern');
    
    tabs.forEach(tab => {
      const subestadoId = parseInt(tab.getAttribute('data-subestado-id'));
      const subestadoOrden = parseInt(tab.getAttribute('data-subestado-orden'));
      
      if (!subestadoId || !subestadoOrden) return;
      
      console.log(`Procesando tab: ID=${subestadoId}, Orden=${subestadoOrden}`);
      
      // Determinar el estado de la pestaña
      const esActual = subestadoId === subestadoActualId;
      const esCompletado = subestadoOrden < subestadoActualOrden;
      const esDisponible = subestadoOrden === subestadoActualOrden + 1;
      const esBloqueado = subestadoOrden > subestadoActualOrden + 1;
      
      console.log(`Tab ${subestadoOrden}: actual=${esActual}, completado=${esCompletado}, disponible=${esDisponible}, bloqueado=${esBloqueado}`);
      
      // Limpiar clases previas
      tab.classList.remove('tab-blocked', 'tab-available', 'tab-completed');
      
      // Remover listeners previos para evitar duplicados
      tab.removeEventListener('click', bloquearClickInvalido);
      tab.removeEventListener('shown.bs.tab', manejarCambioTab);
      tab.removeEventListener('shown.bs.tab', manejarRetrocesoTab);
      
      // Aplicar estilos según el estado
      if (esActual) {
        // Pestaña actual - mantener estilo activo
        console.log(`Tab ${subestadoOrden}: Configurado como ACTUAL`);
        tab.setAttribute('data-tab-state', 'actual');
      } else if (esCompletado) {
        // Pestañas completadas - permitir acceso COMPLETO (navegación libre)
        tab.classList.add('tab-completed');
        tab.setAttribute('data-tab-state', 'completado');
        
        // Mantener funcionalidad de Bootstrap para pestañas completadas (NAVEGACIÓN LIBRE)
        tab.setAttribute('data-bs-toggle', 'tab');
        tab.setAttribute('data-bs-target', `#content-${subestadoId}`);
        tab.removeAttribute('tabindex');
        
        const statusSpan = tab.querySelector('.tab-status');
        if (statusSpan) {
          statusSpan.textContent = 'Completado';
        }
        
        // Agregar listener para manejar retrocesos automáticos
        tab.addEventListener('shown.bs.tab', manejarRetrocesoTab);
        console.log(`Tab ${subestadoOrden}: Configurado como COMPLETADO (navegación libre)`);
      } else if (esDisponible) {
        // Siguiente pestaña disponible - destacar y permitir avance
        tab.classList.add('tab-available');
        tab.setAttribute('data-tab-state', 'disponible');
        
        // Mantener funcionalidad de Bootstrap pero agregar handler personalizado
        tab.setAttribute('data-bs-toggle', 'tab');
        tab.setAttribute('data-bs-target', `#content-${subestadoId}`);
        tab.removeAttribute('tabindex');
        
        const statusSpan = tab.querySelector('.tab-status');
        if (statusSpan) {
          statusSpan.textContent = 'Disponible';
        }
        
        // Agregar listener para manejar el avance automático
        tab.addEventListener('shown.bs.tab', manejarCambioTab);
        console.log(`Tab ${subestadoOrden}: Configurado como DISPONIBLE`);
      } else if (esBloqueado) {
        // Pestañas bloqueadas - SOLO para avanzar más allá de lo permitido
        tab.classList.add('tab-blocked');
        tab.setAttribute('aria-disabled', 'true');
        tab.setAttribute('title', 'No puede avanzar más allá del siguiente subestado disponible');
        tab.setAttribute('data-tab-state', 'bloqueado');
        
        // Deshabilitar funcionalidad de Bootstrap
        tab.removeAttribute('data-bs-toggle');
        tab.removeAttribute('data-bs-target');
        tab.setAttribute('tabindex', '-1');
        tab.setAttribute('role', 'button');
        
        const statusSpan = tab.querySelector('.tab-status');
        if (statusSpan) {
          statusSpan.textContent = 'Bloqueado';
        }
        
        // Agregar evento para bloquear clicks inválidos
        tab.addEventListener('click', bloquearClickInvalido);
        
        console.log(`Tab ${subestadoOrden}: Configurado como BLOQUEADO`);
      }
    });
  }

  // Función para bloquear clicks en pestañas no disponibles
  function bloquearClickInvalido(e) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    
    const tab = e.currentTarget;
    const tabState = tab.getAttribute('data-tab-state');
    const subestadoOrden = tab.getAttribute('data-subestado-orden');
    
    if (tabState === 'bloqueado') {
      // Mostrar tooltip personalizado en la posición del click
      mostrarTooltipBloqueo(e, `Etapa ${subestadoOrden} bloqueada. No puede avanzar más allá del siguiente subestado disponible.`);
      
      // También mostrar mensaje general
      mostrarMensaje('No puede avanzar más allá del siguiente subestado disponible. Complete primero la etapa actual.', 'warning');
    }
    
    return false;
  }

  // Función para alertar sobre completar control de calidad primero
  function alertaControlCalidad(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Mostrar tooltip personalizado en la posición del click
    mostrarTooltipBloqueo(e, 'Debe completar el Control de Calidad primero');
    
    // Resaltar el botón de control de calidad con un efecto visual
    const botonControl = document.getElementById('btn-control-calidad');
    botonControl.classList.add('btn-pulsating');
    
    // Quitar el efecto después de 3 segundos
    setTimeout(() => {
      botonControl.classList.remove('btn-pulsating');
    }, 3000);
    
    // Mostrar toast con instrucciones
    showToast('Debe completar el Control de Calidad antes de avanzar a la siguiente etapa', 'warning');
    
    return false;
  }
  
  // Función para mostrar tooltip de bloqueo
  function mostrarTooltipBloqueo(event, mensaje) {
    // Remover tooltip anterior si existe
    const tooltipAnterior = document.querySelector('.tab-blocked-tooltip');
    if (tooltipAnterior) {
      tooltipAnterior.remove();
    }
    
    // Crear nuevo tooltip
    const tooltip = document.createElement('div');
    tooltip.className = 'tab-blocked-tooltip';
    tooltip.textContent = mensaje;
    
    // Posicionar tooltip
    tooltip.style.position = 'fixed';
    tooltip.style.left = event.clientX + 'px';
    tooltip.style.top = (event.clientY - 40) + 'px';
    tooltip.style.zIndex = '9999';
    
    document.body.appendChild(tooltip);
    
    // Mostrar tooltip con animación
    setTimeout(() => {
      tooltip.classList.add('show');
    }, 10);
    
    // Remover tooltip después de 3 segundos
    setTimeout(() => {
      if (tooltip.parentNode) {
        tooltip.classList.remove('show');
        setTimeout(() => {
          if (tooltip.parentNode) {
            tooltip.remove();
          }
        }, 300);
      }
    }, 3000);
  }

  // Función para manejar cambio de pestaña disponible
  function manejarCambioTab(e) {
    const tab = e.target;
    const subestadoId = parseInt(tab.getAttribute('data-subestado-id'));
    const tabState = tab.getAttribute('data-tab-state');
    
    console.log(`Cambio de tab detectado: ID=${subestadoId}, Estado=${tabState}`);
    
    if (tabState === 'disponible' && subestadoId) {
      // Avanzar automáticamente al subestado cuando se hace clic en pestaña disponible
      console.log(`Avanzando automáticamente al subestado ${subestadoId}`);
      avanzarSubestadoAutomatico(subestadoId);
    }
  }

  // Función para manejar clicks en pestañas completadas (retrocesos)
  function manejarRetrocesoTab(e) {
    const tab = e.target;
    const subestadoId = parseInt(tab.getAttribute('data-subestado-id'));
    const tabState = tab.getAttribute('data-tab-state');
    
    console.log(`Retroceso de tab detectado: ID=${subestadoId}, Estado=${tabState}`);
    
    if (tabState === 'completado' && subestadoId) {
      // Retroceder automáticamente al subestado cuando se hace clic en pestaña completada
      console.log(`Retrocediendo automáticamente al subestado ${subestadoId}`);
      avanzarSubestadoAutomatico(subestadoId, 'retroceso');
    }
  }

  // Función para avanzar subestado automáticamente desde pestaña
  async function avanzarSubestadoAutomatico(subestadoId, accion = 'avance') {
    const solicitudId = {{ solicitud.id }};
    
    console.log(`Navegación automática (${accion}): solicitud=${solicitudId}, subestado=${subestadoId}`);
    
    try {
      const response = await fetch(`/workflow/api/avanzar-subestado/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          solicitud_id: solicitudId,
          subestado_id: subestadoId
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        console.log(`${accion} automático exitoso`);
        const mensajeAccion = accion === 'retroceso' ? 'Retrocediendo a subestado anterior...' : 'Avanzando al siguiente subestado...';
        mostrarMensaje(data.message || mensajeAccion, 'success');
        
        // Actualizar pestañas y recargar después de un breve delay
        setTimeout(() => {
          window.location.reload();
        }, 800);
      } else {
        console.error(`Error en ${accion} automático:`, data.message);
        mostrarMensaje(data.message || `Error al ${accion === 'retroceso' ? 'retroceder' : 'avanzar'} subestado`, 'error');
        
        // Volver a la pestaña anterior
        const pestañaActual = document.querySelector('#backoffice-tabs .nav-link.active');
        if (pestañaActual) {
          const tab = new bootstrap.Tab(pestañaActual);
          tab.show();
        }
      }
    } catch (error) {
      console.error(`Error de conexión en ${accion} automático:`, error);
      mostrarMensaje(`Error de conexión al ${accion === 'retroceso' ? 'retroceder' : 'avanzar'} subestado`, 'error');
      
      // Volver a la pestaña anterior
      const pestañaActual = document.querySelector('#backoffice-tabs .nav-link.active');
      if (pestañaActual) {
        const tab = new bootstrap.Tab(pestañaActual);
        tab.show();
      }
    }
  }

  // Función para actualizar las pestañas después de avanzar subestado
  function actualizarPestanasSecuenciales() {
    setTimeout(() => {
      aplicarValidacionSecuencialTabs();
    }, 100);
  }

  // =======================================================
  // FUNCIONALIDAD DE CALIFICACIÓN DE DOCUMENTOS
  // =======================================================

  // Variables globales
  let currentRequisitoId = null;

  // Función para verificar y preservar estados de botones
  function preservarEstadosBotones() {
    console.log('🔄 Preservando estados de botones...');
    
    // Recorrer todas las cards de requisitos
    const cards = document.querySelectorAll('.card[data-requisito-id]');
    console.log(`📋 Encontradas ${cards.length} cards para preservar estados`);
    
    cards.forEach(card => {
      const requisitoId = card.getAttribute('data-requisito-id');
      console.log(`🔍 Verificando estado para requisito ${requisitoId}`);
      
      // Buscar todos los botones de calificación en esta card
      const botonesBueno = card.querySelectorAll('.calificar-btn-backoffice[data-estado="bueno"]');
      const botonesMalo = card.querySelectorAll('.calificar-btn-backoffice[data-estado="malo"]');
      const botonesPendiente = card.querySelectorAll('.calificar-btn-backoffice[data-estado="pendiente"]');
      
      console.log(`📊 Requisito ${requisitoId}: ${botonesBueno.length} buenos, ${botonesMalo.length} malos, ${botonesPendiente.length} pendientes`);
      
      // Verificar si debe estar marcado como bueno o malo basado en el estado guardado
      // Esta función se ejecutará después de que actualizarEstadoCalificacion haya hecho su trabajo
      setTimeout(() => {
        const botonesActivos = card.querySelectorAll('.calificar-btn-backoffice.activo');
        console.log(`✨ Requisito ${requisitoId}: ${botonesActivos.length} botones con clase activo después de delay`);
        
        botonesActivos.forEach(btn => {
          const estado = btn.dataset.estado;
          console.log(`🎯 Botón ${estado} mantiene clase activo para requisito ${requisitoId}`);
        });
      }, 50);
    });
  }

  // Función para calificar documento
  function calificarDocumento(requisitoId, estado, opcionId = null) {
    console.log(`Calificando documento: requisitoId=${requisitoId}, estado=${estado}, opcionId=${opcionId}`);
    
    const data = {
      requisito_solicitud_id: requisitoId,
      estado: estado,
      opcion_desplegable_id: opcionId
    };

    fetch('/workflow/api/documento/calificar/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify(data)
    })
      .then(response => {
        console.log('Respuesta del servidor calificar:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Datos recibidos de calificación:', data);
        if (data.success) {
          // Actualizar interfaz
          console.log('Llamando a actualizarEstadoCalificacion...');
          actualizarEstadoCalificacion(requisitoId, estado, data.data || { usuario: 'Usuario actual' });
          
          // ✅ INDICADOR VISUAL: Mostrar que se está verificando el botón
          const btnAvanzar = document.getElementById('btn-avanzar-subestado');
          if (btnAvanzar) {
            const textoOriginal = btnAvanzar.innerHTML;
            btnAvanzar.innerHTML = '<i class="fas fa-sync fa-spin me-2"></i>Verificando...';
            setTimeout(() => {
              btnAvanzar.innerHTML = textoOriginal;
            }, 1000); // Mostrar "Verificando..." por 1 segundo
          }
          
          // Preservar estado después de un breve delay
          setTimeout(() => {
            console.log('Preservando estado después de calificación...');
            preservarEstadosBotones();
            
            // Verificar si todos los documentos están calificados y mostrar mensaje indicativo
            const verificacion = verificarDocumentosPendientes();
            
            // Eliminar clase documento-pendiente de todos los elementos
            document.querySelectorAll('.documento-pendiente').forEach(elem => {
              elem.classList.remove('documento-pendiente');
            });
            
            // Si hay documentos pendientes, resaltarlos
            verificacion.pendientes.forEach(req => {
              if (req.elemento) {
                req.elemento.classList.add('documento-pendiente');
              }
            });
            
            // ✅ SOLO USAR BACKEND: No más lógica JavaScript local confusa
            setTimeout(() => {
              verificarEstadoInicialBotonAvanzar(); // Solo consultar el backend
            }, 200); // Pequeño delay para que el DOM se actualice primero
            
            // Si todos los documentos están calificados, mostrar mensaje informativo
            if (verificacion.todoCalificado) {
              const btnAvanzar = document.querySelector('#subestados-container button:not([disabled])');
              if (btnAvanzar) {
                // Hacer parpadear el botón de avanzar
                btnAvanzar.classList.add('btn-pulsating');
                setTimeout(() => {
                  btnAvanzar.classList.remove('btn-pulsating');
                }, 3000);
                
                // Mostrar mensaje informativo
                mostrarMensaje('¡Todos los documentos han sido calificados! Ahora puede avanzar al siguiente estado.', 'info');
              }
            }
          }, 100);
          
          mostrarMensaje('Calificación guardada exitosamente', 'success');
        } else {
          mostrarMensaje('Error al guardar calificación: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('Error en calificarDocumento:', error);
        mostrarMensaje('Error de conexión', 'error');
      });
  }

  // Función para agregar comentario
  function agregarComentario(requisitoId, comentario) {
    const data = {
      requisito_solicitud_id: requisitoId,
      comentario: comentario
    };

    fetch('/workflow/api/documento/comentar/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar modal de comentarios
          actualizarModalComentarios(requisitoId);
          mostrarMensaje('Comentario agregado exitosamente', 'success');
        } else {
          mostrarMensaje('Error al agregar comentario: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error de conexión', 'error');
      });
  }

  // Función para obtener comentarios
  function obtenerComentarios(requisitoId) {
    return fetch(`/workflow/api/documento/${requisitoId}/comentarios/`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          return data.data;
        } else {
          throw new Error(data.error);
        }
      });
  }

  // Función para actualizar estado de calificación en la interfaz
  function actualizarEstadoCalificacion(requisitoId, estado, data) {
    console.log(`🎯 Actualizando estado: requisito=${requisitoId}, estado=${estado}`);
    
    if (!requisitoId) {
      console.warn('⚠️ requisitoId es null o undefined');
      return;
    }

    const card = document.querySelector(`[data-requisito-id="${requisitoId}"]`);
    if (!card) {
      console.warn(`⚠️ No se encontró la card para el requisito ${requisitoId}`);
      return;
    }

    console.log(`✅ Card encontrada para requisito ${requisitoId}`);

    // Actualizar botones de calificación
    const botones = card.querySelectorAll('.calificar-btn-backoffice');
    console.log(`🔘 Encontrados ${botones.length} botones de calificación`);

    botones.forEach((btn, index) => {
      const btnEstado = btn.dataset.estado;
      const esteEsElBotonActivo = btnEstado === estado;
      
      console.log(`🔘 Botón ${index + 1}: estado="${btnEstado}", debe estar activo: ${esteEsElBotonActivo}`);
      
      // Limpiar estado anterior
      btn.classList.remove('activo');
      
      // Activar solo el botón correspondiente
      if (esteEsElBotonActivo) {
        btn.classList.add('activo');
        console.log(`✨ Clase 'activo' agregada al botón ${btnEstado}`);
        
        // Forzar estilo inline para asegurar que se vea - MÁS FUERTE
        if (estado === 'bueno') {
          btn.style.setProperty('background-color', '#198754', 'important');
          btn.style.setProperty('border-color', '#198754', 'important');
          btn.style.setProperty('color', 'white', 'important');
          btn.style.setProperty('font-weight', 'bold', 'important');
          btn.style.setProperty('box-shadow', '0 0 10px rgba(25, 135, 84, 0.5)', 'important');
        } else if (estado === 'subsanado') {
          btn.style.setProperty('background-color', '#17a2b8', 'important');
          btn.style.setProperty('border-color', '#17a2b8', 'important');
          btn.style.setProperty('color', 'white', 'important');
          btn.style.setProperty('font-weight', 'bold', 'important');
          btn.style.setProperty('box-shadow', '0 0 10px rgba(23, 162, 184, 0.5)', 'important');
        } else if (estado === 'pendiente') {
          btn.style.setProperty('background-color', '#ffc107', 'important');
          btn.style.setProperty('border-color', '#ffc107', 'important');
          btn.style.setProperty('color', '#212529', 'important');
          btn.style.setProperty('font-weight', 'bold', 'important');
          btn.style.setProperty('box-shadow', '0 0 10px rgba(255, 193, 7, 0.5)', 'important');
        } else {
          btn.style.setProperty('background-color', '#dc3545', 'important');
          btn.style.setProperty('border-color', '#dc3545', 'important');
          btn.style.setProperty('color', 'white', 'important');
          btn.style.setProperty('font-weight', 'bold', 'important');
          btn.style.setProperty('box-shadow', '0 0 10px rgba(220, 53, 69, 0.5)', 'important');
        }
        
        // FORZAR que se mantenga así para siempre
        btn.setAttribute('data-calificado', estado);
        
        // Verificar que la clase se agregó correctamente
        setTimeout(() => {
          const tieneActivo = btn.classList.contains('activo');
          console.log(`🔍 Verificación: botón ${btnEstado} tiene clase activo: ${tieneActivo}`);
          console.log(`📝 Clases finales del botón: ${btn.className}`);
        }, 10);
      } else {
        // Resetear estilo para botones no activos
        btn.style.backgroundColor = '';
        btn.style.borderColor = '';
        btn.style.color = '';
      }
    });

    console.log(`🏁 Estado visual actualizado para requisito ${requisitoId}`);
  }

  // Función para actualizar modal de comentarios
  function actualizarModalComentarios(requisitoId) {
    obtenerComentarios(requisitoId)
      .then(comentarios => {
        const comentariosContainer = document.getElementById('comentarios-container');
        if (!comentariosContainer) return;

        comentariosContainer.innerHTML = '';

        if (comentarios.length === 0) {
          comentariosContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comment-slash fa-2x mb-2"></i>
                        <p>No hay comentarios aún</p>
                    </div>
                `;
          return;
        }

        comentarios.forEach(comentario => {
          const comentarioDiv = document.createElement('div');
          comentarioDiv.className = 'comentario-item';

          // Obtener información adicional del contexto
          const solicitudCodigo = '{{ solicitud.codigo|default:"Sin código" }}';

          // Usar la información que viene del backend
          const currentEtapa = comentario.etapa || 'Sin etapa';
          const currentSubestado = comentario.subestado || 'Sin subestado';

          // Calcular tiempo transcurrido
          const fechaComentario = new Date(comentario.fecha);
          const ahora = new Date();
          const diffMs = ahora - fechaComentario;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);

          let tiempoTranscurrido = '';
          if (diffDays > 0) {
            tiempoTranscurrido = `hace ${diffDays} día${diffDays > 1 ? 's' : ''}`;
          } else if (diffHours > 0) {
            tiempoTranscurrido = `hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
          } else if (diffMins > 0) {
            tiempoTranscurrido = `hace ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
          } else {
            tiempoTranscurrido = 'hace unos segundos';
          }

          comentarioDiv.innerHTML = `
                    <div class="comentario-header">
                        <div class="comentario-info-principal">
                            <div class="comentario-autor-info">
                                <div class="comentario-avatar">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="comentario-details">
                                    <div class="comentario-autor">${comentario.usuario_nombre}</div>
                                    <div class="comentario-meta">
                                        <span class="comentario-etapa">
                                            <i class="fas fa-layer-group me-1"></i>
                                            ${currentEtapa}
                                        </span>
                                        <span class="comentario-subestado">
                                            <i class="fas fa-tag me-1"></i>
                                            ${currentSubestado}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="comentario-tiempo">
                                <div class="comentario-fecha">${comentario.fecha}</div>
                                <div class="comentario-tiempo-transcurrido">${tiempoTranscurrido}</div>
                            </div>
                        </div>
                        ${comentario.puede_editar ? `
                            <div class="comentario-acciones">
                                <button class="btn btn-sm btn-outline-primary btn-editar-comentario" 
                                        onclick="editarComentario(${comentario.id}, '${comentario.comentario}')"
                                        title="Editar comentario">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="comentario-content">
                        <div class="comentario-texto">${comentario.comentario}</div>
                        <div class="comentario-footer">
                            <div class="comentario-solicitud">
                                <i class="fas fa-file-alt me-1"></i>
                                Solicitud: ${solicitudCodigo}
                            </div>
                            <div class="comentario-id">
                                <i class="fas fa-hashtag me-1"></i>
                                Comentario #${comentario.id}
                            </div>
                        </div>
                    </div>
                `;
          comentariosContainer.appendChild(comentarioDiv);
        });

        // Actualizar contador de comentarios en el botón
        const comentarioBtn = document.querySelector(`[data-requisito="${requisitoId}"].comentario-btn-backoffice`);
        if (comentarioBtn) {
          const badge = comentarioBtn.querySelector('.badge');
          if (badge) {
            badge.textContent = comentarios.length;
          }
        }
      })
      .catch(error => {
        console.error('Error al obtener comentarios:', error);
      });
  }

  // Función para mostrar modal de comentarios
  function mostrarModalComentarios(requisitoId) {
    currentRequisitoId = requisitoId;

    // Actualizar contenido del modal
    actualizarModalComentarios(requisitoId);

    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalComentarios'));
    modal.show();
  }

  // Función para cargar estados iniciales de calificaciones
  function cargarEstadosInicialesCalificaciones() {
    console.log('Cargando estados iniciales de calificaciones...');

    // Obtener todos los requisitos que tienen calificaciones
    const requisitos = document.querySelectorAll('[data-requisito-id]');
    console.log(`Encontrados ${requisitos.length} requisitos con data-requisito-id`);

    requisitos.forEach(requisito => {
      const requisitoId = requisito.getAttribute('data-requisito-id');
      console.log(`Procesando requisito ID: ${requisitoId}`);
      
      if (requisitoId && requisitoId !== 'null' && requisitoId !== 'undefined') {
        // Validar que el ID sea un número válido
        const numericId = parseInt(requisitoId);
        if (isNaN(numericId) || numericId <= 0) {
          console.warn(`ID de requisito inválido: ${requisitoId}`);
          return;
        }
        
        // Obtener calificaciones para este requisito
        fetch(`/workflow/api/documento/${requisitoId}/calificaciones/`)
          .then(response => {
            console.log(`Respuesta para requisito ${requisitoId}: status ${response.status}`);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log(`Datos recibidos para requisito ${requisitoId}:`, data);
            if (data.success && data.data && data.data.length > 0) {
              // Tomar la calificación más reciente
              const ultimaCalificacion = data.data[0];
              console.log(`Calificación encontrada para requisito ${requisitoId}:`, ultimaCalificacion);

              // Actualizar el estado visual
              actualizarEstadoCalificacion(requisitoId, ultimaCalificacion.estado, {
                usuario: ultimaCalificacion.usuario_nombre || 'Usuario'
              });
            } else {
              console.log(`No hay calificaciones para requisito ${requisitoId}`);
            }
          })
          .catch(error => {
            console.error(`Error al cargar calificaciones para requisito ${requisitoId}:`, error);
            // No mostrar mensaje de error al usuario para evitar spam de errores
            // Solo loggear en consola para debugging
          });
      } else {
        console.warn(`RequisitoId inválido o vacío: ${requisitoId}`);
      }
    });
    
    // Preservar estados después de cargar todos los requisitos
    setTimeout(() => {
      console.log('Preservando estados después de cargar todos los requisitos...');
      preservarEstadosBotones();
    }, 500);
  }

  // Función para obtener CSRF token
  function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  // Función para mostrar mensajes
  function mostrarMensaje(mensaje, tipo) {
    // Crear elemento de alerta
    const alertDiv = document.createElement('div');
    let alertClass = 'alert alert-dismissible fade show';
    let iconClass = '';
    
    switch(tipo) {
      case 'success':
        alertClass += ' alert-success';
        iconClass = 'fas fa-check-circle';
        break;
      case 'warning':
        alertClass += ' alert-warning';
        iconClass = 'fas fa-exclamation-triangle';
        break;
      case 'info':
        alertClass += ' alert-info';
        iconClass = 'fas fa-info-circle';
        break;
      case 'error':
      default:
        alertClass += ' alert-danger';
        iconClass = 'fas fa-exclamation-circle';
        break;
    }
    
    alertDiv.className = alertClass;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.maxWidth = '400px';
    alertDiv.innerHTML = `
        <i class="${iconClass} me-2"></i>${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // Auto-remover después de 5 segundos para warnings, 3 para otros
    const timeout = tipo === 'warning' ? 5000 : 3000;
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, timeout);
  }

  // Event listeners cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', function () {
    // Cargar estados iniciales de calificaciones
    cargarEstadosInicialesCalificaciones();

    // VERIFICAR Y MARCAR BOTONES QUE YA ESTÁN CALIFICADOS
    setTimeout(() => {
      const todosBotones = document.querySelectorAll('.calificar-btn-backoffice[data-calificado]');
      console.log(`🔍 Encontrados ${todosBotones.length} botones que deberían estar marcados`);
      
      todosBotones.forEach(btn => {
        const estado = btn.getAttribute('data-calificado');
        console.log(`🎯 Forzando estilo para botón ${estado}`);
        
        if (estado === 'bueno') {
          btn.style.backgroundColor = '#198754 !important';
          btn.style.borderColor = '#198754 !important';
          btn.style.color = 'white !important';
          btn.style.fontWeight = 'bold';
          btn.style.boxShadow = '0 0 10px rgba(25, 135, 84, 0.5)';
        } else if (estado === 'malo') {
          btn.style.backgroundColor = '#dc3545 !important';
          btn.style.borderColor = '#dc3545 !important';
          btn.style.color = 'white !important';
          btn.style.fontWeight = 'bold';
          btn.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.5)';
        } else if (estado === 'pendiente') {
          btn.style.backgroundColor = '#ffc107 !important';
          btn.style.borderColor = '#ffc107 !important';
          btn.style.color = '#212529 !important';
          btn.style.fontWeight = 'bold';
          btn.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.5)';
        } else if (estado === 'subsanado') {
          btn.style.backgroundColor = '#17a2b8 !important';
          btn.style.borderColor = '#17a2b8 !important';
          btn.style.color = 'white !important';
          btn.style.fontWeight = 'bold';
          btn.style.boxShadow = '0 0 10px rgba(23, 162, 184, 0.5)';
        }
      });
    }, 1000);

    // Botones de calificación
    document.addEventListener('click', function (e) {
      if (e.target.closest('.calificar-btn-backoffice')) {
        const btn = e.target.closest('.calificar-btn-backoffice');
        const requisitoId = btn.dataset.requisito;
        const estado = btn.dataset.estado;

        if (requisitoId && estado && !btn.disabled) {
          calificarDocumento(requisitoId, estado);
        }
      }

      // Botón de comentarios
      if (e.target.closest('.comentario-btn-backoffice')) {
        const btn = e.target.closest('.comentario-btn-backoffice');
        const requisitoId = btn.dataset.requisito;

        if (requisitoId && !btn.disabled) {
          mostrarModalComentarios(requisitoId);
        } else if (!requisitoId) {
          mostrarMensaje('No se pueden agregar comentarios: archivo no subido todavía', 'warning');
        }
      }

    });

    // Formulario de nuevo comentario
    const formComentario = document.getElementById('form-nuevo-comentario');
    if (formComentario) {
      formComentario.addEventListener('submit', function (e) {
        e.preventDefault();

        const textarea = this.querySelector('textarea[name="comentario"]');
        const comentario = textarea.value.trim();

        if (comentario && currentRequisitoId) {
          agregarComentario(currentRequisitoId, comentario);
          textarea.value = '';
        }
      });
    }

    // Modal Avanzar Etapa
    const modalAvanzarEtapa = document.getElementById('modalAvanzarEtapa');
    if (modalAvanzarEtapa) {
      modalAvanzarEtapa.addEventListener('show.bs.modal', function (event) {
        cargarOpcionesAvance();
      });
    }
  });

  // =======================================================
  // FUNCIONALIDAD DEL MODAL DE OPCIONES
  // =======================================================

  // Variable global para almacenar el requisito actual
  let currentRequisitoForOpciones = null;

  // Función para mostrar el modal de opciones
  async function mostrarModalOpciones(requisitoId, documentoNombre) {
    currentRequisitoForOpciones = requisitoId;

    // Actualizar el nombre del documento en el modal
    document.getElementById('opciones-documento-nombre').textContent = documentoNombre;

    // Mostrar el modal primero
    const modal = new bootstrap.Modal(document.getElementById('modalOpciones'));
    modal.show();

    // Cargar las opciones disponibles
    await cargarOpcionesDisponibles();
  }

  // Función para cargar las opciones disponibles
  async function cargarOpcionesDisponibles() {
    const opcionesContainer = document.getElementById('opciones-container');
    
    try {
      // Mostrar loading
      opcionesContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando opciones...</div>';
      
      // Obtener opciones desde la API
      const response = await fetch('/workflow/api/opciones-desplegables/', {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCsrfToken()
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        opcionesContainer.innerHTML = '';
        
        data.data.forEach(opcion => {
          const opcionDiv = document.createElement('div');
          opcionDiv.className = 'opcion-item-modal mb-2 p-3 border rounded cursor-pointer';
          opcionDiv.style.cursor = 'pointer';
          opcionDiv.style.transition = 'all 0.2s ease';
          opcionDiv.innerHTML = `
            <div class="d-flex align-items-center">
              <i class="fas fa-exclamation-circle text-warning me-3"></i>
              <div class="flex-grow-1">
                <strong>${opcion.nombre}</strong>
                ${opcion.descripcion ? `<br><small class="text-muted">${opcion.descripcion}</small>` : ''}
              </div>
              <i class="fas fa-chevron-right text-muted"></i>
            </div>
          `;

          // Agregar efectos hover
          opcionDiv.addEventListener('mouseenter', function () {
            this.style.backgroundColor = '#f8f9fa';
            this.style.borderColor = '#4a7c59';
          });

          opcionDiv.addEventListener('mouseleave', function () {
            this.style.backgroundColor = '';
            this.style.borderColor = '';
          });

          // Agregar evento click
          opcionDiv.addEventListener('click', function () {
            seleccionarOpcion(opcion.id, opcion.nombre);
          });

          opcionesContainer.appendChild(opcionDiv);
        });
      } else {
        opcionesContainer.innerHTML = '<div class="alert alert-warning">Error al cargar las opciones</div>';
      }
    } catch (error) {
      console.error('Error cargando opciones:', error);
      opcionesContainer.innerHTML = '<div class="alert alert-danger">Error de conexión al cargar las opciones</div>';
    }
  }

  // Función para seleccionar una opción
  function seleccionarOpcion(opcionId, opcionNombre) {
    if (!currentRequisitoForOpciones) {
      console.error('No hay requisito seleccionado');
      return;
    }

    // Calificar como malo con la opción seleccionada
    calificarDocumento(currentRequisitoForOpciones, 'malo', opcionId);

    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalOpciones'));
    if (modal) {
      modal.hide();
    }

    // Mostrar mensaje de confirmación
    mostrarMensaje(`Documento calificado como malo: ${opcionNombre}`, 'success');
  }

  // =====================================================
  // FUNCIONES PARA AVANZAR ETAPA
  // =====================================================

  async function cargarOpcionesAvance() {
    const solicitudId = {{ solicitud.id }};
    console.log('Cargando opciones de avance para solicitud:', solicitudId);
    
    try {
      // Cargar subestados disponibles
      console.log('Llamando a API de subestados...');
      const responseSubestados = await fetch(`/workflow/api/subestados-disponibles/${solicitudId}/`);
      console.log('Respuesta subestados status:', responseSubestados.status);
      const dataSubestados = await responseSubestados.json();
      console.log('Data subestados:', dataSubestados);
      
      // Cargar transiciones disponibles
      console.log('Llamando a API de transiciones...');
      const responseTransiciones = await fetch(`/workflow/api/transiciones-disponibles/${solicitudId}/`);
      console.log('Respuesta transiciones status:', responseTransiciones.status);
      const dataTransiciones = await responseTransiciones.json();
      console.log('Data transiciones:', dataTransiciones);
      
      // Renderizar opciones
      renderizarSubestados(dataSubestados);
      renderizarTransiciones(dataTransiciones);
      
    } catch (error) {
      console.error('Error cargando opciones de avance:', error);
      mostrarMensaje('Error al cargar las opciones de avance', 'error');
    }
  }

  function renderizarSubestados(data) {
    console.log('Renderizando subestados con validación secuencial:', data);
    const container = document.getElementById('subestados-container');
    
    if (!data.success) {
      container.innerHTML = `<div class="alert alert-warning">${data.message || 'Error al cargar subestados'}</div>`;
      return;
    }
    
    if (!data.subestados || data.subestados.length === 0) {
      container.innerHTML = '<p class="text-muted">No hay subestados disponibles para avanzar.</p>';
      return;
    }
    
    let html = '';
    
    // Agregar información sobre validación secuencial
    if (data.validacion_secuencial) {
      if (data.navegacion_libre_atras && data.bloqueo_solo_avance) {
        html += `
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Navegación Flexible:</strong> Puedes retroceder a etapas completadas o avanzar al siguiente subestado disponible.
          </div>
        `;
      } else {
        html += `
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Navegación Secuencial:</strong> Solo puedes avanzar al siguiente subestado en orden.
          </div>
        `;
      }
    }
    
    data.subestados.forEach(subestado => {
      const isActual = subestado.es_actual || subestado.id === data.subestado_actual_id;
      const esCompletado = subestado.es_completado;
      const puedeAvanzar = subestado.puede_avanzar;
      const estaBloqueado = subestado.esta_bloqueado;
      
      let cardClass = 'card mb-2';
      let btnClass = 'btn btn-sm';
      let btnText = '';
      let disabled = '';
      let statusBadge = '';
      let reasonMessage = '';
      
      if (isActual) {
        cardClass += ' border-success bg-light';
        btnClass += ' btn-outline-secondary';
        btnText = 'Actual';
        disabled = 'disabled';
        statusBadge = '<span class="badge bg-success ms-2">Actual</span>';
      } else if (esCompletado) {
        // Subestados completados - navegación libre permitida
        cardClass += ' border-warning bg-light';
        btnClass += ' btn-warning';
        btnText = 'Regresar';
        statusBadge = '<span class="badge bg-warning ms-2">Completado</span>';
      } else if (puedeAvanzar) {
        // Siguiente subestado disponible
        cardClass += ' border-primary';
        btnClass += ' btn-primary';
        btnText = 'Avanzar';
        statusBadge = '<span class="badge bg-primary ms-2">Disponible</span>';
      } else if (estaBloqueado) {
        // Subestados bloqueados (saltos hacia adelante)
        cardClass += ' border-secondary';
        btnClass += ' btn-outline-secondary';
        btnText = 'Bloqueado';
        disabled = 'disabled';
        statusBadge = '<span class="badge bg-secondary ms-2">Bloqueado</span>';
        if (subestado.razon_bloqueado) {
          reasonMessage = `<small class="text-muted d-block mt-1"><i class="fas fa-lock me-1"></i>${subestado.razon_bloqueado}</small>`;
        }
      }
      
      html += `
        <div class="${cardClass}">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="flex-grow-1">
                <h6 class="mb-1">
                  <span class="badge bg-dark me-2">${subestado.orden}</span>
                  ${subestado.nombre}
                  ${statusBadge}
                </h6>
                ${isActual ? '<small class="text-success"><i class="fas fa-check-circle me-1"></i>Subestado activo actualmente</small>' : ''}
                ${esCompletado ? '<small class="text-warning"><i class="fas fa-undo me-1"></i>Puedes regresar a esta etapa completada</small>' : ''}
                ${puedeAvanzar && !isActual ? '<small class="text-primary"><i class="fas fa-arrow-right me-1"></i>Siguiente subestado disponible</small>' : ''}
                ${estaBloqueado ? '<small class="text-muted"><i class="fas fa-ban me-1"></i>No puede saltar a esta etapa</small>' : ''}
                ${reasonMessage}
              </div>
              <button class="${btnClass}" ${disabled} 
                      onclick="avanzarSubestado(${subestado.id})"
                      data-subestado-id="${subestado.id}"
                      title="${isActual ? 'Subestado actual' : esCompletado ? 'Regresar a esta etapa completada' : puedeAvanzar ? 'Avanzar a este subestado' : subestado.razon_bloqueado || 'No disponible'}">
                <i class="fas fa-${isActual ? 'check' : esCompletado ? 'undo' : puedeAvanzar ? 'arrow-right' : 'lock'} me-1"></i>${btnText}
              </button>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  function renderizarTransiciones(data) {
    console.log('Renderizando transiciones:', data);
    const container = document.getElementById('transiciones-container');
    
    if (!data.success) {
      container.innerHTML = `<div class="alert alert-warning">${data.message || 'Error al cargar transiciones'}</div>`;
      return;
    }
    
    if (!data.transiciones || data.transiciones.length === 0) {
      container.innerHTML = '<p class="text-muted">No hay transiciones disponibles.</p>';
      return;
    }
    
    let html = '';
    data.transiciones.forEach(transicion => {
      html += `
        <div class="card mb-2">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">${transicion.nombre}</h6>
                <small class="text-muted">
                  ${transicion.etapa_origen} → ${transicion.etapa_destino}
                </small>
              </div>
              <button class="btn btn-sm btn-outline-success" 
                      onclick="ejecutarTransicion(${transicion.id})">
                <i class="fas fa-exchange-alt me-1"></i>Ejecutar
              </button>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  // Función para verificar si todos los documentos han sido calificados
  function verificarDocumentosPendientes() {
    const requisitos = document.querySelectorAll('[data-requisito-id]');
    const totalRequisitos = requisitos.length;
    let requisitosSinCalificar = [];

    // Si no hay requisitos, consideramos que todo está calificado
    if (totalRequisitos === 0) {
      console.log('No hay requisitos para calificar');
      return {
        todoCalificado: true,
        pendientes: []
      };
    }

    // Verificar cada requisito
    requisitos.forEach(requisito => {
      const requisitoId = requisito.getAttribute('data-requisito-id');
      const requisitoNombre = requisito.querySelector('.card-title')?.textContent?.trim() || `Requisito ${requisitoId}`;
      
      // Verificar si tiene algún botón activo (calificado)
      const botonesCalificados = requisito.querySelectorAll('.calificar-btn-backoffice.active');
      
      if (botonesCalificados.length === 0) {
        // Este requisito no ha sido calificado
        requisitosSinCalificar.push({
          id: requisitoId,
          nombre: requisitoNombre
        });
      }
    });

    return {
      todoCalificado: requisitosSinCalificar.length === 0,
      pendientes: requisitosSinCalificar
    };
  }

  // Función para verificar si todos los documentos han sido calificados
  function verificarDocumentosPendientes() {
    const requisitos = document.querySelectorAll('.requisito-item');
    const totalRequisitos = requisitos.length;
    let requisitosSinCalificar = [];

    // Si no hay requisitos, consideramos que todo está calificado
    if (totalRequisitos === 0) {
      console.log('No hay requisitos para calificar');
      return {
        todoCalificado: true,
        pendientes: []
      };
    }

    // Verificar cada requisito
    requisitos.forEach(requisito => {
      const requisitoId = requisito.getAttribute('data-requisito-id');
      const requisitoNombre = requisito.querySelector('.card-title')?.textContent?.trim() || 
                              requisito.querySelector('h5')?.textContent?.trim() || 
                              `Requisito ${requisitoId}`;
      
      // Verificar si tiene algún botón activo (calificado) - usando la clase correcta 'activo'
      const botonesCalificados = requisito.querySelectorAll('.calificar-btn.activo, .calificar-btn-backoffice.activo');
      
      // Verificar si tiene un botón "pendiente" (solo para documentos opcionales)
      const botonPendiente = requisito.querySelector('.calificar-btn-backoffice[data-estado="pendiente"].activo');
      
      if (botonesCalificados.length === 0) {
        // Este requisito no ha sido calificado
        requisitosSinCalificar.push({
          id: requisitoId,
          nombre: requisitoNombre,
          elemento: requisito
        });
      } else if (botonPendiente) {
        // Si tiene un botón pendiente activo, NO lo consideramos como bloqueante
        // ya que los documentos opcionales "Pendiente" no bloquean el avance
        console.log(`✅ Documento opcional "${requisitoNombre}" marcado como Pendiente - No bloquea el avance`);
      }
    });

    return {
      todoCalificado: requisitosSinCalificar.length === 0,
      pendientes: requisitosSinCalificar
    };
  }

  async function avanzarSubestado(subestadoId) {
    const solicitudId = {{ solicitud.id }};
    
    console.log(`Intentando avanzar subestado: solicitud=${solicitudId}, subestado=${subestadoId}`);
    
    try {
      // Verificar si todos los documentos han sido calificados
      const verificacion = verificarDocumentosPendientes();
      
      if (!verificacion.todoCalificado) {
        // Si hay documentos sin calificar, mostrar un mensaje al usuario
        let listaPendientes = '';
        verificacion.pendientes.forEach(req => {
          listaPendientes += `<li>${req.nombre}</li>`;
          
          // Resaltar visualmente los documentos pendientes
          if (req.elemento) {
            req.elemento.classList.add('documento-pendiente');
            
            // Hacer scroll al primer documento pendiente
            if (listaPendientes.split('<li>').length - 1 === 1) {
              req.elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        });
        
        Swal.fire({
          title: 'Documentos sin calificar',
          html: `<div class="text-start">
                  <p>No puede avanzar al siguiente estado hasta calificar todos los documentos:</p>
                  <ul class="text-start">${listaPendientes}</ul>
                 </div>`,
          icon: 'warning',
          confirmButtonText: 'Entendido',
          confirmButtonColor: '#3085d6',
          allowOutsideClick: false
        });
        
        return; // Detener la ejecución y no permitir avanzar
      }
      
      // Deshabilitar todos los botones temporalmente
      const buttons = document.querySelectorAll('#subestados-container button');
      const targetButton = document.querySelector(`button[data-subestado-id="${subestadoId}"]`);
      
      buttons.forEach(btn => {
        btn.disabled = true;
      });

      if (targetButton) {
        targetButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
      }

      const response = await fetch(`/workflow/api/avanzar-subestado/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          solicitud_id: solicitudId,
          subestado_id: subestadoId
        })
      });
      
      console.log('Respuesta del servidor:', response.status);
      const data = await response.json();
      console.log('Data recibida:', data);
      
      if (data.success) {
        mostrarMensaje(data.message || 'Subestado avanzado correctamente', 'success');
        
        // Actualizar pestañas secuenciales
        actualizarPestanasSecuenciales();
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAvanzarEtapa'));
        if (modal) {
          modal.hide();
        }
        
        // Mostrar mensaje de recarga
        mostrarMensaje('Recargando página para reflejar los cambios...', 'info');
        
        // Recargar página después de un breve delay
        setTimeout(() => {
          console.log('Recargando página...');
          window.location.reload();
        }, 2000);
      } else {
        // Manejar diferentes tipos de errores
        let tipoMensaje = 'error';
        
        // Si es un error de validación secuencial, usar tipo 'warning'
        if (data.message && (
          data.message.includes('secuencialmente') || 
          data.message.includes('siguiente subestado') ||
          data.message.includes('retroceder') ||
          data.message.includes('mismo subestado')
        )) {
          tipoMensaje = 'warning';
        }
        
        mostrarMensaje(data.message || 'Error al avanzar subestado', tipoMensaje);
        
        // Rehabilitar botones
        buttons.forEach(btn => {
          // Solo rehabilitar botones que no están marcados como "actual"
          if (!btn.innerHTML.includes('Actual')) {
            btn.disabled = false;
          }
        });
        
        // Restaurar texto original del botón específico
        if (targetButton && !targetButton.innerHTML.includes('Actual')) {
          const isBlocked = targetButton.innerHTML.includes('Bloqueado');
          if (isBlocked) {
            targetButton.innerHTML = '<i class="fas fa-lock me-1"></i>Bloqueado';
            targetButton.disabled = true;
          } else {
            targetButton.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Avanzar';
            targetButton.disabled = false;
          }
        }
      }
    } catch (error) {
      console.error('Error avanzando subestado:', error);
      mostrarMensaje('Error de conexión al avanzar subestado', 'error');
      
      // Rehabilitar botones en caso de error
      const buttons = document.querySelectorAll('#subestados-container button');
      buttons.forEach(btn => {
        if (!btn.innerHTML.includes('Actual')) {
          btn.disabled = false;
        }
      });
      
      if (targetButton && !targetButton.innerHTML.includes('Actual')) {
        targetButton.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Avanzar';
        targetButton.disabled = false;
      }
    }
  }

  async function ejecutarTransicion(transicionId) {
    const solicitudId = {{ solicitud.id }};
    
    try {
      const response = await fetch(`/workflow/api/ejecutar-transicion/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          solicitud_id: solicitudId,
          transicion_id: transicionId
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        mostrarMensaje('Transición ejecutada correctamente', 'success');
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAvanzarEtapa'));
        modal.hide();
        // Redirigir a la nueva etapa
        setTimeout(() => window.location.href = data.redirect_url || window.location.href, 1000);
      } else {
        mostrarMensaje(data.message || 'Error al ejecutar transición', 'error');
      }
    } catch (error) {
      console.error('Error ejecutando transición:', error);
      mostrarMensaje('Error al ejecutar transición', 'error');
    }
  }

  // =======================================================
  // FUNCIONALIDAD PARA ASOCIAR ENTREVISTA DE CLIENTE
  // =======================================================

  let entrevistaSeleccionadaId = null;

  function mostrarModalEntrevista() {
    // Obtener datos del cliente de la solicitud actual
    const clienteNombre = "{{ solicitud.cliente_nombre_completo|default:'Cliente' }}";
    const clienteCedula = "{{ solicitud.cliente_cedula_completa|default:'No disponible' }}";
    
    // Actualizar el encabezado del modal con los datos del cliente
    document.getElementById('clienteNombreModal').textContent = clienteNombre;
    document.getElementById('clienteCedulaModal').textContent = clienteCedula;
    document.getElementById('filteredByCedula').textContent = clienteCedula;
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalAsociarEntrevista'));
    modal.show();
    
    // Limpiar búsqueda anterior y configurarla con la cédula del cliente
    const inputBusqueda = document.getElementById('buscarEntrevista');
    inputBusqueda.value = '';
    inputBusqueda.placeholder = `Buscar por nombre o email (ya filtrado por cédula)`;
    
    // Automáticamente buscar entrevistas con la misma cédula
    buscarEntrevistasPorCedula(clienteCedula);
    document.getElementById('resultadosEntrevistas').innerHTML = '';
    document.getElementById('entrevistaSeleccionada').style.display = 'none';
    document.getElementById('btnConfirmarAsociacion').disabled = true;
    entrevistaSeleccionadaId = null;
  }

  function buscarEntrevistasPorCedula(cedula) {
    if (!cedula || cedula === 'No disponible') {
      document.getElementById('resultadosEntrevistas').innerHTML = 
        '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No se puede buscar entrevistas porque la solicitud no tiene un número de cédula asociado.</div>';
      return;
    }
    
    // Mostrar loading
    document.getElementById('resultadosEntrevistas').innerHTML = 
      '<div class="text-center p-3"><i class="fas fa-spinner fa-spin me-2"></i> Buscando entrevistas para la cédula ' + cedula + '...</div>';
    
    // Realizar búsqueda AJAX filtrando por cédula
    fetch(`/workflow/buscar-entrevistas/?cedula=${encodeURIComponent(cedula)}`)
      .then(response => response.json())
      .then(data => {
        // ✅ VALIDACIÓN: Verificar que la respuesta sea exitosa y contenga entrevistas
        if (!data.success) {
          throw new Error(data.error || 'Error en la respuesta del servidor');
        }
        
        // Mostrar mensaje sobre la búsqueda flexible
        const mensajeFlexible = `
          <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-3">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-500"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm text-blue-700">
                  <strong>Búsqueda inteligente:</strong> El sistema busca entrevistas que tengan una cédula similar a <strong>${cedula}</strong>, 
                  incluso si el formato de escritura es diferente.
                </p>
                <p class="text-sm text-blue-700 mt-1">
                  <i class="fas fa-shield-alt text-blue-600 me-1"></i>
                <div class="d-flex align-items-center">
                  <strong>Nota:</strong> Por seguridad, solo puede seleccionar entrevistas con coincidencia exacta o parcial de cédula.
                  <button type="button" class="btn btn-link text-info p-0 ml-1" onclick="mostrarInfoCoincidencias()">
                    <i class="fas fa-info-circle"></i>
                  </button>
                </div>
                </p>
              </div>
            </div>
          </div>
        `;
        
        const container = document.getElementById('resultadosEntrevistas');
        container.innerHTML = mensajeFlexible;
        mostrarResultadosEntrevistas(data.entrevistas || [], cedula);
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('resultadosEntrevistas').innerHTML = 
          '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al buscar entrevistas</div>';
      });
  }

  function buscarEntrevistas() {
    const termino = document.getElementById('buscarEntrevista').value.trim();
    const clienteCedula = "{{ solicitud.cliente_cedula_completa|default:'No disponible' }}";
    
    if (termino.length < 3) {
      // Si no hay término de búsqueda, volvemos a la búsqueda por cédula
      buscarEntrevistasPorCedula(clienteCedula);
      return;
    }
    
    // Mostrar loading
    document.getElementById('resultadosEntrevistas').innerHTML = 
      '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i> Buscando...</div>';
    
    // Realizar búsqueda AJAX con filtro adicional de cédula
    fetch(`/workflow/buscar-entrevistas/?q=${encodeURIComponent(termino)}&cedula=${encodeURIComponent(clienteCedula)}`)
      .then(response => response.json())
      .then(data => {
        // ✅ VALIDACIÓN: Verificar que la respuesta sea exitosa y contenga entrevistas
        if (!data.success) {
          throw new Error(data.error || 'Error en la respuesta del servidor');
        }
        
        mostrarResultadosEntrevistas(data.entrevistas || [], clienteCedula);
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('resultadosEntrevistas').innerHTML = 
          '<div class="alert alert-danger">Error al buscar entrevistas</div>';
      });
  }

  function mostrarResultadosEntrevistas(entrevistas, cedula) {
    const container = document.getElementById('resultadosEntrevistas');
    
    // ✅ VALIDACIÓN: Asegurar que entrevistas sea un array válido
    if (!entrevistas || !Array.isArray(entrevistas)) {
      console.warn('Entrevistas no es un array válido:', entrevistas);
      entrevistas = []; // Usar array vacío como fallback
    }
    
    // Función para comparar similitud entre cédulas
    function compararCedulas(cedula1, cedula2) {
      // 1. Normalizar cedulas para comparación (mantener números y letras, quitar guiones y espacios)
      const normalizada1 = cedula1.replace(/[-\s]/g, '').toUpperCase();
      const normalizada2 = cedula2.replace(/[-\s]/g, '').toUpperCase();
      
      // Coincidencia exacta después de normalizar
      if (normalizada1 === normalizada2) return 'exacta';
      
      // 2. Extraer números y letras por separado
      const numerosYLetras1 = normalizada1.match(/[0-9A-Z]/g) || [];
      const numerosYLetras2 = normalizada2.match(/[0-9A-Z]/g) || [];
      
      // Verificar si las versiones sin caracteres especiales coinciden
      if (numerosYLetras1.join('') === numerosYLetras2.join('')) return 'exacta';
      
      // 3. Extraer solo números para comparación numérica
      const numeros1 = normalizada1.replace(/[^0-9]/g, '');
      const numeros2 = normalizada2.replace(/[^0-9]/g, '');
      
      // Si ambas tienen números
      if (numeros1.length > 0 && numeros2.length > 0) {
        // 4. Comparar primeros dígitos (entre 3-4 dígitos iniciales)
        const primerDigitos1 = numeros1.substring(0, Math.min(4, numeros1.length));
        const primerDigitos2 = numeros2.substring(0, Math.min(4, numeros2.length));
        
        // 5. Comparar últimos dígitos (6-8 dígitos finales)
        const ultimosDigitos1 = numeros1.length > 6 ? numeros1.slice(-8) : numeros1;
        const ultimosDigitos2 = numeros2.length > 6 ? numeros2.slice(-8) : numeros2;
        
        // Si coinciden los primeros o últimos dígitos significativos
        if ((primerDigitos1 === primerDigitos2 && primerDigitos1.length >= 3) || 
            (ultimosDigitos1 === ultimosDigitos2 && ultimosDigitos1.length >= 4)) {
          return 'parcial';
        }
        
        // 6. Calcular distancia de Levenshtein para detectar errores de tipografía
        // Solo si las longitudes son similares (diferencia máxima de 2 caracteres)
        if (Math.abs(numeros1.length - numeros2.length) <= 2) {
          const distancia = levenshteinDistance(numeros1, numeros2);
          // Si la distancia es pequeña en relación al tamaño de la cédula (máximo 2 caracteres diferentes)
          if (distancia <= 2) {
            return 'parcial';
          }
        }
        
        // 7. Verificar si al menos la mitad de los caracteres coinciden (para cédulas de longitud similar)
        if (Math.abs(normalizada1.length - normalizada2.length) <= 3) {
          let coincidencias = 0;
          const minLength = Math.min(normalizada1.length, normalizada2.length);
          
          // Contar caracteres coincidentes en las mismas posiciones
          for (let i = 0; i < minLength; i++) {
            if (normalizada1[i] === normalizada2[i]) {
              coincidencias++;
            }
          }
          
          // Si coinciden más del 70% de los caracteres
          if (coincidencias >= 0.7 * minLength) {
            return 'parcial';
          }
        }
      }
      
      // 8. Comparar letras (importante para extranjeros)
      const letras1 = normalizada1.replace(/[^A-Z]/g, '');
      const letras2 = normalizada2.replace(/[^A-Z]/g, '');
      
      // Si ambas tienen la misma letra de extranjero y algunos dígitos coinciden
      if (letras1 && letras2 && letras1 === letras2) {
        // Verificar si al menos algunos dígitos coinciden
        if (numeros1 && numeros2 && 
            (numeros1.includes(numeros2.slice(-4)) || numeros2.includes(numeros1.slice(-4)))) {
          return 'parcial';
        }
      }
      
      return 'ninguna';
    }
    
    // Función para calcular distancia de Levenshtein (para comparación fuzzy)
    function levenshteinDistance(a, b) {
      if (a.length === 0) return b.length;
      if (b.length === 0) return a.length;
      
      const matrix = [];
      
      // Inicializar matriz
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      
      // Rellenar matriz
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          const costo = a[j - 1] === b[i - 1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i - 1][j] + 1,      // eliminación
            matrix[i][j - 1] + 1,      // inserción
            matrix[i - 1][j - 1] + costo  // sustitución
          );
        }
      }
      
      return matrix[b.length][a.length];
    }
    
    if (entrevistas.length === 0) {
      const mensajeNoEntrevistas = `
        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-3">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <i class="fas fa-info-circle text-yellow-500"></i>
            </div>
            <div class="ml-3">
              <p class="text-sm text-yellow-700">
                No se encontraron entrevistas para la cédula <strong>${cedula}</strong>
              </p>
            </div>
          </div>
        </div>`;
      
      // Agregamos el mensaje al contenido existente (no reemplazamos)
      container.innerHTML += mensajeNoEntrevistas;
      return;
    }
    
    let html = `
      <div class="divide-y divide-gray-200 max-h-[50vh] overflow-y-auto px-1 py-2 rounded-md shadow-inner bg-gray-50">`;
    
    entrevistas.forEach(entrevista => {
      const coincidencia = compararCedulas(entrevista.cedula, cedula);
      let rowClass, badgeClass, badgeText;
      
      let cursorStyle, onclickAttr;
      
      if (coincidencia === 'exacta') {
        rowClass = 'bg-green-50 border border-green-200 shadow-sm hover:shadow-md';
        badgeClass = 'bg-green-100 text-green-800';
        badgeText = '<i class="fas fa-check-circle mr-1"></i>Coincidencia exacta';
        cursorStyle = 'cursor-pointer';
        onclickAttr = `onclick="seleccionarEntrevista(${entrevista.id}, '${entrevista.nombre_completo}', '${entrevista.cedula}')"`;
      } else if (coincidencia === 'parcial') {
        rowClass = 'bg-blue-50 border border-blue-200 shadow-sm hover:shadow-md'; 
        badgeClass = 'bg-blue-100 text-blue-800';
        badgeText = '<i class="fas fa-check mr-1"></i>Coincidencia parcial';
        cursorStyle = 'cursor-pointer';
        onclickAttr = `onclick="seleccionarEntrevista(${entrevista.id}, '${entrevista.nombre_completo}', '${entrevista.cedula}')"`;
      } else {
        rowClass = 'bg-gray-50 opacity-70'; // Gris claro para mostrar que está deshabilitado
        badgeClass = 'bg-red-100 text-red-800';
        badgeText = '<i class="fas fa-times-circle mr-1"></i>Sin coincidencia';
        cursorStyle = 'cursor-not-allowed';
        onclickAttr = `onclick="mostrarMensajeCoincidencia('${entrevista.cedula}', '${cedula}')"`;
      }
      
      html += `
        <div class="p-4 hover:bg-gray-100 rounded-md ${cursorStyle} transition-all duration-300 ${rowClass} mb-2" 
             ${onclickAttr}>
          <div class="flex justify-between items-start">
            <div>
              <h6 class="font-medium text-gray-900 mb-1">${entrevista.nombre_completo}</h6>
              <p class="text-gray-800 font-mono mb-1">
                <strong class="text-gray-600">Cédula:</strong> ${entrevista.cedula}
                <span class="inline-flex items-center ml-2 px-2 py-0.5 rounded-full text-xs font-medium ${badgeClass}">
                  ${badgeText}
                </span>
              </p>
              <p class="text-gray-600 text-sm">
                <strong>Email:</strong> ${entrevista.email || 'No disponible'} | 
                <strong>Teléfono:</strong> ${entrevista.telefono || 'No disponible'}
              </p>
            </div>
            <div class="flex flex-col items-end">
              <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${entrevista.tipo_producto || 'Sin producto'}</span>
              <small class="text-gray-500 mt-2">${entrevista.fecha_entrevista || 'Fecha no disponible'}</small>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    container.innerHTML = html;
  }
  
  // Función para mostrar detalles sobre las coincidencias
  function mostrarInfoCoincidencias() {
    Swal.fire({
      title: 'Criterios de Coincidencia de Cédulas',
      html: `
        <div class="text-left">
          <h5 class="font-weight-bold mb-3">Coincidencia Exacta:</h5>
          <ul class="pl-4">
            <li>Cédulas idénticas después de normalizar (eliminar guiones y espacios)</li>
            <li>Mismos caracteres alfanuméricos en el mismo orden</li>
          </ul>
          
          <h5 class="font-weight-bold mb-3 mt-4">Coincidencia Parcial:</h5>
          <ul class="pl-4">
            <li>Coinciden los primeros 3-4 dígitos <strong>o</strong> los últimos 4-8 dígitos</li>
            <li>Cédulas que difieren en máximo 2 caracteres (errores tipográficos)</li>
            <li>Más del 70% de caracteres coinciden en las mismas posiciones</li>
            <li>Misma letra para extranjeros con algunos dígitos coincidentes</li>
          </ul>
          
          <div class="alert alert-info mt-3">
            <i class="fas fa-lightbulb mr-2"></i>
            <strong>Ejemplos de coincidencia parcial:</strong>
            <ul class="mb-0 mt-1">
              <li>"8-123-456" y "8123456" (mismos dígitos, formato diferente)</li>
              <li>"1-E-234-567" y "E234567" (letra de extranjero igual)</li>
              <li>"9-876-5432" y "9-876-5431" (error tipográfico en un dígito)</li>
              <li>"10-123-456" y "123-456" (últimos 6 dígitos iguales)</li>
            </ul>
          </div>
        </div>
      `,
      icon: 'info',
      confirmButtonText: 'Entendido'
    });
  }

  function seleccionarEntrevista(id, nombre, cedula) {
    const clienteCedula = "{{ solicitud.cliente_cedula_completa|default:'No disponible' }}";
    
    // Función para comparar coincidencia entre cédulas
    function compararCedulas(cedula1, cedula2) {
      if (!cedula1 || !cedula2 || cedula1 === 'No disponible' || cedula2 === 'No disponible') return 'ninguna';
      
      // 1. Normalizar cedulas para comparación (mantener números y letras, quitar guiones y espacios)
      const normalizada1 = cedula1.replace(/[-\s]/g, '').toUpperCase();
      const normalizada2 = cedula2.replace(/[-\s]/g, '').toUpperCase();
      
      // Coincidencia exacta después de normalizar
      if (normalizada1 === normalizada2) return 'exacta';
      
      // 2. Extraer números y letras por separado
      const numerosYLetras1 = normalizada1.match(/[0-9A-Z]/g) || [];
      const numerosYLetras2 = normalizada2.match(/[0-9A-Z]/g) || [];
      
      // Verificar si las versiones sin caracteres especiales coinciden
      if (numerosYLetras1.join('') === numerosYLetras2.join('')) return 'exacta';
      
      // 3. Extraer solo números para comparación numérica
      const numeros1 = normalizada1.replace(/[^0-9]/g, '');
      const numeros2 = normalizada2.replace(/[^0-9]/g, '');
      
      // Si ambas tienen números
      if (numeros1.length > 0 && numeros2.length > 0) {
        // 4. Comparar primeros dígitos (entre 3-4 dígitos iniciales)
        const primerDigitos1 = numeros1.substring(0, Math.min(4, numeros1.length));
        const primerDigitos2 = numeros2.substring(0, Math.min(4, numeros2.length));
        
        // 5. Comparar últimos dígitos (6-8 dígitos finales)
        const ultimosDigitos1 = numeros1.length > 6 ? numeros1.slice(-8) : numeros1;
        const ultimosDigitos2 = numeros2.length > 6 ? numeros2.slice(-8) : numeros2;
        
        // Si coinciden los primeros o últimos dígitos significativos
        if ((primerDigitos1 === primerDigitos2 && primerDigitos1.length >= 3) || 
            (ultimosDigitos1 === ultimosDigitos2 && ultimosDigitos1.length >= 4)) {
          return 'parcial';
        }
        
        // 6. Calcular distancia de Levenshtein para detectar errores de tipografía
        // Solo si las longitudes son similares (diferencia máxima de 2 caracteres)
        if (Math.abs(numeros1.length - numeros2.length) <= 2) {
          const distancia = levenshteinDistance(numeros1, numeros2);
          // Si la distancia es pequeña en relación al tamaño de la cédula (máximo 2 caracteres diferentes)
          if (distancia <= 2) {
            return 'parcial';
          }
        }
        
        // 7. Verificar si al menos la mitad de los caracteres coinciden (para cédulas de longitud similar)
        if (Math.abs(normalizada1.length - normalizada2.length) <= 3) {
          let coincidencias = 0;
          const minLength = Math.min(normalizada1.length, normalizada2.length);
          
          // Contar caracteres coincidentes en las mismas posiciones
          for (let i = 0; i < minLength; i++) {
            if (normalizada1[i] === normalizada2[i]) {
              coincidencias++;
            }
          }
          
          // Si coinciden más del 70% de los caracteres
          if (coincidencias >= 0.7 * minLength) {
            return 'parcial';
          }
        }
      }
      
      // 8. Comparar letras (importante para extranjeros)
      const letras1 = normalizada1.replace(/[^A-Z]/g, '');
      const letras2 = normalizada2.replace(/[^A-Z]/g, '');
      
      // Si ambas tienen la misma letra de extranjero y algunos dígitos coinciden
      if (letras1 && letras2 && letras1 === letras2) {
        // Verificar si al menos algunos dígitos coinciden
        if (numeros1 && numeros2 && 
            (numeros1.includes(numeros2.slice(-4)) || numeros2.includes(numeros1.slice(-4)))) {
          return 'parcial';
        }
      }
      
      return 'ninguna';
    }
    
    // Función para calcular distancia de Levenshtein (para comparación fuzzy)
    function levenshteinDistance(a, b) {
      if (a.length === 0) return b.length;
      if (b.length === 0) return a.length;
      
      const matrix = [];
      
      // Inicializar matriz
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      
      // Rellenar matriz
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          const costo = a[j - 1] === b[i - 1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i - 1][j] + 1,      // eliminación
            matrix[i][j - 1] + 1,      // inserción
            matrix[i - 1][j - 1] + costo  // sustitución
          );
        }
      }
      
      return matrix[b.length][a.length];
    }
    
    // Verificar el tipo de coincidencia entre cédulas
    const coincidencia = compararCedulas(cedula, clienteCedula);
    
    // Solo permitir seleccionar si hay coincidencia exacta o parcial
    if (coincidencia === 'ninguna') {
      Swal.fire({
        title: 'No se puede asociar',
        html: `<p>La cédula de esta entrevista <strong>(${cedula})</strong> no coincide con la cédula del cliente de la solicitud <strong>(${clienteCedula})</strong>.</p>
              <p class="mt-2">Por motivos de seguridad, solo puede asociar entrevistas con coincidencia exacta o parcial de cédula.</p>`,
        icon: 'error',
        confirmButtonText: 'Entendido'
      });
      return;
    }
    
    
    entrevistaSeleccionadaId = id;
    
    // Animar el scroll hacia la sección de entrevista seleccionada
    const entrevistaSeleccionadaEl = document.getElementById('entrevistaSeleccionada');
    
    // Mostrar entrevista seleccionada con animación
    document.getElementById('nombreEntrevistaSeleccionada').textContent = nombre;
    document.getElementById('cedulaEntrevistaSeleccionada').textContent = cedula;
    
    // Aplicar animación
    entrevistaSeleccionadaEl.style.opacity = '0';
    entrevistaSeleccionadaEl.style.transform = 'translateY(20px)';
    entrevistaSeleccionadaEl.style.display = 'block';
    
    // Efecto de aparición
    setTimeout(() => {
      entrevistaSeleccionadaEl.style.opacity = '1';
      entrevistaSeleccionadaEl.style.transform = 'translateY(0)';
    }, 10);
    
    // Scroll suave hasta la sección
    setTimeout(() => {
      entrevistaSeleccionadaEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 300);
    
    // Habilitar botón de confirmación
    document.getElementById('btnConfirmarAsociacion').disabled = false;
    
    // Resaltar selección con animación
    document.querySelectorAll('.p-4[onclick]').forEach(item => {
      item.classList.remove('ring-2', 'ring-green-500', 'bg-green-100');
    });
    
    const selectedItem = event.target.closest('.p-4');
    if (selectedItem) {
      selectedItem.classList.add('ring-2', 'ring-green-500', 'bg-green-100');
    }
  }

  function mostrarMensajeCoincidencia(cedulaEntrevista, cedulaSolicitud) {
    // Muestra un mensaje de error cuando intentan seleccionar una entrevista sin coincidencia
    Swal.fire({
      title: 'No se puede asociar',
      html: `<p>La cédula de esta entrevista <strong>(${cedulaEntrevista})</strong> no coincide con la cédula del cliente de la solicitud <strong>(${cedulaSolicitud})</strong>.</p>
             <p class="mt-2">Por motivos de seguridad, solo puede asociar entrevistas con coincidencia exacta o parcial de cédula.</p>`,
      icon: 'error',
      confirmButtonText: 'Entendido'
    });
  }

  function confirmarAsociacion() {
    console.log('🔍 DEBUG - Iniciando confirmarAsociacion');
    console.log('  - entrevistaSeleccionadaId:', entrevistaSeleccionadaId);
    
    if (!entrevistaSeleccionadaId) {
      console.log('❌ No hay entrevista seleccionada');
      return;
    }
    
    const solicitudId = {{ solicitud.id }};
    console.log('  - solicitudId:', solicitudId);
    
    // Mostrar loading en el botón
    const btn = document.getElementById('btnConfirmarAsociacion');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Asociando...';
    btn.disabled = true;
    
    // Obtener token CSRF
    const csrfToken = getCsrfToken();
    console.log('  - CSRF Token:', csrfToken ? 'Presente' : 'AUSENTE');
    
    const requestData = {
      solicitud_id: solicitudId,
      entrevista_id: entrevistaSeleccionadaId,
      accion: 'asociar'
    };
    console.log('  - Datos a enviar:', requestData);
    
    // Realizar asociación AJAX
    console.log('🚀 Enviando fetch request...');
    fetch('/workflow/asociar-entrevista/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('modalAsociarEntrevista')).hide();
        
        // Mostrar mensaje de éxito
        mostrarMensaje('Entrevista asociada correctamente', 'success');
        
        // Recargar la página para mostrar la entrevista asociada
        setTimeout(() => {
          location.reload();
        }, 1500);
        
      } else {
        // Manejo específico para entrevistas ya asociadas a esta solicitud
        if (data.ya_asociada) {
          mostrarMensaje('Esta entrevista ya está asociada a esta solicitud', 'warning');
        } else {
          mostrarMensaje(data.error || 'Error al asociar entrevista', 'error');
        }
      }
    })
    .catch(error => {
      console.error('❌ Fetch error completo:', error);
      console.error('❌ Error name:', error.name);
      console.error('❌ Error message:', error.message);
      console.error('❌ Error stack:', error.stack);
      mostrarMensaje(`Error al asociar entrevista: ${error.message}`, 'error');
    })
    .finally(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  }

  function desasociarEntrevista() {
    const solicitudId = {{ solicitud.id }};
    
    if (!confirm('¿Está seguro de que desea desasociar la entrevista de esta solicitud?')) {
      return;
    }
    
    fetch('/workflow/asociar-entrevista/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({
        solicitud_id: solicitudId,
        accion: 'desasociar'
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        mostrarMensaje('Entrevista desasociada correctamente', 'success');
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        mostrarMensaje(data.error || 'Error al desasociar entrevista', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      mostrarMensaje('Error al desasociar entrevista', 'error');
    });
  }

  // ✅ Función de reasociación removida - Ya no es necesaria porque se permiten múltiples asociaciones

  function verDetallesEntrevista(entrevistaId) {
    // Abrir modal o página con detalles de la entrevista
    window.open(`/workflow/entrevista/${entrevistaId}/`, '_blank');
  }

  // Función para devolver solicitud a bandeja grupal
  async function devolverABandejaGrupal() {
    const solicitudId = {{ solicitud.id }};
    
    console.log('Devolviendo solicitud a bandeja grupal:', solicitudId);
    
    // Confirmar acción con el usuario
    if (!confirm('¿Estás seguro de que deseas devolver esta solicitud a la bandeja grupal?\n\nOtros usuarios podrán tomarla y continuar con el proceso.')) {
      return;
    }
    
    try {
      // Deshabilitar botón mientras se procesa
      const btn = document.getElementById('btn-devolver-bandeja');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Devolviendo...';
      
      const response = await fetch(`/workflow/api/devolver-bandeja-grupal/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          solicitud_id: solicitudId
        })
      });
      
      console.log('Respuesta devolver bandeja:', response.status);
      const data = await response.json();
      console.log('Data devolver bandeja:', data);
      
      if (data.success) {
        mostrarMensaje('Solicitud devuelta a bandeja grupal exitosamente', 'success');
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAvanzarEtapa'));
        if (modal) {
          modal.hide();
        }
        
        // Mostrar mensaje informativo
        mostrarMensaje('Redirigiendo a la bandeja grupal...', 'info');
        
        // Redirigir a la bandeja grupal después de un breve delay
        setTimeout(() => {
          // Redirigir a la vista de bandeja grupal o dashboard
          window.location.href = data.redirect_url || '/workflow/bandeja-grupal/';
        }, 2000);
        
      } else {
        mostrarMensaje(data.message || 'Error al devolver solicitud a bandeja grupal', 'error');
        
        // Rehabilitar botón
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
      
    } catch (error) {
      console.error('Error devolviendo a bandeja grupal:', error);
      mostrarMensaje('Error de conexión al devolver solicitud', 'error');
      
      // Rehabilitar botón en caso de error
      const btn = document.getElementById('btn-devolver-bandeja');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-share me-1"></i>Devolver a Bandeja Grupal';
    }
  }

  // =======================================================
  // FUNCIONALIDAD PARA ENVIAR ENTREVISTA A APPX
  // =======================================================

  // Función para enviar entrevista a APPX
  function enviarAAAPX(entrevistaId, nombreCliente) {
    // Confirmar antes de enviar
    if (confirm(`¿Está seguro que desea enviar la entrevista de ${nombreCliente} al sistema APPX Core?\n\nEsta acción enviará todos los datos de la entrevista al sistema central.`)) {
      
      // Deshabilitar el botón mientras se procesa
      const boton = event.target.closest('button');
      const textoOriginal = boton.innerHTML;
      boton.disabled = true;
      boton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
      
      // Obtener el token CSRF
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                       document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                       getCookie('csrftoken');
      
      // Hacer la petición AJAX
      fetch(`/workflow/api/entrevistas/${entrevistaId}/enviar-appx/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Éxito
          alert(`✅ ÉXITO: ${data.message}\n\nTimestamp: ${data.timestamp}`);
          
          // Opcional: Marcar visualmente la entrevista como enviada
          boton.innerHTML = '<i class="fa-solid fa-check"></i> ENVIADO';
          boton.classList.remove('btn-outline-warning');
          boton.classList.add('btn-success');
          boton.disabled = true;
          
        } else {
          // Error
          alert(`❌ ERROR: ${data.message}\n\nDetalles: ${data.error_details || 'No disponible'}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert(`❌ ERROR DE CONEXIÓN: No se pudo enviar la entrevista.\n\nError técnico: ${error.message}`);
      })
      .finally(() => {
        // Solo restaurar el botón si no fue exitoso
        if (!boton.classList.contains('btn-success')) {
          boton.disabled = false;
          boton.innerHTML = textoOriginal;
        }
      });
    }
  }

  // Función auxiliar para obtener el CSRF token de las cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

// Función para validar documentos consultando la base de datos
function validarDocumentosYAvanzar() {
  console.log('🔍 Validando documentos contra la base de datos...');
  
  const solicitudId = {{ solicitud.id }};
  
  // Mostrar indicador de carga
  const btnAvanzar = document.getElementById('btn-avanzar-subestado');
  const textoOriginal = btnAvanzar.innerHTML;
  btnAvanzar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Validando...';
  btnAvanzar.disabled = true;
  
  fetch(`/workflow/api/solicitudes/${solicitudId}/validar-documentos/`, {
    method: 'GET',
    headers: {
      'X-CSRFToken': getCsrfToken(),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    console.log('📊 Respuesta de validación:', data);
    
    // Restaurar botón
    btnAvanzar.innerHTML = textoOriginal;
    btnAvanzar.disabled = false;
    
    if (data.success) {
      if (data.puede_avanzar) {
        console.log('✅ Validación exitosa - Abriendo modal');
        cargarInformacionAvance();
        const modal = new bootstrap.Modal(document.getElementById('modalAvanzarSubestado'));
        modal.show();
      } else {
        console.log('❌ Validación fallida:', data.documentos_problematicos);
        
        // Verificar si hay transiciones negativas disponibles
        if (transicionesNegativas.length > 0) {
          // Si hay documentos obligatorios malos Y hay transiciones negativas, ofrecer devolución
          const tieneObligatoriosMalos = data.documentos_problematicos && 
            data.documentos_problematicos.some(doc => doc.problema === 'mal_calificado' && doc.estado_actual === 'malo');
          
          if (tieneObligatoriosMalos) {
            console.log('📋 Documentos obligatorios malos detectados - ofreciendo devolución');
            
            // Mostrar mensaje con opción de devolución
            const mensaje = `${data.mensaje}\n\n${data.detalle ? data.detalle.join('\n') : ''}\n\n¿Deseas devolver la solicitud al oficial para corrección?`;
            
            if (confirm(mensaje)) {
              mostrarModalDevolucion();
              return; // No continuar con el resto de la lógica
            }
          }
        }
        
        // Mostrar mensaje detallado normal
        let mensajeCompleto = data.mensaje + '\n\n';
        if (data.detalle && data.detalle.length > 0) {
          mensajeCompleto += data.detalle.join('\n');
        }
        
        alert(mensajeCompleto);
        
        // Resaltar documentos problemáticos en la interfaz
        if (data.documentos_problematicos) {
          data.documentos_problematicos.forEach(doc => {
            const cards = document.querySelectorAll('.archivo-card-mejorada-backoffice');
            cards.forEach(card => {
              const nombre = card.querySelector('.archivo-nombre-backoffice')?.textContent?.trim();
              if (nombre && nombre.includes(doc.nombre)) {
                card.style.border = '2px solid #dc3545';
                card.style.backgroundColor = '#fff5f5';
                setTimeout(() => {
                  card.style.border = '';
                  card.style.backgroundColor = '';
                }, 8000);
              }
            });
          });
        }
      }
    } else {
      console.error('❌ Error en validación:', data.error);
      alert(`Error al validar documentos: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('❌ Error de red:', error);
    
    // Restaurar botón
    btnAvanzar.innerHTML = textoOriginal;
    btnAvanzar.disabled = false;
    
    alert('Error de conexión al validar documentos. Verifica tu conexión e intenta de nuevo.');
  });
}

// ========================================
// FUNCIONES PARA DEVOLUCIÓN A OFICIAL
// ========================================

// Variable global para almacenar transiciones negativas
let transicionesNegativas = [];

// Función para cargar transiciones negativas al cargar la página
function cargarTransicionesNegativas() {
  const solicitudId = {{ solicitud.id }};
  
  fetch(`/workflow/api/solicitudes/${solicitudId}/transiciones-negativas/`)
    .then(response => response.json())
    .then(data => {
      console.log('🔄 Transiciones negativas:', data);
      
      if (data.success && data.tiene_transiciones_negativas) {
        transicionesNegativas = data.transiciones_negativas;
        
        // Mostrar botón de devolver
        const btnDevolver = document.getElementById('btn-devolver-oficial');
        if (btnDevolver) {
          btnDevolver.style.display = 'inline-block';
          
          // Actualizar texto del botón si hay múltiples transiciones
          if (transicionesNegativas.length === 1) {
            btnDevolver.querySelector('span').textContent = transicionesNegativas[0].nombre;
          }
        }
      }
    })
    .catch(error => {
      console.error('❌ Error cargando transiciones negativas:', error);
    });
}

// Función para mostrar modal de devolución
function mostrarModalDevolucion() {
  console.log('📋 Mostrando modal de devolución...');
  
  if (transicionesNegativas.length === 0) {
    alert('No hay transiciones negativas disponibles.');
    return;
  }
  
  // Cargar información de la transición
  const transicion = transicionesNegativas[0]; // Por ahora tomamos la primera
  document.getElementById('devolver-etapa-destino').textContent = transicion.etapa_destino.nombre;
  
  // Cargar documentos problemáticos
  cargarDocumentosProblematicos();
  
  // Mostrar modal
  const modal = new bootstrap.Modal(document.getElementById('modalDevolverOficial'));
  modal.show();
}

// ✅ MEJORADO: Función para cargar documentos problemáticos (MALOS + PENDIENTES) 
function cargarDocumentosProblematicos() {
  const solicitudId = {{ solicitud.id }};
  
  console.log(`🔍 Cargando documentos problemáticos para solicitud ${solicitudId}`);
  
  // Obtener tanto pendientes como malos
  Promise.all([
    fetch(`/workflow/api/solicitudes/${solicitudId}/validar-documentos/`).then(r => r.json()),
    fetch(`/workflow/api/calificaciones/${solicitudId}/estado/malo/`).then(r => r.json()).catch(error => {
      console.error('❌ Error en API de documentos malos:', error);
      return {success: false, error: error.message};
    })
  ])
  .then(([dataPendientes, dataMalos]) => {
    console.log('📊 Datos pendientes:', dataPendientes);
    console.log('📊 Datos malos:', dataMalos);
    
    const listaContainer = document.getElementById('lista-documentos-problematicos');
    let html = '';
    let totalProblematicos = 0;
    
    // 1. ✅ PROCESAR DOCUMENTOS MALOS (rechazados) - CONSULTA DIRECTA BD
    console.log('🔍 Verificando documentos MALOS...');
    console.log('📊 Respuesta API malos:', dataMalos);
    
    if (dataMalos && dataMalos.success === true && dataMalos.calificaciones) {
      console.log(`✅ API exitosa - ${dataMalos.calificaciones.length} calificaciones encontradas`);
      
      dataMalos.calificaciones.forEach(calificacion => {
        console.log('📋 Calificación:', {
          id: calificacion.id,
          estado: calificacion.estado,
          nombre: calificacion.requisito_solicitud?.requisito?.nombre
        });
        
        // Solo procesar si el estado es exactamente 'malo'
        if (calificacion.estado === 'malo') {
          const nombreDoc = calificacion.requisito_solicitud?.requisito?.nombre || 'Documento sin nombre';
          
          html += `
            <div class="d-flex align-items-center mb-2 p-2" style="background: #fee2e2; border-radius: 6px; border-left: 4px solid #dc2626;">
              <i class="fas fa-times-circle text-danger me-2"></i>
              <span class="fw-medium">${nombreDoc}</span>
              <span class="badge bg-danger ms-auto">Rechazado</span>
            </div>
          `;
          totalProblematicos++;
          console.log(`➕ AGREGADO documento malo: ${nombreDoc}`);
        } else {
          console.log(`⏭️ Saltado - estado: ${calificacion.estado}`);
        }
      });
      
      console.log(`📊 Total documentos malos procesados: ${totalProblematicos}`);
    } else {
      console.log('⚠️ No hay documentos malos:');
      console.log('   - Success:', dataMalos?.success);
      console.log('   - Calificaciones:', dataMalos?.calificaciones?.length);
      console.log('   - Message:', dataMalos?.message);
      if (dataMalos?.error) {
        console.log('❌ Error API:', dataMalos.error);
      }
    }
    
    // 2. Agregar documentos PENDIENTES
    console.log('🔍 Verificando documentos PENDIENTES...');
    if (dataPendientes.success && dataPendientes.documentos_pendientes && dataPendientes.documentos_pendientes.length > 0) {
      console.log(`✅ Encontrados ${dataPendientes.documentos_pendientes.length} documentos pendientes`);
      dataPendientes.documentos_pendientes.forEach(doc => {
        html += `
          <div class="d-flex align-items-center mb-2 p-2" style="background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            <span class="fw-medium">${doc.nombre}</span>
            <span class="badge bg-warning ms-auto">Pendiente</span>
          </div>
        `;
        totalProblematicos++;
        console.log(`➕ Agregado documento pendiente: ${doc.nombre}`);
      });
    } else {
      console.log('⚠️ No hay documentos pendientes o respuesta inválida');
    }
    
    // 3. Mostrar resultado
    console.log(`📊 Total documentos problemáticos: ${totalProblematicos}`);
    if (totalProblematicos > 0) {
      listaContainer.innerHTML = html;
      console.log(`✅ Mostrando ${totalProblematicos} documentos problemáticos`);
    } else {
      listaContainer.innerHTML = `
        <div class="text-center text-muted">
          <i class="fas fa-check-circle text-success me-2"></i>
          No hay documentos problemáticos detectados
        </div>
      `;
      console.log('ℹ️ No hay documentos problemáticos para mostrar');
    }
  })
  .catch(error => {
    console.error('❌ Error cargando documentos problemáticos:', error);
    document.getElementById('lista-documentos-problematicos').innerHTML = `
      <div class="text-center text-danger">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Error al cargar documentos
      </div>
    `;
  });
}



// ✅ MEJORADO: Función para confirmar devolución con correo automático
function confirmarDevolucion() {
  const motivo = document.getElementById('motivo-devolucion').value.trim();
  
  if (!motivo) {
    alert('Por favor, ingresa el motivo de la devolución.');
    document.getElementById('motivo-devolucion').focus();
    return;
  }
  
  if (transicionesNegativas.length === 0) {
    alert('No hay transiciones negativas disponibles.');
    return;
  }
  
  const transicion = transicionesNegativas[0];
  const btnConfirmar = document.getElementById('btn-confirmar-devolucion');
  const textoOriginal = btnConfirmar.innerHTML;
  
  // Mostrar loading
  btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando correo...';
  btnConfirmar.disabled = true;
  
  console.log(`🚨 Devolviendo solicitud {{ solicitud.id }} a ${transicion.etapa_destino.nombre} con motivo: ${motivo}`);
  
  // 🚨 USAR NUEVA API DE DEVOLUCIÓN CON CORREO
  fetch('/workflow/api/solicitudes/devolver-backoffice/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken()
    },
    body: JSON.stringify({
      solicitud_id: {{ solicitud.id }},
      transicion_id: transicion.id,
      motivo: motivo
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // ✅ Mostrar mensaje de éxito con información del correo
      const mensaje = `
        ✅ Solicitud devuelta exitosamente a ${data.data.nueva_etapa}
        
        📧 Se ha enviado un correo automático al propietario con:
        • Lista de documentos problemáticos (${data.data.documentos_problematicos})
        • Motivo de devolución
        • Instrucciones para corrección
        
        Copias enviadas a: arodriguez@fpacifico.com y jacastillo@fpacifico.com
      `;
      
      alert(mensaje);
      
      // Cerrar modal y redirigir
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalDevolverOficial'));
      modal.hide();
      
      // Redirigir según la URL proporcionada por la API
      window.location.href = data.redirect_url || '/workflow/bandeja-mixta/';
      
    } else {
      alert(`❌ Error al devolver solicitud: ${data.message || data.error}`);
      
      // Restaurar botón
      btnConfirmar.innerHTML = textoOriginal;
      btnConfirmar.disabled = false;
    }
  })
  .catch(error => {
    console.error('❌ Error en devolución:', error);
    alert('❌ Error de conexión al devolver solicitud. Inténtalo de nuevo.');
    
    // Restaurar botón
    btnConfirmar.innerHTML = textoOriginal;
    btnConfirmar.disabled = false;
  });
}

// ========================================
// FUNCIONES AUXILIARES
// ========================================

// Función para obtener el token CSRF
function getCsrfToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

// ========================================
// FUNCIONES DEL MODAL DE AVANCE
// ========================================

// Función para cargar información del modal cuando se abre
function cargarInformacionAvance() {
  console.log('🔄 Cargando información de avance...');
  
  const solicitudId = {{ solicitud.id }};
  
  // Mostrar loading
  document.getElementById('avance-loading').style.display = 'block';
  document.getElementById('avance-error').style.display = 'none';
  document.getElementById('estado-documentos').style.display = 'none';
  
  // Cargar siguiente subestado Y validar documentos en paralelo
  Promise.all([
    fetch(`/workflow/api/solicitudes/${solicitudId}/siguiente-subestado/`),
    fetch(`/workflow/api/solicitudes/${solicitudId}/validar-documentos/`)
  ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([subestadoData, validacionData]) => {
      console.log('📊 Información de subestado:', subestadoData);
      console.log('📊 Validación de documentos:', validacionData);
      
      // Actualizar información del siguiente paso
      if (subestadoData.success) {
        window.siguientePaso = subestadoData;
        
        if (subestadoData.siguiente_subestado) {
          document.getElementById('avanzar-siguiente-subestado').textContent = subestadoData.siguiente_subestado.nombre;
        } else if (subestadoData.siguiente_etapa) {
          document.getElementById('avanzar-siguiente-subestado').textContent = subestadoData.siguiente_etapa.nombre;
        } else {
          document.getElementById('avanzar-siguiente-subestado').textContent = 'Fin del proceso';
        }
      } else {
        document.getElementById('avanzar-siguiente-subestado').textContent = 'Error al cargar';
      }
      
      // Mostrar estado de documentos
      if (validacionData.success) {
        mostrarEstadoDocumentos(validacionData);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      document.getElementById('avanzar-siguiente-subestado').textContent = 'Error de conexión';
    })
    .finally(() => {
      document.getElementById('avance-loading').style.display = 'none';
    });
  
  // Cargar usuarios disponibles
  cargarUsuariosDisponiblesAvance();
}

// Función para mostrar el estado de documentos en el modal
function mostrarEstadoDocumentos(data) {
  console.log('📋 Mostrando estado de documentos:', data);
  
  // Mostrar la sección de estado de documentos
  document.getElementById('estado-documentos').style.display = 'block';
  
  // Actualizar contadores
  document.getElementById('documentos-total-count').textContent = data.total_documentos || 0;
  document.getElementById('documentos-buenos-count').textContent = data.documentos_buenos || 0;
  document.getElementById('documentos-malos-count').textContent = data.documentos_malos || 0;
  document.getElementById('documentos-pendientes-count').textContent = data.documentos_pendientes_count || data.documentos_pendientes?.length || 0;
  
  // Mostrar lista de documentos pendientes si existen
  const listaPendientes = document.getElementById('lista-documentos-pendientes');
  const sinPendientes = document.getElementById('sin-documentos-pendientes');
  const listaPendientesContainer = document.getElementById('documentos-pendientes-lista');
  
  if (data.documentos_pendientes && data.documentos_pendientes.length > 0) {
    // Hay documentos pendientes - mostrar lista
    listaPendientes.style.display = 'block';
    sinPendientes.style.display = 'none';
    
    // Limpiar lista anterior
    listaPendientesContainer.innerHTML = '';
    
    // Agregar cada documento pendiente
    data.documentos_pendientes.forEach((doc, index) => {
      const docElement = document.createElement('div');
      docElement.className = 'mb-2';
      docElement.innerHTML = `
        <div class="d-flex align-items-center p-2" style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px;">
          <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; background: #f59e0b; color: white; flex-shrink: 0;">
            <i class="fas fa-clock" style="font-size: 12px;"></i>
          </div>
          <div class="flex-grow-1">
            <div class="fw-bold" style="color: #92400e; font-size: 0.9rem;">${doc.nombre}</div>
            <small style="color: #b45309;">Documento opcional sin archivo - marcado como pendiente</small>
          </div>
          <div class="badge" style="background: #f59e0b; color: white; font-size: 0.75rem;">
            Pendiente
          </div>
        </div>
      `;
      listaPendientesContainer.appendChild(docElement);
    });
    
  } else {
    // No hay documentos pendientes
    listaPendientes.style.display = 'none';
    sinPendientes.style.display = 'block';
  }
}

// Función para cargar usuarios disponibles
function cargarUsuariosDisponiblesAvance() {
  console.log('👥 Cargando usuarios disponibles...');
  
  fetch('/workflow/api/usuarios/')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        mostrarUsuariosEnTabla(data.usuarios);
      } else {
        mostrarErrorAvance('Error al cargar usuarios: ' + (data.message || 'Error desconocido'));
      }
    })
    .catch(error => {
      console.error('Error cargando usuarios:', error);
      mostrarErrorAvance('Error de conexión al cargar usuarios');
    });
}

// Función para mostrar usuarios en la tabla
function mostrarUsuariosEnTabla(usuarios) {
  console.log('📋 Mostrando usuarios en tabla:', usuarios.length);
  
  const tbody = document.getElementById('lista-usuarios-avance');
  const contador = document.getElementById('contador-usuarios-avance');
  
  if (!usuarios || usuarios.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay usuarios disponibles</td></tr>';
    contador.textContent = '0';
    return;
  }
  
  let html = '';
  usuarios.forEach((usuario, index) => {
    const avatarUrl = usuario.profile_picture || '/static/images/profile.png';
    const grupos = 'Sin información de grupos';
    const roleBadge = '';
    const adminBadge = '';
    
    html += `
      <tr id="usuario-row-${usuario.id}" style="cursor: pointer;" onclick="seleccionarUsuarioAvance(${usuario.id}, '${usuario.full_name}')">
        <td>${index + 1}</td>
        <td>
          <img src="${avatarUrl}" alt="Avatar" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
        </td>
        <td>
          <div>
            <strong>${usuario.full_name}</strong>
            <div class="small text-muted">@${usuario.username}</div>
          </div>
        </td>
        <td>
          <div class="small">${usuario.email}</div>
        </td>
        <td>
          <div class="small">${grupos}</div>
          <div>${roleBadge} ${adminBadge}</div>
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); seleccionarUsuarioAvance(${usuario.id}, '${usuario.full_name}')">
            <i class="fas fa-check"></i> Seleccionar
          </button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  contador.textContent = usuarios.length;
}

// Función para seleccionar opción (yo, otro, o bandeja)
function seleccionarOpcionAvance(opcion) {
  console.log('🎯 Opción seleccionada:', opcion);
  
  // Resetear todos los botones
  document.getElementById('btn-continuar-yo').classList.remove('btn-primary');
  document.getElementById('btn-continuar-yo').classList.add('btn-outline-primary');
  document.getElementById('btn-asignar-otro').classList.remove('btn-success');
  document.getElementById('btn-asignar-otro').classList.add('btn-outline-success');
  document.getElementById('btn-bandeja-grupal').classList.remove('btn-warning');
  document.getElementById('btn-bandeja-grupal').classList.add('btn-outline-warning');
  
  // Activar botón seleccionado y configurar estado
  if (opcion === 'yo') {
    document.getElementById('btn-continuar-yo').classList.remove('btn-outline-primary');
    document.getElementById('btn-continuar-yo').classList.add('btn-primary');
    document.getElementById('seccion-asignar-usuario').style.display = 'none';
    document.getElementById('btn-confirmar-avance').disabled = false;
    window.opcionSeleccionada = 'yo';
    window.usuarioSeleccionadoId = null;
  } else if (opcion === 'otro') {
    document.getElementById('btn-asignar-otro').classList.remove('btn-outline-success');
    document.getElementById('btn-asignar-otro').classList.add('btn-success');
    document.getElementById('seccion-asignar-usuario').style.display = 'block';
    document.getElementById('btn-confirmar-avance').disabled = true;
    window.opcionSeleccionada = 'otro';
    window.usuarioSeleccionadoId = null;
  } else if (opcion === 'bandeja') {
    document.getElementById('btn-bandeja-grupal').classList.remove('btn-outline-warning');
    document.getElementById('btn-bandeja-grupal').classList.add('btn-warning');
    document.getElementById('seccion-asignar-usuario').style.display = 'none';
    document.getElementById('btn-confirmar-avance').disabled = false;
    window.opcionSeleccionada = 'bandeja';
    window.usuarioSeleccionadoId = null;
  }
}

// Función para seleccionar usuario
function seleccionarUsuarioAvance(usuarioId, usuarioNombre) {
  console.log('👤 Usuario seleccionado:', usuarioId, usuarioNombre);
  
  // Remover selección anterior
  document.querySelectorAll('#lista-usuarios-avance tr').forEach(row => {
    row.classList.remove('table-success');
    row.style.backgroundColor = '';
  });
  
  // Marcar fila seleccionada
  const row = document.getElementById(`usuario-row-${usuarioId}`);
  if (row) {
    row.classList.add('table-success');
    row.style.backgroundColor = '#d1edff';
  }
  
  // Habilitar botón de confirmar
  document.getElementById('btn-confirmar-avance').disabled = false;
  
  // Guardar selección
  window.usuarioSeleccionadoId = usuarioId;
  window.usuarioSeleccionadoNombre = usuarioNombre;
}

// Función para confirmar el avance
function confirmarAvance() {
  console.log('✅ Confirmando avance...');
  
  const solicitudId = {{ solicitud.id }};
  const opcion = window.opcionSeleccionada;
  const usuarioId = window.usuarioSeleccionadoId;
  
  if (!opcion) {
    alert('Por favor selecciona una opción (Continuar Yo, Asignar a Otro Usuario, o Devolver a Bandeja Grupal)');
    return;
  }
  
  if (opcion === 'otro' && !usuarioId) {
    alert('Por favor selecciona un usuario');
    return;
  }
  
  // Deshabilitar botón y mostrar loading
  const btn = document.getElementById('btn-confirmar-avance');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Procesando...';
  
  // Preparar datos
  const data = {
    opcion: opcion
  };
  
  if (opcion === 'otro') {
    data.usuario_id = usuarioId;
  } else if (opcion === 'bandeja') {
    // Para bandeja grupal, no asignamos a un usuario específico (usuario_asignado = null)
    data.usuario_id = null;
  }
  
  // Agregar información del siguiente paso
  if (window.siguientePaso) {
    if (window.siguientePaso.siguiente_subestado) {
      data.siguiente_subestado_id = window.siguientePaso.siguiente_subestado.id;
    }
    // Si no hay siguiente subestado, la API manejará la transición a la siguiente etapa
  }
  
  console.log('📤 Enviando datos:', data);
  
  // Enviar solicitud
  fetch(`/workflow/api/solicitudes/${solicitudId}/avanzar-subestado/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken()
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Cerrar modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalAvanzarSubestado'));
      modal.hide();
      
      // Mostrar mensaje de éxito
      alert('✅ ' + (data.mensaje || data.message || 'Avance completado exitosamente'));
      
      // Redirigir según la opción
      if (data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        window.location.reload();
      }
    } else {
      mostrarErrorAvance(data.error || data.message || 'Error al avanzar subestado');
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarErrorAvance('Error de conexión');
    btn.disabled = false;
    btn.innerHTML = originalText;
  });
}

// Función para mostrar errores en el modal
function mostrarErrorAvance(mensaje) {
  console.error('❌ Error en avance:', mensaje);
  
  document.getElementById('avance-error-mensaje').textContent = mensaje;
  document.getElementById('avance-error').style.display = 'block';
  
  setTimeout(() => {
    document.getElementById('avance-error').style.display = 'none';
  }, 5000);
}

// Función para configurar búsqueda de usuarios
function configurarBusquedaUsuarios() {
  const input = document.getElementById('buscar-usuario-avance');
  const btnLimpiar = document.getElementById('limpiar-busqueda-avance');
  
  if (input) {
    input.addEventListener('input', function() {
      filtrarUsuarios(this.value);
    });
  }
  
  if (btnLimpiar) {
    btnLimpiar.addEventListener('click', function() {
      input.value = '';
      filtrarUsuarios('');
    });
  }
}

// Función para filtrar usuarios
function filtrarUsuarios(termino) {
  const filas = document.querySelectorAll('#lista-usuarios-avance tr');
  let contador = 0;
  
  filas.forEach(fila => {
    if (fila.querySelector('td')) { // Evitar header
      const texto = fila.textContent.toLowerCase();
      const visible = texto.includes(termino.toLowerCase());
      fila.style.display = visible ? '' : 'none';
      if (visible) contador++;
    }
  });
  
  document.getElementById('contador-usuarios-avance').textContent = contador;
}

// Event listener para cuando se abre el modal
  // ✅ NUEVA FUNCIÓN: Verificar y habilitar botón Avanzar automáticamente
  function verificarYHabilitarBotonAvanzar() {
    console.log('🔍 Verificando si se puede habilitar el botón Avanzar...');
    
    const btnAvanzar = document.getElementById('btn-avanzar-subestado');
    if (!btnAvanzar) {
      console.log('❌ Botón Avanzar no encontrado');
      return;
    }
    
    // Buscar todos los documentos que tienen botones de calificación (bueno/malo/pendiente)
    const documentosConBotones = document.querySelectorAll('.calificar-btn-backoffice[data-estado="bueno"], .calificar-btn-backoffice[data-estado="malo"], .calificar-btn-backoffice[data-estado="pendiente"]');
    
    if (documentosConBotones.length === 0) {
      console.log('ℹ️ No hay documentos para calificar');
      btnAvanzar.disabled = false; // Habilitar si no hay documentos que calificar
      btnAvanzar.title = 'Listo para avanzar';
      return;
    }
    
    // Agrupar botones por requisito ID
    const documentosPorRequisito = {};
    documentosConBotones.forEach(btn => {
      const requisitoId = btn.getAttribute('data-requisito');
      if (requisitoId) {
        if (!documentosPorRequisito[requisitoId]) {
          documentosPorRequisito[requisitoId] = [];
        }
        documentosPorRequisito[requisitoId].push(btn);
      }
    });
    
    const requisitosIds = Object.keys(documentosPorRequisito);
    console.log(`📋 Encontrados ${requisitosIds.length} documentos para verificar`);
    
    let todosCalificados = true;
    let contadorCalificados = 0;
    let documentosPendientes = 0;
    
    // Verificar cada requisito
    requisitosIds.forEach(requisitoId => {
      const botones = documentosPorRequisito[requisitoId];
      const tieneActivo = botones.some(btn => btn.classList.contains('activo'));
      const esPendiente = botones.some(btn => btn.classList.contains('activo') && btn.getAttribute('data-estado') === 'pendiente');
      
      if (tieneActivo) {
        contadorCalificados++;
        if (esPendiente) {
          documentosPendientes++;
          console.log(`✅ Documento opcional ${requisitoId}: Marcado como Pendiente (No bloquea)`);
        } else {
          console.log(`✅ Documento ${requisitoId}: Calificado`);
        }
      } else {
        todosCalificados = false;
        console.log(`⏳ Documento ${requisitoId}: Sin calificar`);
      }
    });
    
    console.log(`📊 Progreso: ${contadorCalificados}/${requisitosIds.length} documentos calificados (${documentosPendientes} opcionales pendientes)`);
    
    // Habilitar/deshabilitar botón basado en el resultado
    if (todosCalificados) {
      btnAvanzar.disabled = false;
      btnAvanzar.title = 'Todos los documentos calificados - Listo para avanzar';
      btnAvanzar.classList.add('btn-pulsating'); // Clase visual opcional
      console.log('✅ Botón Avanzar HABILITADO - Todos los documentos calificados');
      
      // Mostrar mensaje de confirmación
      const documentosReales = contadorCalificados - documentosPendientes;
      let mensaje = `¡Perfecto! Todos los documentos han sido calificados. Ya puedes avanzar.`;
      if (documentosPendientes > 0) {
        mensaje = `¡Perfecto! Todos los documentos obligatorios han sido calificados (${documentosReales} calificados, ${documentosPendientes} opcionales pendientes). Ya puedes avanzar.`;
      }
      mostrarMensaje(mensaje, 'success');
      
    } else {
      btnAvanzar.disabled = true;
      btnAvanzar.title = `Faltan ${requisitosIds.length - contadorCalificados} documentos por calificar`;
      btnAvanzar.classList.remove('btn-pulsating');
      console.log(`⏳ Botón Avanzar DESHABILITADO - Faltan ${requisitosIds.length - contadorCalificados} documentos por calificar`);
    }
  }

  // ✅ SOLUCIÓN PARA PROBLEMA DE ARCHIVOS: Detectar subidas exitosas y actualizar
function detectarCambiosEnArchivos() {
  // Interceptar llamadas fetch exitosas relacionadas con archivos
  const originalFetch = window.fetch;
  window.fetch = function(...args) {
    return originalFetch.apply(this, args)
      .then(response => {
        const url = args[0];
        // Detectar si es una subida de archivo exitosa
        if (url && (url.includes('upload-documento') || url.includes('subir-requisito')) && response.ok) {
          response.clone().json().then(data => {
            if (data.success) {
              console.log('🎯 Subida de archivo detectada exitosamente - forzando actualización');
              // Usar mensaje específico y delay corto
              mostrarMensaje('Archivo subido - Actualizando vista...', 'success');
              
              // ✅ SOLO VERIFICAR CON EL BACKEND
              setTimeout(() => {
                verificarEstadoInicialBotonAvanzar(); // Solo usar el backend
              }, 300);
              
              setTimeout(() => {
                window.location.reload();
              }, 600);
            }
          }).catch(() => {
            // Si no es JSON, asumir que es exitoso si response.ok
            console.log('🎯 Operación de archivo exitosa detectada');
            setTimeout(() => {
              window.location.reload();
            }, 600);
          });
        }
        return response;
      });
  };
}

// ✅ FUNCIÓN CORREGIDA: Usar SOLO la respuesta del backend, no lógica local
function verificarEstadoInicialBotonAvanzar() {
  console.log('🔍 Verificando estado con el BACKEND (fuente de verdad)...');
  
  const solicitudId = {{ solicitud.id }};
  const btnAvanzar = document.getElementById('btn-avanzar-subestado');
  
  if (!btnAvanzar) {
    console.log('❌ Botón Avanzar no encontrado');
    return;
  }
  
  // ✅ SOLO CONSULTAR EL BACKEND - No usar lógica JavaScript local
  fetch(`/workflow/api/solicitudes/${solicitudId}/validar-documentos/`, {
    method: 'GET',
    headers: {
      'X-CSRFToken': getCsrfToken(),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    console.log('🎯 Respuesta DEFINITIVA del backend:', data);
    
    if (data.success) {
      if (data.puede_avanzar) {
        // ✅ BACKEND DICE QUE PUEDE AVANZAR
        btnAvanzar.disabled = false;
        btnAvanzar.title = '✅ Listo para avanzar según validación del servidor';
        btnAvanzar.classList.add('btn-pulsating');
        btnAvanzar.style.backgroundColor = '#28a745';
        btnAvanzar.style.borderColor = '#28a745';
        btnAvanzar.classList.remove('btn-secondary');
        btnAvanzar.classList.add('btn-success');
        
        console.log('✅ BOTÓN HABILITADO por el backend');
        mostrarMensaje(data.mensaje || 'Puede avanzar', 'success', 4000);
        
      } else {
        // ❌ BACKEND DICE QUE NO PUEDE AVANZAR
        btnAvanzar.disabled = true;
        btnAvanzar.title = data.mensaje || 'No puede avanzar según validación del servidor';
        btnAvanzar.classList.remove('btn-pulsating', 'btn-success');
        btnAvanzar.classList.add('btn-secondary');
        btnAvanzar.style.backgroundColor = '#6c757d';
        btnAvanzar.style.borderColor = '#6c757d';
        
        console.log('❌ BOTÓN DESHABILITADO por el backend:', data.mensaje);
        mostrarMensaje(data.mensaje || 'No puede avanzar', 'warning', 4000);
      }
    } else {
      // Error en la API
      console.error('❌ Error en validación del backend:', data.error);
      btnAvanzar.disabled = true;
      btnAvanzar.title = 'Error al validar con el servidor';
      btnAvanzar.classList.remove('btn-pulsating', 'btn-success');
      btnAvanzar.classList.add('btn-secondary');
    }
  })
  .catch(error => {
    console.error('❌ Error de conexión con el backend:', error);
    btnAvanzar.disabled = true;
    btnAvanzar.title = 'Error de conexión con el servidor';
    btnAvanzar.classList.remove('btn-pulsating', 'btn-success');
    btnAvanzar.classList.add('btn-secondary');
  });
}

document.addEventListener('DOMContentLoaded', function() {
  // Inicializar detector de cambios en archivos
  detectarCambiosEnArchivos();
  
  // ✅ VERIFICACIÓN INMEDIATA DEL BOTÓN AVANZAR
  setTimeout(() => {
    verificarEstadoInicialBotonAvanzar();
  }, 500);
  
  // ❌ FUNCIÓN DE RESPALDO DESACTIVADA - Ahora solo el backend decide
  setTimeout(() => {
    console.log('🔧 Función de respaldo: DESACTIVADA - Solo el backend decide el estado del botón');
    // La función de respaldo ya no interfiere con las decisiones del backend
  }, 2000);
  
  const modal = document.getElementById('modalAvanzarSubestado');
  if (modal) {
    modal.addEventListener('shown.bs.modal', function() {
      cargarInformacionAvance();
      configurarBusquedaUsuarios();
    });
  }
  
  // Cargar transiciones negativas al inicializar la página
  cargarTransicionesNegativas();
});

// ✅ FUNCIÓN DE EMERGENCIA - Consulta el backend para obtener el estado real
window.VERIFICAR_ESTADO_BOTON_BACKEND = function() {
  console.log('🚨 FUNCIÓN DE EMERGENCIA: Consultando estado real del backend...');
  
  // Forzar verificación inmediata con el backend
  verificarEstadoInicialBotonAvanzar();
  
  alert('🔍 Consultando el estado real con el servidor...\nRevisa la consola y el botón en unos segundos.');
  
  return true;
};

</script>

<!-- Modal para Comentarios -->
<div class="modal fade" id="modalComentarios" tabindex="-1" aria-labelledby="modalComentariosLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalComentariosLabel">
          <i class="fas fa-comments me-2"></i>Comentarios del Documento
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body modal-comentarios">
        <!-- Contenedor de comentarios con scroll -->
        <div id="comentarios-container">
          <!-- Los comentarios se cargan dinámicamente aquí -->
        </div>

        <!-- Formulario para nuevo comentario (fijo en la parte inferior) -->
        <div class="form-nuevo-comentario-section">
          <h6 class="mb-3">Agregar Comentario</h6>
          <form id="form-nuevo-comentario">
            {% csrf_token %}
            <div class="mb-3">
              <textarea class="form-control" name="comentario" rows="3" placeholder="Escribe tu comentario aquí..."
                required></textarea>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Agregar Comentario
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Opciones -->
<div class="modal fade" id="modalOpciones" tabindex="-1" aria-labelledby="modalOpcionesLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalOpcionesLabel">
          <i class="fas fa-cog me-2"></i>Opciones de Calificación
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>Documento:</strong> <span id="opciones-documento-nombre"></span>
        </div>
        <div class="mb-3">
          <p class="text-muted"><strong>Debes seleccionar una opción</strong> para calificar este documento como "malo":</p>
        </div>
        <div id="opciones-container">
          <!-- Las opciones se cargan dinámicamente aquí -->
        </div>
        <div class="alert alert-info mt-3">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Nota:</strong> Selecciona una opción de la lista para continuar. El documento se calificará automáticamente como "malo" con la razón seleccionada.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Avanzar Etapa -->
<div class="modal fade" id="modalAvanzarEtapa" tabindex="-1" aria-labelledby="modalAvanzarEtapaLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAvanzarEtapaLabel">
          <i class="fas fa-arrow-right me-2"></i>Avanzar Etapa
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Columna de Subestados -->
          <div class="col-md-4">
            <h6 class="border-bottom pb-2 mb-3">
              <i class="fas fa-list-ol me-2"></i>Avanzar Subestado
            </h6>
            <p class="text-muted small">Avanza al siguiente subestado dentro de la etapa actual:</p>
            
            <div id="subestados-container">
              <!-- Los subestados se cargan dinámicamente aquí -->
            </div>
          </div>
          
          <!-- Columna de Transiciones -->
          <div class="col-md-4">
            <h6 class="border-bottom pb-2 mb-3">
              <i class="fas fa-exchange-alt me-2"></i>Cambiar Etapa
            </h6>
            <p class="text-muted small">Cambia a una etapa diferente según las transiciones configuradas:</p>
            
            <div id="transiciones-container">
              <!-- Las transiciones se cargan dinámicamente aquí -->
            </div>
          </div>
          
          <!-- Columna de Bandeja Grupal -->
          <div class="col-md-4">
            <h6 class="border-bottom pb-2 mb-3">
              <i class="fas fa-users me-2"></i>Bandeja Grupal
            </h6>
            <p class="text-muted small">Devuelve la solicitud a la bandeja grupal para que otros usuarios la puedan tomar:</p>
            
            <div id="bandeja-grupal-container">
              <div class="card border-info">
                <div class="card-body p-3">
                  <div class="text-center">
                    <div class="mb-3">
                      <i class="fas fa-inbox fa-2x text-info mb-2"></i>
                      <h6 class="mb-1">Devolver a Bandeja Grupal</h6>
                      <small class="text-muted">
                        Permite que otros usuarios continúen con el siguiente subestado
                      </small>
                    </div>
                    
                    <div class="mb-3">
                      <div class="badge bg-info mb-2">
                        <i class="fas fa-info-circle me-1"></i>
                        Subestado Actual: <span id="subestado-actual-nombre">{{ solicitud.subestado_actual.nombre|default:"Sin subestado" }}</span>
                      </div>
                      <br>
                      <small class="text-muted d-block">
                        Al devolver a bandeja grupal, la solicitud estará disponible para que cualquier usuario autorizado la tome y continúe con el flujo.
                      </small>
                    </div>
                    
                    <button class="btn btn-info btn-sm w-100" 
                            onclick="devolverABandejaGrupal()"
                            id="btn-devolver-bandeja">
                      <i class="fas fa-share me-1"></i>Devolver a Bandeja Grupal
                    </button>
                    
                    <div class="mt-2">
                      <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        Útil cuando has completado tu parte del proceso y quieres que otro usuario continúe.
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Asociar Entrevista -->
<div class="modal fade" id="modalAsociarEntrevista" tabindex="-1" aria-labelledby="modalAsociarEntrevistaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-white border-b p-4 sticky-top shadow-sm">
        <div>
          <h5 class="modal-title text-lg font-medium mb-2" id="modalAsociarEntrevistaLabel">
            <i class="fas fa-user-edit me-2 text-blue-600"></i>Asociar Entrevista de Cliente
          </h5>
          <div class="flex flex-col bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
            <div class="text-gray-800 mb-1">
              <i class="fas fa-user me-1 text-blue-600"></i>
              <strong>Cliente:</strong> <span id="clienteNombreModal" class="font-semibold ml-1">Cargando...</span>
            </div>
            <div class="text-gray-800">
              <i class="fas fa-id-card me-1 text-blue-600"></i>
              <strong>Cédula:</strong> <span id="clienteCedulaModal" class="font-mono font-semibold ml-1">Cargando...</span>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4" style="max-height: 60vh; overflow-y: auto;">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 sticky top-0 z-10">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-shield-alt text-yellow-400"></i>
            </div>
            <div class="ml-3">
              <div class="d-flex align-items-center">
                <p class="text-sm text-yellow-700 mb-0">
                  <strong>Seguridad:</strong> Por seguridad, solo puede seleccionar entrevistas con coincidencia exacta o parcial de cédula.
                  <button type="button" class="btn btn-link text-yellow-700 p-0 ml-1" onclick="mostrarInfoCoincidencias()">
                    <i class="fas fa-info-circle"></i>
                  </button>
                </p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-4 sticky top-20 z-10 pt-2 pb-2 bg-white">
          <label for="buscarEntrevista" class="block text-sm font-medium text-gray-700 mb-1">Buscar Entrevista</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-gray-400"></i>
            </div>
            <input type="text" class="form-control pl-10" id="buscarEntrevista" 
                   placeholder="Refinar búsqueda por nombre o email (opcional)..."
                   onkeyup="buscarEntrevistas()">
          </div>
          <div class="text-xs text-gray-500 mt-1">
            <i class="fas fa-filter me-1"></i>Ya filtrado por cédula: <span id="filteredByCedula" class="font-mono">Cargando...</span>
          </div>
        </div>
        
        <div id="resultadosEntrevistas" class="mt-4 transition-all duration-300">
          <!-- Aquí se cargarán los resultados -->
        </div>
        
        <div id="entrevistaSeleccionada" class="mt-4 p-4 border-2 border-green-500 rounded-md bg-green-50 shadow-sm transition-all duration-300" style="display: none;">
          <div class="flex items-center mb-2">
            <div class="flex-shrink-0">
              <i class="fas fa-check-circle text-green-500 text-xl"></i>
            </div>
            <div class="ml-3">
              <div class="mb-1">
                <strong class="text-gray-700">Entrevista seleccionada:</strong>
                <span id="nombreEntrevistaSeleccionada" class="font-medium"></span>
              </div>
              <div class="text-sm">
                <strong class="text-gray-700">Cédula:</strong>
                <span id="cedulaEntrevistaSeleccionada" class="font-mono font-medium"></span>
                <span class="inline-flex items-center ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  <i class="fas fa-shield-alt mr-1"></i>Verificada
                </span>
              </div>
            </div>
          </div>
          <div class="bg-white p-3 rounded-md border border-gray-200 mt-2 text-sm">
            <p class="text-gray-700 mb-0">
              <i class="fas fa-info-circle text-blue-600 mr-1"></i>
              Esta acción vinculará los datos de la entrevista seleccionada con la solicitud actual.
              <br>Solo se asocian entrevistas del mismo cliente por motivos de seguridad.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-gray-50 p-3 sticky-bottom shadow-sm">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Cancelar
        </button>
        <button type="button" class="btn btn-success" id="btnConfirmarAsociacion" onclick="confirmarAsociacion()" disabled>
          <i class="fas fa-link me-1"></i> Confirmar Asociación
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Avanzar Subestado -->
<div class="modal fade" id="modalAvanzarSubestado" tabindex="-1" aria-labelledby="modalAvanzarSubestadoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: #fff;">
        <h5 class="modal-title" id="modalAvanzarSubestadoLabel">
          <i class="fas fa-arrow-right me-2"></i>
          Avanzar al Siguiente Subestado
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Información de la solicitud -->
        <div class="alert" style="background: linear-gradient(90deg, #e0f2fe 0%, #f0fdfa 100%); color: #1e40af; border: none;">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Solicitud:</strong> <span id="avanzar-codigo-solicitud">{{ solicitud.codigo }}</span>
          <br>
          <strong>Subestado Actual:</strong> <span id="avanzar-subestado-actual">{{ solicitud.subestado_actual.nombre }}</span>
          <br>
          <strong>Siguiente Subestado:</strong> <span id="avanzar-siguiente-subestado">Cargando...</span>
        </div>

        <!-- Estado de documentos -->
        <div id="estado-documentos" class="mb-4" style="display: none;">
          <div class="card" style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
            <div class="card-header" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-bottom: 1px solid #e5e7eb; padding: 12px 16px;">
              <h6 class="mb-0" style="color: #374151; font-weight: 600;">
                <i class="fas fa-clipboard-check me-2"></i>
                Estado de Documentos
              </h6>
            </div>
            <div class="card-body" style="padding: 16px;">
              
              <!-- Resumen de documentos -->
              <div class="row text-center mb-3">
                <div class="col-3">
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                      <i class="fas fa-check" style="font-size: 18px;"></i>
                    </div>
                    <div class="fw-bold" style="font-size: 1.25rem; color: #059669;" id="documentos-buenos-count">0</div>
                    <small class="text-muted">Buenos</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 48px; height: 48px; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white;">
                      <i class="fas fa-times" style="font-size: 18px;"></i>
                    </div>
                    <div class="fw-bold" style="font-size: 1.25rem; color: #dc2626;" id="documentos-malos-count">0</div>
                    <small class="text-muted">Malos</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                      <i class="fas fa-clock" style="font-size: 18px;"></i>
                    </div>
                    <div class="fw-bold" style="font-size: 1.25rem; color: #d97706;" id="documentos-pendientes-count">0</div>
                    <small class="text-muted">Pendientes</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 48px; height: 48px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white;">
                      <i class="fas fa-file-alt" style="font-size: 18px;"></i>
                    </div>
                    <div class="fw-bold" style="font-size: 1.25rem; color: #4b5563;" id="documentos-total-count">0</div>
                    <small class="text-muted">Total</small>
                  </div>
                </div>
              </div>

              <!-- Lista de documentos pendientes -->
              <div id="lista-documentos-pendientes" style="display: none;">
                <div class="alert" style="background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%); color: #92400e; border: 1px solid #f59e0b; border-radius: 8px; margin-bottom: 16px;">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2" style="color: #d97706;"></i>
                    <div>
                      <strong>Documentos Pendientes Detectados</strong>
                      <br>
                      <small>Los siguientes documentos opcionales están marcados como pendientes y avanzarán en este estado:</small>
                    </div>
                  </div>
                </div>
                
                <div id="documentos-pendientes-lista" class="mb-3">
                  <!-- Los documentos pendientes se insertarán aquí dinámicamente -->
                </div>
              </div>

              <!-- Mensaje cuando no hay pendientes -->
              <div id="sin-documentos-pendientes" style="display: none;">
                <div class="alert" style="background: linear-gradient(90deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; border: 1px solid #10b981; border-radius: 8px;">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2" style="color: #10b981;"></i>
                    <div>
                      <strong>Todos los documentos están procesados</strong>
                      <br>
                      <small>No hay documentos pendientes. Puedes continuar con confianza.</small>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Opciones de asignación -->
        <div class="mb-4">
          <h6 class="fw-bold" style="color: #009c3c;">
            <i class="fas fa-user-check me-2"></i>
            ¿Quién continuará con el siguiente subestado?
          </h6>
          
          <!-- Botones de opción -->
          <div class="d-flex gap-2 mb-3">
            <button type="button" class="btn btn-outline-primary flex-fill" id="btn-continuar-yo" onclick="seleccionarOpcionAvance('yo')">
              <i class="fas fa-user me-2"></i>
              Continuar Yo
            </button>
            <button type="button" class="btn btn-outline-success flex-fill" id="btn-asignar-otro" onclick="seleccionarOpcionAvance('otro')">
              <i class="fas fa-user-plus me-2"></i>
              Asignar a Otro Usuario
            </button>
            <button type="button" class="btn btn-outline-warning flex-fill" id="btn-bandeja-grupal" onclick="seleccionarOpcionAvance('bandeja')">
              <i class="fas fa-inbox me-2"></i>
              Devolver a Bandeja Grupal
            </button>
          </div>
        </div>

        <!-- Sección de asignación a otro usuario (inicialmente oculta) -->
        <div id="seccion-asignar-usuario" style="display: none;">
          <h6 class="fw-bold" style="color: #009c3c;">
            <i class="fas fa-users me-2"></i>
            Usuarios Disponibles:
          </h6>

          <!-- Barra de búsqueda -->
          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none;">
                <i class="fas fa-search"></i>
              </span>
              <input type="text" class="form-control" id="buscar-usuario-avance" placeholder="Buscar por nombre, email, grupos o roles..." style="border-left: none;">
              <button class="btn btn-outline-secondary" type="button" id="limpiar-busqueda-avance">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              Busca por nombre, email, grupos o roles (Staff/Admin)
            </small>
          </div>

          <!-- Tabla de usuarios -->
          <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-hover table-striped" id="tabla-usuarios-avance" style="border-radius: 8px; overflow: hidden;">
              <thead style="background: linear-gradient(90deg, #22a650 0%, #009c3c 100%); color: #fff;">
                <tr>
                  <th scope="col" style="width: 50px;">#</th>
                  <th scope="col" style="width: 60px;">Avatar</th>
                  <th scope="col">Usuario</th>
                  <th scope="col">Email</th>
                  <th scope="col">Grupos</th>
                  <th scope="col" style="width: 120px;">Acciones</th>
                </tr>
              </thead>
              <tbody id="lista-usuarios-avance">
                <!-- Los usuarios se cargarán dinámicamente -->
              </tbody>
            </table>
          </div>

          <!-- Contador de resultados -->
          <div class="mt-2">
            <small class="text-muted">
              <i class="fas fa-users me-1"></i>
              <span id="contador-usuarios-avance">0</span> usuarios encontrados
            </small>
          </div>
        </div>

        <!-- Estados de carga y error -->
        <div id="avance-loading" class="text-center" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Cargando información...</p>
        </div>
        
        <div id="avance-error" class="alert alert-danger" style="display: none;">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span id="avance-error-mensaje"></span>
        </div>
      </div>
      
      <div class="modal-footer" style="background: #f0fdfa;">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>
          Cancelar
        </button>
        <button type="button" class="btn btn-success" id="btn-confirmar-avance" onclick="confirmarAvance()" disabled>
          <i class="fas fa-check me-1"></i>
          Confirmar Avance
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Devolver a Oficial -->
<div class="modal fade" id="modalDevolverOficial" tabindex="-1" aria-labelledby="modalDevolverOficialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: #fff;">
        <h5 class="modal-title" id="modalDevolverOficialLabel">
          <i class="fas fa-arrow-left me-2"></i>
          Devolver a Oficial
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Información de la solicitud -->
        <div class="alert" style="background: linear-gradient(90deg, #fee2e2 0%, #fef2f2 100%); color: #dc2626; border: none;">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Solicitud:</strong> <span>{{ solicitud.codigo }}</span>
          <br>
          <strong>Etapa Actual:</strong> <span>{{ solicitud.etapa_actual.nombre }}</span>
          <br>
          <strong>Se devolverá a:</strong> <span id="devolver-etapa-destino">Cargando...</span>
        </div>

        <!-- Resumen de documentos problemáticos -->
        <div id="documentos-problematicos" class="mb-4">
          <div class="card" style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
            <div class="card-header" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-bottom: 1px solid #e5e7eb; padding: 12px 16px;">
              <h6 class="mb-0" style="color: #374151; font-weight: 600;">
                <i class="fas fa-exclamation-circle me-2"></i>
                Documentos Problemáticos
              </h6>
            </div>
            <div class="card-body" style="padding: 16px;">
              <div id="lista-documentos-problematicos">
                <!-- Se llenará dinámicamente -->
              </div>
            </div>
          </div>
        </div>

        <!-- Motivo de devolución -->
        <div class="mb-3">
          <label for="motivo-devolucion" class="form-label fw-bold">
            <i class="fas fa-comment-alt me-2"></i>
            Motivo de la devolución
          </label>
          <textarea id="motivo-devolucion" class="form-control" rows="3" placeholder="Describe el motivo de la devolución..."></textarea>
        </div>
        

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>
          Cancelar
        </button>
        <button type="button" class="btn btn-danger" id="btn-confirmar-devolucion" onclick="confirmarDevolucion()">
          <i class="fas fa-arrow-left me-1"></i>
          Confirmar Devolución
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}