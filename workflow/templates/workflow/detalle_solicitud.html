{% extends "workflow/base.html" %}
{% load static %}
{% load workflow_filters %}

{% block title %}Detalle de Solicitud - Sistema de Workflow{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'workflow/css/detalleSolicitud.css' %}">
<style>
  .info-group {
    margin-bottom: 1rem;
  }
  .info-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 0.25rem;
    display: block;
  }
  .info-value {
    font-size: 1rem;
    color: #212529;
    font-weight: 500;
  }
  .timeline {
    position: relative;
    padding-left: 2rem;
  }
  .timeline-item {
    position: relative;
    margin-bottom: 2rem;
  }
  .timeline-marker {
    position: absolute;
    left: -2rem;
    top: 0;
    width: 2rem;
    height: 2rem;
    background: #e9ecef;
    border: 3px solid #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .timeline-item.completed .timeline-marker {
    background: #28a745;
    color: white;
  }
  .timeline-item.active .timeline-marker {
    background: #007bff;
    color: white;
  }
  .timeline-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.5rem;
    border-left: 3px solid #dee2e6;
  }
  .timeline-item.completed .timeline-content {
    border-left-color: #28a745;
  }
  .timeline-item.active .timeline-content {
    border-left-color: #007bff;
  }
  .timeline-title {
    margin-bottom: 0.5rem;
    color: #495057;
  }
  .timeline-description {
    margin-bottom: 0.5rem;
    color: #6c757d;
  }
  .timeline-time {
    font-size: 0.875rem;
  }
  .timeline-comments {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: #fff;
    border-radius: 0.25rem;
    font-style: italic;
  }
  .comentario-item {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
    border-left: 3px solid #007bff;
  }
  .comentario-content {
    color: #495057;
    line-height: 1.5;
  }
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    display: none;
  }
  .loading-content {
    text-align: center;
  }
  .loading-spinner {
    width: 3rem;
    height: 3rem;
    border: 0.3rem solid #f3f4f6;
    border-top: 0.3rem solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .fade-in-up {
    animation: fadeInUp 0.5s ease-out;
  }
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="fade-in-up">
  <!-- Pass solicitud ID to JavaScript via data attribute -->
  <script>
    document.body.setAttribute('data-solicitud-id', '{{ solicitud.id }}');
    window.solicitudId = {{ solicitud.id }};
  </script>
  
  <!-- CSRF Token for AJAX requests -->
  {% csrf_token %}
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <a href="{% url 'workflow:dashboard' %}" class="btn btn-outline-pacifico mb-2">
        <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
      </a>
      <h1 class="h2 mb-1 text-dark fw-bold">
        <i class="fas fa-file-alt me-2 text-success"></i>
        <span id="solicitudCodigo">COT-XXXX-XXX</span>
      </h1>
      <p class="text-muted mb-0" id="solicitudCliente">Nombre Cliente - CI: 00000000</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-pacifico" id="btnAsignar">
        <i class="fas fa-user-plus me-2"></i>Asignar
      </button>
      <button class="btn btn-outline-secondary" id="btnDevolver">
        <i class="fas fa-undo me-2"></i>Devolver
      </button>
      <button class="btn btn-outline-danger" id="btnAnular">
        <i class="fas fa-times me-2"></i>Anular
      </button>
      <button class="btn btn-pacifico" id="btnCambiarEstado">
        <i class="fas fa-exchange-alt me-2"></i>Cambiar Estado
      </button>
    </div>
  </div>

  <!-- Info Cards -->
  <div class="row mb-4">
    <div class="col-md-8">
      <!-- Main Info Card -->
      <div class="card card-custom mb-4">
        <div class="card-header-custom">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Información General
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-muted small fw-semibold mb-1">Etapa</span>
                <span class="badge-pacifico" id="solicitudEtapa">-</span>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-muted small fw-semibold mb-1">Monto Solicitado</span>
                <span class="text-success fw-bold fs-5" id="solicitudMonto">$0.00</span>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-muted small fw-semibold mb-1">Producto</span>
                <span class="badge bg-light text-dark" id="solicitudProducto">-</span>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-muted small fw-semibold mb-1">Progreso</span>
                <div class="progress progress-custom mb-1">
                  <div class="progress-bar progress-bar-custom" id="solicitudProgreso" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="solicitudProgresoText">0%</small>
              </div>
            </div>
          </div>
          
          <hr class="my-4">
          
          <div class="row g-4">
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-muted small fw-semibold mb-1">Propietario</span>
                <span class="fw-semibold" id="solicitudPropietario">-</span>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-muted small fw-semibold mb-1">Asignado a</span>
                <span class="fw-semibold" id="solicitudAsignado">-</span>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-muted small fw-semibold mb-1">Fecha Inicio</span>
                <span class="fw-semibold" id="solicitudFechaInicio">-</span>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-muted small fw-semibold mb-1">SLA Restante</span>
                <span class="text-warning fw-semibold" id="solicitudSLA">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs Section -->
      <div class="card card-custom">
        <div class="card-header-custom">
          <ul class="nav nav-tabs nav-tabs-custom" id="solicitudTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-personal" data-bs-toggle="tab" data-bs-target="#tabDatosPersonales" type="button" role="tab">
                <i class="fas fa-user me-2"></i>Datos Personales
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-resultado" data-bs-toggle="tab" data-bs-target="#tabResultadoConsulta" type="button" role="tab">
                <i class="fas fa-clipboard-check me-2"></i>Resultado Consulta
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-referencias" data-bs-toggle="tab" data-bs-target="#tabReferencias" type="button" role="tab">
                <i class="fas fa-address-book me-2"></i>Referencias
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-documentos" data-bs-toggle="tab" data-bs-target="#tabDocumentos" type="button" role="tab">
                <i class="fas fa-file-alt me-2"></i>Documentos
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body p-0">
          <div class="tab-content" id="solicitudTabContent">
            <div class="tab-pane fade show active p-4" id="tabDatosPersonales" role="tabpanel">
              <div class="text-center py-4" id="datosPersonalesContent">
                <div class="spinner-custom mx-auto mb-3"></div>
                <p class="text-muted">Cargando datos personales...</p>
              </div>
            </div>
            <div class="tab-pane fade p-4" id="tabResultadoConsulta" role="tabpanel">
              <div class="row">
                <!-- Comentarios de Analista -->
                <div class="col-md-6">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                      <h6 class="mb-0">
                        <i class="fas fa-user-md me-2"></i>Comentarios del Analista
                      </h6>
                    </div>
                    <div class="card-body">
                      <div id="comentariosAnalistaContent">
                        <div class="text-center py-4">
                          <div class="spinner-custom mx-auto mb-3"></div>
                          <p class="text-muted">Cargando comentarios del analista...</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Resultado de Comité -->
                <div class="col-md-6">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                      <h6 class="mb-0">
                        <i class="fas fa-users me-2"></i>Resultado del Comité
                      </h6>
                    </div>
                    <div class="card-body">
                      <div id="resultadoComiteContent">
                        <div class="text-center py-4">
                          <div class="spinner-custom mx-auto mb-3"></div>
                          <p class="text-muted">Cargando resultado del comité...</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="tab-pane fade p-4" id="tabReferencias" role="tabpanel">
              <div class="text-center py-4" id="referenciasContent">
                <div class="spinner-custom mx-auto mb-3"></div>
                <p class="text-muted">Cargando referencias...</p>
              </div>
            </div>
            <div class="tab-pane fade p-4" id="tabDocumentos" role="tabpanel">
              <div class="text-center py-4" id="documentosContent">
                <div class="spinner-custom mx-auto mb-3"></div>
                <p class="text-muted">Cargando documentos...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
      <!-- Historial de Actividades -->
      <div class="card card-custom mb-4">
        <div class="card-header-custom">
          <h5 class="mb-0">
            <i class="fas fa-history me-2"></i>
            Historial de Actividades
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="timeline p-4" id="solicitudHistorial">
            <div class="text-center py-4">
              <div class="spinner-custom mx-auto mb-3"></div>
              <p class="text-muted">Cargando historial...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Comentarios -->
      <div class="card card-custom">
        <div class="card-header-custom">
          <h5 class="mb-0">
            <i class="fas fa-comments me-2"></i>
            Comentarios
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="p-4" id="solicitudComentarios">
            <div class="text-center py-4">
              <div class="spinner-custom mx-auto mb-3"></div>
              <p class="text-muted">Cargando comentarios...</p>
            </div>
          </div>
          <div class="card-footer bg-light border-top">
            <form id="comentarioForm">
              <div class="mb-3">
                <textarea class="form-control form-control-custom" id="comentarioInput" rows="3" placeholder="Escribe un comentario..."></textarea>
              </div>
              <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-pacifico">
                  <i class="fas fa-paper-plane me-2"></i>Enviar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div class="loading-text">Cargando solicitud...</div>
    <div class="loading-subtext">Por favor espere</div>
  </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

{% include 'workflow/partials/solicitud_negocios_styles.html' %}

<script>
  // Pasar el ID de la solicitud al JavaScript
  window.solicitudId = {{ solicitud.id }};
</script>
<script src="{% static 'workflow/js/detalleSolicitud.js' %}"></script>
{% endblock %}

