{% extends 'workflow/base.html' %}
{% load static %}
{% load file_icon_filters %}

{% block title %}Análisis de Reconsideración - {{ solicitud.codigo }}{% endblock %}

{% block extra_css %}
{% include 'workflow/partials/analisis_styles.html' %}
<style>
    /* Modern header styling matching committee and analysis templates */
    .reconsideracion-header {
        background: linear-gradient(135deg, #7c3aed, #a855f7);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
        border: 1px solid #e9ecef;
        position: relative;
        overflow: hidden;
    }
    
    .reconsideracion-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%), 
                    linear-gradient(-45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%), 
                    linear-gradient(45deg, transparent 75%, rgba(255, 255, 255, 0.1) 75%), 
                    linear-gradient(-45deg, transparent 75%, rgba(255, 255, 255, 0.1) 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        opacity: 0.1;
        pointer-events: none;
    }
    
    .reconsideracion-header .header-content {
        position: relative;
        z-index: 1;
    }
    
    .reconsideracion-badge {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 0.375rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: 0.75rem;
        backdrop-filter: blur(10px);
    }
    
    .reconsideracion-badge:first-of-type {
        margin-left: 0;
    }
    
    .reconsideracion-number {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .reconsideracion-subtitle {
        font-size: 1.1rem;
        margin: 0.5rem 0 0 0;
        opacity: 0.95;
        font-weight: 500;
    }
    
    /* Main layout improvements */
    .main-layout-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    /* Modern motivo section styling */
    .motivo-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
        height: fit-content;
    }
    
    .motivo-header {
        background: linear-gradient(135deg, #059669, #10b981);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .motivo-content {
        padding: 1.5rem;
    }
    
    .motivo-text {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        line-height: 1.6;
        color: #374151;
        font-size: 0.95rem;
        margin-bottom: 1rem;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .motivo-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        font-size: 0.875rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e5e7eb;
    }
    
    /* Analysis sections grid matching other templates */
    .analysis-sections {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
        height: 500px;
        display: flex;
        flex-direction: column;
    }
    
    .sections-header {
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .sections-header h5 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .sections-content {
        flex: 1;
        padding: 1rem;
        background-color: #f8f9fa;
        overflow-y: auto;
    }
    
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        height: 100%;
    }
    
    /* Section containers matching analysis template */
    .section-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
        overflow: hidden;
        height: fit-content;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        transition: all 0.2s ease;
    }
    
    .section-container:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        transform: translateY(-1px);
    }
    
    .section-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        transition: all 0.3s ease;
        user-select: none;
    }
    
    .section-header:hover {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
    }
    
    .section-header-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }
    
    .section-title {
        margin: 0;
        font-size: 0.875rem;
        font-weight: 600;
        color: white;
    }
    
    .section-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }
    
    .section-toggle:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }
    
    .toggle-icon {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }
    
    .section-content {
        flex: 1;
        padding: 0.75rem;
        background-color: white;
        transition: all 0.3s ease;
        overflow-y: auto;
        max-height: 250px;
    }
    
    .section-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
        overflow: hidden;
    }
    
    /* Info rows styling */
    .info-row-with-status {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s ease;
    }
    
    .info-row-with-status:hover {
        background-color: #f9fafb;
    }
    
    .info-row-with-status:last-child {
        border-bottom: none;
    }
    
    .info-data {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        min-width: 0;
    }
    
    .info-label {
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
        flex-shrink: 0;
        margin-right: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .info-value {
        color: #6b7280;
        font-size: 0.875rem;
        text-align: right;
        flex: 1;
        word-break: break-word;
        font-weight: 500;
    }
    
    /* Decision form styling */
    .decision-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
        margin-top: 1.5rem;
    }
    
    .decision-header {
        background: linear-gradient(135deg, #dc2626, #ef4444);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .decision-content {
        padding: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .form-control {
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background-color: white;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        line-height: 1.5;
        padding: 0.75rem;
        resize: vertical;
    }
    
    .form-control:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        background-color: white;
        outline: none;
    }
    
    /* Decision buttons grid */
    .decision-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .btn-decision {
        padding: 1.5rem 1rem;
        border: 2px solid transparent;
        border-radius: 12px;
        font-weight: 600;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-decoration: none;
        color: #374151;
        position: relative;
        overflow: hidden;
    }
    
    .btn-decision:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }
    
    .btn-decision:hover:before {
        left: 100%;
    }
    
    .btn-decision:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    .btn-aprobar {
        border-color: #10b981;
        color: #10b981;
    }
    
    .btn-aprobar:hover {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border-color: #059669;
    }
    
    .btn-rechazar {
        border-color: #ef4444;
        color: #ef4444;
    }
    
    .btn-rechazar:hover {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border-color: #dc2626;
    }
    
    .btn-comite {
        border-color: #f59e0b;
        color: #f59e0b;
    }
    
    .btn-comite:hover {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border-color: #d97706;
    }
    
    .btn-decision i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .btn-decision strong {
        display: block;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }
    
    .btn-decision small {
        display: block;
        font-size: 0.75rem;
        opacity: 0.8;
        font-weight: 400;
    }
    
    /* Committee results table styling */
    .comite-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    
    .comite-header {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .comite-content {
        padding: 1.5rem;
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .table {
        margin-bottom: 0;
        background: white;
    }
    
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        padding: 1rem 0.75rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .table td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        border-top: 1px solid #f1f3f4;
    }
    
    .table-hover tbody tr:hover {
        background-color: #f8fafc;
        transform: scale(1.001);
        transition: all 0.2s ease;
    }
    
    /* Badge styling for committee results */
    .badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .badge-primary {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
    }
    
    .badge-aprobado {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }
    
    .badge-rechazado {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }
    
    .badge-observaciones {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }
    
    .badge-pendiente {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        color: white;
    }
    
    /* Avatar styling */
    .avatar-sm {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        margin-right: 0.75rem;
        overflow: hidden;
        flex-shrink: 0;
    }
    
    .avatar-sm i {
        font-size: 1.5rem;
        color: #6b7280;
    }
    
    .participant-info {
        flex: 1;
    }
    
    .participant-name {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.25rem;
    }
    
    .participant-role {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    /* Previous analysis results */
    .resultado-anterior-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    
    .resultado-header {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .resultado-content {
        padding: 1.5rem;
    }
    
    .alert {
        border: none;
        border-radius: 8px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        font-weight: 500;
    }
    
    .alert-warning {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        border-left: 4px solid #f59e0b;
    }
    
    .comentario-analisis-anterior {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .comentario-analisis-anterior h6 {
        color: #374151;
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .comentario-analisis-anterior p {
        color: #6b7280;
        line-height: 1.6;
        margin-bottom: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    /* Archivo Adjunto Section */
    .archivo-adjunto-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    
    .archivo-header {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .archivo-content {
        padding: 1.5rem;
    }
    
    .archivo-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.2s ease;
    }
    
    .archivo-item:hover {
        border-color: #ef4444;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
    }
    
    .archivo-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }
    
    .archivo-icon {
        font-size: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 8px;
    }
    
    .archivo-details .archivo-name {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.25rem;
        word-break: break-all;
    }
    
    .archivo-details .archivo-size {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }
    
    .archivo-details .archivo-fecha {
        font-size: 0.875rem;
        color: #9ca3af;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .archivo-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .archivo-actions .btn {
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .archivo-actions .btn:hover {
        transform: translateY(-1px);
    }
    
    /* Comparison section for quotations */
    .comparacion-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    .comparacion-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }
    
    .comparacion-card:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        transition: all 0.2s ease;
    }
    
    .comparacion-card.anterior:before {
        background: linear-gradient(180deg, #ef4444, #dc2626);
    }
    
    .comparacion-card.actual:before {
        background: linear-gradient(180deg, #10b981, #059669);
    }
    
    .comparacion-card:hover {
        background-color: #f8fafc;
        border-color: #d1d5db;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .comparacion-card h6 {
        font-weight: 700;
        margin-bottom: 1rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .comparacion-card p {
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .comparacion-card strong {
        color: #374151;
        font-weight: 600;
    }
    
    /* Responsive design */
    @media (max-width: 1200px) {
        .analysis-grid {
            grid-template-columns: 1fr;
        }
        
        .comparacion-section {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .decision-buttons {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
    }
    
    @media (max-width: 768px) {
        .reconsideracion-header {
            padding: 1rem 1.5rem;
        }
        
        .reconsideracion-number {
            font-size: 1.5rem;
        }
        
        .reconsideracion-subtitle {
            font-size: 1rem;
        }
        
        .reconsideracion-badge {
            display: block;
            margin-top: 0.5rem;
            margin-left: 0;
            width: fit-content;
        }
        
        .analysis-sections {
            height: auto;
            min-height: 400px;
        }
        
        .section-content {
            max-height: 200px;
        }
        
        .btn-decision {
            padding: 1rem 0.75rem;
        }
        
        .btn-decision i {
            font-size: 1.25rem;
        }
        
        .btn-decision strong {
            font-size: 0.875rem;
        }
        
        .btn-decision small {
            font-size: 0.7rem;
        }
        
        /* Mobile adjustments for compliance status */
        .info-row-with-status {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.75rem;
        }
        
        .info-data {
            width: 100%;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        
        .info-label {
            margin-right: 0;
        }
        
        .info-value {
            text-align: left;
        }
        
        .compliance-status {
            margin-left: 0;
            align-self: flex-end;
        }
    }
    
    .btn-comite {
        background: #f59e0b;
        color: #1f2937;
        border: 1px solid #f59e0b;
    }
    
    .btn-comite:hover {
        background: #d97706;
        border-color: #d97706;
        color: white;
    }
    
    .btn-decision:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .comentario-analisis {
        margin-top: 15px;
        padding: 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f8f9fa;
    }
    
    .motivo-reconsideracion {
        background: #eff6ff;
        border: 1px solid #3b82f6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    /* Card styling improvements to match analysis template */
    .card.shadow {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .card-header {
        background: white;
        border-bottom: 1px solid #f1f3f4;
        padding: 1rem 1.25rem;
    }
    
    .card-body {
        background-color: #f8f9fa;
        padding: 1.25rem;
    }
    
    /* Form styling */
    .form-control {
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background-color: white;
        transition: all 0.2s ease;
    }
    
    .form-control:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        background-color: white;
    }
    
    /* Alert styling */
    .alert-warning {
        background-color: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
        border-radius: 8px;
    }
    
    /* Additional styles for new sections */
    .compliance-field-item {
        border-left: 4px solid #e3e6f0;
        padding: 10px 15px;
        margin-bottom: 10px;
        background: #f8f9fc;
        border-radius: 0 8px 8px 0;
    }
    
    .compliance-field-item.status-bueno {
        border-left-color: #1cc88a;
    }
    
    .compliance-field-item.status-malo {
        border-left-color: #e74a3b;
    }
    
    .compliance-field-item.status-sin_calificar {
        border-left-color: #6c757d;
    }
    
    .bullet-item {
        border-left: 4px solid #e3e6f0;
        padding: 15px 20px;
        margin-bottom: 15px;
        background: #f8f9fc;
        border-radius: 0 8px 8px 0;
        transition: all 0.3s ease;
    }
    
    .bullet-item:hover {
        background: #e8f0fe;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .bullet-content {
        width: 100%;
    }
    
    .bullet-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .bullet-title {
        font-weight: 600;
        color: #2c3e50;
        flex: 1;
        min-width: 120px;
    }
    
    .bullet-value {
        background: #e3f2fd;
        color: #1565c0;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .bullet-comment {
        font-size: 0.9em;
        color: #5a6c7d;
        line-height: 1.5;
        padding-left: 20px;
        position: relative;
    }
    
    .bullet-comment i {
        position: absolute;
        left: 0;
        top: 2px;
        font-size: 0.8em;
    }
    
    .border-left {
        border-left-width: 4px !important;
    }
    
    .border-success {
        border-left-color: #1cc88a !important;
    }
    
    .border-danger {
        border-left-color: #e74a3b !important;
    }
    
    .border-secondary {
        border-left-color: #6c757d !important;
    }
    
    /* Committee participant styles */
    .avatar-sm {
        width: 40px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .comentario-preview {
        max-width: 300px;
    }
    
    .badge-aprobado {
        background-color: #1cc88a !important;
    }
    
    .badge-rechazado {
        background-color: #e74a3b !important;
    }
    
    .badge-observaciones {
        background-color: #f6c23e !important;
    }
    
    .badge-pendiente {
        background-color: #6c757d !important;
    }
    
    /* Collapsible section improvements */
    .collapse {
        transition: height 0.3s ease;
    }
    
    .card-header .btn-outline-info,
    .card-header .btn-outline-warning {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Button styling improvements */
    .btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
        padding: 0.5rem 1rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-success {
        background-color: #16a34a;
        color: white;
    }
    
    .btn-success:hover {
        background-color: #15803d;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(22, 163, 74, 0.4);
    }
    
    .btn-danger {
        background-color: #dc2626;
        color: white;
    }
    
    .btn-danger:hover {
        background-color: #b91c1c;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    }
    
    /* Analysis grid styling to match analysis template */
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        min-height: 400px;
    }
    
    /* Section container styling */
    .section-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    /* Section header styling */
    .section-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        user-select: none;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        border-radius: 12px 12px 0 0;
    }

    .section-header:hover {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
    }

    .section-header-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }
    
    .section-header-content i {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1rem;
    }

    .section-title {
        margin: 0;
        font-size: 0.875rem;
        font-weight: 600;
        color: white;
    }

    .section-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .section-toggle:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .toggle-icon {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
        color: rgba(255, 255, 255, 0.8);
    }

    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .section-content {
        transition: all 0.3s ease;
        overflow: hidden;
        max-height: 300px;
        overflow-y: auto;
        padding: 0.75rem;
        border-radius: 0.375rem;
        background-color: white;
        flex: 1;
        border-top: 1px solid #f1f3f4;
    }

    .section-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
        overflow: hidden;
    }

    /* Custom scrollbar styling for section content */
    .section-content::-webkit-scrollbar {
        width: 6px;
    }

    .section-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .section-content::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .section-content::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    /* Historial de reconsideraciones specific styles */
    .table-success {
        background-color: rgba(22, 163, 74, 0.1) !important;
    }
    
    .table-danger {
        background-color: rgba(220, 38, 38, 0.1) !important;
    }
    
    .table-warning {
        background-color: rgba(245, 158, 11, 0.1) !important;
    }
    
    .motivo-preview, .comentario-preview {
        line-height: 1.4;
        font-size: 0.875rem;
    }
    
    .motivo-preview span, .comentario-preview span {
        display: block;
        margin-bottom: 0.5rem;
        color: #374151;
    }
    
    .badge-success {
        background-color: #16a34a !important;
        color: white !important;
    }
    
    .badge-danger {
        background-color: #dc2626 !important;
        color: white !important;
    }
    
    .badge-warning {
        background-color: #d97706 !important;
        color: white !important;
    }
    
    .badge-info {
        background-color: #0369a1 !important;
        color: white !important;
    }
    
    .badge-secondary {
        background-color: #6b7280 !important;
        color: white !important;
    }
    
    /* Statistics cards */
    .card {
        transition: all 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .card.border-success {
        border-color: #22c55e !important;
    }
    
    .card.border-danger {
        border-color: #ef4444 !important;
    }
    
    .card.border-warning {
        border-color: #f59e0b !important;
    }
    
    .card.border-info {
        border-color: #3b82f6 !important;
    }
    
    /* Info row styling to match analysis template with compliance status */
    .info-row-with-status {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s ease;
    }

    .info-row-with-status:hover {
        background-color: #f9fafb;
        border-color: #d1d5db;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .info-row-with-status:last-child {
        border-bottom: none;
    }

    .info-data {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        min-width: 0;
    }

    .info-label {
        font-weight: 600;
        font-size: 0.875rem;
        color: #374151;
        flex-shrink: 0;
        margin-right: 1rem;
    }

    .info-value {
        font-weight: 500;
        font-size: 0.875rem;
        color: #6b7280;
        text-align: right;
        flex: 1;
        word-break: break-word;
    }
    
    .compliance-status {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-left: 1rem;
        flex-shrink: 0;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        cursor: default;
    }
    
    .status-badge:hover {
        transform: scale(1.05);
    }
    
    .status-bueno {
        background-color: #dcfce7;
        color: #166534;
        border-color: #22c55e;
    }
    
    .status-malo {
        background-color: #fef2f2;
        color: #991b1b;
        border-color: #ef4444;
    }
    
    .status-sin_calificar {
        background-color: #f3f4f6;
        color: #6b7280;
        border-color: #9ca3af;
    }
    
    /* Adjunto item styling */
    .adjunto-item {
        background: white;
        border: 1px solid #e5e7eb !important;
        border-radius: 8px !important;
        padding: 12px !important;
        margin-bottom: 8px !important;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .adjunto-item:hover {
        border-color: #d1d5db !important;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
        background-color: #f9fafb !important;
        transform: translateY(-1px);
    }

    .adjunto-icon i {
        font-size: 1.2rem;
        transition: transform 0.2s ease;
    }

    .adjunto-item:hover .adjunto-icon i {
        transform: scale(1.1);
    }

    .adjunto-name {
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
    }
    
    /* Responsive adjustments for 4-column layout */
    @media (max-width: 1200px) {
        .analysis-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            padding: 0.75rem;
        }
    }
    
    @media (max-width: 768px) {
        .analysis-grid {
            grid-template-columns: 1fr;
            gap: 0.5rem;
            padding: 0.5rem;
        }
        
        .section-content {
            max-height: 200px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Modern Header de Reconsideración -->
    <div class="reconsideracion-header">
        <div class="header-content">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="reconsideracion-number">
                        <i class="fas fa-redo-alt"></i>
                        Reconsideración #{{ reconsideracion_actual.numero_reconsideracion }}
                    </h1>
                    <p class="reconsideracion-subtitle">{{ solicitud.codigo }} - {{ solicitud.cliente_nombre_completo }}</p>
                </div>
                <div class="d-flex flex-wrap align-items-center">
                    <span class="reconsideracion-badge">
                        <i class="fas fa-info-circle"></i>
                        {{ reconsideracion_actual.get_estado_display }}
                    </span>
                    <span class="reconsideracion-badge">
                        <i class="fas fa-calendar"></i>
                        {{ reconsideracion_actual.fecha_solicitud|date:"d/m/Y H:i" }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout Container -->
    <div class="main-layout-container">
        <!-- Motivo de la reconsideración -->
        <div class="motivo-section">
            <div class="motivo-header">
                <i class="fas fa-comment-alt"></i>
                <h5 class="mb-0">Motivo de la Reconsideración</h5>
            </div>
            <div class="motivo-content">
                <div class="motivo-text">{{ reconsideracion_actual.motivo }}</div>
                <div class="motivo-meta">
                    <i class="fas fa-user"></i>
                    <span>Solicitado por: {{ reconsideracion_actual.solicitada_por.get_full_name|default:reconsideracion_actual.solicitada_por.username }}</span>
                    <span>•</span>
                    <i class="fas fa-clock"></i>
                    <span>{{ reconsideracion_actual.fecha_solicitud|date:"d/m/Y H:i" }}</span>
                </div>
            </div>
        </div>

        <!-- Analysis Sections -->
        <div class="analysis-sections">
            <div class="sections-header">
                <h5>
                    <i class="fas fa-search"></i>
                    Análisis Detallado Anterior
                </h5>
                <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#analisisSections" aria-expanded="true">
                    <i class="fas fa-eye"></i>
                    Ver/Ocultar
                </button>
            </div>
            <div class="sections-content collapse show" id="analisisSections">
                <div class="analysis-grid">
                    <!-- Información del Cliente -->
                    <div class="section-container">
                        <div class="section-header" onclick="toggleSection(this)">
                            <div class="section-header-content">
                                <i class="fas fa-user"></i>
                                <h6 class="section-title">Información del Cliente</h6>
                            </div>
                            <div class="section-toggle">
                                <i class="fas fa-chevron-down toggle-icon"></i>
                            </div>
                        </div>
                        <div class="section-content">
                            <div id="cliente-info-container">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <div class="mt-2">Cargando información del cliente...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detalle de la Solicitud -->
                    <div class="section-container">
                        <div class="section-header" onclick="toggleSection(this)">
                            <div class="section-header-content">
                                <i class="fas fa-file-invoice-dollar"></i>
                                <h6 class="section-title">Detalle de la Solicitud</h6>
                            </div>
                            <div class="section-toggle">
                                <i class="fas fa-chevron-down toggle-icon"></i>
                            </div>
                        </div>
                        <div class="section-content">
                            <div id="solicitud-detalle-container">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <div class="mt-2">Cargando detalle de la solicitud...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Datos del Vehículo -->
                    <div class="section-container">
                        <div class="section-header" onclick="toggleSection(this)">
                            <div class="section-header-content">
                                <i class="fas fa-car"></i>
                                <h6 class="section-title">Datos del Vehículo</h6>
                            </div>
                            <div class="section-toggle">
                                <i class="fas fa-chevron-down toggle-icon"></i>
                            </div>
                        </div>
                        <div class="section-content">
                            <div id="vehiculo-datos-container">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <div class="mt-2">Cargando datos del vehículo...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Adjuntos -->
                    <div class="section-container">
                        <div class="section-header" onclick="toggleSection(this)">
                            <div class="section-header-content">
                                <i class="fas fa-paperclip"></i>
                                <h6 class="section-title">Documentos Adjuntos</h6>
                            </div>
                            <div class="section-toggle">
                                <i class="fas fa-chevron-down toggle-icon"></i>
                            </div>
                        </div>
                        <div class="section-content">
                            <div id="adjuntos-container">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <div class="mt-2">Cargando documentos adjuntos...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
            
    <!-- Comparación de Cotizaciones -->
    {% if reconsideracion_actual.usar_nueva_cotizacion %}
    <div class="comite-section">
        <div class="comite-header">
            <h5 class="mb-0">
                <i class="fas fa-exchange-alt"></i>
                Comparación de Cotizaciones
            </h5>
        </div>
        <div class="comite-content">
            <div class="comparacion-section">
                <div class="comparacion-card anterior">
                    <h6>
                        <i class="fas fa-history text-danger"></i>
                        Cotización Original
                    </h6>
                    {% if reconsideracion_actual.cotizacion_original %}
                        <p><strong>Monto:</strong> ${{ reconsideracion_actual.cotizacion_original.montoPrestamo|floatformat:2 }}</p>
                        <p><strong>Plazo:</strong> {{ reconsideracion_actual.cotizacion_original.plazo }} meses</p>
                        <p><strong>Tipo:</strong> {{ reconsideracion_actual.cotizacion_original.tipoPrestamo|capfirst }}</p>
                    {% else %}
                        <p class="text-muted">No disponible</p>
                    {% endif %}
                </div>
                <div class="comparacion-card actual">
                    <h6>
                        <i class="fas fa-star text-success"></i>
                        Nueva Cotización
                    </h6>
                    {% if reconsideracion_actual.cotizacion_nueva %}
                        <p><strong>Monto:</strong> ${{ reconsideracion_actual.cotizacion_nueva.montoPrestamo|floatformat:2 }}</p>
                        <p><strong>Plazo:</strong> {{ reconsideracion_actual.cotizacion_nueva.plazo }} meses</p>
                        <p><strong>Tipo:</strong> {{ reconsideracion_actual.cotizacion_nueva.tipoPrestamo|capfirst }}</p>
                    {% else %}
                        <p class="text-muted">No disponible</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
            
    <!-- Comité de Crédito Information -->
    {% if participaciones_comite %}
    <div class="comite-section">
        <div class="comite-header">
            <h5 class="mb-0">
                <i class="fas fa-users"></i>
                Decisiones del Comité de Crédito
            </h5>
            <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#comiteInfo" aria-expanded="true">
                <i class="fas fa-eye"></i>
                Ver/Ocultar
            </button>
        </div>
        <div class="collapse show" id="comiteInfo">
            <div class="comite-content">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th><i class="fas fa-layer-group"></i> Nivel</th>
                                <th><i class="fas fa-user"></i> Participante</th>
                                <th><i class="fas fa-vote-yea"></i> Resultado</th>
                                <th><i class="fas fa-comment"></i> Comentario</th>
                                <th><i class="fas fa-calendar"></i> Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participacion in participaciones_comite %}
                            <tr>
                                <td>
                                    <span class="badge badge-primary">
                                        {{ participacion.nivel.nombre }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm">
                                            <i class="fas fa-user-circle"></i>
                                        </div>
                                        <div class="participant-info">
                                            <div class="participant-name">{{ participacion.usuario.get_full_name|default:participacion.usuario.username }}</div>
                                            <div class="participant-role">{{ participacion.usuario.userprofile.cargo|default:"Sin cargo definido" }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-{{ participacion.resultado|lower }}">
                                        {{ participacion.get_resultado_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if participacion.comentario %}
                                        <div class="comentario-preview">
                                            {{ participacion.comentario|truncatewords:15 }}
                                            {% if participacion.comentario|length > 80 %}
                                                <br>
                                                <a href="#" onclick="mostrarComentarioCompleto('{{ participacion.comentario|escapejs }}')" class="btn btn-sm btn-outline-info mt-1">
                                                    <i class="fas fa-expand-alt"></i>
                                                    Ver completo
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">Sin comentarios</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i>
                                        {{ participacion.fecha_modificacion|date:"d/m/Y H:i" }}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Historial de Reconsideraciones Anteriores -->
    {% if historial_reconsideraciones and historial_reconsideraciones|length > 1 %}
    <div class="comite-section">
        <div class="comite-header">
            <h5 class="mb-0">
                <i class="fas fa-history"></i>
                Historial de Reconsideraciones Anteriores
            </h5>
            <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#historialReconsideraciones" aria-expanded="true">
                <i class="fas fa-eye"></i>
                Ver/Ocultar
            </button>
        </div>
        <div class="collapse show" id="historialReconsideraciones">
            <div class="comite-content">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Total de reconsideraciones:</strong> {{ historial_reconsideraciones|length }}
                    <span class="ms-2">|</span>
                    <strong class="ms-2">Reconsideración actual:</strong> #{{ reconsideracion_actual.numero_reconsideracion }}
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> #</th>
                                <th><i class="fas fa-calendar"></i> Fecha Solicitud</th>
                                <th><i class="fas fa-user"></i> Solicitada Por</th>
                                <th><i class="fas fa-comment-alt"></i> Motivo</th>
                                <th><i class="fas fa-user-tie"></i> Analizada Por</th>
                                <th><i class="fas fa-calendar-check"></i> Fecha Análisis</th>
                                <th><i class="fas fa-clipboard-check"></i> Estado</th>
                                <th><i class="fas fa-comment-dots"></i> Comentario Análisis</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reconsideracion in historial_reconsideraciones %}
                            {% if reconsideracion != reconsideracion_actual %}
                            <tr class="{% if reconsideracion.estado == 'aprobada' %}table-success{% elif reconsideracion.estado == 'rechazada' %}table-danger{% elif reconsideracion.estado == 'enviada_comite' %}table-warning{% endif %}">
                                <td>
                                    <span class="badge badge-primary fs-6">
                                        #{{ reconsideracion.numero_reconsideracion }}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i>
                                        {{ reconsideracion.fecha_solicitud|date:"d/m/Y H:i" }}
                                    </small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm me-2">
                                            <i class="fas fa-user-circle"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">{{ reconsideracion.solicitada_por.get_full_name|default:reconsideracion.solicitada_por.username }}</div>
                                            <div class="text-muted small">{{ reconsideracion.solicitada_por.email|default:"Sin email" }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="motivo-preview" style="max-width: 200px;">
                                        {% if reconsideracion.motivo|length > 100 %}
                                            <span>{{ reconsideracion.motivo|truncatewords:15 }}</span>
                                            <br>
                                            <a href="#" onclick="mostrarComentarioCompleto('{{ reconsideracion.motivo|escapejs }}')" class="btn btn-sm btn-outline-info mt-1">
                                                <i class="fas fa-expand-alt"></i>
                                                Ver completo
                                            </a>
                                        {% else %}
                                            <span>{{ reconsideracion.motivo }}</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if reconsideracion.analizada_por %}
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <i class="fas fa-user-tie"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">{{ reconsideracion.analizada_por.get_full_name|default:reconsideracion.analizada_por.username }}</div>
                                                <div class="text-muted small">{{ reconsideracion.analizada_por.email|default:"Sin email" }}</div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-hourglass-half"></i>
                                            Pendiente
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if reconsideracion.fecha_analisis %}
                                        <small class="text-muted">
                                            <i class="fas fa-calendar-check"></i>
                                            {{ reconsideracion.fecha_analisis|date:"d/m/Y H:i" }}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-minus"></i>
                                            No analizada
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if reconsideracion.estado == 'aprobada' %}badge-success
                                        {% elif reconsideracion.estado == 'rechazada' %}badge-danger
                                        {% elif reconsideracion.estado == 'enviada_comite' %}badge-warning
                                        {% elif reconsideracion.estado == 'en_revision' %}badge-info
                                        {% else %}badge-secondary
                                        {% endif %}">
                                        {% if reconsideracion.estado == 'aprobada' %}
                                            <i class="fas fa-check"></i> Aprobada
                                        {% elif reconsideracion.estado == 'rechazada' %}
                                            <i class="fas fa-times"></i> Rechazada
                                        {% elif reconsideracion.estado == 'enviada_comite' %}
                                            <i class="fas fa-users"></i> Enviada a Comité
                                        {% elif reconsideracion.estado == 'en_revision' %}
                                            <i class="fas fa-search"></i> En Revisión
                                        {% else %}
                                            <i class="fas fa-paper-plane"></i> {{ reconsideracion.get_estado_display }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    {% if reconsideracion.comentario_analisis %}
                                        <div class="comentario-preview" style="max-width: 250px;">
                                            {% if reconsideracion.comentario_analisis|length > 150 %}
                                                <span>{{ reconsideracion.comentario_analisis|truncatewords:20 }}</span>
                                                <br>
                                                <a href="#" onclick="mostrarComentarioCompleto('{{ reconsideracion.comentario_analisis|escapejs }}')" class="btn btn-sm btn-outline-info mt-1">
                                                    <i class="fas fa-expand-alt"></i>
                                                    Ver análisis completo
                                                </a>
                                            {% else %}
                                                <span>{{ reconsideracion.comentario_analisis }}</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-comment-slash"></i>
                                            Sin comentarios
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
            
    <!-- Análisis anterior -->
    <div class="resultado-anterior-section">
        <div class="resultado-header">
            <i class="fas fa-history"></i>
            <h5 class="mb-0">Resultado de Consulta Anterior</h5>
        </div>
        <div class="resultado-content">
            <div class="alert alert-warning mb-3">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Resultado:</strong> {{ reconsideracion_actual.resultado_consulta_anterior }}
            </div>
            {% if reconsideracion_actual.comentario_consulta_anterior %}
            <div class="comentario-analisis-anterior">
                <h6>
                    <i class="fas fa-user-tie"></i>
                    Comentario del Analista Anterior:
                </h6>
                <p>{{ reconsideracion_actual.comentario_consulta_anterior }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Archivo Adjunto -->
    {% if reconsideracion_actual.archivo_adjunto %}
    <div class="archivo-adjunto-section">
        <div class="archivo-header">
            <i class="fas fa-file-pdf"></i>
            <h5 class="mb-0">Archivo Adjunto</h5>
        </div>
        <div class="archivo-content">
            <div class="archivo-item">
                <div class="archivo-info">
                    <div class="archivo-icon">
                        <i class="fas fa-file-pdf text-danger"></i>
                    </div>
                    <div class="archivo-details">
                        <div class="archivo-name">
                            {{ reconsideracion_actual.archivo_adjunto.name|default:"archivo.pdf" }}
                        </div>
                        <div class="archivo-size">
                            {% if reconsideracion_actual.archivo_adjunto.size %}
                                {{ reconsideracion_actual.archivo_adjunto.size|filesizeformat }}
                            {% endif %}
                        </div>
                        <div class="archivo-fecha">
                            <i class="fas fa-clock text-muted"></i>
                            Adjuntado el {{ reconsideracion_actual.fecha_solicitud|date:"d/m/Y H:i" }}
                        </div>
                    </div>
                </div>
                <div class="archivo-actions">
                    <a href="{{ reconsideracion_actual.archivo_adjunto.url }}" 
                       target="_blank" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>Ver
                    </a>
                    <a href="{{ reconsideracion_actual.archivo_adjunto.url }}" 
                       download 
                       class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-download me-1"></i>Descargar
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
            
    <!-- Formulario de decisión -->
    <div class="decision-section">
        <div class="decision-header">
            <i class="fas fa-gavel"></i>
            <h5 class="mb-0">Decisión de Reconsideración</h5>
        </div>
        <div class="decision-content">
            <form id="form-decision">
                {% csrf_token %}
                <div class="form-group">
                    <label for="comentario_analisis">
                        <i class="fas fa-pen-fancy"></i>
                        Comentario del Análisis
                    </label>
                    <textarea 
                        class="form-control" 
                        id="comentario_analisis" 
                        name="comentario_analisis" 
                        rows="5" 
                        required
                        placeholder="Ingrese su análisis detallado de la reconsideración. Considere todos los aspectos relevantes, cambios en las condiciones, y justifique su decisión..."></textarea>
                    <small class="form-text text-muted">
                        <i class="fas fa-info-circle"></i>
                        Mínimo 20 caracteres requeridos. Sea específico y detallado en su análisis.
                    </small>
                </div>
                        
                <div class="decision-buttons">
                    <button type="button" class="btn-decision btn-aprobar" data-decision="aprobar">
                        <i class="fas fa-check-circle"></i>
                        <strong>Aprobar</strong>
                        <small>Aceptar la reconsideración y proceder con la nueva condición</small>
                    </button>
                    <button type="button" class="btn-decision btn-rechazar" data-decision="rechazar">
                        <i class="fas fa-times-circle"></i>
                        <strong>Rechazar</strong>
                        <small>Mantener la decisión anterior y rechazar la reconsideración</small>
                    </button>
                    <button type="button" class="btn-decision btn-comite" data-decision="enviar_comite">
                        <i class="fas fa-users-cog"></i>
                        <strong>Enviar a Comité</strong>
                        <small>Escalar la decisión al comité de crédito para evaluación</small>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmación -->
<div class="modal fade" id="modalConfirmarDecision" tabindex="-1" aria-labelledby="modalConfirmarDecisionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalConfirmarDecisionLabel">
                    <i class="fas fa-question-circle"></i>
                    Confirmar Decisión
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4">
                <div class="text-center mb-3">
                    <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                </div>
                <p id="mensaje-confirmacion" class="text-center lead"></p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Recuerde:</strong> Esta acción no se puede deshacer. Asegúrese de que su análisis sea completo y correcto.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btn-confirmar">
                    <i class="fas fa-check"></i>
                    Confirmar Decisión
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    const solicitudId = {{ solicitud.id }};
    const csrfToken = '{{ csrf_token }}';
    
    // Template data for enhanced display
    const templateData = {
        solicitud: {
            codigo: '{{ solicitud.codigo|escapejs }}',
            cliente_nombre_completo: '{{ solicitud.cliente_nombre_completo|default:""|escapejs }}',
            pipeline_nombre: '{{ solicitud.pipeline.nombre|escapejs }}',
            etapa_actual: '{{ solicitud.etapa_actual.nombre|default:""|escapejs }}',
            propietario: '{{ solicitud.propietario.get_full_name|default:solicitud.propietario.username|escapejs }}',
            fecha_creacion: '{{ solicitud.fecha_creacion|date:"d/m/Y" }}',
            prioridad: '{{ solicitud.prioridad|default:""|escapejs }}',
            cotizacion_id: '{{ solicitud.cotizacion.id|default:"" }}',
            cotizacion: {
                tipoPrestamo: '{{ solicitud.cotizacion.tipoPrestamo|default:""|escapejs }}',
                montoPrestamo: '{{ solicitud.cotizacion.montoPrestamo|default:"0"|floatformat:2 }}',
                plazo: '{{ solicitud.cotizacion.plazo|default:""|escapejs }}',
                marcaVehiculo: '{{ solicitud.cotizacion.marcaVehiculo|default:""|escapejs }}',
                modeloVehiculo: '{{ solicitud.cotizacion.modeloVehiculo|default:""|escapejs }}',
                anoVehiculo: '{{ solicitud.cotizacion.anoVehiculo|default:""|escapejs }}'
            }
        }
    };
    
    // Enhanced section toggle functionality
    function toggleSection(headerElement) {
        const contentElement = headerElement.nextElementSibling;
        const isCollapsed = headerElement.classList.contains('collapsed');
        
        if (isCollapsed) {
            // Expand
            contentElement.classList.remove('collapsed');
            headerElement.classList.remove('collapsed');
            // Add smooth animation
            contentElement.style.maxHeight = contentElement.scrollHeight + 'px';
        } else {
            // Collapse
            contentElement.style.maxHeight = '0';
            headerElement.classList.add('collapsed');
            setTimeout(() => {
                contentElement.classList.add('collapsed');
            }, 300);
        }
    }
    
    // Initialize page on load
    document.addEventListener('DOMContentLoaded', function() {
        // Load all sections
        loadClienteInfo();
        loadSolicitudDetalle();
        loadVehiculoDatos();
        loadAdjuntos();
        
        // Initialize decision handlers
        initializeDecisionHandlers();
        
        // Initialize tooltips and other UI enhancements
        initializeUIEnhancements();
    });
    
    // Enhanced cliente information loading with compliance status
    async function loadClienteInfo() {
        try {
            const container = document.getElementById('cliente-info-container');
            
            // Fetch client compliance data
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`);
            const responseData = response.ok ? await response.json() : { calificaciones: [] };
            const calificaciones = responseData.calificaciones || [];
            
            // Helper function to get compliance badge
            function getComplianceBadge(campo, calificaciones) {
                const calificacion = calificaciones.find(c => c.campo === campo);
                if (!calificacion) {
                    return '<span class="status-badge status-sin_calificar" title="Sin calificar"><i class="fas fa-question"></i></span>';
                }
                
                const iconMap = {
                    'bueno': 'fa-check',
                    'malo': 'fa-times',
                    'sin_calificar': 'fa-question'
                };
                
                const icon = iconMap[calificacion.estado] || 'fa-question';
                return `<span class="status-badge status-${calificacion.estado}" title="${calificacion.comentario || calificacion.estado}"><i class="fas ${icon}"></i></span>`;
            }
            
            // Create enhanced client info display with compliance badges
            container.innerHTML = `
                <div class="info-row-with-status">
                    <div class="info-data">
                        <div class="info-label"><i class="fas fa-user"></i> Cliente</div>
                        <div class="info-value">${templateData.solicitud.cliente_nombre_completo || 'No especificado'}</div>
                    </div>
                    <div class="compliance-status">
                        ${getComplianceBadge('cliente_nombre', calificaciones)}
                    </div>
                </div>
                <div class="info-row-with-status">
                    <div class="info-data">
                        <div class="info-label"><i class="fas fa-id-card"></i> Cédula</div>
                        <div class="info-value">${templateData.solicitud.cotizacion.cedulaCliente || 'No especificado'}</div>
                    </div>
                    <div class="compliance-status">
                        ${getComplianceBadge('cedula_cliente', calificaciones)}
                    </div>
                </div>
                <div class="info-row-with-status">
                    <div class="info-data">
                        <div class="info-label"><i class="fas fa-phone"></i> Teléfono</div>
                        <div class="info-value">${templateData.solicitud.cotizacion.telefonos || 'No especificado'}</div>
                    </div>
                    <div class="compliance-status">
                        ${getComplianceBadge('telefono', calificaciones)}
                    </div>
                </div>
                <div class="info-row-with-status">
                    <div class="info-data">
                        <div class="info-label"><i class="fas fa-envelope"></i> Email</div>
                        <div class="info-value">${templateData.solicitud.cotizacion.email || 'No especificado'}</div>
                    </div>
                    <div class="compliance-status">
                        ${getComplianceBadge('email', calificaciones)}
                    </div>
                </div>
                <div class="alert alert-info mb-0 mt-2">
                    <i class="fas fa-info-circle"></i>
                    <small>Los marcadores indican la validación de compliance realizada durante el análisis anterior.</small>
                </div>
            `;
        } catch (error) {
            console.error('Error loading cliente info:', error);
            showErrorMessage('cliente-info-container', 'Error al cargar información del cliente');
        }
    }
    
    // Enhanced solicitud details loading with compliance status
    async function loadSolicitudDetalle() {
        try {
            const container = document.getElementById('solicitud-detalle-container');
            const solicitud = templateData.solicitud;
            
            // Fetch compliance data
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`);
            const responseData = response.ok ? await response.json() : { calificaciones: [] };
            const calificaciones = responseData.calificaciones || [];
            
            // Helper function to get compliance badge
            function getComplianceBadge(campo, calificaciones) {
                const calificacion = calificaciones.find(c => c.campo === campo);
                if (!calificacion) {
                    return '<span class="status-badge status-sin_calificar" title="Sin calificar"><i class="fas fa-question"></i></span>';
                }
                
                const iconMap = {
                    'bueno': 'fa-check',
                    'malo': 'fa-times',
                    'sin_calificar': 'fa-question'
                };
                
                const icon = iconMap[calificacion.estado] || 'fa-question';
                return `<span class="status-badge status-${calificacion.estado}" title="${calificacion.comentario || calificacion.estado}"><i class="fas ${icon}"></i></span>`;
            }
            
            container.innerHTML = `
                <div class="info-row-with-status">
                    <div class="info-data">
                        <div class="info-label"><i class="fas fa-hashtag"></i> Código</div>
                        <div class="info-value">${solicitud.codigo}</div>
                    </div>
                    <div class="compliance-status">
                        ${getComplianceBadge('codigo_solicitud', calificaciones)}
                    </div>
                </div>
                <div class="info-row-with-status">
                    <div class="info-data">
                        <div class="info-label"><i class="fas fa-dollar-sign"></i> Monto Préstamo</div>
                        <div class="info-value">B/. ${parseFloat(solicitud.cotizacion.montoPrestamo || 0).toFixed(2)}</div>
                    </div>
                    <div class="compliance-status">
                        ${getComplianceBadge('monto_prestamo', calificaciones)}
                    </div>
                </div>
                <div class="info-row-with-status">
                    <div class="info-data">
                        <div class="info-label"><i class="fas fa-calendar-alt"></i> Plazo</div>
                        <div class="info-value">${solicitud.cotizacion.plazo || 0} meses</div>
                    </div>
                    <div class="compliance-status">
                        ${getComplianceBadge('plazo', calificaciones)}
                    </div>
                </div>
                <div class="info-row-with-status">
                    <div class="info-data">
                        <div class="info-label"><i class="fas fa-percentage"></i> Tasa</div>
                        <div class="info-value">${parseFloat(solicitud.cotizacion.tasaInteres || 0).toFixed(2)}%</div>
                    </div>
                    <div class="compliance-status">
                        ${getComplianceBadge('tasa_interes', calificaciones)}
                    </div>
                </div>
                <div class="info-row-with-status">
                    <div class="info-data">
                        <div class="info-label"><i class="fas fa-receipt"></i> Cuota Mensual</div>
                        <div class="info-value">B/. ${parseFloat(solicitud.cotizacion.cuotaMensual || 0).toFixed(2)}</div>
                    </div>
                    <div class="compliance-status">
                        ${getComplianceBadge('cuota_mensual', calificaciones)}
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading solicitud details:', error);
            showErrorMessage('solicitud-detalle-container', 'Error al cargar detalle de la solicitud');
        }
    }
    
    // Enhanced vehiculo data loading with compliance status
    async function loadVehiculoDatos() {
        try {
            const container = document.getElementById('vehiculo-datos-container');
            const cotizacion = templateData.solicitud.cotizacion;
            
            // Fetch compliance data
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`);
            const responseData = response.ok ? await response.json() : { calificaciones: [] };
            const calificaciones = responseData.calificaciones || [];
            
            // Helper function to get compliance badge
            function getComplianceBadge(campo, calificaciones) {
                const calificacion = calificaciones.find(c => c.campo === campo);
                if (!calificacion) {
                    return '<span class="status-badge status-sin_calificar" title="Sin calificar"><i class="fas fa-question"></i></span>';
                }
                
                const iconMap = {
                    'bueno': 'fa-check',
                    'malo': 'fa-times',
                    'sin_calificar': 'fa-question'
                };
                
                const icon = iconMap[calificacion.estado] || 'fa-question';
                return `<span class="status-badge status-${calificacion.estado}" title="${calificacion.comentario || calificacion.estado}"><i class="fas ${icon}"></i></span>`;
            }
            
            if (templateData.solicitud.cotizacion_id) {
                container.innerHTML = `
                    <div class="info-row-with-status">
                        <div class="info-data">
                            <div class="info-label"><i class="fas fa-tag"></i> Tipo Préstamo</div>
                            <div class="info-value">${cotizacion.tipoPrestamo || 'No especificado'}</div>
                        </div>
                        <div class="compliance-status">
                            ${getComplianceBadge('tipo_prestamo', calificaciones)}
                        </div>
                    </div>
                    <div class="info-row-with-status">
                        <div class="info-data">
                            <div class="info-label"><i class="fas fa-industry"></i> Marca</div>
                            <div class="info-value">${cotizacion.marcaVehiculo || 'No especificado'}</div>
                        </div>
                        <div class="compliance-status">
                            ${getComplianceBadge('marca_vehiculo', calificaciones)}
                        </div>
                    </div>
                    <div class="info-row-with-status">
                        <div class="info-data">
                            <div class="info-label"><i class="fas fa-car"></i> Modelo</div>
                            <div class="info-value">${cotizacion.modeloVehiculo || 'No especificado'}</div>
                        </div>
                        <div class="compliance-status">
                            ${getComplianceBadge('modelo_vehiculo', calificaciones)}
                        </div>
                    </div>
                    <div class="info-row-with-status">
                        <div class="info-data">
                            <div class="info-label"><i class="fas fa-calendar-alt"></i> Año</div>
                            <div class="info-value">${cotizacion.anoVehiculo || 'No especificado'}</div>
                        </div>
                        <div class="compliance-status">
                            ${getComplianceBadge('ano_vehiculo', calificaciones)}
                        </div>
                    </div>
                    <div class="info-row-with-status">
                        <div class="info-data">
                            <div class="info-label"><i class="fas fa-dollar-sign"></i> Valor</div>
                            <div class="info-value">B/. ${parseFloat(cotizacion.valorVehiculo || 0).toFixed(2)}</div>
                        </div>
                        <div class="compliance-status">
                            ${getComplianceBadge('valor_vehiculo', calificaciones)}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i>
                        <div class="mt-2">
                            <strong>Sin Cotización</strong><br>
                            <small>No hay información de cotización o vehículo disponible para esta solicitud.</small>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading vehiculo data:', error);
            showErrorMessage('vehiculo-datos-container', 'Error al cargar datos del vehículo');
        }
    }
    
    // Enhanced adjuntos loading with compliance status
    async function loadAdjuntos() {
        try {
            const container = document.getElementById('adjuntos-container');
            
            // Fetch compliance data for documents
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`);
            const responseData = response.ok ? await response.json() : { calificaciones: [] };
            const calificaciones = responseData.calificaciones || [];
            
            // Helper function to get compliance badge
            function getComplianceBadge(campo, calificaciones) {
                const calificacion = calificaciones.find(c => c.campo === campo);
                if (!calificacion) {
                    return '<span class="status-badge status-sin_calificar" title="Sin calificar"><i class="fas fa-question"></i></span>';
                }
                
                const iconMap = {
                    'bueno': 'fa-check',
                    'malo': 'fa-times',
                    'sin_calificar': 'fa-question'
                };
                
                const icon = iconMap[calificacion.estado] || 'fa-question';
                return `<span class="status-badge status-${calificacion.estado}" title="${calificacion.comentario || calificacion.estado}"><i class="fas ${icon}"></i></span>`;
            }
            
            // Common document fields for compliance checking
            const documentFields = [
                { campo: 'cedula_doc', label: 'Cédula de Identidad', icon: 'fa-id-card' },
                { campo: 'colilla_pago', label: 'Colilla de Pago', icon: 'fa-receipt' },
                { campo: 'carta_trabajo', label: 'Carta de Trabajo', icon: 'fa-briefcase' },
                { campo: 'referencias_comerciales', label: 'Referencias Comerciales', icon: 'fa-handshake' },
                { campo: 'evaluacion_vehiculo', label: 'Evaluación de Vehículo', icon: 'fa-car' },
                { campo: 'poliza_seguro', label: 'Póliza de Seguro', icon: 'fa-shield-alt' }
            ];
            
            let documentsHTML = documentFields.map(field => `
                <div class="info-row-with-status">
                    <div class="info-data">
                        <div class="info-label"><i class="fas ${field.icon}"></i> ${field.label}</div>
                        <div class="info-value">Ver en expediente</div>
                    </div>
                    <div class="compliance-status">
                        ${getComplianceBadge(field.campo, calificaciones)}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `
                ${documentsHTML}
                <div class="alert alert-info mb-0 mt-3">
                    <i class="fas fa-info-circle"></i>
                    <div class="mt-2">
                        <strong>Documentos Adjuntos</strong><br>
                        <small>Los marcadores muestran la validación de compliance de cada documento. Para ver los archivos, acceda al expediente completo.</small>
                    </div>
                </div>
                <div class="d-grid gap-2 mt-2">
                    <a href="/workflow/solicitud/${solicitudId}/" class="btn btn-outline-primary btn-sm" target="_blank">
                        <i class="fas fa-external-link-alt"></i>
                        Ver Expediente Completo
                    </a>
                </div>
            `;
            
        } catch (error) {
            console.error('Error loading adjuntos:', error);
            showErrorMessage('adjuntos-container', 'Error al cargar documentos adjuntos');
        }
    }
    
    // Function to refresh adjuntos
    function refreshAdjuntos() {
        const container = document.getElementById('adjuntos-container');
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin"></i>
                <div class="mt-2">Recargando documentos...</div>
            </div>
        `;
        
        setTimeout(() => {
            loadAdjuntos();
        }, 1000);
    }
    
    // Helper function to show error messages
    function showErrorMessage(containerId, message) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
            <div class="alert alert-warning mb-0">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="mt-2">
                    <strong>Error de Carga</strong><br>
                    <small>${message}</small>
                </div>
            </div>
        `;
    }
    
    // Enhanced comment modal function
    function mostrarComentarioCompleto(comentario) {
        const existingModal = document.getElementById('modalComentarioCompleto');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modalHTML = `
            <div class="modal fade" id="modalComentarioCompleto" tabindex="-1" aria-labelledby="modalComentarioCompletoLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title" id="modalComentarioCompletoLabel">
                                <i class="fas fa-comment-dots"></i>
                                Comentario Completo
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="comentario-completo-container">
                                <div class="comentario-text p-3 bg-light rounded">
                                    ${escapeHtml(comentario)}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i>
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        const modal = new bootstrap.Modal(document.getElementById('modalComentarioCompleto'));
        modal.show();
        
        // Clean up when closed
        document.getElementById('modalComentarioCompleto').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }
    
    // Enhanced decision handling
    let decisionSeleccionada = null;
    
    function initializeDecisionHandlers() {
        document.querySelectorAll('.btn-decision').forEach(button => {
            button.addEventListener('click', function() {
                const decision = this.getAttribute('data-decision');
                const comentarioInput = document.getElementById('comentario_analisis');
                const comentario = comentarioInput.value.trim();
                
                // Enhanced validation
                if (!comentario) {
                    showNotification('Debe ingresar un comentario antes de tomar una decisión.', 'error');
                    comentarioInput.focus();
                    return;
                }
                
                if (comentario.length < 20) {
                    showNotification('El comentario debe tener al menos 20 caracteres.', 'warning');
                    comentarioInput.focus();
                    return;
                }
                
                if (comentario.length > 2000) {
                    showNotification('El comentario no puede exceder los 2000 caracteres.', 'warning');
                    comentarioInput.focus();
                    return;
                }
                
                decisionSeleccionada = decision;
                showConfirmationModal(decision);
            });
        });
    }
    
    // Enhanced confirmation modal
    function showConfirmationModal(decision) {
        let mensaje = '';
        let btnClass = 'btn-primary';
        
        switch(decision) {
            case 'aprobar':
                mensaje = '¿Está completamente seguro de que desea APROBAR esta reconsideración? Esta acción permitirá que la solicitud continúe con las nuevas condiciones.';
                btnClass = 'btn-success';
                break;
            case 'rechazar':
                mensaje = '¿Está completamente seguro de que desea RECHAZAR esta reconsideración? Se mantendrá la decisión anterior y se cerrará el proceso.';
                btnClass = 'btn-danger';
                break;
            case 'enviar_comite':
                mensaje = '¿Está seguro de que desea ENVIAR AL COMITÉ esta reconsideración? La decisión final será tomada por el comité de crédito.';
                btnClass = 'btn-warning';
                break;
        }
        
        document.getElementById('mensaje-confirmacion').textContent = mensaje;
        const btnConfirmar = document.getElementById('btn-confirmar');
        btnConfirmar.className = 'btn ' + btnClass;
        
        const modal = new bootstrap.Modal(document.getElementById('modalConfirmarDecision'));
        modal.show();
    }
    
    // Initialize confirmation handler
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('btn-confirmar').addEventListener('click', function() {
            if (!decisionSeleccionada) return;
            
            const comentario = document.getElementById('comentario_analisis').value.trim();
            const button = this;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            
            // Prepare form data
            const formData = new FormData();
            formData.append('decision', decisionSeleccionada);
            formData.append('comentario', comentario);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Send decision
            fetch(`{% url 'workflow:api_procesar_reconsideracion_analista' solicitud.id %}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarDecision'));
                    modal.hide();
                    
                    showNotification('Decisión procesada exitosamente. Redirigiendo...', 'success');
                    
                    // Redirect to vista mixta after short delay
                    setTimeout(() => {
                        window.location.href = data.redirect_url || "{% url 'workflow:vista_mixta_bandejas' %}";
                    }, 2000);
                } else {
                    showNotification('Error: ' + (data.error || 'Error desconocido'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error procesando reconsideración: ' + error.message, 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check"></i> Confirmar Decisión';
            });
        });
        
        // Reset modal on close
        document.getElementById('modalConfirmarDecision').addEventListener('hidden.bs.modal', function() {
            decisionSeleccionada = null;
            const button = document.getElementById('btn-confirmar');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check"></i> Confirmar Decisión';
            button.className = 'btn btn-primary';
        });
    });
    
    // Enhanced notification system
    function showNotification(message, type = 'info') {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.notification-toast');
        existingNotifications.forEach(notification => notification.remove());
        
        const typeClasses = {
            'success': 'bg-success text-white',
            'error': 'bg-danger text-white',
            'warning': 'bg-warning text-dark',
            'info': 'bg-info text-white'
        };
        
        const icons = {
            'success': 'fas fa-check-circle',
            'error': 'fas fa-exclamation-circle',
            'warning': 'fas fa-exclamation-triangle',
            'info': 'fas fa-info-circle'
        };
        
        const toast = document.createElement('div');
        toast.className = `notification-toast alert ${typeClasses[type]} alert-dismissible position-fixed`;
        toast.style.cssText = `
            top: 80px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none;
            border-radius: 8px;
        `;
        
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="${icons[type]} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }
    
    // UI enhancements initialization
    function initializeUIEnhancements() {
        // Add hover effects to interactive elements
        document.querySelectorAll('.btn-decision').forEach(button => {
            button.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px) scale(1.02)';
            });
            
            button.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });
        
        // Initialize character counter for textarea
        const textarea = document.getElementById('comentario_analisis');
        const maxLength = 2000;
        
        // Create character counter
        const counter = document.createElement('div');
        counter.className = 'text-muted small mt-1';
        counter.innerHTML = `<i class="fas fa-keyboard"></i> 0/${maxLength} caracteres`;
        textarea.parentNode.appendChild(counter);
        
        textarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            counter.innerHTML = `<i class="fas fa-keyboard"></i> ${currentLength}/${maxLength} caracteres`;
            
            if (currentLength < 20) {
                counter.className = 'text-danger small mt-1';
            } else if (currentLength > maxLength * 0.9) {
                counter.className = 'text-warning small mt-1';
            } else {
                counter.className = 'text-success small mt-1';
            }
        });
    }
    
    // Helper function for HTML escaping
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Add smooth scrolling to sections
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
</script>
{% endblock %}
