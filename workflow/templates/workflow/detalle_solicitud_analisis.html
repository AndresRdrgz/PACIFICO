{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}Análisis de Solicitud - {{ solicitud.codigo }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header de la Solicitud -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header" style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <a href="{% url 'workflow:vista_mixta_bandejas' %}" class="btn btn-light btn-sm">
                                <i class="fas fa-arrow-left me-1"></i>Volver a Bandejas
                            </a>
                            <div>
                                <h2 class="mb-1">
                                    <i class="fas fa-microscope me-2"></i>
                                    Análisis de Solicitud: {{ solicitud.codigo }}
                                </h2>
                                <p class="mb-0 opacity-75">
                                    <i class="fas fa-user me-1"></i>
                                    {{ solicitud.cliente_nombre|default:"Sin cliente" }} 
                                    {% if solicitud.cliente_cedula %}
                                        - {{ solicitud.cliente_cedula }}
                                    {% endif %}

                                    <span class="ms-3">
                                        <i class="fas fa-calendar me-1"></i>
                                        <span id="fecha-actual">--/--/----</span>
                                    </span>
                                    {% if solicitud.fecha_creacion %}
                                    <span class="ms-3">
                                        <i class="fas fa-history me-1"></i>
                                        Creada: {{ solicitud.fecha_creacion|date:"d/m/Y H:i" }}
                                    </span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownTransiciones" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-arrow-right me-1"></i>Cambiar Etapa
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownTransiciones">
                                {% if transiciones_disponibles %}
                                    {% for transicion_data in transiciones_disponibles %}
                                        {% with transicion=transicion_data.transicion %}
                                        <li>
                                            <a class="dropdown-item {% if not transicion_data.puede_realizar %}disabled text-muted{% endif %}" 
                                               href="#" 
                                               onclick="if(typeof realizarTransicion === 'function') { realizarTransicion({{ transicion.etapa_destino.id }}, '{{ transicion.etapa_destino.nombre|escapejs }}', {{ transicion_data.puede_realizar|yesno:'true,false' }}, {{ transicion_data.total_requisitos_faltantes }}); } else { console.error('realizarTransicion no está definido'); alert('Error: Función no disponible. Por favor recarga la página.'); }"
                                               {% if not transicion_data.puede_realizar %}title="Faltan {{ transicion_data.total_requisitos_faltantes }} requisito(s) obligatorio(s)"{% endif %}>
                                                <i class="fas fa-arrow-right me-2"></i>
                                                <strong>{{ transicion.etapa_destino.nombre }}</strong>
                                                {% if not transicion_data.puede_realizar %}
                                                    <span class="badge bg-warning text-dark ms-2">{{ transicion_data.total_requisitos_faltantes }}</span>
                                                {% endif %}
                                                <br>
                                                <small class="text-muted">{{ transicion.nombre }}</small>
                                            </a>
                                        </li>
                                        {% endwith %}
                                    {% endfor %}
                                {% else %}
                                    <li><span class="dropdown-item-text text-muted">No hay transiciones disponibles</span></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- LAYOUT PRINCIPAL: RESUMEN COMPLETO (4/6) + ADJUNTOS (2/6) -->
    <div class="row mb-4">
        <div class="col-8">
            <div class="unified-info-card">
                <div class="unified-header">
                    <div class="unified-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="unified-title">
                        <h3>Resumen Completo de la Solicitud</h3>
                    </div>
                    <div class="unified-sla">
                        <div class="sla-badge sla-{% if sla_info.estado == 'vencido' %}danger{% elif sla_info.estado == 'por_vencer' %}warning{% elif sla_info.estado == 'en_tiempo' %}success{% else %}muted{% endif %}">
                            {% if sla_info.estado == 'vencido' %}
                                <i class="fas fa-exclamation-triangle me-1"></i>Vencido
                                <span class="ms-2" id="reloj-tiempo-real" style="font-family: monospace; color: #dc3545; font-weight: bold;">--:--:--</span>
                            {% elif sla_info.estado == 'por_vencer' %}
                                <i class="fas fa-hourglass-half me-1"></i>Por Vencer
                                <span class="ms-2" id="reloj-tiempo-real" style="font-family: monospace; color: #fd7e14; font-weight: bold;">--:--:--</span>
                            {% elif sla_info.estado == 'en_tiempo' %}
                                <i class="fas fa-check-circle me-1"></i>En Tiempo
                                <span class="ms-2" id="reloj-tiempo-real" style="font-family: monospace; color: #198754; font-weight: bold;">--:--:--</span>
                                {% if sla_info.tiempo_restante_formateado %}
                                    - {{ sla_info.tiempo_restante_formateado }}
                                {% endif %}
                            {% else %}
                                <i class="fas fa-question-circle me-1"></i>Sin SLA
                                <span class="ms-2" id="reloj-tiempo-real" style="font-family: monospace; color: #6c757d; font-weight: bold;">--:--:--</span>
                            {% endif %}
                        </div>
                        <button class="btn btn-light btn-sm ms-2" onclick="marcarTodosComoBueno()">
                            <i class="fas fa-check-double me-1"></i>Marcar Todos como Bueno
                        </button>
                    </div>
                </div>
                
                <div class="unified-body">
                    <div class="row g-3">
                        <!-- 1. Información de Cliente -->
                        <div class="col-md-4">
                            <div class="info-section">
                                <div class="section-header">
                                    <i class="fas fa-user text-info"></i>
                                    <h5>Información de Cliente</h5>
                                </div>
                                <div class="section-content">
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Empresa Privada:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.nombreEmpresa|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="empresa_privada" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="empresa_privada" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="empresa_privada" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Cargo:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.posicion|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="cargo" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="cargo" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="cargo" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">T/S:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.tiempoServicio|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="tiempo_servicio" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="tiempo_servicio" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="tiempo_servicio" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Salario:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.salarioBaseMensual %}
                                                    B/. {{ solicitud.cotizacion.salarioBaseMensual|floatformat:2 }}
                                                {% elif solicitud.cotizacion.ingresos %}
                                                    B/. {{ solicitud.cotizacion.ingresos|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="salario" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="salario" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="salario" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Score:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.apcScore|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="score" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="score" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="score" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 2. Detalle de la Solicitud -->
                        <div class="col-md-4">
                            <div class="info-section">
                                <div class="section-header">
                                    <i class="fas fa-calculator text-primary"></i>
                                    <h5>Detalle de la Solicitud</h5>
                                </div>
                                <div class="section-content">
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Valor del equipo:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.valorAuto %}
                                                    B/. {{ solicitud.cotizacion.valorAuto|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="valor_equipo" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="valor_equipo" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="valor_equipo" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Abono:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.abono and solicitud.cotizacion.abonoPorcentaje %}
                                                    B/. {{ solicitud.cotizacion.abono|floatformat:2 }} ({{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%)
                                                {% elif solicitud.cotizacion.abono %}
                                                    B/. {{ solicitud.cotizacion.abono|floatformat:2 }}
                                                {% elif solicitud.cotizacion.abonoPorcentaje %}
                                                    {{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="abono" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="abono" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="abono" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Monto financiado:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.montoPrestamo %}
                                                    B/. {{ solicitud.cotizacion.montoPrestamo|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="monto_financiado" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="monto_financiado" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="monto_financiado" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Plazo:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.plazoPago %}
                                                    {{ solicitud.cotizacion.plazoPago }} meses
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="plazo" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="plazo" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="plazo" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Rentabilidad:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.r_deseada %}
                                                    {{ solicitud.cotizacion.r_deseada|floatformat:2 }}%
                                                {% elif solicitud.cotizacion.r1 %}
                                                    {{ solicitud.cotizacion.r1|floatformat:2 }}%
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="rentabilidad" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="rentabilidad" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="rentabilidad" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Total de letra c/seg:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.wrkMontoLetra %}
                                                    B/. {{ solicitud.cotizacion.wrkMontoLetra|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="total_letra" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="total_letra" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="total_letra" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Sector:</span>
                                            <span class="info-value">-</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="sector" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="sector" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="sector" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 3. Datos del Vehículo -->
                        <div class="col-md-4">
                            <div class="info-section">
                                <div class="section-header">
                                    <i class="fas fa-car text-warning"></i>
                                    <h5>Datos del Vehículo</h5>
                                </div>
                                <div class="section-content">
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Marca:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.marca|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="marca" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="marca" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="marca" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Modelo:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.modelo|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="modelo" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="modelo" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="modelo" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Año:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.yearCarro|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="año" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="año" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="año" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Transmisión:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.transmisionAuto|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="transmision" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="transmision" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="transmision" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">KM:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.kilometrajeAuto %}
                                                    {{ solicitud.cotizacion.kilometrajeAuto|floatformat:0 }} km
                                                {% else %}
                                                    0 km
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="kilometraje" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="kilometraje" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="kilometraje" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Política:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.aseguradora %}
                                                    {{ solicitud.cotizacion.aseguradora }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="politica" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="politica" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="politica" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ADJUNTOS ASOCIADOS (2/6 del ancho) -->
        <div class="col-4">
            <div class="adjuntos-container">
                <div class="adjuntos-header">
                    <div class="adjuntos-icon">
                        <i class="fas fa-paperclip"></i>
                    </div>
                    <div class="adjuntos-title">
                        <h5>Adjuntos</h5>
                        <small>Asociados a la solicitud</small>
                    </div>
                    {% if solicitud.requisitos.all %}
                        {% with requisitos_con_archivos=solicitud.requisitos.all|length %}
                            {% if requisitos_con_archivos > 0 %}
                                <div class="adjuntos-actions">
                                    <button type="button" class="btn btn-success btn-sm" id="btn-download-merged-pdf" title="Descargar todos los documentos en un solo PDF">
                                        <i class="fas fa-download me-1"></i>PDF Completo
                                        <span class="badge bg-light text-dark ms-1">{{ requisitos_con_archivos }}</span>
                                    </button>
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                </div>
                <div class="adjuntos-content">
                    {% if solicitud.requisitos.all %}
                        {% for requisito_solicitud in solicitud.requisitos.all %}
                            <div class="adjunto-item">
                                <div class="adjunto-icon">
                                    {% if requisito_solicitud.archivo %}
                                        <i class="fas fa-file-pdf text-danger"></i>
                                    {% else %}
                                        <i class="fas fa-file-alt text-secondary"></i>
                                    {% endif %}
                                </div>
                                <div class="adjunto-details">
                                    <div class="adjunto-name">{{ requisito_solicitud.requisito.nombre }}</div>
                                    <div class="adjunto-status-line">
                                        <div class="adjunto-status-group">
                                            <div class="adjunto-status">
                                                {% if requisito_solicitud.cumplido %}
                                                    <span class="badge bg-success">Cumplido</span>
                                                {% else %}
                                                    <span class="badge bg-warning">Pendiente</span>
                                                {% endif %}
                                            </div>
                                            {% if requisito_solicitud.archivo %}
                                                <a href="{{ requisito_solicitud.archivo.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="doc_{{ requisito_solicitud.id }}" data-action="bueno" title="Documento válido">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="doc_{{ requisito_solicitud.id }}" data-action="malo" title="Documento inválido">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="doc_{{ requisito_solicitud.id }}" data-action="comentario" title="Comentar documento">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-light text-center">
                            <i class="fas fa-inbox me-2"></i>
                            <small>Sin adjuntos disponibles</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>



    <!-- FLUJO DEL PROCESO - Ancho completo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="compact-timeline-section">
                <div class="timeline-header">
                    <h5><i class="fas fa-route me-2"></i>Flujo del Proceso</h5>
                </div>
                <div class="slim-timeline">
                    {% for etapa in etapas_pipeline %}
                    <div class="timeline-step {% if etapa.orden < solicitud.etapa_actual.orden %}completed{% elif etapa == solicitud.etapa_actual %}active{% else %}pending{% endif %}">
                        <div class="step-dot">
                            {% if etapa.orden < solicitud.etapa_actual.orden %}
                                <i class="fas fa-check"></i>
                            {% elif etapa == solicitud.etapa_actual %}
                                <i class="fas fa-clock"></i>
                            {% else %}
                                <i class="fas fa-circle"></i>
                            {% endif %}
                        </div>
                        <div class="step-label">
                            <span class="step-name">{{ etapa.nombre }}</span>
                            <span class="step-sla">
                                {% if etapa.sla %}{{ etapa.sla_horas }}{% else %}24h{% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL: COMENTARIOS DE ANALISTA (4/6) + SOLICITUDES RELACIONADAS (2/6) -->
    <div class="row mb-4">
        <!-- COMENTARIOS DE ANALISTA (4/6 del ancho) -->
        <div class="col-lg-8">
            <div class="comentarios-analista-section-compact">
                <div class="comentarios-analista-header-compact">
                    <h6><i class="fas fa-user-md me-2"></i>Comentarios de Analista</h6>

                </div>
                <div class="comentarios-analista-body-compact" id="comentarios-analista-content">
                    <!-- Lista de comentarios existentes -->
                    <div class="comentarios-lista-compact" id="lista-comentarios-analista-credito">
                        <div class="alert alert-light text-center" id="sin-comentarios-analista">
                            <i class="fas fa-clipboard-list me-2"></i>
                            <small>Aún no hay comentarios de analista para esta solicitud</small>
                        </div>
                    </div>
                </div>
                
                <!-- Formulario compacto fijo en el pie -->
                <div class="nuevo-comentario-form-compact">
                    <form id="form-comentario-analista-credito" method="post" class="comentario-form-compact">
                        {% csrf_token %}
                        <div class="form-body-compact">
                            <!-- Preview de bullet points generados automáticamente -->
                            <div class="bullet-points-preview" id="bullet-points-preview" style="display: none;">
                                <div class="preview-header">
                                    <i class="fas fa-list-ul me-2"></i>
                                    <strong>Comentarios de campos detectados:</strong>
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="btn-refresh-bullets">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <div class="preview-content" id="preview-content">
                                    <!-- Los bullet points se generan dinámicamente aquí -->
                                </div>
                            </div>
                            
                            <textarea class="form-control comentario-textarea-compact" 
                                      id="comentario-analista-credito-text"
                                      placeholder="Escriba su análisis general..."
                                      rows="3" 
                                      maxlength="1000"
                                      required></textarea>
                            <div class="form-footer-compact">
                                <div class="char-counter-compact">
                                    <span id="char-count-analista-credito">0</span>/1000
                                </div>
                                <div class="form-actions-compact">
                                    <button type="button" class="btn btn-outline-info btn-sm me-2" id="btn-generate-bullets">
                                        <i class="fas fa-magic me-1"></i>Generar Bullets
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-sm" id="btn-enviar-analista-credito">
                                        <i class="fas fa-save me-1"></i>Guardar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- SOLICITUDES RELACIONADAS (2/6 del ancho) -->
        <div class="col-lg-4">
            <div class="related-requests-section">
                <div class="related-header">
                    <div class="related-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <div class="related-title">
                        <h5>Solicitudes Relacionadas</h5>
                        <small>Cliente: {{ solicitud.cliente_cedula|default:"-" }}</small>
                    </div>
                </div>
                
                <div class="related-content">
                    {% if mostrar_mensaje_sin_cliente %}
                        <div class="alert alert-warning text-center my-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Esta solicitud no tiene cédula de cliente asignada, no se pueden mostrar solicitudes relacionadas.
                        </div>
                    {% else %}
                        <!-- Búsqueda automática por cédula -->
                        <div class="search-info">
                            <i class="fas fa-search me-2"></i>
                            <span>Buscando por cédula: <strong>{{ solicitud.cliente_cedula|default:"-" }}</strong></span>
                        </div>
                        
                        <!-- Lista de solicitudes relacionadas -->
                        <div class="related-list">
                            {% for s in solicitudes_relacionadas %}
                            <div class="related-item">
                                <div class="related-icon">
                                    <i class="fas fa-file-alt {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}text-success{% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}text-danger{% else %}text-warning{% endif %}"></i>
                                </div>
                                <div class="related-details">
                                    <div class="related-header-item">
                                        <strong>{{ s.codigo }}</strong>
                                        <span class="related-date">{{ s.fecha_creacion|date:"d/m/Y" }}</span>
                                    </div>
                                    <div class="related-info">
                                        <span class="badge 
                                            {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}bg-success
                                            {% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}bg-danger
                                            {% else %}bg-warning{% endif %}">
                                            {% if s.etapa_actual %}{{ s.etapa_actual.nombre }}{% else %}Sin estado{% endif %}
                                        </span>
                                        <span class="related-amount">
                                            B/. {% if s.cotizacion and s.cotizacion.montoPrestamo %}{{ s.cotizacion.montoPrestamo|floatformat:2 }}{% else %}0.00{% endif %}
                                        </span>
                                    </div>
                                    <div class="related-description">
                                        {% if s.cotizacion and s.cotizacion.tipoPrestamo %}
                                            {% if s.cotizacion.tipoPrestamo == 'auto' %}Préstamo Auto{% else %}Préstamo Personal{% endif %}
                                        {% else %}Préstamo{% endif %}
                                        {% if s.cotizacion and s.cotizacion.plazoPago %} - {{ s.cotizacion.plazoPago }} meses{% endif %}
                                    </div>
                                </div>
                                <div class="related-actions">
                                    <a href="{% url 'workflow:detalle_solicitud_analisis' s.id %}" class="btn btn-outline-primary btn-sm" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <div class="alert alert-info text-center my-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Sin solicitudes relacionadas disponibles para esta cédula.
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if solicitudes_relacionadas %}
                        <div class="related-summary">
                            <div class="summary-item">
                                <span class="summary-label">Total Solicitudes:</span>
                                <span class="summary-value">{{ solicitudes_relacionadas|length }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Aprobadas:</span>
                                <span class="summary-value text-success">
                                    {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                </span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">En Proceso:</span>
                                <span class="summary-value text-warning">
                                    {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Proceso' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                </span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Rechazadas:</span>
                                <span class="summary-value text-danger">
                                    {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- LAYOUT SECUNDARIO: PESTAÑAS (OCUPAN TODO EL ANCHO) -->
    <div class="row">
        <!-- SISTEMA DE PESTAÑAS (ANCHO COMPLETO) -->
        <div class="col-12">
            <!-- SISTEMA DE PESTAÑAS -->
    <div class="tabs-section">
        <div class="tabs-header">
            <button class="tab-button active" data-tab="comentarios">
                <i class="fas fa-comments me-2"></i>Comentarios Generales
            </button>
            <button class="tab-button" data-tab="historial">
                <i class="fas fa-history me-2"></i>Historial
            </button>
        </div>
        
        <div class="tabs-content">
            <!-- Tab Comentarios -->
            <div class="tab-pane active" id="tab-comentarios">
                <div class="chat-container-general">
                    <!-- Header del Chat General -->
                    <div class="chat-header-general">
                        <div class="chat-title-general">
                            <i class="fas fa-comments text-primary me-2"></i>
                            <span>Comentarios Generales</span>
                        </div>
                        <div class="chat-info">
                            <span class="badge bg-primary" id="contador-comentarios-generales">0 comentarios</span>
                            <span class="status-dot online"></span>
                            <small>En línea</small>
                        </div>
                    </div>
                    
                    <!-- Área de Mensajes Generales (con scroll) -->
                    <div class="chat-messages-general" id="lista-comentarios">
                        <!-- Los mensajes se cargan dinámicamente via AJAX -->
                        <div class="chat-welcome-general">
                            <div class="welcome-avatar-general">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="welcome-message-general">
                                <p><strong>Chat General</strong></p>
                                <p>Espacio para comentarios y conversaciones generales sobre esta solicitud. Todos los usuarios pueden participar aquí.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input de Mensaje General (fijo abajo) -->
                    <div class="chat-input-container-general">
                        <form id="form-comentario-moderno" method="post" class="chat-form-general">
                            {% csrf_token %}
                            <div class="input-group-chat-general">
                                <div class="user-avatar-chat-general">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="input-wrapper-general">
                                    <textarea class="chat-input-general" 
                                              placeholder="Escribe tu comentario general..."
                                              rows="1" 
                                              id="comentario-text-modern"
                                              maxlength="1000"></textarea>
                                    <div class="input-actions-general">
                                        <button type="button" class="attachment-button" title="Adjuntar archivo">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <button type="button" class="mention-button" title="Mencionar usuario">
                                            <i class="fas fa-at"></i>
                                        </button>
                                        <span class="char-counter-general">
                                            <span id="char-count">0</span>/1000
                                        </span>
                                        <button type="submit" class="send-button-general" id="btn-enviar-comentario">
                                            <i class="fas fa-paper-plane"></i>
                                            <div class="loading-spinner-chat-general" style="display: none;">
                                                <i class="fas fa-spinner fa-spin"></i>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            

            
            <!-- Tab Historial -->
            <div class="tab-pane" id="tab-historial">
                <div class="historial-content">
                    <div class="historial-item">
                        <div class="historial-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="historial-details">
                            <div class="historial-header">
                                <strong>Consulta</strong>
                                <span class="historial-date">10/07/2025 16:45</span>
                            </div>
                            <div class="historial-info">
                                Por andresrdrg_
                            </div>
                        </div>
                    </div>
                    
                    <div class="historial-item">
                        <div class="historial-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="historial-details">
                            <div class="historial-header">
                                <strong>Documentación Pendiente</strong>
                                <span class="historial-date">10/07/2025 16:45</span>
                            </div>
                            <div class="historial-info">
                                Por andresrdrg_
                                <br><span class="text-success">Completado: 10/07/2025 16:45</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="historial-item">
                        <div class="historial-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="historial-details">
                            <div class="historial-header">
                                <strong>Nuevo Lead</strong>
                                <span class="historial-date">10/07/2025 16:45</span>
                            </div>
                            <div class="historial-info">
                                Por andresrdrg
                                <br><span class="text-success">Completado: 10/07/2025 16:45</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="historial-item">
                        <div class="historial-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="historial-details">
                            <div class="historial-header">
                                <strong>Documentación Pendiente</strong>
                                <span class="historial-date">10/07/2025 14:51</span>
                            </div>
                            <div class="historial-info">
                                Por otejeira
                                <br><span class="text-success">Completado: 10/07/2025 16:45</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="historial-item">
                        <div class="historial-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="historial-details">
                            <div class="historial-header">
                                <strong>Nuevo Lead</strong>
                                <span class="historial-date">10/07/2025 14:15</span>
                            </div>
                            <div class="historial-info">
                                Por otejeira
                                <br><span class="text-success">Completado: 10/07/2025 14:51</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Modal para Comentarios de Compliance -->
<div class="modal fade" id="modalComentarioCompliance" tabindex="-1" aria-labelledby="modalComentarioComplianceLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalComentarioComplianceLabel">
                    <i class="fas fa-comment-dots me-2"></i>
                    Comentario de Compliance
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Campo:</label>
                    <div class="fw-bold text-primary" id="campo-nombre"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Valor actual:</label>
                    <div class="fw-bold" id="campo-valor"></div>
                </div>
                <div class="mb-3">
                    <label for="comentario-compliance" class="form-label">Comentario:</label>
                    <textarea class="form-control" id="comentario-compliance" rows="5" placeholder="Ingrese su comentario sobre este campo..."></textarea>
                    <div class="form-text">
                        <span id="char-count-compliance">0</span>/500 caracteres
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar-comentario-compliance">
                    <i class="fas fa-save me-2"></i>
                    Guardar Comentario
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script para funcionalidades -->
<script>
// Variables globales
const solicitudId = parseInt('{{ solicitud.id }}');

// Función global para obtener token CSRF
function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

// ==========================================
// FUNCIONES GLOBALES PARA TRANSICIONES
// ==========================================

// Función para realizar transiciones
window.realizarTransicion = function(etapaDestinoId, etapaDestinoNombre, puedeRealizar, requisitosFaltantes) {
    console.log('🔄 Iniciando transición:', {
        etapaDestinoId: etapaDestinoId,
        etapaDestino: etapaDestinoNombre,
        puedeRealizar: puedeRealizar,
        requisitosFaltantes: requisitosFaltantes
    });
    
    if (!puedeRealizar) {
        const mensaje = `No puedes realizar esta transición porque faltan ${requisitosFaltantes} requisito(s) obligatorio(s).`;
        if (typeof mostrarToast === 'function') {
            mostrarToast(mensaje, 'warning');
        } else {
            alert(mensaje);
        }
        return;
    }
    
    // Mostrar modal de confirmación con comentarios analista
    mostrarModalConfirmacion(etapaDestinoId, etapaDestinoNombre);
};

// Función para mostrar modal de confirmación
window.mostrarModalConfirmacion = function(etapaDestinoId, etapaDestinoNombre) {
    // Verificar que solicitudId esté disponible
    if (typeof solicitudId === 'undefined') {
        console.error('❌ Error: solicitudId no está definido');
        alert('Error: No se pudo obtener la información de la solicitud');
        return;
    }
    
    // Obtener comentarios analista
    fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios/?tipo=analista`)
        .then(response => response.json())
        .then(data => {
            let comentariosHTML = '';
            let bulletPointsHTML = '';
            
            if (data.success && data.comentarios.length > 0) {
                // Generar HTML de comentarios
                comentariosHTML = data.comentarios.map(comentario => {
                    return `
                        <div class="comentario-confirmacion">
                            <div class="comentario-autor">
                                <i class="fas fa-user-circle me-1"></i>
                                ${comentario.usuario_nombre}
                            </div>
                            <div class="comentario-fecha">
                                ${formatearFecha(comentario.fecha_creacion)}
                            </div>
                            <div class="comentario-texto">
                                ${comentario.comentario}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Generar bullet points
                bulletPointsHTML = data.comentarios.map(comentario => {
                    return `<li>${comentario.comentario}</li>`;
                }).join('');
            } else {
                comentariosHTML = '<p class="text-muted">No hay comentarios de analista para esta solicitud.</p>';
                bulletPointsHTML = '<li>Sin comentarios específicos</li>';
            }
            
            // Mostrar modal con la información
            const modalHTML = `
                <div class="modal fade" id="modalConfirmacionTransicion" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-arrow-right me-2"></i>
                                    Confirmar Transición a: ${etapaDestinoNombre}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    La solicitud será enviada a la etapa: <strong>${etapaDestinoNombre}</strong>
                                </div>
                                
                                <div class="comentarios-analista-section">
                                    <h6><i class="fas fa-comments me-2"></i>Comentarios del Analista:</h6>
                                    ${comentariosHTML}
                                </div>
                                
                                <div class="bullet-points-section mt-3">
                                    <h6><i class="fas fa-list me-2"></i>Resumen para el correo:</h6>
                                    <ul class="bullet-points-list">
                                        ${bulletPointsHTML}
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </button>
                                <button type="button" class="btn btn-primary" onclick="confirmarTransicion(${etapaDestinoId}, '${etapaDestinoNombre}')">
                                    <i class="fas fa-check me-1"></i>Confirmar Transición
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal existente si existe
            const existingModal = document.getElementById('modalConfirmacionTransicion');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacionTransicion'));
            modal.show();
            
            // Limpiar modal cuando se cierre
            document.getElementById('modalConfirmacionTransicion').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        })
        .catch(error => {
            console.error('❌ Error al obtener comentarios:', error);
            alert('Error al obtener comentarios del analista');
        });
};

// Función para confirmar transición
window.confirmarTransicion = function(etapaDestinoId, etapaDestinoNombre) {
    console.log('✅ Confirmando transición a:', etapaDestinoNombre);
    
    // Mostrar loading
    const btnConfirmar = document.querySelector('#modalConfirmacionTransicion .btn-primary');
    const originalText = btnConfirmar.innerHTML;
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
    
    // Realizar transición
    fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            etapa_destino_id: etapaDestinoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Transición exitosa:', data);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionTransicion'));
            modal.hide();
            
            // Mostrar mensaje de éxito
            if (typeof mostrarToast === 'function') {
                mostrarToast(`Solicitud enviada exitosamente a: ${etapaDestinoNombre}`, 'success');
            } else {
                alert(`Solicitud enviada exitosamente a: ${etapaDestinoNombre}`);
            }
            
            // Recargar página después de un momento
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            console.error('❌ Error en transición:', data.error);
            alert('Error al realizar la transición: ' + data.error);
            
            // Restaurar botón
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('❌ Error de red:', error);
        alert('Error de red al realizar la transición');
        
        // Restaurar botón
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = originalText;
    });
};

// Función para formatear fecha
window.formatearFecha = function(fechaISO) {
    const fecha = new Date(fechaISO);
    return fecha.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
};

// Función para mostrar toast (placeholder)
window.mostrarToast = function(mensaje, tipo = 'info') {
    // Implementación básica si no existe la función
    console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
    
    // Mostrar con alert como fallback
    if (tipo === 'error') {
        alert('Error: ' + mensaje);
    } else if (tipo === 'warning') {
        alert('Advertencia: ' + mensaje);
    } else {
        // Para success e info, usar console.log
        console.log(mensaje);
    }
};

// Función para marcar todos los campos como buenos
window.marcarTodosComoBueno = function() {
    if (confirm('¿Está seguro que desea marcar todos los campos como "Bueno"?')) {
        // Obtener todos los botones de calificación "Bueno"
        const botonesBueno = document.querySelectorAll('.btn-calificar-bueno');
        
        botonesBueno.forEach(btn => {
            const campo = btn.getAttribute('data-campo');
            if (campo) {
                calificarCampo(campo, 'bueno');
            }
        });
        
        // Mostrar mensaje de confirmación
        if (typeof mostrarToast === 'function') {
            mostrarToast('Todos los campos han sido marcados como "Bueno"', 'success');
        } else {
            alert('Todos los campos han sido marcados como "Bueno"');
        }
    }
};

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar reloj en tiempo real
    function actualizarTiempo() {
        const ahora = new Date();
        
        // Formatear hora
        const horas = ahora.getHours().toString().padStart(2, '0');
        const minutos = ahora.getMinutes().toString().padStart(2, '0');
        const segundos = ahora.getSeconds().toString().padStart(2, '0');
        
        // Formatear fecha
        const dia = ahora.getDate().toString().padStart(2, '0');
        const mes = (ahora.getMonth() + 1).toString().padStart(2, '0');
        const año = ahora.getFullYear();
        
        // Actualizar elementos
        document.getElementById('reloj-tiempo-real').textContent = `${horas}:${minutos}:${segundos}`;
        document.getElementById('fecha-actual').textContent = `${dia}/${mes}/${año}`;
        document.getElementById('tiempo-boton').textContent = `${horas}:${minutos}:${segundos}`;
    }
    
    // Inicializar tiempo inmediatamente
    actualizarTiempo();
    
    // Actualizar cada segundo
    setInterval(actualizarTiempo, 1000);
    

    
    // Funciones para comentarios
    function guardarComentario(tipo, texto) {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`/workflow/api/solicitudes/{{ solicitud.id }}/comentarios/crear/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                comentario: texto,
                tipo: tipo
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al guardar comentario: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al guardar comentario');
        });
    }

    // Sistema de pestañas
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanes = document.querySelectorAll('.tab-pane');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // Remover clase active de todos los botones y panes
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            // Activar el botón y pane seleccionado
            this.classList.add('active');
            document.getElementById(`tab-${targetTab}`).classList.add('active');
        });
    });

    // Formulario comentario moderno con AJAX
    const formComentarioModerno = document.getElementById('form-comentario-moderno');
    const comentarioTextModerno = document.getElementById('comentario-text-modern');
    const charCountSpan = document.getElementById('char-count');
    const btnEnviar = document.getElementById('btn-enviar-comentario');
    const btnCancelar = document.getElementById('btn-cancelar-comentario');
    
    // Contador de caracteres
    if (comentarioTextModerno && charCountSpan) {
        comentarioTextModerno.addEventListener('input', function() {
            const count = this.value.length;
            charCountSpan.textContent = count;
            
            // Cambiar color según límite
            if (count > 900) {
                charCountSpan.parentElement.className = 'text-danger';
            } else if (count > 700) {
                charCountSpan.parentElement.className = 'text-warning';
            } else {
                charCountSpan.parentElement.className = 'text-muted';
            }
        });
    }
    
    // Manejar envío de comentario moderno
    if (formComentarioModerno) {
        formComentarioModerno.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const comentarioTexto = comentarioTextModerno.value.trim();
            if (!comentarioTexto) {
                alert('Por favor escribe un comentario antes de enviar.');
                return;
            }
            
            // Deshabilitar botón y mostrar loading
            btnEnviar.disabled = true;
            btnEnviar.querySelector('span').style.display = 'none';
            btnEnviar.querySelector('.loading-spinner').style.display = 'inline-block';
            
            // Enviar comentario via AJAX
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/workflow/api/solicitudes/{{ solicitud.id }}/comentarios/crear/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    comentario: comentarioTexto,
                    tipo: 'analisis'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Agregar comentario a la lista sin recargar
                    agregarComentarioALista(data.comentario);
                    
                    // Limpiar formulario
                    comentarioTextModerno.value = '';
                    charCountSpan.textContent = '0';
                    charCountSpan.parentElement.className = 'text-muted';
                    
                    // Mostrar mensaje de éxito
                    mostrarNotificacionExito('Comentario agregado correctamente');
                    
                    // Actualizar contador de comentarios
                    actualizarContadorComentarios();
                } else {
                    mostrarNotificacionError('Error al guardar comentario: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarNotificacionError('Error de red al enviar el comentario');
            })
            .finally(() => {
                // Rehabilitar botón
                btnEnviar.disabled = false;
                btnEnviar.querySelector('span').style.display = 'inline-block';
                btnEnviar.querySelector('.loading-spinner').style.display = 'none';
            });
        });
    }
    
    // Función para descargar PDF completo con todos los documentos
    function downloadMergedPDF() {
        const btn = document.getElementById('btn-download-merged-pdf');
        const originalText = btn.innerHTML;
        
        // Mostrar loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando PDF...';
        
        // Obtener token CSRF
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Realizar petición para generar PDF
        fetch(`/workflow/api/solicitudes/{{ solicitud.id }}/download-merged-pdf/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                // Si la respuesta no es exitosa, intentar leer el error como JSON
                return response.json().then(errorData => {
                    throw new Error(errorData.error || 'Error en la respuesta del servidor');
                }).catch(() => {
                    throw new Error('Error en la respuesta del servidor');
                });
            }
            return response.blob();
        })
        .then(blob => {
            // Crear URL del blob y descargar
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `Solicitud_{{ solicitud.codigo }}_Documentos_Completos.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Mostrar notificación de éxito
            mostrarNotificacionExito('PDF generado y descargado correctamente');
        })
        .catch(error => {
            console.error('Error al generar PDF:', error);
            mostrarNotificacionError('Error al generar el PDF. Intente nuevamente.');
        })
        .finally(() => {
            // Restaurar botón
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    }
    
    // Event listener para el botón de descarga de PDF completo
    const btnDownloadMergedPDF = document.getElementById('btn-download-merged-pdf');
    if (btnDownloadMergedPDF) {
        btnDownloadMergedPDF.addEventListener('click', downloadMergedPDF);
    }
    
    // ==========================================
    // FUNCIONALIDAD PARA GENERAR BULLET POINTS
    // ==========================================
    
    // Función para obtener calificaciones de campos y generar bullet points
    async function generarBulletPoints() {
        const previewContainer = document.getElementById('bullet-points-preview');
        const previewContent = document.getElementById('preview-content');
        const btnGenerate = document.getElementById('btn-generate-bullets');
        
        if (!previewContainer || !previewContent || !btnGenerate) {
            console.error('❌ Elementos de bullet points no encontrados');
            return;
        }
        
        // Mostrar loading
        btnGenerate.disabled = true;
        btnGenerate.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando...';
        
        try {
            // Obtener calificaciones de campos
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Error al obtener calificaciones');
            }
            
            // Filtrar solo calificaciones con comentarios
            const calificacionesConComentarios = data.calificaciones.filter(
                cal => cal.comentario && cal.comentario.trim() !== ''
            );
            
            if (calificacionesConComentarios.length === 0) {
                previewContent.innerHTML = `
                    <div class="no-bullet-points">
                        <i class="fas fa-info-circle me-2"></i>
                        No hay comentarios de campos disponibles para generar bullet points.
                    </div>
                `;
                previewContainer.style.display = 'block';
                return;
            }
            
            // Generar HTML de bullet points
            const bulletPointsHTML = calificacionesConComentarios.map(cal => {
                const estadoClass = cal.estado === 'bueno' ? 'success' : cal.estado === 'malo' ? 'danger' : 'secondary';
                const estadoText = cal.estado === 'bueno' ? 'Bueno' : cal.estado === 'malo' ? 'Malo' : 'Sin calificar';
                
                return `
                    <div class="bullet-point-item">
                        <div class="bullet-point-icon">
                            <i class="fas fa-circle"></i>
                        </div>
                        <div class="bullet-point-content">
                            <div class="bullet-point-field">${formatearNombreCampo(cal.campo)}</div>
                            <div class="bullet-point-comment">${cal.comentario}</div>
                            <div class="bullet-point-status">
                                <span class="badge bg-${estadoClass}">${estadoText}</span>
                                <span class="text-muted">• ${cal.usuario} • ${formatearFecha(cal.fecha_modificacion)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            previewContent.innerHTML = bulletPointsHTML;
            previewContainer.style.display = 'block';
            
            // Mostrar notificación de éxito
            mostrarNotificacionExito(`${calificacionesConComentarios.length} bullet points generados`);
            
        } catch (error) {
            console.error('❌ Error al generar bullet points:', error);
            mostrarNotificacionError('Error al generar bullet points: ' + error.message);
            
            previewContent.innerHTML = `
                <div class="no-bullet-points">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar comentarios de campos.
                </div>
            `;
            previewContainer.style.display = 'block';
        } finally {
            // Restaurar botón
            btnGenerate.disabled = false;
            btnGenerate.innerHTML = '<i class="fas fa-magic me-1"></i>Generar Bullets';
        }
    }
    
    // Función para formatear nombres de campos
    function formatearNombreCampo(campo) {
        const mapeoCampos = {
            'nombre': 'Nombre del Cliente',
            'cedula': 'Cédula',
            'monto': 'Monto del Préstamo',
            'plazo': 'Plazo de Pago',
            'ingresos': 'Ingresos',
            'gastos': 'Gastos',
            'capacidad_pago': 'Capacidad de Pago',
            'historial_credito': 'Historial Crediticio',
            'garantias': 'Garantías',
            'documentacion': 'Documentación',
            'apc': 'APC',
            'css': 'Ficha CSS',
            'referencias': 'Referencias',
            'trabajo': 'Información Laboral',
            'direccion': 'Dirección',
            'telefono': 'Teléfono',
            'email': 'Correo Electrónico'
        };
        
        return mapeoCampos[campo] || campo.charAt(0).toUpperCase() + campo.slice(1).replace(/_/g, ' ');
    }
    
    // Función para generar comentario completo con bullet points
    function generarComentarioCompleto() {
        const comentarioGeneral = document.getElementById('comentario-analista-credito-text').value.trim();
        const previewContent = document.getElementById('preview-content');
        
        if (!comentarioGeneral) {
            mostrarNotificacionError('Debe escribir un análisis general antes de guardar');
            return null;
        }
        
        // Obtener bullet points del preview
        const bulletPoints = [];
        const bulletItems = previewContent.querySelectorAll('.bullet-point-item');
        
        bulletItems.forEach(item => {
            const campo = item.querySelector('.bullet-point-field').textContent;
            const comentario = item.querySelector('.bullet-point-comment').textContent;
            bulletPoints.push(`• ${campo}: ${comentario}`);
        });
        
        // Combinar comentario general con bullet points
        let comentarioCompleto = comentarioGeneral;
        
        if (bulletPoints.length > 0) {
            comentarioCompleto += '\n\nComentarios específicos por campo:\n' + bulletPoints.join('\n');
        }
        
        return comentarioCompleto;
    }
    
    // Event listeners para botones de bullet points
    const btnGenerateBullets = document.getElementById('btn-generate-bullets');
    const btnRefreshBullets = document.getElementById('btn-refresh-bullets');
    
    if (btnGenerateBullets) {
        btnGenerateBullets.addEventListener('click', generarBulletPoints);
    }
    
    if (btnRefreshBullets) {
        btnRefreshBullets.addEventListener('click', generarBulletPoints);
    }
    
    // Función para agregar comentario a la lista
    function agregarComentarioALista(comentario) {
        const listaComentarios = document.getElementById('lista-comentarios');
        const emptyState = listaComentarios.querySelector('.empty-state-modern');
        
        // Remover estado vacío si existe
        if (emptyState) {
            emptyState.remove();
        }
        
        // Crear HTML del nuevo comentario
        const comentarioHTML = `
            <div class="comentario-item-modern">
                <div class="comentario-avatar-modern">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="comentario-content-modern">
                    <div class="comentario-header-modern">
                        <div class="author-info">
                            <strong class="author-name">${comentario.usuario_nombre}</strong>
                            <span class="author-role">Analista</span>
                            <span class="comentario-date-modern">Hace un momento</span>
                        </div>
                        <div class="comentario-actions">
                            <button class="btn-action-mini" title="Editar comentario">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action-mini text-danger" title="Eliminar comentario">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="comentario-text-modern">
                        ${comentario.texto.replace(/\n/g, '<br>')}
                    </div>
                    <div class="comentario-footer-modern">
                        <button class="btn-reaction">
                            <i class="fas fa-thumbs-up me-1"></i>
                            <span>0</span>
                        </button>
                        <button class="btn-reaction">
                            <i class="fas fa-reply me-1"></i>
                            Responder
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Insertar al inicio de la lista
        listaComentarios.insertAdjacentHTML('afterbegin', comentarioHTML);
        
        // Animar el nuevo comentario
        const nuevoComentario = listaComentarios.firstElementChild;
        nuevoComentario.style.opacity = '0';
        nuevoComentario.style.transform = 'translateY(-20px)';
        
        setTimeout(() => {
            nuevoComentario.style.transition = 'all 0.3s ease';
            nuevoComentario.style.opacity = '1';
            nuevoComentario.style.transform = 'translateY(0)';
        }, 100);
    }
    
    // Función para actualizar contador de comentarios
    function actualizarContadorComentarios() {
        const badge = document.querySelector('.comentarios-count .badge');
        if (badge) {
            const count = document.querySelectorAll('.comentario-item-modern').length;
            badge.textContent = `${count} comentario${count !== 1 ? 's' : ''}`;
        }
    }
    
    // Funciones de notificación mejoradas
    function mostrarNotificacionExito(mensaje) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification toast-success';
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-check-circle me-2"></i>
                ${mensaje}
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    function mostrarNotificacionError(mensaje) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification toast-error';
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-exclamation-circle me-2"></i>
                ${mensaje}
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }
    
    // Cancelar comentario
    if (btnCancelar) {
        btnCancelar.addEventListener('click', function() {
            comentarioTextModerno.value = '';
            charCountSpan.textContent = '0';
            charCountSpan.parentElement.className = 'text-muted';
        });
    }

    // Funciones para botones de acción
    window.ejecutarTransicion = function(transicionId) {
        if (confirm('¿Está seguro de realizar esta transición?')) {
            // Implementar lógica de transición
            console.log('Ejecutando transición:', transicionId);
        }
    };

    window.aprobarSolicitud = function() {
        if (confirm('¿Está seguro de aprobar esta solicitud?')) {
            // Implementar lógica de aprobación
            console.log('Aprobando solicitud');
        }
    };

    window.rechazarSolicitud = function() {
        if (confirm('¿Está seguro de rechazar esta solicitud?')) {
            // Implementar lógica de rechazo
            console.log('Rechazando solicitud');
        }
    };

    window.solicitarMasInformacion = function() {
        const motivo = prompt('Indique el motivo por el cual solicita más información:');
        if (motivo) {
            // Implementar lógica para solicitar más información
            console.log('Solicitando más información:', motivo);
        }
    };

    window.derivarSolicitud = function() {
        // Implementar lógica para derivar solicitud
        console.log('Derivando solicitud');
    };

    window.editarComentario = function(comentarioId) {
        // Implementar lógica para editar comentario
        console.log('Editando comentario:', comentarioId);
    };

    window.eliminarComentario = function(comentarioId) {
        if (confirm('¿Está seguro de eliminar este comentario?')) {
            // Implementar lógica para eliminar comentario
            console.log('Eliminando comentario:', comentarioId);
        }
    };

    // ==========================================
    // FUNCIÓN PARA REALIZAR TRANSICIONES
    // ==========================================
    
    // Definir funciones globalmente para que estén disponibles inmediatamente
    window.realizarTransicion = function(etapaDestinoId, etapaDestinoNombre, puedeRealizar, requisitosFaltantes) {
        console.log('🔄 Iniciando transición:', {
            etapaDestinoId: etapaDestinoId,
            etapaDestino: etapaDestinoNombre,
            puedeRealizar: puedeRealizar,
            requisitosFaltantes: requisitosFaltantes
        });
        
        if (!puedeRealizar) {
            const mensaje = `No puedes realizar esta transición porque faltan ${requisitosFaltantes} requisito(s) obligatorio(s).`;
            if (typeof mostrarToast === 'function') {
                mostrarToast(mensaje, 'warning');
            } else {
                alert(mensaje);
            }
            return;
        }
        
        // Mostrar modal de confirmación con comentarios analista
        mostrarModalConfirmacion(etapaDestinoId, etapaDestinoNombre);
    };
    
    // Función para mostrar modal de confirmación
    window.mostrarModalConfirmacion = function(etapaDestinoId, etapaDestinoNombre) {
        // Verificar que solicitudId esté disponible
        if (typeof solicitudId === 'undefined') {
            console.error('❌ Error: solicitudId no está definido');
            alert('Error: No se pudo obtener la información de la solicitud');
            return;
        }
        
        // Obtener comentarios analista
        fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios/?tipo=analista`)
            .then(response => response.json())
            .then(data => {
                let comentariosHTML = '';
                let bulletPointsHTML = '';
                
                if (data.success && data.comentarios.length > 0) {
                    // Generar HTML de comentarios
                    comentariosHTML = data.comentarios.map(comentario => {
                        return `
                            <div class="comentario-confirmacion">
                                <div class="comentario-header">
                                    <strong>${comentario.usuario.nombre_completo}</strong>
                                    <small>${typeof formatearFecha === 'function' ? formatearFecha(comentario.fecha_creacion) : new Date(comentario.fecha_creacion).toLocaleString()}</small>
                                </div>
                                <div class="comentario-texto">
                                    ${comentario.comentario.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Extraer bullet points de los comentarios
                    const bulletPoints = extraerBulletPoints(data.comentarios);
                    if (bulletPoints.length > 0) {
                        bulletPointsHTML = `
                            <div class="bullet-points-confirmacion">
                                <h6><i class="fas fa-list-ul me-2"></i>Puntos Clave del Análisis:</h6>
                                <ul>
                                    ${bulletPoints.map(point => `<li>${point}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                } else {
                    comentariosHTML = '<p class="text-muted">No hay comentarios de analista disponibles.</p>';
                }
                
                // Crear y mostrar modal
                const modalHTML = `
                    <div class="modal fade" id="modalConfirmacionTransicion" tabindex="-1" aria-labelledby="modalConfirmacionTransicionLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title" id="modalConfirmacionTransicionLabel">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Confirmar Cambio de Etapa
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>¿Está seguro de cambiar la etapa a "${etapaDestinoNombre}"?</strong>
                                        <br>
                                        <small>Esta acción no se puede deshacer y notificará al propietario de la solicitud.</small>
                                    </div>
                                    
                                    <div class="comentarios-section">
                                        <h6><i class="fas fa-comments me-2"></i>Comentarios del Analista:</h6>
                                        <div class="comentarios-container">
                                            ${comentariosHTML}
                                        </div>
                                    </div>
                                    
                                    ${bulletPointsHTML}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i>Cancelar
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="confirmarTransicion(${etapaDestinoId}, '${etapaDestinoNombre}')">
                                        <i class="fas fa-check me-1"></i>Confirmar Transición
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal anterior si existe
                const modalAnterior = document.getElementById('modalConfirmacionTransicion');
                if (modalAnterior) {
                    modalAnterior.remove();
                }
                
                // Agregar modal al DOM
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalConfirmacionTransicion'));
                modal.show();
            })
            .catch(error => {
                console.error('❌ Error al cargar comentarios:', error);
                if (typeof mostrarToast === 'function') {
                    mostrarToast('Error al cargar comentarios para confirmación', 'error');
                } else {
                    alert('Error al cargar comentarios para confirmación');
                }
            });
    }
    
    // Función para extraer bullet points de comentarios
    window.extraerBulletPoints = function(comentarios) {
        const bulletPoints = [];
        
        comentarios.forEach(comentario => {
            const texto = comentario.comentario;
            
            // Buscar líneas que empiecen con •, -, *, o números
            const lineas = texto.split('\n');
            lineas.forEach(linea => {
                const lineaLimpia = linea.trim();
                if (lineaLimpia.match(/^[•\-\*]\s/) || lineaLimpia.match(/^\d+\.\s/)) {
                    // Remover el marcador y limpiar
                    const punto = lineaLimpia.replace(/^[•\-\*]\s/, '').replace(/^\d+\.\s/, '');
                    if (punto.length > 0) {
                        bulletPoints.push(punto);
                    }
                }
            });
        });
        
        return bulletPoints;
    }
    
    // Función para confirmar la transición
    window.confirmarTransicion = function(etapaDestinoId, etapaDestinoNombre) {
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionTransicion'));
        modal.hide();
        
        // Mostrar indicador de carga
        const dropdownButton = document.getElementById('dropdownTransiciones');
        const originalText = dropdownButton.innerHTML;
        dropdownButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        dropdownButton.disabled = true;
        
        // Realizar la transición usando la API existente
        fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                etapa_id: etapaDestinoId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast(`Transición exitosa: ${etapaDestinoNombre}`, 'success');
                // Recargar la página para mostrar los cambios
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('❌ Error en transición:', error);
            mostrarToast(`Error al realizar transición: ${error.message}`, 'error');
        })
        .finally(() => {
            // Restaurar botón
            dropdownButton.innerHTML = originalText;
            dropdownButton.disabled = false;
        });
    };
    
    // Función auxiliar para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // ==========================================
    // SISTEMA DE COMENTARIOS COMPLETO
    // ==========================================
    
    // Variables globales
    const solicitudId = parseInt('{{ solicitud.id }}');
    const usuarioActualId = parseInt('{{ request.user.id }}');
    
    // Función para mostrar notificaciones - usa la función principal al final del archivo
    
    // Función para formatear fecha
    function formatearFecha(fecha) {
        const now = new Date();
        const diff = now - new Date(fecha);
        const seconds = Math.floor(diff / 1000);
        
        if (seconds < 60) return 'hace unos segundos';
        if (seconds < 3600) return `hace ${Math.floor(seconds / 60)} minutos`;
        if (seconds < 86400) return `hace ${Math.floor(seconds / 3600)} horas`;
        return `hace ${Math.floor(seconds / 86400)} días`;
    }
    
    // Función para auto-expandir textarea
    function autoExpandTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    // Función para enviar mensaje con Enter
    function handleKeyDown(event, submitFunction) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            submitFunction(event);
        }
    }
    
    // Función para scroll automático al final del chat
    function scrollToBottom(container) {
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
    
    // Función para configurar chat
    function configurarChat() {
        
        // Configurar textarea general
        const textareaGeneral = document.getElementById('comentario-text-modern');
        if (textareaGeneral) {
            textareaGeneral.addEventListener('input', function() {
                autoExpandTextarea(this);
                actualizarContadorCaracteres('comentario-text-modern', 'char-count');
            });
            
            textareaGeneral.addEventListener('keydown', function(event) {
                handleKeyDown(event, enviarComentarioGeneral);
            });
        }
    }
    
    // FUNCIONES PARA COMENTARIOS DE ANALISTA
    
    // Cargar comentarios de analista
    function cargarComentariosAnalista() {
        console.log('🔄 Cargando comentarios de analista...');
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios/?tipo=analista`)
            .then(response => response.json())
            .then(data => {
                console.log('📊 Comentarios analista recibidos:', data);
                
                if (data.success) {
                    const container = document.getElementById('lista-comentarios-analista');
                    
                    if (data.comentarios.length === 0) {
                        container.innerHTML = '';
                    } else {
                        // Mostrar solo comentarios sin mensaje de bienvenida
                        const welcomeMessage = ``;
                        
                        const messages = data.comentarios.map(comentario => {
                            const esPropio = comentario.usuario.id === usuarioActualId;
                            return `
                                <div class="message-bubble ${esPropio ? 'own' : 'other'}" data-comentario-id="${comentario.id}">
                                    <div class="message-content">
                                        ${comentario.comentario}
                                    </div>
                                    <div class="message-meta">
                                        <span class="message-author">${comentario.usuario.nombre_completo}</span>
                                        <span class="message-time">${formatearFecha(comentario.fecha_creacion)}</span>
                                        ${comentario.puede_editar ? `
                                            <div class="message-actions">
                                                <button class="action-btn" onclick="editarComentarioAnalista(${comentario.id})" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="action-btn" onclick="eliminarComentarioAnalista(${comentario.id})" title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        container.innerHTML = welcomeMessage + messages;
                        
                        // Scroll automático al final
                        setTimeout(() => {
                            container.scrollTop = container.scrollHeight;
                        }, 100);
                    }
                } else {
                    console.error('❌ Error al cargar comentarios:', data.error);
                    mostrarToast('Error al cargar comentarios: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('❌ Error de red:', error);
                mostrarToast('Error de red al cargar comentarios', 'error');
            });
    }
    

    
    // Función para editar comentario de analista
    window.editarComentarioAnalista = function(comentarioId) {
        const comentarioElement = document.querySelector(`[data-comentario-id="${comentarioId}"]`);
        const textoElement = comentarioElement.querySelector('.comentario-text-sidebar');
        const textoOriginal = textoElement.textContent.trim();
        
        // Crear campo de edición
        const textarea = document.createElement('textarea');
        textarea.className = 'form-control-sidebar';
        textarea.value = textoOriginal;
        textarea.style.minHeight = '60px';
        
        // Crear botones
        const botonesContainer = document.createElement('div');
        botonesContainer.className = 'comentario-actions-sidebar mt-2';
        botonesContainer.innerHTML = `
            <button class="btn-action-sidebar" onclick="guardarEdicionAnalista(${comentarioId}, this)">
                <i class="fas fa-save"></i> Guardar
            </button>
            <button class="btn-action-sidebar" onclick="cancelarEdicionAnalista(${comentarioId})">
                <i class="fas fa-times"></i> Cancelar
            </button>
        `;
        
        // Reemplazar contenido
        textoElement.innerHTML = '';
        textoElement.appendChild(textarea);
        textoElement.appendChild(botonesContainer);
        
        // Ocultar botones originales
        const accionesOriginales = comentarioElement.querySelector('.comentario-actions-sidebar:not(.mt-2)');
        if (accionesOriginales) {
            accionesOriginales.style.display = 'none';
        }
        
        // Enfocar textarea
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    };
    
    // Función para guardar edición de comentario analista
    window.guardarEdicionAnalista = function(comentarioId, botonElement) {
        const comentarioElement = document.querySelector(`[data-comentario-id="${comentarioId}"]`);
        const textarea = comentarioElement.querySelector('textarea');
        const nuevoTexto = textarea.value.trim();
        
        if (!nuevoTexto) {
            mostrarToast('El comentario no puede estar vacío', 'error');
            return;
        }
        
        console.log('💾 Guardando edición comentario analista:', comentarioId, nuevoTexto);
        
        fetch(`/workflow/api/comentarios/${comentarioId}/editar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ comentario: nuevoTexto })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Comentario actualizado exitosamente');
                cargarComentariosAnalista();
            } else {
                mostrarToast('Error al actualizar comentario: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Error:', error);
            mostrarToast('Error de red al actualizar comentario', 'error');
        });
    };
    
    // Función para cancelar edición de comentario analista
    window.cancelarEdicionAnalista = function(comentarioId) {
        cargarComentariosAnalista();
    };
    
    // Función para eliminar comentario de analista
    window.eliminarComentarioAnalista = function(comentarioId) {
        if (!confirm('¿Estás seguro de eliminar este comentario de analista?')) {
            return;
        }
        
        console.log('🗑️ Eliminando comentario analista:', comentarioId);
        
        fetch(`/workflow/api/comentarios/${comentarioId}/eliminar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Comentario eliminado exitosamente');
                cargarComentariosAnalista();
            } else {
                mostrarToast('Error al eliminar comentario: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Error:', error);
            mostrarToast('Error de red al eliminar comentario', 'error');
        });
    };
    
    // FUNCIONES PARA COMENTARIOS GENERALES
    
    // Cargar comentarios generales
    function cargarComentariosGenerales() {
        console.log('🔄 Cargando comentarios generales...');
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios/?tipo=general`)
            .then(response => response.json())
            .then(data => {
                console.log('📊 Comentarios generales recibidos:', data);
                
                if (data.success) {
                    const container = document.getElementById('lista-comentarios');
                    
                                         // Actualizar contador
                     const contadorGenerales = document.getElementById('contador-comentarios-generales');
                     if (contadorGenerales) {
                         contadorGenerales.textContent = `${data.comentarios.length} comentario${data.comentarios.length !== 1 ? 's' : ''}`;
                     }
                     
                     if (data.comentarios.length === 0) {
                         container.innerHTML = `
                             <div class="chat-welcome-general">
                                 <div class="welcome-avatar-general">
                                     <i class="fas fa-users"></i>
                                 </div>
                                 <div class="welcome-message-general">
                                     <p><strong>Chat General</strong></p>
                                     <p>Espacio para comentarios y conversaciones generales sobre esta solicitud. Todos los usuarios pueden participar aquí.</p>
                                 </div>
                             </div>
                         `;
                     } else {
                         // Mostrar mensaje de bienvenida + comentarios
                         const welcomeMessage = `
                             <div class="chat-welcome-general">
                                 <div class="welcome-avatar-general">
                                     <i class="fas fa-users"></i>
                                 </div>
                                 <div class="welcome-message-general">
                                     <p><strong>Chat General</strong></p>
                                     <p>Historial de conversaciones sobre esta solicitud.</p>
                                 </div>
                             </div>
                         `;
                         
                                                   const messages = data.comentarios.map(comentario => {
                              const esPropio = comentario.usuario.id === usuarioActualId;
                              return `
                                  <div class="message-bubble ${esPropio ? 'own' : 'other'}" data-comentario-id="${comentario.id}">
                                      <div class="message-content">
                                          ${comentario.comentario}
                                      </div>
                                      <div class="message-meta">
                                          <span class="message-author">${comentario.usuario.nombre_completo}</span>
                                          <span class="message-time">${formatearFecha(comentario.fecha_creacion)}</span>
                                          ${comentario.puede_editar ? `
                                              <div class="message-actions">
                                                  <button class="action-btn" onclick="editarComentarioGeneral(${comentario.id})" title="Editar">
                                                      <i class="fas fa-edit"></i>
                                                  </button>
                                                  <button class="action-btn" onclick="eliminarComentarioGeneral(${comentario.id})" title="Eliminar">
                                                      <i class="fas fa-trash"></i>
                                                  </button>
                                              </div>
                                          ` : ''}
                                      </div>
                                  </div>
                              `;
                          }).join('');
                          
                          container.innerHTML = welcomeMessage + messages;
                          
                          // Scroll automático al final
                          setTimeout(() => {
                              container.scrollTop = container.scrollHeight;
                          }, 100);
                    }
                } else {
                    console.error('❌ Error al cargar comentarios generales:', data.error);
                    mostrarToast('Error al cargar comentarios generales: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('❌ Error de red:', error);
                mostrarToast('Error de red al cargar comentarios generales', 'error');
            });
    }
    
    // Función para enviar comentario general
    function enviarComentarioGeneral(evento) {
        evento.preventDefault();
        
        const textarea = document.getElementById('comentario-text-modern');
        const comentarioTexto = textarea.value.trim();
        
        if (!comentarioTexto) {
            mostrarToast('Por favor ingresa un comentario', 'error');
            return;
        }
        
        const botonEnviar = document.getElementById('btn-enviar-comentario');
        const spinner = botonEnviar.querySelector('.loading-spinner-chat-general');
        const iconoBoton = botonEnviar.querySelector('i:not(.loading-spinner-chat-general i)');
        
        // Deshabilitar botón y mostrar spinner
        botonEnviar.disabled = true;
        if (spinner) {
            spinner.style.display = 'inline-block';
            iconoBoton.style.display = 'none';
        }
        
        console.log('📤 Enviando comentario general:', comentarioTexto);
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios/crear/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                comentario: comentarioTexto,
                tipo: 'general'
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('✅ Respuesta del servidor:', data);
            
            if (data.success) {
                mostrarToast('Comentario enviado exitosamente');
                textarea.value = '';
                actualizarContadorCaracteres('comentario-text-modern', 'char-count');
                cargarComentariosGenerales();
            } else {
                mostrarToast('Error al enviar comentario: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Error:', error);
            mostrarToast('Error de red al enviar comentario', 'error');
        })
        .finally(() => {
            // Rehabilitar botón y ocultar spinner
            botonEnviar.disabled = false;
            if (spinner) {
                spinner.style.display = 'none';
                iconoBoton.style.display = 'inline-block';
            }
        });
    }
    
    // Función para editar comentario general
    window.editarComentarioGeneral = function(comentarioId) {
        // Similar a la función de analista pero para comentarios generales
        const comentarioElement = document.querySelector(`[data-comentario-id="${comentarioId}"]`);
        const textoElement = comentarioElement.querySelector('.comentario-text-modern');
        const textoOriginal = textoElement.textContent.trim();
        
        // Crear campo de edición
        const textarea = document.createElement('textarea');
        textarea.className = 'form-control-modern';
        textarea.value = textoOriginal;
        textarea.style.minHeight = '80px';
        
        // Crear botones
        const botonesContainer = document.createElement('div');
        botonesContainer.className = 'comentario-actions mt-2';
        botonesContainer.innerHTML = `
            <button class="btn-action-mini" onclick="guardarEdicionGeneral(${comentarioId}, this)">
                <i class="fas fa-save"></i>
            </button>
            <button class="btn-action-mini" onclick="cancelarEdicionGeneral(${comentarioId})">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Reemplazar contenido
        textoElement.innerHTML = '';
        textoElement.appendChild(textarea);
        textoElement.appendChild(botonesContainer);
        
        // Ocultar botones originales
        const accionesOriginales = comentarioElement.querySelector('.comentario-actions:not(.mt-2)');
        if (accionesOriginales) {
            accionesOriginales.style.display = 'none';
        }
        
        // Enfocar textarea
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    };
    
    // Función para guardar edición de comentario general
    window.guardarEdicionGeneral = function(comentarioId, botonElement) {
        const comentarioElement = document.querySelector(`[data-comentario-id="${comentarioId}"]`);
        const textarea = comentarioElement.querySelector('textarea');
        const nuevoTexto = textarea.value.trim();
        
        if (!nuevoTexto) {
            mostrarToast('El comentario no puede estar vacío', 'error');
            return;
        }
        
        console.log('💾 Guardando edición comentario general:', comentarioId, nuevoTexto);
        
        fetch(`/workflow/api/comentarios/${comentarioId}/editar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ comentario: nuevoTexto })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Comentario actualizado exitosamente');
                cargarComentariosGenerales();
            } else {
                mostrarToast('Error al actualizar comentario: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Error:', error);
            mostrarToast('Error de red al actualizar comentario', 'error');
        });
    };
    
    // Función para cancelar edición de comentario general
    window.cancelarEdicionGeneral = function(comentarioId) {
        cargarComentariosGenerales();
    };
    
    // Función para eliminar comentario general
    window.eliminarComentarioGeneral = function(comentarioId) {
        if (!confirm('¿Estás seguro de eliminar este comentario?')) {
            return;
        }
        
        console.log('🗑️ Eliminando comentario general:', comentarioId);
        
        fetch(`/workflow/api/comentarios/${comentarioId}/eliminar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Comentario eliminado exitosamente');
                cargarComentariosGenerales();
            } else {
                mostrarToast('Error al eliminar comentario: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Error:', error);
            mostrarToast('Error de red al eliminar comentario', 'error');
        });
    };
    
    // FUNCIONES AUXILIARES
    
    // Función para actualizar contador de caracteres
    function actualizarContadorCaracteres(textareaId, counterId) {
        const textarea = document.getElementById(textareaId);
        const counter = document.getElementById(counterId);
        
        if (textarea && counter) {
            counter.textContent = textarea.value.length;
        }
    }
    
    // EVENT LISTENERS
    
    // Formulario de comentarios generales
    document.getElementById('form-comentario-moderno').addEventListener('submit', enviarComentarioGeneral);
    
    // Contador de caracteres para comentarios generales
    document.getElementById('comentario-text-modern').addEventListener('input', function() {
        actualizarContadorCaracteres('comentario-text-modern', 'char-count');
    });
    
    // INICIALIZACIÓN
    console.log('🚀 Inicializando sistema de comentarios completo...');
    
    // Configurar funcionalidades de chat
    configurarChat();
    
    // Cargar comentarios al cargar la página
    cargarComentariosAnalista();
    cargarComentariosGenerales();
    
    // Actualizar comentarios cada 30 segundos
    setInterval(function() {
        cargarComentariosAnalista();
        cargarComentariosGenerales();
    }, 30000);
    
    // ==========================================
    // FUNCIONALIDADES DE COMPLIANCE
    // ==========================================
    
    // Función para inicializar botones de compliance
    function inicializarComplianceButtons() {
        console.log('🔧 Inicializando botones de compliance...');
        const complianceButtons = document.querySelectorAll('.btn-compliance');
        
        console.log(`📊 Encontrados ${complianceButtons.length} botones de compliance`);
        
        if (complianceButtons.length === 0) {
            console.error('❌ No se encontraron botones de compliance');
            return;
        }
        
        complianceButtons.forEach((button, index) => {
            const field = button.dataset.field;
            const action = button.dataset.action;
            
            console.log(`🔘 Botón ${index + 1}: campo="${field}", acción="${action}"`);
            
            button.addEventListener('click', function(e) {
                console.log(`🎯 Click en botón: campo="${field}", acción="${action}"`);
                
                try {
                    if (action === 'comentario') {
                        // Abrir modal para comentario
                        abrirModalComentario(field);
                    } else {
                        // Calificar campo como bueno o malo
                        calificarCampo(field, action);
                    }
                } catch (error) {
                    console.error('❌ Error al manejar click:', error);
                    alert('Error al procesar la acción. Ver consola para más detalles.');
                }
            });
        });
        
        // Inicializar modal de comentarios
        inicializarModalComentario();
        
        // Cargar estados existentes
        cargarEstadosCompliance();
        
        console.log('✅ Botones de compliance inicializados correctamente');
    }
    
    // Función para abrir modal de comentario
    function abrirModalComentario(field) {
        const modal = new bootstrap.Modal(document.getElementById('modalComentarioCompliance'));
        const campoNombre = document.getElementById('campo-nombre');
        const campoValor = document.getElementById('campo-valor');
        const comentarioTextarea = document.getElementById('comentario-compliance');
        
        // Obtener información del campo
        const fieldInfo = getFieldInfo(field);
        
        // Configurar modal
        campoNombre.textContent = fieldInfo.label;
        campoValor.textContent = fieldInfo.value;
        comentarioTextarea.value = fieldInfo.comentario || '';
        
        // Configurar botón de guardar
        const btnGuardar = document.getElementById('btn-guardar-comentario-compliance');
        btnGuardar.onclick = function() {
            const comentario = comentarioTextarea.value.trim();
            if (comentario) {
                guardarComentarioCompliance(field, comentario);
                modal.hide();
            } else {
                mostrarToast('Por favor ingrese un comentario', 'error');
            }
        };
        
        // Almacenar field actual
        modal._element.dataset.field = field;
        
        modal.show();
    }
    
    // Función para obtener información del campo
    function getFieldInfo(field) {
        const fieldMap = {
            'nombre': { label: 'Nombre Completo' },
            'cedula': { label: 'Cédula' },
            'canal': { label: 'Canal de Origen' },
            'monto': { label: 'Monto Solicitado' },
            'plazo': { label: 'Plazo' },
            'tasa': { label: 'Tasa de Interés' },
            'cuota': { label: 'Cuota Mensual' },
            'fecha': { label: 'Fecha de Inicio' },
            'etapa': { label: 'Etapa Actual' },
            'area': { label: 'Área Responsable' },
            'responsable': { label: 'Responsable' }
        };
        
        const info = fieldMap[field];
        if (!info) return { label: field, value: '-', comentario: '' };
        
        // Buscar el botón con el data-field y obtener el valor desde el elemento padre
        const button = document.querySelector(`[data-field="${field}"]`);
        let value = '-';
        
        if (button) {
            const infoRow = button.closest('.info-row-with-check');
            if (infoRow) {
                const valueElement = infoRow.querySelector('.info-value');
                if (valueElement) {
                    value = valueElement.textContent.trim();
                }
            }
        }
        
        return {
            label: info.label,
            value: value,
            comentario: '' // Se cargará desde la base de datos
        };
    }
    
    // Función para calificar campo
    function calificarCampo(field, estado) {
        console.log(`🔄 Calificando campo: "${field}" como "${estado}"`);
        
        const solicitudId = parseInt('{{ solicitud.id }}');
        console.log(`📋 Solicitud ID: ${solicitudId}`);
        
        const token = getCsrfToken();
        console.log(`🔐 Token CSRF: ${token ? 'Obtenido' : 'No encontrado'}`);
        
        if (!token) {
            console.error('❌ No se pudo obtener el token CSRF');
            mostrarToast('Error: No se pudo obtener el token de seguridad', 'error');
            return;
        }
        
        const url = `/workflow/api/solicitudes/${solicitudId}/calificar-campo/`;
        console.log(`🌐 URL: ${url}`);
        
        const payload = {
            campo: field,
            estado: estado
        };
        console.log(`📦 Datos a enviar:`, payload);
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': token
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            console.log(`📡 Respuesta HTTP: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log(`📊 Respuesta del servidor:`, data);
            
            if (data.success) {
                mostrarToast(`Campo "${field}" calificado como ${estado}`, 'success');
                actualizarEstadoBoton(field, estado);
            } else {
                console.error('❌ Error del servidor:', data.error);
                mostrarToast('Error al calificar campo: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Error de red:', error);
            mostrarToast('Error de red al calificar campo', 'error');
        });
    }
    
    // Función para guardar comentario de compliance
    function guardarComentarioCompliance(field, comentario) {
        const solicitudId = parseInt('{{ solicitud.id }}');
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/comentario-compliance/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                campo: field,
                comentario: comentario
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Comentario guardado exitosamente', 'success');
                marcarComentarioEnBoton(field, true);
            } else {
                mostrarToast('Error al guardar comentario: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarToast('Error de red al guardar comentario', 'error');
        });
    }
    
    // Función para actualizar estado visual del botón
    function actualizarEstadoBoton(field, estado) {
        const buttons = document.querySelectorAll(`[data-field="${field}"]`);
        
        buttons.forEach(button => {
            if (button.dataset.action === 'bueno' || button.dataset.action === 'malo') {
                button.classList.remove('active');
            }
        });
        
        const activeButton = document.querySelector(`[data-field="${field}"][data-action="${estado}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }
    
    // Función para marcar comentario en botón
    function marcarComentarioEnBoton(field, hasComment) {
        const commentButton = document.querySelector(`[data-field="${field}"][data-action="comentario"]`);
        if (commentButton) {
            if (hasComment) {
                commentButton.classList.add('has-comment');
            } else {
                commentButton.classList.remove('has-comment');
            }
        }
    }
    
    // Función para cargar estados existentes
    function cargarEstadosCompliance() {
        console.log('📋 Cargando estados de compliance...');
        const solicitudId = parseInt('{{ solicitud.id }}');
        
        const url = `/workflow/api/solicitudes/${solicitudId}/calificaciones/`;
        console.log(`🌐 URL calificaciones: ${url}`);
        
        fetch(url)
            .then(response => {
                console.log(`📡 Respuesta HTTP: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('📊 Calificaciones recibidas:', data);
                
                if (data.success) {
                    console.log(`✅ ${data.calificaciones.length} calificaciones encontradas`);
                    data.calificaciones.forEach(calificacion => {
                        console.log(`🔄 Actualizando estado: ${calificacion.campo} = ${calificacion.estado}`);
                        actualizarEstadoBoton(calificacion.campo, calificacion.estado);
                        if (calificacion.comentario) {
                            console.log(`💬 Marcando comentario para: ${calificacion.campo}`);
                            marcarComentarioEnBoton(calificacion.campo, true);
                        }
                    });
                } else {
                    console.error('❌ Error al obtener calificaciones:', data.error);
                }
            })
            .catch(error => {
                console.error('❌ Error cargando calificaciones:', error);
            });
    }
    
    // Función para inicializar modal de comentarios
    function inicializarModalComentario() {
        const comentarioTextarea = document.getElementById('comentario-compliance');
        const charCount = document.getElementById('char-count-compliance');
        
        if (comentarioTextarea && charCount) {
            comentarioTextarea.addEventListener('input', function() {
                charCount.textContent = this.value.length;
                
                if (this.value.length > 500) {
                    charCount.parentElement.classList.add('text-danger');
                } else {
                    charCount.parentElement.classList.remove('text-danger');
                }
            });
        }
    }
    
    // Inicializar nuevas funcionalidades
    inicializarComplianceButtons();
    inicializarValidacionDocumentos();
    cargarSolicitudesRelacionadas();
    
    // Asegurar que el DOM esté completamente cargado antes de inicializar comentarios
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                inicializarComentariosAnalistaCredito();
            }, 100);
        });
    } else {
        setTimeout(() => {
            inicializarComentariosAnalistaCredito();
        }, 100);
    }
    
    // Función para marcar todos los campos como bueno
    window.marcarTodosComoBueno = function() {
        if (!confirm('¿Está seguro de marcar todos los campos como "bueno"?')) {
            return;
        }
        
        const todosLosBotones = document.querySelectorAll('.btn-compliance.btn-good');
        let contador = 0;
        let promesas = [];
        
        todosLosBotones.forEach((boton) => {
            const field = boton.dataset.field;
            const action = boton.dataset.action;
            
            if (field && action === 'bueno') {
                // Crear promesa para calificar campo sin mostrar toast individual
                const promesa = calificarCampoSinToast(field, 'bueno');
                promesas.push(promesa);
                contador++;
            }
        });
        
        // Esperar a que todas las calificaciones se completen
        Promise.all(promesas).then(() => {
            mostrarToast(`${contador} campos marcados como "bueno"`, 'success');
        }).catch(error => {
            console.error('Error al marcar campos como bueno:', error);
            mostrarToast('Error al marcar algunos campos como "bueno"', 'error');
        });
    };
    
    // Función para calificar campo sin mostrar toast (versión interna)
    function calificarCampoSinToast(field, estado) {
        return new Promise((resolve, reject) => {
            console.log(`🔄 Calificando campo: "${field}" como "${estado}" (sin toast)`);
            
            const solicitudId = parseInt('{{ solicitud.id }}');
            const token = getCsrfToken();
            
            if (!token) {
                console.error('❌ No se pudo obtener el token CSRF');
                reject(new Error('No se pudo obtener el token de seguridad'));
                return;
            }
            
            const url = `/workflow/api/solicitudes/${solicitudId}/calificar-campo/`;
            const payload = {
                campo: field,
                estado: estado
            };
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': token
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actualizarEstadoBoton(field, estado);
                    resolve(data);
                } else {
                    console.error('❌ Error del servidor:', data.error);
                    reject(new Error(data.error));
                }
            })
            .catch(error => {
                console.error('❌ Error de red:', error);
                reject(error);
            });
        });
    }
    


    // Función de prueba para verificar el funcionamiento
    window.testCompliance = function() {
        console.log('🧪 Probando sistema de compliance...');
        mostrarToast('Sistema de compliance activo', 'success');
        
        // Probar calificación de campo
        setTimeout(() => {
            console.log('🎯 Probando calificación de campo...');
            calificarCampo('nombre', 'bueno');
        }, 2000);
    };
    
    console.log('✅ Sistema completo inicializado correctamente');
    console.log('💡 Consejo: Puedes probar el sistema con window.testCompliance()');
    
    // Mostrar notificación de que el sistema está listo
    setTimeout(() => {
        mostrarToast('Sistema de compliance inicializado', 'success');
    }, 1000);
});

// ==========================================
// FUNCIONALIDADES ADICIONALES
// ==========================================





// Función para inicializar validación de documentos
function inicializarValidacionDocumentos() {
    const validationButtons = document.querySelectorAll('.validation-btn');
    
    validationButtons.forEach(button => {
        button.addEventListener('click', function() {
            const doc = this.dataset.doc;
            const status = this.dataset.status;
            const docItem = this.closest('.documento-item');
            
            // Remover clase active de otros botones del mismo documento
            const otherButtons = docItem.querySelectorAll('.validation-btn');
            otherButtons.forEach(btn => btn.classList.remove('active'));
            
            // Agregar clase active al botón clickeado
            this.classList.add('active');
            
            // Guardar estado en localStorage
            localStorage.setItem(`doc_validation_${doc}`, status);
            
            // Mostrar notificación
            const statusText = status === 'valid' ? 'válido' : 'inválido';
            mostrarToast(`Documento "${doc}" marcado como ${statusText}`, status === 'valid' ? 'success' : 'error');
        });
        
        // Restaurar estado desde localStorage
        const doc = button.dataset.doc;
        const status = button.dataset.status;
        const saved = localStorage.getItem(`doc_validation_${doc}`);
        if (saved === status) {
            button.classList.add('active');
        }
    });
}

// Función para cargar solicitudes relacionadas
function cargarSolicitudesRelacionadas() {
    const cedula = '{{ solicitud.cliente_cedula|default:"123193" }}';
    
    // Simular carga de solicitudes relacionadas
    console.log(`🔍 Buscando solicitudes relacionadas para cédula: ${cedula}`);
    
    // En un escenario real, aquí haríamos una llamada AJAX al backend
    // fetch(`/workflow/api/solicitudes/relacionadas/?cedula=${cedula}`)
    //     .then(response => response.json())
    //     .then(data => {
    //         mostrarSolicitudesRelacionadas(data.solicitudes);
    //     });
    
    // Por ahora, las solicitudes están hardcodeadas en el HTML
    mostrarToast(`Solicitudes relacionadas cargadas para cédula ${cedula}`, 'info');
}

// Función para mostrar notificaciones toast mejoradas
function mostrarToast(mensaje, tipo = 'info') {
    const toastContainer = document.querySelector('.toast-container') || crearToastContainer();
    
    const iconos = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-triangle',
        info: 'fa-info-circle',
        warning: 'fa-exclamation-triangle'
    };
    
    const colores = {
        success: 'success',
        error: 'danger',
        info: 'info',
        warning: 'warning'
    };
    
    const toastHTML = `
        <div class="toast align-items-center text-bg-${colores[tipo]} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" style="border-radius: 12px;">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${iconos[tipo]} me-2"></i>
                    ${mensaje}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    // Mostrar toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: tipo === 'error' ? 5000 : 3000
    });
    toast.show();
    
    // Remover elemento después de que se oculte
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
        // Verificar si el contenedor está vacío y eliminarlo si no hay más toasts
        const container = document.querySelector('.toast-container');
        if (container && container.children.length === 0) {
            container.remove();
        }
    });
}

// Función para crear contenedor de toast si no existe
function crearToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '99999';
    document.body.appendChild(container);
    return container;
}

// ==========================================
// FUNCIONALIDADES COMENTARIOS ANALISTA CRÉDITO
// ==========================================

function inicializarComentariosAnalistaCredito() {
    console.log('🏥 Inicializando comentarios de analista de crédito...');
    
    try {
        // Verificar que todos los elementos necesarios existan
        const container = document.getElementById('lista-comentarios-analista-credito');
        const sinComentarios = document.getElementById('sin-comentarios-analista');
        const textarea = document.getElementById('comentario-analista-credito-text');
        const charCounter = document.getElementById('char-count-analista-credito');
        const formElement = document.getElementById('form-comentario-analista-credito');
        
        console.log('🔍 Verificando elementos del DOM:');
        console.log('- Container:', container ? '✅' : '❌');
        console.log('- Sin comentarios:', sinComentarios ? '✅' : '❌');
        console.log('- Textarea:', textarea ? '✅' : '❌');
        console.log('- Char counter:', charCounter ? '✅' : '❌');
        console.log('- Form:', formElement ? '✅' : '❌');
        
        // Verificar elementos críticos
        if (!container || !textarea || !formElement) {
            console.error('❌ Error: Elementos críticos no encontrados. Reintentando en 500ms...');
            setTimeout(() => {
                inicializarComentariosAnalistaCredito();
            }, 500);
            return;
        }
    
        if (!container) {
        console.error('❌ Error crítico: No se encontró el contenedor de comentarios');
        return;
    }
    
    // Configurar contador de caracteres
    if (textarea && charCounter) {
        textarea.addEventListener('input', function() {
            charCounter.textContent = this.value.length;
            
            if (this.value.length > 1800) {
                charCounter.parentElement.classList.add('text-danger');
            } else if (this.value.length > 1500) {
                charCounter.parentElement.classList.add('text-warning');
                charCounter.parentElement.classList.remove('text-danger');
            } else {
                charCounter.parentElement.classList.remove('text-warning', 'text-danger');
            }
        });
    }
    
    // Configurar botón cancelar
    const btnCancelar = document.getElementById('btn-cancelar-analista-credito');
    if (btnCancelar) {
        btnCancelar.addEventListener('click', function() {
            if (textarea) {
                textarea.value = '';
                charCounter.textContent = '0';
                charCounter.parentElement.classList.remove('text-warning', 'text-danger');
            }
        });
    }
    
    // Configurar formulario
    const form = document.getElementById('form-comentario-analista-credito');
    if (form) {
        form.addEventListener('submit', enviarComentarioAnalistaCredito);
    }
    
    // Cargar comentarios existentes
    cargarComentariosAnalistaCredito();
    
    console.log('✅ Comentarios de analista de crédito inicializados');
    
    } catch (error) {
        console.error('❌ Error al inicializar comentarios de analista de crédito:', error);
        mostrarToast('Error al inicializar comentarios de analista', 'error');
    }
}

function cargarComentariosAnalistaCredito() {
    console.log('📋 Cargando comentarios de analista de crédito...');
    
    const solicitudId = parseInt('{{ solicitud.id }}');
    
    fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios-analista-credito/`)
        .then(response => response.json())
        .then(data => {
            console.log('📊 Comentarios recibidos:', data);
            
            if (data.success) {
                mostrarComentariosAnalistaCredito(data.comentarios);
            } else {
                console.error('❌ Error al cargar comentarios:', data.error);
                mostrarToast('Error al cargar comentarios: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Error de red:', error);
            mostrarToast('Error de red al cargar comentarios', 'error');
        });
}

function enviarComentarioAnalistaCredito(event) {
    event.preventDefault();
    
    const textarea = document.getElementById('comentario-analista-credito-text');
    const btnEnviar = document.getElementById('btn-enviar-analista-credito');
    const spinner = btnEnviar.querySelector('.loading-spinner-analista');
    const iconoBoton = btnEnviar.querySelector('i:not(.loading-spinner-analista i)');
    
    // Generar comentario completo con bullet points
    const comentarioCompleto = generarComentarioCompleto();
    
    if (!comentarioCompleto) {
        return; // La función ya muestra el error
    }
    
    // Deshabilitar botón y mostrar spinner
    btnEnviar.disabled = true;
    if (spinner && iconoBoton) {
        spinner.style.display = 'inline-block';
        iconoBoton.style.display = 'none';
    }
    
    console.log('💾 Enviando comentario de analista de crédito:', comentarioCompleto);
    
    const solicitudId = parseInt('{{ solicitud.id }}');
    const token = getCsrfToken();
    
    fetch(`/workflow/api/solicitudes/${solicitudId}/comentario-analista-credito/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': token
        },
        body: JSON.stringify({
            comentario: comentarioCompleto
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('📋 Respuesta del servidor:', data);
        
        if (data.success) {
            mostrarToast('Comentario de analista guardado exitosamente', 'success');
            textarea.value = '';
            document.getElementById('char-count-analista-credito').textContent = '0';
            cargarComentariosAnalistaCredito();
        } else {
            mostrarToast('Error al guardar comentario: ' + (data.error || 'Error desconocido'), 'error');
        }
    })
    .catch(error => {
        console.error('❌ Error:', error);
        mostrarToast('Error de red al enviar comentario', 'error');
    })
    .finally(() => {
        // Rehabilitar botón y ocultar spinner
        btnEnviar.disabled = false;
        if (spinner && iconoBoton) {
            spinner.style.display = 'none';
            iconoBoton.style.display = 'inline-block';
        }
    });
}

function mostrarComentariosAnalistaCredito(comentarios) {
    try {
        console.log('📋 Mostrando comentarios de analista de crédito...', comentarios);
        
        const container = document.getElementById('lista-comentarios-analista-credito');
        const sinComentarios = document.getElementById('sin-comentarios-analista');
        
        // Verificar que el container existe
        if (!container) {
            console.error('❌ Error: No se encontró el elemento lista-comentarios-analista-credito');
            // Intentar recargar después de un momento
            setTimeout(() => {
                const containerRetry = document.getElementById('lista-comentarios-analista-credito');
                if (containerRetry) {
                    mostrarComentariosAnalistaCredito(comentarios);
                } else {
                    console.error('❌ Error: Elemento aún no existe después del reintento');
                }
            }, 500);
            return;
        }
        
        // Verificar que comentarios es un array
        if (!Array.isArray(comentarios)) {
            console.error('❌ Error: comentarios no es un array:', comentarios);
            return;
        }
        
        if (comentarios.length === 0) {
            if (sinComentarios) {
                sinComentarios.style.display = 'block';
            }
            container.innerHTML = '';
            return;
        }
        
        if (sinComentarios) {
            sinComentarios.style.display = 'none';
        }
        
        const comentariosHTML = comentarios.map((comentario, index) => {
            const numeroComentario = index + 1;
            const fechaFormateada = new Date(comentario.fecha_creacion).toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            return `
                <div class="comentario-analista-item">
                    <div class="comentario-analista-header">
                        <div class="comentario-analista-author">
                            <div class="comentario-analista-avatar">
                                <i class="fas fa-user-md"></i>
                            </div>
                            <div class="comentario-analista-info">
                                <strong>${comentario.usuario_nombre || 'Usuario'}</strong>
                                <small>${fechaFormateada}</small>
                            </div>
                        </div>
                        <div class="comentario-analista-numero">
                            Comentario ${numeroComentario}
                        </div>
                    </div>
                    <div class="comentario-analista-text">
                        ${(comentario.comentario || '').replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = comentariosHTML;
        
        // Animar entrada de comentarios
        const items = container.querySelectorAll('.comentario-analista-item');
        items.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateY(20px)';
            setTimeout(() => {
                item.style.transition = 'all 0.3s ease';
                item.style.opacity = '1';
                item.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        console.log('✅ Comentarios mostrados correctamente');
        
    } catch (error) {
        console.error('❌ Error al mostrar comentarios de analista de crédito:', error);
        mostrarToast('Error al mostrar comentarios', 'error');
    }
}
</script>

<style>
/* ============================== */
/* ESTILOS ÉPICOS DE ANÁLISIS    */
/* ============================== */

/* Variables de colores - TONALIDADES AZULES */
:root {
    --color-blue-primary: #3b82f6;
    --color-blue-light: #dbeafe;
    --color-blue-dark: #1e40af;
    --color-blue-darker: #1e3a8a;
    --color-blue-accent: #60a5fa;
    --color-blue-soft: #93c5fd;
    --color-warning: #3b82f6;
    --color-danger: #ef4444;
    --color-success: #3b82f6;
    --shadow-epic: 0 10px 40px rgba(0, 0, 0, 0.1);
    --shadow-hover: 0 20px 60px rgba(0, 0, 0, 0.15);
    --border-radius: 16px;
    --gradient-blue-primary: linear-gradient(135deg, #3b82f6, #1e40af);
    --gradient-blue-light: linear-gradient(135deg, #60a5fa, #3b82f6);
    --gradient-blue-dark: linear-gradient(135deg, #1e40af, #1e3a8a);
}

/* Timeline Horizontal Épico */
.workflow-timeline-section {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0);
    border-radius: var(--border-radius);
    padding: 2rem;
    border: 1px solid #e2e8f0;
    position: relative;
    overflow: hidden;
}

.workflow-timeline-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-blue-primary);
}

.timeline-icon-main {
    width: 64px;
    height: 64px;
    background: var(--gradient-blue-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    box-shadow: var(--shadow-epic);
}

.horizontal-timeline {
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    overflow-x: auto;
    padding: 2rem 0;
    gap: 1rem;
}

.timeline-track {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 4px;
    background: #e2e8f0;
    z-index: 1;
    transform: translateY(-50%);
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
    min-width: 120px;
}

.step-circle {
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.timeline-step.completed .step-circle {
    background: var(--gradient-green);
    color: white;
    box-shadow: 0 8px 30px rgba(34, 197, 94, 0.3);
    transform: scale(1.1);
}

.timeline-step.active .step-circle {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: white;
    box-shadow: 0 8px 30px rgba(251, 191, 36, 0.4);
    transform: scale(1.15);
    animation: pulse 2s infinite;
}

.timeline-step.pending .step-circle {
    background: #f1f5f9;
    color: #64748b;
    border: 3px solid #e2e8f0;
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 8px 30px rgba(251, 191, 36, 0.4); }
    50% { box-shadow: 0 8px 40px rgba(251, 191, 36, 0.6); }
}

.step-icon {
    font-size: 1.5rem;
}

.step-number {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    background: rgba(255, 255, 255, 0.9);
    color: #1f2937;
    border-radius: 50%;
    font-size: 0.75rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}

.step-content {
    text-align: center;
}

.step-title {
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.step-sla {
    color: #64748b;
    font-size: 0.75rem;
}

/* Epic Cards */
.epic-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-epic);
    border: none;
    overflow: hidden;
    transition: all 0.3s ease;
    height: 100%;
}

.epic-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-hover);
}

.epic-card.card-green {
    border-top: 4px solid var(--color-green);
}

.epic-card.card-blue {
    border-top: 4px solid var(--color-blue);
}

.epic-card.card-orange {
    border-top: 4px solid var(--color-orange);
}

.epic-card-header {
    display: flex;
    align-items: center;
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    border-bottom: 1px solid #e2e8f0;
}

.epic-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
    margin-right: 1rem;
    flex-shrink: 0;
}

.card-green .epic-icon {
    background: var(--gradient-green);
}

.card-blue .epic-icon {
    background: var(--gradient-blue);
}

.card-orange .epic-icon {
    background: var(--gradient-orange);
}

.epic-title h6 {
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
    font-size: 1rem;
}

.epic-title small {
    color: #64748b;
    font-size: 0.875rem;
}

.epic-card-body {
    padding: 1.5rem;
}

.epic-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 1.25rem;
    padding: 0.75rem;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.epic-item:hover {
    background: #f8fafc;
}

.epic-item:last-child {
    margin-bottom: 0;
}

.epic-item i {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    font-size: 1rem;
    flex-shrink: 0;
}

.epic-item .label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
}

.epic-item strong {
    color: #1f2937;
    font-weight: 600;
    font-size: 0.875rem;
}

/* SLA Status Card */
.sla-status-card {
    background: linear-gradient(135deg, #ffffff, #f8fafc);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-epic);
    border: 1px solid #e2e8f0;
    position: relative;
    overflow: hidden;
}

.sla-status-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #06b6d4, #0891b2);
}

.sla-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.sla-icon {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #06b6d4, #0891b2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    margin-right: 1rem;
}

.sla-info h5 {
    color: #1f2937;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.sla-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.875rem;
}

.sla-badge.sla-success {
    background: var(--color-green-light);
    color: var(--color-success);
}

.sla-badge.sla-warning {
    background: #fef3c7;
    color: var(--color-warning);
}

.sla-badge.sla-danger {
    background: #fecaca;
    color: var(--color-danger);
}

.sla-badge.sla-muted {
    background: #f1f5f9;
    color: #64748b;
}

.sla-progress {
    background: #f1f5f9;
    border-radius: 10px;
    height: 8px;
    position: relative;
    margin: 1rem 0;
    overflow: hidden;
}

.progress-bar-epic {
    height: 100%;
    background: linear-gradient(135deg, #06b6d4, #0891b2);
    border-radius: 10px;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 0.75rem;
    color: #64748b;
    text-align: center;
    margin-top: 0.5rem;
    display: block;
}

.sla-details {
    color: #64748b;
    font-size: 0.875rem;
    margin-top: 1rem;
}

/* Sidebar Epic Cards */
.epic-card-sidebar {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-epic);
    border: none;
    overflow: hidden;
    border-top: 4px solid var(--color-warning);
}

.epic-card-header-sidebar {
    display: flex;
    align-items: center;
    padding: 1.5rem;
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border-bottom: 1px solid #e2e8f0;
}

.epic-icon-sidebar {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
    margin-right: 1rem;
}

.epic-title-sidebar h6 {
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.epic-title-sidebar small {
    color: #64748b;
}

.epic-card-body-sidebar {
    padding: 1.5rem;
}

/* Comment Form Epic */
.comment-form-epic {
    margin-bottom: 2rem;
}

.form-group-epic {
    margin-bottom: 1rem;
}

.form-label-epic {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.form-control-epic {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    background: #fafafa;
}

.form-control-epic:focus {
    outline: none;
    border-color: var(--color-warning);
    box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
    background: white;
}

.btn-epic {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-epic.btn-success {
    background: var(--gradient-green);
    color: white;
}

.btn-epic.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
}

/* Comments Epic */
.comments-epic {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.comment-epic {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
}

.comment-epic:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
}

.comment-header-epic {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.comment-author-epic {
    display: flex;
    align-items: center;
    flex: 1;
}

.author-avatar-epic {
    width: 32px;
    height: 32px;
    background: var(--gradient-blue);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.875rem;
    margin-right: 0.75rem;
}

.author-info-epic strong {
    display: block;
    color: #1f2937;
    font-size: 0.875rem;
    font-weight: 600;
}

.author-info-epic small {
    color: #64748b;
    font-size: 0.75rem;
}

.comment-actions-epic {
    display: flex;
    gap: 0.25rem;
}

.btn-icon-epic {
    width: 28px;
    height: 28px;
    border: none;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-icon-epic:hover {
    background: rgba(0, 0, 0, 0.1);
    color: #374151;
}

.btn-icon-epic.btn-danger:hover {
    background: #fecaca;
    color: #dc2626;
}

.comment-content-epic {
    color: #374151;
    font-size: 0.875rem;
    line-height: 1.6;
}

.empty-state-epic {
    text-align: center;
    padding: 2rem;
    color: #9ca3af;
}

.empty-state-epic i {
    margin-bottom: 0.5rem;
    opacity: 0.6;
}

/* Text Colors */
.text-blue { color: var(--color-blue) !important; }
.text-orange { color: var(--color-orange) !important; }

/* Responsive */
@media (max-width: 768px) {
    .horizontal-timeline {
        flex-direction: column;
        gap: 2rem;
    }
    
    .timeline-track {
        display: none;
    }
    
    .epic-card-header {
        padding: 1rem;
    }
    
    .epic-card-body {
        padding: 1rem;
    }
    
    .step-circle {
        width: 60px;
        height: 60px;
    }
    
    .step-icon {
        font-size: 1.25rem;
    }
}

/* Scrollbar personalizada */
.comments-epic::-webkit-scrollbar {
    width: 6px;
}

.comments-epic::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.comments-epic::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.comments-epic::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* ========================================
   ESTILOS PARA LA NUEVA ESTRUCTURA
   ======================================== */

/* TARJETA UNIFICADA */
.unified-info-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    border: 1px solid #e5e7eb;
    height: 420px;
    display: flex;
    flex-direction: column;
}

.unified-header {
    background: linear-gradient(135deg, #1e40af, #3b82f6);
    color: white;
    padding: 0.6rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.unified-icon {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    margin-right: 0.75rem;
}

.unified-title h3 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
}

.unified-sla {
    text-align: right;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.unified-sla .sla-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
}

.unified-body {
    padding: 1.5rem;
    flex: 1;
    overflow-y: auto;
}

.info-section {
    height: 100%;
}

/* Encabezados sticky para las secciones principales */
.section-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f3f4f6;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(15px);
    position: sticky;
    top: -25px;
    z-index: 200;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-top: 3px solid #1e40af;
}

.section-header i {
    font-size: 1.25rem;
    margin-right: 0.75rem;
}

.section-header h5 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    color: #1f2937;
}

.adjuntos-title h5 {
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
}

.section-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
}

.info-label {
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
    flex: 1;
}

.info-value {
    font-size: 0.875rem;
    color: #111827;
    font-weight: 600;
    text-align: right !important;
    flex: 1;
    direction: ltr;
}

/* TIMELINE SÚPER ANGOSTO HORIZONTALMENTE */
.compact-timeline-section {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    border: 1px solid #e5e7eb;
    /* Mismo formato que unified-info-card */
}

.timeline-header {
    background: linear-gradient(135deg, #1e40af, #3b82f6);
    color: white;
    padding: 0.4rem 0.8rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0;
}

.timeline-header h5 {
    font-size: 0.9rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    color: white;
}

.timeline-header h5 i {
    margin-right: 0.4rem;
    font-size: 0.85rem;
}

.timeline-header h5::after {
    display: none; /* Quitar la línea decorativa */
}

/* TIMELINE SÚPER DELGADO Y HORIZONTAL */
.slim-timeline {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 0.4rem 1.2rem;
    margin: 0 auto;
    gap: 0;
    max-width: 100%;
}

/* LÍNEA CONECTORA SÚPER DELGADA */
.slim-timeline::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 1.5rem;
    right: 1.5rem;
    height: 1px;
    background: linear-gradient(90deg, 
        #22c55e 0%, 
        #22c55e 30%, 
        #f59e0b 30%, 
        #f59e0b 60%, 
        #94a3b8 60%, 
        #94a3b8 100%
    );
    z-index: 1;
    transform: translateY(-50%);
}

/* PASO DEL TIMELINE */
.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
    flex: 1;
    transition: all 0.3s ease;
}

.timeline-step:hover {
    transform: translateY(-2px);
}

/* PUNTO/ICONO DEL PASO */
.step-dot {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6rem;
    margin-bottom: 0.25rem;
    position: relative;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

/* ESTADOS DE LOS PUNTOS */
.timeline-step.completed .step-dot {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    box-shadow: 0 3px 12px rgba(34, 197, 94, 0.3);
}

.timeline-step.active .step-dot {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    box-shadow: 0 3px 12px rgba(245, 158, 11, 0.4);
    animation: activePulse 2s ease-in-out infinite alternate;
}

.timeline-step.pending .step-dot {
    background: #f8fafc;
    color: #9ca3af;
    border-color: #e5e7eb;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

@keyframes activePulse {
    0% {
        box-shadow: 0 3px 12px rgba(245, 158, 11, 0.4);
    }
    100% {
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
    }
}

/* ETIQUETA DEL PASO */
.step-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 0.05rem;
}

.step-name {
    font-size: 0.65rem;
    font-weight: 600;
    color: #374151;
    line-height: 1.1;
    word-break: break-word;
    max-width: 70px;
}

.step-sla {
    font-size: 0.55rem;
    font-weight: 400;
    color: #9ca3af;
    background: rgba(255, 255, 255, 0.8);
    padding: 0.05rem 0.25rem;
    border-radius: 3px;
    border: 1px solid rgba(0, 0, 0, 0.05);
    white-space: nowrap;
}

/* COLORES PARA DIFERENTES ESTADOS */
.timeline-step.completed .step-name {
    color: #166534;
}

.timeline-step.completed .step-sla {
    color: #166534;
    background: rgba(34, 197, 94, 0.1);
    border-color: rgba(34, 197, 94, 0.2);
}

.timeline-step.active .step-name {
    color: #92400e;
    font-weight: 700;
}

.timeline-step.active .step-sla {
    color: #92400e;
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.2);
}

.timeline-step.pending .step-name {
    color: #9ca3af;
}

.timeline-step.pending .step-sla {
    color: #9ca3af;
    background: rgba(0, 0, 0, 0.02);
    border-color: rgba(0, 0, 0, 0.05);
}



/* SISTEMA DE PESTAÑAS */
.tabs-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.tabs-header {
    display: flex;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.tab-button {
    flex: 1;
    padding: 1rem 1.5rem;
    background: none;
    border: none;
    color: #6b7280;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 3px solid transparent;
}

.tab-button:hover {
    color: #374151;
    background: #f3f4f6;
}

.tab-button.active {
    color: #1f2937;
    background: white;
    border-bottom-color: #3b82f6;
    font-weight: 600;
}

.tabs-content {
    background: white;
}

.tab-pane {
    display: none;
    padding: 1.5rem;
    min-height: 400px;
}

.tab-pane.active {
    display: block;
}

/* CONTENIDO DE PESTAÑAS */
.historial-content,
.comentarios-content,
.documentos-content {
    max-height: 500px;
    overflow-y: auto;
}

.historial-item,
.comentario-item,
.documento-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid #f3f4f6;
}

.historial-item:last-child,
.comentario-item:last-child,
.documento-item:last-child {
    border-bottom: none;
}

.historial-avatar,
.comentario-avatar,
.documento-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.historial-avatar,
.comentario-avatar {
    background: #e5e7eb;
    color: #6b7280;
}

.documento-icon {
    background: #fee2e2;
    color: #dc2626;
    border-radius: 8px;
}

.historial-details,
.comentario-details,
.documento-details {
    flex: 1;
}

.historial-header,
.comentario-header,
.documento-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.historial-header strong,
.comentario-header strong,
.documento-header strong {
    color: #1f2937;
    font-weight: 600;
}

.historial-date,
.comentario-date,
.documento-size {
    color: #6b7280;
    font-size: 0.875rem;
}

.historial-info,
.comentario-text,
.documento-obs {
    color: #374151;
    font-size: 0.875rem;
    line-height: 1.5;
}

.documento-actions {
    display: flex;
    gap: 0.5rem;
}

.comentario-form {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
}

.comentario-form .form-group {
    margin-bottom: 1rem;
}

.comentario-form .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.875rem;
    resize: vertical;
}

.comentario-form .form-control:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-actions {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
}

.documento-upload {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #9ca3af;
}

.empty-state i {
    margin-bottom: 1rem;
    opacity: 0.6;
}

.empty-state p {
    font-size: 0.875rem;
    margin: 0;
}

/* BOTONES DE ACCIÓN */
.action-buttons-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    border: 1px solid #e5e7eb;
}

.action-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
}

.action-btn {
    padding: 0.875rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.action-btn.btn-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.action-btn.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
}

.action-btn.btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.action-btn.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
}

.action-btn.btn-outline-primary {
    background: white;
    color: #3b82f6;
    border: 2px solid #3b82f6;
}

.action-btn.btn-outline-primary:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-2px);
}

/* RESPONSIVE */
@media (max-width: 1024px) {
    .compact-timeline {
        margin: 0 1rem;
    }
    
    .compact-timeline::before {
        left: 2rem;
        right: 2rem;
    }
    
    .timeline-item {
        max-width: 160px;
    }
    
    .timeline-stage {
        padding: 1rem 0.75rem;
    }
    
    .timeline-dot {
        width: 48px;
        height: 48px;
        font-size: 1rem;
    }
    
    .timeline-title {
        font-size: 0.875rem;
    }
}

@media (max-width: 768px) {
    .unified-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .unified-body {
        padding: 1rem;
    }
    
    .compact-timeline-section {
        padding: 2rem 1rem;
        margin-bottom: 1rem;
    }
    
    .timeline-header h5 {
        font-size: 1.3rem;
    }
    
    .compact-timeline {
        flex-direction: column;
        align-items: stretch;
        margin: 0 auto;
        gap: 1rem;
        padding: 1rem 0;
        max-width: 80%;
    }
    
    .compact-timeline::before {
        display: none;
    }
    
    .timeline-item {
        max-width: 100%;
        transform: none !important;
    }
    
    .timeline-item:hover {
        transform: none;
    }
    
    .timeline-stage {
        padding: 1.5rem 1rem;
    }
    
    .timeline-dot {
        width: 56px;
        height: 56px;
        font-size: 1.25rem;
    }
    
    .timeline-title {
        font-size: 1rem;
    }
    
    /* Mobile Timeline Connector */
    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        bottom: -1rem;
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        height: 1.5rem;
        background: linear-gradient(180deg, transparent 0%, #e5e7eb 50%, transparent 100%);
    }
    
    .timeline-item.completed:not(:last-child)::after {
        background: linear-gradient(180deg, transparent 0%, #22c55e 50%, transparent 100%);
    }
    
    .timeline-item.active:not(:last-child)::after {
        background: linear-gradient(180deg, transparent 0%, #f59e0b 50%, transparent 100%);
    }
    
    .tabs-header {
        flex-direction: column;
    }
    
    .tab-button {
        text-align: left;
    }
    
    .action-grid {
        grid-template-columns: 1fr;
    }
    
    .historial-item,
    .comentario-item,
    .documento-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .historial-avatar,
    .comentario-avatar,
    .documento-icon {
        align-self: center;
    }
}

/* ANIMACIONES */
@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

/* SCROLLBAR PERSONALIZADA */
.historial-content::-webkit-scrollbar,
.comentarios-content::-webkit-scrollbar,
.documentos-content::-webkit-scrollbar {
    width: 6px;
}

.historial-content::-webkit-scrollbar-track,
.comentarios-content::-webkit-scrollbar-track,
.documentos-content::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.historial-content::-webkit-scrollbar-thumb,
.comentarios-content::-webkit-scrollbar-thumb,
.documentos-content::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.historial-content::-webkit-scrollbar-thumb:hover,
.comentarios-content::-webkit-scrollbar-thumb:hover,
.documentos-content::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* ========================================
   ESTILOS MODERNOS PARA COMENTARIOS
   ======================================== */

/* Header de comentarios */
.comentarios-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0 1.5rem 0;
    border-bottom: 2px solid #f1f5f9;
    margin-bottom: 1.5rem;
}

.header-info h6 {
    color: #1f2937;
    font-weight: 700;
    margin: 0;
}

.header-info small {
    color: #6b7280;
    font-size: 0.875rem;
}

.comentarios-count .badge {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
}

/* Formulario moderno de comentarios */
.comentario-form-modern {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    margin-bottom: 2rem;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.comentario-form-modern:focus-within {
    border-color: #3b82f6;
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
}

.form-header {
    display: flex;
    align-items: center;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    border-bottom: 1px solid #e5e7eb;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    margin-right: 0.75rem;
}

.user-info strong {
    display: block;
    color: #1f2937;
    font-weight: 600;
}

.user-info small {
    color: #6b7280;
    font-size: 0.75rem;
}

.form-body {
    padding: 1.5rem;
}

.form-control-modern {
    width: 100%;
    padding: 1rem;
    border: 2px solid #f1f5f9;
    border-radius: 12px;
    font-size: 0.875rem;
    line-height: 1.6;
    resize: vertical;
    transition: all 0.3s ease;
    background: #fafbfc;
}

.form-control-modern:focus {
    outline: none;
    border-color: #3b82f6;
    background: white;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.char-counter {
    text-align: right;
    margin-top: 0.5rem;
}

.form-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: #fafbfc;
    border-top: 1px solid #e5e7eb;
}

.form-actions-left,
.form-actions-right {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.btn-action-secondary {
    padding: 0.5rem 1rem;
    background: none;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    color: #6b7280;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-action-secondary:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
    color: #374151;
}

.btn-cancel {
    padding: 0.5rem 1rem;
    background: none;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    color: #6b7280;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-cancel:hover {
    background: #fee2e2;
    border-color: #fca5a5;
    color: #dc2626;
}

.btn-enviar {
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-enviar:hover:not(:disabled) {
    background: linear-gradient(135deg, #16a34a, #15803d);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.btn-enviar:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.loading-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Lista de comentarios moderna */
.comentarios-lista {
    max-height: 600px;
    overflow-y: auto;
}

.comentario-item-modern {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.2s ease;
}

.comentario-item-modern:hover {
    background: #fafbfc;
}

.comentario-item-modern:last-child {
    border-bottom: none;
}

.comentario-avatar-modern {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e5e7eb, #d1d5db);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.comentario-content-modern {
    flex: 1;
}

.comentario-header-modern {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.author-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.author-name {
    color: #1f2937;
    font-weight: 600;
}

.author-role {
    background: #e0f2fe;
    color: #0277bd;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.comentario-date-modern {
    color: #9ca3af;
    font-size: 0.875rem;
}

.comentario-actions {
    display: flex;
    gap: 0.25rem;
}

.btn-action-mini {
    width: 32px;
    height: 32px;
    border: none;
    background: none;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-action-mini:hover {
    background: #f3f4f6;
    color: #6b7280;
}

.btn-action-mini.text-danger:hover {
    background: #fee2e2;
    color: #dc2626;
}

.comentario-text-modern {
    color: #374151;
    line-height: 1.6;
    margin-bottom: 1rem;
    font-size: 0.875rem;
}

.comentario-footer-modern {
    display: flex;
    gap: 1rem;
}

.btn-reaction {
    background: none;
    border: none;
    color: #9ca3af;
    font-size: 0.875rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
}

.btn-reaction:hover {
    background: #f3f4f6;
    color: #6b7280;
}

/* Estado vacío moderno */
.empty-state-modern {
    text-align: center;
    padding: 3rem 2rem;
    color: #9ca3af;
}

.empty-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f1f5f9, #e5e7eb);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    font-size: 2rem;
    color: #d1d5db;
}

.empty-state-modern h6 {
    color: #6b7280;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.empty-state-modern p {
    color: #9ca3af;
    font-size: 0.875rem;
    margin: 0;
}

/* Notificaciones toast */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    color: white;
    font-weight: 500;
    z-index: 99999;
    transform: translateX(400px);
    transition: all 0.3s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    word-wrap: break-word;
}

.toast-notification.show {
    transform: translateX(0);
}

.toast-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.toast-error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.toast-content {
    display: flex;
    align-items: center;
}

/* Responsive */
@media (max-width: 768px) {
    .comentarios-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .form-footer {
        flex-direction: column;
        gap: 1rem;
    }
    
    .form-actions-left,
    .form-actions-right {
        width: 100%;
        justify-content: center;
    }
    
    .form-actions-right {
        flex-direction: row-reverse;
    }
    
    .comentario-item-modern {
        padding: 1rem;
    }
    
    .author-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }
    
    .toast-notification {
        left: 20px;
        right: 20px;
        transform: translateY(-100px);
    }
    
    .toast-notification.show {
        transform: translateY(0);
    }
}



/* ==========================================
   CHAT MODERNO - COMENTARIOS GENERALES
   ========================================== */

.chat-container-general {
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e9ecef;
    height: 400px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Header del Chat General */
.chat-header-general {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 16px 16px 0 0;
}

.chat-title-general {
    display: flex;
    align-items: center;
    font-weight: 600;
    font-size: 0.85rem;
}

.chat-info {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.8rem;
}

/* Área de Mensajes Generales */
.chat-messages-general {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
}

.chat-welcome-general {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: #e8f5e9;
    border-radius: 12px;
    margin-bottom: 20px;
    border-left: 4px solid #4caf50;
}

.welcome-avatar-general {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4caf50, #388e3c);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.welcome-message-general p {
    margin: 0;
    color: #2e7d32;
    font-size: 0.8rem;
    line-height: 1.3;
}

.welcome-message-general p:first-child {
    font-weight: 600;
    margin-bottom: 4px;
}

/* Input Container General */
.chat-input-container-general {
    background: white;
    border-top: 1px solid #e9ecef;
    padding: 12px 16px;
    border-radius: 0 0 16px 16px;
}

.chat-form-general {
    margin: 0;
}

.input-group-chat-general {
    display: flex;
    align-items: flex-end;
    gap: 12px;
}

.user-avatar-chat-general {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #28a745, #20c997);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    flex-shrink: 0;
}

.input-wrapper-general {
    flex: 1;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 20px;
    padding: 8px 16px;
    transition: all 0.2s ease;
}

.input-wrapper-general:focus-within {
    border-color: #28a745;
    background: white;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

.chat-input-general {
    width: 100%;
    border: none;
    background: transparent;
    resize: none;
    outline: none;
    font-size: 0.9rem;
    line-height: 1.4;
    max-height: 120px;
    overflow-y: auto;
}

.input-actions-general {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
}

.attachment-button,
.mention-button {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

.attachment-button:hover,
.mention-button:hover {
    background: #e9ecef;
    color: #28a745;
}

.char-counter-general {
    font-size: 0.75rem;
    color: #6c757d;
    margin-left: auto;
    margin-right: 8px;
}

.send-button-general {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

.send-button-general:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.send-button-general:active {
    transform: scale(0.95);
}

.loading-spinner-chat-general {
    display: none;
}

/* Scrollbar personalizado para chat general */
.chat-messages-general::-webkit-scrollbar {
    width: 6px;
}

.chat-messages-general::-webkit-scrollbar-track {
    background: transparent;
}

.chat-messages-general::-webkit-scrollbar-thumb {
    background: #dee2e6;
    border-radius: 3px;
}

.chat-messages-general::-webkit-scrollbar-thumb:hover {
    background: #adb5bd;
}

/* Animaciones y efectos */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.message-bubble {
    animation: fadeInUp 0.3s ease;
}

.message-bubble.own {
    animation: slideInRight 0.3s ease;
}

.message-bubble.other {
    animation: slideInLeft 0.3s ease;
}

/* Mejoras responsive */
@media (max-width: 1199px) {
    .chat-container-analista {
        height: calc(100vh - 250px);
    }
}

@media (max-width: 991px) {
    .chat-container-analista {
        position: static;
        height: 420px;
        margin-top: 20px;
        margin-bottom: 20px;
    }
    
    .chat-container-general {
        height: 400px;
    }
    
    .message-bubble {
        max-width: 90%;
    }
    
    .chat-header,
    .chat-header-general {
        padding: 12px 16px;
    }
    
    .chat-title,
    .chat-title-general {
        font-size: 0.9rem;
    }
    
    .chat-input-container,
    .chat-input-container-general {
        padding: 12px 16px;
    }
    
    .input-group-chat,
    .input-group-chat-general {
        gap: 8px;
    }
    
    .user-avatar-chat,
    .user-avatar-chat-general {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }
    
    .send-button,
    .send-button-general {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
    }
}

@media (max-width: 767px) {
    .chat-container-analista,
    .chat-container-general {
        height: 350px;
    }
    
    .message-bubble {
        max-width: 95%;
    }
    
    .message-content {
        padding: 10px 14px;
        font-size: 0.85rem;
    }
    
    .message-meta {
        font-size: 0.7rem;
    }
    
    .chat-welcome-general {
        padding: 12px;
        margin-bottom: 16px;
    }
    
    .welcome-avatar-general {
        width: 32px;
        height: 32px;
        font-size: 1rem;
    }
    
    .welcome-message-general p {
        font-size: 0.8rem;
    }
}

/* ===============================================
   ESTILOS PARA LAS NUEVAS FUNCIONALIDADES
   =============================================== */

/* Estilos para botones de compliance */
.info-row-with-check {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    padding: 8px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}

.compliance-actions {
    display: flex;
    gap: 4px;
    margin-left: 16px;
    flex-shrink: 0;
}

.info-row-with-check:hover {
    background-color: #f8f9fa;
}

.info-data {
    flex: 1;
}

.info-data .info-label {
    font-weight: 500;
    color: #6c757d;
    font-size: 0.85rem;
    text-align: left;
}

.info-data .info-value {
    font-weight: 600;
    color: #212529;
    font-size: 0.9rem;
    text-align: left;
}

.compliance-actions {
    display: flex;
    gap: 4px;
    margin-left: 16px;
    flex-shrink: 0;
}

.btn-compliance {
    width: 24px;
    height: 24px;
    border: 2px solid #dee2e6;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.7rem;
    color: #6c757d;
    position: relative;
}

.btn-compliance:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.btn-compliance.btn-good {
    border-color: #3b82f6;
    color: #3b82f6;
}

.btn-compliance.btn-good:hover {
    background: #3b82f6;
    color: white;
}

.btn-compliance.btn-good.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.btn-compliance.btn-bad {
    border-color: #dc3545;
    color: #dc3545;
}

.btn-compliance.btn-bad:hover {
    background: #dc3545;
    color: white;
}

.btn-compliance.btn-bad.active {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
}

.btn-compliance.btn-comment {
    border-color: #1e40af;
    color: #1e40af;
}

.btn-compliance.btn-comment:hover {
    background: #1e40af;
    color: white;
}

.btn-compliance.btn-comment.has-comment {
    background: #1e40af;
    color: white;
    border-color: #1e40af;
}

.btn-compliance.btn-comment.has-comment::after {
    content: '';
    position: absolute;
    top: -2px;
    right: -2px;
    width: 6px;
    height: 6px;
    background: #ffc107;
    border-radius: 50%;
    border: 1px solid white;
}

/* Animaciones para botones de compliance */
@keyframes pulseGreen {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

@keyframes pulseRed {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

@keyframes pulseBlue {
    0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
}

.btn-compliance.btn-good.active {
    animation: pulseGreen 1s;
}

.btn-compliance.btn-bad.active {
    animation: pulseRed 1s;
}

.btn-compliance.btn-comment.has-comment {
    animation: pulseBlue 1s;
}

/* Estilos para el modal de comentarios */
.modal-dialog.modal-lg {
    max-width: 600px;
}

.modal-header {
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    color: white;
    border-radius: 0.5rem 0.5rem 0 0;
}

/* Estilos para compliance en adjuntos */
.adjunto-status-line {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 4px;
    gap: 8px;
}

.adjunto-status-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.adjunto-status-line .compliance-actions {
    margin-left: 0;
    gap: 4px;
}

.adjunto-status-line .btn-compliance {
    width: 18px;
    height: 18px;
    font-size: 0.6rem;
}

.modal-title {
    font-weight: 600;
    font-size: 1.1rem;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: white;
    opacity: 0.8;
}

.btn-close:hover {
    opacity: 1;
}

.modal-body .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}

.modal-body .fw-bold {
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

.modal-body .text-primary {
    color: #3b82f6 !important;
}

.modal-body .form-control {
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 0.75rem;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.modal-body .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.modal-body .form-text {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.modal-footer {
    border-top: 1px solid #dee2e6;
    padding: 1rem 1.5rem;
}

.modal-footer .btn {
    padding: 0.5rem 1.5rem;
    font-weight: 600;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.modal-footer .btn-secondary {
    background: #6c757d;
    border-color: #6c757d;
}

.modal-footer .btn-secondary:hover {
    background: #5a6268;
    border-color: #545b62;
}

.modal-footer .btn-primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border-color: #007bff;
}

.modal-footer .btn-primary:hover {
    background: linear-gradient(135deg, #0056b3, #004085);
    border-color: #0056b3;
}

/* Tooltips para los botones */
.btn-compliance[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 1000;
    margin-bottom: 0.25rem;
}

/* Responsive para botones de compliance */
@media (max-width: 768px) {
    .btn-compliance {
        width: 22px;
        height: 22px;
        font-size: 0.65rem;
    }
    
    .compliance-actions {
        gap: 3px;
    }
    
    .info-row-with-check {
        padding: 6px;
    }
    
    .info-data .info-label,
    .info-data .info-value {
        font-size: 0.8rem;
    }
}

/* Estilos para la sección de upload de documentos */
.upload-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    border: 1px solid #e9ecef;
}

.upload-header h6 {
    color: #495057;
    margin-bottom: 16px;
    font-weight: 600;
}

.upload-zone {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.upload-zone:hover {
    border-color: #28a745;
    background: #f8fff9;
}

.upload-zone.drag-over {
    border-color: #28a745;
    background: #f8fff9;
    border-style: solid;
}

.upload-icon {
    font-size: 2rem;
    color: #6c757d;
    margin-bottom: 12px;
}

.upload-text {
    color: #495057;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.upload-link {
    color: #28a745;
    text-decoration: underline;
    cursor: pointer;
}

.upload-hint {
    color: #6c757d;
    font-size: 0.8rem;
}

/* Estilos para lista de documentos */
.documentos-list {
    background: white;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    overflow: hidden;
}

.documento-item {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #f1f3f4;
    transition: background-color 0.2s ease;
}

.documento-item:last-child {
    border-bottom: none;
}

.documento-item:hover {
    background-color: #f8f9fa;
}

.documento-icon {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 16px;
    font-size: 1.5rem;
}

.documento-details {
    flex: 1;
}

.documento-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 4px;
}

.documento-header strong {
    color: #212529;
    font-size: 0.95rem;
}

.documento-size {
    color: #6c757d;
    font-size: 0.8rem;
}

.documento-status {
    margin-top: 4px;
}

.documento-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.documento-validation {
    display: flex;
    gap: 4px;
}

.validation-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.8rem;
}

.validation-btn.valid {
    background: #e8f5e9;
    color: #2e7d32;
}

.validation-btn.valid:hover {
    background: #2e7d32;
    color: white;
}

.validation-btn.invalid {
    background: #ffebee;
    color: #c62828;
}

.validation-btn.invalid:hover {
    background: #c62828;
    color: white;
}

.validation-btn.active.valid {
    background: #2e7d32;
    color: white;
}

.validation-btn.active.invalid {
    background: #c62828;
    color: white;
}

/* Estilos para solicitudes relacionadas */
.related-requests-section {
    background: white;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    height: 420px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
}

.related-header {
    padding: 0.6rem 1rem;
    border-bottom: 1px solid #f1f3f4;
    background: linear-gradient(135deg, #1e40af, #3b82f6);
    color: white;
    border-radius: 12px 12px 0 0;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.related-header h5 {
    color: white;
    margin-bottom: 4px;
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
}

.related-header small {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.8rem;
    display: block;
}

.related-icon {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.related-title {
    flex: 1;
}

.related-content {
    padding: 16px 20px;
    flex: 1;
    overflow-y: auto;
}

.search-info {
    display: flex;
    align-items: center;
    color: #6c757d;
    font-size: 0.85rem;
    margin-bottom: 16px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
}

.search-info i {
    color: #28a745;
}

.related-list {
    margin-bottom: 20px;
}

.related-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #f1f3f4;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.related-item:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
}

.related-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.related-details {
    flex: 1;
}

.related-header-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 4px;
}

.related-header-item strong {
    color: #212529;
    font-size: 0.9rem;
}

.related-date {
    color: #6c757d;
    font-size: 0.75rem;
}

.related-info {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.related-amount {
    color: #495057;
    font-weight: 600;
    font-size: 0.85rem;
}

.related-description {
    color: #6c757d;
    font-size: 0.8rem;
    line-height: 1.3;
}

.related-actions {
    flex-shrink: 0;
}

.related-summary {
    border-top: 1px solid #f1f3f4;
    padding-top: 16px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.summary-label {
    color: #6c757d;
    font-size: 0.85rem;
}

.summary-value {
    font-weight: 600;
    font-size: 0.9rem;
    color: #212529;
}

/* SECCIÓN COMPACTA DE COMENTARIOS DE ANALISTA */
.comentarios-analista-section-compact {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    height: 420px;
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.comentarios-analista-header-compact {
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    color: white;
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 12px 12px 0 0;
    flex-shrink: 0;
}

.comentarios-analista-header-compact h6 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
}

.analista-actions .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.comentarios-analista-body-compact {
    padding: 1rem;
    flex: 1;
    overflow-y: auto;
    max-height: calc(420px - 120px); /* Resta header y formulario */
}

.comentarios-lista-compact {
    margin-bottom: 0;
}

.nuevo-comentario-form-compact {
    border-top: 1px solid #e5e7eb;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 0 0 12px 12px;
    flex-shrink: 0;
}

.comentario-form-compact .form-body-compact {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.comentario-textarea-compact {
    border: 1px solid #d1d5db;
    border-radius: 20px;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
    resize: none;
    background: white;
    transition: border-color 0.2s ease;
}

.comentario-textarea-compact:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-footer-compact {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.char-counter-compact {
    font-size: 0.75rem;
    color: #6b7280;
}

.form-actions-compact {
    display: flex;
    gap: 0.5rem;
}

.form-actions-compact .btn {
    border-radius: 20px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    transition: all 0.2s ease;
}

.form-actions-compact .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Estilos para preview de bullet points */
.bullet-points-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
}

.preview-header {
    background: #e9ecef;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    font-size: 0.9rem;
}

.preview-header strong {
    color: #495057;
    margin-right: auto;
}

.preview-content {
    padding: 1rem;
    max-height: 200px;
    overflow-y: auto;
}

.bullet-point-item {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    padding: 0.5rem;
    background: white;
    border-radius: 6px;
    border-left: 3px solid #007bff;
}

.bullet-point-item:last-child {
    margin-bottom: 0;
}

.bullet-point-icon {
    color: #007bff;
    font-size: 0.8rem;
    margin-top: 0.2rem;
    flex-shrink: 0;
}

.bullet-point-content {
    flex: 1;
    font-size: 0.85rem;
    line-height: 1.4;
}

.bullet-point-field {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.25rem;
}

.bullet-point-comment {
    color: #6c757d;
}

.bullet-point-status {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.bullet-point-status .badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
}

.no-bullet-points {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 1rem;
}

/* Responsive para bullet points */
@media (max-width: 768px) {
    .bullet-points-preview {
        margin-bottom: 0.75rem;
    }
    
    .preview-header {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .preview-content {
        padding: 0.75rem;
        max-height: 150px;
    }
    
    .bullet-point-item {
        padding: 0.4rem;
        margin-bottom: 0.5rem;
    }
    
    .bullet-point-content {
        font-size: 0.8rem;
    }
    
    .bullet-point-status {
        font-size: 0.7rem;
    }
    
    .form-actions-compact {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .form-actions-compact .btn {
        width: 100%;
        justify-content: center;
    }
}

/* ==========================================
   ESTILOS PARA MODAL DE CONFIRMACIÓN
   ========================================== */

.comentarios-section {
    margin-bottom: 1.5rem;
}

.comentarios-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    background: #f8f9fa;
}

.comentario-confirmacion {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid #007bff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.comentario-confirmacion:last-child {
    margin-bottom: 0;
}

.comentario-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.comentario-header strong {
    color: #007bff;
    font-size: 0.9rem;
}

.comentario-header small {
    color: #6c757d;
    font-size: 0.8rem;
}

.comentario-texto {
    color: #495057;
    font-size: 0.9rem;
    line-height: 1.5;
}

.bullet-points-confirmacion {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.bullet-points-confirmacion h6 {
    color: #495057;
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.bullet-points-confirmacion ul {
    margin: 0;
    padding-left: 1.5rem;
}

.bullet-points-confirmacion li {
    color: #6c757d;
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 0.25rem;
}

.bullet-points-confirmacion li:last-child {
    margin-bottom: 0;
}

/* Responsive para modal de confirmación */
@media (max-width: 768px) {
    .comentarios-container {
        max-height: 200px;
        padding: 0.75rem;
    }
    
    .comentario-confirmacion {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
    }
    
    .comentario-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }
    
    .bullet-points-confirmacion {
        padding: 0.75rem;
    }
    
    .bullet-points-confirmacion ul {
        padding-left: 1rem;
    }
}

/* Estilos para el mensaje de bienvenida del chat de analista */
.chat-welcome {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    margin-bottom: 20px;
    border-left: 4px solid #3b82f6;
}

.welcome-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #007bff, #0056b3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.welcome-message p {
    margin: 0;
    color: #0056b3;
    font-size: 0.8rem;
    line-height: 1.3;
}

.welcome-message p:first-child {
    font-weight: 600;
    margin-bottom: 4px;
}

/* Mejoras responsive para nuevas secciones */
@media (max-width: 991px) {
    .related-requests-section {
        margin-top: 20px;
    }
    
    .comentarios-analista-body-compact {
        max-height: calc(350px - 120px); /* Altura reducida en móviles */
    }
    
    .comentario-textarea-compact {
        border-radius: 12px; /* Menos redondeado en móviles */
        padding: 0.6rem 0.8rem;
    }
    
    .form-actions-compact .btn {
        border-radius: 12px;
        padding: 0.4rem 0.8rem;
    }
}

@media (max-width: 991px) {
    .documento-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .documento-actions {
        width: 100%;
        justify-content: space-between;
    }
    
    .related-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .related-header-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
}

@media (max-width: 767px) {
    .info-row-with-check {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .compliance-check {
        margin-left: 0;
        align-self: flex-end;
    }
    
    .upload-zone {
        padding: 16px;
    }
    
    .upload-icon {
        font-size: 1.5rem;
    }
    
    .documento-icon {
        width: 36px;
        height: 36px;
        font-size: 1.2rem;
    }
    
    .validation-btn {
        width: 28px;
        height: 28px;
        font-size: 0.7rem;
    }
    
    .related-icon {
        width: 28px;
        height: 28px;
        font-size: 0.9rem;
    }
}

/* ===============================================
   ESTILOS PARA ADJUNTOS ASOCIADOS
   =============================================== */

.adjuntos-container {
    background: white;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    height: 420px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
}

.adjuntos-header {
    padding: 0.6rem 1rem;
    border-bottom: 1px solid #f1f3f4;
    background: linear-gradient(135deg, #1e40af, #3b82f6);
    color: white;
    border-radius: 12px 12px 0 0;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.adjuntos-icon {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.adjuntos-title {
    flex: 1;
}

.adjuntos-title h5 {
    margin: 0;
}

.adjuntos-title small {
    display: block;
    color: rgba(255, 255, 255, 0.8);
}

.adjuntos-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.adjuntos-actions .btn {
    border-radius: 20px;
    padding: 0.4rem 0.8rem;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.1);
    color: white;
    transition: all 0.2s ease;
}

.adjuntos-actions .btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.adjuntos-actions .btn-success {
    background: rgba(40, 167, 69, 0.9);
    border-color: rgba(40, 167, 69, 0.9);
}

    .adjuntos-actions .btn-success:hover {
        background: rgba(40, 167, 69, 1);
        border-color: rgba(40, 167, 69, 1);
    }

/* Responsive para adjuntos-actions */
@media (max-width: 768px) {
    .adjuntos-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .adjuntos-actions {
        width: 100%;
        justify-content: center;
    }
    
    .adjuntos-actions .btn {
        width: 100%;
        justify-content: center;
    }
}

.adjuntos-content {
    padding: 16px 20px;
    flex: 1;
    overflow-y: auto;
}

.adjunto-item {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    padding: 14px;
    border-radius: 8px;
    border: 1px solid #f1f3f4;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}

.adjunto-item:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
}

.adjunto-item:last-child {
    margin-bottom: 0;
}

.adjunto-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.adjunto-details {
    flex: 1;
    min-width: 0;
}

.adjunto-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: #212529;
    margin-bottom: 6px;
    line-height: 1.3;
    word-wrap: break-word;
}

.adjunto-status {
    margin-bottom: 8px;
}

.adjunto-actions {
    display: flex;
    gap: 4px;
}

.adjunto-actions .btn {
    padding: 4px 8px;
    font-size: 0.75rem;
}

/* ===============================================
   ESTILOS PARA COMENTARIOS DE ANALISTA SECCIÓN
   =============================================== */

.comentarios-analista-section {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.comentarios-analista-header {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.comentarios-analista-header h5 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    color: white;
}

.analista-info {
    display: flex;
    align-items: center;
    gap: 8px;
}

.analista-info .badge {
    background: rgba(255, 255, 255, 0.2) !important;
    color: white;
    font-weight: 600;
}

.comentarios-analista-body {
    padding: 1.5rem;
}

.comentarios-lista {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 1.5rem;
    padding-right: 0.5rem;
}

.comentario-analista-item {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid #dc3545;
    transition: all 0.2s ease;
}

.comentario-analista-item:hover {
    background: #f1f3f4;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.comentario-analista-item:last-child {
    margin-bottom: 0;
}

.comentario-analista-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.comentario-analista-author {
    display: flex;
    align-items: center;
    gap: 8px;
}

.comentario-analista-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #dc3545, #c82333);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
}

.comentario-analista-info strong {
    color: #dc3545;
    font-weight: 600;
    font-size: 0.9rem;
}

.comentario-analista-info small {
    color: #6c757d;
    font-size: 0.75rem;
    display: block;
}

.comentario-analista-numero {
    background: #dc3545;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.comentario-analista-text {
    color: #374151;
    font-size: 0.9rem;
    line-height: 1.5;
    background: white;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.nuevo-comentario-form {
    border-top: 2px solid #f1f3f4;
    padding-top: 1.5rem;
}

.nuevo-comentario-form .form-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 1rem;
}

.analista-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #dc3545, #c82333);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.1rem;
}

.form-title strong {
    color: #dc3545;
    font-size: 1rem;
}

.form-title small {
    color: #6c757d;
    font-size: 0.85rem;
    display: block;
}

.comentario-textarea {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    font-size: 0.9rem;
    line-height: 1.5;
    resize: vertical;
    transition: all 0.2s ease;
}

.comentario-textarea:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}

.form-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
}

.char-counter {
    font-size: 0.8rem;
    color: #6c757d;
}

.form-actions {
    display: flex;
    gap: 8px;
}

.loading-spinner-analista {
    display: none;
}

/* Ajustes para layout horizontal de 3 columnas */
@media (min-width: 1200px) {
    .info-section .section-header h5 {
        font-size: 1rem;
    }
    
    .info-row-with-check .info-label,
    .info-row-with-check .info-value {
        font-size: 0.85rem;
    }
    
    .btn-compliance {
        width: 22px;
        height: 22px;
        font-size: 0.65rem;
    }
    
    .compliance-actions {
        gap: 3px;
    }
}

/* Estilos para el reloj en tiempo real */
#reloj-tiempo-real {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: #ffd700;
    text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
}

#fecha-actual {
    font-weight: 600;
    color: #e0e7ff;
}

.card-header .opacity-75 .ms-3 {
    display: inline-flex;
    align-items: center;
    white-space: nowrap;
}

/* Animación sutil para el reloj */
#reloj-tiempo-real {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Colores personalizados para íconos de secciones */
.section-header .text-info {
    color: #0dcaf0 !important;
    background: rgba(13, 202, 240, 0.1);
    padding: 8px;
    border-radius: 50%;
}

.section-header .text-primary {
    color: #3b82f6 !important;
    background: rgba(59, 130, 246, 0.1);
    padding: 8px;
    border-radius: 50%;
}

.section-header .text-warning {
    color: #f59e0b !important;
    background: rgba(245, 158, 11, 0.1);
    padding: 8px;
    border-radius: 50%;
}

/* Estilos para encabezados sticky */
.section-content {
    padding-top: 0.5rem;
}

.info-section {
    margin-bottom: 1rem;
}

/* Ajuste para evitar superposición con encabezados sticky */
.info-row-with-check:first-child {
    margin-top: 0.25rem;
}

/* Transición suave para el sticky header */
.section-header {
    transition: all 0.3s ease;
}

.section-header:hover {
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    transform: translateY(-1px);
}





/* Responsive para adjuntos y comentarios de analista */
@media (max-width: 1199px) {
    .adjuntos-container {
        margin-top: 20px;
    }
}

/* Ajustes para encabezados sticky en responsive */
@media (max-width: 768px) {
    .section-header {
        padding: 0.5rem;
        font-size: 0.9rem;
    }
    
    .section-header i {
        font-size: 1rem;
        margin-right: 0.5rem;
    }
    
    .section-header h5 {
        font-size: 0.9rem;
    }
    
    /* Ajustes para el reloj en móviles */
    .card-header .opacity-75 .ms-3 {
        margin-left: 0.5rem !important;
        font-size: 0.8rem;
    }
    
    #reloj-tiempo-real {
        font-size: 0.8rem;
    }
    
    #fecha-actual {
        font-size: 0.8rem;
    }
    
    /* Ajustes para headers sticky en móviles */
    .section-header {
        z-index: 250;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    /* Ajustes para el unified-sla en móviles */
    .unified-sla {
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
    }
    
    .unified-sla .btn {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
}

/* Ajustes para pantallas muy pequeñas */
@media (max-width: 576px) {
    .card-header .opacity-75 .ms-3:nth-child(4) {
        display: none; /* Ocultar fecha de creación en móviles muy pequeños */
    }
    
    .card-header .opacity-75 {
        flex-wrap: wrap;
    }
}

@media (max-width: 991px) {
    /* En pantallas medianas, cambiar a 1 columna por fila pero manteniendo 3 filas */
    .unified-body .row .col-md-4 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 1rem;
    }
}

@media (max-width: 767px) {
    /* En móviles, apilar verticalmente */
    .unified-body .row .col-md-4 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 1rem;
    }
    
    /* En móviles, resumen y adjuntos se apilan verticalmente */
    .row.mb-4 .col-8,
    .row.mb-4 .col-4 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .row.mb-4 .col-4 {
        margin-top: 1rem;
    }
    
    /* Ajustes para comentarios de analista y solicitudes relacionadas en móviles */
    .row.mb-4 .col-lg-8,
    .row.mb-4 .col-lg-4 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .row.mb-4 .col-lg-4 {
        margin-top: 1.5rem;
    }
    
    /* Ajustes específicos para comentarios de analista en móviles */
    .comentarios-analista-section-compact {
        height: auto;
        max-height: 350px;
    }
    
    /* Ajustes específicos para solicitudes relacionadas en móviles */
    .related-requests-section {
        height: auto;
        max-height: 300px;
    }
    
    .related-header {
        padding: 0.5rem;
    }
    
    .related-header h5 {
        font-size: 1rem;
    }
    
    .related-icon {
        width: 28px;
        height: 28px;
        font-size: 0.9rem;
    }
    
    .adjunto-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .adjunto-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .comentarios-analista-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    .analista-info {
        justify-content: center;
    }
    
    .comentario-analista-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .form-footer {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .form-actions {
        width: 100%;
        justify-content: flex-end;
    }
}
</style>
{% endblock %} 
