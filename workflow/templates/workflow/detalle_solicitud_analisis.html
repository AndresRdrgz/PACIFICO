{% extends 'workflow/base.html' %}
{% load static %}
{% load file_icon_filters %}

{% block title %}An√°lisis de Solicitud - {{ solicitud.codigo }}{% endblock %}

{% block extra_css %}
{% include 'workflow/partials/analisis_styles.html' %}
<style>
    /* Section Toggle Styles */
    .section-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        user-select: none;
    }

    .section-header:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .section-header-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }

    .section-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .section-toggle:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .toggle-icon {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
        color: rgba(255, 255, 255, 0.8);
    }

    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .section-content {
        transition: all 0.3s ease;
        overflow: hidden;
        max-height: 300px; /* Reduced height to fit within main container */
        overflow-y: auto; /* Enable vertical scrolling */
        padding: 0.75rem;
        border-radius: 0.375rem;
        background-color: white;
        margin-top: 0.5rem;
        border: 1px solid #e5e7eb;
    }

    .section-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
        overflow: hidden; /* Hide overflow when collapsed */
    }

    /* Custom scrollbar styling for better UX */
    .section-content::-webkit-scrollbar {
        width: 6px;
    }

    .section-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .section-content::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .section-content::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Custom scrollbar for main section content */
    .main-section-content::-webkit-scrollbar {
        width: 8px;
    }

    .main-section-content::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 4px;
    }

    .main-section-content::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 4px;
    }

    .main-section-content::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
    }

    /* Animation for smooth collapse/expand */
    .section-content {
        max-height: 1000px;
        opacity: 1;
    }

    .section-content.collapsed {
        max-height: 0;
        opacity: 0;
    }

    /* Ensure smooth layout transitions */
    .section-container {
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }

    .section-container:last-child {
        margin-bottom: 0;
    }

    /* Main layout container for equal heights */
    .main-layout-row {
        display: flex;
        min-height: 420px; /* Match adjuntos-container height */
    }

    /* Main section container styling */
    .main-section-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
        height: 420px; /* Fixed height to match adjuntos */
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    /* Resumen header styling */
    .resumen-header {
        padding: 0.6rem 1rem;
        border-bottom: 1px solid #f1f3f4;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        border-radius: 12px 12px 0 0;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .resumen-icon {
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .resumen-title {
        flex: 1;
    }

    .resumen-title h3.section-title {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 700;
        color: white;
    }

    .resumen-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .resumen-actions .btn {
        border-radius: 16px;
        padding: 0.3rem 0.6rem;
        font-size: 0.7rem;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.9);
        color: #1e40af;
        transition: all 0.2s ease;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .resumen-actions .btn:hover {
        background: rgba(255, 255, 255, 1);
        border-color: rgba(255, 255, 255, 0.8);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        color: #1e40af;
    }

    /* Main section content styling */
    .main-section-content {
        padding: 16px 20px;
        flex: 1;
        overflow-y: auto;
        background-color: #f8f9fa;
    }

    /* Analysis grid styling */
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        height: 100%;
    }

    /* Compact styles for Motivo de la Consulta section */
    .observaciones-content {
        padding: 0.25rem;
    }

    .observaciones-textarea {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #f8f9fa;
        font-family: inherit;
        line-height: 1.3;
    }

    .observaciones-empty {
        padding: 0.25rem;
    }

    .observaciones-empty .alert {
        margin: 0;
        border-radius: 4px;
    }

    /* Ensure content doesn't get clipped */
    .info-row-with-check {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        border-radius: 0.25rem;
        background-color: white;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }

    .info-row-with-check:hover {
        background-color: #f9fafb;
        border-color: #d1d5db;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .info-data {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .info-label {
        font-weight: 600;
        font-size: 0.875rem;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        margin-bottom: 0.125rem;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.25rem;
    }

    .info-value {
        font-weight: 500;
        font-size: 1rem;
        color: #1f2937;
        line-height: 1.4;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        padding: 0.25rem 0;
    }

    .compliance-actions {
        display: flex;
        gap: 0.25rem;
        flex-shrink: 0;
        align-items: center;
        padding-left: 0.5rem;
        border-left: 1px solid #e5e7eb;
    }

    /* Compliance button styles */
    .btn-compliance {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        background: white;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-compliance:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-compliance.btn-good {
        color: #198754;
        border-color: #198754;
    }

    .btn-compliance.btn-good:hover,
    .btn-compliance.btn-good.active {
        background: #198754;
        color: white;
        border-color: #198754;
    }

    .btn-compliance.btn-bad {
        color: #dc3545;
        border-color: #dc3545;
    }

    .btn-compliance.btn-bad:hover,
    .btn-compliance.btn-bad.active {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
    }

    .btn-compliance.btn-comment {
        color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-compliance.btn-comment:hover {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .btn-compliance.btn-comment.has-comment {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
        position: relative;
    }

    .btn-compliance.btn-comment.has-comment::after {
        content: '';
        position: absolute;
        top: -2px;
        right: -2px;
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        border: 1px solid white;
    }

    .btn-compliance:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Document compliance button styles */
    .adjunto-item .btn-compliance {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
    }

    .adjunto-item .btn-compliance.btn-comment.has-comment::after {
        width: 6px;
        height: 6px;
        top: -1px;
        right: -1px;
    }

    /* File extension styling */
    .adjunto-extension {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: normal;
        margin-left: 0.25rem;
        opacity: 0.8;
    }

    /* File size styling */
    .adjunto-size {
        font-size: 0.7rem;
        color: #adb5bd;
        font-weight: normal;
        margin-left: 0.5rem;
        opacity: 0.7;
    }

    /* Enhanced adjunto icon styling */
    .adjunto-icon i {
        font-size: 1.2rem;
        transition: transform 0.2s ease;
    }

    .adjunto-item:hover .adjunto-icon i {
        transform: scale(1.1);
    }

    /* File type specific hover effects */
    .adjunto-icon .fa-file-pdf:hover {
        color: #dc3545 !important;
    }

    .adjunto-icon .fa-file-word:hover {
        color: #0d6efd !important;
    }

    .adjunto-icon .fa-file-excel:hover {
        color: #198754 !important;
    }

    .adjunto-icon .fa-file-powerpoint:hover {
        color: #fd7e14 !important;
    }

    .adjunto-icon .fa-file-image:hover {
        color: #0dcaf0 !important;
    }

    .adjunto-icon .fa-file-archive:hover {
        color: #fd7e14 !important;
    }

    .adjunto-icon .fa-file-code:hover {
        color: #6f42c1 !important;
    }

    .adjunto-icon .fa-file-video:hover {
        color: #dc3545 !important;
    }

    .adjunto-icon .fa-file-audio:hover {
        color: #0dcaf0 !important;
    }

    /* Enhanced Bullet points styling */
    .bullet-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .bullet-item:hover {
        border-color: #d1d5db;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
        background-color: #f9fafb;
        transform: translateY(-1px);
    }

    .bullet-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .bullet-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        padding-bottom: 6px;
        border-bottom: 1px solid #f1f3f4;
    }

    .bullet-title {
        color: #1f2937;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
        min-width: 120px;
        max-width: 200px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .bullet-value {
        color: #6b7280;
        font-size: 0.85rem;
        font-weight: 500;
        text-align: right;
        flex: 1;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 300px;
    }

    .bullet-comment {
        color: #374151;
        font-size: 0.875rem;
        line-height: 1.5;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        padding-left: 4px;
    }

    .bullet-comment i {
        font-size: 0.8rem;
        opacity: 0.8;
    }

    /* Responsive improvements for bullet points */
    @media (max-width: 768px) {
        .bullet-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }

        .bullet-title {
            min-width: auto;
            max-width: none;
            width: 100%;
        }

        .bullet-value {
            text-align: left;
            max-width: none;
            width: 100%;
        }

        .bullets-content {
            max-height: 250px;
        }
    }

    .bullets-content {
        max-height: 200px;
        overflow-y: auto;
        padding-right: 8px;
    }

    .bullets-content::-webkit-scrollbar {
        width: 6px;
    }

    .bullets-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .bullets-content::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .bullets-content::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .bullets-placeholder {
        text-align: center;
        padding: 20px;
        color: #6b7280;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px dashed #d1d5db;
    }

    .bullets-placeholder i {
        color: #9ca3af;
        font-size: 1.2rem;
        margin-bottom: 8px;
        display: block;
    }

    .bullets-placeholder small {
        font-size: 0.875rem;
        color: #6b7280;
    }

    /* Animation for new bullet items */
    .bullet-item {
        animation: slideInUp 0.3s ease-out;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }





    /* Top-positioned form footer */
    .form-footer-top {
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: flex-end;
    }

    /* Make the entire analyst comments section scrollable */
    .comentarios-analista-section-compact {
        overflow-y: auto;
        max-height: 500px;
    }

    .nuevo-comentario-form-compact {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .comentario-form-compact {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    /* Form body with vertical scrolling */
    .form-body-compact {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 8px;
    }

    .form-body-compact::-webkit-scrollbar {
        width: 8px;
    }

    .form-body-compact::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 4px;
    }

    .form-body-compact::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 4px;
    }

    .form-body-compact::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
    }

    /* Responsive design for analyst comments and related requests */
    @media (max-width: 1200px) {
        .row.mb-5 .col-6 {
            width: 100%;
            margin-bottom: 1.5rem;
        }
        
        .row.mb-5 .col-6:last-child {
            margin-bottom: 0;
        }
        
        .comentarios-analista-section-compact {
            max-height: 450px;
        }
        
        .section-container {
            max-height: 450px;
        }
    }

    @media (max-width: 992px) {
        .comentarios-analista-header-compact {
            padding: 0.75rem 1rem;
        }
        
        .comentarios-analista-header-compact h6 {
            font-size: 1rem;
        }
        
        .form-body-compact {
            max-height: 350px;
        }
        
        .bullets-content {
            max-height: 150px;
        }
        
        .comentario-textarea-compact {
            min-height: 80px;
            font-size: 0.85rem;
        }
        
        .analisis-seccion-bullets {
            padding: 0.75rem;
        }
        
        .bullets-header {
            font-size: 0.85rem;
        }
        
        .bullet-text {
            font-size: 0.8rem;
        }
        
        .bullet-text strong {
            min-width: 100px;
            max-width: 150px;
        }
    }

    @media (max-width: 768px) {
        .row.mb-5 {
            margin-bottom: 1rem !important;
        }
        
        .comentarios-analista-section-compact {
            max-height: 400px;
            border-radius: 12px;
        }
        
        .section-container {
            max-height: 400px;
            border-radius: 12px;
        }
        
        .comentarios-analista-header-compact {
            padding: 0.5rem 0.75rem;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-start;
        }
        
        .comentarios-analista-header-compact .d-flex {
            width: 100%;
            justify-content: space-between;
        }
        
        .comentarios-analista-header-compact h6 {
            font-size: 0.9rem;
        }
        
        .comentarios-analista-header-compact .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        /* PDF resultado consulta button specific styling */
        #btn-pdf-resultado-consulta {
            border-color: #0d6efd !important;
            color: #0d6efd !important;
            transition: all 0.2s ease-in-out;
        }

        #btn-pdf-resultado-consulta:hover {
            background-color: #0d6efd !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
        }

        #btn-pdf-resultado-consulta:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }

        .comentarios-analista-header-compact .d-flex.gap-2 {
            align-items: center;
        }
        
        .form-body-compact {
            max-height: 300px;
            padding: 0.75rem;
        }
        
        .analisis-unificado-container {
            gap: 0.75rem;
        }
        
        .analisis-seccion-editable {
            gap: 0.25rem;
        }
        
        .analisis-seccion-editable .form-label {
            font-size: 0.8rem;
        }
        
        .comentario-textarea-compact {
            min-height: 60px;
            font-size: 0.8rem;
            padding: 0.5rem;
        }
        
        .analisis-seccion-bullets {
            padding: 0.5rem;
        }
        
        .bullets-header {
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }
        
        .bullets-content {
            max-height: 120px;
        }
        
        .bullet-item {
            padding: 6px 8px;
            margin-bottom: 4px;
        }
        
        .bullet-text {
            font-size: 0.75rem;
            gap: 2px;
        }
        
        .bullet-text::before {
            font-size: 1rem;
            margin-right: 4px;
        }
        
        .bullet-text strong {
            min-width: 80px;
            max-width: 120px;
            font-size: 0.75rem;
        }
        
        /* Related requests responsive */
        .resumen-header {
            padding: 0.5rem 0.75rem;
        }
        
        .resumen-title h3.section-title {
            font-size: 0.85rem;
        }
        
        .resumen-title small {
            font-size: 0.75rem;
        }
        
        .section-content {
            padding: 0.75rem;
        }
        
        .search-info {
            padding: 0.5rem;
            font-size: 0.8rem;
        }
        
        .related-item {
            padding: 0.75rem;
            gap: 0.75rem;
        }
        
        .related-header-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        
        .related-header-item strong {
            font-size: 0.8rem;
        }
        
        .related-date {
            font-size: 0.7rem;
        }
        
        .related-info {
            gap: 0.5rem;
        }
        
        .related-info .badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }
        
        .related-amount {
            font-size: 0.75rem;
        }
        
        .related-description {
            font-size: 0.7rem;
        }
        
        .related-actions .btn {
            padding: 0.3rem 0.5rem;
            font-size: 0.7rem;
        }
        
        .related-summary {
            padding: 0.75rem;
        }
        
        .summary-item {
            margin-bottom: 0.25rem;
        }
        
        .summary-label {
            font-size: 0.75rem;
        }
        
        .summary-value {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 576px) {
        .comentarios-analista-section-compact {
            max-height: 350px;
        }
        
        .section-container {
            max-height: 350px;
        }
        
        .form-body-compact {
            max-height: 250px;
            padding: 0.5rem;
        }
        
        .bullets-content {
            max-height: 100px;
        }
        
        .comentario-textarea-compact {
            min-height: 50px;
            font-size: 0.75rem;
        }
        
        .bullet-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }
        
        .bullet-title {
            min-width: auto;
            max-width: none;
            width: 100%;
            font-size: 0.8rem;
        }
        
        .bullet-value {
            text-align: left;
            max-width: none;
            width: 100%;
            font-size: 0.75rem;
        }
        
        .bullet-comment {
            font-size: 0.8rem;
        }
        
        .related-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .related-actions {
            align-self: flex-end;
        }
    }

    /* View Mode Styles */
    .view-mode-indicator {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(13, 110, 253, 0.1);
        z-index: 10;
        pointer-events: none;
    }

    .view-mode-badge {
        background: linear-gradient(135deg, #0d6efd, #0b5ed7);
        color: white;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
        }
        50% {
            box-shadow: 0 2px 12px rgba(13, 110, 253, 0.5);
        }
        100% {
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
        }
    }

    /* Read-only styles for view mode */
    .read-only-element {
        background-color: #f8f9fa !important;
        cursor: not-allowed !important;
        opacity: 0.8;
    }

    .read-only-element:focus {
        outline: none !important;
        box-shadow: none !important;
    }

    /* Disabled compliance buttons in view mode */
    .btn-compliance.view-mode-disabled {
        opacity: 0.6 !important;
        cursor: not-allowed !important;
        pointer-events: none !important;
    }

    .btn-compliance.view-mode-disabled:hover {
        transform: none !important;
        box-shadow: none !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Redirect to reconsideration analysis if applicable -->
{% if solicitud.es_reconsideracion %}
    <script>
        window.location.href = "{% url 'workflow:detalle_reconsideracion_analista' solicitud.id %}";
    </script>
{% endif %}

<div id="analisis-container">
    <div class="container-fluid">
        <!-- Header de la Solicitud -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header" style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <a href="{% url 'workflow:vista_mixta_bandejas' %}" class="btn btn-light btn-sm">
                                    <i class="fas fa-arrow-left me-1"></i>Volver a Bandejas
                                </a>
                                <div>
                                    <h2 class="mb-1 d-flex align-items-center">
                                        <i class="fas fa-microscope me-2"></i>
                                        An√°lisis: {{ solicitud.cliente_nombre_completo|default:"Sin cliente" }}
                                    </h2>
                                    <div class="mt-1 d-flex align-items-center gap-4" style="font-size: 0.85em; opacity: 0.9;">
                                        {% if solicitud.creada_por %}
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user me-1"></i>
                                            <strong>Propietario:</strong> 
                                            <span class="ms-1">{{ solicitud.creada_por.get_full_name|default:solicitud.creada_por.username }}</span>
                                        </div>
                                        {% endif %}
                                        {% if solicitud.cotizacion and solicitud.cotizacion.observaciones %}
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-comments me-1"></i>
                                            <strong>Motivo:</strong> 
                                            <span class="ms-1" id="motivo-texto-corto">{{ solicitud.cotizacion.observaciones|truncatechars:100 }}</span>
                                            <span class="ms-1" id="motivo-texto-completo" style="display: none;">{{ solicitud.cotizacion.observaciones }}</span>
                                            {% if solicitud.cotizacion.observaciones|length > 100 %}
                                            <button type="button" class="btn btn-link btn-sm p-0 ms-1" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.8em;" onclick="toggleMotivoCompleto()" id="btn-toggle-motivo">
                                                <i class="fas fa-chevron-down"></i><span> Ver m√°s</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownTransiciones" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-arrow-right me-1"></i>Cambiar Etapa
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownTransiciones">
                                    {% if transiciones_disponibles %}
                                        {% for transicion_data in transiciones_disponibles %}
                                            {% with transicion=transicion_data.transicion %}
                                            <li>
                                                <a class="dropdown-item {% if not transicion_data.puede_realizar %}disabled text-muted{% endif %}" 
                                                href="#" 
                                                onclick="handleTransicionClick({{ transicion.etapa_destino.id }}, '{{ transicion.etapa_destino.nombre|escapejs }}', {{ transicion_data.puede_realizar|yesno:'true,false' }}, {{ transicion_data.total_requisitos_faltantes }}); return false;"
                                                {% if not transicion_data.puede_realizar %}title="Faltan {{ transicion_data.total_requisitos_faltantes }} requisito(s) obligatorio(s)"{% endif %}>
                                                    <i class="fas fa-arrow-right me-2"></i>
                                                    <strong>{{ transicion.etapa_destino.nombre }}</strong>
                                                    {% if not transicion_data.puede_realizar %}
                                                        <span class="badge bg-warning text-dark ms-2">{{ transicion_data.total_requisitos_faltantes }}</span>
                                                    {% endif %}
                                                    <br>
                                                    <small class="text-muted">{{ transicion.nombre }}</small>
                                                </a>
                                            </li>
                                            {% endwith %}
                                        {% endfor %}
                                    {% else %}
                                        <li><span class="dropdown-item-text text-muted">No hay transiciones disponibles</span></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BLOCKING ALERT: Solicitud sin asignar -->
        {% if not solicitud.asignada_a %}
        <div class="row mb-4" id="solicitud-bloqueada-alert">
            <div class="col-12">
                <div class="alert alert-warning border-warning" role="alert">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading mb-2">
                                <i class="fas fa-lock me-2"></i>
                                Solicitud Bloqueada - Pendiente de Asignaci√≥n
                            </h5>
                            <p class="mb-3">
                                Esta solicitud no ha sido asignada a ning√∫n analista. Para poder realizar el an√°lisis, 
                                primero debe ser asignada a un usuario autorizado.
                            </p>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-warning mb-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        ¬øQu√© necesitas hacer?
                                    </h6>
                                    <ul class="mb-0">
                                        <li>Contactar al administrador del sistema</li>
                                        <li>Solicitar la asignaci√≥n de esta solicitud</li>
                                        <li>Esperar a que sea asignada a un analista</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-warning mb-2">
                                        <i class="fas fa-user-check me-1"></i>
                                        Informaci√≥n de la Solicitud
                                    </h6>
                                    <ul class="mb-0">
                                        <li><strong>C√≥digo:</strong> {{ solicitud.codigo }}</li>
                                        <li><strong>Pipeline:</strong> {{ solicitud.pipeline.nombre }}</li>
                                        <li><strong>Etapa Actual:</strong> {{ solicitud.etapa_actual.nombre|default:"Sin etapa" }}</li>
                                        <li><strong>Fecha Creaci√≥n:</strong> {{ solicitud.fecha_creacion|date:"d/m/Y H:i" }}</li>
                                    </ul>
                                </div>
                            </div>
                            <hr class="my-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        Solicitud creada hace {{ solicitud.fecha_creacion|timesince }}
                                    </small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-info btn-sm" id="btn-ver-solicitud">
                                        <i class="fas fa-eye me-1"></i>
                                        Ver Solicitud
                                    </button>
                                    <a href="{% url 'workflow:vista_mixta_bandejas' %}" class="btn btn-outline-warning btn-sm">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Volver a Bandejas
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

       





        <!-- LAYOUT PRINCIPAL: RESUMEN COMPLETO (4/6) + ADJUNTOS (2/6) -->
        <div class="row mb-4 main-layout-row">
            <div class="col-8">
                <div class="main-section-container">
                    <div class="resumen-header">
                        <div class="resumen-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="resumen-title">
                            <h3 class="section-title">Resumen Completo de la Solicitud</h3>
                        </div>
                        <div class="resumen-actions">
                            <button class="btn btn-light btn-sm" onclick="confirmarMarcarTodosComoBueno()">
                                <i class="fas fa-check-double me-1"></i>Marcar Todos como Bueno
                            </button>
                        </div>
                    </div>
                    <div class="main-section-content">
                        <div class="analysis-grid">
                            <!-- 1. Informaci√≥n de Cliente -->
                            <div class="col-md-4">
                                <div class="section-container">
                                    <div class="section-header" onclick="toggleSection(this)">
                                        <div class="section-header-content">
                                            <i class="fas fa-user text-info"></i>
                                            <h3 class="section-title">Informaci√≥n de Cliente</h3>
                                        </div>
                                        <div class="section-toggle">
                                            <i class="fas fa-chevron-down toggle-icon"></i>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Empresa Privada:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.nombreEmpresa|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="empresa_privada" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="empresa_privada" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="empresa_privada" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Cargo:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.posicion|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="cargo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="cargo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="cargo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Tiempo de Servicio:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.tiempoServicio|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="tiempo_servicio" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="tiempo_servicio" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="tiempo_servicio" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Salario:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.salarioBaseMensual %}
                                                        B/. {{ solicitud.cotizacion.salarioBaseMensual|floatformat:2 }}
                                                    {% elif solicitud.cotizacion.ingresos %}
                                                        B/. {{ solicitud.cotizacion.ingresos|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="salario" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="salario" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="salario" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Score:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.apcScore|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="score" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="score" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="score" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Pol√≠tica:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.politica.titulo|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="politica" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="politica" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="politica" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Sector:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.sector|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="sector" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="sector" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="sector" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 2. Detalle de la Solicitud -->
                            <div class="col-md-4">
                                <div class="section-container">
                                    <div class="section-header" onclick="toggleSection(this)">
                                        <div class="section-header-content">
                                            <i class="fas fa-calculator text-primary"></i>
                                            <h3 class="section-title">Detalle de la Solicitud</h3>
                                        </div>
                                        <div class="section-toggle">
                                            <i class="fas fa-chevron-down toggle-icon"></i>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Valor del equipo:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.valorAuto %}
                                                        B/. {{ solicitud.cotizacion.valorAuto|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="valor_equipo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="valor_equipo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="valor_equipo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Abono:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.abono and solicitud.cotizacion.abonoPorcentaje %}
                                                        B/. {{ solicitud.cotizacion.abono|floatformat:2 }} ({{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%)
                                                    {% elif solicitud.cotizacion.abono %}
                                                        B/. {{ solicitud.cotizacion.abono|floatformat:2 }}
                                                    {% elif solicitud.cotizacion.abonoPorcentaje %}
                                                        {{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="abono" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="abono" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="abono" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Monto financiado:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.montoPrestamo %}
                                                        B/. {{ solicitud.cotizacion.montoPrestamo|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="monto_financiado" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="monto_financiado" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="monto_financiado" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Plazo:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.plazoPago %}
                                                        {{ solicitud.cotizacion.plazoPago }} meses
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="plazo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="plazo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="plazo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Rentabilidad:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.r_deseada %}
                                                        {{ solicitud.cotizacion.r_deseada|floatformat:2 }}%
                                                    {% elif solicitud.cotizacion.r1 %}
                                                        {{ solicitud.cotizacion.r1|floatformat:2 }}%
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="rentabilidad" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="rentabilidad" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="rentabilidad" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Total de letra c/seg:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.wrkMontoLetra %}
                                                        B/. {{ solicitud.cotizacion.wrkMontoLetra|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="total_letra" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="total_letra" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="total_letra" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            
                            <!-- 3. Datos del Veh√≠culo -->
                            <div class="col-md-4">
                                <div class="section-container">
                                    <div class="section-header" onclick="toggleSection(this)">
                                        <div class="section-header-content">
                                            <i class="fas fa-car text-warning"></i>
                                            <h3 class="section-title">Datos del Veh√≠culo</h3>
                                        </div>
                                        <div class="section-toggle">
                                            <i class="fas fa-chevron-down toggle-icon"></i>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Marca:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.marca|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="marca" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="marca" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="marca" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Modelo:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.modelo|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="modelo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="modelo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="modelo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">A√±o:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.yearCarro|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="a√±o" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="a√±o" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="a√±o" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Transmisi√≥n:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.transmisionAuto|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="transmision" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="transmision" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="transmision" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">KM:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.kilometrajeAuto %}
                                                        {{ solicitud.cotizacion.kilometrajeAuto|floatformat:0 }} km
                                                    {% else %}
                                                        0 km
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="kilometraje" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="kilometraje" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="kilometraje" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ADJUNTOS ASOCIADOS (2/6 del ancho) -->
            <div class="col-4">
                <div class="adjuntos-container">
                    <div class="adjuntos-header">
                        <div class="adjuntos-icon">
                            <i class="fas fa-paperclip"></i>
                        </div>
                        <div class="adjuntos-title">
                            <h3 class="section-title">Adjuntos (Consulta)</h3>
                            
                        </div>
                        {% if requisitos_consulta %}
                            {% with requisitos_con_archivos=requisitos_consulta|length %}
                                {% if requisitos_con_archivos > 0 %}
                                    <div class="adjuntos-actions">
                                        <button type="button" class="btn btn-light btn-sm" id="btn-download-merged-pdf" title="Descargar todos los documentos en un solo PDF">
                                            <i class="fas fa-download me-1"></i>PDF Completo
                                        </button>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                    <div class="adjuntos-content">
                        {% if requisitos_consulta %}
                            {% for requisito_solicitud in requisitos_consulta %}
                                <div class="adjunto-item" {% if requisito_solicitud.archivo %}title="{{ requisito_solicitud.archivo|get_file_name }}"{% endif %}>
                                    <div class="adjunto-icon">
                                        <i class="{{ requisito_solicitud.archivo|get_file_icon }}"></i>
                                    </div>
                                    <div class="adjunto-details">
                                        <div class="adjunto-name">
                                            {{ requisito_solicitud.requisito.nombre }}
                                            {% comment %}Show mandatory/optional badge based on transition configuration{% endcomment %}
                                            {% if requisito_solicitud.es_obligatorio %}
                                                <span class="badge bg-danger badge-sm ms-1">Obligatorio</span>
                                            {% else %}
                                                <span class="badge bg-secondary badge-sm ms-1">Opcional</span>
                                            {% endif %}
                                            {% if requisito_solicitud.archivo %}
                                                <span class="adjunto-extension">({{ requisito_solicitud.archivo|get_file_extension }})</span>
                                                <span class="adjunto-size">{{ requisito_solicitud.archivo|get_file_size }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="adjunto-actions">
                                            {% if requisito_solicitud.archivo %}
                                                <a href="{{ requisito_solicitud.archivo.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            {% endif %}
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="doc_{{ requisito_solicitud.id }}" data-action="bueno" title="Documento v√°lido">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="doc_{{ requisito_solicitud.id }}" data-action="malo" title="Documento inv√°lido">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="doc_{{ requisito_solicitud.id }}" data-action="comentario" title="Comentar documento">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-light text-center">
                                <i class="fas fa-inbox me-2"></i>
                                <small>Sin requisitos configurados para transici√≥n a Consulta</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>




        <!-- COMENTARIOS DE ANALISTA Y SOLICITUDES RELACIONADAS (side by side) -->
        <div class="row mb-5">
            <!-- COMENTARIOS DE ANALISTA (6/12) -->
            <div class="col-6">
                <div class="comentarios-analista-section-compact">
                    <div class="comentarios-analista-header-compact">
                        <div class="d-flex align-items-center justify-content-between w-100">
                            <h6 class="mb-0"><i class="fas fa-user-md me-2"></i>Comentarios de Analista</h6>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-danger btn-sm" id="btn-pdf-resultado-consulta">
                                    <i class="fas fa-file-pdf me-1"></i>PDF resultado consulta
                                </button>
                                <button type="button" class="btn btn-light btn-sm" id="btn-enviar-analista-credito">
                                    <i class="fas fa-save me-1"></i>Guardar An√°lisis
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Formulario compacto fijo en el pie -->
                    <div class="nuevo-comentario-form-compact">
                        <form id="form-comentario-analista-credito" class="comentario-form-compact">
                            {% csrf_token %}
                            
                            <div class="form-body-compact">
                                <!-- √Årea de an√°lisis unificado -->
                                <div class="analisis-unificado-container">
                                    <!-- Secci√≥n editable del analista -->
                                    <div class="analisis-seccion-editable">
                                        <label for="comentario-analista-credito-text" class="form-label">
                                            <i class="fas fa-edit me-2"></i>An√°lisis General (Editable)
                                        </label>
                                        <textarea class="form-control comentario-textarea-compact" 
                                                id="comentario-analista-credito-text"
                                                placeholder="Escriba su an√°lisis general aqu√≠..."
                                                rows="4" 
                                                maxlength="2000"
                                                required></textarea>
                                    </div>
                                    
                                    <!-- Secci√≥n de resultado de an√°lisis -->
                                    <div class="analisis-seccion-resultado mt-3">
                                        <label for="resultado-analisis" class="form-label">
                                            <i class="fas fa-decision me-2"></i>Resultado de An√°lisis
                                        </label>
                                        <select class="form-select" id="resultado-analisis" name="resultado_analisis" required>
                                            <option value="">Seleccione el resultado...</option>
                                            <option value="Aprobado">Aprobado</option>
                                            <option value="Rechazado">Rechazado</option>
                                            <option value="Alternativa">Alternativa</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Secci√≥n de bullet points auto-generados -->
                                    <div class="analisis-seccion-bullets">
                                        <div class="bullets-header">
                                            <i class="fas fa-list-ul me-2"></i>
                                            <strong>Comentarios de Campos (Auto-generados)</strong>
                                        </div>
                                        <div class="bullets-content" id="bullets-content">
                                            <div class="bullets-placeholder">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <small>Los comentarios de campos se generar√°n autom√°ticamente al guardar</small>
                                            </div>
                                        </div>
                                    </div>
                                    

                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- SOLICITUDES RELACIONADAS (6/12) -->
            <div class="col-6">
                <div class="section-container">
                    <div class="resumen-header">
                        <div class="resumen-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <div class="resumen-title">
                            <h3 class="section-title">Solicitudes Relacionadas</h3>
                            <small>C√©dula: {{ solicitud.cliente_cedula_completa|default:"-" }}</small>
                        </div>
                    </div>
                    
                    <div class="section-content">
                        {% if mostrar_mensaje_sin_cliente %}
                            <div class="alert alert-warning text-center my-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Esta solicitud no tiene c√©dula de cliente asignada, no se pueden mostrar solicitudes relacionadas.
                            </div>
                        {% else %}
                            <!-- B√∫squeda autom√°tica por c√©dula -->
                            <div class="search-info">
                                <i class="fas fa-search me-2"></i>
                                <span>Buscando por c√©dula: <strong>{{ solicitud.cliente_cedula_completa|default:"-" }}</strong></span>
                            </div>
                            
                            <!-- Lista de solicitudes relacionadas -->
                            <div class="related-list">
                                {% for s in solicitudes_relacionadas %}
                                <div class="related-item">
                                    <div class="related-icon">
                                        <i class="fas fa-file-alt {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}text-success{% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}text-danger{% else %}text-warning{% endif %}"></i>
                                    </div>
                                    <div class="related-details">
                                        <div class="related-header-item">
                                            <strong>{{ s.codigo }}</strong>
                                            <span class="related-date">{{ s.fecha_creacion|date:"d/m/Y" }}</span>
                                        </div>
                                        <div class="related-info">
                                            <span class="badge 
                                                {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}bg-success
                                                {% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}bg-danger
                                                {% else %}bg-warning{% endif %}">
                                                {% if s.etapa_actual %}{{ s.etapa_actual.nombre }}{% else %}Sin estado{% endif %}
                                            </span>
                                            <span class="related-amount">
                                                B/. {% if s.cotizacion and s.cotizacion.montoPrestamo %}{{ s.cotizacion.montoPrestamo|floatformat:2 }}{% else %}0.00{% endif %}
                                            </span>
                                        </div>
                                        <div class="related-description">
                                            {% if s.cotizacion and s.cotizacion.tipoPrestamo %}
                                                {% if s.cotizacion.tipoPrestamo == 'auto' %}Pr√©stamo Auto{% else %}Pr√©stamo Personal{% endif %}
                                            {% else %}Pr√©stamo{% endif %}
                                            {% if s.cotizacion and s.cotizacion.plazoPago %} - {{ s.cotizacion.plazoPago }} meses{% endif %}
                                        </div>
                                    </div>
                                    <div class="related-actions">
                                        <a href="{% url 'workflow:detalle_solicitud_analisis' s.id %}" class="btn btn-outline-primary btn-sm" title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="alert alert-info text-center my-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Sin solicitudes relacionadas disponibles para esta c√©dula.
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% if solicitudes_relacionadas %}
                            <div class="related-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Total Solicitudes:</span>
                                    <span class="summary-value">{{ solicitudes_relacionadas|length }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Aprobadas:</span>
                                    <span class="summary-value text-success">
                                        {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                    </span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">En Proceso:</span>
                                    <span class="summary-value text-warning">
                                        {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Proceso' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                    </span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Rechazadas:</span>
                                    <span class="summary-value text-danger">
                                        {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>



    <!-- Modal para Comentarios de Compliance -->
    <div class="modal fade" id="modalComentarioCompliance" tabindex="-1" aria-labelledby="modalComentarioComplianceLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalComentarioComplianceLabel">
                        <i class="fas fa-comment-dots me-2"></i>
                        Comentario de Compliance
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Campo:</label>
                            <div class="fw-bold text-primary" id="campo-nombre"></div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Valor actual:</label>
                            <div class="fw-bold" id="campo-valor"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="comentario-compliance" class="form-label">Comentario:</label>
                        <textarea class="form-control" id="comentario-compliance" rows="5" placeholder="Ingrese su comentario sobre este campo..."></textarea>
                        <div class="form-text">
                            <span id="char-count-compliance">0</span>/500 caracteres
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-guardar-comentario-compliance">
                        <i class="fas fa-save me-2"></i>
                        Guardar Comentario
                    </button>
                </div>
            </div>
        </div>
    </div>

    

</div>

{% endblock %}

{% block extra_js %}
<!-- VER MAS FUNCIONES -->
<script>
    // Toggle functionality for "Ver m√°s" button to show/hide complete motivo consulta
    const toggleMotivoCompleto = () => {
        const textoCorto = document.getElementById('motivo-texto-corto');
        const textoCompleto = document.getElementById('motivo-texto-completo');
        const btnToggle = document.getElementById('btn-toggle-motivo');
        
        // Check if all required elements exist
        if (!textoCorto || !textoCompleto || !btnToggle) {
            console.error('Required elements for motivo toggle not found');
            return;
        }
        
        const icon = btnToggle.querySelector('i');
        const textSpan = btnToggle.querySelector('span');
        
        if (!icon) {
            console.error('Icon element not found in toggle button');
            return;
        }

        if (textoCorto.style.display !== 'none') {
            // Show complete text
            textoCorto.style.display = 'none';
            textoCompleto.style.display = 'inline';
            icon.className = 'fas fa-chevron-up';
            if (textSpan) {
                textSpan.textContent = ' Ver menos';
            }
        } else {
            // Show short text
            textoCorto.style.display = 'inline';
            textoCompleto.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
            if (textSpan) {
                textSpan.textContent = ' Ver m√°s';
            }
        }
    };

    // Section toggle functionality
    const toggleSection = (headerElement) => {
        const sectionContent = headerElement.nextElementSibling;
        const toggleIcon = headerElement.querySelector('.toggle-icon');
        
        if (sectionContent.classList.contains('collapsed')) {
            // Expand section
            sectionContent.classList.remove('collapsed');
            headerElement.classList.remove('collapsed');
            toggleIcon.style.transform = 'rotate(0deg)';
            
            // Set proper height for scrollable content
            const contentHeight = Math.min(sectionContent.scrollHeight, 300);
            sectionContent.style.maxHeight = `${contentHeight}px`;
            sectionContent.style.overflowY = 'auto';
            
        } else {
            // Collapse section
            sectionContent.classList.add('collapsed');
            headerElement.classList.add('collapsed');
            toggleIcon.style.transform = 'rotate(-90deg)';
            
            // Reset height and hide overflow
            sectionContent.style.maxHeight = '0';
            sectionContent.style.overflowY = 'hidden';
        }
    };



    // Enhanced stage change handler with validation
    const handleTransicionClick = (etapaId, etapaNombre, puedeRealizar, requisitosFaltantes) => {
        // Check if in view mode
        const isViewMode = document.querySelector('.view-mode-indicator') !== null;
        if (isViewMode) {
            showNotification('Modo solo lectura - No se pueden cambiar etapas en solicitudes no asignadas', 'warning');
            return;
        }
        
        if (!puedeRealizar) {
            showNotification(`No se puede cambiar a ${etapaNombre}. Faltan ${requisitosFaltantes} requisito(s) obligatorio(s).`, 'warning');
            return;
        }
        
        // Show validation and confirmation before proceeding
        showStageChangeConfirmation(etapaNombre);
    };

    // Confirmation dialog for marking all as good
    const confirmarMarcarTodosComoBueno = () => {
        // Check if in view mode
        const isViewMode = document.querySelector('.view-mode-indicator') !== null;
        if (isViewMode) {
            showNotification('Modo solo lectura - No se pueden realizar acciones en solicitudes no asignadas', 'warning');
            return;
        }
        
        const goodButtons = document.querySelectorAll('.btn-compliance.btn-good');
        const totalButtons = goodButtons.length;
        
        if (totalButtons === 0) {
            showNotification('No hay campos para marcar como buenos', 'info');
            return;
        }
        
        // Count fields that are not already marked as good
        let camposPendientes = 0;
        for (const button of goodButtons) {
            if (!button.classList.contains('active')) {
                camposPendientes++;
            }
        }
        
        if (camposPendientes === 0) {
            showNotification('Todos los campos ya est√°n marcados como buenos', 'info');
            return;
        }
        
        // Show confirmation dialog
        if (confirm(`¬øEst√° seguro que desea marcar ${camposPendientes} campo(s) como buenos?\n\nEsta acci√≥n no se puede deshacer.`)) {
            marcarTodosComoBueno();
        }
    };

    // Mark all as good functionality with bulk API support
    const marcarTodosComoBueno = async () => {
        const goodButtons = document.querySelectorAll('.btn-compliance.btn-good');
        const totalButtons = goodButtons.length;
        
        if (totalButtons === 0) {
            showNotification('No hay campos para marcar como buenos', 'info');
            return;
        }
        
        // Disable the button and show loading state
        const btnMarcarTodos = document.querySelector('button[onclick="marcarTodosComoBueno()"]');
        const originalContent = btnMarcarTodos ? btnMarcarTodos.innerHTML : '';
        
        if (btnMarcarTodos) {
            btnMarcarTodos.disabled = true;
            btnMarcarTodos.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        }
        
        try {
            showNotification(`Iniciando proceso de calificaci√≥n de ${totalButtons} campos...`, 'info');
            
            // Collect fields that need to be marked as good
            const campos = [];
            for (const button of goodButtons) {
                const field = button.getAttribute('data-field');
                if (!button.classList.contains('active')) {
                    campos.push(field);
                }
            }
            
            if (campos.length === 0) {
                showNotification('Todos los campos ya est√°n marcados como buenos', 'info');
                return;
            }
            
            // Try bulk API first
            const solicitudId = getSolicitudIdFromUrl();
            if (!solicitudId) {
                throw new Error('No se pudo obtener el ID de la solicitud');
            }
            
            try {
                // Show progress
                if (btnMarcarTodos) {
                    btnMarcarTodos.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Procesando en lote...`;
                }
                
                const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificar-campos-bulk/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        campos: campos,
                        estado: 'bueno'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update all button states
                    campos.forEach(field => {
                        const button = document.querySelector(`[data-field="${field}"][data-action="bueno"]`);
                        if (button) {
                            updateComplianceButtonState(button, 'bueno');
                        }
                    });
                    
                    const successCount = data.total_procesados;
                    const errorCount = data.total_errores;
                    
                    if (errorCount === 0) {
                        showNotification(`‚úÖ Todos los campos (${successCount}) fueron marcados como buenos exitosamente`, 'success');
                    } else {
                        showNotification(`‚ö†Ô∏è Proceso completado: ${successCount} exitosos, ${errorCount} con errores`, 'warning');
                        if (data.errores && data.errores.length > 0) {
                            console.error('Errors during bulk marking:', data.errores);
                        }
                    }
                } else {
                    throw new Error(data.error || 'Error en la API de lote');
                }
                
            } catch (bulkError) {
                console.warn('Bulk API failed, falling back to sequential processing:', bulkError);
                
                // Fallback to sequential processing
                if (btnMarcarTodos) {
                    btnMarcarTodos.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando secuencialmente...';
                }
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                for (let i = 0; i < campos.length; i++) {
                    const field = campos[i];
                    const button = document.querySelector(`[data-field="${field}"][data-action="bueno"]`);
                    
                    if (!button) continue;
                    
                    try {
                        // Show progress
                        if (btnMarcarTodos) {
                            btnMarcarTodos.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Procesando ${i + 1}/${campos.length}...`;
                        }
                        
                        // Add delay to avoid database locks
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        // Call the compliance action directly
                        await handleComplianceAction(button);
                        successCount++;
                        
                    } catch (error) {
                        errorCount++;
                        errors.push(`${field}: ${error.message}`);
                        console.error(`Error processing field ${field}:`, error);
                    }
                }
                
                // Show final results
                if (errorCount === 0) {
                    showNotification(`‚úÖ Todos los campos (${successCount}) fueron marcados como buenos exitosamente`, 'success');
                } else if (successCount === 0) {
                    showNotification(`‚ùå Error al procesar todos los campos. Revise los errores en la consola.`, 'error');
                } else {
                    showNotification(`‚ö†Ô∏è Proceso completado: ${successCount} exitosos, ${errorCount} con errores`, 'warning');
                    console.error('Errors during sequential marking:', errors);
                }
            }
            
        } catch (error) {
            console.error('Error in marcarTodosComoBueno:', error);
            showNotification(`Error general: ${error.message}`, 'error');
        } finally {
            // Restore button state
            if (btnMarcarTodos) {
                btnMarcarTodos.disabled = false;
                btnMarcarTodos.innerHTML = originalContent;
            }
        }
    };

    // Compliance button functionality
    const handleComplianceAction = async (button) => {
        // Check if in view mode
        const isViewMode = document.querySelector('.view-mode-indicator') !== null;
        if (isViewMode) {
            showNotification('Modo solo lectura - No se pueden realizar acciones en solicitudes no asignadas', 'warning');
            return;
        }
        
        const field = button.getAttribute('data-field');
        const action = button.getAttribute('data-action');
        const solicitudId = getSolicitudIdFromUrl();
        
        console.log('Compliance action triggered:', { field, action, solicitudId });
        
        if (!solicitudId) {
            showNotification('Error: No se pudo obtener el ID de la solicitud', 'error');
            return;
        }

        if (!field) {
            console.error('Field attribute not found on button');
            showNotification('Error: Campo no especificado', 'error');
            return;
        }

        // Store original HTML outside try block so it's available in finally
        const originalHTML = button.innerHTML;

        try {
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            if (action === 'bueno' || action === 'malo') {
                console.log('Processing good/bad rating for field:', field);
                
                // Handle good/bad rating
                const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificar-campo/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        campo: field,
                        estado: action === 'bueno' ? 'bueno' : 'malo'
                    })
                });

                const data = await response.json();
                console.log('Rating response:', data);
                
                if (data.success) {
                    // Update button appearance
                    updateComplianceButtonState(button, action);
                    showNotification(`Campo calificado como ${action === 'bueno' ? 'bueno' : 'malo'}`, 'success');
                } else {
                    throw new Error(data.error || 'Error al calificar campo');
                }
            } else if (action === 'comentario') {
                console.log('Opening comment modal for field:', field);
                // Handle comment action - don't show spinner for comment modal
                button.disabled = false;
                button.innerHTML = originalHTML;
                showCommentModal(field, solicitudId);
                return; // Exit early for comment action
            } else {
                console.error('Unknown action:', action);
                showNotification('Error: Acci√≥n no v√°lida', 'error');
            }

        } catch (error) {
            console.error('Error in compliance action:', error);
            
            // Handle specific error types
            if (error.message.includes('database is locked') || error.message.includes('Base de datos ocupada')) {
                showNotification('Base de datos ocupada. Intente nuevamente en unos segundos.', 'warning');
            } else {
                showNotification(`Error: ${error.message}`, 'error');
            }
        } finally {
            // Restore button state
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    };

    // Update compliance button visual state
    const updateComplianceButtonState = (button, action) => {
        if (!button) {
            console.warn('updateComplianceButtonState called with null button');
            return;
        }
        
        // Handle document fields differently
        const field = button.getAttribute('data-field');
        if (field && field.startsWith('doc_')) {
            // For document fields, find buttons within the same adjunto-item
            const docRow = button.closest('.adjunto-item');
            if (!docRow) {
                console.warn('Could not find adjunto-item for document button:', button);
                return;
            }
            
            const goodButton = docRow.querySelector('.btn-compliance.btn-good');
            const badButton = docRow.querySelector('.btn-compliance.btn-bad');
            
            if (!goodButton || !badButton) {
                console.warn('Could not find good/bad buttons in document row:', docRow);
                return;
            }
            
            // Reset all buttons
            goodButton.classList.remove('active');
            badButton.classList.remove('active');
            
            // Activate the selected button
            if (action === 'bueno') {
                goodButton.classList.add('active');
            } else if (action === 'malo') {
                badButton.classList.add('active');
            }
        } else {
            // Handle regular fields
            const row = button.closest('.info-row-with-check');
            if (!row) {
                console.warn('Could not find info-row-with-check for button:', button);
                return;
            }
            
            const goodButton = row.querySelector('.btn-compliance.btn-good');
            const badButton = row.querySelector('.btn-compliance.btn-bad');
            
            if (!goodButton || !badButton) {
                console.warn('Could not find good/bad buttons in row:', row);
                return;
            }
            
            // Reset all buttons
            goodButton.classList.remove('active');
            badButton.classList.remove('active');
            
            // Activate the selected button
            if (action === 'bueno') {
                goodButton.classList.add('active');
            } else if (action === 'malo') {
                badButton.classList.add('active');
            }
        }
    };

    // Show comment modal
    const showCommentModal = async (field, solicitudId) => {
        const modal = document.getElementById('modalComentarioCompliance');
        const campoNombre = document.getElementById('campo-nombre');
        const campoValor = document.getElementById('campo-valor');
        const comentarioTextarea = document.getElementById('comentario-compliance');
        
        if (!modal || !campoNombre || !campoValor || !comentarioTextarea) {
            console.error('Modal elements not found');
            showNotification('Error: No se pudo abrir el modal de comentarios', 'error');
            return;
        }
        
        // Set field information
        campoNombre.textContent = getFieldDisplayName(field);
        
        // Get the field value using the helper function
        const fieldValue = getFieldValue(field);
        campoValor.textContent = fieldValue;
        
        // Store field and solicitud ID for the save action
        modal.setAttribute('data-field', field);
        modal.setAttribute('data-solicitud-id', solicitudId);
        
        console.log('Opening comment modal for field:', field, 'solicitud:', solicitudId);
        
        // Load existing comment if any
        let hasExistingComment = false;
        try {
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Find comment for this specific field
                    const fieldComment = data.calificaciones.find(cal => cal.campo === field);
                    if (fieldComment && fieldComment.comentario) {
                        comentarioTextarea.value = fieldComment.comentario;
                        hasExistingComment = true;
                        console.log('Loaded existing comment:', fieldComment.comentario);
                    } else {
                        comentarioTextarea.value = '';
                        console.log('No existing comment found for field:', field);
                    }
                }
            }
        } catch (error) {
            console.error('Error loading existing comment:', error);
            comentarioTextarea.value = '';
        }
        
        // Update modal title based on whether there's an existing comment
        const modalTitle = document.getElementById('modalComentarioComplianceLabel');
        if (modalTitle) {
            const fieldName = getFieldDisplayName(field);
            if (hasExistingComment) {
                modalTitle.innerHTML = `<i class="fas fa-edit me-2"></i>Editar Comentario: ${fieldName}`;
            } else {
                modalTitle.innerHTML = `<i class="fas fa-comment-dots me-2"></i>Nuevo Comentario: ${fieldName}`;
            }
        }
        
        // Update character count
        updateCharCount('comentario-compliance', 'char-count-compliance', 500);
        
        // Show modal
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
    };

    // Save compliance comment
    const saveComplianceComment = async () => {
        console.log('=== saveComplianceComment START ===');
        
        const modal = document.getElementById('modalComentarioCompliance');
        console.log('Modal element:', modal);
        
        const field = modal.getAttribute('data-field');
        const solicitudId = modal.getAttribute('data-solicitud-id');
        const comentario = document.getElementById('comentario-compliance').value.trim();
        
        console.log('Extracted data:', { field, solicitudId, comentario });
        
        if (!comentario) {
            console.log('No comment provided');
            showNotification('Por favor ingrese un comentario', 'error');
            return;
        }

        if (!field || !solicitudId) {
            console.log('Missing field or solicitudId:', { field, solicitudId });
            showNotification('Error: Datos del campo o solicitud no encontrados', 'error');
            return;
        }

        try {
            console.log('=== API CALL START ===');
            console.log('Request URL:', `/workflow/api/solicitudes/${solicitudId}/comentario-compliance/`);
            console.log('Request data:', { campo: field, comentario: comentario });
            
            const csrfToken = getCSRFToken();
            console.log('CSRF Token:', csrfToken ? 'Present' : 'Missing');
            
            const requestBody = JSON.stringify({
                campo: field,
                comentario: comentario
            });
            console.log('Request body:', requestBody);
            
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/comentario-compliance/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: requestBody
            });

            console.log('=== API RESPONSE ===');
            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Response error text:', errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const responseText = await response.text();
            console.log('Response text:', responseText);
            
            let data;
            try {
                data = JSON.parse(responseText);
                console.log('Parsed response data:', data);
            } catch (parseError) {
                console.error('JSON parse error:', parseError);
                throw new Error(`Invalid JSON response: ${responseText}`);
            }
            
            if (data.success) {
                console.log('Success! Comment saved successfully');
                showNotification('Comentario guardado exitosamente', 'success');
                
                // Update visual state of comment button
                updateCommentButtonState(field, true);
                
                // Update bullets with new comment
                await updateBulletsAfterCommentSave();
                
                // Close modal
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                if (bootstrapModal) {
                    console.log('Closing modal via Bootstrap instance');
                    bootstrapModal.hide();
                } else {
                    console.log('Bootstrap modal instance not found, using fallback');
                    // Fallback if bootstrap modal instance not found
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                }
            } else {
                console.error('API returned success=false:', data);
                throw new Error(data.error || 'Error al guardar comentario');
            }

        } catch (error) {
            console.error('=== ERROR IN saveComplianceComment ===');
            console.error('Error type:', error.constructor.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            showNotification(`Error: ${error.message}`, 'error');
        }
        
        console.log('=== saveComplianceComment END ===');
    };

    // Get field display name
    const getFieldDisplayName = (field) => {
        // Handle document fields (doc_*)
        if (field.startsWith('doc_')) {
            const docId = field.replace('doc_', '');
            // Try to find the document name from the DOM
            const docButton = document.querySelector(`[data-field="${field}"]`);
            if (docButton) {
                const docRow = docButton.closest('.adjunto-item');
                if (docRow) {
                    const docNameElement = docRow.querySelector('.adjunto-name');
                    if (docNameElement) {
                        // Clean up the document name by removing file extension and size
                        let docName = docNameElement.textContent.trim();
                        
                        // Remove file extension and size if present
                        // Pattern: "Document Name (ext) size" -> "Document Name"
                        docName = docName.replace(/\s*\([^)]+\)\s*\d+\.?\d*\s*[KMGT]?B\s*$/, '');
                        docName = docName.replace(/\s*\(\.[^)]+\)\s*$/, '');
                        
                        return `Documento: ${docName}`;
                    }
                }
            }
            return `Documento ID: ${docId}`;
        }
        
        const fieldNames = {
            'empresa_privada': 'Empresa Privada',
            'cargo': 'Cargo',
            'tiempo_servicio': 'Tiempo de Servicio',
            'salario': 'Salario',
            'score': 'Score',
            'valor_equipo': 'Valor del Equipo',
            'abono': 'Abono',
            'monto_financiado': 'Monto Financiado',
            'plazo': 'Plazo',
            'rentabilidad': 'Rentabilidad',
            'total_letra': 'Total de Letra',
            'marca': 'Marca',
            'modelo': 'Modelo',
            'a√±o': 'A√±o',
            'transmision': 'Transmisi√≥n',
            'kilometraje': 'Kilometraje'
        };
        return fieldNames[field] || field;
    };

    // Get solicitud ID from URL
    const getSolicitudIdFromUrl = () => {
        const urlParts = window.location.pathname.split('/');
        const solicitudIndex = urlParts.indexOf('solicitud');
        if (solicitudIndex !== -1 && urlParts[solicitudIndex + 1]) {
            return urlParts[solicitudIndex + 1];
        }
        return null;
    };

    // Get CSRF token
    const getCSRFToken = () => {
        console.log('=== getCSRFToken START ===');
        
        // Try multiple selectors for CSRF token
        const selectors = [
            '[name=csrfmiddlewaretoken]',
            'input[name="csrfmiddlewaretoken"]',
            'meta[name="csrf-token"]',
            '[name="csrfmiddlewaretoken"]'
        ];
        
        let token = null;
        for (const selector of selectors) {
            const element = document.querySelector(selector);
            if (element) {
                token = element.value || element.getAttribute('content');
                console.log(`Found CSRF token with selector "${selector}":`, token ? 'Present' : 'Missing');
                break;
            }
        }
        
        if (!token) {
            console.warn('CSRF token not found with any selector');
            console.log('Available meta tags:', document.querySelectorAll('meta'));
            console.log('Available input elements:', document.querySelectorAll('input[name*="csrf"]'));
        }
        
        console.log('=== getCSRFToken END ===');
        return token || '';
    };

    // Character counter for compliance comment modal
    const updateCharCount = (textareaId, counterId, maxLength) => {
        const textarea = document.getElementById(textareaId);
        const counter = document.getElementById(counterId);
        
        if (textarea && counter) {
            const currentLength = textarea.value.length;
            counter.textContent = currentLength;
            
            if (currentLength > maxLength * 0.8) {
                counter.style.color = currentLength > maxLength ? '#dc3545' : '#ffc107';
            } else {
                counter.style.color = '#6c757d';
            }
        }
    };

    // PDF Download functionality
    const downloadMergedPDF = async () => {
        // Check if in view mode
        const isViewMode = document.querySelector('.view-mode-indicator') !== null;
        if (isViewMode) {
            showNotification('Modo solo lectura - No se pueden descargar documentos en solicitudes no asignadas', 'warning');
            return;
        }
        
        const btnDownload = document.getElementById('btn-download-merged-pdf');
        const originalContent = btnDownload.innerHTML;
        
        try {
            // Show loading state
            btnDownload.disabled = true;
            btnDownload.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando PDF...';
            
            // Get solicitud ID from URL - support both /solicitud/{id}/analisis/ and /solicitudes/{id}/detalle/
            const urlParts = window.location.pathname.split('/');
            let solicitudId = null;
            
            // Try to find solicitud ID in different URL patterns
            const solicitudIndex = urlParts.indexOf('solicitud');
            const solicitudesIndex = urlParts.indexOf('solicitudes');
            
            if (solicitudIndex !== -1 && urlParts[solicitudIndex + 1]) {
                // Pattern: /solicitud/{id}/analisis/
                solicitudId = urlParts[solicitudIndex + 1];
            } else if (solicitudesIndex !== -1 && urlParts[solicitudesIndex + 1]) {
                // Pattern: /solicitudes/{id}/detalle/
                solicitudId = urlParts[solicitudesIndex + 1];
            }
            
            // Validate solicitud ID
            if (!solicitudId || isNaN(parseInt(solicitudId))) {
                console.error('URL parts:', urlParts);
                console.error('Current pathname:', window.location.pathname);
                throw new Error('No se pudo obtener el ID de la solicitud de la URL');
            }
            
            console.log('Solicitud ID extracted:', solicitudId);
            
            // Make API call to download PDF
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/download-merged-pdf/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                // Try to get error message from response
                let errorMessage = 'Error al generar el PDF';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                } catch (e) {
                    // If response is not JSON, use status text
                    errorMessage = response.statusText || errorMessage;
                }
                throw new Error(errorMessage);
            }
            
            // Check if response is PDF
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/pdf')) {
                throw new Error('La respuesta no es un archivo PDF v√°lido');
            }
            
            // Get filename from response headers or use default
            const contentDisposition = response.headers.get('content-disposition');
            let filename = 'Solicitud_Documentos_Completos.pdf';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            // Create blob and download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            // Show success message
            showNotification('PDF generado y descargado exitosamente', 'success');
            
        } catch (error) {
            console.error('Error downloading PDF:', error);
            showNotification(`Error: ${error.message}`, 'error');
        } finally {
            // Restore button state
            btnDownload.disabled = false;
            btnDownload.innerHTML = originalContent;
        }
    };

    // PDF Resultado Consulta functionality
    const generatePdfResultadoConsulta = async () => {
        // Check if in view mode
        const isViewMode = document.querySelector('.view-mode-indicator') !== null;
        if (isViewMode) {
            showNotification('Modo solo lectura - No se pueden generar reportes en solicitudes no asignadas', 'warning');
            return;
        }
        
        const btnPdf = document.getElementById('btn-pdf-resultado-consulta');
        const originalContent = btnPdf.innerHTML;
        
        try {
            // Show loading state
            btnPdf.disabled = true;
            btnPdf.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando reporte...';
            
            // Get solicitud ID from URL
            const solicitudId = getSolicitudIdFromUrl();
            
            if (!solicitudId) {
                throw new Error('No se pudo obtener el ID de la solicitud');
            }
            
            console.log('Generating PDF resultado consulta for solicitud:', solicitudId);
            
            // Collect current analysis data from the page
            const analysisData = collectAnalysisData();
            
            // Make API call to generate PDF
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/pdf-resultado-consulta/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
                body: JSON.stringify(analysisData)
            });
            
            if (!response.ok) {
                // Try to get error message from response
                let errorMessage = 'Error al generar el reporte PDF';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                } catch (e) {
                    // If response is not JSON, use status text
                    errorMessage = response.statusText || errorMessage;
                }
                throw new Error(errorMessage);
            }
            
            // Check if response is PDF
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/pdf')) {
                throw new Error('La respuesta no es un archivo PDF v√°lido');
            }
            
            // Get filename from response headers or use default
            const contentDisposition = response.headers.get('content-disposition');
            let filename = `Resultado_Consulta_${solicitudId}.pdf`;
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            // Create blob and download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            // Show success message
            showNotification('Reporte PDF generado y descargado exitosamente', 'success');
            
        } catch (error) {
            console.error('Error generating PDF resultado consulta:', error);
            showNotification(`Error: ${error.message}`, 'error');
        } finally {
            // Restore button state
            btnPdf.disabled = false;
            btnPdf.innerHTML = originalContent;
        }
    };

    // Collect analysis data from the current page
    const collectAnalysisData = () => {
        const data = {
            analyst_comment: '',
            resultado_analisis: '',
            compliance_ratings: [],
            compliance_comments: [],
            field_values: {}
        };
        
        // Get analyst comment
        const analystTextarea = document.getElementById('comentario-analista-credito-text');
        if (analystTextarea) {
            data.analyst_comment = analystTextarea.value.trim();
        }
        
        // Get resultado de an√°lisis
        const resultadoSelect = document.getElementById('resultado-analisis');
        if (resultadoSelect) {
            data.resultado_analisis = resultadoSelect.value;
        }
        
        // Collect compliance ratings and comments
        const allComplianceButtons = document.querySelectorAll('.btn-compliance[data-action="bueno"], .btn-compliance[data-action="malo"]');
        const processedFields = new Set();
        
        allComplianceButtons.forEach(button => {
            const field = button.getAttribute('data-field');
            if (processedFields.has(field)) return;
            processedFields.add(field);
            
            const row = button.closest('.info-row-with-check, .adjunto-item');
            if (row) {
                const goodButton = row.querySelector('.btn-compliance.btn-good');
                const badButton = row.querySelector('.btn-compliance.btn-bad');
                const commentButton = row.querySelector('.btn-compliance.btn-comment');
                
                let rating = null;
                if (goodButton && goodButton.classList.contains('active')) {
                    rating = 'bueno';
                } else if (badButton && badButton.classList.contains('active')) {
                    rating = 'malo';
                }
                
                if (rating) {
                    data.compliance_ratings.push({
                        field: field,
                        rating: rating
                    });
                }
                
                // Check for comment
                if (commentButton && commentButton.classList.contains('has-comment')) {
                    // This would contain the comment if we could extract it from the modal
                    // For now, we'll rely on the backend to provide the comment
                    data.compliance_comments.push({
                        field: field,
                        has_comment: true
                    });
                }
                
                // Get field value from the page
                const fieldValue = getFieldValue(field);
                if (fieldValue) {
                    data.field_values[field] = fieldValue;
                }
            }
        });
        
        return data;
    };

    // Notification system
    const showNotification = (message, type = 'info') => {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.custom-notification');
        existingNotifications.forEach(notification => notification.remove());
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `custom-notification alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        notification.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    };

    // Update comment button visual state
    const updateCommentButtonState = (field, hasComment) => {
        console.log('updateCommentButtonState called:', { field, hasComment });
        
        const commentButton = document.querySelector(`[data-field="${field}"][data-action="comentario"]`);
        if (commentButton) {
            console.log('Found comment button for field:', field);
            // Always restore the comment icon
            commentButton.innerHTML = '<i class="fas fa-comment-dots"></i>';
            
            if (hasComment) {
                commentButton.classList.add('has-comment');
                // Update title based on field type
                if (field.startsWith('doc_')) {
                    commentButton.title = 'Ver/editar comentario del documento';
                } else {
                    commentButton.title = 'Ver/editar comentario existente';
                }
                console.log('Added has-comment class to button');
            } else {
                commentButton.classList.remove('has-comment');
                // Update title based on field type
                if (field.startsWith('doc_')) {
                    commentButton.title = 'Comentar documento';
                } else {
                    commentButton.title = 'Agregar comentario';
                }
                console.log('Removed has-comment class from button');
            }
        } else {
            console.warn('Comment button not found for field:', field);
        }
    };

    // Load existing compliance ratings
    const loadExistingComplianceRatings = async () => {
        const solicitudId = getSolicitudIdFromUrl();
        
        if (!solicitudId) {
            console.error('No se pudo obtener el ID de la solicitud');
            return;
        }

        try {
            console.log('Loading existing compliance ratings for solicitud:', solicitudId);
            
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });

            if (!response.ok) {
                console.error('Failed to load compliance ratings:', response.status, response.statusText);
                return;
            }

            const data = await response.json();
            console.log('Compliance ratings response:', data);
            
            if (data.success && data.calificaciones) {
                console.log('Processing', data.calificaciones.length, 'calificaciones');
                
                data.calificaciones.forEach(calificacion => {
                    console.log('Processing calificacion:', calificacion);
                    
                    // Update compliance button states
                    if (calificacion.estado && calificacion.estado !== 'sin_calificar') {
                        const button = document.querySelector(`[data-field="${calificacion.campo}"][data-action="${calificacion.estado}"]`);
                        if (button) {
                            console.log('Found button for', calificacion.campo, calificacion.estado);
                            updateComplianceButtonState(button, calificacion.estado);
                        } else {
                            console.warn('Button not found for', calificacion.campo, calificacion.estado);
                        }
                    }
                    
                    // Update comment button states
                    if (calificacion.comentario) {
                        console.log('Found comment for', calificacion.campo);
                        updateCommentButtonState(calificacion.campo, true);
                    }
                });
                
                // Load and display compliance comments as bullet points
                loadComplianceCommentsAsBullets(data.calificaciones);
            } else {
                console.warn('No calificaciones found or API returned success=false');
                // Show empty bullets section
                loadComplianceCommentsAsBullets([]);
            }
        } catch (error) {
            console.error('Error loading compliance ratings:', error);
            // Show empty bullets section on error
            loadComplianceCommentsAsBullets([]);
        }
    };

    // Get field value from DOM
    const getFieldValue = (field) => {
        const fieldButton = document.querySelector(`[data-field="${field}"]`);
        if (!fieldButton) {
            return 'Sin valor';
        }
        
        // Handle document fields differently
        if (field.startsWith('doc_')) {
            const docRow = fieldButton.closest('.adjunto-item');
            if (docRow) {
                const docNameElement = docRow.querySelector('.adjunto-name');
                if (docNameElement) {
                    return docNameElement.textContent.trim();
                }
            }
        } else {
            // Handle regular fields
            const fieldRow = fieldButton.closest('.info-row-with-check');
            if (fieldRow) {
                const fieldValueElement = fieldRow.querySelector('.info-value');
                return fieldValueElement ? fieldValueElement.textContent.trim() : 'Sin valor';
            }
        }
        
        return 'Sin valor';
    };

    // Load and display compliance comments as bullet points
    const loadComplianceCommentsAsBullets = (calificaciones) => {
        const bulletsContent = document.getElementById('bullets-content');
        if (!bulletsContent) {
            console.error('Bullets content container not found');
            return;
        }

        // Filter calificaciones that have comments (excluding analyst comments)
        const commentsWithContent = calificaciones.filter(cal => 
            cal.comentario && 
            cal.comentario.trim() && 
            !cal.campo.startsWith('comentario_analista_credito_')
        );

        if (commentsWithContent.length === 0) {
            // Show placeholder when no comments
            bulletsContent.innerHTML = `
                <div class="bullets-placeholder">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>No hay comentarios de campos disponibles</small>
                </div>
            `;
            return;
        }

        // Create enhanced bullet points HTML with campo title, value, and comment
        const bulletsHTML = commentsWithContent.map(cal => {
            const fieldName = getFieldDisplayName(cal.campo);
            const fieldValue = getFieldValue(cal.campo);
            const comment = cal.comentario.trim();
            
            return `
                <div class="bullet-item" data-field="${cal.campo}">
                    <div class="bullet-content">
                        <div class="bullet-header">
                            <strong class="bullet-title">${fieldName}</strong>
                            <span class="bullet-value">${escapeHtml(fieldValue)}</span>
                        </div>
                        <div class="bullet-comment">
                            <i class="fas fa-comment-dots text-primary me-1"></i>
                            ${escapeHtml(comment)}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Update bullets content
        bulletsContent.innerHTML = bulletsHTML;
        
        console.log(`Loaded ${commentsWithContent.length} compliance comments as bullet points`);
    };

    // Update bullets when a new comment is saved
    const updateBulletsAfterCommentSave = async () => {
        const solicitudId = getSolicitudIdFromUrl();
        if (!solicitudId) return;

        try {
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.calificaciones) {
                    loadComplianceCommentsAsBullets(data.calificaciones);
                }
            }
        } catch (error) {
            console.error('Error updating bullets after comment save:', error);
        }
    };

    // Helper function to escape HTML
    const escapeHtml = (text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };

    // Initialize character counters when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        // Check if solicitud is assigned and block content if not
        const isSolicitudAsignada = {% if solicitud.asignada_a %}true{% else %}false{% endif %};
        
        // Global state for view mode
        let isViewMode = false;
        
        if (!isSolicitudAsignada) {
            // Block all interactive elements except navigation buttons and view button
            const blockInteractiveElements = () => {
                document.querySelectorAll('.btn-compliance, .btn:not(.btn-outline-warning):not(.btn-outline-info), textarea, input, select').forEach(element => {
                    // Skip navigation buttons and view button
                    if (element.textContent.includes('Volver a Bandejas') || 
                        element.classList.contains('btn-outline-warning') ||
                        element.id === 'btn-ver-solicitud') {
                        return;
                    }
                    element.disabled = true;
                    element.style.opacity = '0.5';
                    element.style.pointerEvents = 'none';
                });
            };
            
            // Add overlay to main content
            const addBlockingOverlay = () => {
                const mainContent = document.querySelector('.main-layout-row');
                if (mainContent) {
                    // Remove existing overlay if any
                    const existingOverlay = mainContent.querySelector('.blocking-overlay');
                    if (existingOverlay) {
                        existingOverlay.remove();
                    }
                    
                    const overlay = document.createElement('div');
                    overlay.className = 'position-absolute w-100 h-100 bg-light bg-opacity-75 d-flex align-items-center justify-content-center blocking-overlay';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.zIndex = '1000';
                    overlay.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-lock fa-3x text-warning mb-3"></i>
                            <h5 class="text-warning">Contenido Bloqueado</h5>
                            <p class="text-muted">La solicitud debe ser asignada antes de poder realizar el an√°lisis</p>
                        </div>
                    `;
                    mainContent.style.position = 'relative';
                    mainContent.appendChild(overlay);
                }
            };
            
            // Remove overlay and enable view mode
            const enableViewMode = () => {
                isViewMode = true;
                
                // Hide the blocking alert
                const blockingAlert = document.getElementById('solicitud-bloqueada-alert');
                if (blockingAlert) {
                    blockingAlert.style.display = 'none';
                }
                
                // Remove blocking overlay
                const mainContent = document.querySelector('.main-layout-row');
                if (mainContent) {
                    const overlay = mainContent.querySelector('.blocking-overlay');
                    if (overlay) {
                        overlay.remove();
                    }
                }
                
                // Enable all elements but keep them read-only
                document.querySelectorAll('.btn-compliance, .btn, textarea, input, select').forEach(element => {
                    element.disabled = false;
                    element.style.opacity = '1';
                    element.style.pointerEvents = 'auto';
                    
                    // Make interactive elements read-only or non-functional
                    if (element.classList.contains('btn-compliance')) {
                        element.classList.add('view-mode-disabled');
                        element.title = 'Modo solo lectura - La solicitud debe ser asignada para interactuar';
                    }
                    
                    if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
                        element.readOnly = true;
                        element.classList.add('read-only-element');
                    }
                    
                    if (element.tagName === 'SELECT') {
                        element.disabled = true;
                        element.classList.add('read-only-element');
                    }
                });
                
                // Add view mode indicator to header
                const header = document.querySelector('.card-header');
                if (header) {
                    // Remove existing indicator if any
                    const existingIndicator = header.querySelector('.view-mode-indicator');
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }
                    
                    const viewModeIndicator = document.createElement('div');
                    viewModeIndicator.className = 'view-mode-indicator';
                    viewModeIndicator.innerHTML = `
                        <div class="view-mode-badge">
                            <i class="fas fa-eye me-2"></i>Modo Solo Lectura
                        </div>
                    `;
                    header.style.position = 'relative';
                    header.appendChild(viewModeIndicator);
                }
                
                // Add view mode indicator to main sections
                const mainSections = document.querySelectorAll('.main-section-container, .adjuntos-container');
                mainSections.forEach(section => {
                    // Remove existing indicator if any
                    const existingIndicator = section.querySelector('.view-mode-indicator');
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }
                    
                    const viewModeIndicator = document.createElement('div');
                    viewModeIndicator.className = 'view-mode-indicator';
                    viewModeIndicator.innerHTML = `
                        <div class="view-mode-badge">
                            <i class="fas fa-eye me-2"></i>Solo Lectura
                        </div>
                    `;
                    section.style.position = 'relative';
                    section.appendChild(viewModeIndicator);
                });
                
                // Show notification
                showNotification('Modo solo lectura activado - Puede ver los detalles de la solicitud', 'info');
                
                // Update button text
                const btnVerSolicitud = document.getElementById('btn-ver-solicitud');
                if (btnVerSolicitud) {
                    btnVerSolicitud.innerHTML = '<i class="fas fa-check me-1"></i>Modo Lectura Activo';
                    btnVerSolicitud.classList.remove('btn-outline-info');
                    btnVerSolicitud.classList.add('btn-success');
                    btnVerSolicitud.disabled = true;
                }
            };
            
            // Add event listener for "Ver Solicitud" button
            const btnVerSolicitud = document.getElementById('btn-ver-solicitud');
            if (btnVerSolicitud) {
                btnVerSolicitud.addEventListener('click', enableViewMode);
            }
            
            // Initialize blocking state
            blockInteractiveElements();
            addBlockingOverlay();
        }
        
        // Initialize compliance comment modal character counter
        const comentarioCompliance = document.getElementById('comentario-compliance');
        if (comentarioCompliance) {
            comentarioCompliance.addEventListener('input', () => {
                updateCharCount('comentario-compliance', 'char-count-compliance', 500);
            });
        }

        // Initialize analista comment character counter and change tracking
        const comentarioAnalista = document.getElementById('comentario-analista-credito-text');
        if (comentarioAnalista) {
            comentarioAnalista.addEventListener('input', () => {
                updateCharCount('comentario-analista-credito-text', 'char-count-analista-credito', 2000);
                
                // Check for unsaved changes
                const currentContent = comentarioAnalista.value.trim();
                const originalContent = comentarioAnalista.getAttribute('data-original-content') || '';
                const hasChanges = currentContent !== originalContent;
                
                // Update button appearance
                const saveButton = document.getElementById('btn-enviar-analista-credito');
                if (saveButton) {
                    if (hasChanges && currentContent) {
                        saveButton.classList.add('btn-warning');
                        saveButton.classList.remove('btn-light');
                        saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Cambios';
                    } else {
                        saveButton.classList.remove('btn-warning');
                        saveButton.classList.add('btn-light');
                        saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Guardar An√°lisis';
                    }
                }
            });
        }

        // Initialize PDF download button
        const btnDownloadPDF = document.getElementById('btn-download-merged-pdf');
        if (btnDownloadPDF) {
            btnDownloadPDF.addEventListener('click', downloadMergedPDF);
        }

        // Add event listeners for compliance buttons
        document.querySelectorAll('.btn-compliance').forEach(button => {
            button.addEventListener('click', (event) => {
                handleComplianceAction(event.currentTarget);
            });
        });

        // Add event listener for the save compliance comment button
        const btnGuardarComentarioCompliance = document.getElementById('btn-guardar-comentario-compliance');
        console.log('Save compliance comment button:', btnGuardarComentarioCompliance);
        if (btnGuardarComentarioCompliance) {
            console.log('Adding click event listener to save compliance comment button');
            btnGuardarComentarioCompliance.addEventListener('click', (event) => {
                console.log('Save compliance comment button clicked!');
                console.log('Event:', event);
                saveComplianceComment();
            });
        } else {
            console.error('Save compliance comment button not found!');
        }

        // Load existing compliance ratings and bullets
        loadExistingComplianceRatings();

        // Enhanced file icon hover effects
        document.querySelectorAll('.adjunto-item').forEach(item => {
            item.addEventListener('mouseenter', function() {
                const icon = this.querySelector('.adjunto-icon i');
                if (icon) {
                    icon.style.transform = 'scale(1.2)';
                }
            });
            
            item.addEventListener('mouseleave', function() {
                const icon = this.querySelector('.adjunto-icon i');
                if (icon) {
                    icon.style.transform = 'scale(1)';
                }
            });
        });





        // Add event listener for analyst comment save button
        const btnEnviarAnalista = document.getElementById('btn-enviar-analista-credito');
        if (btnEnviarAnalista) {
            btnEnviarAnalista.addEventListener('click', handleAnalystCommentSubmit);
        }

        // Add event listener for PDF resultado consulta button
        const btnPdfResultadoConsulta = document.getElementById('btn-pdf-resultado-consulta');
        if (btnPdfResultadoConsulta) {
            btnPdfResultadoConsulta.addEventListener('click', generatePdfResultadoConsulta);
        }

        // Load existing analyst comments
        loadExistingAnalystComments();

        // Add keyboard shortcut for saving (Ctrl+S)
        document.addEventListener('keydown', (event) => {
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                const textarea = document.getElementById('comentario-analista-credito-text');
                if (document.activeElement === textarea) {
                    event.preventDefault();
                    handleAnalystCommentSubmit({ preventDefault: () => {}, target: document.getElementById('btn-enviar-analista-credito') });
                }
            }
        });

        // Warn user before leaving page with unsaved changes
        window.addEventListener('beforeunload', (event) => {
            const textarea = document.getElementById('comentario-analista-credito-text');
            if (textarea) {
                const currentContent = textarea.value.trim();
                const originalContent = textarea.getAttribute('data-original-content') || '';
                const hasChanges = currentContent !== originalContent && currentContent;
                
                if (hasChanges) {
                    event.preventDefault();
                    event.returnValue = 'Tiene cambios sin guardar. ¬øEst√° seguro de que desea salir?';
                    return 'Tiene cambios sin guardar. ¬øEst√° seguro de que desea salir?';
                }
            }
        });

        // Synchronization between Resultado de An√°lisis and Subestado Selector
        const setupResultadoSubestadoSync = () => {
            const resultadoAnalisisSelect = document.getElementById('resultado-analisis');
            const subestadoSelect = document.getElementById('subestadoSelect');
            
            if (!resultadoAnalisisSelect || !subestadoSelect) {
                return; // One or both selects not found
            }

            // Create mapping between resultado values and subestado text
            const createMapping = () => {
                const mapping = {};
                const subestadoOptions = Array.from(subestadoSelect.options);
                
                subestadoOptions.forEach(option => {
                    if (option.value && option.text) {
                        const optionText = option.text.trim().toLowerCase();
                        if (optionText === 'aprobado') {
                            mapping['Aprobado'] = option.value;
                        } else if (optionText === 'rechazado') {
                            mapping['Rechazado'] = option.value;
                        } else if (optionText === 'alternativa') {
                            mapping['Alternativa'] = option.value;
                        }
                    }
                });
                
                return mapping;
            };

            const mapping = createMapping();
            console.log('Resultado-Subestado mapping:', mapping);

            // Function to sync from resultado to subestado
            const syncResultadoToSubestado = () => {
                const resultadoValue = resultadoAnalisisSelect.value;
                if (resultadoValue && mapping[resultadoValue]) {
                    const targetSubestadoValue = mapping[resultadoValue];
                    if (subestadoSelect.value !== targetSubestadoValue) {
                        subestadoSelect.value = targetSubestadoValue;
                        console.log(`Synced resultado "${resultadoValue}" to subestado "${targetSubestadoValue}"`);
                        
                        // Trigger change event on subestado select
                        const changeEvent = new Event('change', { bubbles: true });
                        subestadoSelect.dispatchEvent(changeEvent);
                    }
                }
            };

            // Function to sync from subestado to resultado
            const syncSubestadoToResultado = () => {
                const subestadoValue = subestadoSelect.value;
                const subestadoText = subestadoSelect.options[subestadoSelect.selectedIndex]?.text?.trim();
                
                if (subestadoText) {
                    let targetResultadoValue = '';
                    const lowerSubestadoText = subestadoText.toLowerCase();
                    
                    if (lowerSubestadoText === 'aprobado') {
                        targetResultadoValue = 'Aprobado';
                    } else if (lowerSubestadoText === 'rechazado') {
                        targetResultadoValue = 'Rechazado';
                    } else if (lowerSubestadoText === 'alternativa') {
                        targetResultadoValue = 'Alternativa';
                    }
                    
                    if (targetResultadoValue && resultadoAnalisisSelect.value !== targetResultadoValue) {
                        resultadoAnalisisSelect.value = targetResultadoValue;
                        console.log(`Synced subestado "${subestadoText}" to resultado "${targetResultadoValue}"`);
                        
                        // Update the data attribute for change tracking
                        if (targetResultadoValue === resultadoAnalisisSelect.getAttribute('data-original-resultado')) {
                            resultadoAnalisisSelect.removeAttribute('data-has-changes');
                        } else {
                            resultadoAnalisisSelect.setAttribute('data-has-changes', 'true');
                        }
                    }
                }
            };

            // Add event listeners for synchronization
            resultadoAnalisisSelect.addEventListener('change', (event) => {
                console.log('Resultado de an√°lisis changed to:', event.target.value);
                syncResultadoToSubestado();
            });

            subestadoSelect.addEventListener('change', (event) => {
                console.log('Subestado changed to:', event.target.value, 'Text:', event.target.options[event.target.selectedIndex]?.text);
                syncSubestadoToResultado();
            });

            // Initial sync on page load if both have values
            setTimeout(() => {
                if (resultadoAnalisisSelect.value && !subestadoSelect.value) {
                    syncResultadoToSubestado();
                } else if (subestadoSelect.value && !resultadoAnalisisSelect.value) {
                    syncSubestadoToResultado();
                } else if (resultadoAnalisisSelect.value && subestadoSelect.value) {
                    // Both have values, sync resultado to subestado as it's the primary field
                    syncResultadoToSubestado();
                }
            }, 500); // Small delay to ensure DOM is fully loaded
        };

        // Initialize synchronization
        setupResultadoSubestadoSync();
    });





    // Validate all fields are rated and analyst comment is filled before stage change
    const validateAllFieldsRated = () => {
        const allComplianceButtons = document.querySelectorAll('.btn-compliance[data-action="bueno"], .btn-compliance[data-action="malo"]');
        const unratedFields = [];
        
        allComplianceButtons.forEach(button => {
            const field = button.getAttribute('data-field');
            const action = button.getAttribute('data-action');
            
            // Check if this field has a rating (good or bad button is active)
            const row = button.closest('.info-row-with-check, .adjunto-item');
            if (row) {
                const goodButton = row.querySelector('.btn-compliance.btn-good');
                const badButton = row.querySelector('.btn-compliance.btn-bad');
                
                if (goodButton && badButton) {
                    const hasRating = goodButton.classList.contains('active') || badButton.classList.contains('active');
                    if (!hasRating) {
                        const fieldName = getFieldDisplayName(field);
                        unratedFields.push(fieldName);
                    }
                }
            }
        });
        
        // Check if analyst comment is filled
        const analystTextarea = document.getElementById('comentario-analista-credito-text');
        const hasAnalystComment = analystTextarea && analystTextarea.value.trim().length > 0;
        
        return {
            isValid: unratedFields.length === 0 && hasAnalystComment,
            unratedFields: [...new Set(unratedFields)], // Remove duplicates
            hasAnalystComment: hasAnalystComment
        };
    };

    // Generate analysis summary for confirmation
    const generateAnalysisSummary = () => {
        const summary = {
            totalFields: 0,
            ratedFields: 0,
            goodRatings: 0,
            badRatings: 0,
            comments: 0,
            analystComment: '',
            unratedFields: []
        };
        
        // Count all compliance buttons
        const allComplianceButtons = document.querySelectorAll('.btn-compliance[data-action="bueno"], .btn-compliance[data-action="malo"]');
        const processedFields = new Set();
        
        allComplianceButtons.forEach(button => {
            const field = button.getAttribute('data-field');
            if (processedFields.has(field)) return;
            processedFields.add(field);
            
            summary.totalFields++;
            
            const row = button.closest('.info-row-with-check, .adjunto-item');
            if (row) {
                const goodButton = row.querySelector('.btn-compliance.btn-good');
                const badButton = row.querySelector('.btn-compliance.btn-bad');
                const commentButton = row.querySelector('.btn-compliance.btn-comment');
                
                if (goodButton && badButton) {
                    const hasGoodRating = goodButton.classList.contains('active');
                    const hasBadRating = badButton.classList.contains('active');
                    
                    if (hasGoodRating || hasBadRating) {
                        summary.ratedFields++;
                        if (hasGoodRating) summary.goodRatings++;
                        if (hasBadRating) summary.badRatings++;
                    } else {
                        const fieldName = getFieldDisplayName(field);
                        summary.unratedFields.push(fieldName);
                    }
                }
                
                // Check for comments
                if (commentButton && commentButton.classList.contains('has-comment')) {
                    summary.comments++;
                }
            }
        });
        
        // Get analyst comment
        const analystTextarea = document.getElementById('comentario-analista-credito-text');
        if (analystTextarea) {
            summary.analystComment = analystTextarea.value.trim();
        }
        
        return summary;
    };

        // Show confirmation modal with analysis summary
    const showStageChangeConfirmation = (targetStageName) => {
        const validation = validateAllFieldsRated();
        const summary = generateAnalysisSummary();
        
        if (!validation.isValid) {
            // Show validation error modal
            const errorModal = `
                <div class="modal fade" id="validationErrorModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Validaci√≥n Requerida
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>No se puede cambiar de etapa</strong> - Se requieren las siguientes validaciones:
                                        </div>
                                
                                ${!validation.hasAnalystComment ? `
                                <div class="mb-3">
                                    <h6><i class="fas fa-user-md me-2"></i>An√°lisis General Requerido</h6>
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        <strong>Falta el an√°lisis general</strong> - Debe completar el an√°lisis general antes de cambiar de etapa.
                                        <br><br>
                                        <strong>Instrucciones:</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>Complete el campo "An√°lisis General" en la secci√≥n de Comentarios de Analista</li>
                                            <li>El an√°lisis debe contener al menos un car√°cter</li>
                                            <li>Guarde el an√°lisis antes de intentar cambiar de etapa</li>
                                        </ul>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${validation.unratedFields.length > 0 ? `
                                <div class="mb-3">
                                    <h6><i class="fas fa-list-check me-2"></i>Campos Pendientes de Calificaci√≥n</h6>
                                    <ul class="list-group">
                                        ${validation.unratedFields.map(field => 
                                            `<li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>${field}</span>
                                                <span class="badge bg-warning text-dark">Pendiente</span>
                                            </li>`
                                        ).join('')}
                                    </ul>
                                    <div class="alert alert-info mt-2">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        <strong>Instrucciones para calificar campos:</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>Haga clic en el bot√≥n <i class="fas fa-check text-success"></i> para marcar como "Bueno"</li>
                                            <li>Haga clic en el bot√≥n <i class="fas fa-times text-danger"></i> para marcar como "Malo"</li>
                                            <li>Opcionalmente, agregue comentarios con el bot√≥n <i class="fas fa-comment-dots text-primary"></i></li>
                                        </ul>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('validationErrorModal');
            if (existingModal) existingModal.remove();
            
            // Add modal to page and show
            document.body.insertAdjacentHTML('beforeend', errorModal);
            const modal = new bootstrap.Modal(document.getElementById('validationErrorModal'));
            modal.show();
            
            return false;
        }
        
        // Show confirmation modal with summary
        const confirmationModal = `
            <div class="modal fade" id="stageChangeConfirmationModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-arrow-right me-2"></i>
                                Confirmar Cambio de Etapa
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Resumen del An√°lisis</strong> - Revise los detalles antes de cambiar a: <strong>${targetStageName}</strong>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Total de campos:</span>
                                                <span class="badge bg-secondary">${summary.totalFields}</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Campos calificados:</span>
                                                <span class="badge bg-success">${summary.ratedFields}</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Calificaciones buenas:</span>
                                                <span class="badge bg-success">${summary.goodRatings}</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Calificaciones malas:</span>
                                                <span class="badge bg-danger">${summary.badRatings}</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Comentarios agregados:</span>
                                                <span class="badge bg-info">${summary.comments}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fas fa-user-md me-2"></i>An√°lisis General</h6>
                                        </div>
                                        <div class="card-body">
                                            ${summary.analystComment ? 
                                                `<div class="analysis-preview">
                                                    <p class="mb-0">${escapeHtml(summary.analystComment)}</p>
                                                </div>` :
                                                `<div class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    No se ha agregado an√°lisis general
                                                </div>`
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${summary.badRatings > 0 ? `
                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Atenci√≥n:</strong> Hay ${summary.badRatings} campo(s) calificado(s) como "Malo". 
                                    Aseg√∫rese de que esto sea correcto antes de proceder.
                                </div>
                            ` : ''}
                            
                            ${!summary.analystComment ? `
                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-user-md me-2"></i>
                                    <strong>An√°lisis General:</strong> Se ha incluido un an√°lisis general en la confirmaci√≥n. 
                                    Este es un requisito obligatorio para el cambio de etapa.
                                </div>
                            ` : ''}
                            
                            <!-- Selector de subestado (mostrar solo si la etapa tiene subestados) -->
                            <div id="selectorSubestado" class="mt-3" style="display: none;">
                                <div class="alert alert-warning">
                                    <h6 class="fw-bold mb-3 text-dark" style="font-size: 1rem;">
                                        <i class="fas fa-list-ul text-primary me-2"></i>
                                        Seleccionar estado espec√≠fico para <strong>${targetStageName}</strong>:
                                    </h6>
                                    <div class="bg-white border border-warning border-opacity-25 rounded-3 p-3">
                                        <select id="subestadoSelect" class="form-select form-select-lg" style="border: 2px solid #e9ecef; border-radius: 8px; font-weight: 600;">
                                            <option value="">Cargando estados...</option>
                                        </select>
                                        <small class="text-muted mt-2 d-block">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Debe seleccionar un estado espec√≠fico para continuar
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                            <button type="button" class="btn btn-primary" id="confirmStageChange">
                                <i class="fas fa-check me-1"></i>Confirmar Cambio de Etapa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('stageChangeConfirmationModal');
        if (existingModal) existingModal.remove();
        
        // Add modal to page and show
        document.body.insertAdjacentHTML('beforeend', confirmationModal);
        const modal = new bootstrap.Modal(document.getElementById('stageChangeConfirmationModal'));
        modal.show();
        
        // Load subestados for the target stage after modal is shown
        modal._element.addEventListener('shown.bs.modal', async () => {
            await loadSubestadosForStage(targetStageName);
        });
        
        // Add event listener for confirmation
        document.getElementById('confirmStageChange').addEventListener('click', () => {
            // Validate subestado selection if subestados are available
            const subestadoSelect = document.getElementById('subestadoSelect');
            const selectorSubestado = document.getElementById('selectorSubestado');
            
            if (selectorSubestado && selectorSubestado.style.display !== 'none') {
                const selectedSubestado = subestadoSelect.value;
                if (!selectedSubestado) {
                    alert('Debe seleccionar un estado espec√≠fico para continuar.');
                    return;
                }
            }
            
            modal.hide();
            // Proceed with stage change
            proceedWithStageChange(targetStageName);
        });
        
        return true;
    };

    // Function to load subestados for a target stage
    const loadSubestadosForStage = async (targetStageName) => {
        try {
            // Find the target stage ID from the dropdown menu
            const stageButtons = document.querySelectorAll('.dropdown-item');
            let targetStageId = null;
            
            for (const button of stageButtons) {
                const buttonText = button.textContent.trim();
                if (buttonText.includes(targetStageName)) {
                    const onclick = button.getAttribute('onclick');
                    if (onclick) {
                        const match = onclick.match(/handleTransicionClick\((\d+),/);
                        if (match) {
                            targetStageId = parseInt(match[1]);
                            break;
                        }
                    }
                }
            }
            
            if (!targetStageId) {
                console.log('Could not find stage ID for:', targetStageName);
                return;
            }
            
            console.log('Loading subestados for stage ID:', targetStageId);
            
            // Load subestados from API
            const response = await fetch(`/workflow/api/etapas/${targetStageId}/subestados/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            if (!response.ok) {
                console.error('Failed to load subestados:', response.status);
                return;
            }
            
            const data = await response.json();
            console.log('Subestados response:', data);
            
            if (data.success && data.subestados && data.subestados.length > 0) {
                // Show subestado selector
                const selectorSubestado = document.getElementById('selectorSubestado');
                const subestadoSelect = document.getElementById('subestadoSelect');
                
                if (selectorSubestado && subestadoSelect) {
                    // Clear existing options
                    subestadoSelect.innerHTML = '<option value="">Seleccionar estado...</option>';
                    
                    // Add subestado options
                    data.subestados.forEach(subestado => {
                        const option = document.createElement('option');
                        option.value = subestado.id;
                        option.textContent = subestado.nombre;
                        subestadoSelect.appendChild(option);
                    });
                    
                    // Show the selector
                    selectorSubestado.style.display = 'block';
                    console.log('Subestado selector shown with', data.subestados.length, 'options');
                }
            } else {
                console.log('No subestados found for this stage');
                // Hide the selector if it's visible
                const selectorSubestado = document.getElementById('selectorSubestado');
                if (selectorSubestado) {
                    selectorSubestado.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('Error loading subestados:', error);
        }
    };

    // Proceed with actual stage change
    const proceedWithStageChange = (targetStageName) => {
        // Find the stage change button and trigger it
        const stageButtons = document.querySelectorAll('.dropdown-item');
        for (const button of stageButtons) {
            const buttonText = button.textContent.trim();
            if (buttonText.includes(targetStageName)) {
                // Extract the onclick parameters and execute
                const onclick = button.getAttribute('onclick');
                if (onclick) {
                    // Parse the onclick to get the original parameters
                    const match = onclick.match(/handleTransicionClick\((\d+),\s*'([^']+)',\s*(true|false),\s*(\d+)\)/);
                    if (match) {
                        const [, etapaId, etapaNombre, puedeRealizar, requisitosFaltantes] = match;
                        console.log('Extracted stage change parameters:', { etapaId, etapaNombre, puedeRealizar, requisitosFaltantes });
                        // Call the original stage change function
                        callOriginalStageChange(parseInt(etapaId), etapaNombre, puedeRealizar === 'true', parseInt(requisitosFaltantes));
                        return; // Exit after finding the correct button
                    } else {
                        console.error('Failed to parse onclick attribute:', onclick);
                    }
                } else {
                    console.error('No onclick attribute found on button');
                }
                break;
            }
        }
        
        // If we get here, we couldn't find the button
        console.error('Could not find stage change button for:', targetStageName);
        showNotification(`Error: No se pudo encontrar el bot√≥n para cambiar a ${targetStageName}`, 'error');
    };

    // Call the original stage change function
    const callOriginalStageChange = async (etapaId, etapaNombre, puedeRealizar, requisitosFaltantes) => {
        try {
            console.log('=== callOriginalStageChange START ===');
            console.log('Parameters:', { etapaId, etapaNombre, puedeRealizar, requisitosFaltantes });
            
            const solicitudId = getSolicitudIdFromUrl();
            if (!solicitudId) {
                showNotification('Error: No se pudo obtener el ID de la solicitud', 'error');
                return;
            }

            console.log('Solicitud ID:', solicitudId);
            console.log('Etapa ID:', etapaId);
            console.log('Etapa Nombre:', etapaNombre);

            // Show loading state
            showNotification(`Cambiando a etapa: ${etapaNombre}...`, 'info');

            // Get selected subestado if available
            const subestadoSelect = document.getElementById('subestadoSelect');
            const selectedSubestado = subestadoSelect ? subestadoSelect.value : null;
            
            const requestBody = {
                etapa_destino_id: etapaId,
                comentarios_analista: document.getElementById('comentario-analista-credito-text')?.value || ''
            };
            
            // Add subestado if selected
            if (selectedSubestado) {
                requestBody.subestado_id = parseInt(selectedSubestado);
                console.log('Including subestado ID:', selectedSubestado);
            }
            
            console.log('Request body:', requestBody);

            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify(requestBody)
            });

            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Response error text:', errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            console.log('Response data:', data);

            if (data.success) {
                showNotification(`‚úÖ Solicitud cambiada exitosamente a: ${etapaNombre}`, 'success');
                // Redirect to bandeja mixta after successful stage change
                setTimeout(() => {
                    window.location.href = "{% url 'workflow:vista_mixta_bandejas' %}";
                }, 1500);
            } else {
                // Handle specific error types
                if (data.tipo_error === 'campos_sin_calificar') {
                    showValidationErrorModal(data.campos_sin_calificar, etapaNombre);
                } else if (data.tipo_error === 'requisitos_faltantes') {
                    showRequisitosErrorModal(data.requisitos_faltantes, etapaNombre);
                } else if (data.tipo_error === 'analisis_general_faltante') {
                    showAnalisisGeneralErrorModal(etapaNombre);
                } else {
                    throw new Error(data.error || 'Error al cambiar de etapa');
                }
            }

        } catch (error) {
            console.error('=== Error in callOriginalStageChange ===');
            console.error('Error type:', error.constructor.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            showNotification(`Error: ${error.message}`, 'error');
        } finally {
            console.log('=== callOriginalStageChange END ===');
        }
    };

    // Show validation error modal for unrated fields
    const showValidationErrorModal = (camposSinCalificar, etapaNombre) => {
        const errorModal = `
            <div class="modal fade" id="backendValidationErrorModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Campos Sin Calificar
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>No se puede cambiar a ${etapaNombre}</strong> - Todos los campos deben estar calificados como "Bueno" o "Malo".
                            </div>
                            <div class="mb-3">
                                <h6>Campos pendientes de calificaci√≥n:</h6>
                                <ul class="list-group">
                                    ${camposSinCalificar.map(campo => 
                                        `<li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>${campo.nombre}</span>
                                            <span class="badge bg-warning text-dark">Pendiente</span>
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Instrucciones:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Haga clic en el bot√≥n <i class="fas fa-check text-success"></i> para marcar como "Bueno"</li>
                                    <li>Haga clic en el bot√≥n <i class="fas fa-times text-danger"></i> para marcar como "Malo"</li>
                                    <li>Opcionalmente, agregue comentarios con el bot√≥n <i class="fas fa-comment-dots text-primary"></i></li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('backendValidationErrorModal');
        if (existingModal) existingModal.remove();
        
        // Add modal to page and show
        document.body.insertAdjacentHTML('beforeend', errorModal);
        const modal = new bootstrap.Modal(document.getElementById('backendValidationErrorModal'));
        modal.show();
    };

        // Show requisitos error modal
    const showRequisitosErrorModal = (requisitosFaltantes, etapaNombre) => {
        const errorModal = `
            <div class="modal fade" id="requisitosErrorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Requisitos Faltantes
                    </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>No se puede cambiar a ${etapaNombre}</strong> - Faltan requisitos obligatorios.
                    </div>
                    <div class="mb-3">
                                <h6>Requisitos pendientes:</h6>
                                <ul class="list-group">
                                    ${requisitosFaltantes.map(req => 
                                        `<li class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong>${req.nombre}</strong>
                                                    <br>
                                                    <small class="text-muted">${req.descripcion}</small>
                    </div>
                                                <div class="text-end">
                                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                                    <br>
                                                    <small class="text-muted">
                                                        ${req.tiene_archivo ? 'Con archivo' : 'Sin archivo'} | 
                                                        ${req.esta_cumplido ? 'Cumplido' : 'No cumplido'}
                                                    </small>
                        </div>
                                            </div>
                                        </li>`
                                    ).join('')}
                                </ul>
                    </div>
                </div>
                <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('requisitosErrorModal');
        if (existingModal) existingModal.remove();
        
        // Add modal to page and show
        document.body.insertAdjacentHTML('beforeend', errorModal);
        const modal = new bootstrap.Modal(document.getElementById('requisitosErrorModal'));
        modal.show();
    };

    // Show analyst comment error modal
    const showAnalisisGeneralErrorModal = (etapaNombre) => {
        const errorModal = `
            <div class="modal fade" id="analisisGeneralErrorModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-user-md me-2"></i>
                                An√°lisis General Requerido
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <strong>No se puede cambiar a ${etapaNombre}</strong> - Debe completar el an√°lisis general antes de cambiar de etapa.
                            </div>
                            <div class="mb-3">
                                <h6><i class="fas fa-info-circle me-2"></i>Instrucciones:</h6>
                                <div class="alert alert-info">
                                    <ul class="mb-0">
                                        <li>Complete el campo "An√°lisis General" en la secci√≥n de Comentarios de Analista</li>
                                        <li>El an√°lisis debe contener al menos un car√°cter</li>
                                        <li>Guarde el an√°lisis haciendo clic en "Guardar An√°lisis" antes de intentar cambiar de etapa</li>
                                        <li>El an√°lisis general es obligatorio para proceder con el cambio de etapa</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="alert alert-warning">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Consejo:</strong> El an√°lisis general debe incluir una evaluaci√≥n completa de la solicitud, 
                                considerando todos los aspectos revisados en los campos de compliance.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('analisisGeneralErrorModal');
        if (existingModal) existingModal.remove();
        
        // Add modal to page and show
        document.body.insertAdjacentHTML('beforeend', errorModal);
        const modal = new bootstrap.Modal(document.getElementById('analisisGeneralErrorModal'));
        modal.show();
    };

    // Handle analyst comment form submission
    const handleAnalystCommentSubmit = async (event) => {
        event.preventDefault();
        
        // Check if in view mode
        const isViewMode = document.querySelector('.view-mode-indicator') !== null;
        if (isViewMode) {
            showNotification('Modo solo lectura - No se pueden guardar comentarios en solicitudes no asignadas', 'warning');
            return;
        }
        
        const textarea = document.getElementById('comentario-analista-credito-text');
        const resultadoSelect = document.getElementById('resultado-analisis');
        const submitButton = event.target;
        
        if (!textarea || !resultadoSelect || !submitButton) {
            console.error('Required elements not found');
            return;
        }
        
        const comentario = textarea.value.trim();
        const resultadoAnalisis = resultadoSelect.value;
        
        // Frontend validation
        if (!comentario) {
            showNotification('Por favor ingrese un an√°lisis general', 'error');
            textarea.focus();
            return;
        }
        
        if (!resultadoAnalisis) {
            showNotification('Por favor seleccione el resultado del an√°lisis', 'error');
            resultadoSelect.focus();
            return;
        }
        
        if (comentario.length > 2000) {
            showNotification('El an√°lisis no puede exceder 2000 caracteres', 'error');
            textarea.focus();
            return;
        }

        // Check if content has changed (optional - could be used for optimization)
        const originalContent = textarea.getAttribute('data-original-content') || '';
        const originalResultado = resultadoSelect.getAttribute('data-original-resultado') || '';
        if (comentario === originalContent && resultadoAnalisis === originalResultado) {
            showNotification('No hay cambios para guardar', 'info');
            return;
        }
        
        // Store original button state
        const originalButtonText = submitButton.innerHTML;
        const originalDisabled = submitButton.disabled;
        
        try {
            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
            
            const solicitudId = getSolicitudIdFromUrl();
            if (!solicitudId) {
                throw new Error('No se pudo obtener el ID de la solicitud');
            }
            
            // Make API call
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios-analista/crear/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({
                    comentario: comentario,
                    resultado_analisis: resultadoAnalisis
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error al guardar el an√°lisis');
            }
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('An√°lisis guardado exitosamente', 'success');
                
                // Update character counter
                updateCharCount('comentario-analista-credito-text', 'char-count-analista-credito', 2000);
                
                // Update the original content marker to prevent duplicate saves
                textarea.setAttribute('data-original-content', comentario);
                resultadoSelect.setAttribute('data-original-resultado', resultadoAnalisis);
                
                // Reset button appearance
                submitButton.classList.remove('btn-warning');
                submitButton.classList.add('btn-light');
                submitButton.innerHTML = '<i class="fas fa-save me-1"></i>Guardar An√°lisis';
                
                // Reload existing comments to show the new one
                await loadExistingAnalystComments();
                
            } else {
                throw new Error(data.error || 'Error al guardar el an√°lisis');
            }
            
        } catch (error) {
            console.error('Error saving analyst comment:', error);
            showNotification(`Error: ${error.message}`, 'error');
        } finally {
            // Restore button state
            submitButton.disabled = originalDisabled;
            submitButton.innerHTML = originalButtonText;
        }
    };

    // Load existing analyst comments
    const loadExistingAnalystComments = async () => {
        const solicitudId = getSolicitudIdFromUrl();
        if (!solicitudId) {
            console.error('No se pudo obtener el ID de la solicitud');
            return;
        }

        try {
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios-analista/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });

            if (!response.ok) {
                console.error('Failed to load analyst comments:', response.status, response.statusText);
                return;
            }

            const data = await response.json();
            
            if (data.success && data.comentarios && data.comentarios.length > 0) {
                // Get the most recent comment and populate the textarea only if it's empty
                const latestComment = data.comentarios[0]; // Already sorted by date descending
                const textarea = document.getElementById('comentario-analista-credito-text');
                const resultadoSelect = document.getElementById('resultado-analisis');
                
                if (textarea && !textarea.value.trim()) {
                    textarea.value = latestComment.comentario;
                    textarea.setAttribute('data-original-content', latestComment.comentario);
                    updateCharCount('comentario-analista-credito-text', 'char-count-analista-credito', 2000);
                }
                
                if (resultadoSelect && latestComment.resultado_analisis && !resultadoSelect.value) {
                    resultadoSelect.value = latestComment.resultado_analisis;
                    resultadoSelect.setAttribute('data-original-resultado', latestComment.resultado_analisis);
                }
                
                console.log('Loaded existing analyst comment:', latestComment.comentario);
                console.log('Loaded existing resultado an√°lisis:', latestComment.resultado_analisis);
            } else {
                console.log('No existing analyst comments found');
            }
        } catch (error) {
            console.error('Error loading analyst comments:', error);
        }
    };
</script>
{% endblock %}
