{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}An√°lisis de Solicitud - {{ solicitud.codigo }}{% endblock %}

{% block extra_css %}
{% include 'workflow/partials/analisis_styles.html' %}
<style>
    /* Section Toggle Styles */
    .section-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        user-select: none;
    }

    .section-header:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .section-header-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }

    .section-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .section-toggle:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .toggle-icon {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
        color: rgba(255, 255, 255, 0.8);
    }

    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .section-content {
        transition: all 0.3s ease;
        overflow: hidden;
        max-height: 300px; /* Reduced height to fit within main container */
        overflow-y: auto; /* Enable vertical scrolling */
        padding: 0.75rem;
        border-radius: 0.375rem;
        background-color: white;
        margin-top: 0.5rem;
        border: 1px solid #e5e7eb;
    }

    .section-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
        overflow: hidden; /* Hide overflow when collapsed */
    }

    /* Custom scrollbar styling for better UX */
    .section-content::-webkit-scrollbar {
        width: 6px;
    }

    .section-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .section-content::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .section-content::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Custom scrollbar for main section content */
    .main-section-content::-webkit-scrollbar {
        width: 8px;
    }

    .main-section-content::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 4px;
    }

    .main-section-content::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 4px;
    }

    .main-section-content::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
    }

    /* Animation for smooth collapse/expand */
    .section-content {
        max-height: 1000px;
        opacity: 1;
    }

    .section-content.collapsed {
        max-height: 0;
        opacity: 0;
    }

    /* Ensure smooth layout transitions */
    .section-container {
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }

    .section-container:last-child {
        margin-bottom: 0;
    }

    /* Main layout container for equal heights */
    .main-layout-row {
        display: flex;
        min-height: 420px; /* Match adjuntos-container height */
    }

    /* Main section container styling */
    .main-section-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
        height: 420px; /* Fixed height to match adjuntos */
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    /* Resumen header styling */
    .resumen-header {
        padding: 0.6rem 1rem;
        border-bottom: 1px solid #f1f3f4;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        border-radius: 12px 12px 0 0;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .resumen-icon {
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .resumen-title {
        flex: 1;
    }

    .resumen-title h3.section-title {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 700;
        color: white;
    }

    .resumen-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .resumen-actions .btn {
        border-radius: 16px;
        padding: 0.3rem 0.6rem;
        font-size: 0.7rem;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.9);
        color: #1e40af;
        transition: all 0.2s ease;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .resumen-actions .btn:hover {
        background: rgba(255, 255, 255, 1);
        border-color: rgba(255, 255, 255, 0.8);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        color: #1e40af;
    }

    /* Main section content styling */
    .main-section-content {
        padding: 16px 20px;
        flex: 1;
        overflow-y: auto;
        background-color: #f8f9fa;
    }

    /* Analysis grid styling */
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        height: 100%;
    }

    /* Compact styles for Motivo de la Consulta section */
    .observaciones-content {
        padding: 0.25rem;
    }

    .observaciones-textarea {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #f8f9fa;
        font-family: inherit;
        line-height: 1.3;
    }

    .observaciones-empty {
        padding: 0.25rem;
    }

    .observaciones-empty .alert {
        margin: 0;
        border-radius: 4px;
    }

    /* Ensure content doesn't get clipped */
    .info-row-with-check {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        border-radius: 0.25rem;
        background-color: white;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }

    .info-row-with-check:hover {
        background-color: #f9fafb;
        border-color: #d1d5db;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .info-data {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .info-label {
        font-weight: 600;
        font-size: 0.875rem;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        margin-bottom: 0.125rem;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.25rem;
    }

    .info-value {
        font-weight: 500;
        font-size: 1rem;
        color: #1f2937;
        line-height: 1.4;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        padding: 0.25rem 0;
    }

    .compliance-actions {
        display: flex;
        gap: 0.25rem;
        flex-shrink: 0;
        align-items: center;
        padding-left: 0.5rem;
        border-left: 1px solid #e5e7eb;
    }

    /* Compliance button styles */
    .btn-compliance {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        background: white;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-compliance:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-compliance.btn-good {
        color: #198754;
        border-color: #198754;
    }

    .btn-compliance.btn-good:hover,
    .btn-compliance.btn-good.active {
        background: #198754;
        color: white;
        border-color: #198754;
    }

    .btn-compliance.btn-bad {
        color: #dc3545;
        border-color: #dc3545;
    }

    .btn-compliance.btn-bad:hover,
    .btn-compliance.btn-bad.active {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
    }

    .btn-compliance.btn-comment {
        color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-compliance.btn-comment:hover {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .btn-compliance.btn-comment.has-comment {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
        position: relative;
    }

    .btn-compliance.btn-comment.has-comment::after {
        content: '';
        position: absolute;
        top: -2px;
        right: -2px;
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        border: 1px solid white;
    }

    .btn-compliance:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Document compliance button styles */
    .adjunto-item .btn-compliance {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
    }

    .adjunto-item .btn-compliance.btn-comment.has-comment::after {
        width: 6px;
        height: 6px;
        top: -1px;
        right: -1px;
    }
</style>
{% endblock %}

{% block content %}
<div id="analisis-container">
    <div class="container-fluid">
        <!-- Header de la Solicitud -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header" style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <a href="{% url 'workflow:vista_mixta_bandejas' %}" class="btn btn-light btn-sm">
                                    <i class="fas fa-arrow-left me-1"></i>Volver a Bandejas
                                </a>
                                <div>
                                    <h2 class="mb-1 d-flex align-items-center">
                                        <i class="fas fa-microscope me-2"></i>
                                        An√°lisis: {{ solicitud.cliente_nombre|default:"Sin cliente" }}
                                        {% if solicitud.cotizacion and solicitud.cotizacion.NumeroCotizacion %}
                                        <span class="ms-3 opacity-75" style="font-size: 0.9em; font-weight: normal;">
                                            <i class="fas fa-file-invoice me-1"></i>
                                            Cotizaci√≥n: {{ solicitud.cotizacion.NumeroCotizacion }}
                                        </span>
                                        {% endif %}
                                    </h2>
                                    {% if solicitud.cotizacion and solicitud.cotizacion.observaciones %}
                                    <div class="mt-2" style="font-size: 0.85em; opacity: 0.9;">
                                        <i class="fas fa-comments me-1"></i>
                                        <strong>Motivo:</strong> 
                                        <span id="motivo-texto-corto">{{ solicitud.cotizacion.observaciones|truncatechars:100 }}</span>
                                        <span id="motivo-texto-completo" style="display: none;">{{ solicitud.cotizacion.observaciones }}</span>
                                        {% if solicitud.cotizacion.observaciones|length > 100 %}
                                        <button type="button" class="btn btn-link btn-sm p-0 ms-1" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.8em;" onclick="toggleMotivoCompleto()" id="btn-toggle-motivo">
                                            <i class="fas fa-chevron-down"></i><span> Ver m√°s</span>
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownTransiciones" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-arrow-right me-1"></i>Cambiar Etapa
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownTransiciones">
                                    {% if transiciones_disponibles %}
                                        {% for transicion_data in transiciones_disponibles %}
                                            {% with transicion=transicion_data.transicion %}
                                            <li>
                                                <a class="dropdown-item {% if not transicion_data.puede_realizar %}disabled text-muted{% endif %}" 
                                                href="#" 
                                                onclick="handleTransicionClick({{ transicion.etapa_destino.id }}, '{{ transicion.etapa_destino.nombre|escapejs }}', {{ transicion_data.puede_realizar|yesno:'true,false' }}, {{ transicion_data.total_requisitos_faltantes }}); return false;"
                                                {% if not transicion_data.puede_realizar %}title="Faltan {{ transicion_data.total_requisitos_faltantes }} requisito(s) obligatorio(s)"{% endif %}>
                                                    <i class="fas fa-arrow-right me-2"></i>
                                                    <strong>{{ transicion.etapa_destino.nombre }}</strong>
                                                    {% if not transicion_data.puede_realizar %}
                                                        <span class="badge bg-warning text-dark ms-2">{{ transicion_data.total_requisitos_faltantes }}</span>
                                                    {% endif %}
                                                    <br>
                                                    <small class="text-muted">{{ transicion.nombre }}</small>
                                                </a>
                                            </li>
                                            {% endwith %}
                                        {% endfor %}
                                    {% else %}
                                        <li><span class="dropdown-item-text text-muted">No hay transiciones disponibles</span></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>





        <!-- LAYOUT PRINCIPAL: RESUMEN COMPLETO (4/6) + ADJUNTOS (2/6) -->
        <div class="row mb-4 main-layout-row">
            <div class="col-8">
                <div class="main-section-container">
                    <div class="resumen-header">
                        <div class="resumen-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="resumen-title">
                            <h3 class="section-title">Resumen Completo de la Solicitud</h3>
                        </div>
                        <div class="resumen-actions">
                            <button class="btn btn-light btn-sm" onclick="confirmarMarcarTodosComoBueno()">
                                <i class="fas fa-check-double me-1"></i>Marcar Todos como Bueno
                            </button>
                        </div>
                    </div>
                    <div class="main-section-content">
                        <div class="analysis-grid">
                            <!-- 1. Informaci√≥n de Cliente -->
                            <div class="col-md-4">
                                <div class="section-container">
                                    <div class="section-header" onclick="toggleSection(this)">
                                        <div class="section-header-content">
                                            <i class="fas fa-user text-info"></i>
                                            <h3 class="section-title">Informaci√≥n de Cliente</h3>
                                        </div>
                                        <div class="section-toggle">
                                            <i class="fas fa-chevron-down toggle-icon"></i>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Empresa Privada:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.nombreEmpresa|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="empresa_privada" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="empresa_privada" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="empresa_privada" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Cargo:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.posicion|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="cargo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="cargo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="cargo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Tiempo de Servicio:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.tiempoServicio|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="tiempo_servicio" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="tiempo_servicio" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="tiempo_servicio" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Salario:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.salarioBaseMensual %}
                                                        B/. {{ solicitud.cotizacion.salarioBaseMensual|floatformat:2 }}
                                                    {% elif solicitud.cotizacion.ingresos %}
                                                        B/. {{ solicitud.cotizacion.ingresos|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="salario" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="salario" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="salario" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Score:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.apcScore|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="score" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="score" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="score" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 2. Detalle de la Solicitud -->
                            <div class="col-md-4">
                                <div class="section-container">
                                    <div class="section-header" onclick="toggleSection(this)">
                                        <div class="section-header-content">
                                            <i class="fas fa-calculator text-primary"></i>
                                            <h3 class="section-title">Detalle de la Solicitud</h3>
                                        </div>
                                        <div class="section-toggle">
                                            <i class="fas fa-chevron-down toggle-icon"></i>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Valor del equipo:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.valorAuto %}
                                                        B/. {{ solicitud.cotizacion.valorAuto|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="valor_equipo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="valor_equipo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="valor_equipo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Abono:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.abono and solicitud.cotizacion.abonoPorcentaje %}
                                                        B/. {{ solicitud.cotizacion.abono|floatformat:2 }} ({{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%)
                                                    {% elif solicitud.cotizacion.abono %}
                                                        B/. {{ solicitud.cotizacion.abono|floatformat:2 }}
                                                    {% elif solicitud.cotizacion.abonoPorcentaje %}
                                                        {{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="abono" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="abono" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="abono" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Monto financiado:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.montoPrestamo %}
                                                        B/. {{ solicitud.cotizacion.montoPrestamo|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="monto_financiado" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="monto_financiado" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="monto_financiado" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Plazo:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.plazoPago %}
                                                        {{ solicitud.cotizacion.plazoPago }} meses
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="plazo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="plazo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="plazo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Rentabilidad:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.r_deseada %}
                                                        {{ solicitud.cotizacion.r_deseada|floatformat:2 }}%
                                                    {% elif solicitud.cotizacion.r1 %}
                                                        {{ solicitud.cotizacion.r1|floatformat:2 }}%
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="rentabilidad" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="rentabilidad" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="rentabilidad" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Total de letra c/seg:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.wrkMontoLetra %}
                                                        B/. {{ solicitud.cotizacion.wrkMontoLetra|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="total_letra" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="total_letra" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="total_letra" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            
                            <!-- 3. Datos del Veh√≠culo -->
                            <div class="col-md-4">
                                <div class="section-container">
                                    <div class="section-header" onclick="toggleSection(this)">
                                        <div class="section-header-content">
                                            <i class="fas fa-car text-warning"></i>
                                            <h3 class="section-title">Datos del Veh√≠culo</h3>
                                        </div>
                                        <div class="section-toggle">
                                            <i class="fas fa-chevron-down toggle-icon"></i>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Marca:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.marca|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="marca" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="marca" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="marca" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Modelo:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.modelo|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="modelo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="modelo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="modelo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">A√±o:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.yearCarro|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="a√±o" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="a√±o" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="a√±o" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Transmisi√≥n:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.transmisionAuto|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="transmision" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="transmision" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="transmision" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">KM:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.kilometrajeAuto %}
                                                        {{ solicitud.cotizacion.kilometrajeAuto|floatformat:0 }} km
                                                    {% else %}
                                                        0 km
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="kilometraje" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="kilometraje" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="kilometraje" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ADJUNTOS ASOCIADOS (2/6 del ancho) -->
            <div class="col-4">
                <div class="adjuntos-container">
                    <div class="adjuntos-header">
                        <div class="adjuntos-icon">
                            <i class="fas fa-paperclip"></i>
                        </div>
                        <div class="adjuntos-title">
                            <h3 class="section-title">Adjuntos</h3>
                            
                        </div>
                        {% if solicitud.requisitos.all %}
                            {% with requisitos_con_archivos=solicitud.requisitos.all|length %}
                                {% if requisitos_con_archivos > 0 %}
                                    <div class="adjuntos-actions">
                                        <button type="button" class="btn btn-light btn-sm" id="btn-download-merged-pdf" title="Descargar todos los documentos en un solo PDF">
                                            <i class="fas fa-download me-1"></i>PDF Completo
                                        </button>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                    <div class="adjuntos-content">
                        {% if solicitud.requisitos.all %}
                            {% for requisito_solicitud in solicitud.requisitos.all %}
                                <div class="adjunto-item">
                                    <div class="adjunto-icon">
                                        {% if requisito_solicitud.archivo %}
                                            <i class="fas fa-file-pdf text-danger"></i>
                                        {% else %}
                                            <i class="fas fa-file-alt text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <div class="adjunto-details">
                                        <div class="adjunto-name">{{ requisito_solicitud.requisito.nombre }}</div>
                                        <div class="adjunto-actions">
                                            {% if requisito_solicitud.archivo %}
                                                <a href="{{ requisito_solicitud.archivo.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            {% endif %}
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="doc_{{ requisito_solicitud.id }}" data-action="bueno" title="Documento v√°lido">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="doc_{{ requisito_solicitud.id }}" data-action="malo" title="Documento inv√°lido">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="doc_{{ requisito_solicitud.id }}" data-action="comentario" title="Comentar documento">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-light text-center">
                                <i class="fas fa-inbox me-2"></i>
                                <small>Sin adjuntos disponibles</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- SOLICITUDES RELACIONADAS (ancho completo) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="section-container">
                    <div class="resumen-header">
                        <div class="resumen-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <div class="resumen-title">
                            <h3 class="section-title">Solicitudes Relacionadas</h3>
                            <small>C√©dula: {{ solicitud.cliente_cedula|default:"-" }}</small>
                        </div>
                    </div>
                    
                    <div class="section-content">
                        {% if mostrar_mensaje_sin_cliente %}
                            <div class="alert alert-warning text-center my-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Esta solicitud no tiene c√©dula de cliente asignada, no se pueden mostrar solicitudes relacionadas.
                            </div>
                        {% else %}
                            <!-- B√∫squeda autom√°tica por c√©dula -->
                            <div class="search-info">
                                <i class="fas fa-search me-2"></i>
                                <span>Buscando por c√©dula: <strong>{{ solicitud.cliente_cedula|default:"-" }}</strong></span>
                            </div>
                            
                            <!-- Lista de solicitudes relacionadas -->
                            <div class="related-list">
                                {% for s in solicitudes_relacionadas %}
                                <div class="related-item">
                                    <div class="related-icon">
                                        <i class="fas fa-file-alt {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}text-success{% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}text-danger{% else %}text-warning{% endif %}"></i>
                                    </div>
                                    <div class="related-details">
                                        <div class="related-header-item">
                                            <strong>{{ s.codigo }}</strong>
                                            <span class="related-date">{{ s.fecha_creacion|date:"d/m/Y" }}</span>
                                        </div>
                                        <div class="related-info">
                                            <span class="badge 
                                                {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}bg-success
                                                {% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}bg-danger
                                                {% else %}bg-warning{% endif %}">
                                                {% if s.etapa_actual %}{{ s.etapa_actual.nombre }}{% else %}Sin estado{% endif %}
                                            </span>
                                            <span class="related-amount">
                                                B/. {% if s.cotizacion and s.cotizacion.montoPrestamo %}{{ s.cotizacion.montoPrestamo|floatformat:2 }}{% else %}0.00{% endif %}
                                            </span>
                                        </div>
                                        <div class="related-description">
                                            {% if s.cotizacion and s.cotizacion.tipoPrestamo %}
                                                {% if s.cotizacion.tipoPrestamo == 'auto' %}Pr√©stamo Auto{% else %}Pr√©stamo Personal{% endif %}
                                            {% else %}Pr√©stamo{% endif %}
                                            {% if s.cotizacion and s.cotizacion.plazoPago %} - {{ s.cotizacion.plazoPago }} meses{% endif %}
                                        </div>
                                    </div>
                                    <div class="related-actions">
                                        <a href="{% url 'workflow:detalle_solicitud_analisis' s.id %}" class="btn btn-outline-primary btn-sm" title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="alert alert-info text-center my-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Sin solicitudes relacionadas disponibles para esta c√©dula.
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% if solicitudes_relacionadas %}
                            <div class="related-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Total Solicitudes:</span>
                                    <span class="summary-value">{{ solicitudes_relacionadas|length }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Aprobadas:</span>
                                    <span class="summary-value text-success">
                                        {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                    </span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">En Proceso:</span>
                                    <span class="summary-value text-warning">
                                        {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Proceso' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                    </span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Rechazadas:</span>
                                    <span class="summary-value text-danger">
                                        {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>


        <!-- COMENTARIOS DE ANALISTA (ancho completo) -->
        <div class="row mb-5">
            <!-- COMENTARIOS DE ANALISTA (ancho completo) -->
            <div class="col-12">
                <div class="comentarios-analista-section-compact">
                    <div class="comentarios-analista-header-compact">
                        <h6><i class="fas fa-user-md me-2"></i>Comentarios de Analista</h6>

                    </div>
                    <div class="comentarios-analista-body-compact" id="comentarios-analista-content">
                        <!-- Lista de comentarios existentes -->
                        <div class="comentarios-lista-compact" id="lista-comentarios-analista-credito">
                            <div class="alert alert-light text-center" id="sin-comentarios-analista">
                                <i class="fas fa-clipboard-list me-2"></i>
                                <small>A√∫n no hay comentarios de analista para esta solicitud</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Formulario compacto fijo en el pie -->
                    <div class="nuevo-comentario-form-compact">
                        <form id="form-comentario-analista-credito" method="post" class="comentario-form-compact">
                            {% csrf_token %}
                            <div class="form-body-compact">
                                <!-- √Årea de an√°lisis unificado -->
                                <div class="analisis-unificado-container">
                                    <!-- Secci√≥n editable del analista -->
                                    <div class="analisis-seccion-editable">
                                        <label for="comentario-analista-credito-text" class="form-label">
                                            <i class="fas fa-edit me-2"></i>An√°lisis General (Editable)
                                        </label>
                                        <textarea class="form-control comentario-textarea-compact" 
                                                id="comentario-analista-credito-text"
                                                placeholder="Escriba su an√°lisis general aqu√≠..."
                                                rows="4" 
                                                maxlength="2000"
                                                required></textarea>
                                    </div>
                                    
                                    <!-- Secci√≥n de bullet points auto-generados -->
                                    <div class="analisis-seccion-bullets">
                                        <div class="bullets-header">
                                            <i class="fas fa-list-ul me-2"></i>
                                            <strong>Comentarios de Campos (Auto-generados)</strong>
                                        </div>
                                        <div class="bullets-content" id="bullets-content">
                                            <div class="bullets-placeholder">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <small>Los comentarios de campos se generar√°n autom√°ticamente al guardar</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview del resultado final -->
                                    <div class="analisis-preview" id="analisis-preview" style="display: none;">
                                        <div class="preview-header">
                                            <i class="fas fa-eye me-2"></i>
                                            <strong>Vista Previa del An√°lisis Completo</strong>
                                        </div>
                                        <div class="preview-content" id="preview-content">
                                            <!-- El an√°lisis completo se muestra aqu√≠ -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-footer-compact">
                                    <div class="char-counter-compact">
                                        <span id="char-count-analista-credito">0</span>/2000
                                    </div>
                                    <div class="form-actions-compact">
                                        <button type="button" class="btn btn-outline-info btn-sm me-2" id="btn-preview-analisis">
                                            <i class="fas fa-eye me-1"></i>Vista Previa
                                        </button>
                                        <button type="submit" class="btn btn-primary btn-sm" id="btn-enviar-analista-credito">
                                            <i class="fas fa-save me-1"></i>Guardar An√°lisis
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>



    <!-- Modal para Comentarios de Compliance -->
    <div class="modal fade" id="modalComentarioCompliance" tabindex="-1" aria-labelledby="modalComentarioComplianceLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalComentarioComplianceLabel">
                        <i class="fas fa-comment-dots me-2"></i>
                        Comentario de Compliance
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Campo:</label>
                        <div class="fw-bold text-primary" id="campo-nombre"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valor actual:</label>
                        <div class="fw-bold" id="campo-valor"></div>
                    </div>
                    <div class="mb-3">
                        <label for="comentario-compliance" class="form-label">Comentario:</label>
                        <textarea class="form-control" id="comentario-compliance" rows="5" placeholder="Ingrese su comentario sobre este campo..."></textarea>
                        <div class="form-text">
                            <span id="char-count-compliance">0</span>/500 caracteres
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-guardar-comentario-compliance">
                        <i class="fas fa-save me-2"></i>
                        Guardar Comentario
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<!-- VER MAS FUNCIONES -->
<script>
    // Toggle functionality for "Ver m√°s" button to show/hide complete motivo consulta
    const toggleMotivoCompleto = () => {
        const textoCorto = document.getElementById('motivo-texto-corto');
        const textoCompleto = document.getElementById('motivo-texto-completo');
        const btnToggle = document.getElementById('btn-toggle-motivo');
        
        // Check if all required elements exist
        if (!textoCorto || !textoCompleto || !btnToggle) {
            console.error('Required elements for motivo toggle not found');
            return;
        }
        
        const icon = btnToggle.querySelector('i');
        const textSpan = btnToggle.querySelector('span');
        
        if (!icon) {
            console.error('Icon element not found in toggle button');
            return;
        }

        if (textoCorto.style.display !== 'none') {
            // Show complete text
            textoCorto.style.display = 'none';
            textoCompleto.style.display = 'inline';
            icon.className = 'fas fa-chevron-up';
            if (textSpan) {
                textSpan.textContent = ' Ver menos';
            }
        } else {
            // Show short text
            textoCorto.style.display = 'inline';
            textoCompleto.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
            if (textSpan) {
                textSpan.textContent = ' Ver m√°s';
            }
        }
    };

    // Section toggle functionality
    const toggleSection = (headerElement) => {
        const sectionContent = headerElement.nextElementSibling;
        const toggleIcon = headerElement.querySelector('.toggle-icon');
        
        if (sectionContent.classList.contains('collapsed')) {
            // Expand section
            sectionContent.classList.remove('collapsed');
            headerElement.classList.remove('collapsed');
            toggleIcon.style.transform = 'rotate(0deg)';
            
            // Set proper height for scrollable content
            const contentHeight = Math.min(sectionContent.scrollHeight, 300);
            sectionContent.style.maxHeight = `${contentHeight}px`;
            sectionContent.style.overflowY = 'auto';
            
        } else {
            // Collapse section
            sectionContent.classList.add('collapsed');
            headerElement.classList.add('collapsed');
            toggleIcon.style.transform = 'rotate(-90deg)';
            
            // Reset height and hide overflow
            sectionContent.style.maxHeight = '0';
            sectionContent.style.overflowY = 'hidden';
        }
    };



    // Confirmation dialog for marking all as good
    const confirmarMarcarTodosComoBueno = () => {
        const goodButtons = document.querySelectorAll('.btn-compliance.btn-good');
        const totalButtons = goodButtons.length;
        
        if (totalButtons === 0) {
            showNotification('No hay campos para marcar como buenos', 'info');
            return;
        }
        
        // Count fields that are not already marked as good
        let camposPendientes = 0;
        for (const button of goodButtons) {
            if (!button.classList.contains('active')) {
                camposPendientes++;
            }
        }
        
        if (camposPendientes === 0) {
            showNotification('Todos los campos ya est√°n marcados como buenos', 'info');
            return;
        }
        
        // Show confirmation dialog
        if (confirm(`¬øEst√° seguro que desea marcar ${camposPendientes} campo(s) como buenos?\n\nEsta acci√≥n no se puede deshacer.`)) {
            marcarTodosComoBueno();
        }
    };

    // Mark all as good functionality with bulk API support
    const marcarTodosComoBueno = async () => {
        const goodButtons = document.querySelectorAll('.btn-compliance.btn-good');
        const totalButtons = goodButtons.length;
        
        if (totalButtons === 0) {
            showNotification('No hay campos para marcar como buenos', 'info');
            return;
        }
        
        // Disable the button and show loading state
        const btnMarcarTodos = document.querySelector('button[onclick="marcarTodosComoBueno()"]');
        const originalContent = btnMarcarTodos ? btnMarcarTodos.innerHTML : '';
        
        if (btnMarcarTodos) {
            btnMarcarTodos.disabled = true;
            btnMarcarTodos.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        }
        
        try {
            showNotification(`Iniciando proceso de calificaci√≥n de ${totalButtons} campos...`, 'info');
            
            // Collect fields that need to be marked as good
            const campos = [];
            for (const button of goodButtons) {
                const field = button.getAttribute('data-field');
                if (!button.classList.contains('active')) {
                    campos.push(field);
                }
            }
            
            if (campos.length === 0) {
                showNotification('Todos los campos ya est√°n marcados como buenos', 'info');
                return;
            }
            
            // Try bulk API first
            const solicitudId = getSolicitudIdFromUrl();
            if (!solicitudId) {
                throw new Error('No se pudo obtener el ID de la solicitud');
            }
            
            try {
                // Show progress
                if (btnMarcarTodos) {
                    btnMarcarTodos.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Procesando en lote...`;
                }
                
                const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificar-campos-bulk/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        campos: campos,
                        estado: 'bueno'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update all button states
                    campos.forEach(field => {
                        const button = document.querySelector(`[data-field="${field}"][data-action="bueno"]`);
                        if (button) {
                            updateComplianceButtonState(button, 'bueno');
                        }
                    });
                    
                    const successCount = data.total_procesados;
                    const errorCount = data.total_errores;
                    
                    if (errorCount === 0) {
                        showNotification(`‚úÖ Todos los campos (${successCount}) fueron marcados como buenos exitosamente`, 'success');
                    } else {
                        showNotification(`‚ö†Ô∏è Proceso completado: ${successCount} exitosos, ${errorCount} con errores`, 'warning');
                        if (data.errores && data.errores.length > 0) {
                            console.error('Errors during bulk marking:', data.errores);
                        }
                    }
                } else {
                    throw new Error(data.error || 'Error en la API de lote');
                }
                
            } catch (bulkError) {
                console.warn('Bulk API failed, falling back to sequential processing:', bulkError);
                
                // Fallback to sequential processing
                if (btnMarcarTodos) {
                    btnMarcarTodos.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando secuencialmente...';
                }
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                for (let i = 0; i < campos.length; i++) {
                    const field = campos[i];
                    const button = document.querySelector(`[data-field="${field}"][data-action="bueno"]`);
                    
                    if (!button) continue;
                    
                    try {
                        // Show progress
                        if (btnMarcarTodos) {
                            btnMarcarTodos.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Procesando ${i + 1}/${campos.length}...`;
                        }
                        
                        // Add delay to avoid database locks
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        // Call the compliance action directly
                        await handleComplianceAction(button);
                        successCount++;
                        
                    } catch (error) {
                        errorCount++;
                        errors.push(`${field}: ${error.message}`);
                        console.error(`Error processing field ${field}:`, error);
                    }
                }
                
                // Show final results
                if (errorCount === 0) {
                    showNotification(`‚úÖ Todos los campos (${successCount}) fueron marcados como buenos exitosamente`, 'success');
                } else if (successCount === 0) {
                    showNotification(`‚ùå Error al procesar todos los campos. Revise los errores en la consola.`, 'error');
                } else {
                    showNotification(`‚ö†Ô∏è Proceso completado: ${successCount} exitosos, ${errorCount} con errores`, 'warning');
                    console.error('Errors during sequential marking:', errors);
                }
            }
            
        } catch (error) {
            console.error('Error in marcarTodosComoBueno:', error);
            showNotification(`Error general: ${error.message}`, 'error');
        } finally {
            // Restore button state
            if (btnMarcarTodos) {
                btnMarcarTodos.disabled = false;
                btnMarcarTodos.innerHTML = originalContent;
            }
        }
    };

    // Compliance button functionality
    const handleComplianceAction = async (button) => {
        const field = button.getAttribute('data-field');
        const action = button.getAttribute('data-action');
        const solicitudId = getSolicitudIdFromUrl();
        
        console.log('Compliance action triggered:', { field, action, solicitudId });
        
        if (!solicitudId) {
            showNotification('Error: No se pudo obtener el ID de la solicitud', 'error');
            return;
        }

        if (!field) {
            console.error('Field attribute not found on button');
            showNotification('Error: Campo no especificado', 'error');
            return;
        }

        // Store original HTML outside try block so it's available in finally
        const originalHTML = button.innerHTML;

        try {
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            if (action === 'bueno' || action === 'malo') {
                console.log('Processing good/bad rating for field:', field);
                
                // Handle good/bad rating
                const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificar-campo/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        campo: field,
                        estado: action === 'bueno' ? 'bueno' : 'malo'
                    })
                });

                const data = await response.json();
                console.log('Rating response:', data);
                
                if (data.success) {
                    // Update button appearance
                    updateComplianceButtonState(button, action);
                    showNotification(`Campo calificado como ${action === 'bueno' ? 'bueno' : 'malo'}`, 'success');
                } else {
                    throw new Error(data.error || 'Error al calificar campo');
                }
            } else if (action === 'comentario') {
                console.log('Opening comment modal for field:', field);
                // Handle comment action - don't show spinner for comment modal
                button.disabled = false;
                button.innerHTML = originalHTML;
                showCommentModal(field, solicitudId);
                return; // Exit early for comment action
            } else {
                console.error('Unknown action:', action);
                showNotification('Error: Acci√≥n no v√°lida', 'error');
            }

        } catch (error) {
            console.error('Error in compliance action:', error);
            
            // Handle specific error types
            if (error.message.includes('database is locked') || error.message.includes('Base de datos ocupada')) {
                showNotification('Base de datos ocupada. Intente nuevamente en unos segundos.', 'warning');
            } else {
                showNotification(`Error: ${error.message}`, 'error');
            }
        } finally {
            // Restore button state
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    };

    // Update compliance button visual state
    const updateComplianceButtonState = (button, action) => {
        if (!button) {
            console.warn('updateComplianceButtonState called with null button');
            return;
        }
        
        // Handle document fields differently
        const field = button.getAttribute('data-field');
        if (field && field.startsWith('doc_')) {
            // For document fields, find buttons within the same adjunto-item
            const docRow = button.closest('.adjunto-item');
            if (!docRow) {
                console.warn('Could not find adjunto-item for document button:', button);
                return;
            }
            
            const goodButton = docRow.querySelector('.btn-compliance.btn-good');
            const badButton = docRow.querySelector('.btn-compliance.btn-bad');
            
            if (!goodButton || !badButton) {
                console.warn('Could not find good/bad buttons in document row:', docRow);
                return;
            }
            
            // Reset all buttons
            goodButton.classList.remove('active');
            badButton.classList.remove('active');
            
            // Activate the selected button
            if (action === 'bueno') {
                goodButton.classList.add('active');
            } else if (action === 'malo') {
                badButton.classList.add('active');
            }
        } else {
            // Handle regular fields
            const row = button.closest('.info-row-with-check');
            if (!row) {
                console.warn('Could not find info-row-with-check for button:', button);
                return;
            }
            
            const goodButton = row.querySelector('.btn-compliance.btn-good');
            const badButton = row.querySelector('.btn-compliance.btn-bad');
            
            if (!goodButton || !badButton) {
                console.warn('Could not find good/bad buttons in row:', row);
                return;
            }
            
            // Reset all buttons
            goodButton.classList.remove('active');
            badButton.classList.remove('active');
            
            // Activate the selected button
            if (action === 'bueno') {
                goodButton.classList.add('active');
            } else if (action === 'malo') {
                badButton.classList.add('active');
            }
        }
    };

    // Show comment modal
    const showCommentModal = async (field, solicitudId) => {
        const modal = document.getElementById('modalComentarioCompliance');
        const campoNombre = document.getElementById('campo-nombre');
        const campoValor = document.getElementById('campo-valor');
        const comentarioTextarea = document.getElementById('comentario-compliance');
        
        if (!modal || !campoNombre || !campoValor || !comentarioTextarea) {
            console.error('Modal elements not found');
            showNotification('Error: No se pudo abrir el modal de comentarios', 'error');
            return;
        }
        
        // Set field information
        campoNombre.textContent = getFieldDisplayName(field);
        
        // Get the field value from the DOM
        const fieldButton = document.querySelector(`[data-field="${field}"]`);
        if (!fieldButton) {
            console.error('Field button not found:', field);
            showNotification('Error: No se pudo encontrar el campo', 'error');
            return;
        }
        
        let fieldValue = 'Sin valor';
        
        // Handle document fields differently
        if (field.startsWith('doc_')) {
            const docRow = fieldButton.closest('.adjunto-item');
            if (docRow) {
                const docNameElement = docRow.querySelector('.adjunto-name');
                if (docNameElement) {
                    fieldValue = docNameElement.textContent.trim();
                }
            }
        } else {
            // Handle regular fields
            const fieldRow = fieldButton.closest('.info-row-with-check');
            if (fieldRow) {
                const fieldValueElement = fieldRow.querySelector('.info-value');
                fieldValue = fieldValueElement ? fieldValueElement.textContent.trim() : 'Sin valor';
            } else {
                console.error('Field row not found for field:', field);
                showNotification('Error: No se pudo encontrar la informaci√≥n del campo', 'error');
                return;
            }
        }
        
        campoValor.textContent = fieldValue;
        
        // Store field and solicitud ID for the save action
        modal.setAttribute('data-field', field);
        modal.setAttribute('data-solicitud-id', solicitudId);
        
        console.log('Opening comment modal for field:', field, 'solicitud:', solicitudId);
        
        // Load existing comment if any
        let hasExistingComment = false;
        try {
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Find comment for this specific field
                    const fieldComment = data.calificaciones.find(cal => cal.campo === field);
                    if (fieldComment && fieldComment.comentario) {
                        comentarioTextarea.value = fieldComment.comentario;
                        hasExistingComment = true;
                        console.log('Loaded existing comment:', fieldComment.comentario);
                    } else {
                        comentarioTextarea.value = '';
                        console.log('No existing comment found for field:', field);
                    }
                }
            }
        } catch (error) {
            console.error('Error loading existing comment:', error);
            comentarioTextarea.value = '';
        }
        
        // Update modal title based on whether there's an existing comment
        const modalTitle = document.getElementById('modalComentarioComplianceLabel');
        if (modalTitle) {
            if (hasExistingComment) {
                modalTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Editar Comentario de Compliance';
            } else {
                modalTitle.innerHTML = '<i class="fas fa-comment-dots me-2"></i>Nuevo Comentario de Compliance';
            }
        }
        
        // Update character count
        updateCharCount('comentario-compliance', 'char-count-compliance', 500);
        
        // Show modal
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
    };

    // Save compliance comment
    const saveComplianceComment = async () => {
        console.log('=== saveComplianceComment START ===');
        
        const modal = document.getElementById('modalComentarioCompliance');
        console.log('Modal element:', modal);
        
        const field = modal.getAttribute('data-field');
        const solicitudId = modal.getAttribute('data-solicitud-id');
        const comentario = document.getElementById('comentario-compliance').value.trim();
        
        console.log('Extracted data:', { field, solicitudId, comentario });
        
        if (!comentario) {
            console.log('No comment provided');
            showNotification('Por favor ingrese un comentario', 'error');
            return;
        }

        if (!field || !solicitudId) {
            console.log('Missing field or solicitudId:', { field, solicitudId });
            showNotification('Error: Datos del campo o solicitud no encontrados', 'error');
            return;
        }

        try {
            console.log('=== API CALL START ===');
            console.log('Request URL:', `/workflow/api/solicitudes/${solicitudId}/comentario-compliance/`);
            console.log('Request data:', { campo: field, comentario: comentario });
            
            const csrfToken = getCSRFToken();
            console.log('CSRF Token:', csrfToken ? 'Present' : 'Missing');
            
            const requestBody = JSON.stringify({
                campo: field,
                comentario: comentario
            });
            console.log('Request body:', requestBody);
            
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/comentario-compliance/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: requestBody
            });

            console.log('=== API RESPONSE ===');
            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Response error text:', errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const responseText = await response.text();
            console.log('Response text:', responseText);
            
            let data;
            try {
                data = JSON.parse(responseText);
                console.log('Parsed response data:', data);
            } catch (parseError) {
                console.error('JSON parse error:', parseError);
                throw new Error(`Invalid JSON response: ${responseText}`);
            }
            
            if (data.success) {
                console.log('Success! Comment saved successfully');
                showNotification('Comentario guardado exitosamente', 'success');
                
                // Update visual state of comment button
                updateCommentButtonState(field, true);
                
                // Close modal
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                if (bootstrapModal) {
                    console.log('Closing modal via Bootstrap instance');
                    bootstrapModal.hide();
                } else {
                    console.log('Bootstrap modal instance not found, using fallback');
                    // Fallback if bootstrap modal instance not found
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                }
            } else {
                console.error('API returned success=false:', data);
                throw new Error(data.error || 'Error al guardar comentario');
            }

        } catch (error) {
            console.error('=== ERROR IN saveComplianceComment ===');
            console.error('Error type:', error.constructor.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            showNotification(`Error: ${error.message}`, 'error');
        }
        
        console.log('=== saveComplianceComment END ===');
    };

    // Get field display name
    const getFieldDisplayName = (field) => {
        // Handle document fields (doc_*)
        if (field.startsWith('doc_')) {
            const docId = field.replace('doc_', '');
            // Try to find the document name from the DOM
            const docButton = document.querySelector(`[data-field="${field}"]`);
            if (docButton) {
                const docRow = docButton.closest('.adjunto-item');
                if (docRow) {
                    const docNameElement = docRow.querySelector('.adjunto-name');
                    if (docNameElement) {
                        return `Documento: ${docNameElement.textContent.trim()}`;
                    }
                }
            }
            return `Documento ID: ${docId}`;
        }
        
        const fieldNames = {
            'empresa_privada': 'Empresa Privada',
            'cargo': 'Cargo',
            'tiempo_servicio': 'Tiempo de Servicio',
            'salario': 'Salario',
            'score': 'Score',
            'valor_equipo': 'Valor del Equipo',
            'abono': 'Abono',
            'monto_financiado': 'Monto Financiado',
            'plazo': 'Plazo',
            'rentabilidad': 'Rentabilidad',
            'total_letra': 'Total de Letra',
            'marca': 'Marca',
            'modelo': 'Modelo',
            'a√±o': 'A√±o',
            'transmision': 'Transmisi√≥n',
            'kilometraje': 'Kilometraje'
        };
        return fieldNames[field] || field;
    };

    // Get solicitud ID from URL
    const getSolicitudIdFromUrl = () => {
        const urlParts = window.location.pathname.split('/');
        const solicitudIndex = urlParts.indexOf('solicitud');
        if (solicitudIndex !== -1 && urlParts[solicitudIndex + 1]) {
            return urlParts[solicitudIndex + 1];
        }
        return null;
    };

    // Get CSRF token
    const getCSRFToken = () => {
        console.log('=== getCSRFToken START ===');
        
        // Try multiple selectors for CSRF token
        const selectors = [
            '[name=csrfmiddlewaretoken]',
            'input[name="csrfmiddlewaretoken"]',
            'meta[name="csrf-token"]',
            '[name="csrfmiddlewaretoken"]'
        ];
        
        let token = null;
        for (const selector of selectors) {
            const element = document.querySelector(selector);
            if (element) {
                token = element.value || element.getAttribute('content');
                console.log(`Found CSRF token with selector "${selector}":`, token ? 'Present' : 'Missing');
                break;
            }
        }
        
        if (!token) {
            console.warn('CSRF token not found with any selector');
            console.log('Available meta tags:', document.querySelectorAll('meta'));
            console.log('Available input elements:', document.querySelectorAll('input[name*="csrf"]'));
        }
        
        console.log('=== getCSRFToken END ===');
        return token || '';
    };

    // Character counter for compliance comment modal
    const updateCharCount = (textareaId, counterId, maxLength) => {
        const textarea = document.getElementById(textareaId);
        const counter = document.getElementById(counterId);
        
        if (textarea && counter) {
            const currentLength = textarea.value.length;
            counter.textContent = currentLength;
            
            if (currentLength > maxLength * 0.8) {
                counter.style.color = currentLength > maxLength ? '#dc3545' : '#ffc107';
            } else {
                counter.style.color = '#6c757d';
            }
        }
    };

    // PDF Download functionality
    const downloadMergedPDF = async () => {
        const btnDownload = document.getElementById('btn-download-merged-pdf');
        const originalContent = btnDownload.innerHTML;
        
        try {
            // Show loading state
            btnDownload.disabled = true;
            btnDownload.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando PDF...';
            
            // Get solicitud ID from URL - support both /solicitud/{id}/analisis/ and /solicitudes/{id}/detalle/
            const urlParts = window.location.pathname.split('/');
            let solicitudId = null;
            
            // Try to find solicitud ID in different URL patterns
            const solicitudIndex = urlParts.indexOf('solicitud');
            const solicitudesIndex = urlParts.indexOf('solicitudes');
            
            if (solicitudIndex !== -1 && urlParts[solicitudIndex + 1]) {
                // Pattern: /solicitud/{id}/analisis/
                solicitudId = urlParts[solicitudIndex + 1];
            } else if (solicitudesIndex !== -1 && urlParts[solicitudesIndex + 1]) {
                // Pattern: /solicitudes/{id}/detalle/
                solicitudId = urlParts[solicitudesIndex + 1];
            }
            
            // Validate solicitud ID
            if (!solicitudId || isNaN(parseInt(solicitudId))) {
                console.error('URL parts:', urlParts);
                console.error('Current pathname:', window.location.pathname);
                throw new Error('No se pudo obtener el ID de la solicitud de la URL');
            }
            
            console.log('Solicitud ID extracted:', solicitudId);
            
            // Make API call to download PDF
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/download-merged-pdf/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                // Try to get error message from response
                let errorMessage = 'Error al generar el PDF';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                } catch (e) {
                    // If response is not JSON, use status text
                    errorMessage = response.statusText || errorMessage;
                }
                throw new Error(errorMessage);
            }
            
            // Check if response is PDF
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/pdf')) {
                throw new Error('La respuesta no es un archivo PDF v√°lido');
            }
            
            // Get filename from response headers or use default
            const contentDisposition = response.headers.get('content-disposition');
            let filename = 'Solicitud_Documentos_Completos.pdf';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            // Create blob and download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            // Show success message
            showNotification('PDF generado y descargado exitosamente', 'success');
            
        } catch (error) {
            console.error('Error downloading PDF:', error);
            showNotification(`Error: ${error.message}`, 'error');
        } finally {
            // Restore button state
            btnDownload.disabled = false;
            btnDownload.innerHTML = originalContent;
        }
    };

    // Notification system
    const showNotification = (message, type = 'info') => {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.custom-notification');
        existingNotifications.forEach(notification => notification.remove());
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `custom-notification alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        notification.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    };

    // Update comment button visual state
    const updateCommentButtonState = (field, hasComment) => {
        console.log('updateCommentButtonState called:', { field, hasComment });
        
        const commentButton = document.querySelector(`[data-field="${field}"][data-action="comentario"]`);
        if (commentButton) {
            console.log('Found comment button for field:', field);
            // Always restore the comment icon
            commentButton.innerHTML = '<i class="fas fa-comment-dots"></i>';
            
            if (hasComment) {
                commentButton.classList.add('has-comment');
                // Update title based on field type
                if (field.startsWith('doc_')) {
                    commentButton.title = 'Ver/editar comentario del documento';
                } else {
                    commentButton.title = 'Ver/editar comentario existente';
                }
                console.log('Added has-comment class to button');
            } else {
                commentButton.classList.remove('has-comment');
                // Update title based on field type
                if (field.startsWith('doc_')) {
                    commentButton.title = 'Comentar documento';
                } else {
                    commentButton.title = 'Agregar comentario';
                }
                console.log('Removed has-comment class from button');
            }
        } else {
            console.warn('Comment button not found for field:', field);
        }
    };

    // Load existing compliance ratings
    const loadExistingComplianceRatings = async () => {
        const solicitudId = getSolicitudIdFromUrl();
        
        if (!solicitudId) {
            console.error('No se pudo obtener el ID de la solicitud');
            return;
        }

        try {
            console.log('Loading existing compliance ratings for solicitud:', solicitudId);
            
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });

            if (!response.ok) {
                console.error('Failed to load compliance ratings:', response.status, response.statusText);
                return;
            }

            const data = await response.json();
            console.log('Compliance ratings response:', data);
            
            if (data.success && data.calificaciones) {
                console.log('Processing', data.calificaciones.length, 'calificaciones');
                
                data.calificaciones.forEach(calificacion => {
                    console.log('Processing calificacion:', calificacion);
                    
                    // Update compliance button states
                    if (calificacion.estado && calificacion.estado !== 'sin_calificar') {
                        const button = document.querySelector(`[data-field="${calificacion.campo}"][data-action="${calificacion.estado}"]`);
                        if (button) {
                            console.log('Found button for', calificacion.campo, calificacion.estado);
                            updateComplianceButtonState(button, calificacion.estado);
                        } else {
                            console.warn('Button not found for', calificacion.campo, calificacion.estado);
                        }
                    }
                    
                    // Update comment button states
                    if (calificacion.comentario) {
                        console.log('Found comment for', calificacion.campo);
                        updateCommentButtonState(calificacion.campo, true);
                    }
                });
            } else {
                console.warn('No calificaciones found or API returned success=false');
            }
        } catch (error) {
            console.error('Error loading compliance ratings:', error);
        }
    };

    // Initialize character counters when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize compliance comment modal character counter
        const comentarioCompliance = document.getElementById('comentario-compliance');
        if (comentarioCompliance) {
            comentarioCompliance.addEventListener('input', () => {
                updateCharCount('comentario-compliance', 'char-count-compliance', 500);
            });
        }

        // Initialize analista comment character counter
        const comentarioAnalista = document.getElementById('comentario-analista-credito-text');
        if (comentarioAnalista) {
            comentarioAnalista.addEventListener('input', () => {
                updateCharCount('comentario-analista-credito-text', 'char-count-analista-credito', 2000);
            });
        }

        // Initialize PDF download button
        const btnDownloadPDF = document.getElementById('btn-download-merged-pdf');
        if (btnDownloadPDF) {
            btnDownloadPDF.addEventListener('click', downloadMergedPDF);
        }

        // Add event listeners for compliance buttons
        document.querySelectorAll('.btn-compliance').forEach(button => {
            button.addEventListener('click', (event) => {
                handleComplianceAction(event.currentTarget);
            });
        });

        // Add event listener for the save compliance comment button
        const btnGuardarComentarioCompliance = document.getElementById('btn-guardar-comentario-compliance');
        console.log('Save compliance comment button:', btnGuardarComentarioCompliance);
        if (btnGuardarComentarioCompliance) {
            console.log('Adding click event listener to save compliance comment button');
            btnGuardarComentarioCompliance.addEventListener('click', (event) => {
                console.log('Save compliance comment button clicked!');
                console.log('Event:', event);
                saveComplianceComment();
            });
        } else {
            console.error('Save compliance comment button not found!');
        }

        // Load existing compliance ratings
        loadExistingComplianceRatings();
    });
</script>
{% endblock %}
