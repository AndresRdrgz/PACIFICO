{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}Análisis de Solicitud - {{ solicitud.codigo }}{% endblock %}

{% block extra_css %}
{% include 'workflow/partials/analisis_styles.html' %}
<style>
    /* Section Toggle Styles */
    .section-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        user-select: none;
    }

    .section-header:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .section-header-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }

    .section-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .section-toggle:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .toggle-icon {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
        color: rgba(255, 255, 255, 0.8);
    }

    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .section-content {
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .section-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
    }

    /* Animation for smooth collapse/expand */
    .section-content {
        max-height: 1000px;
        opacity: 1;
    }

    .section-content.collapsed {
        max-height: 0;
        opacity: 0;
    }

    /* Compact styles for Motivo de la Consulta section */
    .observaciones-content {
        padding: 0.25rem;
    }

    .observaciones-textarea {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #f8f9fa;
        font-family: inherit;
        line-height: 1.3;
    }

    .observaciones-empty {
        padding: 0.25rem;
    }

    .observaciones-empty .alert {
        margin: 0;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div id="analisis-container">
    <div class="container-fluid">
        <!-- Header de la Solicitud -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header" style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <a href="{% url 'workflow:vista_mixta_bandejas' %}" class="btn btn-light btn-sm">
                                    <i class="fas fa-arrow-left me-1"></i>Volver a Bandejas
                                </a>
                                <div>
                                    <h2 class="mb-1 d-flex align-items-center">
                                        <i class="fas fa-microscope me-2"></i>
                                        Análisis: {{ solicitud.cliente_nombre|default:"Sin cliente" }}
                                        {% if solicitud.cotizacion and solicitud.cotizacion.NumeroCotizacion %}
                                        <span class="ms-3 opacity-75" style="font-size: 0.9em; font-weight: normal;">
                                            <i class="fas fa-file-invoice me-1"></i>
                                            Cotización: {{ solicitud.cotizacion.NumeroCotizacion }}
                                        </span>
                                        {% endif %}
                                    </h2>
                                    {% if solicitud.cotizacion and solicitud.cotizacion.observaciones %}
                                    <div class="mt-2" style="font-size: 0.85em; opacity: 0.9;">
                                        <i class="fas fa-comments me-1"></i>
                                        <strong>Motivo:</strong> 
                                        <span id="motivo-texto-corto">{{ solicitud.cotizacion.observaciones|truncatechars:100 }}</span>
                                        <span id="motivo-texto-completo" style="display: none;">{{ solicitud.cotizacion.observaciones }}</span>
                                        {% if solicitud.cotizacion.observaciones|length > 100 %}
                                        <button type="button" class="btn btn-link btn-sm p-0 ms-1" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.8em;" onclick="toggleMotivoCompleto()" id="btn-toggle-motivo">
                                            <i class="fas fa-chevron-down"></i><span> Ver más</span>
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownTransiciones" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-arrow-right me-1"></i>Cambiar Etapa
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownTransiciones">
                                    {% if transiciones_disponibles %}
                                        {% for transicion_data in transiciones_disponibles %}
                                            {% with transicion=transicion_data.transicion %}
                                            <li>
                                                <a class="dropdown-item {% if not transicion_data.puede_realizar %}disabled text-muted{% endif %}" 
                                                href="#" 
                                                onclick="handleTransicionClick({{ transicion.etapa_destino.id }}, '{{ transicion.etapa_destino.nombre|escapejs }}', {{ transicion_data.puede_realizar|yesno:'true,false' }}, {{ transicion_data.total_requisitos_faltantes }}); return false;"
                                                {% if not transicion_data.puede_realizar %}title="Faltan {{ transicion_data.total_requisitos_faltantes }} requisito(s) obligatorio(s)"{% endif %}>
                                                    <i class="fas fa-arrow-right me-2"></i>
                                                    <strong>{{ transicion.etapa_destino.nombre }}</strong>
                                                    {% if not transicion_data.puede_realizar %}
                                                        <span class="badge bg-warning text-dark ms-2">{{ transicion_data.total_requisitos_faltantes }}</span>
                                                    {% endif %}
                                                    <br>
                                                    <small class="text-muted">{{ transicion.nombre }}</small>
                                                </a>
                                            </li>
                                            {% endwith %}
                                        {% endfor %}
                                    {% else %}
                                        <li><span class="dropdown-item-text text-muted">No hay transiciones disponibles</span></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>





        <!-- LAYOUT PRINCIPAL: RESUMEN COMPLETO (4/6) + ADJUNTOS (2/6) -->
        <div class="row mb-4">
            <div class="col-8">
                <div class="section-container">
                    <div class="resumen-header">
                        <div class="resumen-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="resumen-title">
                            <h3 class="section-title">Resumen Completo de la Solicitud</h3>
                        </div>
                        <div class="resumen-actions">
                            <button class="btn btn-light btn-sm" onclick="marcarTodosComoBueno()">
                                <i class="fas fa-check-double me-1"></i>Marcar Todos como Bueno
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="analysis-grid">
                            <!-- 1. Información de Cliente -->
                            <div class="col-md-4">
                                <div class="section-container">
                                    <div class="section-header" onclick="toggleSection(this)">
                                        <div class="section-header-content">
                                            <i class="fas fa-user text-info"></i>
                                            <h3 class="section-title">Información de Cliente</h3>
                                        </div>
                                        <div class="section-toggle">
                                            <i class="fas fa-chevron-down toggle-icon"></i>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Empresa Privada:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.nombreEmpresa|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="empresa_privada" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="empresa_privada" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="empresa_privada" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Cargo:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.posicion|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="cargo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="cargo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="cargo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Tiempo de Servicio:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.tiempoServicio|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="tiempo_servicio" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="tiempo_servicio" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="tiempo_servicio" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Salario:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.salarioBaseMensual %}
                                                        B/. {{ solicitud.cotizacion.salarioBaseMensual|floatformat:2 }}
                                                    {% elif solicitud.cotizacion.ingresos %}
                                                        B/. {{ solicitud.cotizacion.ingresos|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="salario" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="salario" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="salario" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Score:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.apcScore|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="score" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="score" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="score" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 2. Detalle de la Solicitud -->
                            <div class="col-md-4">
                                <div class="section-container">
                                    <div class="section-header" onclick="toggleSection(this)">
                                        <div class="section-header-content">
                                            <i class="fas fa-calculator text-primary"></i>
                                            <h3 class="section-title">Detalle de la Solicitud</h3>
                                        </div>
                                        <div class="section-toggle">
                                            <i class="fas fa-chevron-down toggle-icon"></i>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Valor del equipo:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.valorAuto %}
                                                        B/. {{ solicitud.cotizacion.valorAuto|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="valor_equipo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="valor_equipo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="valor_equipo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Abono:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.abono and solicitud.cotizacion.abonoPorcentaje %}
                                                        B/. {{ solicitud.cotizacion.abono|floatformat:2 }} ({{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%)
                                                    {% elif solicitud.cotizacion.abono %}
                                                        B/. {{ solicitud.cotizacion.abono|floatformat:2 }}
                                                    {% elif solicitud.cotizacion.abonoPorcentaje %}
                                                        {{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="abono" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="abono" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="abono" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Monto financiado:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.montoPrestamo %}
                                                        B/. {{ solicitud.cotizacion.montoPrestamo|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="monto_financiado" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="monto_financiado" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="monto_financiado" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Plazo:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.plazoPago %}
                                                        {{ solicitud.cotizacion.plazoPago }} meses
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="plazo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="plazo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="plazo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Rentabilidad:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.r_deseada %}
                                                        {{ solicitud.cotizacion.r_deseada|floatformat:2 }}%
                                                    {% elif solicitud.cotizacion.r1 %}
                                                        {{ solicitud.cotizacion.r1|floatformat:2 }}%
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="rentabilidad" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="rentabilidad" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="rentabilidad" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Total de letra c/seg:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.wrkMontoLetra %}
                                                        B/. {{ solicitud.cotizacion.wrkMontoLetra|floatformat:2 }}
                                                    {% else %}
                                                        Sin datos
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="total_letra" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="total_letra" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="total_letra" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            
                            <!-- 3. Datos del Vehículo -->
                            <div class="col-md-4">
                                <div class="section-container">
                                    <div class="section-header" onclick="toggleSection(this)">
                                        <div class="section-header-content">
                                            <i class="fas fa-car text-warning"></i>
                                            <h3 class="section-title">Datos del Vehículo</h3>
                                        </div>
                                        <div class="section-toggle">
                                            <i class="fas fa-chevron-down toggle-icon"></i>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Marca:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.marca|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="marca" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="marca" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="marca" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Modelo:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.modelo|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="modelo" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="modelo" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="modelo" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Año:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.yearCarro|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="año" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="año" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="año" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">Transmisión:</span>
                                                <span class="info-value">{{ solicitud.cotizacion.transmisionAuto|default:"Sin datos" }}</span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="transmision" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="transmision" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="transmision" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="info-row-with-check">
                                            <div class="info-data">
                                                <span class="info-label">KM:</span>
                                                <span class="info-value">
                                                    {% if solicitud.cotizacion.kilometrajeAuto %}
                                                        {{ solicitud.cotizacion.kilometrajeAuto|floatformat:0 }} km
                                                    {% else %}
                                                        0 km
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="kilometraje" data-action="bueno" title="Calificar como bueno">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="kilometraje" data-action="malo" title="Calificar como malo">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="kilometraje" data-action="comentario" title="Agregar comentario">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ADJUNTOS ASOCIADOS (2/6 del ancho) -->
            <div class="col-4">
                <div class="adjuntos-container">
                    <div class="adjuntos-header">
                        <div class="adjuntos-icon">
                            <i class="fas fa-paperclip"></i>
                        </div>
                        <div class="adjuntos-title">
                            <h3 class="section-title">Adjuntos</h3>
                            
                        </div>
                        {% if solicitud.requisitos.all %}
                            {% with requisitos_con_archivos=solicitud.requisitos.all|length %}
                                {% if requisitos_con_archivos > 0 %}
                                    <div class="adjuntos-actions">
                                        <button type="button" class="btn btn-light btn-sm" id="btn-download-merged-pdf" title="Descargar todos los documentos en un solo PDF">
                                            <i class="fas fa-download me-1"></i>PDF Completo
                                        </button>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                    <div class="adjuntos-content">
                        {% if solicitud.requisitos.all %}
                            {% for requisito_solicitud in solicitud.requisitos.all %}
                                <div class="adjunto-item">
                                    <div class="adjunto-icon">
                                        {% if requisito_solicitud.archivo %}
                                            <i class="fas fa-file-pdf text-danger"></i>
                                        {% else %}
                                            <i class="fas fa-file-alt text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <div class="adjunto-details">
                                        <div class="adjunto-name">{{ requisito_solicitud.requisito.nombre }}</div>
                                        <div class="adjunto-actions">
                                            {% if requisito_solicitud.archivo %}
                                                <a href="{{ requisito_solicitud.archivo.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            {% endif %}
                                            <div class="compliance-actions">
                                                <button type="button" class="btn-compliance btn-good" data-field="doc_{{ requisito_solicitud.id }}" data-action="bueno" title="Documento válido">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-bad" data-field="doc_{{ requisito_solicitud.id }}" data-action="malo" title="Documento inválido">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button type="button" class="btn-compliance btn-comment" data-field="doc_{{ requisito_solicitud.id }}" data-action="comentario" title="Comentar documento">
                                                    <i class="fas fa-comment-dots"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-light text-center">
                                <i class="fas fa-inbox me-2"></i>
                                <small>Sin adjuntos disponibles</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- SOLICITUDES RELACIONADAS (ancho completo) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="section-container">
                    <div class="resumen-header">
                        <div class="resumen-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <div class="resumen-title">
                            <h3 class="section-title">Solicitudes Relacionadas</h3>
                            <small>Cédula: {{ solicitud.cliente_cedula|default:"-" }}</small>
                        </div>
                    </div>
                    
                    <div class="section-content">
                        {% if mostrar_mensaje_sin_cliente %}
                            <div class="alert alert-warning text-center my-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Esta solicitud no tiene cédula de cliente asignada, no se pueden mostrar solicitudes relacionadas.
                            </div>
                        {% else %}
                            <!-- Búsqueda automática por cédula -->
                            <div class="search-info">
                                <i class="fas fa-search me-2"></i>
                                <span>Buscando por cédula: <strong>{{ solicitud.cliente_cedula|default:"-" }}</strong></span>
                            </div>
                            
                            <!-- Lista de solicitudes relacionadas -->
                            <div class="related-list">
                                {% for s in solicitudes_relacionadas %}
                                <div class="related-item">
                                    <div class="related-icon">
                                        <i class="fas fa-file-alt {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}text-success{% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}text-danger{% else %}text-warning{% endif %}"></i>
                                    </div>
                                    <div class="related-details">
                                        <div class="related-header-item">
                                            <strong>{{ s.codigo }}</strong>
                                            <span class="related-date">{{ s.fecha_creacion|date:"d/m/Y" }}</span>
                                        </div>
                                        <div class="related-info">
                                            <span class="badge 
                                                {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}bg-success
                                                {% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}bg-danger
                                                {% else %}bg-warning{% endif %}">
                                                {% if s.etapa_actual %}{{ s.etapa_actual.nombre }}{% else %}Sin estado{% endif %}
                                            </span>
                                            <span class="related-amount">
                                                B/. {% if s.cotizacion and s.cotizacion.montoPrestamo %}{{ s.cotizacion.montoPrestamo|floatformat:2 }}{% else %}0.00{% endif %}
                                            </span>
                                        </div>
                                        <div class="related-description">
                                            {% if s.cotizacion and s.cotizacion.tipoPrestamo %}
                                                {% if s.cotizacion.tipoPrestamo == 'auto' %}Préstamo Auto{% else %}Préstamo Personal{% endif %}
                                            {% else %}Préstamo{% endif %}
                                            {% if s.cotizacion and s.cotizacion.plazoPago %} - {{ s.cotizacion.plazoPago }} meses{% endif %}
                                        </div>
                                    </div>
                                    <div class="related-actions">
                                        <a href="{% url 'workflow:detalle_solicitud_analisis' s.id %}" class="btn btn-outline-primary btn-sm" title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="alert alert-info text-center my-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Sin solicitudes relacionadas disponibles para esta cédula.
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% if solicitudes_relacionadas %}
                            <div class="related-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Total Solicitudes:</span>
                                    <span class="summary-value">{{ solicitudes_relacionadas|length }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Aprobadas:</span>
                                    <span class="summary-value text-success">
                                        {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                    </span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">En Proceso:</span>
                                    <span class="summary-value text-warning">
                                        {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Proceso' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                    </span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Rechazadas:</span>
                                    <span class="summary-value text-danger">
                                        {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>


        <!-- COMENTARIOS DE ANALISTA (ancho completo) -->
        <div class="row mb-5">
            <!-- COMENTARIOS DE ANALISTA (ancho completo) -->
            <div class="col-12">
                <div class="comentarios-analista-section-compact">
                    <div class="comentarios-analista-header-compact">
                        <h6><i class="fas fa-user-md me-2"></i>Comentarios de Analista</h6>

                    </div>
                    <div class="comentarios-analista-body-compact" id="comentarios-analista-content">
                        <!-- Lista de comentarios existentes -->
                        <div class="comentarios-lista-compact" id="lista-comentarios-analista-credito">
                            <div class="alert alert-light text-center" id="sin-comentarios-analista">
                                <i class="fas fa-clipboard-list me-2"></i>
                                <small>Aún no hay comentarios de analista para esta solicitud</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Formulario compacto fijo en el pie -->
                    <div class="nuevo-comentario-form-compact">
                        <form id="form-comentario-analista-credito" method="post" class="comentario-form-compact">
                            {% csrf_token %}
                            <div class="form-body-compact">
                                <!-- Área de análisis unificado -->
                                <div class="analisis-unificado-container">
                                    <!-- Sección editable del analista -->
                                    <div class="analisis-seccion-editable">
                                        <label for="comentario-analista-credito-text" class="form-label">
                                            <i class="fas fa-edit me-2"></i>Análisis General (Editable)
                                        </label>
                                        <textarea class="form-control comentario-textarea-compact" 
                                                id="comentario-analista-credito-text"
                                                placeholder="Escriba su análisis general aquí..."
                                                rows="4" 
                                                maxlength="2000"
                                                required></textarea>
                                    </div>
                                    
                                    <!-- Sección de bullet points auto-generados -->
                                    <div class="analisis-seccion-bullets">
                                        <div class="bullets-header">
                                            <i class="fas fa-list-ul me-2"></i>
                                            <strong>Comentarios de Campos (Auto-generados)</strong>
                                        </div>
                                        <div class="bullets-content" id="bullets-content">
                                            <div class="bullets-placeholder">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <small>Los comentarios de campos se generarán automáticamente al guardar</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview del resultado final -->
                                    <div class="analisis-preview" id="analisis-preview" style="display: none;">
                                        <div class="preview-header">
                                            <i class="fas fa-eye me-2"></i>
                                            <strong>Vista Previa del Análisis Completo</strong>
                                        </div>
                                        <div class="preview-content" id="preview-content">
                                            <!-- El análisis completo se muestra aquí -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-footer-compact">
                                    <div class="char-counter-compact">
                                        <span id="char-count-analista-credito">0</span>/2000
                                    </div>
                                    <div class="form-actions-compact">
                                        <button type="button" class="btn btn-outline-info btn-sm me-2" id="btn-preview-analisis">
                                            <i class="fas fa-eye me-1"></i>Vista Previa
                                        </button>
                                        <button type="submit" class="btn btn-primary btn-sm" id="btn-enviar-analista-credito">
                                            <i class="fas fa-save me-1"></i>Guardar Análisis
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>



    <!-- Modal para Comentarios de Compliance -->
    <div class="modal fade" id="modalComentarioCompliance" tabindex="-1" aria-labelledby="modalComentarioComplianceLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalComentarioComplianceLabel">
                        <i class="fas fa-comment-dots me-2"></i>
                        Comentario de Compliance
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Campo:</label>
                        <div class="fw-bold text-primary" id="campo-nombre"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valor actual:</label>
                        <div class="fw-bold" id="campo-valor"></div>
                    </div>
                    <div class="mb-3">
                        <label for="comentario-compliance" class="form-label">Comentario:</label>
                        <textarea class="form-control" id="comentario-compliance" rows="5" placeholder="Ingrese su comentario sobre este campo..."></textarea>
                        <div class="form-text">
                            <span id="char-count-compliance">0</span>/500 caracteres
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-guardar-comentario-compliance">
                        <i class="fas fa-save me-2"></i>
                        Guardar Comentario
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<!-- VER MAS FUNCIONES -->
<script>
    // Toggle functionality for "Ver más" button to show/hide complete motivo consulta
    const toggleMotivoCompleto = () => {
        const textoCorto = document.getElementById('motivo-texto-corto');
        const textoCompleto = document.getElementById('motivo-texto-completo');
        const btnToggle = document.getElementById('btn-toggle-motivo');
        
        // Check if all required elements exist
        if (!textoCorto || !textoCompleto || !btnToggle) {
            console.error('Required elements for motivo toggle not found');
            return;
        }
        
        const icon = btnToggle.querySelector('i');
        const textSpan = btnToggle.querySelector('span');
        
        if (!icon) {
            console.error('Icon element not found in toggle button');
            return;
        }

        if (textoCorto.style.display !== 'none') {
            // Show complete text
            textoCorto.style.display = 'none';
            textoCompleto.style.display = 'inline';
            icon.className = 'fas fa-chevron-up';
            if (textSpan) {
                textSpan.textContent = ' Ver menos';
            }
        } else {
            // Show short text
            textoCorto.style.display = 'inline';
            textoCompleto.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
            if (textSpan) {
                textSpan.textContent = ' Ver más';
            }
        }
    };

    // Section toggle functionality
    const toggleSection = (headerElement) => {
        const sectionContent = headerElement.nextElementSibling;
        const toggleIcon = headerElement.querySelector('.toggle-icon');
        
        if (sectionContent.classList.contains('collapsed')) {
            // Expand section
            sectionContent.classList.remove('collapsed');
            headerElement.classList.remove('collapsed');
            toggleIcon.style.transform = 'rotate(0deg)';
        } else {
            // Collapse section
            sectionContent.classList.add('collapsed');
            headerElement.classList.add('collapsed');
            toggleIcon.style.transform = 'rotate(-90deg)';
        }
    };

    // Mark all as good functionality
    const marcarTodosComoBueno = () => {
        const goodButtons = document.querySelectorAll('.btn-compliance.btn-good');
        goodButtons.forEach(button => {
            button.click();
        });
    };

    // Character counter for compliance comment modal
    const updateCharCount = (textareaId, counterId, maxLength) => {
        const textarea = document.getElementById(textareaId);
        const counter = document.getElementById(counterId);
        
        if (textarea && counter) {
            const currentLength = textarea.value.length;
            counter.textContent = currentLength;
            
            if (currentLength > maxLength * 0.8) {
                counter.style.color = currentLength > maxLength ? '#dc3545' : '#ffc107';
            } else {
                counter.style.color = '#6c757d';
            }
        }
    };

    // PDF Download functionality
    const downloadMergedPDF = async () => {
        const btnDownload = document.getElementById('btn-download-merged-pdf');
        const originalContent = btnDownload.innerHTML;
        
        try {
            // Show loading state
            btnDownload.disabled = true;
            btnDownload.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando PDF...';
            
            // Get solicitud ID from URL - support both /solicitud/{id}/analisis/ and /solicitudes/{id}/detalle/
            const urlParts = window.location.pathname.split('/');
            let solicitudId = null;
            
            // Try to find solicitud ID in different URL patterns
            const solicitudIndex = urlParts.indexOf('solicitud');
            const solicitudesIndex = urlParts.indexOf('solicitudes');
            
            if (solicitudIndex !== -1 && urlParts[solicitudIndex + 1]) {
                // Pattern: /solicitud/{id}/analisis/
                solicitudId = urlParts[solicitudIndex + 1];
            } else if (solicitudesIndex !== -1 && urlParts[solicitudesIndex + 1]) {
                // Pattern: /solicitudes/{id}/detalle/
                solicitudId = urlParts[solicitudesIndex + 1];
            }
            
            // Validate solicitud ID
            if (!solicitudId || isNaN(parseInt(solicitudId))) {
                console.error('URL parts:', urlParts);
                console.error('Current pathname:', window.location.pathname);
                throw new Error('No se pudo obtener el ID de la solicitud de la URL');
            }
            
            console.log('Solicitud ID extracted:', solicitudId);
            
            // Make API call to download PDF
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/download-merged-pdf/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                // Try to get error message from response
                let errorMessage = 'Error al generar el PDF';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                } catch (e) {
                    // If response is not JSON, use status text
                    errorMessage = response.statusText || errorMessage;
                }
                throw new Error(errorMessage);
            }
            
            // Check if response is PDF
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/pdf')) {
                throw new Error('La respuesta no es un archivo PDF válido');
            }
            
            // Get filename from response headers or use default
            const contentDisposition = response.headers.get('content-disposition');
            let filename = 'Solicitud_Documentos_Completos.pdf';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            // Create blob and download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            // Show success message
            showNotification('PDF generado y descargado exitosamente', 'success');
            
        } catch (error) {
            console.error('Error downloading PDF:', error);
            showNotification(`Error: ${error.message}`, 'error');
        } finally {
            // Restore button state
            btnDownload.disabled = false;
            btnDownload.innerHTML = originalContent;
        }
    };

    // Notification system
    const showNotification = (message, type = 'info') => {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.custom-notification');
        existingNotifications.forEach(notification => notification.remove());
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `custom-notification alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        notification.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    };

    // Initialize character counters when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize compliance comment modal character counter
        const comentarioCompliance = document.getElementById('comentario-compliance');
        if (comentarioCompliance) {
            comentarioCompliance.addEventListener('input', () => {
                updateCharCount('comentario-compliance', 'char-count-compliance', 500);
            });
        }

        // Initialize analista comment character counter
        const comentarioAnalista = document.getElementById('comentario-analista-credito-text');
        if (comentarioAnalista) {
            comentarioAnalista.addEventListener('input', () => {
                updateCharCount('comentario-analista-credito-text', 'char-count-analista-credito', 2000);
            });
        }

        // Initialize PDF download button
        const btnDownloadPDF = document.getElementById('btn-download-merged-pdf');
        if (btnDownloadPDF) {
            btnDownloadPDF.addEventListener('click', downloadMergedPDF);
        }
    });
</script>
{% endblock %}
