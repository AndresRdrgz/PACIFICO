{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}Análisis de Solicitud - {{ solicitud.codigo }}{% endblock %}

{% block extra_css %}
<style>
    /* Section Toggle Styles */
    .section-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        user-select: none;
    }

    .section-header:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .section-header-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }

    .section-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .section-toggle:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .toggle-icon {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
        color: rgba(255, 255, 255, 0.8);
    }

    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .section-content {
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .section-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
    }

    /* Animation for smooth collapse/expand */
    .section-content {
        max-height: 1000px;
        opacity: 1;
    }

    .section-content.collapsed {
        max-height: 0;
        opacity: 0;
    }

    /* Compact styles for Motivo de la Consulta section */
    .observaciones-content {
        padding: 0.25rem;
    }

    .observaciones-textarea {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #f8f9fa;
        font-family: inherit;
        line-height: 1.3;
    }

    .observaciones-empty {
        padding: 0.25rem;
    }

    .observaciones-empty .alert {
        margin: 0;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header de la Solicitud -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header" style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <a href="{% url 'workflow:vista_mixta_bandejas' %}" class="btn btn-light btn-sm">
                                <i class="fas fa-arrow-left me-1"></i>Volver a Bandejas
                            </a>
                            <div>
                                <h2 class="mb-1 d-flex align-items-center">
                                    <i class="fas fa-microscope me-2"></i>
                                    Análisis: {{ solicitud.cliente_nombre|default:"Sin cliente" }}
                                    {% if solicitud.cotizacion and solicitud.cotizacion.NumeroCotizacion %}
                                    <span class="ms-3 opacity-75" style="font-size: 0.9em; font-weight: normal;">
                                        <i class="fas fa-file-invoice me-1"></i>
                                        Cotización: {{ solicitud.cotizacion.NumeroCotizacion }}
                                    </span>
                                    {% endif %}
                                </h2>
                                {% if solicitud.cotizacion and solicitud.cotizacion.observaciones %}
                                <div class="mt-2" style="font-size: 0.85em; opacity: 0.9;">
                                    <i class="fas fa-comments me-1"></i>
                                    <strong>Motivo:</strong> 
                                    <span id="motivo-texto-corto">{{ solicitud.cotizacion.observaciones|truncatechars:100 }}</span>
                                    <span id="motivo-texto-completo" style="display: none;">{{ solicitud.cotizacion.observaciones }}</span>
                                    {% if solicitud.cotizacion.observaciones|length > 100 %}
                                    <button type="button" class="btn btn-link btn-sm p-0 ms-1" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.8em;" onclick="toggleMotivoCompleto()" id="btn-toggle-motivo">
                                        <i class="fas fa-chevron-down"></i> Ver más
                                    </button>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownTransiciones" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-arrow-right me-1"></i>Cambiar Etapa
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownTransiciones">
                                {% if transiciones_disponibles %}
                                    {% for transicion_data in transiciones_disponibles %}
                                        {% with transicion=transicion_data.transicion %}
                                        <li>
                                            <a class="dropdown-item {% if not transicion_data.puede_realizar %}disabled text-muted{% endif %}" 
                                               href="#" 
                                               onclick="if(typeof realizarTransicion === 'function') { realizarTransicion({{ transicion.etapa_destino.id }}, '{{ transicion.etapa_destino.nombre|escapejs }}', {{ transicion_data.puede_realizar|yesno:'true,false' }}, {{ transicion_data.total_requisitos_faltantes }}); } else { console.error('realizarTransicion no está definido'); alert('Error: Función no disponible. Por favor recarga la página.'); } return false;"
                                               {% if not transicion_data.puede_realizar %}title="Faltan {{ transicion_data.total_requisitos_faltantes }} requisito(s) obligatorio(s)"{% endif %}>
                                                <i class="fas fa-arrow-right me-2"></i>
                                                <strong>{{ transicion.etapa_destino.nombre }}</strong>
                                                {% if not transicion_data.puede_realizar %}
                                                    <span class="badge bg-warning text-dark ms-2">{{ transicion_data.total_requisitos_faltantes }}</span>
                                                {% endif %}
                                                <br>
                                                <small class="text-muted">{{ transicion.nombre }}</small>
                                            </a>
                                        </li>
                                        {% endwith %}
                                    {% endfor %}
                                {% else %}
                                    <li><span class="dropdown-item-text text-muted">No hay transiciones disponibles</span></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>





    <!-- LAYOUT PRINCIPAL: RESUMEN COMPLETO (4/6) + ADJUNTOS (2/6) -->
    <div class="row mb-4">
        <div class="col-8">
            <div class="section-container">
                <div class="resumen-header">
                    <div class="resumen-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="resumen-title">
                        <h3 class="section-title">Resumen Completo de la Solicitud</h3>
                    </div>
                    <div class="resumen-actions">
                        <button class="btn btn-light btn-sm" onclick="marcarTodosComoBueno()">
                            <i class="fas fa-check-double me-1"></i>Marcar Todos como Bueno
                        </button>
                    </div>
                </div>
                <div class="section-content">
                    <div class="analysis-grid">
                        <!-- 1. Información de Cliente -->
                        <div class="col-md-4">
                            <div class="section-container">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-header-content">
                                        <i class="fas fa-user text-info"></i>
                                        <h3 class="section-title">Información de Cliente</h3>
                                    </div>
                                    <div class="section-toggle">
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </div>
                                </div>
                                <div class="section-content">
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Empresa Privada:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.nombreEmpresa|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="empresa_privada" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="empresa_privada" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="empresa_privada" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Cargo:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.posicion|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="cargo" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="cargo" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="cargo" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Tiempo de Servicio:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.tiempoServicio|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="tiempo_servicio" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="tiempo_servicio" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="tiempo_servicio" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Salario:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.salarioBaseMensual %}
                                                    B/. {{ solicitud.cotizacion.salarioBaseMensual|floatformat:2 }}
                                                {% elif solicitud.cotizacion.ingresos %}
                                                    B/. {{ solicitud.cotizacion.ingresos|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="salario" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="salario" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="salario" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Score:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.apcScore|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="score" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="score" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="score" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 2. Detalle de la Solicitud -->
                        <div class="col-md-4">
                            <div class="section-container">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-header-content">
                                        <i class="fas fa-calculator text-primary"></i>
                                        <h3 class="section-title">Detalle de la Solicitud</h3>
                                    </div>
                                    <div class="section-toggle">
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </div>
                                </div>
                                <div class="section-content">
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Valor del equipo:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.valorAuto %}
                                                    B/. {{ solicitud.cotizacion.valorAuto|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="valor_equipo" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="valor_equipo" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="valor_equipo" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Abono:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.abono and solicitud.cotizacion.abonoPorcentaje %}
                                                    B/. {{ solicitud.cotizacion.abono|floatformat:2 }} ({{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%)
                                                {% elif solicitud.cotizacion.abono %}
                                                    B/. {{ solicitud.cotizacion.abono|floatformat:2 }}
                                                {% elif solicitud.cotizacion.abonoPorcentaje %}
                                                    {{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="abono" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="abono" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="abono" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Monto financiado:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.montoPrestamo %}
                                                    B/. {{ solicitud.cotizacion.montoPrestamo|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="monto_financiado" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="monto_financiado" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="monto_financiado" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Plazo:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.plazoPago %}
                                                    {{ solicitud.cotizacion.plazoPago }} meses
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="plazo" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="plazo" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="plazo" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Rentabilidad:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.r_deseada %}
                                                    {{ solicitud.cotizacion.r_deseada|floatformat:2 }}%
                                                {% elif solicitud.cotizacion.r1 %}
                                                    {{ solicitud.cotizacion.r1|floatformat:2 }}%
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="rentabilidad" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="rentabilidad" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="rentabilidad" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Total de letra c/seg:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.wrkMontoLetra %}
                                                    B/. {{ solicitud.cotizacion.wrkMontoLetra|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="total_letra" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="total_letra" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="total_letra" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        
                        <!-- 3. Datos del Vehículo -->
                        <div class="col-md-4">
                            <div class="section-container">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-header-content">
                                        <i class="fas fa-car text-warning"></i>
                                        <h3 class="section-title">Datos del Vehículo</h3>
                                    </div>
                                    <div class="section-toggle">
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </div>
                                </div>
                                <div class="section-content">
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Marca:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.marca|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="marca" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="marca" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="marca" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Modelo:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.modelo|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="modelo" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="modelo" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="modelo" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Año:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.yearCarro|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="año" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="año" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="año" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">Transmisión:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.transmisionAuto|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="transmision" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="transmision" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="transmision" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-row-with-check">
                                        <div class="info-data">
                                            <span class="info-label">KM:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.kilometrajeAuto %}
                                                    {{ solicitud.cotizacion.kilometrajeAuto|floatformat:0 }} km
                                                {% else %}
                                                    0 km
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="kilometraje" data-action="bueno" title="Calificar como bueno">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="kilometraje" data-action="malo" title="Calificar como malo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="kilometraje" data-action="comentario" title="Agregar comentario">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
         <!-- ADJUNTOS ASOCIADOS (2/6 del ancho) -->
         <div class="col-4">
            <div class="adjuntos-container">
                <div class="adjuntos-header">
                    <div class="adjuntos-icon">
                        <i class="fas fa-paperclip"></i>
                    </div>
                    <div class="adjuntos-title">
                        <h3 class="section-title">Adjuntos</h3>
                        
                    </div>
                    {% if solicitud.requisitos.all %}
                        {% with requisitos_con_archivos=solicitud.requisitos.all|length %}
                            {% if requisitos_con_archivos > 0 %}
                                <div class="adjuntos-actions">
                                    <button type="button" class="btn btn-light btn-sm" id="btn-download-merged-pdf" title="Descargar todos los documentos en un solo PDF">
                                        <i class="fas fa-download me-1"></i>PDF Completo
                                    </button>
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                </div>
                <div class="adjuntos-content">
                    {% if solicitud.requisitos.all %}
                        {% for requisito_solicitud in solicitud.requisitos.all %}
                            <div class="adjunto-item">
                                <div class="adjunto-icon">
                                    {% if requisito_solicitud.archivo %}
                                        <i class="fas fa-file-pdf text-danger"></i>
                                    {% else %}
                                        <i class="fas fa-file-alt text-secondary"></i>
                                    {% endif %}
                                </div>
                                <div class="adjunto-details">
                                    <div class="adjunto-name">{{ requisito_solicitud.requisito.nombre }}</div>
                                    <div class="adjunto-actions">
                                        {% if requisito_solicitud.archivo %}
                                            <a href="{{ requisito_solicitud.archivo.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        {% endif %}
                                        <div class="compliance-actions">
                                            <button type="button" class="btn-compliance btn-good" data-field="doc_{{ requisito_solicitud.id }}" data-action="bueno" title="Documento válido">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-bad" data-field="doc_{{ requisito_solicitud.id }}" data-action="malo" title="Documento inválido">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn-compliance btn-comment" data-field="doc_{{ requisito_solicitud.id }}" data-action="comentario" title="Comentar documento">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-light text-center">
                            <i class="fas fa-inbox me-2"></i>
                            <small>Sin adjuntos disponibles</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

  
        
       
    </div>

      <!-- SOLICITUDES RELACIONADAS (ancho completo) -->
      <div class="row mb-4">
        <div class="col-12">
            <div class="section-container">
                <div class="resumen-header">
                    <div class="resumen-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <div class="resumen-title">
                        <h3 class="section-title">Solicitudes Relacionadas</h3>
                        <small>Cédula: {{ solicitud.cliente_cedula|default:"-" }}</small>
                    </div>
                </div>
                
                <div class="section-content">
                    {% if mostrar_mensaje_sin_cliente %}
                        <div class="alert alert-warning text-center my-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Esta solicitud no tiene cédula de cliente asignada, no se pueden mostrar solicitudes relacionadas.
                        </div>
                    {% else %}
                        <!-- Búsqueda automática por cédula -->
                        <div class="search-info">
                            <i class="fas fa-search me-2"></i>
                            <span>Buscando por cédula: <strong>{{ solicitud.cliente_cedula|default:"-" }}</strong></span>
                        </div>
                        
                        <!-- Lista de solicitudes relacionadas -->
                        <div class="related-list">
                            {% for s in solicitudes_relacionadas %}
                            <div class="related-item">
                                <div class="related-icon">
                                    <i class="fas fa-file-alt {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}text-success{% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}text-danger{% else %}text-warning{% endif %}"></i>
                                </div>
                                <div class="related-details">
                                    <div class="related-header-item">
                                        <strong>{{ s.codigo }}</strong>
                                        <span class="related-date">{{ s.fecha_creacion|date:"d/m/Y" }}</span>
                                    </div>
                                    <div class="related-info">
                                        <span class="badge 
                                            {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}bg-success
                                            {% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}bg-danger
                                            {% else %}bg-warning{% endif %}">
                                            {% if s.etapa_actual %}{{ s.etapa_actual.nombre }}{% else %}Sin estado{% endif %}
                                        </span>
                                        <span class="related-amount">
                                            B/. {% if s.cotizacion and s.cotizacion.montoPrestamo %}{{ s.cotizacion.montoPrestamo|floatformat:2 }}{% else %}0.00{% endif %}
                                        </span>
                                    </div>
                                    <div class="related-description">
                                        {% if s.cotizacion and s.cotizacion.tipoPrestamo %}
                                            {% if s.cotizacion.tipoPrestamo == 'auto' %}Préstamo Auto{% else %}Préstamo Personal{% endif %}
                                        {% else %}Préstamo{% endif %}
                                        {% if s.cotizacion and s.cotizacion.plazoPago %} - {{ s.cotizacion.plazoPago }} meses{% endif %}
                                    </div>
                                </div>
                                <div class="related-actions">
                                    <a href="{% url 'workflow:detalle_solicitud_analisis' s.id %}" class="btn btn-outline-primary btn-sm" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <div class="alert alert-info text-center my-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Sin solicitudes relacionadas disponibles para esta cédula.
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if solicitudes_relacionadas %}
                        <div class="related-summary">
                            <div class="summary-item">
                                <span class="summary-label">Total Solicitudes:</span>
                                <span class="summary-value">{{ solicitudes_relacionadas|length }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Aprobadas:</span>
                                <span class="summary-value text-success">
                                    {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                </span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">En Proceso:</span>
                                <span class="summary-value text-warning">
                                    {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Proceso' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                </span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Rechazadas:</span>
                                <span class="summary-value text-danger">
                                    {% for s in solicitudes_relacionadas %}{% if s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}1{% endif %}{% endfor %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <!-- COMENTARIOS DE ANALISTA (ancho completo) -->
    <div class="row mb-5">
        <!-- COMENTARIOS DE ANALISTA (ancho completo) -->
        <div class="col-12">
            <div class="comentarios-analista-section-compact">
                <div class="comentarios-analista-header-compact">
                    <h6><i class="fas fa-user-md me-2"></i>Comentarios de Analista</h6>

                </div>
                <div class="comentarios-analista-body-compact" id="comentarios-analista-content">
                    <!-- Lista de comentarios existentes -->
                    <div class="comentarios-lista-compact" id="lista-comentarios-analista-credito">
                        <div class="alert alert-light text-center" id="sin-comentarios-analista">
                            <i class="fas fa-clipboard-list me-2"></i>
                            <small>Aún no hay comentarios de analista para esta solicitud</small>
                        </div>
                    </div>
                </div>
                
                <!-- Formulario compacto fijo en el pie -->
                <div class="nuevo-comentario-form-compact">
                    <form id="form-comentario-analista-credito" method="post" class="comentario-form-compact">
                        {% csrf_token %}
                        <div class="form-body-compact">
                            <!-- Área de análisis unificado -->
                            <div class="analisis-unificado-container">
                                <!-- Sección editable del analista -->
                                <div class="analisis-seccion-editable">
                                    <label for="comentario-analista-credito-text" class="form-label">
                                        <i class="fas fa-edit me-2"></i>Análisis General (Editable)
                                    </label>
                                    <textarea class="form-control comentario-textarea-compact" 
                                              id="comentario-analista-credito-text"
                                              placeholder="Escriba su análisis general aquí..."
                                              rows="4" 
                                              maxlength="2000"
                                              required></textarea>
                                </div>
                                
                                <!-- Sección de bullet points auto-generados -->
                                <div class="analisis-seccion-bullets">
                                    <div class="bullets-header">
                                        <i class="fas fa-list-ul me-2"></i>
                                        <strong>Comentarios de Campos (Auto-generados)</strong>
                                    </div>
                                    <div class="bullets-content" id="bullets-content">
                                        <div class="bullets-placeholder">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <small>Los comentarios de campos se generarán automáticamente al guardar</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Preview del resultado final -->
                                <div class="analisis-preview" id="analisis-preview" style="display: none;">
                                    <div class="preview-header">
                                        <i class="fas fa-eye me-2"></i>
                                        <strong>Vista Previa del Análisis Completo</strong>
                                    </div>
                                    <div class="preview-content" id="preview-content">
                                        <!-- El análisis completo se muestra aquí -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-footer-compact">
                                <div class="char-counter-compact">
                                    <span id="char-count-analista-credito">0</span>/2000
                                </div>
                                <div class="form-actions-compact">
                                    <button type="button" class="btn btn-outline-info btn-sm me-2" id="btn-preview-analisis">
                                        <i class="fas fa-eye me-1"></i>Vista Previa
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-sm" id="btn-enviar-analista-credito">
                                        <i class="fas fa-save me-1"></i>Guardar Análisis
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>



<!-- Modal para Comentarios de Compliance -->
<div class="modal fade" id="modalComentarioCompliance" tabindex="-1" aria-labelledby="modalComentarioComplianceLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalComentarioComplianceLabel">
                    <i class="fas fa-comment-dots me-2"></i>
                    Comentario de Compliance
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Campo:</label>
                    <div class="fw-bold text-primary" id="campo-nombre"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Valor actual:</label>
                    <div class="fw-bold" id="campo-valor"></div>
                </div>
                <div class="mb-3">
                    <label for="comentario-compliance" class="form-label">Comentario:</label>
                    <textarea class="form-control" id="comentario-compliance" rows="5" placeholder="Ingrese su comentario sobre este campo..."></textarea>
                    <div class="form-text">
                        <span id="char-count-compliance">0</span>/500 caracteres
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar-comentario-compliance">
                    <i class="fas fa-save me-2"></i>
                    Guardar Comentario
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script para funcionalidades -->
<script>
// Variables globales
const solicitudId = parseInt('{{ solicitud.id }}');

// Función para alternar entre texto corto y completo del motivo
window.toggleMotivoCompleto = function() {
    const textoCorto = document.getElementById('motivo-texto-corto');
    const textoCompleto = document.getElementById('motivo-texto-completo');
    const btnToggle = document.getElementById('btn-toggle-motivo');
    
    if (textoCorto && textoCompleto && btnToggle) {
        const isExpanded = textoCompleto.style.display !== 'none';
        
        if (isExpanded) {
            // Contraer
            textoCorto.style.display = 'inline';
            textoCompleto.style.display = 'none';
            btnToggle.innerHTML = '<i class="fas fa-chevron-down"></i> Ver más';
        } else {
            // Expandir
            textoCorto.style.display = 'none';
            textoCompleto.style.display = 'inline';
            btnToggle.innerHTML = '<i class="fas fa-chevron-up"></i> Ver menos';
        }
    }
};

// Función para alternar secciones
window.toggleSection = function(headerElement) {
    const sectionContainer = headerElement.closest('.section-container');
    const contentElement = sectionContainer.querySelector('.section-content');
    const toggleIcon = headerElement.querySelector('.toggle-icon');
    
    // Toggle collapsed state
    const isCollapsed = headerElement.classList.contains('collapsed');
    
    if (isCollapsed) {
        // Expand section
        headerElement.classList.remove('collapsed');
        contentElement.classList.remove('collapsed');
        toggleIcon.style.transform = 'rotate(0deg)';
    } else {
        // Collapse section
        headerElement.classList.add('collapsed');
        contentElement.classList.add('collapsed');
        toggleIcon.style.transform = 'rotate(-90deg)';
    }
    
    // Save state to localStorage
    const sectionTitle = headerElement.querySelector('.section-title').textContent;
    localStorage.setItem(`section_${sectionTitle}`, !isCollapsed);
};

// Función para restaurar estados de secciones al cargar la página
function restoreSectionStates() {
    const sectionHeaders = document.querySelectorAll('.section-header');
    
    sectionHeaders.forEach(header => {
        const sectionTitle = header.querySelector('.section-title').textContent;
        const isCollapsed = localStorage.getItem(`section_${sectionTitle}`) === 'true';
        
        if (isCollapsed) {
            const sectionContainer = header.closest('.section-container');
            const contentElement = sectionContainer.querySelector('.section-content');
            const toggleIcon = header.querySelector('.toggle-icon');
            
            header.classList.add('collapsed');
            contentElement.classList.add('collapsed');
            toggleIcon.style.transform = 'rotate(-90deg)';
        }
    });
}

// Función global para obtener token CSRF
function getCsrfToken() {
    // Buscar en input hidden
    const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    if (tokenElement && tokenElement.value) {
        return tokenElement.value;
    }
    
    // Fallback: buscar en meta tags
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        return metaToken.getAttribute('content');
    }
    
    // Fallback: buscar en cookies
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    
    console.error('❌ No se pudo obtener el token CSRF');
    return '';
}

// Función para formatear nombres de campos
function formatearNombreCampo(campo) {
    const mapeoCampos = {
        'nombre': 'Nombre del Cliente',
        'cedula': 'Cédula',
        'monto': 'Monto del Préstamo',
        'plazo': 'Plazo de Pago',
        'ingresos': 'Ingresos',
        'gastos': 'Gastos',
        'capacidad_pago': 'Capacidad de Pago',
        'historial_credito': 'Historial Crediticio',
        'garantias': 'Garantías',
        'documentacion': 'Documentación',
        'apc': 'APC',
        'css': 'Ficha CSS',
        'referencias': 'Referencias',
        'trabajo': 'Información Laboral',
        'direccion': 'Dirección',
        'telefono': 'Teléfono',
        'email': 'Correo Electrónico'
    };
    
    return mapeoCampos[campo] || campo.charAt(0).toUpperCase() + campo.slice(1).replace(/_/g, ' ');
}

// Función para generar comentario completo con bullet points
async function generarComentarioCompleto() {
    const comentarioGeneral = document.getElementById('comentario-analista-credito-text').value.trim();
    
    if (!comentarioGeneral) {
        if (typeof mostrarToast === 'function') {
            mostrarToast('Debe escribir un análisis general antes de guardar', 'error');
        } else {
            alert('Debe escribir un análisis general antes de guardar');
        }
        return null;
    }
    
    try {
        // Obtener calificaciones de campos para generar bullet points
        const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Error al obtener calificaciones');
        }
        
        // Filtrar solo calificaciones con comentarios
        const calificacionesConComentarios = data.calificaciones.filter(
            cal => cal.comentario && cal.comentario.trim() !== ''
        );
        
        // Generar bullet points
        const bulletPoints = [];
        calificacionesConComentarios.forEach(cal => {
            const campoFormateado = formatearNombreCampo(cal.campo);
            const estadoIcon = cal.estado === 'bueno' ? '+' : cal.estado === 'malo' ? '-' : '•';
            bulletPoints.push(`${estadoIcon} ${campoFormateado}: ${cal.comentario}`);
        });
        
        // Combinar comentario general con bullet points
        let comentarioCompleto = comentarioGeneral;
        
        if (bulletPoints.length > 0) {
            comentarioCompleto += '\n\n' + bulletPoints.join('\n');
        }
        
        return comentarioCompleto;
        
    } catch (error) {
        console.error('❌ Error al generar comentario completo:', error);
        if (typeof mostrarToast === 'function') {
            mostrarToast('Error al generar comentario completo: ' + error.message, 'error');
        } else {
            alert('Error al generar comentario completo: ' + error.message);
        }
        return null;
    }
}

// Función para mostrar vista previa del análisis completo
async function mostrarVistaPreviaAnalisis() {
    const comentarioCompleto = await generarComentarioCompleto();
    
    if (!comentarioCompleto) {
        return;
    }
    
    const previewContainer = document.getElementById('analisis-preview');
    const previewContent = document.getElementById('preview-content');
    
    if (!previewContainer || !previewContent) {
        console.error('❌ Elementos de preview no encontrados');
        return;
    }
    
    // Formatear el contenido para mostrar
    const contenidoFormateado = comentarioCompleto
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
    
    previewContent.innerHTML = `<p>${contenidoFormateado}</p>`;
    previewContainer.style.display = 'block';
    
    // Scroll suave al preview
    previewContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    if (typeof mostrarToast === 'function') {
        mostrarToast('Vista previa generada correctamente', 'success');
    } else {
        alert('Vista previa generada correctamente');
    }
}

// Función para actualizar preview de bullet points
async function actualizarBulletsPreview() {
    const bulletsContent = document.getElementById('bullets-content');
    
    if (!bulletsContent) {
        console.error('❌ Elementos de bullets no encontrados');
        return;
    }
    
    // Mostrar loading en el contenido
    bulletsContent.innerHTML = `
        <div class="bullets-placeholder">
            <i class="fas fa-spinner fa-spin me-2"></i>
            <small>Actualizando comentarios...</small>
        </div>
    `;
    
    try {
        // Obtener calificaciones de campos
        const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Error al obtener calificaciones');
        }
        
        // Filtrar solo calificaciones con comentarios
        const calificacionesConComentarios = data.calificaciones.filter(
            cal => cal.comentario && cal.comentario.trim() !== ''
        );
        
        if (calificacionesConComentarios.length === 0) {
            bulletsContent.innerHTML = `
                <div class="bullets-placeholder">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>No hay comentarios de campos disponibles</small>
                </div>
            `;
            return;
        }
        
        // Generar HTML de bullet points
        const bulletPointsHTML = calificacionesConComentarios.map(cal => {
            const estadoClass = cal.estado === 'bueno' ? 'success' : cal.estado === 'malo' ? 'danger' : 'secondary';
            const estadoIcon = cal.estado === 'bueno' ? '+' : cal.estado === 'malo' ? '-' : '•';
            
            return `
                <div class="bullet-point-item">
                    <div class="bullet-point-icon">
                        <span class="text-${estadoClass}">${estadoIcon}</span>
                    </div>
                    <div class="bullet-point-content">
                        <div class="bullet-point-field">${formatearNombreCampo(cal.campo)}</div>
                        <div class="bullet-point-comment">${cal.comentario}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        bulletsContent.innerHTML = bulletPointsHTML;
        if (typeof mostrarToast === 'function') {
            mostrarToast(`${calificacionesConComentarios.length} comentarios de campos actualizados`, 'success');
        } else {
            alert(`${calificacionesConComentarios.length} comentarios de campos actualizados`);
        }
        
    } catch (error) {
        console.error('❌ Error al actualizar bullets:', error);
        if (typeof mostrarToast === 'function') {
            mostrarToast('Error al actualizar comentarios: ' + error.message, 'error');
        } else {
            alert('Error al actualizar comentarios: ' + error.message);
        }
        
        bulletsContent.innerHTML = `
            <div class="bullets-placeholder">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <small>Error al cargar comentarios de campos</small>
            </div>
        `;
    }
}

// ==========================================
// FUNCIONES GLOBALES PARA TRANSICIONES
// ==========================================

// Función para realizar transiciones
window.realizarTransicion = function(etapaDestinoId, etapaDestinoNombre, puedeRealizar, requisitosFaltantes) {
    console.log('🔄 Iniciando transición:', {
        etapaDestinoId: etapaDestinoId,
        etapaDestino: etapaDestinoNombre,
        puedeRealizar: puedeRealizar,
        requisitosFaltantes: requisitosFaltantes
    });
    
    if (!puedeRealizar) {
        const mensaje = `No puedes realizar esta transición porque faltan ${requisitosFaltantes} requisito(s) obligatorio(s).`;
        if (typeof mostrarToast === 'function') {
            mostrarToast(mensaje, 'warning');
        } else {
            alert(mensaje);
        }
        return;
    }
    
    // Mostrar modal de confirmación con comentarios analista
    // Agregar un pequeño delay para asegurar que los comentarios estén guardados
    setTimeout(() => {
        mostrarModalConfirmacion(etapaDestinoId, etapaDestinoNombre);
    }, 500);
};

// Función para mostrar modal de confirmación
window.mostrarModalConfirmacion = function(etapaDestinoId, etapaDestinoNombre) {
    // Verificar que solicitudId esté disponible
    if (typeof solicitudId === 'undefined') {
        console.error('❌ Error: solicitudId no está definido');
        alert('Error: No se pudo obtener la información de la solicitud');
        return;
    }
    
    // Primero refrescar la lista de comentarios para asegurar datos actualizados
    if (typeof cargarComentariosAnalistaCredito === 'function') {
        console.log('🔄 Refrescando lista de comentarios antes de mostrar modal...');
        cargarComentariosAnalistaCredito();
    }
    
    // Obtener comentarios analista de crédito
    console.log('🔍 Buscando comentarios de analista de crédito para solicitud:', solicitudId);
    fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios-analista-credito/`)
        .then(response => response.json())
        .then(data => {
            console.log('📋 Respuesta de comentarios de analista:', data);
            let comentariosHTML = '';
            if (data.success && data.comentarios.length > 0) {
                console.log('✅ Encontrados', data.comentarios.length, 'comentarios de analista');
                // Tomar solo el comentario más reciente (el último en la lista)
                const comentario = data.comentarios[data.comentarios.length - 1];
                console.log('📋 Mostrando comentario más reciente:', comentario);
                
                // Generar HTML del comentario más reciente con párrafo y bullet points
                const lines = (comentario.comentario || '').split('\n');
                // Find the index of the first bullet point
                const bulletIdx = lines.findIndex(line => line.trim().match(/^([•\-*]|\d+\.)\s/));
                let mainParagraph = '';
                let bulletLines = [];
                if (bulletIdx === -1) {
                    mainParagraph = lines.join(' ');
                } else {
                    mainParagraph = lines.slice(0, bulletIdx).join(' ');
                    bulletLines = lines.slice(bulletIdx).filter(line => line.trim().match(/^([•\-*]|\d+\.)\s/));
                }
                // Clean up bullet points (remove marker)
                const bulletHTML = bulletLines.length > 0 ?
                    `<ul class="mb-0">${bulletLines.map(line => `<li>${line.trim().replace(/^([•\-*]|\d+\.)\s/, '')}</li>`).join('')}</ul>`
                    : '';
                
                comentariosHTML = `
                    <div class="comentario-confirmacion mb-3">
                        <div class="comentario-header">
                            <strong>${comentario.usuario_nombre || 'Analista'}</strong>
                            <small>${typeof formatearFecha === 'function' ? formatearFecha(comentario.fecha_creacion) : new Date(comentario.fecha_creacion).toLocaleString()}</small>
                        </div>
                        <div class="comentario-texto mb-2">${mainParagraph.replace(/\n/g, '<br>')}</div>
                        ${bulletHTML}
                    </div>
                `;
                        } else {
                console.log('⚠️ No se encontraron comentarios de analista');
                comentariosHTML = '<p class="text-muted">No hay comentarios de analista para esta solicitud.</p>';
            }
            
            // Mostrar modal con la información
            const modalHTML = `
                <div class="modal fade" id="modalConfirmacionTransicion" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-arrow-right me-2"></i>
                                    Confirmar Transición a: ${etapaDestinoNombre}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    La solicitud será enviada a la etapa: <strong>${etapaDestinoNombre}</strong>
                                </div>
                                <div class="comentarios-analista-section">
                                    <h6><i class="fas fa-comments me-2"></i>Comentarios del Analista:</h6>
                                    ${comentariosHTML}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </button>
                                <button type="button" class="btn btn-primary" onclick="confirmarTransicion(${etapaDestinoId}, '${etapaDestinoNombre}')">
                                    <i class="fas fa-check me-1"></i>Confirmar Transición
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            // Remover modal existente si existe
            const existingModal = document.getElementById('modalConfirmacionTransicion');
            if (existingModal) {
                existingModal.remove();
            }
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacionTransicion'));
            modal.show();
            // Limpiar modal cuando se cierre
            document.getElementById('modalConfirmacionTransicion').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        })
        .catch(error => {
            console.error('❌ Error al obtener comentarios:', error);
            console.error('❌ Error details:', error.message);
            
            // Intentar obtener comentarios del DOM como fallback
            console.log('🔄 Intentando obtener comentarios del DOM como fallback...');
            const comentariosContainer = document.getElementById('lista-comentarios-analista-credito');
            if (comentariosContainer && comentariosContainer.children.length > 0) {
                console.log('✅ Encontrados comentarios en el DOM, usando como fallback');
                // Tomar solo el comentario más reciente (el último en la lista del DOM)
                const comentarioItem = comentariosContainer.children[comentariosContainer.children.length - 1];
                const comentariosHTML = (() => {
                    const header = comentarioItem.querySelector('.comentario-analista-header');
                    const text = comentarioItem.querySelector('.comentario-analista-text');
                    const author = header?.querySelector('.comentario-analista-info strong')?.textContent || 'Analista';
                    const date = header?.querySelector('.comentario-analista-info small')?.textContent || '';
                    const content = text?.innerHTML || '';
                    
                    // Parsear el contenido para separar párrafo y bullet points
                    const lines = content.split('<br>');
                    const bulletIdx = lines.findIndex(line => line.trim().match(/^([•\-*]|\d+\.)\s/));
                    let mainParagraph = '';
                    let bulletLines = [];
                    if (bulletIdx === -1) {
                        mainParagraph = lines.join(' ');
                    } else {
                        mainParagraph = lines.slice(0, bulletIdx).join(' ');
                        bulletLines = lines.slice(bulletIdx).filter(line => line.trim().match(/^([•\-*]|\d+\.)\s/));
                    }
                    
                    const bulletHTML = bulletLines.length > 0 ?
                        `<ul class="mb-0">${bulletLines.map(line => `<li>${line.trim().replace(/^([•\-*]|\d+\.)\s/, '')}</li>`).join('')}</ul>`
                        : '';
                    
                    return `
                        <div class="comentario-confirmacion mb-3">
                            <div class="comentario-header">
                                <strong>${author}</strong>
                                <small>${date}</small>
                            </div>
                            <div class="comentario-texto mb-2">${mainParagraph}</div>
                            ${bulletHTML}
                        </div>
                    `;
                })();
                
                // Mostrar modal con comentarios del DOM
                const modalHTML = `
                    <div class="modal fade" id="modalConfirmacionTransicion" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-arrow-right me-2"></i>
                                        Confirmar Transición a: ${etapaDestinoNombre}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        La solicitud será enviada a la etapa: <strong>${etapaDestinoNombre}</strong>
                                    </div>
                                    <div class="comentarios-analista-section">
                                        <h6><i class="fas fa-comments me-2"></i>Último Comentario del Analista:</h6>
                                        ${comentariosHTML}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i>Cancelar
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="confirmarTransicion(${etapaDestinoId}, '${etapaDestinoNombre}')">
                                        <i class="fas fa-check me-1"></i>Confirmar Transición
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // Remover modal existente si existe
                const existingModal = document.getElementById('modalConfirmacionTransicion');
                if (existingModal) {
                    existingModal.remove();
                }
                // Agregar modal al DOM
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalConfirmacionTransicion'));
                modal.show();
                // Limpiar modal cuando se cierre
                document.getElementById('modalConfirmacionTransicion').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
            } else {
                console.log('⚠️ No se encontraron comentarios en el DOM');
                // Mostrar modal sin comentarios
                const modalHTML = `
                    <div class="modal fade" id="modalConfirmacionTransicion" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-arrow-right me-2"></i>
                                        Confirmar Transición a: ${etapaDestinoNombre}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        La solicitud será enviada a la etapa: <strong>${etapaDestinoNombre}</strong>
                                    </div>
                                    <div class="comentarios-analista-section">
                                        <h6><i class="fas fa-comments me-2"></i>Último Comentario del Analista:</h6>
                                        <p class="text-muted">No hay comentarios de analista para esta solicitud.</p>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i>Cancelar
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="confirmarTransicion(${etapaDestinoId}, '${etapaDestinoNombre}')">
                                        <i class="fas fa-check me-1"></i>Confirmar Transición
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // Remover modal existente si existe
                const existingModal = document.getElementById('modalConfirmacionTransicion');
                if (existingModal) {
                    existingModal.remove();
                }
                // Agregar modal al DOM
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalConfirmacionTransicion'));
                modal.show();
                // Limpiar modal cuando se cierre
                document.getElementById('modalConfirmacionTransicion').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
            }
        });
    


// Función para confirmar transición
window.confirmarTransicion = function(etapaDestinoId, etapaDestinoNombre) {
    console.log('✅ Confirmando transición a:', etapaDestinoNombre);
    
    // Mostrar loading
    const btnConfirmar = document.querySelector('#modalConfirmacionTransicion .btn-primary');
    const originalText = btnConfirmar.innerHTML;
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
    
    // Realizar transición
    fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            etapa_destino_id: etapaDestinoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Transición exitosa:', data);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionTransicion'));
            modal.hide();
            
            // Mostrar mensaje de éxito
            if (typeof mostrarToast === 'function') {
                mostrarToast(`Solicitud enviada exitosamente a: ${etapaDestinoNombre}`, 'success');
            } else {
                alert(`Solicitud enviada exitosamente a: ${etapaDestinoNombre}`);
            }
            
            // Mostrar mensaje de éxito sin recargar la página
            if (typeof mostrarToast === 'function') {
                mostrarToast(`Solicitud enviada exitosamente a: ${etapaDestinoNombre}`, 'success');
            } else {
                alert(`Solicitud enviada exitosamente a: ${etapaDestinoNombre}`);
            }
        } else {
            console.error('❌ Error en transición:', data.error);
            alert('Error al realizar la transición: ' + data.error);
            
            // Restaurar botón
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('❌ Error de red:', error);
        alert('Error de red al realizar la transición');
        
        // Restaurar botón
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = originalText;
    });
};

// Función para formatear fecha
window.formatearFecha = function(fechaISO) {
    const fecha = new Date(fechaISO);
    return fecha.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
};

// Función para mostrar toast (placeholder)
window.mostrarToast = function(mensaje, tipo = 'info') {
    // Implementación básica si no existe la función
    console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
    
    // Mostrar con alert como fallback
    if (tipo === 'error') {
        alert('Error: ' + mensaje);
    } else if (tipo === 'warning') {
        alert('Advertencia: ' + mensaje);
    } else {
        // Para success e info, usar console.log
        console.log(mensaje);
    }
};

    // Función para marcar todos los campos como buenos
    window.marcarTodosComoBueno = function() {
        if (confirm('¿Está seguro que desea marcar todos los campos como "Bueno"?')) {
            // Mostrar toast de inicio
            mostrarToast('Iniciando calificación masiva de campos...', 'info');
            
            // Obtener todos los botones de calificación "Bueno"
            const botonesBueno = document.querySelectorAll('.btn-compliance[data-action="bueno"]');
            let contador = 0;
            let promesas = [];
            
            botonesBueno.forEach(btn => {
                const campo = btn.getAttribute('data-field');
                if (campo) {
                    // Crear promesa para calificar campo sin mostrar toast individual
                    const promesa = calificarCampoSinToast(campo, 'bueno');
                    promesas.push(promesa);
                    contador++;
                }
            });
            
            // Esperar a que todas las calificaciones se completen
            Promise.all(promesas).then(() => {
                mostrarToast(`${contador} campos han sido marcados como "Bueno" exitosamente`, 'success');
            }).catch(error => {
                console.error('Error al marcar campos como bueno:', error);
                mostrarToast('Error al marcar algunos campos como "Bueno"', 'error');
            });
        }
    };

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar reloj en tiempo real
    function actualizarTiempo() {
        const ahora = new Date();
        
        // Formatear hora
        const horas = ahora.getHours().toString().padStart(2, '0');
        const minutos = ahora.getMinutes().toString().padStart(2, '0');
        const segundos = ahora.getSeconds().toString().padStart(2, '0');
        
        // Formatear fecha
        const dia = ahora.getDate().toString().padStart(2, '0');
        const mes = (ahora.getMonth() + 1).toString().padStart(2, '0');
        const año = ahora.getFullYear();
        
        // Actualizar elementos con verificación de existencia
        const relojElement = document.getElementById('reloj-tiempo-real');
        const fechaElement = document.getElementById('fecha-actual');
        const tiempoBotonElement = document.getElementById('tiempo-boton');
        
        if (relojElement) {
            relojElement.textContent = `${horas}:${minutos}:${segundos}`;
        }
        if (fechaElement) {
            fechaElement.textContent = `${dia}/${mes}/${año}`;
        }
        if (tiempoBotonElement) {
            tiempoBotonElement.textContent = `${horas}:${minutos}:${segundos}`;
        }
    }
    
    // Inicializar tiempo inmediatamente
    actualizarTiempo();
    
    // Actualizar cada segundo
    setInterval(actualizarTiempo, 1000);
    

    
    // Funciones para comentarios
    function guardarComentario(tipo, texto) {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`/workflow/api/solicitudes/{{ solicitud.id }}/comentarios/crear/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                comentario: texto,
                tipo: tipo
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de éxito sin recargar
                if (typeof mostrarToast === 'function') {
                    mostrarToast('Comentario guardado exitosamente', 'success');
                } else {
                    alert('Comentario guardado exitosamente');
                }
                // Opcional: limpiar el formulario o actualizar la vista
            } else {
                alert('Error al guardar comentario: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al guardar comentario');
        });
    }




    
    // Función para descargar PDF completo con todos los documentos
    function downloadMergedPDF() {
        const btn = document.getElementById('btn-download-merged-pdf');
        const originalText = btn.innerHTML;
        
        // Mostrar loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando PDF...';
        
        // Obtener token CSRF
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Realizar petición para generar PDF
        fetch(`/workflow/api/solicitudes/{{ solicitud.id }}/download-merged-pdf/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                // Si la respuesta no es exitosa, intentar leer el error como JSON
                return response.json().then(errorData => {
                    throw new Error(errorData.error || 'Error en la respuesta del servidor');
                }).catch(() => {
                    throw new Error('Error en la respuesta del servidor');
                });
            }
            return response.blob();
        })
        .then(blob => {
            // Crear URL del blob y descargar
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `Solicitud_{{ solicitud.codigo }}_Documentos_Completos.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Mostrar notificación de éxito
            if (typeof mostrarToast === 'function') {
                mostrarToast('PDF generado y descargado correctamente', 'success');
            } else {
                alert('PDF generado y descargado correctamente');
            }
        })
        .catch(error => {
            console.error('Error al generar PDF:', error);
            if (typeof mostrarToast === 'function') {
                mostrarToast('Error al generar el PDF. Intente nuevamente.', 'error');
            } else {
                alert('Error al generar el PDF. Intente nuevamente.');
            }
        })
        .finally(() => {
            // Restaurar botón
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    }
    
    // Event listener para el botón de descarga de PDF completo
    const btnDownloadMergedPDF = document.getElementById('btn-download-merged-pdf');
    if (btnDownloadMergedPDF) {
        btnDownloadMergedPDF.addEventListener('click', downloadMergedPDF);
    }
    
    // ==========================================
    // FUNCIONALIDAD PARA GENERAR BULLET POINTS
    // ==========================================
    

    

    
    // Event listeners para botones de análisis unificado
    const btnPreviewAnalisis = document.getElementById('btn-preview-analisis');
    
    if (btnPreviewAnalisis) {
        btnPreviewAnalisis.addEventListener('click', mostrarVistaPreviaAnalisis);
    }
    

    
    // Función para agregar comentario a la lista
    function agregarComentarioALista(comentario) {
        const listaComentarios = document.getElementById('lista-comentarios');
        const emptyState = listaComentarios.querySelector('.empty-state-modern');
        
        // Remover estado vacío si existe
        if (emptyState) {
            emptyState.remove();
        }
        
        // Crear HTML del nuevo comentario
        const comentarioHTML = `
            <div class="comentario-item-modern">
                <div class="comentario-avatar-modern">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="comentario-content-modern">
                    <div class="comentario-header-modern">
                        <div class="author-info">
                            <strong class="author-name">${comentario.usuario_nombre}</strong>
                            <span class="author-role">Analista</span>
                            <span class="comentario-date-modern">Hace un momento</span>
                        </div>
                        <div class="comentario-actions">
                            <button class="btn-action-mini" title="Editar comentario">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action-mini text-danger" title="Eliminar comentario">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="comentario-text-modern">
                        ${comentario.texto.replace(/\n/g, '<br>')}
                    </div>
                    <div class="comentario-footer-modern">
                        <button class="btn-reaction">
                            <i class="fas fa-thumbs-up me-1"></i>
                            <span>0</span>
                        </button>
                        <button class="btn-reaction">
                            <i class="fas fa-reply me-1"></i>
                            Responder
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Insertar al inicio de la lista
        listaComentarios.insertAdjacentHTML('afterbegin', comentarioHTML);
        
        // Animar el nuevo comentario
        const nuevoComentario = listaComentarios.firstElementChild;
        nuevoComentario.style.opacity = '0';
        nuevoComentario.style.transform = 'translateY(-20px)';
        
        setTimeout(() => {
            nuevoComentario.style.transition = 'all 0.3s ease';
            nuevoComentario.style.opacity = '1';
            nuevoComentario.style.transform = 'translateY(0)';
        }, 100);
    }
    
    // Función para actualizar contador de comentarios
    function actualizarContadorComentarios() {
        const badge = document.querySelector('.comentarios-count .badge');
        if (badge) {
            const count = document.querySelectorAll('.comentario-item-modern').length;
            badge.textContent = `${count} comentario${count !== 1 ? 's' : ''}`;
        }
    }
    
    // Funciones de notificación mejoradas - Usar la función global showToast del base.html
    function mostrarToast(mensaje, tipo = 'info', duracion = 3000) {
        // Usar la función global showToast si está disponible, sino crear una local
        if (typeof showToast === 'function') {
            showToast(mensaje, tipo, duracion);
        } else {
            // Fallback local si showToast no está disponible
            const toast = document.createElement('div');
            toast.className = `alert alert-${tipo} position-fixed`;
            toast.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 1080;
                max-width: 400px;
                min-width: 300px;
                animation: slideInRight 0.3s ease-out;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.1);
            `;
            
            const iconMap = {
                'success': 'check-circle',
                'info': 'info-circle',
                'warning': 'exclamation-triangle',
                'danger': 'times-circle',
                'error': 'times-circle'
            };
            
            toast.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${iconMap[tipo] || 'info-circle'} me-2"></i>
                        <span>${mensaje}</span>
                    </div>
                    <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after duration
            if (duracion > 0) {
                setTimeout(() => {
                    if (toast && toast.parentNode) {
                        toast.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => {
                            if (toast && toast.parentNode) {
                                toast.remove();
                            }
                        }, 300);
                    }
                }, duracion);
            }
        }
    }
    
    // Funciones de compatibilidad para mantener el código existente
    function mostrarNotificacionExito(mensaje) {
        mostrarToast(mensaje, 'success', 3000);
    }
    
    function mostrarNotificacionError(mensaje) {
        mostrarToast(mensaje, 'error', 4000);
    }
    


    // Funciones para botones de acción
    window.ejecutarTransicion = function(transicionId) {
        if (confirm('¿Está seguro de realizar esta transición?')) {
            // Implementar lógica de transición
            console.log('Ejecutando transición:', transicionId);
        }
    };

    window.aprobarSolicitud = function() {
        if (confirm('¿Está seguro de aprobar esta solicitud?')) {
            // Implementar lógica de aprobación
            console.log('Aprobando solicitud');
        }
    };

    window.rechazarSolicitud = function() {
        if (confirm('¿Está seguro de rechazar esta solicitud?')) {
            // Implementar lógica de rechazo
            console.log('Rechazando solicitud');
        }
    };

    window.solicitarMasInformacion = function() {
        const motivo = prompt('Indique el motivo por el cual solicita más información:');
        if (motivo) {
            // Implementar lógica para solicitar más información
            console.log('Solicitando más información:', motivo);
        }
    };

    window.derivarSolicitud = function() {
        // Implementar lógica para derivar solicitud
        console.log('Derivando solicitud');
    };

    window.editarComentario = function(comentarioId) {
        // Implementar lógica para editar comentario
        console.log('Editando comentario:', comentarioId);
    };

    window.eliminarComentario = function(comentarioId) {
        if (confirm('¿Está seguro de eliminar este comentario?')) {
            // Implementar lógica para eliminar comentario
            console.log('Eliminando comentario:', comentarioId);
        }
    };

    // ==========================================
    // FUNCIÓN PARA REALIZAR TRANSICIONES
    // ==========================================
    

    

    
    // Función para extraer bullet points de comentarios
    window.extraerBulletPoints = function(comentarios) {
        const bulletPoints = [];
        
        comentarios.forEach(comentario => {
            const texto = comentario.comentario;
            
            // Buscar líneas que empiecen con •, -, *, o números
            const lineas = texto.split('\n');
            lineas.forEach(linea => {
                const lineaLimpia = linea.trim();
                if (lineaLimpia.match(/^[•\-\*]\s/) || lineaLimpia.match(/^\d+\.\s/)) {
                    // Remover el marcador y limpiar
                    const punto = lineaLimpia.replace(/^[•\-\*]\s/, '').replace(/^\d+\.\s/, '');
                    if (punto.length > 0) {
                        bulletPoints.push(punto);
                    }
                }
            });
        });
        
        return bulletPoints;
    }
    

    
    // Función auxiliar para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // ==========================================
    // SISTEMA DE COMENTARIOS COMPLETO
    // ==========================================
    
    // Variables globales
    const solicitudId = parseInt('{{ solicitud.id }}');
    const usuarioActualId = parseInt('{{ request.user.id }}');
    
    // Función para mostrar notificaciones - usa la función principal al final del archivo
    
    // Función para formatear fecha
    function formatearFecha(fecha) {
        const now = new Date();
        const diff = now - new Date(fecha);
        const seconds = Math.floor(diff / 1000);
        
        if (seconds < 60) return 'hace unos segundos';
        if (seconds < 3600) return `hace ${Math.floor(seconds / 60)} minutos`;
        if (seconds < 86400) return `hace ${Math.floor(seconds / 3600)} horas`;
        return `hace ${Math.floor(seconds / 86400)} días`;
    }
    
    // Función para auto-expandir textarea
    function autoExpandTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    // Función para enviar mensaje con Enter
    function handleKeyDown(event, submitFunction) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            submitFunction(event);
        }
    }
    
    // Función para scroll automático al final del chat
    function scrollToBottom(container) {
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
    

    
    // FUNCIONES PARA COMENTARIOS DE ANALISTA
    
    // Cargar comentarios de analista
    function cargarComentariosAnalista() {
        console.log('🔄 Cargando comentarios de analista...');
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios/?tipo=analista`)
            .then(response => response.json())
            .then(data => {
                console.log('📊 Comentarios analista recibidos:', data);
                
                if (data.success) {
                    const container = document.getElementById('lista-comentarios-analista');
                    
                    if (data.comentarios.length === 0) {
                        container.innerHTML = '';
                    } else {
                        // Mostrar solo comentarios sin mensaje de bienvenida
                        const welcomeMessage = ``;
                        
                        const messages = data.comentarios.map(comentario => {
                            const esPropio = comentario.usuario.id === usuarioActualId;
                            return `
                                <div class="message-bubble ${esPropio ? 'own' : 'other'}" data-comentario-id="${comentario.id}">
                                    <div class="message-content">
                                        ${comentario.comentario}
                                    </div>
                                    <div class="message-meta">
                                        <span class="message-author">${comentario.usuario.nombre_completo}</span>
                                        <span class="message-time">${formatearFecha(comentario.fecha_creacion)}</span>
                                        ${comentario.puede_editar ? `
                                            <div class="message-actions">
                                                <button class="action-btn" onclick="editarComentarioAnalista(${comentario.id})" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="action-btn" onclick="eliminarComentarioAnalista(${comentario.id})" title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        container.innerHTML = welcomeMessage + messages;
                        
                        // Scroll automático al final
                        setTimeout(() => {
                            container.scrollTop = container.scrollHeight;
                        }, 100);
                    }
                } else {
                    console.error('❌ Error al cargar comentarios:', data.error);
                    mostrarToast('Error al cargar comentarios: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('❌ Error de red:', error);
                mostrarToast('Error de red al cargar comentarios', 'error');
            });
    }
    

    
    // Función para editar comentario de analista
    window.editarComentarioAnalista = function(comentarioId) {
        const comentarioElement = document.querySelector(`[data-comentario-id="${comentarioId}"]`);
        const textoElement = comentarioElement.querySelector('.comentario-text-sidebar');
        const textoOriginal = textoElement.textContent.trim();
        
        // Crear campo de edición
        const textarea = document.createElement('textarea');
        textarea.className = 'form-control-sidebar';
        textarea.value = textoOriginal;
        textarea.style.minHeight = '60px';
        
        // Crear botones
        const botonesContainer = document.createElement('div');
        botonesContainer.className = 'comentario-actions-sidebar mt-2';
        botonesContainer.innerHTML = `
            <button class="btn-action-sidebar" onclick="guardarEdicionAnalista(${comentarioId}, this)">
                <i class="fas fa-save"></i> Guardar
            </button>
            <button class="btn-action-sidebar" onclick="cancelarEdicionAnalista(${comentarioId})">
                <i class="fas fa-times"></i> Cancelar
            </button>
        `;
        
        // Reemplazar contenido
        textoElement.innerHTML = '';
        textoElement.appendChild(textarea);
        textoElement.appendChild(botonesContainer);
        
        // Ocultar botones originales
        const accionesOriginales = comentarioElement.querySelector('.comentario-actions-sidebar:not(.mt-2)');
        if (accionesOriginales) {
            accionesOriginales.style.display = 'none';
        }
        
        // Enfocar textarea
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    };
    
    // Función para guardar edición de comentario analista
    window.guardarEdicionAnalista = function(comentarioId, botonElement) {
        const comentarioElement = document.querySelector(`[data-comentario-id="${comentarioId}"]`);
        const textarea = comentarioElement.querySelector('textarea');
        const nuevoTexto = textarea.value.trim();
        
        if (!nuevoTexto) {
            mostrarToast('El comentario no puede estar vacío', 'error');
            return;
        }
        
        console.log('💾 Guardando edición comentario analista:', comentarioId, nuevoTexto);
        
        fetch(`/workflow/api/comentarios/${comentarioId}/editar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ comentario: nuevoTexto })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Comentario actualizado exitosamente');
                cargarComentariosAnalista();
            } else {
                mostrarToast('Error al actualizar comentario: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Error:', error);
            mostrarToast('Error de red al actualizar comentario', 'error');
        });
    };
    
    // Función para cancelar edición de comentario analista
    window.cancelarEdicionAnalista = function(comentarioId) {
        cargarComentariosAnalista();
    };
    
    // Función para eliminar comentario de analista
    window.eliminarComentarioAnalista = function(comentarioId) {
        if (!confirm('¿Estás seguro de eliminar este comentario de analista?')) {
            return;
        }
        
        console.log('🗑️ Eliminando comentario analista:', comentarioId);
        
        fetch(`/workflow/api/comentarios/${comentarioId}/eliminar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Comentario eliminado exitosamente');
                cargarComentariosAnalista();
            } else {
                mostrarToast('Error al eliminar comentario: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Error:', error);
            mostrarToast('Error de red al eliminar comentario', 'error');
        });
    };
    

    

    

    
    // FUNCIONES AUXILIARES
    
    // Función para actualizar contador de caracteres
    function actualizarContadorCaracteres(textareaId, counterId) {
        const textarea = document.getElementById(textareaId);
        const counter = document.getElementById(counterId);
        
        if (textarea && counter) {
            counter.textContent = textarea.value.length;
        }
    }
    
    // EVENT LISTENERS
    

    
    // INICIALIZACIÓN
    console.log('🚀 Inicializando sistema de comentarios completo...');
    
    // Cargar comentarios al cargar la página
    cargarComentariosAnalista();
    
    // Comentarios se cargan una vez al inicio
    // Auto-refresh removido para evitar interrupciones del usuario
    
    // ==========================================
    // FUNCIONALIDADES DE COMPLIANCE
    // ==========================================
    
    // Función para inicializar botones de compliance
    function inicializarComplianceButtons() {
        console.log('🔧 Inicializando botones de compliance...');
        const complianceButtons = document.querySelectorAll('.btn-compliance');
        
        console.log(`📊 Encontrados ${complianceButtons.length} botones de compliance`);
        
        if (complianceButtons.length === 0) {
            console.error('❌ No se encontraron botones de compliance');
            return;
        }
        
        complianceButtons.forEach((button, index) => {
            const field = button.dataset.field;
            const action = button.dataset.action;
            
            console.log(`🔘 Botón ${index + 1}: campo="${field}", acción="${action}"`);
            
            button.addEventListener('click', function(e) {
                console.log(`🎯 Click en botón: campo="${field}", acción="${action}"`);
                
                try {
                    if (action === 'comentario') {
                        // Abrir modal para comentario
                        abrirModalComentario(field);
                    } else {
                        // Calificar campo como bueno o malo
                        calificarCampo(field, action);
                    }
                } catch (error) {
                    console.error('❌ Error al manejar click:', error);
                    alert('Error al procesar la acción. Ver consola para más detalles.');
                }
            });
        });
        
        // Inicializar modal de comentarios
        inicializarModalComentario();
        
        // Cargar estados existentes
        cargarEstadosCompliance();
        
        console.log('✅ Botones de compliance inicializados correctamente');
    }
    
    // Función para abrir modal de comentario
    function abrirModalComentario(field) {
        const modal = new bootstrap.Modal(document.getElementById('modalComentarioCompliance'));
        const campoNombre = document.getElementById('campo-nombre');
        const campoValor = document.getElementById('campo-valor');
        const comentarioTextarea = document.getElementById('comentario-compliance');
        
        // Obtener información del campo
        const fieldInfo = getFieldInfo(field);
        
        // Configurar modal
        campoNombre.textContent = fieldInfo.label;
        campoValor.textContent = fieldInfo.value;
        comentarioTextarea.value = fieldInfo.comentario || '';
        
        // Configurar botón de guardar
        const btnGuardar = document.getElementById('btn-guardar-comentario-compliance');
        btnGuardar.onclick = function() {
            const comentario = comentarioTextarea.value.trim();
            if (comentario) {
                guardarComentarioCompliance(field, comentario);
                modal.hide();
            } else {
                mostrarToast('Por favor ingrese un comentario', 'error');
            }
        };
        
        // Almacenar field actual
        modal._element.dataset.field = field;
        
        modal.show();
    }
    
    // Función para obtener información del campo
    function getFieldInfo(field) {
        const fieldMap = {
            'nombre': { label: 'Nombre Completo' },
            'cedula': { label: 'Cédula' },
            'canal': { label: 'Canal de Origen' },
            'monto': { label: 'Monto Solicitado' },
            'plazo': { label: 'Plazo' },
            'tasa': { label: 'Tasa de Interés' },
            'cuota': { label: 'Cuota Mensual' },
            'fecha': { label: 'Fecha de Inicio' },
            'etapa': { label: 'Etapa Actual' },
            'area': { label: 'Área Responsable' },
            'responsable': { label: 'Responsable' }
        };
        
        const info = fieldMap[field];
        if (!info) return { label: field, value: '-', comentario: '' };
        
        // Buscar el botón con el data-field y obtener el valor desde el elemento padre
        const button = document.querySelector(`[data-field="${field}"]`);
        let value = '-';
        
        if (button) {
            const infoRow = button.closest('.info-row-with-check');
            if (infoRow) {
                const valueElement = infoRow.querySelector('.info-value');
                if (valueElement) {
                    value = valueElement.textContent.trim();
                }
            }
        }
        
        return {
            label: info.label,
            value: value,
            comentario: '' // Se cargará desde la base de datos
        };
    }
    
    // Función para calificar campo
    function calificarCampo(field, estado) {
        console.log(`🔄 Calificando campo: "${field}" como "${estado}"`);
        
        const solicitudId = parseInt('{{ solicitud.id }}');
        console.log(`📋 Solicitud ID: ${solicitudId}`);
        
        const token = getCsrfToken();
        console.log(`🔐 Token CSRF: ${token ? 'Obtenido' : 'No encontrado'}`);
        
        if (!token) {
            console.error('❌ No se pudo obtener el token CSRF');
            mostrarToast('Error: No se pudo obtener el token de seguridad', 'error');
            return;
        }
        
        const url = `/workflow/api/solicitudes/${solicitudId}/calificar-campo/`;
        console.log(`🌐 URL: ${url}`);
        
        const payload = {
            campo: field,
            estado: estado
        };
        console.log(`📦 Datos a enviar:`, payload);
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': token
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            console.log(`📡 Respuesta HTTP: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log(`📊 Respuesta del servidor:`, data);
            
            if (data.success) {
                mostrarToast(`Campo "${field}" calificado como ${estado}`, 'success');
                actualizarEstadoBoton(field, estado);
            } else {
                console.error('❌ Error del servidor:', data.error);
                mostrarToast('Error al calificar campo: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Error de red:', error);
            mostrarToast('Error de red al calificar campo', 'error');
        });
    }
    
    // Función para guardar comentario de compliance
    function guardarComentarioCompliance(field, comentario) {
        const solicitudId = parseInt('{{ solicitud.id }}');
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/comentario-compliance/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                campo: field,
                comentario: comentario
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Comentario guardado exitosamente', 'success');
                marcarComentarioEnBoton(field, true);
                // Auto-refresh bullet points after saving comentario
                if (typeof actualizarBulletsPreview === 'function') {
                    actualizarBulletsPreview();
                }
            } else {
                mostrarToast('Error al guardar comentario: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarToast('Error de red al guardar comentario', 'error');
        });
    }
    
    // Función para actualizar estado visual del botón
    function actualizarEstadoBoton(field, estado) {
        const buttons = document.querySelectorAll(`[data-field="${field}"]`);
        
        buttons.forEach(button => {
            if (button.dataset.action === 'bueno' || button.dataset.action === 'malo') {
                button.classList.remove('active');
            }
        });
        
        const activeButton = document.querySelector(`[data-field="${field}"][data-action="${estado}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }
    
    // Función para marcar comentario en botón
    function marcarComentarioEnBoton(field, hasComment) {
        const commentButton = document.querySelector(`[data-field="${field}"][data-action="comentario"]`);
        if (commentButton) {
            if (hasComment) {
                commentButton.classList.add('has-comment');
            } else {
                commentButton.classList.remove('has-comment');
            }
        }
    }
    
    // Función para cargar estados existentes
    function cargarEstadosCompliance() {
        console.log('📋 Cargando estados de compliance...');
        const solicitudId = parseInt('{{ solicitud.id }}');
        
        const url = `/workflow/api/solicitudes/${solicitudId}/calificaciones/`;
        console.log(`🌐 URL calificaciones: ${url}`);
        
        fetch(url)
            .then(response => {
                console.log(`📡 Respuesta HTTP: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('📊 Calificaciones recibidas:', data);
                
                if (data.success) {
                    console.log(`✅ ${data.calificaciones.length} calificaciones encontradas`);
                    data.calificaciones.forEach(calificacion => {
                        console.log(`🔄 Actualizando estado: ${calificacion.campo} = ${calificacion.estado}`);
                        actualizarEstadoBoton(calificacion.campo, calificacion.estado);
                        if (calificacion.comentario) {
                            console.log(`💬 Marcando comentario para: ${calificacion.campo}`);
                            marcarComentarioEnBoton(calificacion.campo, true);
                        }
                    });
                } else {
                    console.error('❌ Error al obtener calificaciones:', data.error);
                }
            })
            .catch(error => {
                console.error('❌ Error cargando calificaciones:', error);
            });
    }
    
    // Función para inicializar modal de comentarios
    function inicializarModalComentario() {
        const comentarioTextarea = document.getElementById('comentario-compliance');
        const charCount = document.getElementById('char-count-compliance');
        
        if (comentarioTextarea && charCount) {
            comentarioTextarea.addEventListener('input', function() {
                charCount.textContent = this.value.length;
                
                if (this.value.length > 500) {
                    charCount.parentElement.classList.add('text-danger');
                } else {
                    charCount.parentElement.classList.remove('text-danger');
                }
            });
        }
    }
    
    // Inicializar nuevas funcionalidades
    inicializarComplianceButtons();
    inicializarValidacionDocumentos();
    cargarSolicitudesRelacionadas();
    
    // Restaurar estados de secciones
    restoreSectionStates();
    
    // Cargar bullet points iniciales
    if (typeof actualizarBulletsPreview === 'function') {
        actualizarBulletsPreview();
    }
    
    // Asegurar que el DOM esté completamente cargado antes de inicializar comentarios
    function inicializarCuandoEsteListo() {
        setTimeout(() => {
            try {
                if (typeof inicializarComentariosAnalistaCredito === 'function') {
                    inicializarComentariosAnalistaCredito();
                } else {
                    console.warn('⚠️ inicializarComentariosAnalistaCredito no está definida aún');
                    // Reintentar después
                    setTimeout(inicializarCuandoEsteListo, 500);
                }
            } catch (error) {
                console.error('❌ Error al inicializar comentarios:', error);
                // Reintentar después
                setTimeout(inicializarCuandoEsteListo, 1000);
            }
        }, 200);
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarCuandoEsteListo);
    } else {
        inicializarCuandoEsteListo();
    }
    

    
    // Función para calificar campo sin mostrar toast (versión interna)
    function calificarCampoSinToast(field, estado) {
        return new Promise((resolve, reject) => {
            console.log(`🔄 Calificando campo: "${field}" como "${estado}" (sin toast)`);
            
            const solicitudId = parseInt('{{ solicitud.id }}');
            const token = getCsrfToken();
            
            if (!token) {
                console.error('❌ No se pudo obtener el token CSRF');
                reject(new Error('No se pudo obtener el token de seguridad'));
                return;
            }
            
            const url = `/workflow/api/solicitudes/${solicitudId}/calificar-campo/`;
            const payload = {
                campo: field,
                estado: estado
            };
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': token
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actualizarEstadoBoton(field, estado);
                    // Auto-refresh bullet points after field qualification
                    if (typeof actualizarBulletsPreview === 'function') {
                        actualizarBulletsPreview();
                    }
                    resolve(data);
                } else {
                    console.error('❌ Error del servidor:', data.error);
                    reject(new Error(data.error));
                }
            })
            .catch(error => {
                console.error('❌ Error de red:', error);
                reject(error);
            });
        });
    }
    


    // Función de prueba para verificar el funcionamiento
    window.testCompliance = function() {
        console.log('🧪 Probando sistema de compliance...');
        mostrarToast('Sistema de compliance activo', 'success');
        
        // Probar calificación de campo
        setTimeout(() => {
            console.log('🎯 Probando calificación de campo...');
            calificarCampo('nombre', 'bueno');
        }, 2000);
    };
    
    console.log('✅ Sistema completo inicializado correctamente');
    console.log('💡 Consejo: Puedes probar el sistema con window.testCompliance()');
    
    // Mostrar notificación de que el sistema está listo
    setTimeout(() => {
        mostrarToast('Sistema de análisis inicializado correctamente', 'success');
    }, 1000);
});

// ==========================================
// FUNCIONALIDADES ADICIONALES
// ==========================================





// Función para inicializar validación de documentos
function inicializarValidacionDocumentos() {
    const validationButtons = document.querySelectorAll('.validation-btn');
    
    validationButtons.forEach(button => {
        button.addEventListener('click', function() {
            const doc = this.dataset.doc;
            const status = this.dataset.status;
            const docItem = this.closest('.documento-item');
            
            // Remover clase active de otros botones del mismo documento
            const otherButtons = docItem.querySelectorAll('.validation-btn');
            otherButtons.forEach(btn => btn.classList.remove('active'));
            
            // Agregar clase active al botón clickeado
            this.classList.add('active');
            
            // Guardar estado en localStorage
            localStorage.setItem(`doc_validation_${doc}`, status);
            
            // Mostrar notificación
            const statusText = status === 'valid' ? 'válido' : 'inválido';
            mostrarToast(`Documento "${doc}" marcado como ${statusText}`, status === 'valid' ? 'success' : 'error');
        });
        
        // Restaurar estado desde localStorage
        const doc = button.dataset.doc;
        const status = button.dataset.status;
        const saved = localStorage.getItem(`doc_validation_${doc}`);
        if (saved === status) {
            button.classList.add('active');
        }
    });
}

// Función para cargar solicitudes relacionadas
function cargarSolicitudesRelacionadas() {
    const cedula = '{{ solicitud.cliente_cedula|default:"123193" }}';
    
    // Simular carga de solicitudes relacionadas
    console.log(`🔍 Buscando solicitudes relacionadas para cédula: ${cedula}`);
    
    // En un escenario real, aquí haríamos una llamada AJAX al backend
    // fetch(`/workflow/api/solicitudes/relacionadas/?cedula=${cedula}`)
    //     .then(response => response.json())
    //     .then(data => {
    //         mostrarSolicitudesRelacionadas(data.solicitudes);
    //     });
    
    // Por ahora, las solicitudes están hardcodeadas en el HTML
    mostrarToast(`Solicitudes relacionadas cargadas para cédula ${cedula}`, 'info');
}

// Función para mostrar notificaciones toast mejoradas
function mostrarToast(mensaje, tipo = 'info') {
    const toastContainer = document.querySelector('.toast-container') || crearToastContainer();
    
    const iconos = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-triangle',
        info: 'fa-info-circle',
        warning: 'fa-exclamation-triangle'
    };
    
    const colores = {
        success: 'success',
        error: 'danger',
        info: 'info',
        warning: 'warning'
    };
    
    const toastHTML = `
        <div class="toast align-items-center text-bg-${colores[tipo]} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" style="border-radius: 12px;">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${iconos[tipo]} me-2"></i>
                    ${mensaje}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    // Mostrar toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: tipo === 'error' ? 5000 : 3000
    });
    toast.show();
    
    // Remover elemento después de que se oculte
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
        // Verificar si el contenedor está vacío y eliminarlo si no hay más toasts
        const container = document.querySelector('.toast-container');
        if (container && container.children.length === 0) {
            container.remove();
        }
    });
}

// Función para crear contenedor de toast si no existe
function crearToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '99999';
    document.body.appendChild(container);
    return container;
}

// ==========================================
// FUNCIONALIDADES COMENTARIOS ANALISTA CRÉDITO
// ==========================================

function inicializarComentariosAnalistaCredito() {
    console.log('🏥 Inicializando comentarios de analista de crédito...');
    
    try {
        // Verificar que todos los elementos necesarios existan
        const container = document.getElementById('lista-comentarios-analista-credito');
        const sinComentarios = document.getElementById('sin-comentarios-analista');
        const textarea = document.getElementById('comentario-analista-credito-text');
        const charCounter = document.getElementById('char-count-analista-credito');
        const formElement = document.getElementById('form-comentario-analista-credito');
        
        console.log('🔍 Verificando elementos del DOM:');
        console.log('- Container:', container ? '✅' : '❌');
        console.log('- Sin comentarios:', sinComentarios ? '✅' : '❌');
        console.log('- Textarea:', textarea ? '✅' : '❌');
        console.log('- Char counter:', charCounter ? '✅' : '❌');
        console.log('- Form:', formElement ? '✅' : '❌');
        
        // Verificar elementos críticos
        if (!container || !textarea || !formElement) {
            console.error('❌ Error: Elementos críticos no encontrados. Reintentando en 500ms...');
            setTimeout(() => {
                inicializarComentariosAnalistaCredito();
            }, 500);
            return;
        }
    
        if (!container) {
        console.error('❌ Error crítico: No se encontró el contenedor de comentarios');
        return;
    }
    
    // Configurar contador de caracteres
    if (textarea && charCounter) {
        textarea.addEventListener('input', function() {
            charCounter.textContent = this.value.length;
            
            if (this.value.length > 1800) {
                charCounter.parentElement.classList.add('text-danger');
            } else if (this.value.length > 1500) {
                charCounter.parentElement.classList.add('text-warning');
                charCounter.parentElement.classList.remove('text-danger');
            } else {
                charCounter.parentElement.classList.remove('text-warning', 'text-danger');
            }
        });
    }
    
    // Cargar bullets preview inicial (con manejo de errores)
    try {
        if (typeof actualizarBulletsPreview === 'function') {
            actualizarBulletsPreview();
        } else {
            console.warn('⚠️ actualizarBulletsPreview no está definida aún, se cargará más tarde');
        }
    } catch (error) {
        console.warn('⚠️ Error al cargar bullets preview inicial:', error);
    }
    
    // Configurar botón cancelar
    const btnCancelar = document.getElementById('btn-cancelar-analista-credito');
    if (btnCancelar) {
        btnCancelar.addEventListener('click', function() {
            if (textarea) {
                textarea.value = '';
                charCounter.textContent = '0';
                charCounter.parentElement.classList.remove('text-warning', 'text-danger');
            }
        });
    }
    
    // Configurar formulario
    const form = document.getElementById('form-comentario-analista-credito');
    if (form) {
        form.addEventListener('submit', enviarComentarioAnalistaCredito);
    }
    
    // Cargar comentarios existentes
    cargarComentariosAnalistaCredito();
    
    console.log('✅ Comentarios de analista de crédito inicializados');
    
    } catch (error) {
        console.error('❌ Error al inicializar comentarios de analista de crédito:', error);
        if (typeof mostrarToast === 'function') {
            mostrarToast('Error al inicializar comentarios de analista', 'error');
        } else {
            console.error('❌ Error al inicializar comentarios de analista:', error.message);
        }
    }
}

function cargarComentariosAnalistaCredito() {
    console.log('📋 Cargando comentarios de analista de crédito...');
    
    try {
        const solicitudId = parseInt('{{ solicitud.id }}');
        
        if (!solicitudId || isNaN(solicitudId)) {
            console.error('❌ Error: solicitudId inválido:', solicitudId);
            return;
        }
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios-analista-credito/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📊 Comentarios recibidos:', data);
                
                if (data.success) {
                    mostrarComentariosAnalistaCredito(data.comentarios);
                } else {
                    console.error('❌ Error al cargar comentarios:', data.error);
                    if (typeof mostrarToast === 'function') {
                        mostrarToast('Error al cargar comentarios: ' + data.error, 'error');
                    }
                }
            })
            .catch(error => {
                console.error('❌ Error de red:', error);
                if (typeof mostrarToast === 'function') {
                    mostrarToast('Error de red al cargar comentarios', 'error');
                }
            });
    } catch (error) {
        console.error('❌ Error en cargarComentariosAnalistaCredito:', error);
    }
}

async function enviarComentarioAnalistaCredito(event) {
    event.preventDefault();
    
    const textarea = document.getElementById('comentario-analista-credito-text');
    const btnEnviar = document.getElementById('btn-enviar-analista-credito');
    const spinner = btnEnviar.querySelector('.loading-spinner-analista');
    const iconoBoton = btnEnviar.querySelector('i:not(.loading-spinner-analista i)');
    
    // Deshabilitar botón y mostrar spinner
    btnEnviar.disabled = true;
    if (spinner && iconoBoton) {
        spinner.style.display = 'inline-block';
        iconoBoton.style.display = 'none';
    }
    
    try {
        // Generar comentario completo con bullet points
        const comentarioCompleto = await generarComentarioCompleto();
        
        if (!comentarioCompleto) {
            return; // La función ya muestra el error
        }
    
        console.log('💾 Enviando comentario de analista de crédito:', comentarioCompleto);
        
        const solicitudId = parseInt('{{ solicitud.id }}');
        const token = getCsrfToken();
        
        const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/comentario-analista-credito/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': token
            },
            body: JSON.stringify({
                comentario: comentarioCompleto
            })
        });
        
        const data = await response.json();
        console.log('📋 Respuesta del servidor:', data);
        
        if (data.success) {
            mostrarToast('Análisis de analista guardado exitosamente', 'success');
            textarea.value = '';
            document.getElementById('char-count-analista-credito').textContent = '0';
            cargarComentariosAnalistaCredito();
            
            // Ocultar preview después de guardar
            const previewContainer = document.getElementById('analisis-preview');
            if (previewContainer) {
                previewContainer.style.display = 'none';
            }
        } else {
            mostrarToast('Error al guardar análisis: ' + (data.error || 'Error desconocido'), 'error');
        }
        
    } catch (error) {
        console.error('❌ Error:', error);
        mostrarToast('Error de red al enviar análisis', 'error');
    } finally {
        // Rehabilitar botón y ocultar spinner
        btnEnviar.disabled = false;
        if (spinner && iconoBoton) {
            spinner.style.display = 'none';
            iconoBoton.style.display = 'inline-block';
        }
    }
}

function mostrarComentariosAnalistaCredito(comentarios) {
    try {
        console.log('📋 Mostrando comentarios de analista de crédito...', comentarios);
        
        const container = document.getElementById('lista-comentarios-analista-credito');
        const sinComentarios = document.getElementById('sin-comentarios-analista');
        
        // Verificar que el container existe
        if (!container) {
            console.error('❌ Error: No se encontró el elemento lista-comentarios-analista-credito');
            // Intentar recargar después de un momento
            setTimeout(() => {
                const containerRetry = document.getElementById('lista-comentarios-analista-credito');
                if (containerRetry) {
                    mostrarComentariosAnalistaCredito(comentarios);
                } else {
                    console.error('❌ Error: Elemento aún no existe después del reintento');
                }
            }, 500);
            return;
        }
        
        // Verificar que comentarios es un array
        if (!Array.isArray(comentarios)) {
            console.error('❌ Error: comentarios no es un array:', comentarios);
            return;
        }
        
        if (comentarios.length === 0) {
            if (sinComentarios) {
                sinComentarios.style.display = 'block';
            }
            container.innerHTML = '';
            return;
        }
        
        if (sinComentarios) {
            sinComentarios.style.display = 'none';
        }
        
        const comentariosHTML = comentarios.map((comentario, index) => {
            const numeroComentario = index + 1;
            const fechaFormateada = new Date(comentario.fecha_creacion).toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            return `
                <div class="comentario-analista-item">
                    <div class="comentario-analista-header">
                        <div class="comentario-analista-author">
                            <div class="comentario-analista-avatar">
                                <i class="fas fa-user-md"></i>
                            </div>
                            <div class="comentario-analista-info">
                                <strong>${comentario.usuario_nombre || 'Usuario'}</strong>
                                <small>${fechaFormateada}</small>
                            </div>
                        </div>
                        <div class="comentario-analista-numero">
                            Comentario ${numeroComentario}
                        </div>
                    </div>
                    <div class="comentario-analista-text">
                        ${(comentario.comentario || '').replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = comentariosHTML;
        
        // Animar entrada de comentarios
        const items = container.querySelectorAll('.comentario-analista-item');
        items.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateY(20px)';
            setTimeout(() => {
                item.style.transition = 'all 0.3s ease';
                item.style.opacity = '1';
                item.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        console.log('✅ Comentarios mostrados correctamente');
        
    } catch (error) {
        console.error('❌ Error al mostrar comentarios de analista de crédito:', error);
        mostrarToast('Error al mostrar comentarios', 'error');
    }
}
</script>

{% include 'workflow/partials/analisis_styles.html' %}

{% endblock %} 