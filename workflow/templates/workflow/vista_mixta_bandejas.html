{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}Vista Mixta - Sistema de Workflow{% endblock %}

{% block content %}
<div class="mt-0 pt-0">
    <!-- Header Estático - Sin Animaciones -->
    <div class="card mb-1" style="border: 1px solid #e0e0e0;">
        <div class="card-header" style="background: var(--verde-pacifico); padding: 12px 20px; border-radius: 0; border: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-white fw-bold">
                        <i class="fas fa-clipboard-list me-2"></i>
                        <span id="titulo-bandeja">
                            {% if etapa_seleccionada %}
                                {{ etapa_seleccionada.pipeline.nombre }} - {{ etapa_seleccionada.nombre }}
                            {% else %}
                                Vista Mixta
                            {% endif %}
                        </span>
                    </h1>
                    {% if etapa_seleccionada %}
                        <div class="mt-1">
                            <small class="text-white-50">
                                <i class="fas fa-users me-1"></i>
                                Bandeja grupal y tareas personales
                            </small>
                        </div>
                    {% else %}
                        <div class="mt-1">
                            <small class="text-white-50">
                                <i class="fas fa-info-circle me-1"></i>
                                Todas las etapas con bandeja grupal
                            </small>
                        </div>
                    {% endif %}
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Selector de Etapas con Bandeja -->
                    <div class="dropdown position-static">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownEtapas" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-list me-1"></i>
                            Etapas con Bandeja
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownEtapas" style="z-index: 99999;">
                            {% if etapa_seleccionada %}
                            <li>
                                <a class="dropdown-item" href="{% url 'workflow:vista_mixta_bandejas' %}">
                                    <i class="fas fa-list me-2"></i>
                                    Ver todas las etapas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            {% endif %}
                            {% for etapa in etapas_con_bandeja %}
                            <li>
                                <a class="dropdown-item" href="?etapa_id={{ etapa.id }}">
                                    <i class="fas fa-layer-group me-2"></i>
                                    {{ etapa.pipeline.nombre }} - {{ etapa.nombre }}
                                </a>
                            </li>
                            {% empty %}
                            <li><span class="dropdown-item-text text-muted">No hay etapas con bandeja habilitada</span></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Filtros Estáticos -->
    <div class="card mb-2" style="border: 1px solid #e0e0e0;">
        <div class="card-body py-2">
            <div class="row g-1 align-items-center">
                <div class="col-6 col-md-3">
                    <select id="filtroEstado" class="form-select form-select-sm">
                        <option value="">Todos los estados</option>
                        {% for estado in estados_unicos %}
                        <option value="{{ estado }}">{{ estado }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-6 col-md-3">
                    <select id="filtroSLA" class="form-select form-select-sm">
                        <option value="">Todos los SLA</option>
                        <option value="en_tiempo">En tiempo</option>
                        <option value="por_vencer">Por vencer</option>
                        <option value="vencido">Vencido</option>
                    </select>
                </div>
                <div class="col-12 col-md-5">
                    <input type="text" id="busquedaGlobal" class="form-control form-control-sm" 
                           placeholder="Buscar por código, cliente, cédula...">
                </div>
                <div class="col-12 col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-info w-100" id="limpiarFiltros">
                        <i class="fas fa-filter-circle-xmark"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leyenda SLA Compacta -->
    <small class="text-muted mb-2 d-block" style="font-size: 0.7rem;">
        <i class="fas fa-info-circle me-1"></i>Leyenda SLA:
        <i class="fas fa-circle text-success me-1 ms-2" style="font-size: 0.5rem;"></i>En tiempo
        <i class="fas fa-circle text-warning me-1 ms-2" style="font-size: 0.5rem;"></i>Por vencer
        <i class="fas fa-circle text-danger me-1 ms-2" style="font-size: 0.5rem;"></i>Vencido
    </small>

    <!-- Vista de Supervisor/Superuser - Tabla Completa de Solicitudes -->
    {% if user.is_superuser or user.is_staff %}
    <div class="card mb-3" style="border: 1px solid #e0e0e0;">
        <div class="card-header" style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white;">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Vista de Supervisor - Gestión Completa de Solicitudes
                </h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-light btn-sm" id="toggle-supervisor-view">
                        <i class="fas fa-eye me-1"></i>Mostrar/Ocultar Vista Completa
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="export-supervisor-data">
                        <i class="fas fa-download me-1"></i>Exportar Datos
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0" id="supervisor-view-content" style="display: none;">
            <div class="table-responsive" style="max-height: 800px; overflow-y: auto;">
                <table class="table table-hover mb-0" id="supervisor-table">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th style="min-width: 120px;">
                                <i class="fas fa-hashtag me-1"></i>Código
                            </th>
                            <th style="min-width: 150px;">
                                <i class="fas fa-user me-1"></i>Cliente
                            </th>
                            <th style="min-width: 100px;">
                                <i class="fas fa-id-card me-1"></i>Cédula
                            </th>
                            <th style="min-width: 120px;">
                                <i class="fas fa-layer-group me-1"></i>Pipeline
                            </th>
                            <th style="min-width: 120px;">
                                <i class="fas fa-tasks me-1"></i>Etapa
                            </th>
                            <th style="min-width: 100px;">
                                <i class="fas fa-user-check me-1"></i>Asignado a
                            </th>
                            <th style="min-width: 100px;">
                                <i class="fas fa-clock me-1"></i>SLA
                            </th>
                            <th style="min-width: 120px;">
                                <i class="fas fa-calendar me-1"></i>Fecha Creación
                            </th>
                            <th style="min-width: 120px;">
                                <i class="fas fa-calendar-check me-1"></i>Última Actualización
                            </th>
                            <th style="min-width: 100px;">
                                <i class="fas fa-user-plus me-1"></i>Creado por
                            </th>
                            <th style="min-width: 100px;">
                                <i class="fas fa-dollar-sign me-1"></i>Monto
                            </th>
                            <th style="min-width: 120px;">
                                <i class="fas fa-cogs me-1"></i>Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody id="supervisor-table-body">
                        {% for solicitud in solicitudes_grupales %}
                        <tr class="supervisor-row" 
                            data-solicitud-id="{{ solicitud.id }}"
                            data-tipo="grupal"
                            data-cliente="{{ solicitud.cliente_nombre }}"
                            data-estado="{{ solicitud.estado_actual }}"
                            data-etapa="{{ solicitud.etapa_actual.nombre }}"
                            data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                            data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre|lower }} {{ solicitud.cliente_cedula|lower }}">
                            <td>
                                <a href="{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}" class="text-decoration-none">
                                    <strong class="text-primary">{{ solicitud.codigo }}</strong>
                                </a>
                                <br><small class="text-muted">Bandeja Grupal</small>
                            </td>
                            <td>
                                <strong>{{ solicitud.cliente_nombre|default:"Sin cliente" }}</strong>
                            </td>
                            <td>
                                <code>{{ solicitud.cliente_cedula|default:"-" }}</code>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ solicitud.pipeline.nombre }}</span>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ solicitud.etapa_actual.nombre|default:"Sin etapa" }}</span>
                            </td>
                            <td>
                                <span class="badge bg-warning text-dark">Sin asignar</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-circle {{ solicitud.sla_color }}" style="font-size: 0.8rem;"></i>
                                    <span class="{{ solicitud.sla_color }} ms-1">{{ solicitud.sla_restante }}</span>
                                </div>
                            </td>
                            <td>
                                <small>{{ solicitud.fecha_creacion|date:"d/m/Y H:i" }}</small>
                            </td>
                            <td>
                                <small>{{ solicitud.fecha_ultima_actualizacion|date:"d/m/Y H:i" }}</small>
                            </td>
                            <td>
                                <small>{{ solicitud.creada_por.get_full_name|default:solicitud.creada_por.username }}</small>
                            </td>
                            <td>
                                <strong class="text-success">{{ solicitud.monto_formateado|default:"-" }}</strong>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-success btn-sm tomar-solicitud" 
                                            data-solicitud-id="{{ solicitud.id }}"
                                            data-codigo="{{ solicitud.codigo }}">
                                        <i class="fas fa-hand-paper"></i>
                                    </button>
                                    <button class="btn btn-primary btn-sm asignar-solicitud" 
                                            data-solicitud-id="{{ solicitud.id }}"
                                            data-codigo="{{ solicitud.codigo }}"
                                            data-etapa-id="{{ solicitud.etapa_actual.id }}">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                    <button class="btn btn-info btn-sm ver-detalle" 
                                            data-solicitud-id="{{ solicitud.id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% for solicitud in solicitudes_personales %}
                        <tr class="supervisor-row" 
                            data-solicitud-id="{{ solicitud.id }}"
                            data-tipo="personal"
                            data-cliente="{{ solicitud.cliente_nombre }}"
                            data-estado="{{ solicitud.estado_actual }}"
                            data-etapa="{{ solicitud.etapa_actual.nombre }}"
                            data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                            data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre|lower }} {{ solicitud.cliente_cedula|lower }}">
                            <td>
                                <a href="{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}" class="text-decoration-none">
                                    <strong class="text-primary">{{ solicitud.codigo }}</strong>
                                </a>
                                <br><small class="text-muted">Asignada</small>
                            </td>
                            <td>
                                <strong>{{ solicitud.cliente_nombre|default:"Sin cliente" }}</strong>
                            </td>
                            <td>
                                <code>{{ solicitud.cliente_cedula|default:"-" }}</code>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ solicitud.pipeline.nombre }}</span>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ solicitud.etapa_actual.nombre|default:"Sin etapa" }}</span>
                            </td>
                            <td>
                                <span class="badge bg-success">{{ solicitud.asignada_a.get_full_name|default:solicitud.asignada_a.username }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-circle {{ solicitud.sla_color }}" style="font-size: 0.8rem;"></i>
                                    <span class="{{ solicitud.sla_color }} ms-1">{{ solicitud.sla_restante }}</span>
                                </div>
                            </td>
                            <td>
                                <small>{{ solicitud.fecha_creacion|date:"d/m/Y H:i" }}</small>
                            </td>
                            <td>
                                <small>{{ solicitud.fecha_ultima_actualizacion|date:"d/m/Y H:i" }}</small>
                            </td>
                            <td>
                                <small>{{ solicitud.creada_por.get_full_name|default:solicitud.creada_por.username }}</small>
                            </td>
                            <td>
                                <strong class="text-success">{{ solicitud.monto_formateado|default:"-" }}</strong>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if solicitud.asignada_a == user %}
                                    <button class="btn btn-warning btn-sm devolver-solicitud" 
                                            data-solicitud-id="{{ solicitud.id }}"
                                            data-codigo="{{ solicitud.codigo }}">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-info btn-sm ver-detalle" 
                                            data-solicitud-id="{{ solicitud.id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Estadísticas de la Vista de Supervisor -->
            <div class="card-footer bg-light">
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-clipboard-list text-info me-2"></i>
                            <div>
                                <strong class="d-block" id="supervisor-total-count">{{ solicitudes_grupales|length|add:solicitudes_personales|length }}</strong>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-users text-primary me-2"></i>
                            <div>
                                <strong class="d-block">{{ solicitudes_grupales|length }}</strong>
                                <small class="text-muted">Bandeja Grupal</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-user-check text-success me-2"></i>
                            <div>
                                <strong class="d-block">{{ solicitudes_personales|length }}</strong>
                                <small class="text-muted">Asignadas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <div>
                                <strong class="d-block">{{ por_vencer }}</strong>
                                <small class="text-muted">Por Vencer</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <div>
                                <strong class="d-block" id="supervisor-vencidas-count">0</strong>
                                <small class="text-muted">Vencidas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <div>
                                <strong class="d-block">{{ en_tiempo }}</strong>
                                <small class="text-muted">En Tiempo</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Contenedor de Bandejas -->
    <div id="contenedor-bandejas">
        <!-- Vista Mixta (Default) -->
        <div id="vista-mixta" class="vista-bandeja">
            <div class="row">
                <!-- Bandeja Grupal -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header" style="background: var(--verde-pacifico); color: #fff;">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>
                                {% if etapa_seleccionada %}
                                    Bandeja Grupal - {{ etapa_seleccionada.nombre }}
                                {% else %}
                                    Bandeja Grupal
                                {% endif %}
                                <span class="badge bg-light text-dark ms-2">{{ solicitudes_grupales|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Código</th>
                                            <th>Cliente</th>
                                            <th>Etapa</th>
                                            <th>SLA</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-grupal">
                                        {% for solicitud in solicitudes_grupales %}
                                        <tr id="solicitud-grupal-{{ solicitud.id }}" 
                                            class="solicitud-row"
                                            data-cliente="{{ solicitud.cliente_nombre }}"
                                            data-estado="{{ solicitud.estado_actual }}"
                                            data-etapa="{{ solicitud.etapa_actual.nombre }}"
                                            data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                                            data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre|lower }} {{ solicitud.cliente_cedula|lower }}">
                                            <td>
                                                <a href="{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}" class="text-decoration-none">
                                                    <strong class="text-primary">{{ solicitud.codigo }}</strong>
                                                </a>
                                                <br><small class="text-muted">{{ solicitud.fecha_inicio|date:"d/m/Y" }}</small>
                                            </td>
                                            <td>
                                                {{ solicitud.cliente_nombre }}
                                                <br><small class="text-muted">{{ solicitud.cliente_cedula }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ solicitud.etapa_actual.nombre }}</span>
                                            </td>
                                            <td>
                                                <i class="fas fa-circle {{ solicitud.sla_color }}" style="font-size: 0.8rem;"></i>
                                                <span class="{{ solicitud.sla_color }}">{{ solicitud.sla_restante }}</span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-success btn-sm tomar-solicitud" 
                                                            data-solicitud-id="{{ solicitud.id }}"
                                                            data-codigo="{{ solicitud.codigo }}">
                                                        <i class="fas fa-hand-paper me-1"></i><span class="btn-action-text">Tomar</span>
                                                    </button>
                                                                                                {% if user.is_superuser or user.is_staff %}
                                            <button class="btn btn-primary btn-sm asignar-solicitud" 
                                                    data-solicitud-id="{{ solicitud.id }}"
                                                    data-codigo="{{ solicitud.codigo }}"
                                                    data-etapa-id="{{ solicitud.etapa_actual.id }}">
                                                <i class="fas fa-user-plus me-1"></i><span class="btn-action-text">Asignar</span>
                                            </button>
                                            {% endif %}
                                                    <button class="btn btn-info btn-sm ver-detalle" 
                                                            data-solicitud-id="{{ solicitud.id }}">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                                <br>No hay solicitudes en bandeja grupal
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bandeja Personal -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header" style="background: var(--verde-pacifico); color: #fff;">
                            <h5 class="mb-0">
                                <i class="fas fa-user me-2"></i>
                                Mis Tareas
                                {% if etapa_seleccionada %}
                                    <small class="text-white-50 ms-2">({{ etapa_seleccionada.nombre }})</small>
                                {% endif %}
                                <span class="badge bg-light text-dark ms-2">{{ solicitudes_personales|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Código</th>
                                            <th>Cliente</th>
                                            <th>Etapa</th>
                                            <th>SLA</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-personal">
                                        {% for solicitud in solicitudes_personales %}
                                        <tr id="solicitud-personal-{{ solicitud.id }}" 
                                            class="solicitud-row"
                                            data-cliente="{{ solicitud.cliente_nombre }}"
                                            data-estado="{{ solicitud.estado_actual }}"
                                            data-etapa="{{ solicitud.etapa_actual.nombre }}"
                                            data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                                            data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre|lower }} {{ solicitud.cliente_cedula|lower }}">
                                            <td>
                                                <a href="{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}" class="text-decoration-none">
                                                    <strong class="text-primary">{{ solicitud.codigo }}</strong>
                                                </a>
                                                <br><small class="text-muted">{{ solicitud.fecha_inicio|date:"d/m/Y" }}</small>
                                            </td>
                                            <td>
                                                {{ solicitud.cliente_nombre }}
                                                <br><small class="text-muted">{{ solicitud.cliente_cedula }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ solicitud.etapa_actual.nombre }}</span>
                                            </td>
                                            <td>
                                                <i class="fas fa-circle {{ solicitud.sla_color }}" style="font-size: 0.8rem;"></i>
                                                <span class="{{ solicitud.sla_color }}">{{ solicitud.sla_restante }}</span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-warning btn-sm devolver-solicitud" 
                                                            data-solicitud-id="{{ solicitud.id }}"
                                                            data-codigo="{{ solicitud.codigo }}">
                                                        <i class="fas fa-undo me-1"></i> Devolver
                                                    </button>
                                                    <button class="btn btn-info btn-sm ver-solicitud" 
                                                            data-solicitud-id="{{ solicitud.id }}">
                                                        <i class="fas fa-eye me-1"></i> Ver
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                                <br>No tienes tareas asignadas
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Solo Bandeja Grupal -->
        <div id="vista-grupal" class="vista-bandeja" style="display: none;">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Bandeja Grupal
                        <span class="badge bg-light text-dark ms-2">{{ solicitudes_grupales|length }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Código</th>
                                    <th>Cliente</th>
                                    <th>Cédula</th>
                                    <th>Etapa</th>
                                    <th>Estado</th>
                                    <th>SLA</th>
                                    <th>Fecha Inicio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-grupal-expandida">
                                {% for solicitud in solicitudes_grupales %}
                                <tr class="solicitud-row"
                                    data-cliente="{{ solicitud.cliente_nombre }}"
                                    data-estado="{{ solicitud.estado_actual }}"
                                    data-etapa="{{ solicitud.etapa_actual.nombre }}"
                                    data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                                    data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre|lower }} {{ solicitud.cliente_cedula|lower }}">
                                    <td>
                                        <a href="{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}" class="text-decoration-none">
                                            <strong class="text-primary">{{ solicitud.codigo }}</strong>
                                        </a>
                                    </td>
                                    <td>{{ solicitud.cliente_nombre }}</td>
                                    <td>{{ solicitud.cliente_cedula }}</td>
                                    <td><span class="badge bg-info">{{ solicitud.etapa_actual.nombre }}</span></td>
                                    <td><span class="badge bg-secondary">{{ solicitud.estado_actual }}</span></td>
                                    <td>
                                        <i class="fas fa-circle {{ solicitud.sla_color }}" style="font-size: 0.8rem;"></i>
                                        <span class="{{ solicitud.sla_color }}">{{ solicitud.sla_restante }}</span>
                                    </td>
                                    <td>{{ solicitud.fecha_inicio|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-success btn-sm tomar-solicitud" 
                                                    data-solicitud-id="{{ solicitud.id }}"
                                                    data-codigo="{{ solicitud.codigo }}">
                                                <i class="fas fa-hand-paper me-1"></i><span class="btn-action-text">Tomar</span>
                                            </button>
                                            {% if user.is_superuser or user.is_staff %}
                                            <button class="btn btn-primary btn-sm asignar-solicitud" 
                                                    data-solicitud-id="{{ solicitud.id }}"
                                                    data-codigo="{{ solicitud.codigo }}"
                                                    data-etapa-id="{{ solicitud.etapa_actual.id }}">
                                                <i class="fas fa-user-plus me-1"></i><span class="btn-action-text">Asignar</span>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-info btn-sm ver-detalle" 
                                                    data-solicitud-id="{{ solicitud.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <br>No hay solicitudes en bandeja grupal
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Solo Bandeja Personal -->
        <div id="vista-personal" class="vista-bandeja" style="display: none;">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>
                        Mis Tareas
                        <span class="badge bg-light text-dark ms-2">{{ solicitudes_personales|length }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Código</th>
                                    <th>Cliente</th>
                                    <th>Cédula</th>
                                    <th>Etapa</th>
                                    <th>Estado</th>
                                    <th>SLA</th>
                                    <th>Fecha Inicio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-personal-expandida">
                                {% for solicitud in solicitudes_personales %}
                                <tr class="solicitud-row"
                                    data-cliente="{{ solicitud.cliente_nombre }}"
                                    data-estado="{{ solicitud.estado_actual }}"
                                    data-etapa="{{ solicitud.etapa_actual.nombre }}"
                                    data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                                    data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre|lower }} {{ solicitud.cliente_cedula|lower }}">
                                    <td>
                                        <a href="{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}" class="text-decoration-none">
                                            <strong class="text-primary">{{ solicitud.codigo }}</strong>
                                        </a>
                                    </td>
                                    <td>{{ solicitud.cliente_nombre }}</td>
                                    <td>{{ solicitud.cliente_cedula }}</td>
                                    <td><span class="badge bg-info">{{ solicitud.etapa_actual.nombre }}</span></td>
                                    <td><span class="badge bg-secondary">{{ solicitud.estado_actual }}</span></td>
                                    <td>
                                        <i class="fas fa-circle {{ solicitud.sla_color }}" style="font-size: 0.8rem;"></i>
                                        <span class="{{ solicitud.sla_color }}">{{ solicitud.sla_restante }}</span>
                                    </td>
                                    <td>{{ solicitud.fecha_inicio|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-warning btn-sm devolver-solicitud" 
                                                    data-solicitud-id="{{ solicitud.id }}"
                                                    data-codigo="{{ solicitud.codigo }}">
                                                <i class="fas fa-undo me-1"></i><span class="btn-action-text">Devolver</span>
                                            </button>
                                            <button class="btn btn-info btn-sm ver-detalle" 
                                                    data-solicitud-id="{{ solicitud.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <br>No tienes tareas asignadas
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- KPIs con formato EXACTO de negocios.html -->
    <div class="card card-custom mt-3" id="kpis-section">
        <div class="card-body py-2">
            <div class="row g-2">
                <div class="col-3">
                    <div class="kpi-card-compact kpi-total">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Total</p>
                            <h4 class="kpi-number-compact" id="kpi-total-grupo">{{ total_grupo }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-activas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Activas</p>
                            <h4 class="kpi-number-compact" id="kpi-mis-tareas">{{ mis_tareas }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-completadas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Completadas</p>
                            <h4 class="kpi-number-compact" id="kpi-en-tiempo">{{ en_tiempo }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-compact kpi-vencidas">
                        <div class="kpi-icon-compact">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="kpi-content-compact">
                            <p class="kpi-label-compact">Vencidas</p>
                            <h4 class="kpi-number-compact" id="kpi-por-vencer">{{ por_vencer }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación Personalizado -->
<div class="modal fade" id="modalConfirmacionEtapa" tabindex="-1" aria-labelledby="modalConfirmacionEtapaLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);">
            <!-- Header con gradiente verde -->
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; padding: 24px 32px 20px 32px; position: relative; overflow: hidden;">
                <div class="d-flex align-items-center w-100">
                    <div class="me-3">
                        <div style="width: 50px; height: 50px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                            <i class="fas fa-exchange-alt text-white" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div>
                        <h4 class="modal-title text-white fw-bold mb-1" id="modalConfirmacionTitulo">Confirmar Acción</h4>
                        <p class="text-white-50 mb-0" style="font-size: 0.9rem;">Sistema de Workflow</p>
                    </div>
                </div>
                <!-- Patrón decorativo -->
                <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; transform: rotate(45deg);"></div>
            </div>
            
            <!-- Body con contenido estructurado -->
            <div class="modal-body" style="padding: 32px; background: linear-gradient(to bottom, #f8f9fa, #ffffff);">
                <!-- Pregunta principal -->
                <div class="text-center mb-4">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #e8f5e8, #d4edda); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                        <i class="fas fa-arrow-right text-success" style="font-size: 2rem;"></i>
                    </div>
                    <h5 class="fw-bold text-dark mb-2" id="modalConfirmacionPregunta">¿Está seguro de la acción?</h5>
                    <p class="text-muted mb-0" id="modalConfirmacionSubtitulo">Esta acción afectará el estado de la solicitud</p>
                </div>
                
                <!-- Información destacada -->
                <div class="alert alert-success border-0 mb-4" style="background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 12px;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle text-success me-2" style="font-size: 1.2rem;"></i>
                        <div>
                            <strong>Detalles:</strong> <span id="modalConfirmacionDetalle">Se procesará la solicitud</span>
                        </div>
                    </div>
                </div>
                
                <!-- Información del proceso -->
                <div class="mb-4">
                    <h6 class="fw-bold text-dark mb-3">
                        <i class="fas fa-cogs text-primary me-2"></i>
                        Proceso automático que se ejecutará:
                    </h6>
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded-lg">
                                <i class="fas fa-database text-info me-2"></i>
                                <small class="text-muted">Se actualizará el estado de la solicitud</small>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded-lg">
                                <i class="fas fa-history text-warning me-2"></i>
                                <small class="text-muted">Se registrará en el historial del sistema</small>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded-lg">
                                <i class="fas fa-bell text-success me-2"></i>
                                <small class="text-muted">Se notificará a los usuarios correspondientes</small>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded-lg">
                                <i class="fas fa-sync text-secondary me-2"></i>
                                <small class="text-muted">Se sincronizará en tiempo real</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer con botones -->
            <div class="modal-footer border-0" style="padding: 20px 32px 32px; background: #ffffff;">
                <div class="w-100 d-flex gap-3">
                    <button type="button" class="btn btn-outline-secondary flex-fill py-2 fw-medium" id="modalConfirmacionCancelar" style="border-radius: 10px;">
                        <i class="fas fa-times me-2"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-success flex-fill py-2 fw-medium" id="modalConfirmacionAceptar" style="border-radius: 10px; background: linear-gradient(135deg, #28a745, #20c997); border: none;">
                        <i class="fas fa-check me-2"></i>
                        Aceptar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Detalle -->
<div class="modal fade" id="detalleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Solicitud</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detalle-contenido">
                    <!-- Contenido se carga dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Asignar Solicitud -->
<div class="modal fade" id="modalAsignarSolicitud" tabindex="-1" aria-labelledby="modalAsignarSolicitudLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: #fff;">
                <h5 class="modal-title" id="modalAsignarSolicitudLabel">
                    <i class="fas fa-user-plus me-2"></i>
                    Asignar Solicitud
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert" style="background: linear-gradient(90deg, #e0f2fe 0%, #f0fdfa 100%); color: #1e40af; border: none;">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Solicitud:</strong> <span id="asignar-codigo-solicitud"></span>
                    <br>
                    <strong>Etapa:</strong> <span id="asignar-etapa-solicitud"></span>
                </div>
                <div class="mb-3">
                    <h6 class="fw-bold" style="color: #009c3c;">
                        <i class="fas fa-users me-2"></i>
                        Usuarios con Acceso a esta Etapa:
                    </h6>
                    
                    <!-- Barra de búsqueda -->
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none;">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="buscar-usuario-asignacion" 
                                   placeholder="Buscar por nombre, email, grupos o roles..." 
                                   style="border-left: none;">
                            <button class="btn btn-outline-secondary" type="button" id="limpiar-busqueda-usuarios">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Busca por nombre, email, grupos o roles (Staff/Admin)
                        </small>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover table-striped" id="tabla-usuarios" style="border-radius: 8px; overflow: hidden;">
                            <thead style="background: linear-gradient(90deg, #22a650 0%, #009c3c 100%); color: #fff;">
                                <tr>
                                    <th scope="col" style="width: 50px;">#</th>
                                    <th scope="col" style="width: 60px;">Avatar</th>
                                    <th scope="col">Usuario</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Grupos</th>
                                    <th scope="col" style="width: 120px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="lista-usuarios">
                                <!-- Lista de usuarios se carga dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Contador de resultados -->
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-users me-1"></i>
                            <span id="contador-usuarios">0</span> usuarios encontrados
                        </small>
                    </div>
                </div>
                <div id="asignar-loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando usuarios disponibles...</p>
                </div>
                <div id="asignar-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="asignar-error-mensaje"></span>
                </div>
            </div>
            <div class="modal-footer" style="background: #f0fdfa;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast para notificaciones -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="notificacionToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-info-circle me-2 text-success"></i>
            <strong class="me-auto">Notificación</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <!-- Mensaje se establece dinámicamente -->
        </div>
    </div>
</div>

<!-- Asegurar que jQuery esté disponible -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para obtener token CSRF de las cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // =====================================
    // MODAL DE CONFIRMACIÓN PERSONALIZADO
    // =====================================
    
    // Variables para manejar callbacks del modal
    let modalConfirmCallback = null;
    let modalCancelCallback = null;
    
    // Función para mostrar modal de confirmación
    window.mostrarModalConfirmacion = function(accion, onConfirm, onCancel, opciones) {
        // Opciones por defecto
        var configuracion = {
            titulo: 'Confirmar Acción',
            subtitulo: 'Sistema de Workflow',
            pregunta: '¿Está seguro de la acción?',
            descripcion: 'Esta acción afectará el estado de la solicitud',
            detalle: 'Se procesará la solicitud',
            iconoHeader: 'fas fa-exchange-alt',
            iconoCentral: 'fas fa-arrow-right'
        };
        
        // Personalizar según la acción
        if (accion === 'tomar') {
            configuracion.titulo = 'Tomar Solicitud';
            configuracion.pregunta = '¿Confirma que desea tomar esta solicitud?';
            configuracion.descripcion = 'La solicitud se asignará a su usuario';
            configuracion.detalle = 'Se asignará la solicitud a su usuario';
            configuracion.iconoHeader = 'fas fa-hand-paper';
            configuracion.iconoCentral = 'fas fa-user-check';
        } else if (accion === 'devolver') {
            configuracion.titulo = 'Devolver Solicitud';
            configuracion.pregunta = '¿Confirma que desea devolver esta solicitud?';
            configuracion.descripcion = 'La solicitud volverá a bandeja grupal';
            configuracion.detalle = 'Se devolverá la solicitud a bandeja grupal';
            configuracion.iconoHeader = 'fas fa-undo';
            configuracion.iconoCentral = 'fas fa-reply';
        }
        
        // Aplicar opciones personalizadas
        if (opciones) {
            Object.assign(configuracion, opciones);
        }
        
        // Actualizar el contenido del modal
        $('#modalConfirmacionTitulo').text(configuracion.titulo);
        $('#modalConfirmacionPregunta').text(configuracion.pregunta);
        $('#modalConfirmacionSubtitulo').text(configuracion.descripcion);
        $('#modalConfirmacionDetalle').text(configuracion.detalle);
        
        // Actualizar iconos
        $('#modalConfirmacionEtapa .modal-header i').removeClass().addClass(configuracion.iconoHeader + ' text-white');
        $('#modalConfirmacionEtapa .modal-body .text-center i').removeClass().addClass(configuracion.iconoCentral + ' text-success');
        
        // Guardar callbacks
        modalConfirmCallback = onConfirm;
        modalCancelCallback = onCancel || function() {};
        
        // Mostrar el modal
        var modal = new bootstrap.Modal(document.getElementById('modalConfirmacionEtapa'));
        modal.show();
    };
    
    // Event listeners para los botones del modal
    $('#modalConfirmacionAceptar').on('click', function() {
        if (modalConfirmCallback) {
            modalConfirmCallback();
        }
        bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionEtapa')).hide();
    });
    
    $('#modalConfirmacionCancelar').on('click', function() {
        if (modalCancelCallback) {
            modalCancelCallback();
        }
        bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionEtapa')).hide();
    });
    
    // =====================================
    // NOTIFICACIONES TOAST PERSONALIZADAS
    // =====================================
    
    function mostrarNotificacionExito(mensaje) {
        console.log('✅ Mostrando notificación de éxito:', mensaje);
        
        // Crear toast personalizado
        var toastHTML = `
            <div class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" style="border-radius: 12px;">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        ${mensaje}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // Agregar al contenedor
        var toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        
        // Mostrar toast
        var toastElement = toastContainer.lastElementChild;
        var toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 4000
        });
        toast.show();
        
        // Remover elemento después de que se oculte
        toastElement.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }
    
    function mostrarNotificacionError(mensaje) {
        console.log('🚨 Mostrando notificación de error:', mensaje);
        
        // Crear toast personalizado
        var toastHTML = `
            <div class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" style="border-radius: 12px;">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${mensaje}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // Agregar al contenedor
        var toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        
        // Mostrar toast
        var toastElement = toastContainer.lastElementChild;
        var toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 5000
        });
        toast.show();
        
        // Remover elemento después de que se oculte
        toastElement.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }
    
    // Función específica para toast de asignación exitosa
    function mostrarToastExito(mensaje) {
        console.log('🎉 Mostrando toast de asignación exitosa:', mensaje);
        
        // Crear toast personalizado con diseño especial para asignación
        var toastHTML = `
            <div class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true" 
                 style="background: linear-gradient(135deg, #22a650 0%, #009c3c 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(34, 166, 80, 0.3);">
                <div class="d-flex">
                    <div class="toast-body d-flex align-items-center">
                        <i class="fas fa-user-plus me-2" style="font-size: 1.2em;"></i>
                        <div>
                            <strong style="font-size: 1.1em;">¡Asignación Exitosa!</strong><br>
                            <span style="font-size: 0.95em;">${mensaje}</span>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // Agregar al contenedor
        var toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        
        // Mostrar toast
        var toastElement = toastContainer.lastElementChild;
        var toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 4000
        });
        toast.show();
        
        // Remover elemento después de que se oculte
        toastElement.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }
    
    // Función para aplicar filtros
    function aplicarFiltros() {
        const filtroEstado = document.getElementById('filtroEstado').value.toLowerCase();
        const filtroSLA = document.getElementById('filtroSLA').value;
        const busqueda = document.getElementById('busquedaGlobal').value.toLowerCase();
        
        const filas = document.querySelectorAll('.solicitud-row');
        const supervisorFilas = document.querySelectorAll('.supervisor-row');
        
        // Aplicar filtros a las filas normales
        filas.forEach(fila => {
            const estado = fila.dataset.estado.toLowerCase();
            const sla = fila.dataset.sla;
            const search = fila.dataset.search || '';
            
            let mostrar = true;
            
            // Filtro por estado
            if (filtroEstado && !estado.includes(filtroEstado)) {
                mostrar = false;
            }
            
            // Filtro por SLA
            if (filtroSLA && sla !== filtroSLA) {
                mostrar = false;
            }
            
            // Búsqueda global
            if (busqueda && !search.includes(busqueda)) {
                mostrar = false;
            }
            
            fila.style.display = mostrar ? '' : 'none';
        });
        
        // Aplicar filtros a las filas de supervisor
        supervisorFilas.forEach(fila => {
            const estado = fila.dataset.estado.toLowerCase();
            const sla = fila.dataset.sla;
            const search = fila.dataset.search || '';
            
            let mostrar = true;
            
            // Filtro por estado
            if (filtroEstado && !estado.includes(filtroEstado)) {
                mostrar = false;
            }
            
            // Filtro por SLA
            if (filtroSLA && sla !== filtroSLA) {
                mostrar = false;
            }
            
            // Búsqueda global
            if (busqueda && !search.includes(busqueda)) {
                mostrar = false;
            }
            
            fila.style.display = mostrar ? '' : 'none';
        });
        
        // Actualizar contadores en vista de supervisor
        actualizarContadoresSupervisor();
    }
    
    // Event listeners para filtros
    document.getElementById('filtroEstado').addEventListener('change', aplicarFiltros);
    document.getElementById('filtroSLA').addEventListener('change', aplicarFiltros);
    document.getElementById('busquedaGlobal').addEventListener('input', aplicarFiltros);
    
    // Botón limpiar filtros
    document.getElementById('limpiarFiltros').addEventListener('click', function() {
        document.getElementById('filtroEstado').value = '';
        document.getElementById('filtroSLA').value = '';
        document.getElementById('busquedaGlobal').value = '';
        aplicarFiltros();
    });
    
    // Función para mostrar notificaciones
    function mostrarNotificacion(mensaje, tipo = 'success') {
        const toast = document.getElementById('notificacionToast');
        const toastBody = toast.querySelector('.toast-body');
        const toastHeader = toast.querySelector('.toast-header i');
        
        toastBody.textContent = mensaje;
        
        // Cambiar icono según tipo
        toastHeader.className = `fas me-2 ${tipo === 'success' ? 'fa-check-circle text-success' : 'fa-exclamation-triangle text-warning'}`;
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }
    
    // BOTONES TOMAR SOLICITUD - CON MODAL PERSONALIZADO
    document.querySelectorAll('.tomar-solicitud').forEach(button => {
        button.addEventListener('click', function() {
            const solicitudId = this.getAttribute('data-solicitud-id');
            const codigo = this.getAttribute('data-codigo');
            const botonOriginal = this;
            
            console.log('🔵 Tomando solicitud:', solicitudId, codigo);
            
            // Mostrar modal personalizado
            mostrarModalConfirmacion('tomar', function() {
                // CALLBACK DE CONFIRMACIÓN
                console.log('✅ Confirmado - Tomando solicitud:', solicitudId);
                
                // Deshabilitar botón
                botonOriginal.disabled = true;
                botonOriginal.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Tomando...';
                
                fetch(`/workflow/api/solicitudes/${solicitudId}/tomar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Notificación de éxito personalizada
                        mostrarNotificacionExito(`Solicitud ${codigo} tomada correctamente`);
                        
                        // Recargar la página después de 1 segundo
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        mostrarNotificacionError("Error: " + (data.error || 'Error desconocido'));
                        // Rehabilitar botón
                        botonOriginal.disabled = false;
                        botonOriginal.innerHTML = '<i class="fas fa-hand-paper me-1"></i>Tomar';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacionError("Error de red al tomar la solicitud");
                    // Rehabilitar botón
                    botonOriginal.disabled = false;
                    botonOriginal.innerHTML = '<i class="fas fa-hand-paper me-1"></i>Tomar';
                });
            }, function() {
                // CALLBACK DE CANCELACIÓN
                console.log('❌ Cancelado - Tomar solicitud');
            });
        });
    });
    
    // BOTONES DEVOLVER SOLICITUD - CON MODAL PERSONALIZADO
    document.querySelectorAll('.devolver-solicitud').forEach(button => {
        button.addEventListener('click', function() {
            const solicitudId = this.getAttribute('data-solicitud-id');
            const codigo = this.getAttribute('data-codigo');
            const botonOriginal = this;
            
            console.log('🔴 Devolviendo solicitud:', solicitudId, codigo);
            
            // Mostrar modal personalizado
            mostrarModalConfirmacion('devolver', function() {
                // CALLBACK DE CONFIRMACIÓN
                console.log('✅ Confirmado - Devolviendo solicitud:', solicitudId);
                
                // Deshabilitar botón
                botonOriginal.disabled = true;
                botonOriginal.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Devolviendo...';
                
                fetch(`/workflow/api/solicitudes/${solicitudId}/devolver/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Notificación de éxito personalizada
                        mostrarNotificacionExito(`Solicitud ${codigo} devuelta correctamente`);
                        
                        // Recargar la página después de 1 segundo
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        mostrarNotificacionError("Error: " + (data.error || 'Error desconocido'));
                        // Rehabilitar botón
                        botonOriginal.disabled = false;
                        botonOriginal.innerHTML = '<i class="fas fa-undo me-1"></i>Devolver';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacionError("Error de red al devolver la solicitud");
                    // Rehabilitar botón
                    botonOriginal.disabled = false;
                    botonOriginal.innerHTML = '<i class="fas fa-undo me-1"></i>Devolver';
                });
            }, function() {
                // CALLBACK DE CANCELACIÓN
                console.log('❌ Cancelado - Devolver solicitud');
            });
        });
    });
    
    // Función para ver detalle - navegar directamente a la página de análisis
    document.querySelectorAll('.ver-detalle').forEach(button => {
        button.addEventListener('click', function() {
            const solicitudId = this.getAttribute('data-solicitud-id');
            
            // Navegar directamente a la página de análisis
            window.location.href = `/workflow/solicitud/${solicitudId}/analisis/`;
        });
    });
    
    // Función para ver solicitud
    document.querySelectorAll('.ver-solicitud').forEach(button => {
        button.addEventListener('click', function() {
            const solicitudId = this.getAttribute('data-solicitud-id');
            
            // Navegar directamente a la página de análisis
            window.location.href = `/workflow/solicitud/${solicitudId}/analisis/`;
        });
    });
    
    // BOTONES ASIGNAR SOLICITUD
    document.querySelectorAll('.asignar-solicitud').forEach(button => {
        button.addEventListener('click', function() {
            const solicitudId = this.getAttribute('data-solicitud-id');
            const codigo = this.getAttribute('data-codigo');
            const etapaId = this.getAttribute('data-etapa-id');
            
            console.log('🔵 Asignando solicitud:', solicitudId, codigo, etapaId);
            
            // Guardar el solicitud_id en el modal para uso posterior
            document.getElementById('modalAsignarSolicitud').setAttribute('data-solicitud-id', solicitudId);
            
            // Actualizar información del modal
            document.getElementById('asignar-codigo-solicitud').textContent = codigo;
            document.getElementById('asignar-etapa-solicitud').textContent = this.closest('tr').querySelector('.badge').textContent;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalAsignarSolicitud'));
            modal.show();
            
            // Configurar búsqueda después de que el modal se muestre
            setTimeout(() => {
                configurarBusquedaUsuarios();
            }, 100);
            
            // Cargar usuarios disponibles
            cargarUsuariosDisponibles(solicitudId, etapaId);
        });
    });
    
    // Función para cargar usuarios disponibles
    function cargarUsuariosDisponibles(solicitudId, etapaId) {
        const loadingDiv = document.getElementById('asignar-loading');
        const errorDiv = document.getElementById('asignar-error');
        const listaUsuarios = document.getElementById('lista-usuarios');
        
        // Mostrar loading
        loadingDiv.style.display = 'block';
        errorDiv.style.display = 'none';
        listaUsuarios.innerHTML = '';
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/usuarios-disponibles/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            loadingDiv.style.display = 'none';
            
            if (data.success) {
                if (data.usuarios && data.usuarios.length > 0) {
                    renderizarListaUsuarios(data.usuarios);
                    // Configurar búsqueda después de renderizar usuarios
                    setTimeout(() => {
                        configurarBusquedaUsuarios();
                    }, 50);
                } else {
                    listaUsuarios.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No hay usuarios disponibles para asignar esta solicitud.
                                </div>
                            </td>
                        </tr>
                    `;
                }
            } else {
                throw new Error(data.error || 'Error al cargar usuarios');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'block';
            document.getElementById('asignar-error-mensaje').textContent = error.message;
        });
    }
    
    // Función para renderizar lista de usuarios
    function renderizarListaUsuarios(usuarios) {
        const listaUsuarios = document.getElementById('lista-usuarios');
        
        const usuariosHTML = usuarios.map((usuario, index) => `
            <tr class="usuario-item" 
                data-usuario-id="${usuario.id}" 
                data-usuario-nombre="${usuario.nombre_completo}"
                data-usuario-email="${usuario.email}"
                data-usuario-grupos="${usuario.grupos ? usuario.grupos.join(',') : ''}"
                data-usuario-roles="${(usuario.is_staff ? 'staff' : '') + (usuario.is_superuser ? 'admin' : '')}"
                data-profile-picture="${usuario.profile_picture_url || ''}">
                <td class="text-center">
                    <span class="badge bg-secondary">${index + 1}</span>
                </td>
                <td class="text-center">
                    ${usuario.profile_picture_url ? 
                        `<img src="${usuario.profile_picture_url}" alt="${usuario.nombre_completo}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e0e0e0;">` :
                        `<div style="width: 40px; height: 40px; background: linear-gradient(135deg, #007bff, #0056b3); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin: 0 auto;">
                            ${usuario.nombre_completo.charAt(0).toUpperCase()}
                        </div>`
                    }
                </td>
                <td>
                    <div>
                        <strong class="fw-bold">${usuario.nombre_completo}</strong>
                        ${usuario.is_staff ? '<span class="badge bg-info ms-1">Staff</span>' : ''}
                        ${usuario.is_superuser ? '<span class="badge bg-danger ms-1">Admin</span>' : ''}
                    </div>
                </td>
                <td>
                    <small class="text-muted">${usuario.email}</small>
                </td>
                <td>
                    ${usuario.grupos && usuario.grupos.length > 0 ? 
                        usuario.grupos.map(grupo => `<span class="badge bg-light text-dark me-1">${grupo}</span>`).join('') : 
                        '<span class="text-muted">Sin grupos</span>'
                    }
                </td>
                <td class="text-center">
                    <button class="btn btn-success btn-sm asignar-usuario" 
                            data-usuario-id="${usuario.id}" 
                            data-usuario-nombre="${usuario.nombre_completo}">
                        <i class="fas fa-user-plus me-1"></i>
                        Asignar
                    </button>
                </td>
            </tr>
        `).join('');
        
        listaUsuarios.innerHTML = usuariosHTML;
        
        // Actualizar contador
        actualizarContadorUsuarios();
        
        // Agregar event listeners a los botones de asignar
        document.querySelectorAll('.asignar-usuario').forEach(btn => {
            btn.addEventListener('click', function() {
                const usuarioId = this.getAttribute('data-usuario-id');
                const usuarioNombre = this.getAttribute('data-usuario-nombre');
                const modal = document.getElementById('modalAsignarSolicitud');
                const solicitudId = modal.getAttribute('data-solicitud-id');
                
                console.log('🔵 Asignando usuario:', usuarioId, usuarioNombre, 'a solicitud:', solicitudId);
                
                if (!solicitudId) {
                    mostrarNotificacionError('Error: No se pudo obtener el ID de la solicitud');
                    return;
                }
                
                asignarSolicitudAUsuario(solicitudId, usuarioId, usuarioNombre);
            });
        });
    }
    
    // Función para filtrar usuarios
    function filtrarUsuarios() {
        console.log('🔍 Filtrando usuarios...');
        
        const buscarInput = document.getElementById('buscar-usuario-asignacion');
        const contadorElement = document.getElementById('contador-usuarios');
        
        if (!buscarInput || !contadorElement) {
            console.log('❌ Elementos de búsqueda no encontrados');
            return;
        }
        
        const busqueda = buscarInput.value.toLowerCase().trim();
        const usuarios = document.querySelectorAll('.usuario-item');
        let contador = 0;
        
        console.log(`🔍 Buscando: "${busqueda}" en ${usuarios.length} usuarios`);
        
        usuarios.forEach((usuario, index) => {
            const nombre = usuario.getAttribute('data-usuario-nombre') || '';
            const email = usuario.getAttribute('data-usuario-email') || '';
            const grupos = usuario.getAttribute('data-usuario-grupos') || '';
            const roles = usuario.getAttribute('data-usuario-roles') || '';
            
            const coincide = nombre.toLowerCase().includes(busqueda) || 
                           email.toLowerCase().includes(busqueda) || 
                           grupos.toLowerCase().includes(busqueda) || 
                           roles.toLowerCase().includes(busqueda);
            
            if (coincide || !busqueda) {
                usuario.style.display = '';
                contador++;
            } else {
                usuario.style.display = 'none';
            }
        });
        
        // Actualizar contador
        contadorElement.textContent = contador;
        console.log(`✅ ${contador} usuarios encontrados`);
        
        // Mostrar mensaje si no hay resultados
        const tabla = document.getElementById('tabla-usuarios');
        if (tabla) {
            const tbody = tabla.querySelector('tbody');
            
            // Remover mensaje anterior si existe
            const noResultadosAnterior = tbody.querySelector('.no-resultados');
            if (noResultadosAnterior) {
                noResultadosAnterior.remove();
            }
            
            if (contador === 0 && busqueda) {
                const noResultados = document.createElement('tr');
                noResultados.className = 'no-resultados';
                noResultados.innerHTML = `
                    <td colspan="6" class="text-center py-4">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-search me-2"></i>
                            No se encontraron usuarios que coincidan con "${busqueda}"
                        </div>
                    </td>
                `;
                tbody.appendChild(noResultados);
            }
        }
    }
    
    // Función para actualizar contador de usuarios
    function actualizarContadorUsuarios() {
        const usuariosVisibles = document.querySelectorAll('.usuario-item:not([style*="display: none"])').length;
        const totalUsuarios = document.querySelectorAll('.usuario-item').length;
        document.getElementById('contador-usuarios').textContent = usuariosVisibles;
    }
    
    // Función para limpiar búsqueda
    function limpiarBusquedaUsuarios() {
        document.getElementById('buscar-usuario-asignacion').value = '';
        filtrarUsuarios();
    }
    
    // Función para configurar búsqueda de usuarios
    function configurarBusquedaUsuarios() {
        // Búsqueda en tiempo real
        const buscarInput = document.getElementById('buscar-usuario-asignacion');
        if (buscarInput) {
            // Remover event listeners existentes para evitar duplicados
            buscarInput.removeEventListener('input', filtrarUsuarios);
            buscarInput.removeEventListener('keydown', handleEnterKey);
            
            // Agregar nuevos event listeners
            buscarInput.addEventListener('input', filtrarUsuarios);
            buscarInput.addEventListener('keydown', handleEnterKey);
        }
        
        // Botón limpiar búsqueda
        const limpiarBtn = document.getElementById('limpiar-busqueda-usuarios');
        if (limpiarBtn) {
            // Remover event listeners existentes
            limpiarBtn.removeEventListener('click', handleLimpiarBusqueda);
            
            // Agregar nuevo event listener
            limpiarBtn.addEventListener('click', handleLimpiarBusqueda);
        }
    }
    
    // Función para manejar la tecla Enter
    function handleEnterKey(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            filtrarUsuarios();
        }
    }
    
    // Función para manejar limpiar búsqueda
    function handleLimpiarBusqueda() {
        limpiarBusquedaUsuarios();
        const buscarInput = document.getElementById('buscar-usuario-asignacion');
        if (buscarInput) {
            buscarInput.focus();
        }
    }
    
    // Función para asignar solicitud a usuario
    function asignarSolicitudAUsuario(solicitudId, usuarioId, usuarioNombre) {
        console.log('🔵 Iniciando asignación:', { solicitudId, usuarioId, usuarioNombre });
        
        if (!solicitudId || solicitudId === 'null' || solicitudId === 'undefined') {
            mostrarNotificacionError('Error: ID de solicitud inválido');
            return;
        }
        
        const boton = document.querySelector(`[data-usuario-id="${usuarioId}"] .asignar-usuario`);
        if (!boton) {
            mostrarNotificacionError('Error: No se pudo encontrar el botón de asignación');
            return;
        }
        
        const originalText = boton.innerHTML;
        
        // Deshabilitar botón y mostrar loading
        boton.disabled = true;
        boton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Asignando...';
        
        const url = `/workflow/api/solicitudes/${solicitudId}/asignar-usuario/`;
        console.log('🔵 Haciendo request a:', url);
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                usuario_id: usuarioId
            })
        })
        .then(response => {
            console.log('🔵 Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('🔵 Response data:', data);
            if (data.success) {
                // Mostrar toast de éxito
                mostrarToastExito(`✅ Solicitud asignada exitosamente a ${usuarioNombre}`);
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAsignarSolicitud'));
                if (modal) {
                    modal.hide();
                }
                
                // Recargar página después de 2 segundos para que el usuario vea el toast
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                throw new Error(data.error || 'Error al asignar la solicitud');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacionError(`Error: ${error.message}`);
            
            // Rehabilitar botón
            boton.disabled = false;
            boton.innerHTML = originalText;
        });
    }
    

    
    // RECARGA AUTOMÁTICA REMOVIDA - Ya no se recarga automáticamente para evitar expulsar usuarios
    // setInterval(function() {
    //     if (!document.hidden) {
    //         console.log('🔄 Recarga automática programada');
    //         location.reload();
    //     }
    // }, 30000); // REMOVIDO - Era cada 30 segundos
    
    // =====================================
    // FUNCIONALIDAD DE VISTA DE SUPERVISOR
    // =====================================
    
    // Toggle para mostrar/ocultar vista de supervisor
    const toggleSupervisorView = document.getElementById('toggle-supervisor-view');
    const supervisorViewContent = document.getElementById('supervisor-view-content');
    
    if (toggleSupervisorView && supervisorViewContent) {
        toggleSupervisorView.addEventListener('click', function() {
            const isVisible = supervisorViewContent.style.display !== 'none';
            
            if (isVisible) {
                supervisorViewContent.style.display = 'none';
                toggleSupervisorView.innerHTML = '<i class="fas fa-eye me-1"></i>Mostrar Vista Completa';
                toggleSupervisorView.classList.remove('btn-light');
                toggleSupervisorView.classList.add('btn-outline-light');
            } else {
                supervisorViewContent.style.display = 'block';
                toggleSupervisorView.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Ocultar Vista Completa';
                toggleSupervisorView.classList.remove('btn-outline-light');
                toggleSupervisorView.classList.add('btn-light');
                
                // Actualizar contadores cuando se muestra
                actualizarContadorVencidas();
            }
        });
    }
    
    // Función para actualizar contadores de la vista de supervisor
    function actualizarContadoresSupervisor() {
        const supervisorFilas = document.querySelectorAll('.supervisor-row');
        let vencidasCount = 0;
        let totalVisible = 0;
        
        supervisorFilas.forEach(fila => {
            if (fila.style.display !== 'none') {
                totalVisible++;
                const sla = fila.dataset.sla;
                if (sla === 'vencido') {
                    vencidasCount++;
                }
            }
        });
        
        // Actualizar contador de vencidas
        const vencidasElement = document.getElementById('supervisor-vencidas-count');
        if (vencidasElement) {
            vencidasElement.textContent = vencidasCount;
        }
        
        // Actualizar contador total
        const totalElement = document.getElementById('supervisor-total-count');
        if (totalElement) {
            totalElement.textContent = totalVisible;
        }
    }
    
    // Función para actualizar contador de solicitudes vencidas (mantener compatibilidad)
    function actualizarContadorVencidas() {
        actualizarContadoresSupervisor();
    }
    
    // Función para exportar datos de supervisor
    const exportSupervisorData = document.getElementById('export-supervisor-data');
    if (exportSupervisorData) {
        exportSupervisorData.addEventListener('click', function() {
            exportarDatosSupervisor();
        });
    }
    
    function exportarDatosSupervisor() {
        const supervisorFilas = document.querySelectorAll('.supervisor-row');
        const datos = [];
        
        // Encabezados
        datos.push([
            'Código', 'Cliente', 'Cédula', 'Pipeline', 'Etapa', 'Asignado a', 
            'SLA', 'Fecha Creación', 'Última Actualización', 'Creado por', 'Monto', 'Tipo'
        ]);
        
        // Datos de cada fila
        supervisorFilas.forEach(fila => {
            if (fila.style.display !== 'none') {
                const codigo = fila.querySelector('td:nth-child(1) strong').textContent;
                const cliente = fila.querySelector('td:nth-child(2) strong').textContent;
                const cedula = fila.querySelector('td:nth-child(3) code').textContent;
                const pipeline = fila.querySelector('td:nth-child(4) .badge').textContent;
                const etapa = fila.querySelector('td:nth-child(5) .badge').textContent;
                const asignado = fila.querySelector('td:nth-child(6) .badge').textContent;
                const sla = fila.querySelector('td:nth-child(7) span').textContent.trim();
                const fechaCreacion = fila.querySelector('td:nth-child(8) small').textContent;
                const ultimaActualizacion = fila.querySelector('td:nth-child(9) small').textContent;
                const creadoPor = fila.querySelector('td:nth-child(10) small').textContent;
                const monto = fila.querySelector('td:nth-child(11) strong').textContent;
                const tipo = fila.dataset.tipo === 'grupal' ? 'Bandeja Grupal' : 'Asignada';
                
                datos.push([
                    codigo, cliente, cedula, pipeline, etapa, asignado, sla,
                    fechaCreacion, ultimaActualizacion, creadoPor, monto, tipo
                ]);
            }
        });
        
        // Crear CSV
        const csvContent = datos.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `solicitudes_supervisor_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
    
    // Event listeners para botones en la tabla de supervisor
    document.addEventListener('click', function(e) {
        // Botones de tomar solicitud en tabla de supervisor
        if (e.target.closest('.supervisor-row .tomar-solicitud')) {
            const button = e.target.closest('.tomar-solicitud');
            const solicitudId = button.getAttribute('data-solicitud-id');
            const codigo = button.getAttribute('data-codigo');
            
            console.log('🔵 Tomando solicitud desde vista supervisor:', solicitudId, codigo);
            
            // Usar el mismo modal de confirmación
            mostrarModalConfirmacion('tomar', function() {
                // CALLBACK DE CONFIRMACIÓN
                console.log('✅ Confirmado - Tomando solicitud desde supervisor:', solicitudId);
                
                // Deshabilitar botón
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                fetch(`/workflow/api/solicitudes/${solicitudId}/tomar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        mostrarNotificacionExito(`Solicitud ${codigo} tomada correctamente`);
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        mostrarNotificacionError("Error: " + (data.error || 'Error desconocido'));
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-hand-paper"></i>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacionError("Error de red al tomar la solicitud");
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-hand-paper"></i>';
                });
            });
        }
        
        // Botones de devolver solicitud en tabla de supervisor
        if (e.target.closest('.supervisor-row .devolver-solicitud')) {
            const button = e.target.closest('.devolver-solicitud');
            const solicitudId = button.getAttribute('data-solicitud-id');
            const codigo = button.getAttribute('data-codigo');
            
            console.log('🔴 Devolviendo solicitud desde vista supervisor:', solicitudId, codigo);
            
            mostrarModalConfirmacion('devolver', function() {
                console.log('✅ Confirmado - Devolviendo solicitud desde supervisor:', solicitudId);
                
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                fetch(`/workflow/api/solicitudes/${solicitudId}/devolver/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        mostrarNotificacionExito(`Solicitud ${codigo} devuelta correctamente`);
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        mostrarNotificacionError("Error: " + (data.error || 'Error desconocido'));
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-undo"></i>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacionError("Error de red al devolver la solicitud");
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-undo"></i>';
                });
            });
        }
        
        // Botones de asignar solicitud en tabla de supervisor
        if (e.target.closest('.supervisor-row .asignar-solicitud')) {
            const button = e.target.closest('.asignar-solicitud');
            const solicitudId = button.getAttribute('data-solicitud-id');
            const codigo = button.getAttribute('data-codigo');
            const etapaId = button.getAttribute('data-etapa-id');
            
            console.log('🔵 Asignando solicitud desde vista supervisor:', solicitudId, codigo, etapaId);
            
            // Guardar el solicitud_id en el modal para uso posterior
            document.getElementById('modalAsignarSolicitud').setAttribute('data-solicitud-id', solicitudId);
            
            // Actualizar información del modal
            document.getElementById('asignar-codigo-solicitud').textContent = codigo;
            document.getElementById('asignar-etapa-solicitud').textContent = button.closest('tr').querySelector('.badge').textContent;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalAsignarSolicitud'));
            modal.show();
            
            // Configurar búsqueda después de que el modal se muestre
            setTimeout(() => {
                configurarBusquedaUsuarios();
            }, 100);
            
            // Cargar usuarios disponibles
            cargarUsuariosDisponibles(solicitudId, etapaId);
        }
        
        // Botones de ver detalle en tabla de supervisor
        if (e.target.closest('.supervisor-row .ver-detalle')) {
            const button = e.target.closest('.ver-detalle');
            const solicitudId = button.getAttribute('data-solicitud-id');
            
            // Navegar directamente a la página de análisis
            window.location.href = `/workflow/solicitud/${solicitudId}/analisis/`;
        }
    });
    
    console.log('✅ Sistema de bandejas inicializado correctamente - SIN auto-refresh');
    console.log('✅ Vista de supervisor habilitada para superusers/staff');
});
</script>

<style>
/* Estilos para KPIs compactos - EXACTOS de negocios.html */
.kpi-card-compact {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.3s ease;
    height: 60px;
}

.kpi-card-compact:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.kpi-icon-compact {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 1.2rem;
}

.kpi-content-compact {
    flex: 1;
}

.kpi-label-compact {
    font-size: 0.75rem;
    margin-bottom: 2px;
    opacity: 0.9;
    font-weight: 500;
}

.kpi-number-compact {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    line-height: 1;
}

/* Variantes de KPIs compactos - EXACTOS de negocios.html */
.kpi-total .kpi-icon-compact {
    background: linear-gradient(135deg, #009c3c, #22a650);
    color: white;
}

.kpi-total .kpi-number-compact {
    color: #009c3c;
}

.kpi-activas .kpi-icon-compact {
    background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    color: white;
}

.kpi-activas .kpi-number-compact {
    color: #0d6efd;
}

.kpi-completadas .kpi-icon-compact {
    background: linear-gradient(135deg, #ffc107, #ffb84d);
    color: #000;
}

.kpi-completadas .kpi-number-compact {
    color: #ffc107;
}

.kpi-vencidas .kpi-icon-compact {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.kpi-vencidas .kpi-number-compact {
    color: #dc3545;
}

/* Estilos para el header personalizado */
.card-custom {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-header-custom {
    border: none;
}

/* Variable CSS para el verde Pacífico */
:root {
    --verde-pacifico: #28a745;
}

/* Estilos para las tablas */
.table-responsive {
    border-radius: 8px;
    height: 420px;
    overflow-y: auto;
}

@media (max-width: 768px) {
    .table-responsive {
        height: 280px;
    }
}

.table th {
    font-weight: 600;
    font-size: 0.875rem;
    border-top: none;
}

.table td {
    font-size: 0.875rem;
    vertical-align: middle;
}

/* Animación fade-in */
.fade-in-up {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Animación fade-in y hover para filas de tabla */
.solicitud-row {
    transition: background-color 0.2s ease-in-out;
}

/* Estilos para botones de acción más pequeños y responsivos */
.table .btn-group-sm .btn {
    padding: 0.15rem 0.4rem;
    font-size: 0.75rem;
    min-width: 56px;
    text-align: center;
    border-radius: 4px;
}

.table .btn-group-sm .btn .fas {
    margin-right: 0.3rem; /* Espacio reducido entre icono y texto */
}

/* En pantallas pequeñas, ocultar el texto de los botones para ahorrar espacio */
@media (max-width: 768px) {
    .btn-action-text {
        display: none;
    }
    .table .btn-group-sm .btn .fas {
        margin-right: 0; /* Sin margen si no hay texto */
    }
}


/* Responsive adjustments */
@media (max-width: 768px) {
    .kpi-card-compact {
        height: 50px;
        padding: 6px 8px;
    }
    
    .kpi-icon-compact {
        font-size: 1.2rem;
        margin-right: 8px;
    }
    
    .kpi-number-compact {
        font-size: 1.2rem;
    }
    
    .kpi-label-compact {
        font-size: 0.7rem;
    }
}

/* Estilos para la Vista de Supervisor */
#supervisor-table {
    font-size: 0.875rem;
}

#supervisor-table th {
    font-weight: 600;
    font-size: 0.8rem;
    white-space: nowrap;
    vertical-align: middle;
}

#supervisor-table td {
    vertical-align: middle;
    padding: 0.5rem 0.25rem;
}

.supervisor-row {
    transition: background-color 0.2s ease-in-out;
}

.supervisor-row:hover {
    background-color: rgba(59, 130, 246, 0.05);
}

.supervisor-row td {
    border-top: 1px solid #f0f0f0;
}

.supervisor-row td:first-child {
    border-left: 3px solid transparent;
}

.supervisor-row[data-tipo="grupal"] td:first-child {
    border-left-color: #ffc107;
}

.supervisor-row[data-tipo="personal"] td:first-child {
    border-left-color: #28a745;
}

/* Estilos para los badges en la tabla de supervisor */
#supervisor-table .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

/* Estilos para los botones en la tabla de supervisor */
#supervisor-table .btn-group-sm .btn {
    padding: 0.15rem 0.3rem;
    font-size: 0.7rem;
    min-width: 32px;
}

/* Estilos para el header de la vista de supervisor */
#supervisor-view-content .card-header {
    background: linear-gradient(135deg, #1e40af, #3b82f6);
    border: none;
}

/* Estilos para el footer de estadísticas */
#supervisor-view-content .card-footer {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-top: 1px solid #dee2e6;
}

/* Responsive para la vista de supervisor */
@media (max-width: 1200px) {
    #supervisor-table {
        font-size: 0.8rem;
    }
    
    #supervisor-table th,
    #supervisor-table td {
        padding: 0.25rem 0.15rem;
    }
    
    #supervisor-table .btn-group-sm .btn {
        padding: 0.1rem 0.2rem;
        font-size: 0.65rem;
        min-width: 28px;
    }
}

@media (max-width: 768px) {
    #supervisor-view-content .table-responsive {
        max-height: 600px;
    }
    
    #supervisor-table th,
    #supervisor-table td {
        font-size: 0.75rem;
        padding: 0.2rem 0.1rem;
    }
    
    #supervisor-table .badge {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
    }
}
</style>

{% endblock %} 