{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}Vista Mixta - Sistema de Workflow{% endblock %}

{% block extra_css %}
<style>
    /* Modern Design Variables - Inspired by APC Tracking */
    :root {
        --primary-color: #2d5a2d;
        --primary-hover: #1e5f2a;
        --primary-light: #4a7c59;
        --background-color: #f8fafc;
        --card-background: #ffffff;
        --border-color: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --border-radius: 12px;
        --border-radius-sm: 8px;
        --verde-pacifico: var(--primary-color);
        
        /* Status Colors */
        --success-color: #059669;
        --success-light: #d1fae5;
        --warning-color: #d97706;
        --warning-light: #fef3c7;
        --danger-color: #dc2626;
        --danger-light: #fee2e2;
        --info-color: #2563eb;
        --info-light: #dbeafe;
        
        /* SLA Colors */
        --sla-good: #10b981;
        --sla-warning: #f59e0b;
        --sla-danger: #ef4444;
        --sla-neutral: #6b7280;
    }

    /* Global Container Styling */
    body .workflow-container {
        background: var(--background-color);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        position: relative;
        overflow: visible;
    }

    /* Header Styling */
    .workflow-header {
        background: var(--card-background) !important;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
        position: relative;
        overflow: visible;
    }

    .workflow-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
    }

    .workflow-header .card-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light)) !important;
        border: none !important;
        padding: 24px !important;
    }

    /* Card Styling */
    .modern-card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .modern-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .modern-card .card-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light)) !important;
        border: none !important;
        padding: 20px 24px !important;
        border-radius: 0 !important;
    }

    .modern-card .card-body {
        padding: 0 !important;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
    }

    /* Table Styling */
    .modern-table-container {
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        overflow: hidden;
    }

    .modern-table {
        margin: 0 !important;
        border-collapse: separate;
        border-spacing: 0;
    }

    .modern-table thead th {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9) !important;
        color: var(--text-primary) !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
        border: none !important;
        padding: 16px 20px !important;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .modern-table thead th:first-child {
        border-radius: 0;
        border-left: none;
    }

    .modern-table thead th:last-child {
        border-radius: 0;
        border-right: none;
    }

    .modern-table tbody tr {
        transition: all 0.2s ease;
        border: none !important;
        position: relative;
    }

    .modern-table tbody tr::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 1px;
        background: var(--border-color);
        opacity: 0.5;
    }

    .modern-table tbody tr:hover {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9) !important;
        transform: translateY(-1px);
    }

    .modern-table tbody tr:hover::after {
        opacity: 0;
    }

    .modern-table tbody tr:last-child::after {
        display: none;
    }

    .modern-table tbody td {
        padding: 16px 20px !important;
        border: none !important;
        vertical-align: middle !important;
        color: var(--text-primary) !important;
        font-size: 0.875rem !important;
    }

    .modern-table tbody tr:last-child td {
        border-bottom: none !important;
    }

    /* Badge Styling */
    .modern-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .badge-etapa {
        background: linear-gradient(135deg, var(--info-color), #3b82f6);
        color: white;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    /* Button Styling */
    .modern-btn-group {
        display: flex;
        gap: 4px;
        align-items: center;
    }

    .modern-btn {
        padding: 8px 12px !important;
        border-radius: var(--border-radius-sm) !important;
        font-size: 0.75rem !important;
        font-weight: 600 !important;
        transition: all 0.2s ease !important;
        border: none !important;
        box-shadow: var(--shadow-sm) !important;
        min-width: auto !important;
    }

    .modern-btn:hover {
        transform: translateY(-1px) !important;
        box-shadow: var(--shadow-md) !important;
    }

    .modern-btn-success {
        background: linear-gradient(135deg, var(--success-color), #10b981) !important;
        color: white !important;
    }

    .modern-btn-success:hover {
        background: linear-gradient(135deg, #047857, var(--success-color)) !important;
        color: white !important;
    }

    .modern-btn-primary {
        background: linear-gradient(135deg, var(--info-color), #3b82f6) !important;
        color: white !important;
    }

    .modern-btn-primary:hover {
        background: linear-gradient(135deg, #1d4ed8, var(--info-color)) !important;
        color: white !important;
    }
    
    /* Make anchor tags look like buttons */
    .modern-btn-primary {
        text-decoration: none !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .modern-btn-warning {
        background: linear-gradient(135deg, var(--warning-color), #f59e0b) !important;
        color: white !important;
    }

    .modern-btn-warning:hover {
        background: linear-gradient(135deg, #b45309, var(--warning-color)) !important;
        color: white !important;
    }

    .modern-btn-info {
        background: linear-gradient(135deg, #0891b2, #06b6d4) !important;
        color: white !important;
    }

    .modern-btn-info:hover {
        background: linear-gradient(135deg, #0e7490, #0891b2) !important;
        color: white !important;
    }

    /* SLA Indicator Styling */
    .sla-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .sla-icon {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .sla-text {
        font-weight: 600;
        font-size: 0.8rem;
    }

    .text-success { color: var(--sla-good) !important; }
    .text-warning { color: var(--sla-warning) !important; }
    .text-danger { color: var(--sla-danger) !important; }
    .text-secondary { color: var(--sla-neutral) !important; }
    
    /* Vehicle/Marca Styling - Using the same blue as etapa badge */
    .text-vehicle {
        color: #3b82f6 !important;
        font-weight: 600 !important;
    }
    
    .text-vehicle i {
        color: #3b82f6 !important;
    }
    
    /* Instruction Section Styling - Tailwind-inspired */
    .bg-blue-50 {
        background-color: #eff6ff !important;
    }
    
    .border-blue-200 {
        border-color: #bfdbfe !important;
    }
    
    .text-blue-600 {
        color: #2563eb !important;
    }
    
    .text-blue-800 {
        color: #1e40af !important;
    }
    
    .text-blue-900 {
        color: #1e3a8a !important;
    }
    
    .bg-blue-100 {
        background-color: #dbeafe !important;
    }
    
    .bg-green-100 {
        background-color: #dcfce7 !important;
    }
    
    .text-green-800 {
        color: #166534 !important;
    }
    
    .space-y-1 > * + * {
        margin-top: 0.25rem !important;
    }
    
    .space-x-3 > * + * {
        margin-left: 0.75rem !important;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Link Styling */
    .modern-link {
        color: var(--primary-color) !important;
        text-decoration: none !important;
        font-weight: 600;
        transition: color 0.2s ease;
    }

    .modern-link:hover {
        color: var(--primary-hover) !important;
        text-decoration: underline !important;
    }

    /* Text Styling */
    .text-muted { color: var(--text-muted) !important; }
    .text-secondary { color: var(--text-secondary) !important; }
    .text-primary { color: var(--text-primary) !important; }

    /* Code Styling */
    code {
        background: linear-gradient(135deg, #f1f5f9, #e2e8f0) !important;
        color: var(--text-primary) !important;
        padding: 4px 8px !important;
        border-radius: 4px !important;
        font-size: 0.8rem !important;
        font-weight: 600 !important;
    }

    /* Dropdown Styling */
    .modern-dropdown {
        position: relative !important;
        z-index: 1000 !important;
    }
    
    .modern-dropdown .dropdown-toggle {
        background: var(--card-background) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-primary) !important;
        border-radius: var(--border-radius-sm) !important;
        box-shadow: var(--shadow-sm) !important;
        transition: all 0.2s ease !important;
    }

    .modern-dropdown .dropdown-toggle:hover {
        border-color: var(--primary-color) !important;
        box-shadow: var(--shadow-md) !important;
    }

    .modern-dropdown .dropdown-menu {
        border: 1px solid var(--border-color) !important;
        border-radius: var(--border-radius-sm) !important;
        box-shadow: var(--shadow-lg) !important;
        background: var(--card-background) !important;
        z-index: 99999 !important;
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        min-width: 300px !important;
        max-height: 400px !important;
        overflow-y: auto !important;
    }

    .modern-dropdown .dropdown-item {
        color: var(--text-primary) !important;
        padding: 8px 16px !important;
        transition: all 0.2s ease !important;
    }

    .modern-dropdown .dropdown-item:hover {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light)) !important;
        color: white !important;
    }

    /* Empty State Styling */
    .empty-state {
        padding: 40px 20px !important;
        text-align: center !important;
        color: var(--text-muted) !important;
    }

    .empty-state i {
        font-size: 3rem !important;
        margin-bottom: 16px !important;
        opacity: 0.5 !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .modern-card {
            margin-bottom: 16px;
            border-radius: var(--border-radius-sm);
        }

        .modern-table tbody td {
            padding: 12px 16px !important;
            font-size: 0.8rem !important;
        }

        .modern-table thead th {
            padding: 12px 16px !important;
            font-size: 0.8rem !important;
        }

        .modern-btn {
            padding: 6px 8px !important;
            font-size: 0.7rem !important;
        }

        .btn-action-text {
            display: none;
        }

        .modern-btn .fas {
            margin-right: 0 !important;
        }

        .workflow-header .card-header {
            padding: 16px !important;
        }
    }

    /* Override default Bootstrap styles */
    .card {
        border: none !important;
    }

    .table-responsive {
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        background: var(--card-background);
    }

    /* Animation for page load */
    .fade-in-up {
        animation: fadeInUp 0.6s ease-out;
    }

    /* Processed Requests Section Styling */
    #solicitudes-procesadas-content {
        background: var(--card-background);
    }

    #tabla-procesadas-container {
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--border-color);
    }

    .processed-status-badge {
        font-size: 0.7rem;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .processed-status-completada {
        background: linear-gradient(135deg, var(--success-color), #10b981);
        color: white;
    }

    .processed-status-rechazada {
        background: linear-gradient(135deg, var(--danger-color), #ef4444);
        color: white;
    }

    .processed-status-cancelada {
        background: linear-gradient(135deg, var(--text-muted), #6b7280);
        color: white;
    }

    .processed-date {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .processed-row {
        transition: all 0.2s ease;
    }

    .processed-row:hover {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9) !important;
        transform: translateY(-1px);
    }

    /* Pagination styling */
    .pagination-sm .page-link {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .pagination-sm .page-link:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .pagination-sm .page-item.active .page-link {
        background: var(--primary-color);
        border-color: var(--primary-color);
    }

    /* Loading animation */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.1em;
    }

    /* Filter dropdown styling */
    .dropdown-menu {
        border: none;
        box-shadow: var(--shadow-lg);
        border-radius: var(--border-radius-sm);
        background: var(--card-background);
    }

    .dropdown-item {
        padding: 8px 16px;
        font-size: 0.875rem;
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .dropdown-item:hover {
        background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
        color: white;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estilos específicos para sección de procesadas en Vista Mixta */
    .decision-badge {
        font-size: 0.7rem;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }
    
    .decision-aprobado {
        background: #d1fae5;
        color: #065f46;
    }
    
    .decision-rechazado {
        background: #fecaca;
        color: #991b1b;
    }
    
    .decision-observaciones {
        background: #fed7aa;
        color: #9a3412;
    }
    
    .decision-pendiente {
        background: #e5e7eb;
        color: #374151;
    }
    
    .btn-download-pdf {
        background: #dc2626;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .btn-download-pdf:hover {
        background: #b91c1c;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 38, 38, 0.2);
    }
    
    .btn-view-procesada {
        background: #2563eb;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
    }
    
    .btn-view-procesada:hover {
        background: #1d4ed8;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
        text-decoration: none;
    }
    
    /* Loading spinner */
    .loading-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="workflow-container mt-0 pt-0">
    <!-- Header Estático - Modern Design -->
    <div class="workflow-header card mb-3">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-white fw-bold">
                        <i class="fas fa-clipboard-list me-2"></i>
                        <span id="titulo-bandeja">
                            {% if etapa_seleccionada %}
                            {{ etapa_seleccionada.pipeline.nombre }} - {{ etapa_seleccionada.nombre }}
                            {% else %}
                            Vista Mixta
                            {% endif %}
                        </span>
                    </h1>
                    {% if etapa_seleccionada %}
                    <div class="mt-1">
                        <small class="text-white-50">
                            <i class="fas fa-users me-1"></i>
                            Bandeja grupal y tareas personales
                        </small>
                    </div>
                    {% else %}
                    <div class="mt-1">
                        <small class="text-white-50">
                            <i class="fas fa-info-circle me-1"></i>
                            Todas las etapas con bandeja grupal
                        </small>
                    </div>
                    {% endif %}
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Botón de Historial de Solicitudes Procesadas -->
                    <button id="btnHistorialProcesadasMixta" class="btn btn-outline-light btn-sm d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#modalSolicitudesProcesadasMixta">
                        <i class="fas fa-history"></i>
                        <span class="d-none d-md-inline">Historial</span>
                    </button>
                    
                    <!-- Selector de Etapas con Bandeja -->
                    <div class="dropdown modern-dropdown position-relative">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownEtapas"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-list me-1"></i>
                            Etapas con Bandeja
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownEtapas" style="z-index: 99999; position: absolute; top: 100%; left: 0; min-width: 300px; max-height: 400px; overflow-y: auto;">
                            {% if etapa_seleccionada %}
                            <li>
                                <a class="dropdown-item" href="{% url 'workflow:vista_mixta_bandejas' %}">
                                    <i class="fas fa-list me-2"></i>
                                    Ver todas las etapas
                                </a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            {% endif %}
                            {% for etapa in etapas_con_bandeja %}
                            <li>
                                <a class="dropdown-item" href="?etapa_id={{ etapa.id }}">
                                    <i class="fas fa-layer-group me-2"></i>
                                    {{ etapa.pipeline.nombre }} - {{ etapa.nombre }}
                                </a>
                            </li>
                            {% empty %}
                            <li><span class="dropdown-item-text text-muted">No hay etapas con bandeja habilitada</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>





    <!-- Vista de Supervisor/Superuser - Tabla Completa de Solicitudes -->
    {% if user.is_superuser or user.is_staff %}
    <div class="modern-card mb-3">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-white">
                    <i class="fas fa-chart-line me-2"></i>
                    Vista de Supervisor - Gestión Completa de Solicitudes
                </h5>
                <div class="d-flex gap-2">
                    <button type="button" class="modern-btn modern-btn-primary" id="toggle-supervisor-view">
                        <i class="fas fa-eye me-1"></i>Mostrar/Ocultar Vista Completa
                    </button>

                    <button type="button" class="modern-btn modern-btn-info" id="export-backoffice-data">
                        <i class="fas fa-file-excel me-1"></i>Exportar Back Office
                    </button>
                    {% if user.is_superuser %}
                    <button type="button" class="modern-btn modern-btn-warning" id="admin-backoffice-btn">
                        <i class="fas fa-cogs me-1"></i>Admin Back Office
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="card-body" id="supervisor-view-content" style="display: none;">
            <div class="modern-table-container table-responsive" style="max-height: 800px; overflow-y: auto;">
                <div class="table-responsive">
                    <table class="modern-table table table-hover mb-0" id="supervisor-table">
                        <thead>
                            <tr>
                                <th style="min-width: 180px;">
                                    <i class="fas fa-user me-1"></i>Cliente y Producto
                                </th>
                                <th style="min-width: 120px;">
                                    <i class="fas fa-layer-group me-1"></i>Pipeline
                                </th>
                                <th style="min-width: 100px;">
                                    <i class="fas fa-list me-1"></i>Etapa
                                </th>
                                <th style="min-width: 100px;">
                                    <i class="fas fa-user-check me-1"></i>Asignado a
                                </th>
                                <th style="min-width: 100px;">
                                    <i class="fas fa-clock me-1"></i>SLA
                                </th>
                                <th style="min-width: 120px;">
                                    <i class="fas fa-calendar me-1"></i>Fecha Creación
                                </th>
                                <th style="min-width: 120px;">
                                    <i class="fas fa-calendar-check me-1"></i>Última Actualización
                                </th>
                                <th style="min-width: 100px;">
                                    <i class="fas fa-dollar-sign me-1"></i>Monto
                                </th>
                                <th style="min-width: 120px;">
                                    <i class="fas fa-cogs me-1"></i>Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody id="supervisor-table-body">
                        {% for solicitud in solicitudes_grupales %}
                        <tr class="supervisor-row" data-solicitud-id="{{ solicitud.id }}" data-tipo="grupal"
                            data-cliente="{{ solicitud.cliente_nombre_completo }}" data-estado="{{ solicitud.estado_actual }}"
                            data-etapa="{{ solicitud.etapa_actual.nombre }}"
                            data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                            data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre_completo|lower }} {{ solicitud.cliente_cedula_completa|lower }}">
                            <td>
                                <div class="d-flex align-items-start">
                                    <div class="flex-grow-1">
                                        <a href="{% if solicitud.etapa_actual.nombre == 'Back Office' and solicitud.etapa_actual.es_bandeja_grupal %}{% url 'workflow:detalle_solicitud_backoffice' solicitud.id %}{% else %}{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}{% endif %}"
                                            class="text-decoration-none">
                                            <strong class="text-primary">{{ solicitud.cliente_nombre_completo|default:"Sin cliente" }}</strong>
                                        </a>
                                        <br><small class="text-muted">{{ solicitud.producto_descripcion|default:"Sin producto" }}</small>
                                        {% if solicitud.producto_descripcion == "Préstamo de Auto" and solicitud.cotizacion and solicitud.cotizacion.marca %}
                                        <br><small class="text-vehicle"><i class="fas fa-car me-1"></i>{{ solicitud.cotizacion.marca }} {{ solicitud.cotizacion.modelo|default:"" }}</small>
                                        {% endif %}
                                        <br><small class="text-muted">Bandeja Grupal</small>
                                    </div>
                                    {% if solicitud.es_reconsideracion and solicitud.etapa_actual and solicitud.etapa_actual.nombre in "Consulta,Comité de Crédito" %}
                                    <div class="ms-2">
                                        <span class="badge bg-warning text-dark" title="Solicitud en reconsideración">
                                            <i class="fas fa-redo-alt me-1"></i>Recons.
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ solicitud.pipeline.nombre }}</span>
                            </td>
                            <td>
                                <span class="badge-etapa modern-badge">{{ solicitud.etapa_actual.nombre }}</span>
                            </td>
                            <td>
                                <span class="badge bg-warning text-dark">Sin asignar</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-circle {{ solicitud.sla_color }}" style="font-size: 0.8rem;"></i>
                                    <span class="{{ solicitud.sla_color }} ms-1">{{ solicitud.sla_restante }}</span>
                                </div>
                            </td>
                            <td>
                                <small>{{ solicitud.fecha_creacion|date:"d/m/Y g:i A" }}</small>
                                <br><small class="text-info"><i class="fas fa-clock me-1"></i>En etapa desde: {{ solicitud.fecha_inicio_etapa|date:"d/m/Y g:i A"|default:"N/A" }}</small>
                            </td>
                            <td>
                                <small>{{ solicitud.fecha_ultima_actualizacion|date:"d/m/Y g:i A" }}</small>
                            </td>
                            <td>
                                <strong class="text-success">{{ solicitud.monto_formateado|default:"-" }}</strong>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-success btn-sm tomar-solicitud"
                                        data-solicitud-id="{{ solicitud.id }}"
                                        data-etapa-id="{{ solicitud.etapa_actual.id }}"
                                        data-codigo="{{ solicitud.codigo }}">
                                        <i class="fas fa-hand-paper"></i>
                                    </button>
                                    <button class="btn btn-primary btn-sm asignar-solicitud"
                                        data-solicitud-id="{{ solicitud.id }}"
                                        data-etapa-id="{{ solicitud.etapa_actual.id }}"
                                        data-codigo="{{ solicitud.codigo }}">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}

                        {% for solicitud in solicitudes_personales %}
                        <tr class="supervisor-row" data-solicitud-id="{{ solicitud.id }}" data-tipo="personal"
                            data-cliente="{{ solicitud.cliente_nombre_completo }}" data-estado="{{ solicitud.estado_actual }}"
                            data-etapa="{{ solicitud.etapa_actual.nombre }}"
                            data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                            data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre_completo|lower }} {{ solicitud.cliente_cedula_completa|lower }}">
                            <td>
                                <div class="d-flex align-items-start">
                                    <div class="flex-grow-1">
                                        <a href="{% if solicitud.etapa_actual.nombre == 'Back Office' and solicitud.etapa_actual.es_bandeja_grupal %}{% url 'workflow:detalle_solicitud_backoffice' solicitud.id %}{% else %}{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}{% endif %}"
                                            class="text-decoration-none">
                                            <strong class="text-primary">{{ solicitud.cliente_nombre_completo|default:"Sin cliente" }}</strong>
                                        </a>
                                        <br><small class="text-muted">{{ solicitud.producto_descripcion|default:"Sin producto" }}</small>
                                        {% if solicitud.producto_descripcion == "Préstamo de Auto" and solicitud.cotizacion and solicitud.cotizacion.marca %}
                                        <br><small class="text-vehicle"><i class="fas fa-car me-1"></i>{{ solicitud.cotizacion.marca }} {{ solicitud.cotizacion.modelo|default:"" }}</small>
                                        {% endif %}
                                        <br><small class="text-muted">Asignada</small>
                                    </div>
                                    {% if solicitud.es_reconsideracion and solicitud.etapa_actual and solicitud.etapa_actual.nombre in "Consulta,Comité de Crédito" %}
                                    <div class="ms-2">
                                        <span class="badge bg-warning text-dark" title="Solicitud en reconsideración">
                                            <i class="fas fa-redo-alt me-1"></i>Recons.
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ solicitud.pipeline.nombre }}</span>
                            </td>
                            <td>
                                <span class="badge-etapa modern-badge">{{ solicitud.etapa_actual.nombre }}</span>
                            </td>
                            <td>
                                <span class="badge bg-success">{{
                                    solicitud.asignada_a.get_full_name|default:solicitud.asignada_a.username }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-circle {{ solicitud.sla_color }}" style="font-size: 0.8rem;"></i>
                                    <span class="{{ solicitud.sla_color }} ms-1">{{ solicitud.sla_restante }}</span>
                                </div>
                            </td>
                            <td>
                                <small>{{ solicitud.fecha_creacion|date:"d/m/Y g:i A" }}</small>
                                <br><small class="text-info"><i class="fas fa-clock me-1"></i>En etapa desde: {{ solicitud.fecha_inicio_etapa|date:"d/m/Y g:i A"|default:"N/A" }}</small>
                            </td>
                            <td>
                                <small>{{ solicitud.fecha_ultima_actualizacion|date:"d/m/Y g:i A" }}</small>
                            </td>
                            <td>
                                <strong class="text-success">{{ solicitud.monto_formateado|default:"-" }}</strong>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if solicitud.asignada_a == user %}
                                    <button class="btn btn-warning btn-sm devolver-solicitud"
                                        data-solicitud-id="{{ solicitud.id }}"
                                        data-codigo="{{ solicitud.codigo }}">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>

            <!-- Estadísticas de la Vista de Supervisor -->
            <div class="card-footer bg-light">
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-clipboard-list text-info me-2"></i>
                            <div>
                                <strong class="d-block" id="supervisor-total-count">{{
                                    solicitudes_grupales|length|add:solicitudes_personales|length }}</strong>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-users text-primary me-2"></i>
                            <div>
                                <strong class="d-block">{{ solicitudes_grupales|length }}</strong>
                                <small class="text-muted">Bandeja Grupal</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-user-check text-success me-2"></i>
                            <div>
                                <strong class="d-block">{{ solicitudes_personales|length }}</strong>
                                <small class="text-muted">Asignadas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <div>
                                <strong class="d-block">{{ por_vencer }}</strong>
                                <small class="text-muted">Por Vencer</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <div>
                                <strong class="d-block" id="supervisor-vencidas-count">0</strong>
                                <small class="text-muted">Vencidas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <div>
                                <strong class="d-block">{{ en_tiempo }}</strong>
                                <small class="text-muted">En Tiempo</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Contenedor de Bandejas -->
    <div id="contenedor-bandejas">
        <!-- Filtros Modernos -->
        <div class="modern-card mb-3">
            <div class="card-body py-3">
                <div class="row g-3 align-items-center">
                    <div class="col-6 col-md-3">
                        <select id="filtroEstado" class="form-select form-select-sm modern-dropdown">
                            <option value="">Todos los estados</option>
                            {% for estado in estados_unicos %}
                            <option value="{{ estado }}">{{ estado }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <select id="filtroSLA" class="form-select form-select-sm modern-dropdown">
                            <option value="">Todos los SLA</option>
                            <option value="en_tiempo">En tiempo</option>
                            <option value="por_vencer">Por vencer</option>
                            <option value="vencido">Vencido</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-5">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text modern-dropdown">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" id="busquedaGlobal" class="form-control form-control-sm modern-dropdown"
                                placeholder="Buscar por cliente...">
                        </div>
                    </div>
                    <div class="col-12 col-md-1">
                        <button type="button" class="modern-btn modern-btn-info w-100" id="limpiarFiltros">
                            <i class="fas fa-filter-circle-xmark"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Leyenda SLA Compacta -->
                <div class="d-flex align-items-center mt-2 pt-2" style="border-top: 1px solid var(--border-color);">
                    <small class="text-muted" style="font-size: 0.75rem;">
                        <i class="fas fa-info-circle me-1"></i>Leyenda SLA:
                        <span class="ms-2">
                            <span class="sla-icon text-success me-1"></span>En tiempo
                        </span>
                        <span class="ms-2">
                            <span class="sla-icon text-warning me-1"></span>Por vencer
                        </span>
                        <span class="ms-2">
                            <span class="sla-icon text-danger me-1"></span>Vencido
                        </span>
                    </small>
                </div>
            </div>
        </div>

        <!-- Vista Mixta (Default) -->
        <div id="vista-mixta" class="vista-bandeja">
            <div class="row">
                <!-- Bandeja Grupal -->
                <div class="col-md-6">
                    <div class="modern-card">
                        <div class="card-header">
                            <h5 class="mb-0 text-white">
                                <i class="fas fa-users me-2"></i>
                                {% if etapa_seleccionada %}
                                Bandeja Grupal - {{ etapa_seleccionada.nombre }}
                                {% else %}
                                Bandeja Grupal
                                {% endif %}
                                <span class="badge bg-light text-dark ms-2">{{ solicitudes_grupales|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="modern-table-container table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="modern-table table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Cliente y Producto</th>
                                            <th>Etapa</th>
                                            <th>SLA</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-grupal">
                                        {% for solicitud in solicitudes_grupales %}
                                        <tr id="solicitud-grupal-{{ solicitud.id }}" class="solicitud-row"
                                            data-cliente="{{ solicitud.cliente_nombre_completo }}"
                                            data-estado="{{ solicitud.estado_actual }}"
                                            data-etapa="{{ solicitud.etapa_actual.nombre }}"
                                            data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                                            data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre_completo|lower }} {{ solicitud.cliente_cedula_completa|lower }}">
                                            <td>
                                                <div class="d-flex align-items-start">
                                                    <div class="flex-grow-1">
                                                        <a href="{% if solicitud.etapa_actual.nombre == 'Back Office' and solicitud.etapa_actual.es_bandeja_grupal %}{% url 'workflow:detalle_solicitud_backoffice' solicitud.id %}{% else %}{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}{% endif %}"
                                                            class="modern-link">
                                                            <strong>{{ solicitud.cliente_nombre_completo|default:"Sin cliente" }}</strong>
                                                        </a>
                                                        <br><small class="text-muted">{{ solicitud.producto_descripcion|default:"Sin producto" }}</small>
                                                        {% if solicitud.producto_descripcion == "Préstamo de Auto" and solicitud.cotizacion and solicitud.cotizacion.marca %}
                                                        <br><small class="text-vehicle"><i class="fas fa-car me-1"></i>{{ solicitud.cotizacion.marca }} {{ solicitud.cotizacion.modelo|default:"" }}</small>
                                                        {% endif %}
                                                        <br><small class="text-muted">Creada: {{ solicitud.fecha_creacion|date:"d/m/Y" }}</small>
                                                        <br><small class="text-info"><i class="fas fa-clock me-1"></i>En etapa desde: {{ solicitud.fecha_inicio_etapa|date:"d/m/Y g:i A"|default:"N/A" }}</small>
                                                    </div>
                                                    {% if solicitud.es_reconsideracion and solicitud.etapa_actual and solicitud.etapa_actual.nombre in "Consulta,Comité de Crédito" %}
                                                    <div class="ms-2">
                                                        <span class="badge bg-warning text-dark" title="Solicitud en reconsideración">
                                                            <i class="fas fa-redo-alt me-1"></i>Recons.
                                                        </span>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge-etapa modern-badge">{{ solicitud.etapa_actual.nombre }}</span>
                                            </td>
                                            <td>
                                                <div class="sla-indicator">
                                                    <div class="sla-icon {{ solicitud.sla_color }}"></div>
                                                    <span class="sla-text {{ solicitud.sla_color }}">{{ solicitud.sla_restante }}</span>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="modern-btn-group">
                                                    <button class="modern-btn modern-btn-success tomar-solicitud"
                                                        data-solicitud-id="{{ solicitud.id }}"
                                                        data-etapa-id="{{ solicitud.etapa_actual.id }}"
                                                        data-codigo="{{ solicitud.codigo }}">
                                                        <i class="fas fa-hand-paper me-1"></i><span
                                                            class="btn-action-text">Tomar</span>
                                                    </button>
                                                    {% if solicitud.etapa_actual.nombre == 'Back Office' %}
                                                    <button class="modern-btn modern-btn-info ver-pendientes-backoffice"
                                                        data-solicitud-id="{{ solicitud.id }}"
                                                        data-codigo="{{ solicitud.codigo }}"
                                                        title="Ver documentos pendientes">
                                                        <i class="fas fa-clipboard-list me-1"></i><span class="btn-action-text">Pendientes</span>
                                                    </button>
                                                    {% endif %}
                                                    {% if user.is_superuser or user.is_staff %}
                                                    <button class="modern-btn modern-btn-primary asignar-solicitud"
                                                        data-solicitud-id="{{ solicitud.id }}"
                                                        data-etapa-id="{{ solicitud.etapa_actual.id }}"
                                                        data-codigo="{{ solicitud.codigo }}">
                                                        <i class="fas fa-user-plus me-1"></i><span
                                                            class="btn-action-text">Asignar</span>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="4" class="empty-state">
                                                <i class="fas fa-inbox"></i>
                                                <br>No hay solicitudes en bandeja grupal
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bandeja Personal -->
                <div class="col-md-6">
                    <div class="modern-card">
                        <div class="card-header">
                            <h5 class="mb-0 text-white">
                                <i class="fas fa-user me-2"></i>
                                Mis Tareas
                                {% if etapa_seleccionada %}
                                <small class="text-white-50 ms-2">({{ etapa_seleccionada.nombre }})</small>
                                {% endif %}
                                <span class="badge bg-light text-dark ms-2">{{ solicitudes_personales|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="modern-table-container table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="modern-table table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Cliente y Producto</th>
                                            <th>Etapa</th>
                                            <th>SLA</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-personal">
                                        {% for solicitud in solicitudes_personales %}
                                        <tr id="solicitud-personal-{{ solicitud.id }}" class="solicitud-row"
                                            data-cliente="{{ solicitud.cliente_nombre_completo }}"
                                            data-estado="{{ solicitud.estado_actual }}"
                                            data-etapa="{{ solicitud.etapa_actual.nombre }}"
                                            data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                                            data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre_completo|lower }} {{ solicitud.cliente_cedula_completa|lower }}">
                                            <td>
                                                <div class="d-flex align-items-start">
                                                    <div class="flex-grow-1">
                                                        <a href="{% if solicitud.etapa_actual.nombre == 'Back Office' and solicitud.etapa_actual.es_bandeja_grupal %}{% url 'workflow:detalle_solicitud_backoffice' solicitud.id %}{% else %}{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}{% endif %}"
                                                            class="modern-link">
                                                            <strong>{{ solicitud.cliente_nombre_completo|default:"Sin cliente" }}</strong>
                                                        </a>
                                                        <br><small class="text-muted">{{ solicitud.producto_descripcion|default:"Sin producto" }}</small>
                                                        {% if solicitud.producto_descripcion == "Préstamo de Auto" and solicitud.cotizacion and solicitud.cotizacion.marca %}
                                                        <br><small class="text-vehicle"><i class="fas fa-car me-1"></i>{{ solicitud.cotizacion.marca }} {{ solicitud.cotizacion.modelo|default:"" }}</small>
                                                        {% endif %}
                                                        <br><small class="text-muted">Creada: {{ solicitud.fecha_creacion|date:"d/m/Y" }}</small>
                                                        <br><small class="text-info"><i class="fas fa-clock me-1"></i>En etapa desde: {{ solicitud.fecha_inicio_etapa|date:"d/m/Y g:i A"|default:"N/A" }}</small>
                                                    </div>
                                                    {% if solicitud.es_reconsideracion and solicitud.etapa_actual and solicitud.etapa_actual.nombre in "Consulta,Comité de Crédito" %}
                                                    <div class="ms-2">
                                                        <span class="badge bg-warning text-dark" title="Solicitud en reconsideración">
                                                            <i class="fas fa-redo-alt me-1"></i>Recons.
                                                        </span>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge-etapa modern-badge">{{ solicitud.etapa_actual.nombre }}</span>
                                                
                                                <!-- Etiqueta de asignación -->
                                                <br>
                                                {% if solicitud.asignada_a %}
                                                <span class="badge bg-info text-white">
                                                    <i class="fas fa-user me-1"></i>{{ solicitud.asignada_a.get_full_name|default:solicitud.asignada_a.username }}
                                                </span>
                                                {% else %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-user-slash me-1"></i>Sin asignar
                                                </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="sla-indicator">
                                                    <div class="sla-icon {{ solicitud.sla_color }}"></div>
                                                    <span class="sla-text {{ solicitud.sla_color }}">{{ solicitud.sla_restante }}</span>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="modern-btn-group">
                                                    <a href="{% if solicitud.etapa_actual.nombre == 'Back Office' and solicitud.etapa_actual.es_bandeja_grupal %}{% url 'workflow:detalle_solicitud_backoffice' solicitud.id %}{% else %}{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}{% endif %}"
                                                        class="modern-btn modern-btn-primary">
                                                        <i class="fas fa-search me-1"></i><span class="btn-action-text">Analizar</span>
                                                    </a>
                                                    {% if solicitud.etapa_actual.nombre == 'Back Office' %}
                                                    <button class="modern-btn modern-btn-info ver-pendientes-backoffice"
                                                        data-solicitud-id="{{ solicitud.id }}"
                                                        data-codigo="{{ solicitud.codigo }}"
                                                        title="Ver documentos pendientes">
                                                        <i class="fas fa-clipboard-list me-1"></i><span class="btn-action-text">Pendientes</span>
                                                    </button>
                                                    {% endif %}
                                                    <button class="modern-btn modern-btn-warning devolver-solicitud"
                                                        data-solicitud-id="{{ solicitud.id }}"
                                                        data-codigo="{{ solicitud.codigo }}">
                                                        <i class="fas fa-undo me-1"></i><span class="btn-action-text">Devolver</span>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="4" class="empty-state">
                                                <i class="fas fa-inbox"></i>
                                                <br>No tienes tareas asignadas
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Solo Bandeja Grupal -->
        <div id="vista-grupal" class="vista-bandeja" style="display: none;">
            <div class="modern-card">
                <div class="card-header">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-users me-2"></i>
                        Bandeja Grupal
                        <span class="badge bg-light text-dark ms-2">{{ solicitudes_grupales|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="modern-table-container table-responsive" style="max-height: 700px; overflow-y: auto;">
                        <table class="modern-table table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Cliente y Producto</th>
                                    <th>Etapa</th>
                                    <th>Estado</th>
                                    <th>SLA</th>
                                    <th>Fecha Inicio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-grupal-expandida">
                                {% for solicitud in solicitudes_grupales %}
                                <tr class="solicitud-row" data-cliente="{{ solicitud.cliente_nombre_completo }}"
                                    data-estado="{{ solicitud.estado_actual }}"
                                    data-etapa="{{ solicitud.etapa_actual.nombre }}"
                                    data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                                    data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre_completo|lower }} {{ solicitud.cliente_cedula_completa|lower }}">
                                    <td>
                                        <div class="d-flex align-items-start">
                                            <div class="flex-grow-1">
                                                <a href="{% if solicitud.etapa_actual.nombre == 'Back Office' and solicitud.etapa_actual.es_bandeja_grupal %}{% url 'workflow:detalle_solicitud_backoffice' solicitud.id %}{% else %}{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}{% endif %}"
                                                    class="modern-link">
                                                    <strong>{{ solicitud.cliente_nombre_completo|default:"Sin cliente" }}</strong>
                                                </a>
                                                <br><small class="text-muted">{{ solicitud.producto_descripcion|default:"Sin producto" }}</small>
                                                {% if solicitud.producto_descripcion == "Préstamo de Auto" and solicitud.cotizacion and solicitud.cotizacion.marca %}
                                                <br><small class="text-vehicle"><i class="fas fa-car me-1"></i>{{ solicitud.cotizacion.marca }} {{ solicitud.cotizacion.modelo|default:"" }}</small>
                                                {% endif %}
                                                <br><small class="text-muted">Creada: {{ solicitud.fecha_creacion|date:"d/m/Y" }}</small>
                                                <br><small class="text-info">En etapa desde: {{ solicitud.fecha_inicio_etapa|date:"d/m/Y g:i A"|default:"N/A" }}</small>
                                            </div>
                                            {% if solicitud.es_reconsideracion and solicitud.etapa_actual and solicitud.etapa_actual.nombre in "Consulta,Comité de Crédito" %}
                                            <div class="ms-2">
                                                <span class="badge bg-warning text-dark" title="Solicitud en reconsideración">
                                                    <i class="fas fa-redo-alt me-1"></i>Recons.
                                                </span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td><span class="badge-etapa modern-badge">{{ solicitud.etapa_actual.nombre }}</span></td>
                                    <td><span class="modern-badge" style="background: linear-gradient(135deg, var(--text-secondary), var(--text-muted)); color: white;">{{ solicitud.estado_actual }}</span></td>
                                    <td>
                                        <div class="sla-indicator">
                                            <div class="sla-icon {{ solicitud.sla_color }}"></div>
                                            <span class="sla-text {{ solicitud.sla_color }}">{{ solicitud.sla_restante }}</span>
                                        </div>
                                    </td>
                                    <td><small class="text-muted">{{ solicitud.fecha_inicio_etapa|date:"d/m/Y g:i A"|default:"N/A" }}</small></td>
                                    <td>
                                        <div class="modern-btn-group">
                                            <button class="modern-btn modern-btn-success tomar-solicitud"
                                                data-solicitud-id="{{ solicitud.id }}"
                                                data-etapa-id="{{ solicitud.etapa_actual.id }}"
                                                data-codigo="{{ solicitud.codigo }}">
                                                <i class="fas fa-hand-paper me-1"></i><span
                                                    class="btn-action-text">Tomar</span>
                                            </button>
                                            {% if user.is_superuser or user.is_staff %}
                                            <button class="modern-btn modern-btn-primary asignar-solicitud"
                                                data-solicitud-id="{{ solicitud.id }}"
                                                data-etapa-id="{{ solicitud.etapa_actual.id }}"
                                                data-codigo="{{ solicitud.codigo }}">
                                                <i class="fas fa-user-plus me-1"></i><span
                                                    class="btn-action-text">Asignar</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <br>No hay solicitudes en bandeja grupal
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Solo Bandeja Personal -->
        <div id="vista-personal" class="vista-bandeja" style="display: none;">
            <div class="modern-card">
                <div class="card-header">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-user me-2"></i>
                        Mis Tareas
                        <span class="badge bg-light text-dark ms-2">{{ solicitudes_personales|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="modern-table-container table-responsive" style="max-height: 700px; overflow-y: auto;">
                        <table class="modern-table table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Cliente y Producto</th>
                                    <th>Etapa</th>
                                    <th>Estado</th>
                                    <th>SLA</th>
                                    <th>Fecha Inicio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-personal-expandida">
                                {% for solicitud in solicitudes_personales %}
                                <tr class="solicitud-row" data-cliente="{{ solicitud.cliente_nombre_completo }}"
                                    data-estado="{{ solicitud.estado_actual }}"
                                    data-etapa="{{ solicitud.etapa_actual.nombre }}"
                                    data-sla="{% if solicitud.sla_color == 'text-danger' %}vencido{% elif solicitud.sla_color == 'text-warning' %}por_vencer{% else %}en_tiempo{% endif %}"
                                    data-search="{{ solicitud.codigo|lower }} {{ solicitud.cliente_nombre_completo|lower }} {{ solicitud.cliente_cedula_completa|lower }}">
                                    <td>
                                        <div class="d-flex align-items-start">
                                            <div class="flex-grow-1">
                                                <a href="{% if solicitud.etapa_actual.nombre == 'Back Office' and solicitud.etapa_actual.es_bandeja_grupal %}{% url 'workflow:detalle_solicitud_backoffice' solicitud.id %}{% else %}{% url 'workflow:detalle_solicitud_analisis' solicitud.id %}{% endif %}"
                                                    class="modern-link">
                                                    <strong>{{ solicitud.cliente_nombre_completo|default:"Sin cliente" }}</strong>
                                                </a>
                                                <br><small class="text-muted">{{ solicitud.producto_descripcion|default:"Sin producto" }}</small>
                                                {% if solicitud.producto_descripcion == "Auto" and solicitud.cotizacion and solicitud.cotizacion.marca %}
                                                <br><small class="text-vehicle"><i class="fas fa-car me-1"></i>{{ solicitud.cotizacion.marca }} {{ solicitud.cotizacion.modelo|default:"" }}</small>
                                                {% endif %}
                                                <br><small class="text-muted">Creada: {{ solicitud.fecha_creacion|date:"d/m/Y" }}</small>
                                                <br><small class="text-info">En etapa desde: {{ solicitud.fecha_inicio_etapa|date:"d/m/Y g:i A"|default:"N/A" }}</small>
                                            </div>
                                            {% if solicitud.es_reconsideracion and solicitud.etapa_actual and solicitud.etapa_actual.nombre in "Consulta,Comité de Crédito" %}
                                            <div class="ms-2">
                                                <span class="badge bg-warning text-dark" title="Solicitud en reconsideración">
                                                    <i class="fas fa-redo-alt me-1"></i>Recons.
                                                </span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td><span class="badge-etapa modern-badge">{{ solicitud.etapa_actual.nombre }}</span></td>
                                    <td><span class="modern-badge" style="background: linear-gradient(135deg, var(--text-secondary), var(--text-muted)); color: white;">{{ solicitud.estado_actual }}</span></td>
                                    <td>
                                        <div class="sla-indicator">
                                            <div class="sla-icon {{ solicitud.sla_color }}"></div>
                                            <span class="sla-text {{ solicitud.sla_color }}">{{ solicitud.sla_restante }}</span>
                                        </div>
                                    </td>
                                    <td><small class="text-muted">{{ solicitud.fecha_inicio_etapa|date:"d/m/Y g:i A"|default:"N/A" }}</small></td>
                                    <td>
                                        <div class="modern-btn-group">
                                            <button class="modern-btn modern-btn-warning devolver-solicitud"
                                                data-solicitud-id="{{ solicitud.id }}"
                                                data-codigo="{{ solicitud.codigo }}">
                                                <i class="fas fa-undo me-1"></i><span
                                                    class="btn-action-text">Devolver</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <br>No tienes tareas asignadas
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Modernos - Inspirados en APC Tracking -->
    <div class="mt-3" id="kpis-section">
        <div class="py-3">
            <div class="row g-4">
                <div class="col-3">
                    <div class="kpi-card-modern kpi-total">
                        <div class="kpi-icon-modern">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="kpi-content-modern">
                            <p class="kpi-label-modern">Total</p>
                            <h4 class="kpi-number-modern" id="kpi-total-grupo">{{ total_grupo }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-modern kpi-activas">
                        <div class="kpi-icon-modern">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="kpi-content-modern">
                            <p class="kpi-label-modern">Activas</p>
                            <h4 class="kpi-number-modern" id="kpi-mis-tareas">{{ mis_tareas }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-modern kpi-completadas">
                        <div class="kpi-icon-modern">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="kpi-content-modern">
                            <p class="kpi-label-modern">Bandeja Grupal</p>
                            <h4 class="kpi-number-modern" id="kpi-grupales">{{ solicitudes_grupales|length }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="kpi-card-modern kpi-vencidas">
                        <div class="kpi-icon-modern">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="kpi-content-modern">
                            <p class="kpi-label-modern">Vencidas</p>
                            <h4 class="kpi-number-modern" id="kpi-vencidas">{{ vencidas }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs por Subestado -->
    <div class="mt-4" id="kpis-subestado-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 text-dark fw-bold">
                <i class="fas fa-chart-bar me-2"></i>
                KPIs por Subestado
            </h5>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="actualizarKPIsSubestado()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Actualizar
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleKPIsSubestado()">
                    <i class="fas fa-eye me-1" id="toggle-kpis-icon"></i>
                    <span id="toggle-kpis-text">Ocultar</span>
                </button>
            </div>
        </div>
        
        <div id="kpis-subestado-container">
            <div class="row g-3">
                <div class="col-2">
                    <div class="kpi-card-modern kpi-activas">
                        <div class="kpi-icon-modern">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="kpi-content-modern">
                            <p class="kpi-label-modern">Checklist</p>
                            <h4 class="kpi-number-modern" id="kpi-checklist">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-2">
                    <div class="kpi-card-modern kpi-completadas">
                        <div class="kpi-icon-modern">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="kpi-content-modern">
                            <p class="kpi-label-modern">Captura</p>
                            <h4 class="kpi-number-modern" id="kpi-captura">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-2">
                    <div class="kpi-card-modern kpi-vencidas">
                        <div class="kpi-icon-modern">
                            <i class="fas fa-signature"></i>
                        </div>
                        <div class="kpi-content-modern">
                            <p class="kpi-label-modern">Firma</p>
                            <h4 class="kpi-number-modern" id="kpi-firma">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-2">
                    <div class="kpi-card-modern kpi-warning">
                        <div class="kpi-icon-modern">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <div class="kpi-content-modern">
                            <p class="kpi-label-modern">Orden Expediente</p>
                            <h4 class="kpi-number-modern" id="kpi-orden">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-2">
                    <div class="kpi-card-modern kpi-info">
                        <div class="kpi-icon-modern">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="kpi-content-modern">
                            <p class="kpi-label-modern">Trámite</p>
                            <h4 class="kpi-number-modern" id="kpi-tramite">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-2">
                    <div class="kpi-card-modern kpi-danger">
                        <div class="kpi-icon-modern">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="kpi-content-modern">
                            <p class="kpi-label-modern">Subsanación</p>
                            <h4 class="kpi-number-modern" id="kpi-subsanacion">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Instrucciones Compactas para el Usuario -->
<div class="mt-4 mb-3">
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start space-x-3">
            <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-info-circle text-blue-600 text-sm"></i>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <h6 class="text-sm font-semibold text-blue-900 mb-2">
                    <i class="fas fa-lightbulb me-1"></i>Guía Rápida
                </h6>
                <div class="text-sm text-blue-800 space-y-1">
                    <p class="mb-1">
                        <i class="fas fa-mouse-pointer me-1"></i>
                        <strong>Ver detalles:</strong> Haz clic en el <span class="text-blue-600 font-medium">nombre del cliente</span> para ver la solicitud completa
                    </p>
                    <p class="mb-1">
                        <i class="fas fa-hand-paper me-1"></i>
                        <strong>Tomar solicitud:</strong> Usa el botón <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">Tomar</span> para asignártela
                    </p>
                    <p class="mb-0">
                        <i class="fas fa-user-plus me-1"></i>
                        <strong>Asignar a otro:</strong> Usa el botón <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">Asignar</span> para delegar a otro usuario
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Solicitudes Procesadas -->
    <div class="mt-4 mb-3">
        <div class="modern-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white d-flex align-items-center">
                        <i class="fas fa-history me-2"></i>
                        Solicitudes Procesadas
                        {% if user.is_staff or user.is_superuser %}
                        <span class="badge bg-warning text-dark ms-2">
                            <i class="fas fa-eye me-1"></i>Supervisor
                        </span>
                        {% endif %}
                        <span class="badge bg-light text-dark ms-2" id="badge-procesadas">0</span>
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-light" id="toggle-procesadas" onclick="toggleSolicitudesProcesadas()">
                            <i class="fas fa-eye me-1"></i>
                            <span id="text-toggle-procesadas">Mostrar</span>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-filter me-1"></i>
                                Filtrar
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="filtrarProcesadas('todas')">
                                    <i class="fas fa-list me-1"></i>Todas
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="filtrarProcesadas('ultima_semana')">
                                    <i class="fas fa-calendar-week me-1"></i>Última semana
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="filtrarProcesadas('ultimo_mes')">
                                    <i class="fas fa-calendar-alt me-1"></i>Último mes
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="filtrarProcesadas('completadas')">
                                    <i class="fas fa-check-circle text-success me-1"></i>Completadas
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="filtrarProcesadas('rechazadas')">
                                    <i class="fas fa-times-circle text-danger me-1"></i>Rechazadas
                                </a></li>
                                {% if user.is_staff or user.is_superuser %}
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">
                                    <i class="fas fa-crown text-warning me-1"></i>Vista Supervisor
                                </h6></li>
                                <li><a class="dropdown-item" href="#" onclick="filtrarProcesadas('por_usuario')">
                                    <i class="fas fa-users me-1"></i>Por usuario
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="filtrarProcesadas('por_pipeline')">
                                    <i class="fas fa-project-diagram me-1"></i>Por pipeline
                                </a></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body" id="solicitudes-procesadas-content" style="display: none;">
                <div id="loading-procesadas" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando solicitudes procesadas...</p>
                </div>
                
                <div id="tabla-procesadas-container" class="modern-table-container table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="modern-table table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: {% if user.is_staff or user.is_superuser %}12%{% else %}15%{% endif %};">
                                    <i class="fas fa-hashtag me-1"></i>
                                    Código
                                </th>
                                <th style="width: {% if user.is_staff or user.is_superuser %}20%{% else %}25%{% endif %};">
                                    <i class="fas fa-user me-1"></i>
                                    Cliente
                                </th>
                                {% if user.is_staff or user.is_superuser %}
                                <th style="width: 15%;">
                                    <i class="fas fa-project-diagram me-1"></i>
                                    Pipeline
                                </th>
                                <th style="width: 12%;">
                                    <i class="fas fa-user-tie me-1"></i>
                                    Procesado por
                                </th>
                                {% endif %}
                                <th style="width: {% if user.is_staff or user.is_superuser %}12%{% else %}15%{% endif %};">
                                    <i class="fas fa-tasks me-1"></i>
                                    Etapa Final
                                </th>
                                <th style="width: {% if user.is_staff or user.is_superuser %}12%{% else %}15%{% endif %};">
                                    <i class="fas fa-calendar me-1"></i>
                                    Fecha Procesada
                                </th>
                                <th style="width: {% if user.is_staff or user.is_superuser %}8%{% else %}10%{% endif %};">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Estado
                                </th>
                                <th style="width: {% if user.is_staff or user.is_superuser %}9%{% else %}20%{% endif %};">
                                    <i class="fas fa-cogs me-1"></i>
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tabla-procesadas">
                            <!-- Se llenará dinámicamente con JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div id="empty-procesadas" class="empty-state text-center py-5" style="display: none;">
                    <i class="fas fa-inbox text-muted mb-3" style="font-size: 3rem;"></i>
                    <h6 class="text-muted">No hay solicitudes procesadas</h6>
                    {% if user.is_staff or user.is_superuser %}
                    <p class="text-muted small">No se encontraron solicitudes procesadas en el sistema</p>
                    {% else %}
                    <p class="text-muted small">Las solicitudes que hayas procesado aparecerán aquí</p>
                    {% endif %}
                </div>
                
                <!-- Información para supervisores -->
                {% if user.is_staff or user.is_superuser %}
                <div class="alert alert-info border-0 mt-3 mb-0" style="background: linear-gradient(135deg, #e7f3ff, #cce7ff); border-radius: 8px;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <div>
                            <strong>Vista Supervisor:</strong> 
                            <span class="text-muted">Puedes ver todas las solicitudes procesadas del sistema, incluyendo información del pipeline y quién las procesó.</span>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Paginación -->
                <div id="pagination-procesadas" class="d-flex justify-content-between align-items-center mt-3 pt-3" style="border-top: 1px solid var(--border-color); display: none !important;">
                    <div class="text-muted small">
                        Mostrando <span id="showing-from">1</span> a <span id="showing-to">10</span> de <span id="total-procesadas">0</span> solicitudes
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item" id="prev-page">
                                <a class="page-link" href="#" onclick="cambiarPaginaProcesadas('prev')">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            <li class="page-item active">
                                <span class="page-link" id="current-page">1</span>
                            </li>
                            <li class="page-item" id="next-page">
                                <a class="page-link" href="#" onclick="cambiarPaginaProcesadas('next')">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación Personalizado -->
<div class="modal fade" id="modalConfirmacionEtapa" tabindex="-1" aria-labelledby="modalConfirmacionEtapaLabel"
    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content"
            style="border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);">
            <!-- Header con gradiente verde -->
            <div class="modal-header"
                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; padding: 24px 32px 20px 32px; position: relative; overflow: hidden;">
                <div class="d-flex align-items-center w-100">
                    <div class="me-3">
                        <div
                            style="width: 50px; height: 50px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                            <i class="fas fa-exchange-alt text-white" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div>
                        <h4 class="modal-title text-white fw-bold mb-1" id="modalConfirmacionTitulo">Confirmar Acción
                        </h4>
                        <p class="text-white-50 mb-0" style="font-size: 0.9rem;">Sistema de Workflow</p>
                    </div>
                </div>
                <!-- Patrón decorativo -->
                <div
                    style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; transform: rotate(45deg);">
                </div>
            </div>

            <!-- Body con contenido estructurado -->
            <div class="modal-body" style="padding: 32px; background: linear-gradient(to bottom, #f8f9fa, #ffffff);">
                <!-- Pregunta principal -->
                <div class="text-center mb-4">
                    <div
                        style="width: 80px; height: 80px; background: linear-gradient(135deg, #e8f5e8, #d4edda); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                        <i class="fas fa-arrow-right text-success" style="font-size: 2rem;"></i>
                    </div>
                    <h5 class="fw-bold text-dark mb-2" id="modalConfirmacionPregunta">¿Está seguro de la acción?</h5>
                    <p class="text-muted mb-0" id="modalConfirmacionSubtitulo">Esta acción afectará el estado de la
                        solicitud</p>
                </div>

                <!-- Información destacada -->
                <div class="alert alert-success border-0 mb-4"
                    style="background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 12px;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle text-success me-2" style="font-size: 1.2rem;"></i>
                        <div>
                            <strong>Detalles:</strong> <span id="modalConfirmacionDetalle">Se procesará la
                                solicitud</span>
                        </div>
                    </div>
                </div>

                <!-- Información del proceso -->
                <div class="mb-4">
                    <h6 class="fw-bold text-dark mb-3">
                        <i class="fas fa-cogs text-primary me-2"></i>
                        Proceso automático que se ejecutará:
                    </h6>
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded-lg">
                                <i class="fas fa-database text-info me-2"></i>
                                <small class="text-muted">Se actualizará el estado de la solicitud</small>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded-lg">
                                <i class="fas fa-history text-warning me-2"></i>
                                <small class="text-muted">Se registrará en el historial del sistema</small>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded-lg">
                                <i class="fas fa-bell text-success me-2"></i>
                                <small class="text-muted">Se notificará a los usuarios correspondientes</small>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded-lg">
                                <i class="fas fa-sync text-secondary me-2"></i>
                                <small class="text-muted">Se sincronizará en tiempo real</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer con botones -->
            <div class="modal-footer border-0" style="padding: 20px 32px 32px; background: #ffffff;">
                <div class="w-100 d-flex gap-3">
                    <button type="button" class="btn btn-outline-secondary flex-fill py-2 fw-medium"
                        id="modalConfirmacionCancelar" style="border-radius: 10px;">
                        <i class="fas fa-times me-2"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-success flex-fill py-2 fw-medium" id="modalConfirmacionAceptar"
                        style="border-radius: 10px; background: linear-gradient(135deg, #28a745, #20c997); border: none;">
                        <i class="fas fa-check me-2"></i>
                        Aceptar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Detalle -->
<div class="modal fade" id="detalleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Solicitud</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detalle-contenido">
                    <!-- Contenido se carga dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Documentos Pendientes Back Office -->
<div class="modal fade" id="pendientesBackofficeModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-list me-2"></i>
                    Documentos Pendientes - Back Office
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="pendientes-loading" class="text-center py-4">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando documentos pendientes...</p>
                </div>
                
                <div id="pendientes-contenido" style="display: none;">
                    <!-- Header con información de la solicitud -->
                    <div class="alert alert-info border-0 mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">
                                    <strong>Solicitud:</strong> 
                                    <span id="pendientes-solicitud-codigo"></span>
                                </h6>
                                <small class="text-muted">
                                    Documentos NO OBLIGATORIOS que requieren atención
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-info fs-6" id="pendientes-contador">
                                    0 pendientes
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de documentos pendientes -->
                    <div id="pendientes-lista">
                        <!-- Se llena dinámicamente -->
                    </div>

                    <!-- Estado: Solicitud ya completa -->
                    <div id="pendientes-ya-completa" class="alert alert-success border-0" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-3 fs-4"></i>
                            <div>
                                <h6 class="mb-1">Solicitud Completa</h6>
                                <small class="text-muted">
                                    Esta solicitud ya fue marcada como completa. 
                                    Todos los documentos pendientes han sido revisados.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Sin documentos pendientes -->
                    <div id="pendientes-sin-documentos" class="text-center py-5" style="display: none;">
                        <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                        <h5 class="text-success">¡Excelente!</h5>
                        <p class="text-muted">No hay documentos pendientes para esta solicitud.</p>
                    </div>
                </div>

                <!-- Error state -->
                <div id="pendientes-error" style="display: none;">
                    <div class="alert alert-danger border-0">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle text-danger me-3"></i>
                            <div>
                                <h6 class="mb-1">Error al cargar documentos</h6>
                                <small id="pendientes-error-mensaje"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Asignar Solicitud -->
<div class="modal fade" id="modalAsignarSolicitud" tabindex="-1" aria-labelledby="modalAsignarSolicitudLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: #fff;">
                <h5 class="modal-title" id="modalAsignarSolicitudLabel">
                    <i class="fas fa-user-plus me-2"></i>
                    Asignar Solicitud
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert"
                    style="background: linear-gradient(90deg, #e0f2fe 0%, #f0fdfa 100%); color: #1e40af; border: none;">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Solicitud:</strong> <span id="asignar-codigo-solicitud"></span>
                    <br>
                    <strong>Etapa:</strong> <span id="asignar-etapa-solicitud"></span>
                </div>
                <div class="mb-3">
                    <h6 class="fw-bold" style="color: #009c3c;">
                        <i class="fas fa-users me-2"></i>
                        Usuarios con Acceso a esta Etapa:
                    </h6>

                    <!-- Barra de búsqueda -->
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"
                                style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none;">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="buscar-usuario-asignacion"
                                placeholder="Buscar por nombre, email, grupos o roles..." style="border-left: none;">
                            <button class="btn btn-outline-secondary" type="button" id="limpiar-busqueda-usuarios">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Busca por nombre, email, grupos o roles (Staff/Admin)
                        </small>
                    </div>

                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover table-striped" id="tabla-usuarios"
                            style="border-radius: 8px; overflow: hidden;">
                            <thead style="background: linear-gradient(90deg, #22a650 0%, #009c3c 100%); color: #fff;">
                                <tr>
                                    <th scope="col" style="width: 50px;">#</th>
                                    <th scope="col" style="width: 60px;">Avatar</th>
                                    <th scope="col">Usuario</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Grupos</th>
                                    <th scope="col" style="width: 120px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="lista-usuarios">
                                <!-- Lista de usuarios se carga dinámicamente -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Contador de resultados -->
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-users me-1"></i>
                            <span id="contador-usuarios">0</span> usuarios encontrados
                        </small>
                    </div>
                </div>
                <div id="asignar-loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando usuarios disponibles...</p>
                </div>
                <div id="asignar-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="asignar-error-mensaje"></span>
                </div>
            </div>
            <div class="modal-footer" style="background: #f0fdfa;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Solicitudes Procesadas para Vista Mixta -->
<div class="modal fade" id="modalSolicitudesProcesadasMixta" tabindex="-1" aria-labelledby="modalSolicitudesProcesadasMixtaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); color: white;">
                <h5 class="modal-title" id="modalSolicitudesProcesadasMixtaLabel">
                    <i class="fas fa-history me-2"></i>
                    Historial de Solicitudes Procesadas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Sección de Búsqueda dentro del modal -->
                <div class="p-3 border-bottom">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="position-relative">
                                <i class="fas fa-search position-absolute text-muted" style="left: 12px; top: 50%; transform: translateY(-50%);"></i>
                                <input type="text" 
                                       id="searchInputProcesadasMixta" 
                                       class="form-control ps-5" 
                                       placeholder="Buscar por cliente, cédula o código..."
                                       style="border-radius: 8px; padding: 0.75rem 1rem 0.75rem 2.5rem;">
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="text-muted">
                                <small>Total: <span id="totalProcesadasMixta">0</span> solicitudes</small>
                                <button id="btnRefrescarProcesadasMixta" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido principal del modal -->
                <div style="max-height: 70vh; overflow-y: auto;">
                    <!-- Vista de Escritorio: Tabla de Procesadas -->
                    <div class="d-none d-lg-block" id="tableProcesadasDesktopMixta">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 25%;">Cliente</th>
                                        <th style="width: 12%;">Monto</th>
                                        <th style="width: 10%;">Producto</th>
                                        <th style="width: 15%;">Decisión</th>
                                        <th style="width: 15%;">Etapa Actual</th>
                                        <th style="width: 12%;">Fecha</th>
                                        <th style="width: 11%;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tableProcesadasBodyMixta">
                                    <!-- Las filas se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Vista Móvil: Cards de Procesadas -->
                    <div class="d-block d-lg-none p-3" id="cardsProcesadasMobileMixta">
                        <div id="mobileCardsProcesadasContainerMixta" class="row g-3">
                            <!-- Las cards se cargarán dinámicamente -->
                        </div>
                    </div>

                    <!-- Estado de Carga para Procesadas -->
                    <div id="loadingStateProcesadasMixta" class="p-5 text-center" style="display: none;">
                        <div class="d-flex flex-column align-items-center">
                            <div class="loading-spinner"></div>
                            <p class="mt-3 text-muted mb-0">Cargando solicitudes procesadas...</p>
                        </div>
                    </div>

                    <!-- Estado Vacío para Procesadas -->
                    <div id="emptyStateProcesadasMixta" class="p-5 text-center" style="display: none;">
                        <i class="fas fa-clock fa-4x text-muted mb-3"></i>
                        <h5 class="text-secondary mb-2">No hay solicitudes procesadas</h5>
                        <p class="text-muted mb-3">Aún no se han procesado solicitudes por el Comité de Crédito.</p>
                        <button id="btnRefrescarEmptyProcesadasMixta" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-sync-alt me-1"></i>
                            Refrescar
                        </button>
                    </div>
                </div>
                
                <!-- Paginación en el footer del modal -->
                <div class="border-top p-3" id="paginationContainerProcesadasMixta">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="text-muted mb-0" id="rowCountProcesadasMixta">
                                <!-- Se actualizará dinámicamente -->
                            </p>
                        </div>
                        <div class="col-md-6">
                            <nav class="pagination-modern d-flex justify-content-end" id="paginationProcesadasMixta">
                                <!-- La paginación se generará dinámicamente -->
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast para notificaciones -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="notificacionToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-info-circle me-2 text-success"></i>
            <strong class="me-auto">Notificación</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <!-- Mensaje se establece dinámicamente -->
        </div>
    </div>
</div>

<!-- Asegurar que jQuery esté disponible -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
    // Función global para obtener token CSRF de las cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function () {

        // =====================================
        // MODAL DE CONFIRMACIÓN PERSONALIZADO
        // =====================================

        // Variables para manejar callbacks del modal
        let modalConfirmCallback = null;
        let modalCancelCallback = null;

        // Función para mostrar modal de confirmación
        window.mostrarModalConfirmacion = function (accion, onConfirm, onCancel, opciones) {
            // Opciones por defecto
            var configuracion = {
                titulo: 'Confirmar Acción',
                subtitulo: 'Sistema de Workflow',
                pregunta: '¿Está seguro de la acción?',
                descripcion: 'Esta acción afectará el estado de la solicitud',
                detalle: 'Se procesará la solicitud',
                iconoHeader: 'fas fa-exchange-alt',
                iconoCentral: 'fas fa-arrow-right'
            };

            // Personalizar según la acción
            if (accion === 'tomar') {
                configuracion.titulo = 'Tomar Solicitud';
                configuracion.pregunta = '¿Confirma que desea tomar esta solicitud?';
                configuracion.descripcion = 'La solicitud se asignará a su usuario';
                configuracion.detalle = 'Se asignará la solicitud a su usuario';
                configuracion.iconoHeader = 'fas fa-hand-paper';
                configuracion.iconoCentral = 'fas fa-user-check';
            } else if (accion === 'devolver') {
                configuracion.titulo = 'Devolver Solicitud';
                configuracion.pregunta = '¿Confirma que desea devolver esta solicitud?';
                configuracion.descripcion = 'La solicitud volverá a bandeja grupal';
                configuracion.detalle = 'Se devolverá la solicitud a bandeja grupal';
                configuracion.iconoHeader = 'fas fa-undo';
                configuracion.iconoCentral = 'fas fa-reply';
            }

            // Aplicar opciones personalizadas
            if (opciones) {
                Object.assign(configuracion, opciones);
            }

            // Actualizar el contenido del modal
            $('#modalConfirmacionTitulo').text(configuracion.titulo);
            $('#modalConfirmacionPregunta').text(configuracion.pregunta);
            $('#modalConfirmacionSubtitulo').text(configuracion.descripcion);
            $('#modalConfirmacionDetalle').text(configuracion.detalle);

            // Actualizar iconos
            $('#modalConfirmacionEtapa .modal-header i').removeClass().addClass(configuracion.iconoHeader + ' text-white');
            $('#modalConfirmacionEtapa .modal-body .text-center i').removeClass().addClass(configuracion.iconoCentral + ' text-success');

            // Guardar callbacks
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel || function () { };

            // Mostrar el modal
            var modal = new bootstrap.Modal(document.getElementById('modalConfirmacionEtapa'));
            modal.show();
        };

        // Event listeners para los botones del modal
        $('#modalConfirmacionAceptar').on('click', function () {
            if (modalConfirmCallback) {
                modalConfirmCallback();
            }
            bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionEtapa')).hide();
        });

        $('#modalConfirmacionCancelar').on('click', function () {
            if (modalCancelCallback) {
                modalCancelCallback();
            }
            bootstrap.Modal.getInstance(document.getElementById('modalConfirmacionEtapa')).hide();
        });

        // =====================================
        // NOTIFICACIONES TOAST PERSONALIZADAS
        // =====================================

        function mostrarNotificacionExito(mensaje) {
            console.log('✅ Mostrando notificación de éxito:', mensaje);

            // Crear toast personalizado
            var toastHTML = `
            <div class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" style="border-radius: 12px;">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        ${mensaje}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

            // Agregar al contenedor
            var toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            // Mostrar toast
            var toastElement = toastContainer.lastElementChild;
            var toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 4000
            });
            toast.show();

            // Remover elemento después de que se oculte
            toastElement.addEventListener('hidden.bs.toast', function () {
                this.remove();
            });
        }

        function mostrarNotificacionError(mensaje) {
            console.log('🚨 Mostrando notificación de error:', mensaje);

            // Crear toast personalizado
            var toastHTML = `
            <div class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" style="border-radius: 12px;">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${mensaje}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

            // Agregar al contenedor
            var toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            // Mostrar toast
            var toastElement = toastContainer.lastElementChild;
            var toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 5000
            });
            toast.show();

            // Remover elemento después de que se oculte
            toastElement.addEventListener('hidden.bs.toast', function () {
                this.remove();
            });
        }

        // Función específica para toast de asignación exitosa
        function mostrarToastExito(mensaje) {
            console.log('🎉 Mostrando toast de asignación exitosa:', mensaje);

            // Crear toast personalizado con diseño especial para asignación
            var toastHTML = `
            <div class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true" 
                 style="background: linear-gradient(135deg, #22a650 0%, #009c3c 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(34, 166, 80, 0.3);">
                <div class="d-flex">
                    <div class="toast-body d-flex align-items-center">
                        <i class="fas fa-user-plus me-2" style="font-size: 1.2em;"></i>
                        <div>
                            <strong style="font-size: 1.1em;">¡Asignación Exitosa!</strong><br>
                            <span style="font-size: 0.95em;">${mensaje}</span>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

            // Agregar al contenedor
            var toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            // Mostrar toast
            var toastElement = toastContainer.lastElementChild;
            var toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 4000
            });
            toast.show();

            // Remover elemento después de que se oculte
            toastElement.addEventListener('hidden.bs.toast', function () {
                this.remove();
            });
        }

        // Función para aplicar filtros
        function aplicarFiltros() {
            const filtroEstado = document.getElementById('filtroEstado').value.toLowerCase();
            const filtroSLA = document.getElementById('filtroSLA').value;
            const busqueda = document.getElementById('busquedaGlobal').value.toLowerCase();

            const filas = document.querySelectorAll('.solicitud-row');
            const supervisorFilas = document.querySelectorAll('.supervisor-row');

            // Aplicar filtros a las filas normales
            filas.forEach(fila => {
                const estado = fila.dataset.estado.toLowerCase();
                const sla = fila.dataset.sla;
                const search = fila.dataset.search || '';

                let mostrar = true;

                // Filtro por estado
                if (filtroEstado && !estado.includes(filtroEstado)) {
                    mostrar = false;
                }

                // Filtro por SLA
                if (filtroSLA && sla !== filtroSLA) {
                    mostrar = false;
                }

                // Búsqueda global
                if (busqueda && !search.includes(busqueda)) {
                    mostrar = false;
                }

                fila.style.display = mostrar ? '' : 'none';
            });

            // Aplicar filtros a las filas de supervisor
            supervisorFilas.forEach(fila => {
                const estado = fila.dataset.estado.toLowerCase();
                const sla = fila.dataset.sla;
                const search = fila.dataset.search || '';

                let mostrar = true;

                // Filtro por estado
                if (filtroEstado && !estado.includes(filtroEstado)) {
                    mostrar = false;
                }

                // Filtro por SLA
                if (filtroSLA && sla !== filtroSLA) {
                    mostrar = false;
                }

                // Búsqueda global
                if (busqueda && !search.includes(busqueda)) {
                    mostrar = false;
                }

                fila.style.display = mostrar ? '' : 'none';
            });

            // Actualizar contadores en vista de supervisor
            actualizarContadoresSupervisor();
        }

        // Event listeners para filtros
        document.getElementById('filtroEstado').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroSLA').addEventListener('change', aplicarFiltros);
        document.getElementById('busquedaGlobal').addEventListener('input', aplicarFiltros);

        // Botón limpiar filtros
        document.getElementById('limpiarFiltros').addEventListener('click', function () {
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroSLA').value = '';
            document.getElementById('busquedaGlobal').value = '';
            aplicarFiltros();
        });

        // Función para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const toast = document.getElementById('notificacionToast');
            const toastBody = toast.querySelector('.toast-body');
            const toastHeader = toast.querySelector('.toast-header i');

            toastBody.textContent = mensaje;

            // Cambiar icono según tipo
            toastHeader.className = `fas me-2 ${tipo === 'success' ? 'fa-check-circle text-success' : 'fa-exclamation-triangle text-warning'}`;

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // BOTONES TOMAR SOLICITUD - CON MODAL PERSONALIZADO
        document.querySelectorAll('.tomar-solicitud').forEach(button => {
            button.addEventListener('click', function () {
                const solicitudId = this.getAttribute('data-solicitud-id');
                const codigo = this.getAttribute('data-codigo');
                const botonOriginal = this;

                console.log('🔵 Tomando solicitud:', solicitudId, codigo);

                // Mostrar modal personalizado
                mostrarModalConfirmacion('tomar', function () {
                    // CALLBACK DE CONFIRMACIÓN
                    console.log('✅ Confirmado - Tomando solicitud:', solicitudId);

                    // Deshabilitar botón
                    botonOriginal.disabled = true;
                    botonOriginal.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Tomando...';

                    fetch(`/workflow/api/solicitudes/${solicitudId}/tomar/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Notificación de éxito personalizada
                                mostrarNotificacionExito(`Solicitud ${codigo} tomada correctamente`);

                                // Recargar la página después de 1 segundo
                                setTimeout(() => {
                                    location.reload();
                                }, 1000);
                            } else {
                                mostrarNotificacionError("Error: " + (data.error || 'Error desconocido'));
                                // Rehabilitar botón
                                botonOriginal.disabled = false;
                                botonOriginal.innerHTML = '<i class="fas fa-hand-paper me-1"></i>Tomar';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            mostrarNotificacionError("Error de red al tomar la solicitud");
                            // Rehabilitar botón
                            botonOriginal.disabled = false;
                            botonOriginal.innerHTML = '<i class="fas fa-hand-paper me-1"></i>Tomar';
                        });
                }, function () {
                    // CALLBACK DE CANCELACIÓN
                    console.log('❌ Cancelado - Tomar solicitud');
                });
            });
        });

        // BOTONES DEVOLVER SOLICITUD - CON MODAL PERSONALIZADO
        document.querySelectorAll('.devolver-solicitud').forEach(button => {
            button.addEventListener('click', function () {
                const solicitudId = this.getAttribute('data-solicitud-id');
                const codigo = this.getAttribute('data-codigo');
                const botonOriginal = this;

                console.log('🔴 Devolviendo solicitud:', solicitudId, codigo);

                // Mostrar modal personalizado
                mostrarModalConfirmacion('devolver', function () {
                    // CALLBACK DE CONFIRMACIÓN
                    console.log('✅ Confirmado - Devolviendo solicitud:', solicitudId);

                    // Deshabilitar botón
                    botonOriginal.disabled = true;
                    botonOriginal.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Devolviendo...';

                    fetch(`/workflow/api/solicitudes/${solicitudId}/devolver/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Notificación de éxito personalizada
                                mostrarNotificacionExito(`Solicitud ${codigo} devuelta correctamente`);

                                // Recargar la página después de 1 segundo
                                setTimeout(() => {
                                    location.reload();
                                }, 1000);
                            } else {
                                mostrarNotificacionError("Error: " + (data.error || 'Error desconocido'));
                                // Rehabilitar botón
                                botonOriginal.disabled = false;
                                botonOriginal.innerHTML = '<i class="fas fa-undo me-1"></i>Devolver';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            mostrarNotificacionError("Error de red al devolver la solicitud");
                            // Rehabilitar botón
                            botonOriginal.disabled = false;
                            botonOriginal.innerHTML = '<i class="fas fa-undo me-1"></i>Devolver';
                        });
                }, function () {
                    // CALLBACK DE CANCELACIÓN
                    console.log('❌ Cancelado - Devolver solicitud');
                });
            });
        });





        // BOTONES ASIGNAR SOLICITUD
        document.querySelectorAll('.asignar-solicitud').forEach(button => {
            button.addEventListener('click', function () {
                const solicitudId = this.getAttribute('data-solicitud-id');
                const codigo = this.getAttribute('data-codigo');
                const etapaId = this.getAttribute('data-etapa-id');

                console.log('🔵 Asignando solicitud:', solicitudId, codigo, etapaId);

                // Guardar el solicitud_id en el modal para uso posterior
                document.getElementById('modalAsignarSolicitud').setAttribute('data-solicitud-id', solicitudId);

                // Actualizar información del modal
                document.getElementById('asignar-codigo-solicitud').textContent = codigo;
                // Find the etapa badge - it's now in the 3rd column after removing cedula
                const etapaBadge = this.closest('tr').querySelector('td:nth-child(3) .badge');
                if (etapaBadge) {
                    document.getElementById('asignar-etapa-solicitud').textContent = etapaBadge.textContent;
                } else {
                    document.getElementById('asignar-etapa-solicitud').textContent = 'Etapa no encontrada';
                }

                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalAsignarSolicitud'));
                modal.show();

                // Configurar búsqueda después de que el modal se muestre
                setTimeout(() => {
                    configurarBusquedaUsuarios();
                }, 100);

                // Cargar usuarios disponibles
                cargarUsuariosDisponibles(solicitudId, etapaId);
            });
        });

        // Función para cargar usuarios disponibles
        function cargarUsuariosDisponibles(solicitudId, etapaId) {
            const loadingDiv = document.getElementById('asignar-loading');
            const errorDiv = document.getElementById('asignar-error');
            const listaUsuarios = document.getElementById('lista-usuarios');

            // Mostrar loading
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            listaUsuarios.innerHTML = '';

            fetch(`/workflow/api/solicitudes/${solicitudId}/usuarios-disponibles/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';

                    if (data.success) {
                        if (data.usuarios && data.usuarios.length > 0) {
                            renderizarListaUsuarios(data.usuarios);
                            // Configurar búsqueda después de renderizar usuarios
                            setTimeout(() => {
                                configurarBusquedaUsuarios();
                            }, 50);
                        } else {
                            listaUsuarios.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No hay usuarios disponibles para asignar esta solicitud.
                                </div>
                            </td>
                        </tr>
                    `;
                        }
                    } else {
                        throw new Error(data.error || 'Error al cargar usuarios');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                    document.getElementById('asignar-error-mensaje').textContent = error.message;
                });
        }

        // Función para renderizar lista de usuarios
        function renderizarListaUsuarios(usuarios) {
            const listaUsuarios = document.getElementById('lista-usuarios');

            const usuariosHTML = usuarios.map((usuario, index) => `
            <tr class="usuario-item" 
                data-usuario-id="${usuario.id}" 
                data-usuario-nombre="${usuario.nombre_completo}"
                data-usuario-email="${usuario.email}"
                data-usuario-grupos="${usuario.grupos ? usuario.grupos.join(',') : ''}"
                data-usuario-roles="${(usuario.is_staff ? 'staff' : '') + (usuario.is_superuser ? 'admin' : '')}"
                data-profile-picture="${usuario.profile_picture_url || ''}">
                <td class="text-center">
                    <span class="badge bg-secondary">${index + 1}</span>
                </td>
                <td class="text-center">
                    ${usuario.profile_picture_url ?
                    `<img src="${usuario.profile_picture_url}" alt="${usuario.nombre_completo}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e0e0e0;">` :
                    `<div style="width: 40px; height: 40px; background: linear-gradient(135deg, #007bff, #0056b3); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin: 0 auto;">
                            ${usuario.nombre_completo.charAt(0).toUpperCase()}
                        </div>`
                }
                </td>
                <td>
                    <div>
                        <strong class="fw-bold">${usuario.nombre_completo}</strong>
                        ${usuario.is_staff ? '<span class="badge bg-info ms-1">Staff</span>' : ''}
                        ${usuario.is_superuser ? '<span class="badge bg-danger ms-1">Admin</span>' : ''}
                    </div>
                </td>
                <td>
                    <small class="text-muted">${usuario.email}</small>
                </td>
                <td>
                    ${usuario.grupos && usuario.grupos.length > 0 ?
                    usuario.grupos.map(grupo => `<span class="badge bg-light text-dark me-1">${grupo}</span>`).join('') :
                    '<span class="text-muted">Sin grupos</span>'
                }
                </td>
                <td class="text-center">
                    <button class="btn btn-success btn-sm asignar-usuario" 
                            data-usuario-id="${usuario.id}" 
                            data-usuario-nombre="${usuario.nombre_completo}">
                        <i class="fas fa-user-plus me-1"></i>
                        Asignar
                    </button>
                </td>
            </tr>
        `).join('');

            listaUsuarios.innerHTML = usuariosHTML;

            // Actualizar contador
            actualizarContadorUsuarios();

            // Agregar event listeners a los botones de asignar
            document.querySelectorAll('.asignar-usuario').forEach(btn => {
                btn.addEventListener('click', function () {
                    const usuarioId = this.getAttribute('data-usuario-id');
                    const usuarioNombre = this.getAttribute('data-usuario-nombre');
                    const modal = document.getElementById('modalAsignarSolicitud');
                    const solicitudId = modal.getAttribute('data-solicitud-id');

                    console.log('🔵 Asignando usuario:', usuarioId, usuarioNombre, 'a solicitud:', solicitudId);

                    if (!solicitudId) {
                        mostrarNotificacionError('Error: No se pudo obtener el ID de la solicitud');
                        return;
                    }

                    asignarSolicitudAUsuario(solicitudId, usuarioId, usuarioNombre);
                });
            });
        }

        // Función para filtrar usuarios
        function filtrarUsuarios() {
            console.log('🔍 Filtrando usuarios...');

            const buscarInput = document.getElementById('buscar-usuario-asignacion');
            const contadorElement = document.getElementById('contador-usuarios');

            if (!buscarInput || !contadorElement) {
                console.log('❌ Elementos de búsqueda no encontrados');
                return;
            }

            const busqueda = buscarInput.value.toLowerCase().trim();
            const usuarios = document.querySelectorAll('.usuario-item');
            let contador = 0;

            console.log(`🔍 Buscando: "${busqueda}" en ${usuarios.length} usuarios`);

            usuarios.forEach((usuario, index) => {
                const nombre = usuario.getAttribute('data-usuario-nombre') || '';
                const email = usuario.getAttribute('data-usuario-email') || '';
                const grupos = usuario.getAttribute('data-usuario-grupos') || '';
                const roles = usuario.getAttribute('data-usuario-roles') || '';

                const coincide = nombre.toLowerCase().includes(busqueda) ||
                    email.toLowerCase().includes(busqueda) ||
                    grupos.toLowerCase().includes(busqueda) ||
                    roles.toLowerCase().includes(busqueda);

                if (coincide || !busqueda) {
                    usuario.style.display = '';
                    contador++;
                } else {
                    usuario.style.display = 'none';
                }
            });

            // Actualizar contador
            contadorElement.textContent = contador;
            console.log(`✅ ${contador} usuarios encontrados`);

            // Mostrar mensaje si no hay resultados
            const tabla = document.getElementById('tabla-usuarios');
            if (tabla) {
                const tbody = tabla.querySelector('tbody');

                // Remover mensaje anterior si existe
                const noResultadosAnterior = tbody.querySelector('.no-resultados');
                if (noResultadosAnterior) {
                    noResultadosAnterior.remove();
                }

                if (contador === 0 && busqueda) {
                    const noResultados = document.createElement('tr');
                    noResultados.className = 'no-resultados';
                    noResultados.innerHTML = `
                    <td colspan="6" class="text-center py-4">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-search me-2"></i>
                            No se encontraron usuarios que coincidan con "${busqueda}"
                        </div>
                    </td>
                `;
                    tbody.appendChild(noResultados);
                }
            }
        }

        // Función para actualizar contador de usuarios
        function actualizarContadorUsuarios() {
            const usuariosVisibles = document.querySelectorAll('.usuario-item:not([style*="display: none"])').length;
            const totalUsuarios = document.querySelectorAll('.usuario-item').length;
            document.getElementById('contador-usuarios').textContent = usuariosVisibles;
        }

        // Función para limpiar búsqueda
        function limpiarBusquedaUsuarios() {
            document.getElementById('buscar-usuario-asignacion').value = '';
            filtrarUsuarios();
        }

        // Función para configurar búsqueda de usuarios
        function configurarBusquedaUsuarios() {
            // Búsqueda en tiempo real
            const buscarInput = document.getElementById('buscar-usuario-asignacion');
            if (buscarInput) {
                // Remover event listeners existentes para evitar duplicados
                buscarInput.removeEventListener('input', filtrarUsuarios);
                buscarInput.removeEventListener('keydown', handleEnterKey);

                // Agregar nuevos event listeners
                buscarInput.addEventListener('input', filtrarUsuarios);
                buscarInput.addEventListener('keydown', handleEnterKey);
            }

            // Botón limpiar búsqueda
            const limpiarBtn = document.getElementById('limpiar-busqueda-usuarios');
            if (limpiarBtn) {
                // Remover event listeners existentes
                limpiarBtn.removeEventListener('click', handleLimpiarBusqueda);

                // Agregar nuevo event listener
                limpiarBtn.addEventListener('click', handleLimpiarBusqueda);
            }
        }

        // Función para manejar la tecla Enter
        function handleEnterKey(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                filtrarUsuarios();
            }
        }

        // Función para manejar limpiar búsqueda
        function handleLimpiarBusqueda() {
            limpiarBusquedaUsuarios();
            const buscarInput = document.getElementById('buscar-usuario-asignacion');
            if (buscarInput) {
                buscarInput.focus();
            }
        }

        // Función para asignar solicitud a usuario
        function asignarSolicitudAUsuario(solicitudId, usuarioId, usuarioNombre) {
            console.log('🔵 Iniciando asignación:', { solicitudId, usuarioId, usuarioNombre });

            if (!solicitudId || solicitudId === 'null' || solicitudId === 'undefined') {
                mostrarNotificacionError('Error: ID de solicitud inválido');
                return;
            }

            const boton = document.querySelector(`[data-usuario-id="${usuarioId}"] .asignar-usuario`);
            if (!boton) {
                mostrarNotificacionError('Error: No se pudo encontrar el botón de asignación');
                return;
            }

            const originalText = boton.innerHTML;

            // Deshabilitar botón y mostrar loading
            boton.disabled = true;
            boton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Asignando...';

            const url = `/workflow/api/solicitudes/${solicitudId}/asignar-usuario/`;
            console.log('🔵 Haciendo request a:', url);

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    usuario_id: usuarioId
                })
            })
                .then(response => {
                    console.log('🔵 Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('🔵 Response data:', data);
                    if (data.success) {
                        // Mostrar toast de éxito
                        mostrarToastExito(`✅ Solicitud asignada exitosamente a ${usuarioNombre}`);

                        // Cerrar modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAsignarSolicitud'));
                        if (modal) {
                            modal.hide();
                        }

                        // Recargar página después de 2 segundos para que el usuario vea el toast
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        throw new Error(data.error || 'Error al asignar la solicitud');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacionError(`Error: ${error.message}`);

                    // Rehabilitar botón
                    boton.disabled = false;
                    boton.innerHTML = originalText;
                });
        }



        // RECARGA AUTOMÁTICA REMOVIDA - Ya no se recarga automáticamente para evitar expulsar usuarios
        // setInterval(function() {
        //     if (!document.hidden) {
        //         console.log('🔄 Recarga automática programada');
        //         location.reload();
        //     }
        // }, 30000); // REMOVIDO - Era cada 30 segundos

        // =====================================
        // FUNCIONALIDAD DE VISTA DE SUPERVISOR
        // =====================================

        // Toggle para mostrar/ocultar vista de supervisor
        const toggleSupervisorView = document.getElementById('toggle-supervisor-view');
        const supervisorViewContent = document.getElementById('supervisor-view-content');

        if (toggleSupervisorView && supervisorViewContent) {
            toggleSupervisorView.addEventListener('click', function () {
                const isVisible = supervisorViewContent.style.display !== 'none';

                if (isVisible) {
                    supervisorViewContent.style.display = 'none';
                    toggleSupervisorView.innerHTML = '<i class="fas fa-eye me-1"></i>Mostrar Vista Completa';
                    toggleSupervisorView.classList.remove('btn-light');
                    toggleSupervisorView.classList.add('btn-outline-light');
                } else {
                    supervisorViewContent.style.display = 'block';
                    toggleSupervisorView.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Ocultar Vista Completa';
                    toggleSupervisorView.classList.remove('btn-outline-light');
                    toggleSupervisorView.classList.add('btn-light');

                    // Actualizar contadores cuando se muestra
                    actualizarContadorVencidas();
                }
            });
        }

        // Función para actualizar contadores de la vista de supervisor
        function actualizarContadoresSupervisor() {
            const supervisorFilas = document.querySelectorAll('.supervisor-row');
            let vencidasCount = 0;
            let totalVisible = 0;

            supervisorFilas.forEach(fila => {
                if (fila.style.display !== 'none') {
                    totalVisible++;
                    const sla = fila.dataset.sla;
                    if (sla === 'vencido') {
                        vencidasCount++;
                    }
                }
            });

            // Actualizar contador de vencidas
            const vencidasElement = document.getElementById('supervisor-vencidas-count');
            if (vencidasElement) {
                vencidasElement.textContent = vencidasCount;
            }

            // Actualizar contador total
            const totalElement = document.getElementById('supervisor-total-count');
            if (totalElement) {
                totalElement.textContent = totalVisible;
            }
        }

        // Función para actualizar contador de solicitudes vencidas (mantener compatibilidad)
        function actualizarContadorVencidas() {
            actualizarContadoresSupervisor();
        }



        // Función para exportar datos de Back Office
        const exportBackofficeData = document.getElementById('export-backoffice-data');
        if (exportBackofficeData) {
            exportBackofficeData.addEventListener('click', function () {
                exportarDatosBackOffice();
            });
        }

        // Función para Admin Back Office
        const adminBackofficeBtn = document.getElementById('admin-backoffice-btn');
        if (adminBackofficeBtn) {
            adminBackofficeBtn.addEventListener('click', function () {
                window.location.href = '/workflow/admin-backoffice/';
            });
        }





        function exportarDatosBackOffice() {
            // Mostrar indicador de carga
            const button = document.getElementById('export-backoffice-data');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando Excel...';

            // Llamar al endpoint para generar el Excel
            fetch('/workflow/api/exportar-backoffice/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al generar el archivo');
                }
                return response.blob();
            })
            .then(blob => {
                // Crear link de descarga
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `estadisticas_backoffice_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                // Mostrar mensaje de éxito
                mostrarNotificacion('Excel generado exitosamente', 'success');
            })
            .catch(error => {
                console.error('Error al exportar datos de Back Office:', error);
                mostrarNotificacion('Error al generar el archivo Excel', 'error');
            })
            .finally(() => {
                // Restaurar botón
                button.disabled = false;
                button.innerHTML = originalHTML;
            });
        }

        // Event listeners para botones en la tabla de supervisor
        document.addEventListener('click', function (e) {
            // Botones de tomar solicitud en tabla de supervisor
            if (e.target.closest('.supervisor-row .tomar-solicitud')) {
                const button = e.target.closest('.tomar-solicitud');
                const solicitudId = button.getAttribute('data-solicitud-id');
                const codigo = button.getAttribute('data-codigo');

                console.log('🔵 Tomando solicitud desde vista supervisor:', solicitudId, codigo);

                // Usar el mismo modal de confirmación
                mostrarModalConfirmacion('tomar', function () {
                    // CALLBACK DE CONFIRMACIÓN
                    console.log('✅ Confirmado - Tomando solicitud desde supervisor:', solicitudId);

                    // Deshabilitar botón
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    fetch(`/workflow/api/solicitudes/${solicitudId}/tomar/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                mostrarNotificacionExito(`Solicitud ${codigo} tomada correctamente`);
                                setTimeout(() => {
                                    location.reload();
                                }, 1000);
                            } else {
                                mostrarNotificacionError("Error: " + (data.error || 'Error desconocido'));
                                button.disabled = false;
                                button.innerHTML = '<i class="fas fa-hand-paper"></i>';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            mostrarNotificacionError("Error de red al tomar la solicitud");
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-hand-paper"></i>';
                        });
                });
            }

            // Botones de devolver solicitud en tabla de supervisor
            if (e.target.closest('.supervisor-row .devolver-solicitud')) {
                const button = e.target.closest('.devolver-solicitud');
                const solicitudId = button.getAttribute('data-solicitud-id');
                const codigo = button.getAttribute('data-codigo');

                console.log('🔴 Devolviendo solicitud desde vista supervisor:', solicitudId, codigo);

                mostrarModalConfirmacion('devolver', function () {
                    console.log('✅ Confirmado - Devolviendo solicitud desde supervisor:', solicitudId);

                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    fetch(`/workflow/api/solicitudes/${solicitudId}/devolver/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                mostrarNotificacionExito(`Solicitud ${codigo} devuelta correctamente`);
                                setTimeout(() => {
                                    location.reload();
                                }, 1000);
                            } else {
                                mostrarNotificacionError("Error: " + (data.error || 'Error desconocido'));
                                button.disabled = false;
                                button.innerHTML = '<i class="fas fa-undo"></i>';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            mostrarNotificacionError("Error de red al devolver la solicitud");
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-undo"></i>';
                        });
                });
            }

            // Botones de asignar solicitud en tabla de supervisor
            if (e.target.closest('.supervisor-row .asignar-solicitud')) {
                const button = e.target.closest('.asignar-solicitud');
                const solicitudId = button.getAttribute('data-solicitud-id');
                const codigo = button.getAttribute('data-codigo');
                const etapaId = button.getAttribute('data-etapa-id');

                console.log('🔵 Asignando solicitud desde vista supervisor:', solicitudId, codigo, etapaId);

                // Guardar el solicitud_id en el modal para uso posterior
                document.getElementById('modalAsignarSolicitud').setAttribute('data-solicitud-id', solicitudId);

                // Actualizar información del modal
                document.getElementById('asignar-codigo-solicitud').textContent = codigo;
                // Find the etapa badge - it's now in the 3rd column after removing cedula
                const etapaBadge = button.closest('tr').querySelector('td:nth-child(3) .badge');
                if (etapaBadge) {
                    document.getElementById('asignar-etapa-solicitud').textContent = etapaBadge.textContent;
                } else {
                    document.getElementById('asignar-etapa-solicitud').textContent = 'Etapa no encontrada';
                }

                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalAsignarSolicitud'));
                modal.show();

                // Configurar búsqueda después de que el modal se muestre
                setTimeout(() => {
                    configurarBusquedaUsuarios();
                }, 100);

                // Cargar usuarios disponibles
                cargarUsuariosDisponibles(solicitudId, etapaId);
            }


        });

        // =====================================
        // SOLICITUDES PROCESADAS FUNCTIONALITY
        // =====================================

        // Variables globales para paginación
        let currentPageProcesadas = 1;
        let totalPagesProcesadas = 1;
        let currentFilterProcesadas = 'todas';
        let solicitudesProcesadasData = [];

        // Función para alternar la visibilidad de solicitudes procesadas
        window.toggleSolicitudesProcesadas = function() {
            const content = document.getElementById('solicitudes-procesadas-content');
            const toggleButton = document.getElementById('toggle-procesadas');
            const toggleText = document.getElementById('text-toggle-procesadas');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleText.textContent = 'Ocultar';
                toggleButton.innerHTML = '<i class="fas fa-eye-slash me-1"></i><span id="text-toggle-procesadas">Ocultar</span>';
                cargarSolicitudesProcesadas();
            } else {
                content.style.display = 'none';
                toggleText.textContent = 'Mostrar';
                toggleButton.innerHTML = '<i class="fas fa-eye me-1"></i><span id="text-toggle-procesadas">Mostrar</span>';
            }
        };

        // Función para cargar solicitudes procesadas
        function cargarSolicitudesProcesadas(filtro = 'todas', pagina = 1) {
            const loadingElement = document.getElementById('loading-procesadas');
            const tablaElement = document.getElementById('tabla-procesadas');
            const emptyElement = document.getElementById('empty-procesadas');
            const tableContainer = document.getElementById('tabla-procesadas-container');
            
            // Mostrar loading
            loadingElement.style.display = 'block';
            tableContainer.style.display = 'none';
            emptyElement.style.display = 'none';
            
            // Simular llamada a API - Aquí deberías hacer la llamada real al backend
            fetch(`/workflow/api/solicitudes-procesadas/?filtro=${filtro}&pagina=${pagina}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                loadingElement.style.display = 'none';
                
                if (data.success && data.solicitudes && data.solicitudes.length > 0) {
                    solicitudesProcesadasData = data.solicitudes;
                    renderizarTablaProcesadas(data.solicitudes);
                    actualizarPaginacionProcesadas(data.total_paginas, data.pagina_actual, data.total_solicitudes);
                    actualizarBadgeProcesadas(data.total_solicitudes);
                    tableContainer.style.display = 'block';
                } else {
                    emptyElement.style.display = 'block';
                    actualizarBadgeProcesadas(0);
                }
            })
            .catch(error => {
                console.error('Error al cargar solicitudes procesadas:', error);
                loadingElement.style.display = 'none';
                emptyElement.style.display = 'block';
                actualizarBadgeProcesadas(0);
                // Mostrar datos de ejemplo en caso de error de conexión
                mostrarDatosEjemplo();
            });
        }

        // Función para mostrar datos de ejemplo (para desarrollo)
        function mostrarDatosEjemplo() {
            const ejemploData = [
                {
                    id: 1,
                    codigo: 'SOL-2024-001',
                    cliente_nombre: 'Juan Pérez González',
                    etapa_final: 'Completada',
                    fecha_procesada: '2024-01-15 14:30:00',
                    estado_final: 'completada',
                    puede_ver_detalle: true,
                    pipeline: 'Crédito Automotriz',
                    procesado_por: 'Ana García',
                    es_supervisor_view: {{ user.is_staff|yesno:"true,false" }}
                },
                {
                    id: 2,
                    codigo: 'SOL-2024-002',
                    cliente_nombre: 'María López Rodríguez',
                    etapa_final: 'Rechazada',
                    fecha_procesada: '2024-01-14 09:15:00',
                    estado_final: 'rechazada',
                    puede_ver_detalle: true,
                    pipeline: 'Crédito Personal',
                    procesado_por: 'Carlos Mendoza',
                    es_supervisor_view: {{ user.is_staff|yesno:"true,false" }}
                },
                {
                    id: 3,
                    codigo: 'SOL-2024-003',
                    cliente_nombre: 'Carlos Mendoza Silva',
                    etapa_final: 'Cancelada',
                    fecha_procesada: '2024-01-13 16:45:00',
                    estado_final: 'cancelada',
                    puede_ver_detalle: false,
                    pipeline: 'Crédito Hipotecario',
                    procesado_por: 'Sistema',
                    es_supervisor_view: {{ user.is_staff|yesno:"true,false" }}
                }
            ];
            
            renderizarTablaProcesadas(ejemploData);
            actualizarBadgeProcesadas(ejemploData.length);
            document.getElementById('tabla-procesadas-container').style.display = 'block';
        }

        // Función para renderizar la tabla de solicitudes procesadas
        function renderizarTablaProcesadas(solicitudes) {
            const tabla = document.getElementById('tabla-procesadas');
            tabla.innerHTML = '';
            
            solicitudes.forEach(solicitud => {
                const row = document.createElement('tr');
                row.className = 'processed-row';
                row.setAttribute('data-solicitud-id', solicitud.id);
                
                const estadoBadgeClass = getEstadoBadgeClass(solicitud.estado_final);
                const fechaFormateada = formatearFecha(solicitud.fecha_procesada);
                const esSupervisor = solicitud.es_supervisor_view || {{ user.is_staff|yesno:"true,false" }};
                
                // Construir las celdas dinámicamente basado en si es supervisor
                let cellsHTML = `
                    <td>
                        <strong class="text-primary">${solicitud.codigo}</strong>
                    </td>
                    <td>
                        ${solicitud.puede_ver_detalle ? 
                            `<a href="#" class="modern-link ver-detalle-procesada" data-solicitud-id="${solicitud.id}">
                                <i class="fas fa-user me-1"></i>${solicitud.cliente_nombre}
                            </a>` : 
                            `<span class="text-muted">
                                <i class="fas fa-user me-1"></i>${solicitud.cliente_nombre}
                            </span>`
                        }
                    </td>`;
                
                // Agregar columnas adicionales para supervisores
                if (esSupervisor) {
                    cellsHTML += `
                    <td>
                        <span class="badge bg-info text-white" style="font-size: 0.75rem;">
                            <i class="fas fa-project-diagram me-1"></i>${solicitud.pipeline || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <small class="text-muted">
                            <i class="fas fa-user-tie me-1"></i>${solicitud.procesado_por || 'Sistema'}
                        </small>
                    </td>`;
                }
                
                cellsHTML += `
                    <td>
                        <span class="badge bg-secondary">${solicitud.etapa_final}</span>
                    </td>
                    <td>
                        <span class="processed-date">${fechaFormateada}</span>
                    </td>
                    <td>
                        <span class="processed-status-badge ${estadoBadgeClass}">
                            ${solicitud.estado_final}
                        </span>
                    </td>
                    <td>
                        <div class="modern-btn-group">
                            ${solicitud.puede_ver_detalle ? 
                                `<button class="modern-btn modern-btn-primary ver-detalle-procesada" 
                                    data-solicitud-id="${solicitud.id}" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>` : ''
                            }
                            <button class="modern-btn modern-btn-info ver-historial-procesada" 
                                data-solicitud-id="${solicitud.id}" title="Ver historial">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                row.innerHTML = cellsHTML;
                tabla.appendChild(row);
            });
            
            // Agregar event listeners para los botones
            agregarEventListenersProcesadas();
        }

        // Función para obtener la clase CSS del badge según el estado
        function getEstadoBadgeClass(estado) {
            switch (estado) {
                case 'completada':
                    return 'processed-status-completada';
                case 'rechazada':
                    return 'processed-status-rechazada';
                case 'cancelada':
                    return 'processed-status-cancelada';
                default:
                    return 'processed-status-completada';
            }
        }

        // Función para formatear fecha
        function formatearFecha(fechaString) {
            const fecha = new Date(fechaString);
            return fecha.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Función para agregar event listeners a los botones de solicitudes procesadas
        function agregarEventListenersProcesadas() {
            // Ver detalle
            document.querySelectorAll('.ver-detalle-procesada').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const solicitudId = this.getAttribute('data-solicitud-id');
                    abrirDetalleProc = this.getAttribute('data-solicitud-id');
                    // Aquí abrir modal de detalles o redirigir
                    mostrarNotificacionInfo(`Abriendo detalles de solicitud ${solicitudId}`);
                });
            });
            
            // Ver historial
            document.querySelectorAll('.ver-historial-procesada').forEach(btn => {
                btn.addEventListener('click', function() {
                    const solicitudId = this.getAttribute('data-solicitud-id');
                    // Aquí abrir modal de historial
                    mostrarNotificacionInfo(`Abriendo historial de solicitud ${solicitudId}`);
                });
            });
        }

        // Función para filtrar solicitudes procesadas
        window.filtrarProcesadas = function(filtro) {
            currentFilterProcesadas = filtro;
            currentPageProcesadas = 1;
            cargarSolicitudesProcesadas(filtro, 1);
        };

        // Función para cambiar página
        window.cambiarPaginaProcesadas = function(direccion) {
            if (direccion === 'prev' && currentPageProcesadas > 1) {
                currentPageProcesadas--;
            } else if (direccion === 'next' && currentPageProcesadas < totalPagesProcesadas) {
                currentPageProcesadas++;
            }
            cargarSolicitudesProcesadas(currentFilterProcesadas, currentPageProcesadas);
        };

        // Función para actualizar paginación
        function actualizarPaginacionProcesadas(totalPaginas, paginaActual, totalSolicitudes) {
            totalPagesProcesadas = totalPaginas;
            currentPageProcesadas = paginaActual;
            
            const showingFrom = ((paginaActual - 1) * 10) + 1;
            const showingTo = Math.min(paginaActual * 10, totalSolicitudes);
            
            document.getElementById('showing-from').textContent = showingFrom;
            document.getElementById('showing-to').textContent = showingTo;
            document.getElementById('total-procesadas').textContent = totalSolicitudes;
            document.getElementById('current-page').textContent = paginaActual;
            
            // Habilitar/deshabilitar botones de paginación
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            
            if (paginaActual <= 1) {
                prevBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
            }
            
            if (paginaActual >= totalPaginas) {
                nextBtn.classList.add('disabled');
            } else {
                nextBtn.classList.remove('disabled');
            }
            
            // Mostrar paginación si hay más de una página
            const paginationElement = document.getElementById('pagination-procesadas');
            if (totalPaginas > 1) {
                paginationElement.style.display = 'flex !important';
            } else {
                paginationElement.style.display = 'none !important';
            }
        }

        // Función para actualizar el badge de solicitudes procesadas
        function actualizarBadgeProcesadas(total) {
            document.getElementById('badge-procesadas').textContent = total;
        }

        console.log('✅ Sistema de bandejas inicializado correctamente - SIN auto-refresh');
        console.log('✅ Vista de supervisor habilitada para superusers/staff');
    });
</script>

<style>
    /* Modern KPI Styling - Inspired by APC Tracking */
    .kpi-card-modern {
        display: flex;
        align-items: center;
        padding: 20px 24px;
        border-radius: var(--border-radius);
        transition: all 0.3s ease;
        height: 90px;
        background: var(--card-background);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-md);
        margin-bottom: 8px;
    }

    .kpi-card-modern:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--info-color);
    }

    .kpi-icon-modern {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 16px;
        font-size: 1.4rem;
    }

    .kpi-content-modern {
        flex: 1;
    }

    .kpi-label-modern {
        font-size: 0.8rem;
        margin-bottom: 4px;
        opacity: 0.9;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .kpi-number-modern {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        line-height: 1;
    }

    /* KPI Variants */
    .kpi-total .kpi-icon-modern {
        background: linear-gradient(135deg, var(--success-color), #10b981);
        color: white;
    }

    .kpi-total .kpi-number-modern {
        color: var(--success-color);
    }

    .kpi-activas .kpi-icon-modern {
        background: linear-gradient(135deg, var(--info-color), #3b82f6);
        color: white;
    }

    .kpi-activas .kpi-number-modern {
        color: var(--info-color);
    }

    .kpi-completadas .kpi-icon-modern {
        background: linear-gradient(135deg, var(--warning-color), #f59e0b);
        color: white;
    }

    .kpi-completadas .kpi-number-modern {
        color: var(--warning-color);
    }

    .kpi-vencidas .kpi-icon-modern {
        background: linear-gradient(135deg, var(--danger-color), #f87171);
        color: white;
    }

    .kpi-vencidas .kpi-number-modern {
        color: var(--danger-color);
    }

    /* Nuevos estilos para KPIs por subestado */
    .kpi-warning .kpi-icon-modern {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
        color: white;
    }

    .kpi-warning .kpi-number-modern {
        color: #f59e0b;
    }

    .kpi-info .kpi-icon-modern {
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
        color: white;
    }

    .kpi-info .kpi-number-modern {
        color: #3b82f6;
    }

    .kpi-danger .kpi-icon-modern {
        background: linear-gradient(135deg, #ef4444, #f87171);
        color: white;
    }

    .kpi-danger .kpi-number-modern {
        color: #ef4444;
    }

    .kpi-neutral .kpi-icon-modern {
        background: linear-gradient(135deg, #6b7280, #9ca3af);
        color: white;
    }

    .kpi-neutral .kpi-number-modern {
        color: #6b7280;
    }

    /* Animaciones para KPIs por subestado */
    #kpis-subestado-container .kpi-card-modern {
        animation: fadeInUp 0.6s ease-out;
    }

    #kpis-subestado-container .kpi-card-modern:nth-child(1) { animation-delay: 0.1s; }
    #kpis-subestado-container .kpi-card-modern:nth-child(2) { animation-delay: 0.2s; }
    #kpis-subestado-container .kpi-card-modern:nth-child(3) { animation-delay: 0.3s; }
    #kpis-subestado-container .kpi-card-modern:nth-child(4) { animation-delay: 0.4s; }

    /* Hover effects específicos para KPIs de subestado */
    #kpis-subestado-container .kpi-card-modern:hover {
        transform: translateY(-6px) scale(1.02);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    /* Ajustes para KPIs de subestado en una línea */
    #kpis-subestado-container .kpi-card-modern {
        height: 85px;
        padding: 16px 20px;
    }

    #kpis-subestado-container .kpi-icon-modern {
        width: 42px;
        height: 42px;
        font-size: 1.1rem;
        margin-right: 12px;
    }

    #kpis-subestado-container .kpi-label-modern {
        font-size: 0.85rem;
        margin-bottom: 4px;
    }

    #kpis-subestado-container .kpi-number-modern {
        font-size: 1.4rem;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .kpi-card-modern {
            height: 80px;
            padding: 16px 20px;
            margin-bottom: 12px;
        }

        .kpi-icon-modern {
            width: 44px;
            height: 40px;
            font-size: 1.2rem;
            margin-right: 12px;
        }

        /* Ajustes específicos para KPIs de subestado en móviles */
        #kpis-subestado-container .col-2 {
            flex: 0 0 50% !important;
            max-width: 50% !important;
        }

        #kpis-subestado-container .kpi-card-modern {
            height: 75px;
            padding: 12px 16px;
        }

        #kpis-subestado-container .kpi-icon-modern {
            width: 36px;
            height: 36px;
            font-size: 1rem;
            margin-right: 8px;
        }

        #kpis-subestado-container .kpi-label-modern {
            font-size: 0.75rem;
        }

        #kpis-subestado-container .kpi-number-modern {
            font-size: 1.2rem;
        }
    }

        .kpi-number-modern {
            font-size: 1.4rem;
        }

        .kpi-label-modern {
            font-size: 0.75rem;
        }
    }
    /* Essential Supervisor Table Styles */
    #supervisor-table {
        font-size: 0.875rem;
    }

    .supervisor-row {
        transition: background-color 0.2s ease-in-out;
    }

    .supervisor-row:hover {
        background-color: rgba(45, 90, 45, 0.05);
    }

    .supervisor-row[data-tipo="grupal"] td:first-child {
        border-left: 3px solid var(--warning-color);
    }

    .supervisor-row[data-tipo="personal"] td:first-child {
        border-left: 3px solid var(--success-color);
    }

    /* Responsive Design for All Components */
    @media (max-width: 1200px) {
        #supervisor-table {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 768px) {
        #supervisor-table {
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// =====================================================
// FUNCIONALIDAD PARA SOLICITUDES PROCESADAS EN VISTA MIXTA
// =====================================================

// Variables para solicitudes procesadas en vista mixta
let currentPageProcesadasMixta = 1;
let searchTimeoutProcesadasMixta = null;
let modalProcesadasMixtaLoaded = false;

// Función para descargar PDF de resultado de consulta desde vista mixta
function descargarPDFResultadoMixta(solicitudId, buttonElement = null) {
    console.log('Descargando PDF para solicitud desde Vista Mixta:', solicitudId);
    
    // Mostrar estado de carga (opcional)
    if (buttonElement) {
        const originalHTML = buttonElement.innerHTML;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        buttonElement.disabled = true;
        
        // Restaurar botón después de 5 segundos como fallback
        setTimeout(() => {
            buttonElement.innerHTML = originalHTML;
            buttonElement.disabled = false;
        }, 5000);
    }
    
    // Enviar request con fetch
    fetch(`{% url 'workflow:api_pdf_resultado_consulta' 0 %}`.replace('0', solicitudId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            // Datos vacíos - el API puede funcionar sin datos específicos
            field_values: {},
            preview_mode: false
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        // Convertir respuesta a blob para descargar
        return response.blob();
    })
    .then(blob => {
        // Crear URL temporal para el blob
        const url = window.URL.createObjectURL(blob);
        
        // Crear link temporal para descarga
        const a = document.createElement('a');
        a.href = url;
        a.download = `Resultado_Consulta_${solicitudId}_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.pdf`;
        document.body.appendChild(a);
        a.click();
        
        // Limpiar
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        console.log('PDF descargado exitosamente desde Vista Mixta');
    })
    .catch(error => {
        console.error('Error al descargar PDF desde Vista Mixta:', error);
        alert('Error al descargar el PDF. Por favor, inténtalo de nuevo.');
    })
    .finally(() => {
        // Restaurar botón
        if (buttonElement) {
            const originalHTML = buttonElement.getAttribute('data-original-html') || '<i class="fas fa-file-pdf"></i>';
            buttonElement.innerHTML = originalHTML;
            buttonElement.disabled = false;
        }
    });
}

// Función para cargar solicitudes procesadas en vista mixta
function cargarSolicitudesProcesadasMixta(page = 1, search = '') {
    currentPageProcesadasMixta = page;
    
    // Mostrar estado de carga
    mostrarEstadoCargaProcesadasMixta();
    
    const params = new URLSearchParams({
        page: page,
        per_page: 10,
        search: search
    });
    
    fetch(`{% url 'workflow:api_solicitudes_procesadas_comite' %}?${params}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Solicitudes procesadas cargadas en Vista Mixta:', data);
        
        if (data.solicitudes && data.solicitudes.length > 0) {
            // Renderizar solicitudes
            renderizarSolicitudesProcesadasMixta(data.solicitudes);
            renderizarPaginacionProcesadasMixta(data.pagination);
            actualizarContadorProcesadasMixta(data.pagination.total_items);
            mostrarEstadoSolicitudesProcesadasMixta(true, data.solicitudes);
        } else {
            mostrarEstadoSolicitudesProcesadasMixta(false, []);
        }
    })
    .catch(error => {
        console.error('Error al cargar solicitudes procesadas en Vista Mixta:', error);
        mostrarEstadoSolicitudesProcesadasMixta(false, []);
        
        // Mostrar mensaje de error en el modal
        const container = document.getElementById('tableProcesadasBodyMixta');
        if (container) {
            container.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center p-4">
                        <div class="text-danger">
                            <i class="fas fa-exclamation-triangle mb-2"></i>
                            <p>Error al cargar las solicitudes procesadas</p>
                            <small>${error.message}</small>
                        </div>
                    </td>
                </tr>
            `;
        }
    });
}

// Función para renderizar solicitudes procesadas en vista mixta
function renderizarSolicitudesProcesadasMixta(solicitudes) {
    const tbody = document.getElementById('tableProcesadasBodyMixta');
    const mobileContainer = document.getElementById('mobileCardsProcesadasContainerMixta');
    
    if (!tbody || !mobileContainer) return;
    
    // Limpiar contenido previo
    tbody.innerHTML = '';
    mobileContainer.innerHTML = '';
    
    solicitudes.forEach(solicitud => {
        // Determinar clase de decisión
        let decisionClass = 'decision-pendiente';
        let decisionText = solicitud.decision_comite || 'Pendiente';
        
        switch(solicitud.decision_comite) {
            case 'APROBADO':
                decisionClass = 'decision-aprobado';
                break;
            case 'RECHAZADO':
                decisionClass = 'decision-rechazado';
                break;
            case 'OBSERVACIONES':
                decisionClass = 'decision-observaciones';
                break;
            default:
                decisionClass = 'decision-pendiente';
                decisionText = 'Pendiente';
        }
        
        // Crear fila para tabla de escritorio
        const row = document.createElement('tr');
        row.className = 'solicitud-row';
        
        row.innerHTML = `
            <td>
                <div class="d-flex flex-column">
                    <span class="fw-bold text-primary">${solicitud.cliente_nombre || 'Sin nombre'}</span>
                    <small class="text-muted">${solicitud.cliente_cedula || 'Sin cédula'}</small>
                </div>
            </td>
            <td class="text-end">
                <span class="fw-bold text-success">$${solicitud.monto.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>
            </td>
            <td class="text-center">
                <span class="product-badge product-${solicitud.tipo_producto}">${solicitud.tipo_producto || 'N/A'}</span>
            </td>
            <td class="text-center">
                <span class="decision-badge ${decisionClass}">${decisionText}</span>
            </td>
            <td class="text-center">
                <small class="text-muted">${solicitud.etapa_actual || 'Sin etapa'}</small>
            </td>
            <td class="text-center">
                <small class="text-muted">${solicitud.fecha_modificacion}</small>
            </td>
            <td class="text-center">
                <div class="d-flex gap-1 justify-content-center">
                    <a href="{% url 'workflow:detalle_solicitud' 0 %}".replace('0', solicitud.id) 
                       class="btn-view-procesada" title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </a>
                    <button onclick="descargarPDFResultadoMixta(${solicitud.id}, this)" 
                            class="btn-download-pdf" title="Descargar PDF"
                            data-original-html="<i class='fas fa-file-pdf'></i>">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
        
        // Crear card para vista móvil
        const cardCol = document.createElement('div');
        cardCol.className = 'col-12';
        
        cardCol.innerHTML = `
            <div class="solicitud-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="cliente-info">
                        <div class="cliente-name">${solicitud.cliente_nombre || 'Sin nombre'}</div>
                        <div class="cliente-cedula">${solicitud.cliente_cedula || 'Sin cédula'}</div>
                    </div>
                    <span class="decision-badge ${decisionClass}">${decisionText}</span>
                </div>
                <div class="card-body d-flex flex-column gap-3">
                    <div class="monto">$${solicitud.monto.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="product-badge product-${solicitud.tipo_producto}">${solicitud.tipo_producto || 'N/A'}</span>
                        <small class="text-muted">${solicitud.etapa_actual || 'Sin etapa'}</small>
                    </div>
                    
                    <div class="meta-info">
                        <div class="codigo">${solicitud.codigo}</div>
                        <div class="fecha">${solicitud.fecha_modificacion}</div>
                    </div>
                </div>
                <div class="card-footer d-flex gap-2">
                    <a href="{% url 'workflow:detalle_solicitud' 0 %}".replace('0', solicitud.id) 
                       class="btn-view-procesada flex-fill text-center">
                        <i class="fas fa-eye me-1"></i>Ver
                    </a>
                    <button onclick="descargarPDFResultadoMixta(${solicitud.id}, this)" 
                            class="btn-download-pdf" title="Descargar PDF"
                            data-original-html="<i class='fas fa-file-pdf'></i>">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                </div>
            </div>
        `;
        
        mobileContainer.appendChild(cardCol);
    });
}

// Función para renderizar paginación en vista mixta
function renderizarPaginacionProcesadasMixta(pagination) {
    const paginationContainer = document.getElementById('paginationProcesadasMixta');
    if (!paginationContainer) return;
    
    let paginationHTML = '<ul class="pagination pagination-sm justify-content-center mb-0">';
    
    // Botón anterior
    if (pagination.has_previous) {
        paginationHTML += `<li class="page-item">
            <a class="page-link" href="#" onclick="cargarSolicitudesProcesadasMixta(${pagination.current_page - 1}, document.getElementById('searchInputProcesadasMixta').value)">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>`;
    } else {
        paginationHTML += '<li class="page-item disabled"><span class="page-link"><i class="fas fa-chevron-left"></i></span></li>';
    }
    
    // Páginas
    const startPage = Math.max(1, pagination.current_page - 2);
    const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === pagination.current_page) {
            paginationHTML += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            paginationHTML += `<li class="page-item">
                <a class="page-link" href="#" onclick="cargarSolicitudesProcesadasMixta(${i}, document.getElementById('searchInputProcesadasMixta').value)">${i}</a>
            </li>`;
        }
    }
    
    // Botón siguiente
    if (pagination.has_next) {
        paginationHTML += `<li class="page-item">
            <a class="page-link" href="#" onclick="cargarSolicitudesProcesadasMixta(${pagination.current_page + 1}, document.getElementById('searchInputProcesadasMixta').value)">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>`;
    } else {
        paginationHTML += '<li class="page-item disabled"><span class="page-link"><i class="fas fa-chevron-right"></i></span></li>';
    }
    
    paginationHTML += '</ul>';
    paginationContainer.innerHTML = paginationHTML;
    
    // Actualizar contador de filas
    const rowCount = document.getElementById('rowCountProcesadasMixta');
    if (rowCount) {
        const start = (pagination.current_page - 1) * pagination.per_page + 1;
        const end = Math.min(pagination.current_page * pagination.per_page, pagination.total_items);
        rowCount.textContent = `Mostrando ${start} a ${end} de ${pagination.total_items} solicitudes procesadas`;
    }
}

// Función para actualizar contador
function actualizarContadorProcesadasMixta(total) {
    const totalElement = document.getElementById('totalProcesadasMixta');
    if (totalElement) {
        totalElement.textContent = total;
    }
}

// Función para mostrar/ocultar contenedores
function mostrarEstadoSolicitudesProcesadasMixta(tieneSolicitudes, solicitudes = []) {
    const tableDesktop = document.getElementById('tableProcesadasDesktopMixta');
    const cardsMobile = document.getElementById('cardsProcesadasMobileMixta');
    const emptyState = document.getElementById('emptyStateProcesadasMixta');
    const loadingState = document.getElementById('loadingStateProcesadasMixta');
    const paginationContainer = document.getElementById('paginationContainerProcesadasMixta');
    
    // Ocultar loading
    if (loadingState) loadingState.style.display = 'none';
    
    if (tieneSolicitudes && solicitudes.length > 0) {
        // Hay solicitudes - mostrar tabla/cards
        if (tableDesktop) tableDesktop.style.display = 'block';
        if (cardsMobile) cardsMobile.style.display = 'block';
        if (emptyState) emptyState.style.display = 'none';
        if (paginationContainer) paginationContainer.style.display = 'block';
    } else {
        // No hay solicitudes - mostrar estado vacío
        if (tableDesktop) tableDesktop.style.display = 'none';
        if (cardsMobile) cardsMobile.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
        if (paginationContainer) paginationContainer.style.display = 'none';
    }
}

// Función para mostrar estado de carga
function mostrarEstadoCargaProcesadasMixta() {
    const tableDesktop = document.getElementById('tableProcesadasDesktopMixta');
    const cardsMobile = document.getElementById('cardsProcesadasMobileMixta');
    const emptyState = document.getElementById('emptyStateProcesadasMixta');
    const loadingState = document.getElementById('loadingStateProcesadasMixta');
    const paginationContainer = document.getElementById('paginationContainerProcesadasMixta');
    
    // Ocultar todo y mostrar carga
    if (tableDesktop) tableDesktop.style.display = 'none';
    if (cardsMobile) cardsMobile.style.display = 'none';
    if (emptyState) emptyState.style.display = 'none';
    if (paginationContainer) paginationContainer.style.display = 'none';
    if (loadingState) loadingState.style.display = 'block';
}

// ==========================================
// GESTIÓN DE DOCUMENTOS PENDIENTES BACK OFFICE
// ==========================================

document.addEventListener('DOMContentLoaded', function() {
    // Event listener para botones de "Ver Pendientes"
    document.addEventListener('click', function(e) {
        if (e.target.closest('.ver-pendientes-backoffice')) {
            e.preventDefault();
            const button = e.target.closest('.ver-pendientes-backoffice');
            const solicitudId = button.getAttribute('data-solicitud-id');
            const codigoSolicitud = button.getAttribute('data-codigo');
            
            console.log('🔍 Abriendo modal de pendientes para solicitud:', solicitudId);
            abrirModalPendientes(solicitudId, codigoSolicitud);
        }
    });

    // ==========================================
    // EVENT LISTENERS PARA MODAL DE SOLICITUDES PROCESADAS VISTA MIXTA
    // ==========================================
    
    // Cargar datos cuando se abre el modal
    const modalProcesadasMixta = document.getElementById('modalSolicitudesProcesadasMixta');
    if (modalProcesadasMixta) {
        modalProcesadasMixta.addEventListener('shown.bs.modal', function() {
            if (!modalProcesadasMixtaLoaded) {
                cargarSolicitudesProcesadasMixta();
                modalProcesadasMixtaLoaded = true;
            }
        });
        
        // Reset modal state when closed
        modalProcesadasMixta.addEventListener('hidden.bs.modal', function() {
            // Optionally reset search
            const searchInput = document.getElementById('searchInputProcesadasMixta');
            if (searchInput) {
                searchInput.value = '';
            }
        });
    }
    
    // Búsqueda de solicitudes procesadas
    const searchInputProcesadasMixta = document.getElementById('searchInputProcesadasMixta');
    if (searchInputProcesadasMixta) {
        searchInputProcesadasMixta.addEventListener('input', function() {
            const searchTerm = this.value;
            
            // Debounce - cancelar búsqueda anterior
            if (searchTimeoutProcesadasMixta) {
                clearTimeout(searchTimeoutProcesadasMixta);
            }
            
            // Nueva búsqueda después de 500ms
            searchTimeoutProcesadasMixta = setTimeout(() => {
                cargarSolicitudesProcesadasMixta(1, searchTerm);
            }, 500);
        });
    }
    
    // Botón refrescar procesadas
    const btnRefrescarProcesadasMixta = document.getElementById('btnRefrescarProcesadasMixta');
    if (btnRefrescarProcesadasMixta) {
        btnRefrescarProcesadasMixta.addEventListener('click', function() {
            const searchTerm = document.getElementById('searchInputProcesadasMixta')?.value || '';
            cargarSolicitudesProcesadasMixta(currentPageProcesadasMixta, searchTerm);
        });
    }
    
    // Botón refrescar en estado vacío
    const btnRefrescarEmptyProcesadasMixta = document.getElementById('btnRefrescarEmptyProcesadasMixta');
    if (btnRefrescarEmptyProcesadasMixta) {
        btnRefrescarEmptyProcesadasMixta.addEventListener('click', function() {
            cargarSolicitudesProcesadasMixta();
        });
    }
});

/**
 * Abre el modal de documentos pendientes y carga los datos
 */
function abrirModalPendientes(solicitudId, codigoSolicitud) {
    const modal = new bootstrap.Modal(document.getElementById('pendientesBackofficeModal'));
    
    // Mostrar loading y ocultar contenido
    document.getElementById('pendientes-loading').style.display = 'block';
    document.getElementById('pendientes-contenido').style.display = 'none';
    document.getElementById('pendientes-error').style.display = 'none';
    
    // Abrir modal
    modal.show();
    
    // Cargar datos
    cargarDocumentosPendientes(solicitudId, codigoSolicitud);
}

/**
 * Carga los documentos pendientes desde la API
 */
function cargarDocumentosPendientes(solicitudId, codigoSolicitud) {
    console.log('📡 Cargando documentos pendientes para solicitud:', solicitudId);
    
    fetch(`/workflow/api/solicitudes/${solicitudId}/documentos-pendientes-backoffice/`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
        .then(response => {
            console.log('📡 Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('✅ Datos de pendientes recibidos:', data);
            
            if (data.success) {
                mostrarDocumentosPendientes(data, codigoSolicitud);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('❌ Error cargando documentos pendientes:', error);
            mostrarErrorPendientes(error.message);
        });
}

/**
 * Muestra los documentos del checklist en el modal con funcionalidad de calificación
 */
function mostrarDocumentosPendientes(data, codigoSolicitud) {
    // Ocultar loading
    document.getElementById('pendientes-loading').style.display = 'none';
    document.getElementById('pendientes-contenido').style.display = 'block';
    
    // Actualizar información de la solicitud
    document.getElementById('pendientes-solicitud-codigo').textContent = codigoSolicitud;
    document.getElementById('pendientes-contador').textContent = 
        `${data.total_documentos} documento${data.total_documentos !== 1 ? 's' : ''}`;
    

    
    const listaContainer = document.getElementById('pendientes-lista');
    const sinDocumentosDiv = document.getElementById('pendientes-sin-documentos');
    const yaCompletaDiv = document.getElementById('pendientes-ya-completa');
    
    // Verificar si ya está marcada como completa
    if (data.solicitud_completa) {
        yaCompletaDiv.style.display = 'block';
        listaContainer.innerHTML = '';
        sinDocumentosDiv.style.display = 'none';
        return;
    }
    
    // Verificar si hay documentos para mostrar
    if (data.total_documentos === 0) {
        sinDocumentosDiv.style.display = 'block';
        listaContainer.innerHTML = '';
        yaCompletaDiv.style.display = 'none';
        return;
    }
    
    // Mostrar documentos
    yaCompletaDiv.style.display = 'none';
    sinDocumentosDiv.style.display = 'none';
    
    let html = '';
    
    data.documentos.forEach((doc, index) => {
        // Determinar color del borde según estado
        let borderClass = 'border-warning';
        let estadoBadge = '';
        
        switch(doc.estado_calificacion) {
            case 'bueno':
                borderClass = 'border-success';
                estadoBadge = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Bueno</span>';
                break;
            case 'malo':
                borderClass = 'border-danger';
                estadoBadge = '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Malo</span>';
                break;
            case 'pendiente':
                borderClass = 'border-warning';
                estadoBadge = '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pendiente</span>';
                break;
            case 'subsanado':
                borderClass = 'border-info';
                estadoBadge = '<span class="badge bg-info"><i class="fas fa-check-circle me-1"></i>Subsanado</span>';
                break;
            default:
                borderClass = 'border-secondary';
                estadoBadge = '<span class="badge bg-secondary"><i class="fas fa-question me-1"></i>Sin calificar</span>';
        }
        
        html += `
            <div class="card mb-3 border-start ${borderClass} border-4" id="documento-${doc.requisito_solicitud_id}">
                <div class="card-body">
                    <div class="row">
                        <!-- IZQUIERDA: Información del documento -->
                        <div class="col-md-6">
                            <h6 class="card-title mb-2">
                                <i class="fas fa-file-alt me-2"></i>
                                ${doc.nombre}
                                ${doc.obligatorio ? '<span class="badge bg-danger ms-2">Obligatorio</span>' : '<span class="badge bg-info ms-2">Opcional</span>'}
                            </h6>
                            ${doc.descripcion ? `<p class="card-text text-muted small mb-2">${doc.descripcion}</p>` : ''}
                            
                            <div class="d-flex gap-2 mb-2">
                                ${estadoBadge}
                                <small class="text-muted align-self-center">
                                    <i class="fas fa-paperclip me-1"></i>
                                    ${doc.archivos_count} archivo${doc.archivos_count !== 1 ? 's' : ''}
                                </small>
                            </div>
                            
                            ${doc.tiene_archivo ? `
                                <div class="mb-2">
                                    <a href="${doc.archivo_url}" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                                        <i class="fas fa-eye me-1"></i>Ver
                                    </a>
                                    <a href="${doc.archivo_url}" download class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-download me-1"></i>Descargar
                                    </a>
                                </div>
                            ` : `
                                <div class="alert alert-warning py-2 mb-2">
                                    <small><i class="fas fa-info-circle me-1"></i>Sin archivo subido</small>
                                </div>
                            `}
                            
                            ${doc.observaciones ? `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <strong>Observaciones:</strong> ${doc.observaciones}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- DERECHA: Botones de calificación -->
                        <div class="col-md-6">
                            <div class="d-flex flex-column gap-2">
                                <h6 class="mb-2">Calificar documento:</h6>
                                
                                <!-- Botón Bueno -->
                                <button type="button" 
                                        class="btn ${doc.estado_calificacion === 'bueno' ? 'btn-success' : 'btn-outline-success'} btn-sm calificar-modal-btn" 
                                        data-requisito-solicitud-id="${doc.requisito_solicitud_id}"
                                        data-estado="bueno"
                                        ${!doc.puede_calificar_bueno ? 'disabled title="Debe subir archivo para calificar como bueno"' : ''}>
                                    <i class="fas fa-thumbs-up me-1"></i>Bueno
                                </button>
                                
                                <!-- Botón Malo -->
                                <button type="button" 
                                        class="btn ${doc.estado_calificacion === 'malo' ? 'btn-danger' : 'btn-outline-danger'} btn-sm calificar-modal-btn" 
                                        data-requisito-solicitud-id="${doc.requisito_solicitud_id}"
                                        data-estado="malo"
                                        ${!doc.puede_calificar_malo ? 'disabled title="Debe subir archivo para calificar como malo"' : ''}>
                                    <i class="fas fa-thumbs-down me-1"></i>Malo
                                </button>
                                
                                <!-- Botón Pendiente (solo para opcionales) -->
                                ${doc.puede_calificar_pendiente ? `
                                    <button type="button" 
                                            class="btn ${doc.estado_calificacion === 'pendiente' ? 'btn-warning' : 'btn-outline-warning'} btn-sm calificar-modal-btn" 
                                            data-requisito-solicitud-id="${doc.requisito_solicitud_id}"
                                            data-estado="pendiente">
                                        <i class="fas fa-clock me-1"></i>Pendiente
                                    </button>
                                ` : ''}
                                
                                <!-- Botón Subsanado (siempre disponible) -->
                                ${doc.puede_calificar_subsanado ? `
                                    <button type="button" 
                                            class="btn ${doc.estado_calificacion === 'subsanado' ? 'btn-info' : 'btn-outline-info'} btn-sm calificar-modal-btn" 
                                            data-requisito-solicitud-id="${doc.requisito_solicitud_id}"
                                            data-estado="subsanado"
                                            title="Marcar como subsanado">
                                        <i class="fas fa-check-circle me-1"></i>Subsanado
                                    </button>
                                ` : ''}
                                
                                ${doc.fecha_calificacion ? `
                                    <small class="text-muted mt-2">
                                        <i class="fas fa-clock me-1"></i>
                                        Calificado: ${new Date(doc.fecha_calificacion).toLocaleDateString()}
                                        <br>Por: ${doc.calificado_por}
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    listaContainer.innerHTML = html;
    
    // Agregar event listeners para los botones de calificación
    document.querySelectorAll('.calificar-modal-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const requisitoSolicitudId = this.getAttribute('data-requisito-solicitud-id');
            const estado = this.getAttribute('data-estado');
            calificarDocumentoModal(requisitoSolicitudId, estado, this);
        });
    });
}

/**
 * Muestra error en el modal
 */
function mostrarErrorPendientes(mensaje) {
    document.getElementById('pendientes-loading').style.display = 'none';
    document.getElementById('pendientes-contenido').style.display = 'none';
    document.getElementById('pendientes-error').style.display = 'block';
    document.getElementById('pendientes-error-mensaje').textContent = mensaje;
}





/**
 * Muestra notificaciones toast
 */
function mostrarNotificacion(mensaje, tipo = 'info') {
    // Crear elemento de notificación
    const alertClass = tipo === 'success' ? 'alert-success' : 
                     tipo === 'error' ? 'alert-danger' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove después de 5 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

/**
 * Califica un documento desde el modal
 */
function calificarDocumentoModal(requisitoSolicitudId, estado, botonElement) {
    console.log(`📝 Calificando documento ${requisitoSolicitudId} como ${estado}`);
    
    // Si es "malo", mostrar modal de opciones
    if (estado === 'malo') {
        // Obtener el nombre del documento desde el contenedor padre
        const documentoContainer = botonElement.closest('.documento-item');
        const documentoNombre = documentoContainer ? documentoContainer.querySelector('.fw-bold')?.textContent || 'Documento' : 'Documento';
        
        mostrarModalOpciones(requisitoSolicitudId, documentoNombre, botonElement);
        return;
    }
    
    // Para otros estados, proceder normalmente
    // Guardar estado original del botón
    const originalText = botonElement.innerHTML;
    const originalDisabled = botonElement.disabled;
    
    // Mostrar loading en el botón
    botonElement.disabled = true;
    botonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Calificando...';
    
    fetch(`/workflow/api/requisito-solicitud/${requisitoSolicitudId}/calificar-modal/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            estado: estado,
            observaciones: '' // Podríamos agregar un campo para esto después
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('✅ Documento calificado:', data);
        
        if (data.success) {
            // Mostrar notificación de éxito
            mostrarNotificacion(`Documento calificado como ${estado}`, 'success');
            
            // Si fue calificado como "bueno", desaparece del modal
            if (data.desaparece_del_modal) {
                const documentoCard = document.getElementById(`documento-${requisitoSolicitudId}`);
                if (documentoCard) {
                    // Animación de desaparición
                    documentoCard.style.transition = 'opacity 0.5s ease-out';
                    documentoCard.style.opacity = '0';
                    
                    setTimeout(() => {
                        documentoCard.remove();
                        
                        // Verificar si ya no hay documentos
                        const listaContainer = document.getElementById('pendientes-lista');
                        if (listaContainer.children.length === 0) {
                            document.getElementById('pendientes-sin-documentos').style.display = 'block';
                            // Actualizar contador
                            document.getElementById('pendientes-contador').textContent = '0 documentos';
                        } else {
                            // Actualizar contador
                            const count = listaContainer.children.length;
                            document.getElementById('pendientes-contador').textContent = 
                                `${count} documento${count !== 1 ? 's' : ''}`;
                        }
                    }, 500);
                }
            } else {
                // Actualizar el estado visual del documento
                actualizarEstadoDocumentoModal(requisitoSolicitudId, estado, data);
                
                // Restaurar botón solo si existe
                if (botonElement) {
                    botonElement.disabled = originalDisabled;
                    botonElement.innerHTML = originalText;
                }
                
                // Actualizar estado de los botones
                const documentoCard = document.getElementById(`documento-${requisitoSolicitudId}`);
                if (documentoCard) {
                    // Actualizar clases de botones
                    documentoCard.querySelectorAll('.calificar-modal-btn').forEach(btn => {
                        const btnEstado = btn.getAttribute('data-estado');
                        if (btnEstado === estado) {
                            // Activar botón seleccionado
                            btn.className = btn.className.replace('btn-outline-', 'btn-');
                        } else {
                            // Desactivar otros botones
                            btn.className = btn.className.replace('btn-success', 'btn-outline-success');
                            btn.className = btn.className.replace('btn-danger', 'btn-outline-danger');
                            btn.className = btn.className.replace('btn-warning', 'btn-outline-warning');
                            btn.className = btn.className.replace('btn-info', 'btn-outline-info');
                        }
                    });
                }
            }
            
        } else {
            throw new Error(data.error || 'Error desconocido al calificar');
        }
    })
    .catch(error => {
        console.error('❌ Error calificando documento:', error);
        mostrarNotificacion(`Error: ${error.message}`, 'error');
        
        // Restaurar botón solo si existe
        if (botonElement) {
            botonElement.disabled = originalDisabled;
            botonElement.innerHTML = originalText;
        }
    });
}

/**
 * Actualiza el estado visual de un documento en el modal
 */
function actualizarEstadoDocumentoModal(requisitoSolicitudId, estado, data) {
    const documentoCard = document.getElementById(`documento-${requisitoSolicitudId}`);
    if (!documentoCard) return;
    
    // Actualizar clase del borde
    documentoCard.className = documentoCard.className.replace(/border-(success|danger|warning|secondary)/, '');
    
    let borderClass = 'border-warning';
    switch(estado) {
        case 'bueno':
            borderClass = 'border-success';
            break;
        case 'malo':
            borderClass = 'border-danger';
            break;
        case 'pendiente':
            borderClass = 'border-warning';
            break;
    }
    
    documentoCard.classList.add(borderClass);
    
    // Actualizar badge de estado
    const badgeContainer = documentoCard.querySelector('.d-flex.gap-2.mb-2');
    if (badgeContainer) {
        const estadoBadge = badgeContainer.querySelector('.badge');
        if (estadoBadge) {
            estadoBadge.className = 'badge';
            let badgeContent = '';
            
            switch(estado) {
                case 'bueno':
                    estadoBadge.classList.add('bg-success');
                    badgeContent = '<i class="fas fa-check me-1"></i>Bueno';
                    break;
                case 'malo':
                    estadoBadge.classList.add('bg-danger');
                    badgeContent = '<i class="fas fa-times me-1"></i>Malo';
                    break;
                case 'pendiente':
                    estadoBadge.classList.add('bg-warning');
                    badgeContent = '<i class="fas fa-clock me-1"></i>Pendiente';
                    break;
            }
            
            estadoBadge.innerHTML = badgeContent;
        }
    }
}

// ========================================
// FUNCIONES PARA KPIs POR SUBESTADO
// ========================================

/**
 * Actualiza los KPIs por subestado
 */
function actualizarKPIsSubestado() {
    console.log('🔄 Actualizando KPIs por subestado...');
    
    // Mostrar indicador de carga
    const contenedor = document.getElementById('kpis-subestado-container');
    const originalContent = contenedor.innerHTML;
    
    contenedor.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2 text-muted">Calculando KPIs por subestado...</p>
        </div>
    `;
    
    // Hacer llamada a la API
    fetch('/workflow/api/kpis-subestado/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Restaurar contenido original
            contenedor.innerHTML = originalContent;
            
            // Actualizar los valores
            document.getElementById('kpi-checklist').textContent = data.checklist || 0;
            document.getElementById('kpi-captura').textContent = data.captura || 0;
            document.getElementById('kpi-firma').textContent = data.firma || 0;
            document.getElementById('kpi-orden').textContent = data.orden || 0;
            document.getElementById('kpi-tramite').textContent = data.tramite || 0;
            document.getElementById('kpi-subsanacion').textContent = data.subsanacion || 0;
            
            // Animar los números
            animarKPIs();
            
            console.log('✅ KPIs por subestado actualizados');
        } else {
            console.error('❌ Error al obtener KPIs:', data.error);
            contenedor.innerHTML = `
                <div class="alert alert-warning text-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar KPIs: ${data.error || 'Error desconocido'}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('❌ Error de conexión:', error);
        contenedor.innerHTML = `
            <div class="alert alert-danger text-center">
                <i class="fas fa-wifi me-2"></i>
                Error de conexión. <button class="btn btn-link p-0" onclick="actualizarKPIsSubestado()">Reintentar</button>
            </div>
        `;
    });
}

/**
 * Toggle para mostrar/ocultar KPIs por subestado
 */
function toggleKPIsSubestado() {
    const container = document.getElementById('kpis-subestado-container');
    const icon = document.getElementById('toggle-kpis-icon');
    const text = document.getElementById('toggle-kpis-text');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        icon.className = 'fas fa-eye me-1';
        text.textContent = 'Ocultar';
        
        // Actualizar KPIs al mostrar
        actualizarKPIsSubestado();
    } else {
        container.style.display = 'none';
        icon.className = 'fas fa-eye-slash me-1';
        text.textContent = 'Mostrar';
    }
}

/**
 * Anima los números de los KPIs
 */
function animarKPIs() {
    const kpiNumbers = document.querySelectorAll('#kpis-subestado-container .kpi-number-modern');
    
    kpiNumbers.forEach(element => {
        const finalValue = parseInt(element.textContent) || 0;
        let currentValue = 0;
        const increment = Math.ceil(finalValue / 20);
        
        const timer = setInterval(() => {
            currentValue += increment;
            if (currentValue >= finalValue) {
                currentValue = finalValue;
                clearInterval(timer);
            }
            element.textContent = currentValue;
        }, 50);
    });
}

// ========================================
// FUNCIONES PARA MODAL DE OPCIONES
// ========================================

// Variable global para almacenar el requisito actual
let currentRequisitoForOpciones = null;
let currentBotonForOpciones = null;

/**
 * Muestra el modal de opciones para calificar como malo
 */
async function mostrarModalOpciones(requisitoSolicitudId, documentoNombre, botonElement) {
    currentRequisitoForOpciones = requisitoSolicitudId;
    currentBotonForOpciones = botonElement;

    // Actualizar el nombre del documento en el modal
    document.getElementById('opciones-documento-nombre').textContent = documentoNombre;

    // Mostrar el modal primero
    const modal = new bootstrap.Modal(document.getElementById('modalOpciones'));
    modal.show();

    // Cargar las opciones disponibles
    await cargarOpcionesDisponibles();
}

/**
 * Carga las opciones disponibles desde la API
 */
async function cargarOpcionesDisponibles() {
    const opcionesContainer = document.getElementById('opciones-container');
    
    try {
        // Mostrar loading
        opcionesContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando opciones...</div>';
        
        // Obtener opciones desde la API
        const response = await fetch('/workflow/api/opciones-desplegables/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarOpcionesEnModal(data.data);
        } else {
            opcionesContainer.innerHTML = '<div class="alert alert-danger">Error al cargar opciones: ' + data.error + '</div>';
        }
        
    } catch (error) {
        console.error('Error al cargar opciones:', error);
        opcionesContainer.innerHTML = '<div class="alert alert-danger">Error de conexión al cargar opciones</div>';
    }
}

/**
 * Muestra las opciones en el modal
 */
function mostrarOpcionesEnModal(opciones) {
    const container = document.getElementById('opciones-container');
    
    if (!opciones || opciones.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No hay opciones disponibles</div>';
        return;
    }
    
    let html = '<div class="list-group">';
    
    opciones.forEach(opcion => {
        html += `
            <button type="button" class="list-group-item list-group-item-action" onclick="seleccionarOpcion(${opcion.id}, '${opcion.nombre}')">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${opcion.nombre}</h6>
                </div>
                ${opcion.descripcion ? `<p class="mb-1 text-muted">${opcion.descripcion}</p>` : ''}
            </button>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

/**
 * Selecciona una opción y califica el documento como malo
 */
function seleccionarOpcion(opcionId, opcionNombre) {
    console.log(`📝 Opción seleccionada: ${opcionNombre} (ID: ${opcionId})`);
    
    // Calificar automáticamente como malo con la opción seleccionada
    calificarDocumentoConOpcion(currentRequisitoForOpciones, 'malo', opcionId);
    
    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalOpciones'));
    modal.hide();
}

/**
 * Actualiza la interfaz después de calificar un documento
 */
function actualizarInterfazCalificacion(botonElement, estado) {
    if (!botonElement) {
        console.warn('⚠️ botonElement es null en actualizarInterfazCalificacion');
        return;
    }
    
    // Buscar el contenedor de botones
    const grupoContainer = botonElement.closest('.d-flex');
    if (!grupoContainer) {
        console.warn('⚠️ No se encontró el contenedor de botones');
        return;
    }
    
    // Remover clases activas de todos los botones del mismo grupo
    const grupoButtons = grupoContainer.querySelectorAll('.calificar-modal-btn');
    grupoButtons.forEach(btn => {
        btn.classList.remove('btn-success', 'btn-danger', 'btn-warning', 'btn-info');
        const estadoBtn = btn.getAttribute('data-estado');
        const outlineClass = 'btn-outline-' + (estadoBtn === 'bueno' ? 'success' : 
                                               estadoBtn === 'malo' ? 'danger' :
                                               estadoBtn === 'pendiente' ? 'warning' : 'info');
        btn.classList.add(outlineClass);
    });
    
    // Activar el botón correspondiente solo si existe
    if (botonElement) {
        if (estado === 'bueno') {
            botonElement.classList.remove('btn-outline-success');
            botonElement.classList.add('btn-success');
        } else if (estado === 'malo') {
            botonElement.classList.remove('btn-outline-danger');
            botonElement.classList.add('btn-danger');
        } else if (estado === 'pendiente') {
            botonElement.classList.remove('btn-outline-warning');
            botonElement.classList.add('btn-warning');
        } else if (estado === 'subsanado') {
            botonElement.classList.remove('btn-outline-info');
            botonElement.classList.add('btn-info');
        }
    }
}

/**
 * Califica un documento con una opción específica
 */
function calificarDocumentoConOpcion(requisitoSolicitudId, estado, opcionId) {
    console.log(`📝 Calificando documento ${requisitoSolicitudId} como ${estado} con opción ${opcionId}`);
    
    const botonElement = currentBotonForOpciones;
    
    if (!botonElement) {
        console.error('❌ currentBotonForOpciones es null');
        mostrarNotificacion('Error interno: elemento de botón no encontrado', 'error');
        return;
    }
    
    // Guardar estado original del botón
    const originalText = botonElement.innerHTML;
    const originalDisabled = botonElement.disabled;
    
    // Mostrar loading en el botón
    botonElement.disabled = true;
    botonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Calificando...';
    
    fetch(`/workflow/api/requisito-solicitud/${requisitoSolicitudId}/calificar-modal/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            estado: estado,
            opcion_desplegable_id: opcionId,
            observaciones: ''
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('✅ Documento calificado con opción:', data);
        
        if (data.success) {
            // Actualizar la interfaz
            actualizarInterfazCalificacion(botonElement, estado);
            
            // Recargar la lista de pendientes si está abierto el modal
            const modalPendientes = document.getElementById('modalPendientes');
            if (modalPendientes && modalPendientes.classList.contains('show')) {
                const solicitudId = modalPendientes.dataset.solicitudId;
                if (solicitudId) {
                    cargarPendientesSolicitud(solicitudId);
                }
            }
            
            // Mostrar mensaje de éxito
            mostrarNotificacion('Documento calificado exitosamente', 'success');
        } else {
            throw new Error(data.error || 'Error desconocido');
        }
    })
    .catch(error => {
        console.error('❌ Error al calificar documento:', error);
        mostrarNotificacion('Error al calificar documento: ' + error.message, 'error');
    })
    .finally(() => {
        // Restaurar estado del botón solo si existe
        if (botonElement) {
            botonElement.disabled = originalDisabled;
            botonElement.innerHTML = originalText;
        }
    });
}

// Inicializar KPIs por subestado al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Cargar KPIs después de un breve delay para no sobrecargar la carga inicial
    setTimeout(() => {
        actualizarKPIsSubestado();
    }, 1000);
});

</script>

<!-- Modal para Opciones de Calificación -->
<div class="modal fade" id="modalOpciones" tabindex="-1" aria-labelledby="modalOpcionesLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalOpcionesLabel">
          <i class="fas fa-cog me-2"></i>Opciones de Calificación
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>Documento:</strong> <span id="opciones-documento-nombre"></span>
        </div>
        <div class="mb-3">
          <p class="text-muted"><strong>Debes seleccionar una opción</strong> para calificar este documento como "malo":</p>
        </div>
        <div id="opciones-container">
          <!-- Las opciones se cargan dinámicamente aquí -->
        </div>
        <div class="alert alert-info mt-3">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Nota:</strong> Selecciona una opción de la lista para continuar. El documento se calificará automáticamente como "malo" con la razón seleccionada.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
    