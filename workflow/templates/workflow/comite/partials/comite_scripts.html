<script>
document.addEventListener('DOMContentLoaded', function() {
    const API_URL = "{% url 'workflow:api_solicitudes_comite' %}";
    let currentPage = 1;
    let currentSearch = '';
    let isLoading = false; // Prevenir múltiples llamadas simultáneas

    const tablaBody = document.getElementById('tablaComiteBody');
    const mobileCardsContainer = document.getElementById('mobileCardsContainer');
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const searchInput = document.getElementById('searchInput');
    const btnRefrescar = document.getElementById('btnRefrescar');
    const paginationNav = document.getElementById('pagination');
    const rowCountDiv = document.getElementById('rowCount');

    function renderizarPaginacion(numPages, currentPage) {
        if (!paginationNav) return;
        
        paginationNav.innerHTML = '';
        
        if (numPages <= 1) return;
        
        const ul = document.createElement('ul');
        ul.className = 'pagination mb-0';
        
        for (let i = 1; i <= numPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.textContent = i;
            a.addEventListener('click', function(e) {
                e.preventDefault();
                if (i !== currentPage && !isLoading) {
                    cargarSolicitudes(i, currentSearch);
                }
            });
            
            li.appendChild(a);
            ul.appendChild(li);
        }
        
        paginationNav.appendChild(ul);
    }

    function mostrarEstadoCarga() {
        const tableDesktop = document.getElementById('tableDesktop');
        const cardsMobile = document.getElementById('cardsMobile');
        
        if (tableDesktop) tableDesktop.style.display = 'none';
        if (cardsMobile) cardsMobile.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';
        if (loadingState) loadingState.style.display = 'block';
    }

    function ocultarEstadoCarga() {
        const tableDesktop = document.getElementById('tableDesktop');
        const cardsMobile = document.getElementById('cardsMobile');
        
        if (loadingState) loadingState.style.display = 'none';
        
        // Restore proper responsive classes and show the containers
        if (tableDesktop) {
            tableDesktop.className = 'table-modern d-none d-lg-block';
            tableDesktop.style.display = '';
            tableDesktop.style.visibility = 'visible';
            console.log('Table desktop mostrada');
        }
        if (cardsMobile) {
            cardsMobile.className = 'mobile-cards d-block d-lg-none';
            cardsMobile.style.display = '';
            cardsMobile.style.visibility = 'visible';
            console.log('Cards móviles mostradas');
        }
    }

    function mostrarEstadoVacio() {
        const tableDesktop = document.getElementById('tableDesktop');
        const cardsMobile = document.getElementById('cardsMobile');
        
        if (tableDesktop) tableDesktop.style.display = 'none';
        if (cardsMobile) cardsMobile.style.display = 'none';
        if (loadingState) loadingState.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
    }

    function cargarSolicitudes(page = 1, search = '') {
        // Prevenir múltiples llamadas simultáneas
        if (isLoading) {
            console.log('Ya hay una carga en progreso, ignorando...');
            return;
        }
        
        isLoading = true;
        currentPage = page;
        currentSearch = search;
        
        console.log('Cargando solicitudes - Página:', page, 'Búsqueda:', search);
        
        mostrarEstadoCarga();
        
        const params = new URLSearchParams({
            page: page,
            search: encodeURIComponent(search)
        });
        
        fetch(`${API_URL}?${params}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data);
                
                // Limpiar tabla y cards completamente antes de agregar datos
                if (tablaBody) {
                    tablaBody.innerHTML = '';
                    console.log('Tabla limpiada');
                }
                if (mobileCardsContainer) {
                    mobileCardsContainer.innerHTML = '';
                    console.log('Cards móviles limpiadas');
                }
                
                if (data.success && data.solicitudes && data.solicitudes.length > 0) {
                    console.log(`Procesando ${data.solicitudes.length} solicitudes`);
                    // Crear fragmentos para insertar todas las filas y cards de una vez
                    const tableFragment = document.createDocumentFragment();
                    const cardsFragment = document.createDocumentFragment();
                    
                    data.solicitudes.forEach(solicitud => {
                        // Crear fila de tabla
                        const row = document.createElement('tr');
                        row.style.cursor = 'pointer';
                        row.setAttribute('data-solicitud-id', solicitud.id);
                        row.innerHTML = `
                            <td>
                                <div class="text-primary fw-bold">
                                    ${solicitud.cliente_nombre || 'Sin nombre'}
                                </div>
                                <div class="text-muted small">${solicitud.cliente_cedula || 'Sin cédula'}</div>
                                ${solicitud.marca_modelo ? `<div class="text-vehicle small"><i class="fas fa-car me-1"></i>${solicitud.marca_modelo}</div>` : ''}
                            </td>
                            <td>
                                <div class="fw-bold">${solicitud.monto_formateado}</div>
                            </td>
                            <td>
                                <span class="product-badge product-${solicitud.producto_descripcion.toLowerCase()}">
                                    ${solicitud.producto_descripcion}
                                </span>
                            </td>
                            <td>
                                <div class="analyst-info">
                                    <div class="analyst-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold small">${solicitud.analista_revisor.nombre}</div>
                                        <div class="text-muted small">${solicitud.analista_revisor.etapa}</div>
                                        <div class="text-muted small">${solicitud.analista_revisor.fecha}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="small">${solicitud.creada_por}</span>
                            </td>
                            <td>
                                <span class="small text-muted">${solicitud.fecha_creacion}</span>
                            </td>
                            <td>
                                <span class="text-muted small">${solicitud.codigo}</span>
                            </td>
                        `;
                        tableFragment.appendChild(row);
                        
                        // Crear card móvil
                        const cardCol = document.createElement('div');
                        cardCol.className = 'col-12 col-md-6 col-lg-4';
                        cardCol.innerHTML = `
                            <div class="solicitud-card" data-solicitud-id="${solicitud.id}" style="cursor: pointer;">
                                <div class="card-header">
                                    <div class="cliente-name">
                                        ${solicitud.cliente_nombre || 'Sin nombre'}
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="cliente-cedula">
                                        <i class="fas fa-id-card me-1"></i>${solicitud.cliente_cedula || 'Sin cédula'}
                                    </div>
                                    ${solicitud.marca_modelo ? `<div class="vehicle-info"><i class="fas fa-car me-1"></i>${solicitud.marca_modelo}</div>` : ''}
                                    <div class="monto">
                                        ${solicitud.monto_formateado}
                                    </div>
                                    <div class="producto-badge product-${solicitud.producto_descripcion.toLowerCase()}">
                                        ${solicitud.producto_descripcion}
                                    </div>
                                    <div class="analyst-info">
                                        <div class="analyst-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="analyst-details">
                                            <div class="analyst-name">${solicitud.analista_revisor.nombre}</div>
                                            <div class="analyst-etapa">${solicitud.analista_revisor.etapa}</div>
                                            <div class="analyst-fecha">${solicitud.analista_revisor.fecha}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="meta-info">
                                        <span class="codigo">${solicitud.codigo}</span>
                                        <span class="fecha">${solicitud.fecha_creacion}</span>
                                    </div>
                                    <div class="text-muted small mt-2">
                                        <i class="fas fa-user-plus me-1"></i>${solicitud.creada_por}
                                    </div>
                                </div>
                            </div>
                        `;
                        cardsFragment.appendChild(cardCol);
                    });
                    
                    // Insertar todas las filas y cards de una vez
                    if (tablaBody) {
                        tablaBody.appendChild(tableFragment);
                        console.log(`${tableFragment.children.length} filas agregadas a la tabla`);
                        
                        // Agregar event listeners para las filas de tabla
                        const tableRows = tablaBody.querySelectorAll('tr[data-solicitud-id]');
                        console.log(`${tableRows.length} filas con event listeners`);
                        tableRows.forEach(row => {
                            row.addEventListener('click', function() {
                                const solicitudId = this.getAttribute('data-solicitud-id');
                                if (solicitudId) {
                                    window.location.href = `/workflow/comite/solicitud/${solicitudId}/`;
                                }
                            });
                        });
                    }
                    if (mobileCardsContainer) {
                        mobileCardsContainer.appendChild(cardsFragment);
                        console.log(`${cardsFragment.children.length} cards agregadas`);
                        
                        // Agregar event listeners para las cards móviles
                        const cards = mobileCardsContainer.querySelectorAll('.solicitud-card');
                        cards.forEach(card => {
                            card.addEventListener('click', function() {
                                const solicitudId = this.getAttribute('data-solicitud-id');
                                if (solicitudId) {
                                    window.location.href = `/workflow/comite/solicitud/${solicitudId}/`;
                                }
                            });
                        });
                    }
                    
                    console.log('Llamando ocultarEstadoCarga()');
                    ocultarEstadoCarga();
                    
                    // Actualizar información de paginación
                    if (rowCountDiv) {
                        const totalCount = data.total_count || data.solicitudes.length;
                        rowCountDiv.textContent = `Mostrando ${data.solicitudes.length} de ${totalCount} solicitudes.`;
                    }
                    
                    // Renderizar paginación
                    renderizarPaginacion(data.num_pages || 1, currentPage);
                    
                } else {
                    // No hay solicitudes
                    mostrarEstadoVacio();
                    
                    if (rowCountDiv) {
                        rowCountDiv.textContent = 'No hay solicitudes.';
                    }
                    
                    if (paginationNav) {
                        paginationNav.innerHTML = '';
                    }
                }
            })
            .catch(error => {
                console.error('Error al cargar solicitudes:', error);
                mostrarEstadoVacio();
                
                if (rowCountDiv) {
                    rowCountDiv.textContent = 'Error al cargar solicitudes.';
                }
                
                if (paginationNav) {
                    paginationNav.innerHTML = '';
                }
            })
            .finally(() => {
                isLoading = false;
                console.log('Carga completada');
            });
    }

    // Configurar búsqueda con debouncing
    let searchTimeout;
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (!isLoading) {
                    cargarSolicitudes(1, this.value);
                }
            }, 300);
        });
    }

    // Botón de refrescar
    if (btnRefrescar) {
        btnRefrescar.addEventListener('click', function() {
            if (!isLoading) {
                cargarSolicitudes(currentPage, currentSearch);
            }
        });
    }

    // Botones de filtros y exportación con mensajes informativos
    const btnFiltros = document.getElementById('btnFiltrosAvanzados');
    const btnExportar = document.getElementById('btnExportar');
    
    if (btnFiltros) {
        btnFiltros.addEventListener('click', function() {
            alert('Funcionalidad de filtros avanzados en desarrollo');
        });
    }
    
    if (btnExportar) {
        btnExportar.addEventListener('click', function() {
            alert('Funcionalidad de exportación en desarrollo');
        });
    }

    // Cargar solicitudes al inicializar
    console.log('Inicializando carga de solicitudes...');
    cargarSolicitudes();
    
    // Exponer función globalmente para que pueda ser llamada desde otros scripts
    window.cargarSolicitudes = cargarSolicitudes;
});

// Función global para abrir modal de participación
function abrirModalParticipacion(solicitudId) {
    alert(`Abrir modal de participación para solicitud ID: ${solicitudId}`);
}
</script> 