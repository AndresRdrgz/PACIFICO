{% extends 'workflow/base.html' %}
{% load static %}
{% load file_icon_filters %}

{% block title %}Comité de Crédito - {{ solicitud.codigo }}{% endblock %}

{% block extra_css %}
{% include 'workflow/partials/analisis_styles.html' %}
<style>
    /* Estilos específicos del comité */
    .comite-header {
        background: linear-gradient(135deg, #047857, #059669);
        color: white;
    }
    
    .participaciones-table {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .participacion-row {
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s ease;
    }
    
    .participacion-row:hover {
        background-color: #f8fafc;
    }
    
    .participacion-row:last-child {
        border-bottom: none;
    }
    
    .avatar-sm {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: #f3f4f6;
        overflow: hidden;
        flex-shrink: 0;
    }
    
    .avatar-sm img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    
    .avatar-sm i {
        font-size: 1.2rem;
    }
    
    .comentario-cell {
        position: relative;
    }
    
    .comentario-preview {
        color: #374151;
        line-height: 1.4;
    }
    
    .empty-state {
        padding: 2rem;
    }
    
    .resultado-APROBADO { 
        background-color: #dcfce7; 
        color: #166534; 
        border: 1px solid #22c55e;
    }
    
    .resultado-RECHAZADO { 
        background-color: #fef2f2; 
        color: #991b1b; 
        border: 1px solid #ef4444;
    }
    
    .resultado-OBSERVACIONES { 
        background-color: #fef3c7; 
        color: #92400e; 
        border: 1px solid #f59e0b;
    }
    
    .resultado-PENDIENTE { 
        background-color: #f3f4f6; 
        color: #374151; 
        border: 1px solid #9ca3af;
    }
    
    .btn-comite {
        background: linear-gradient(135deg, #047857, #059669);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-comite:hover {
        background: linear-gradient(135deg, #065f46, #047857);
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-escalar {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-escalar:hover {
        background: linear-gradient(135deg, #1e40af, #1d4ed8);
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-avanzar {
        background: linear-gradient(135deg, #059669, #10b981);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-avanzar:hover {
        background: linear-gradient(135deg, #047857, #059669);
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-avanzar:disabled {
        background: #9ca3af;
        color: #6b7280;
        cursor: not-allowed;
        transform: none;
    }
    
    /* PDF resultado comité button specific styling */
    #btn-pdf-resultado-comite {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    #btn-pdf-resultado-comite:hover {
        background: linear-gradient(135deg, #059669, #047857);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }

    #btn-pdf-resultado-comite:disabled {
        opacity: 0.6;
        transform: none;
        cursor: not-allowed;
    }
    
    .section-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        user-select: none;
    }

    .section-header:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .section-header-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }

    .section-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .section-toggle:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .toggle-icon {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
        color: rgba(255, 255, 255, 0.8);
    }

    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .section-content {
        transition: all 0.3s ease;
        overflow: hidden;
        max-height: 300px;
        overflow-y: auto;
        padding: 0.75rem;
        border-radius: 0.375rem;
        background-color: white;
        margin-top: 0.5rem;
        border: 1px solid #e5e7eb;
    }

    .section-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
        overflow: hidden;
    }
    
    /* Estilos para comentarios */
    .comentarios-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .comentarios-section {
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 1rem;
    }
    
    .comentarios-section:last-child {
        border-bottom: none;
    }
    
    .comentario-item {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        transition: all 0.2s ease;
    }
    
    .comentario-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .comentario-header {
        margin-bottom: 0.5rem;
    }
    
    .comentario-author {
        font-weight: 600;
        color: #374151;
    }
    
    .comentario-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.25rem;
    }
    
    .comentario-date {
        font-size: 0.75rem;
        color: #6b7280;
    }
    
    .comentario-content {
        color: #374151;
        line-height: 1.5;
    }
    
    .comentario-tipo-badge {
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .comentarios-section-unified {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }
    
    .comentarios-section-unified::-webkit-scrollbar {
        width: 6px;
    }
    
    .comentarios-section-unified::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    
    .comentarios-section-unified::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    
    .comentarios-section-unified::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    /* Estilos para compliance status - matching analysis template */
    .info-row-with-status {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s ease;
    }
    
    .info-row-with-status:hover {
        background-color: #f9fafb;
    }
    
    .info-row-with-status:last-child {
        border-bottom: none;
    }
    
    .info-data {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        min-width: 0;
    }
    
    .info-label {
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
        flex-shrink: 0;
        margin-right: 1rem;
    }
    
    .info-value {
        color: #6b7280;
        font-size: 0.875rem;
        text-align: right;
        flex: 1;
        word-break: break-word;
    }
    
    .compliance-status {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-left: 1rem;
        flex-shrink: 0;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        cursor: default;
    }
    
    .status-badge:hover {
        transform: scale(1.05);
    }
    
    .status-bueno {
        background-color: #dcfce7;
        color: #166534;
        border-color: #22c55e;
    }
    
    .status-malo {
        background-color: #fef2f2;
        color: #991b1b;
        border-color: #ef4444;
    }
    
    .status-sin_calificar {
        background-color: #f3f4f6;
        color: #6b7280;
        border-color: #9ca3af;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .info-data {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        
        .info-label {
            margin-right: 0;
        }
        
        .info-value {
            text-align: left;
        }
        
        .compliance-status {
            margin-left: 0;
            margin-top: 0.5rem;
        }
    }
    
    /* Estilos para Análisis de Consulta */
    .analisis-seccion {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        height: 100%;
        min-height: 300px;
        display: flex;
        flex-direction: column;
    }
    
    .analisis-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f1f3f4;
        color: #374151;
        font-size: 0.95rem;
    }
    
    .analisis-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 8px;
    }
    
    .analisis-content::-webkit-scrollbar {
        width: 6px;
    }
    
    .analisis-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .analisis-content::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .analisis-content::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    .analisis-placeholder {
        text-align: center;
        padding: 20px;
        color: #6b7280;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px dashed #d1d5db;
    }
    
    .analisis-placeholder i {
        color: #9ca3af;
        font-size: 1.2rem;
        margin-bottom: 8px;
        display: block;
    }
    
    .analisis-placeholder small {
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    /* Bullet points styling for comentarios de campos */
    .bullet-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .bullet-item:hover {
        border-color: #d1d5db;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
        background-color: #f9fafb;
        transform: translateY(-1px);
    }
    
    .bullet-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .bullet-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        padding-bottom: 6px;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .bullet-title {
        color: #1f2937;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
        min-width: 120px;
        max-width: 200px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .bullet-value {
        color: #6b7280;
        font-size: 0.85rem;
        font-weight: 500;
        text-align: right;
        flex: 1;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 300px;
    }
    
    .bullet-comment {
        color: #374151;
        font-size: 0.875rem;
        line-height: 1.5;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        padding-left: 4px;
    }
    
    .bullet-comment i {
        font-size: 0.8rem;
        opacity: 0.8;
    }
    
    /* Análisis general content */
    .analisis-general-text {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 1rem;
        line-height: 1.6;
        color: #374151;
        font-size: 0.875rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        text-align: left;
    }
    
    .analisis-general-text:empty::before {
        content: "No hay análisis general disponible";
        color: #9ca3af;
        font-style: italic;
    }
    
    /* Mobile Section Navigation */
    .mobile-section-nav {
        position: fixed;
        top: 60px; /* Below the main mobile navbar - adjusted for actual navbar height */
        left: 0;
        right: 0;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        z-index: 1001; /* Higher than sidebar z-index: 1000 */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        /* Ensure it's always visible on mobile */
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .mobile-nav-container {
        display: flex;
        overflow-x: auto;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }
    
    .mobile-nav-container::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
    
    .mobile-nav-item {
        flex: 1;
        min-width: 0;
        padding: 0.75rem 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        text-align: center;
        white-space: nowrap;
    }
    
    .mobile-nav-item:hover {
        background-color: #f8fafc;
    }
    
    .mobile-nav-item.active {
        background-color: #f0f9ff;
        border-bottom-color: #047857;
        color: #047857;
    }
    
    .mobile-nav-item i {
        font-size: 1.1rem;
        margin-bottom: 0.125rem;
    }
    
    .mobile-nav-item span {
        font-size: 0.75rem;
        font-weight: 500;
        line-height: 1.2;
    }
    
    /* Adjust main content for mobile navigation */
    @media (max-width: 768px) {
        .main-content {
            padding-top: 120px !important; /* Account for both navbars (mobile navbar + section nav) */
        }
        
        .mobile-section-nav {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .analisis-seccion {
            min-height: 250px;
            margin-bottom: 1rem;
        }
        
        .bullet-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
        
        .bullet-title {
            min-width: auto;
            max-width: none;
            width: 100%;
        }
        
        .bullet-value {
            text-align: left;
            max-width: none;
            width: 100%;
        }
    }
    
    /* Hide mobile section navigation on desktop */
    @media (min-width: 769px) {
        .mobile-section-nav {
            display: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Redirect to reconsideration committee view if applicable -->
{% if solicitud.es_reconsideracion %}
    <script>
        window.location.href = "{% url 'workflow:detalle_reconsideracion_comite' solicitud.id %}";
    </script>
{% endif %}

<div id="comite-container">
    <!-- Mobile Navigation Bar -->
    <div class="mobile-section-nav d-md-none">
        <div class="mobile-nav-container">
            <div class="mobile-nav-item" data-section="analisis-consulta">
                <i class="fas fa-search"></i>
                <span>Análisis de Consulta</span>
            </div>
            <div class="mobile-nav-item" data-section="participacion-comite">
                <i class="fas fa-users"></i>
                <span>Participación Comité</span>
            </div>
        </div>
    </div>
    
    <div class="container-fluid">
        <!-- Header de la Solicitud -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header comite-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <a href="{% url 'workflow:bandeja_comite' %}" class="btn btn-light btn-sm">
                                    <i class="fas fa-arrow-left me-1"></i>Volver al Comité
                                </a>
                                <div>
                                    <h2 class="mb-1 d-flex align-items-center">
                                        <i class="fas fa-users me-2"></i>
                                        Comité: {{ solicitud.cliente_nombre_completo|default:"Sin cliente" }}
                                    </h2>
                                    <div class="mt-1 d-flex align-items-center gap-4" style="font-size: 0.85em; opacity: 0.9;">
                                        {% if solicitud.creada_por %}
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user me-1"></i>
                                            <strong>Propietario:</strong> 
                                            <span class="ms-1">{{ solicitud.creada_por.get_full_name|default:solicitud.creada_por.username }}</span>
                                        </div>
                                        {% endif %}
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-code me-1"></i>
                                            <strong>Código:</strong> 
                                            <span class="ms-1">{{ solicitud.codigo }}</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-money-bill-wave me-1"></i>
                                            <strong>Monto:</strong> 
                                            <span class="ms-1">{{ solicitud.monto_formateado }}</span>
                                        </div>
                                        {% if solicitud.cotizacion and solicitud.cotizacion.observaciones %}
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-comments me-1"></i>
                                            <strong>Motivo:</strong> 
                                            <span class="ms-1" id="motivo-texto-corto">{{ solicitud.cotizacion.observaciones|truncatechars:100 }}</span>
                                            <span class="ms-1" id="motivo-texto-completo" style="display: none;">{{ solicitud.cotizacion.observaciones }}</span>
                                            {% if solicitud.cotizacion.observaciones|length > 100 %}
                                            <button type="button" class="btn btn-link btn-sm p-0 ms-1" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.8em;" onclick="toggleMotivoCompleto()" id="btn-toggle-motivo">
                                                <i class="fas fa-chevron-down"></i><span> Ver más</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-light text-dark">{{ solicitud.pipeline.nombre }}</span>
                                <span class="badge bg-success">{{ solicitud.etapa_actual.nombre }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información Principal de la Solicitud -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="main-section-content">
                    <div class="analysis-grid">
                        <!-- 1. Información de Cliente -->
                        <div class="col-md-4">
                            <div class="section-container">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-header-content">
                                        <i class="fas fa-user text-info"></i>
                                        <h3 class="section-title">Información de Cliente</h3>
                                    </div>
                                    <div class="section-toggle">
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </div>
                                </div>
                                <div class="section-content">
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Empresa Privada:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.nombreEmpresa|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'empresa_privada' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Cargo:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.posicion|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'cargo' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Tiempo de Servicio:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.tiempoServicio|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'tiempo_servicio' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Salario:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.salarioBaseMensual %}
                                                    B/. {{ solicitud.cotizacion.salarioBaseMensual|floatformat:2 }}
                                                {% elif solicitud.cotizacion.ingresos %}
                                                    B/. {{ solicitud.cotizacion.ingresos|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'salario' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Score:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.apcScore|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'score' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Política:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.politica.titulo|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'politica' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Sector:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.sector|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'sector' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Detalle de la Solicitud -->
                        <div class="col-md-4">
                            <div class="section-container">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-header-content">
                                        <i class="fas fa-calculator text-primary"></i>
                                        <h3 class="section-title">Detalle de la Solicitud</h3>
                                    </div>
                                    <div class="section-toggle">
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </div>
                                </div>
                                <div class="section-content">
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Valor del equipo:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.valorAuto %}
                                                    B/. {{ solicitud.cotizacion.valorAuto|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'valor_equipo' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Abono:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.abono and solicitud.cotizacion.abonoPorcentaje %}
                                                    B/. {{ solicitud.cotizacion.abono|floatformat:2 }} ({{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%)
                                                {% elif solicitud.cotizacion.abono %}
                                                    B/. {{ solicitud.cotizacion.abono|floatformat:2 }}
                                                {% elif solicitud.cotizacion.abonoPorcentaje %}
                                                    {{ solicitud.cotizacion.abonoPorcentaje|floatformat:1 }}%
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'abono' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Monto financiado:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.montoPrestamo %}
                                                    B/. {{ solicitud.cotizacion.montoPrestamo|floatformat:2 }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'monto_financiado' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Monto en Letra:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.wrkMontoLetra %}
                                                    {{ solicitud.cotizacion.wrkMontoLetra }}
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'total_letra' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Plazo:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.plazoPago %}
                                                    {{ solicitud.cotizacion.plazoPago }} meses
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'plazo' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Información del Producto -->
                        <div class="col-md-4">
                            <div class="section-container">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-header-content">
                                        <i class="fas fa-box text-warning"></i>
                                        <h3 class="section-title">Información del Producto</h3>
                                    </div>
                                    <div class="section-toggle">
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </div>
                                </div>
                                <div class="section-content">
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Tipo de Producto:</span>
                                            <span class="info-value">{{ solicitud.producto_descripcion|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'tipo_producto' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Rentabilidad:</span>
                                            <span class="info-value">
                                                {% if solicitud.cotizacion.r_deseada %}
                                                    {{ solicitud.cotizacion.r_deseada|floatformat:2 }}%
                                                {% elif solicitud.cotizacion.r1 %}
                                                    {{ solicitud.cotizacion.r1|floatformat:2 }}%
                                                {% else %}
                                                    Sin datos
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'rentabilidad' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% if solicitud.cotizacion.tipoPrestamo == 'auto' %}
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Marca:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.marca|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'marca' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Modelo:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.modelo|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'modelo' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="info-row-with-status">
                                        <div class="info-data">
                                            <span class="info-label">Año:</span>
                                            <span class="info-value">{{ solicitud.cotizacion.yearCarro|default:"Sin datos" }}</span>
                                        </div>
                                        <div class="compliance-status">
                                            {% for calificacion in solicitud.calificaciones_campos.all %}
                                                {% if calificacion.campo == 'año' %}
                                                    <span class="status-badge status-{{ calificacion.estado }}" title="{{ calificacion.comentario|default:calificacion.get_estado_display }}">
                                                        <i class="fas {{ calificacion.get_estado_icon }}"></i>
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- 4. Documentos Adjuntos -->
                        <div class="col-md-4">
                            <div class="section-container">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-header-content">
                                        <i class="fas fa-paperclip text-success"></i>
                                        <h3 class="section-title">Documentos Adjuntos</h3>
                                        {% if solicitud.requisitos_con_archivos %}
                                            <button type="button" class="btn btn-primary btn-sm ms-2" id="btn-download-merged-pdf" title="Descargar todos los documentos en un solo PDF" onclick="event.stopPropagation();">
                                                <i class="fas fa-download me-1"></i>Descargar Consolidado
                                            </button>
                                        {% endif %}
                                    </div>
                                    <div class="section-toggle">
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </div>
                                </div>
                                <div class="section-content">
                                    <div class="adjuntos-content">
                                        {% with requisitos_con_archivos=solicitud.requisitos_con_archivos %}
                                            {% if requisitos_con_archivos %}
                                                {% for requisito_solicitud in requisitos_con_archivos %}
                                                    <div class="adjunto-item" title="{{ requisito_solicitud.archivo|get_file_name }}">
                                                        <div class="adjunto-icon">
                                                            <i class="{{ requisito_solicitud.archivo|get_file_icon }}"></i>
                                                        </div>
                                                        <div class="adjunto-details">
                                                            <div class="adjunto-name">
                                                                {{ requisito_solicitud.requisito.nombre }}
                                                                <span class="adjunto-extension">({{ requisito_solicitud.archivo|get_file_extension }})</span>
                                                                <span class="adjunto-size">{{ requisito_solicitud.archivo|get_file_size }}</span>
                                                            </div>
                                                            {% if requisito_solicitud.observaciones %}
                                                                <div class="adjunto-observaciones">
                                                                    <strong>Observaciones:</strong> {{ requisito_solicitud.observaciones }}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        <div class="adjunto-actions">
                                                            <a href="{{ requisito_solicitud.archivo.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                                <i class="fas fa-eye me-1"></i>Ver
                                                            </a>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="text-center py-4">
                                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                                    <h5 class="text-muted">No hay documentos adjuntos</h5>
                                                    <p class="text-muted">Esta solicitud no tiene documentos adjuntos cargados.</p>
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Análisis de Consulta -->
        <div class="row mb-4" id="analisis-consulta">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">
                                    <i class="fas fa-search me-2"></i>
                                    Análisis de Consulta
                                </h5>
                                <div id="analisis-info" class="text-muted small mt-1" style="display: none;">
                                    <i class="fas fa-user me-1"></i>
                                    <span id="analista-nombre"></span>
                                    <i class="fas fa-clock ms-2 me-1"></i>
                                    <span id="analisis-fecha"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Análisis General -->
                            <div class="col-md-6">
                                <div class="analisis-seccion">
                                    <div class="analisis-header">
                                        <i class="fas fa-edit me-2"></i>
                                        <strong>Análisis General</strong>
                                    </div>
                                    <div class="analisis-content" id="analisis-general-content">
                                        <div class="analisis-placeholder">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <small>Cargando análisis general...</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Comentarios de Campos -->
                            <div class="col-md-6">
                                <div class="analisis-seccion">
                                    <div class="analisis-header">
                                        <i class="fas fa-list-ul me-2"></i>
                                        <strong>Comentarios de Campos</strong>
                                    </div>
                                    <div class="analisis-content" id="comentarios-campos-content">
                                        <div class="analisis-placeholder">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <small>Cargando comentarios de campos...</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Participaciones del Comité -->
        <div class="row mb-4" id="participacion-comite">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>
                                Participaciones del Comité
                            </h5>
                            {% if nivel_usuario %}
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary btn-sm" onclick="mostrarModalParticipacion()">
                                    <i class="fas fa-plus me-1"></i>
                                    Dar mi resultado
                                </button>
                                <button type="button" class="btn btn-warning btn-sm" onclick="mostrarModalEscalar()">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    Escalar a nivel superior
                                </button>
                                <button type="button" class="btn btn-success btn-sm" id="btn-pdf-resultado-comite">
                                    <i class="fas fa-file-pdf me-1"></i>PDF resultado comité
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    

                    
                    <!-- Lista de Participaciones -->
                    <div class="card-body p-0">
                        {% if participaciones %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="px-3">Nivel</th>
                                        <th>Usuario</th>
                                        <th>Resultado</th>
                                        <th>Comentario</th>
                                        <th class="text-end px-3">Fecha</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for participacion in participaciones %}
                                    <tr class="participacion-row">
                                        <td class="px-3">
                                            <span class="badge bg-primary">
                                                {{ participacion.nivel.orden }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm me-2">
                                                    {% if participacion.usuario.userprofile and participacion.usuario.userprofile.profile_picture %}
                                                        <img src="{{ participacion.usuario.userprofile.profile_picture.url }}" 
                                                             alt="{{ participacion.usuario.get_full_name|default:participacion.usuario.username }}" 
                                                             class="rounded-circle"
                                                             width="32" 
                                                             height="32"
                                                             style="object-fit: cover;">
                                                    {% else %}
                                                        <i class="fas fa-user-circle text-primary"></i>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <strong>{{ participacion.usuario.get_full_name|default:participacion.usuario.username }}</strong>
                                                    {% if participacion.usuario == request.user %}
                                                    <span class="badge bg-info ms-2">Tú</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge resultado-{{ participacion.resultado }}">
                                                {{ participacion.get_resultado_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="comentario-cell" style="max-width: 300px;">
                                                <div class="comentario-preview">
                                                    {{ participacion.comentario|truncatechars:80 }}
                                                </div>
                                                {% if participacion.comentario|length > 80 %}
                                                <button class="btn btn-link btn-sm p-0 text-decoration-none" onclick="mostrarComentarioCompleto('{{ participacion.comentario }}')">
                                                    Ver más...
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="text-end px-3">
                                            <small class="text-muted">
                                                {{ participacion.fecha_modificacion|date:"d/m/Y H:i" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <div class="empty-state">
                                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No hay participaciones aún</h5>
                                <p class="text-muted mb-3">Esta solicitud aún no tiene participaciones del comité.</p>
                                {% if nivel_usuario %}
                                <button type="button" class="btn btn-primary" onclick="mostrarModalParticipacion()">
                                    <i class="fas fa-plus me-1"></i>
                                    Ser el primero en participar
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Decisión Final Section -->
                        {% if participaciones and nivel_usuario %}
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Una vez que envíes la decisión final, se notificará al propietario de la solicitud
                                    </small>
                                </div>
                                <button type="button" class="btn btn-success" onclick="mostrarModalDecisionFinal()" id="btnDecisionFinal">
                                    <i class="fas fa-paper-plane me-1"></i>
                                    Enviar Decisión Final
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>



        <!-- Solicitudes Relacionadas -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-link me-2"></i>
                            Solicitudes Relacionadas
                            <small class="text-muted">(Cédula: {{ solicitud.cliente_cedula|default:"-" }})</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if mostrar_mensaje_sin_cliente %}
                            <div class="alert alert-warning text-center my-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Esta solicitud no tiene cédula de cliente asignada, no se pueden mostrar solicitudes relacionadas.
                            </div>
                        {% else %}
                            {% if solicitudes_relacionadas %}
                                <div class="row">
                                    {% for s in solicitudes_relacionadas %}
                                        <div class="col-md-4 mb-3">
                                            <div class="card border-left-primary">
                                                <div class="card-body">
                                                    <div class="related-header-item">
                                                        <strong>{{ s.codigo }}</strong>
                                                        <span class="related-date">{{ s.fecha_creacion|date:"d/m/Y" }}</span>
                                                    </div>
                                                    <div class="related-info">
                                                        <span class="badge 
                                                            {% if s.etapa_actual and 'Aprobad' in s.etapa_actual.nombre %}bg-success
                                                            {% elif s.etapa_actual and 'Rechazad' in s.etapa_actual.nombre %}bg-danger
                                                            {% else %}bg-warning{% endif %}">
                                                            {% if s.etapa_actual %}{{ s.etapa_actual.nombre }}{% else %}Sin estado{% endif %}
                                                        </span>
                                                        <span class="related-amount">
                                                            B/. {% if s.cotizacion and s.cotizacion.montoPrestamo %}{{ s.cotizacion.montoPrestamo|floatformat:2 }}{% else %}0.00{% endif %}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No hay solicitudes relacionadas</h5>
                                    <p class="text-muted">No se encontraron otras solicitudes para este cliente.</p>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Participación del Comité -->
<div class="modal fade" id="modalParticipacion" tabindex="-1" aria-labelledby="modalParticipacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalParticipacionLabel">
                    <i class="fas fa-comment-dots me-2"></i>
                    Mi Participación - {{ nivel_usuario.nivel.nombre|default:"Comité" }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-participacion-comite-modal">
                    {% csrf_token %}
                    
                    <!-- Información de la solicitud -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2"></i>
                            <div>
                                <strong>Solicitud:</strong> {{ solicitud.codigo }} - {{ solicitud.cliente_nombre_completo|default:"Sin cliente" }}
                                <br>
                                <strong>Monto:</strong> {{ solicitud.monto_formateado }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Instrucciones importantes -->
                    <div class="alert alert-warning mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Instrucciones Importantes
                                </h6>
                                <ul class="mb-2">
                                    <li><strong>El Oficial de Negocios será notificado automáticamente</strong> con el resultado final del comité</li>
                                    <li><strong>Se enviará un PDF completo</strong> con todos los detalles y decisiones del comité</li>
                                    <li><strong>Su decisión es final</strong> y formará parte del resultado oficial</li>
                                </ul>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="descargarPdfResultadoComite()">
                                        <i class="fas fa-file-pdf me-1"></i>
                                        Previsualizar PDF que recibirá el Oficial
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <label for="resultado-modal" class="form-label fw-bold">
                                <i class="fas fa-check-circle me-1"></i>
                                Resultado *
                            </label>
                            <select class="form-select form-select-lg" id="resultado-modal" name="resultado" required>
                                <option value="">Seleccione...</option>
                                <option value="APROBADO" {% if participacion_usuario.resultado == 'APROBADO' %}selected{% endif %}>
                                    ✅ Aprobado
                                </option>
                                <option value="RECHAZADO" {% if participacion_usuario.resultado == 'RECHAZADO' %}selected{% endif %}>
                                    ❌ Rechazado
                                </option>
                                <option value="OBSERVACIONES" {% if participacion_usuario.resultado == 'OBSERVACIONES' %}selected{% endif %}>
                                    ⚠️ Alternativa
                                </option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-lightbulb me-1"></i>
                                Seleccione su decisión final sobre esta solicitud
                            </div>
                        </div>
                        <div class="col-md-8">
                            <label for="comentario-modal" class="form-label fw-bold">
                                <i class="fas fa-comment me-1"></i>
                                Comentario *
                            </label>
                            <textarea 
                                class="form-control" 
                                id="comentario-modal" 
                                name="comentario" 
                                rows="6" 
                                placeholder="Escriba su análisis, comentarios o justificación de la decisión..." 
                                required
                            >{% if participacion_usuario %}{{ participacion_usuario.comentario }}{% endif %}</textarea>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Este comentario será visible para todos los miembros del comité
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información adicional -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="fw-bold mb-2">
                            <i class="fas fa-user me-1"></i>
                            Información de su participación
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Nivel:</strong> {{ nivel_usuario.nivel.nombre|default:"No asignado" }}
                            </div>
                            <div class="col-md-6">
                                <strong>Usuario:</strong> {{ request.user.get_full_name|default:request.user.username }}
                            </div>
                        </div>
                        {% if participacion_usuario %}
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Última modificación: {{ participacion_usuario.fecha_modificacion|date:"d/m/Y H:i" }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="procesarParticipacion()">
                    <i class="fas fa-save me-1"></i>
                    {% if participacion_usuario %}Actualizar Participación{% else %}Guardar Participación{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Escalar -->
<div class="modal fade" id="modalEscalar" tabindex="-1" aria-labelledby="modalEscalarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEscalarLabel">
                    <i class="fas fa-arrow-up me-2"></i>
                    Escalar a Nivel Superior
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-escalar">
                    <div class="mb-3">
                        <label for="nivel-escalar" class="form-label">Nivel de Destino</label>
                        <select class="form-select" id="nivel-escalar" name="nivel_solicitado" required>
                            <option value="">Seleccione un nivel...</option>
                            {% for nivel in niveles_comite %}
                                {% if not nivel_usuario or nivel.orden < nivel_usuario.nivel.orden %}
                                    <option value="{{ nivel.id }}">{{ nivel.nombre }} (Orden: {{ nivel.orden }})</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Solo se muestran niveles superiores a su nivel actual. Menor orden = Mayor jerarquía.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="comentario-escalar" class="form-label">Motivo del Escalamiento</label>
                        <textarea class="form-control" id="comentario-escalar" name="comentario" rows="3" placeholder="Explique por qué necesita escalar esta solicitud..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-escalar" onclick="procesarEscalamiento()">
                    <i class="fas fa-arrow-up me-1"></i>
                    Escalar Solicitud
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Comentario Completo -->
<div class="modal fade" id="modalComentario" tabindex="-1" aria-labelledby="modalComentarioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalComentarioLabel">
                    <i class="fas fa-comment me-2"></i>
                    Comentario Completo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="comentario-completo-texto"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Decisión Final -->
<div class="modal fade" id="modalDecisionFinal" tabindex="-1" aria-labelledby="modalDecisionFinalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDecisionFinalLabel">
                    <i class="fas fa-paper-plane me-2"></i>
                    Enviar Decisión Final del Comité
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Importante:</strong> Al enviar la decisión final se notificará al propietario de la solicitud y se avanzará la solicitud a la etapa "Resultado Consulta".
                </div>
                
                <h6>Resumen de Participaciones:</h6>
                <div class="table-responsive mb-4">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Nivel</th>
                                <th>Usuario</th>
                                <th>Resultado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="resumenParticipaciones">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mb-3">
                    <label for="decisionFinal" class="form-label">
                        <strong>Decisión Final del Comité:</strong>
                    </label>
                    <select id="decisionFinal" class="form-select" required>
                        <option value="">Seleccionar resultado...</option>
                        <option value="Aprobado">Aprobado</option>
                        <option value="Rechazado">Rechazado</option>
                        <option value="Solicitar Observaciones">Solicitar Observaciones</option>
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Se preseleccionará automáticamente basado en la participación más reciente.
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="comentarioFinal" class="form-label">Comentario adicional:</label>
                    <textarea id="comentarioFinal" class="form-control" rows="3" 
                              placeholder="Este campo se prellenará con el comentario de la participación más reciente..."></textarea>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Se prellenará automáticamente con el comentario de la participación más reciente. Puede modificarlo o agregarlo si es necesario.
                    </div>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmacionEnvio" required>
                    <label class="form-check-label" for="confirmacionEnvio">
                        Confirmo que he revisado todas las participaciones y deseo enviar la decisión final
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success btn-enviar-decision" onclick="enviarDecisionFinal()" disabled>
                    <i class="fas fa-paper-plane me-1"></i>
                    Enviar Decisión Final
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    const solicitudId = {{ solicitud.id }};
    const csrfToken = '{{ csrf_token }}';
    const nivelUsuarioId = {{ nivel_usuario.nivel.id|default:"null" }};
    
    // Función para toggle de secciones
    function toggleSection(header) {
        const content = header.nextElementSibling;
        const icon = header.querySelector('.toggle-icon');
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            header.classList.remove('collapsed');
        } else {
            content.classList.add('collapsed');
            header.classList.add('collapsed');
        }
    }
    
    // Función para toggle del motivo completo
    function toggleMotivoCompleto() {
        const textoCorto = document.getElementById('motivo-texto-corto');
        const textoCompleto = document.getElementById('motivo-texto-completo');
        const btnToggle = document.getElementById('btn-toggle-motivo');
        
        if (textoCorto && textoCompleto && btnToggle) {
            if (textoCorto.style.display !== 'none') {
                // Mostrar texto completo
                textoCorto.style.display = 'none';
                textoCompleto.style.display = 'inline';
                btnToggle.innerHTML = '<i class="fas fa-chevron-up"></i><span> Ver menos</span>';
            } else {
                // Mostrar texto corto
                textoCorto.style.display = 'inline';
                textoCompleto.style.display = 'none';
                btnToggle.innerHTML = '<i class="fas fa-chevron-down"></i><span> Ver más</span>';
            }
        }
    }
    
    // Función para mostrar modal de participación
    function mostrarModalParticipacion() {
        const modal = new bootstrap.Modal(document.getElementById('modalParticipacion'));
        modal.show();
    }
    
    // Función para procesar la participación
    function procesarParticipacion() {
        const form = document.getElementById('form-participacion-comite-modal');
        const formData = new FormData(form);
        
        const resultado = formData.get('resultado');
        const comentario = formData.get('comentario');
        
        // Validaciones
        if (!resultado) {
            mostrarToast('Debe seleccionar un resultado', 'error');
            return;
        }
        
        if (!comentario || comentario.trim() === '') {
            mostrarToast('Debe escribir un comentario', 'error');
            return;
        }
        
        // Mostrar confirmación antes de procesar
        const resultadoTexto = {
            'APROBADO': '✅ APROBADO',
            'RECHAZADO': '❌ RECHAZADO', 
            'OBSERVACIONES': '⚠️ ALTERNATIVA'
        }[resultado] || resultado;
        
        if (!confirm(`¿Está seguro que desea registrar su participación con resultado: ${resultadoTexto}?\n\nEsta decisión será registrada oficialmente y el Oficial de Negocios será notificado automáticamente.`)) {
            return;
        }
        
        // Mostrar loading
        const btnProcesar = document.querySelector('#modalParticipacion .btn-primary');
        if (!btnProcesar) {
            mostrarToast('Error: No se pudo encontrar el botón de procesar', 'error');
            return;
        }
        const originalText = btnProcesar.innerHTML;
        btnProcesar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        btnProcesar.disabled = true;
        
        const data = {
            resultado: resultado,
            comentario: comentario.trim(),
            nivel_id: nivelUsuarioId
        };
        
        fetch(`/workflow/api/comite/solicitudes/${solicitudId}/participar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Participación registrada exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalParticipacion')).hide();
                // Recargar página después de 1 segundo
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                mostrarToast(data.error || 'Error al registrar la participación', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarToast('Error de conexión', 'error');
        })
        .finally(() => {
            // Restaurar botón
            btnProcesar.innerHTML = originalText;
            btnProcesar.disabled = false;
        });
    }
    
    // Función para mostrar modal de escalar
    function mostrarModalEscalar() {
        // Cargar niveles disponibles dinámicamente
        cargarNivelesDisponibles();
        
        const modal = new bootstrap.Modal(document.getElementById('modalEscalar'));
        modal.show();
    }
    
    // Función para cargar niveles disponibles
    function cargarNivelesDisponibles() {
        const selectNivel = document.getElementById('nivel-escalar');
        
        // Mostrar loading en el select
        selectNivel.innerHTML = '<option value="">Cargando niveles...</option>';
        
        fetch(`/workflow/api/comite/niveles/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    selectNivel.innerHTML = '<option value="">Seleccione un nivel...</option>';
                    
                    // Filtrar niveles superiores al nivel actual del usuario
                    const nivelesDisponibles = data.niveles.filter(nivel => {
                        return !nivelUsuarioId || nivel.orden < nivelUsuarioId;
                    });
                    
                    if (nivelesDisponibles.length === 0) {
                        selectNivel.innerHTML = '<option value="">No hay niveles superiores disponibles</option>';
                        return;
                    }
                    
                    // Ordenar por orden (menor = mayor jerarquía)
                    nivelesDisponibles.sort((a, b) => a.orden - b.orden);
                    
                    nivelesDisponibles.forEach(nivel => {
                        const option = document.createElement('option');
                        option.value = nivel.id;
                        option.textContent = `${nivel.nombre} (Orden: ${nivel.orden})`;
                        selectNivel.appendChild(option);
                    });
                } else {
                    selectNivel.innerHTML = '<option value="">Error al cargar niveles</option>';
                    console.error('Error cargando niveles:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                selectNivel.innerHTML = '<option value="">Error de conexión</option>';
            });
    }
    
    // Función para mostrar comentario completo
    function mostrarComentarioCompleto(comentario) {
        document.getElementById('comentario-completo-texto').textContent = comentario;
        const modal = new bootstrap.Modal(document.getElementById('modalComentario'));
        modal.show();
    }
    
    // Función para procesar escalamiento
    function procesarEscalamiento() {
        const form = document.getElementById('form-escalar');
        const formData = new FormData(form);
        
        const nivelSolicitado = formData.get('nivel_solicitado');
        const comentario = formData.get('comentario');
        
        // Validaciones
        if (!nivelSolicitado) {
            mostrarToast('Debe seleccionar un nivel de destino', 'error');
            return;
        }
        
        if (!comentario || comentario.trim() === '') {
            mostrarToast('Debe especificar el motivo del escalamiento', 'error');
            return;
        }
        
        // Mostrar loading
        const btnEscalar = document.querySelector('#modalEscalar .btn-escalar');
        if (!btnEscalar) {
            mostrarToast('Error: No se pudo encontrar el botón de escalar', 'error');
            return;
        }
        const originalText = btnEscalar.innerHTML;
        btnEscalar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        btnEscalar.disabled = true;
        
        const data = {
            nivel_solicitado: nivelSolicitado,
            comentario: comentario.trim()
        };
        
        fetch(`/workflow/api/comite/solicitudes/${solicitudId}/escalar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Solicitud escalada exitosamente. Se ha enviado notificación al nivel superior.', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalEscalar')).hide();
                // Recargar página después de 2 segundos
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                mostrarToast(data.error || 'Error al escalar la solicitud', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarToast('Error de conexión al procesar el escalamiento', 'error');
        })
        .finally(() => {
            // Restaurar botón
            btnEscalar.innerHTML = originalText;
            btnEscalar.disabled = false;
        });
    }
    
    // Función para mostrar toast
    function mostrarToast(mensaje, tipo) {
        // Crear el toast
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white border-0 ${tipo === 'success' ? 'bg-success' : 'bg-danger'}`;
        toast.role = 'alert';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${tipo === 'success' ? 'fa-check' : 'fa-exclamation-triangle'} me-2"></i>
                    ${mensaje}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        // Agregar al container de toasts
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        
        // Mostrar el toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remover después de que se oculte
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
    

    

    
    // Función para formatear fecha
    function formatearFecha(fechaString) {
        const fecha = new Date(fechaString);
        return fecha.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // Cargar análisis de consulta cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
        cargarAnalisisConsulta();
        
        // Manejar errores de carga de imágenes de perfil
        document.querySelectorAll('.avatar-sm img').forEach(img => {
            img.addEventListener('error', function() {
                // Reemplazar imagen con icono si falla la carga
                const avatarContainer = this.closest('.avatar-sm');
                avatarContainer.innerHTML = '<i class="fas fa-user-circle text-primary"></i>';
            });
        });
        
        // Inicializar navegación móvil
        initializeMobileNavigation();
    });
    
    // Función para inicializar la navegación móvil
    function initializeMobileNavigation() {
        const navItems = document.querySelectorAll('.mobile-nav-item');
        const sections = document.querySelectorAll('#analisis-consulta, #participacion-comite');
        
        // Función para actualizar el item activo basado en la posición del scroll
        function updateActiveNavItem() {
            const scrollPosition = window.scrollY + 130; // Offset para ambos navbars (mobile navbar + section nav)
            
            sections.forEach((section, index) => {
                const sectionTop = section.offsetTop;
                const sectionBottom = sectionTop + section.offsetHeight;
                
                if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
                    // Remover clase activa de todos los items
                    navItems.forEach(item => item.classList.remove('active'));
                    // Agregar clase activa al item correspondiente
                    navItems[index].classList.add('active');
                }
            });
        }
        
        // Event listeners para los items de navegación
        navItems.forEach((item, index) => {
            item.addEventListener('click', function() {
                const targetSection = sections[index];
                if (targetSection) {
                    // Scroll suave a la sección
                    const offsetTop = targetSection.offsetTop - 120; // Account for both navbars (mobile navbar + section nav)
                    window.scrollTo({
                        top: offsetTop,
                        behavior: 'smooth'
                    });
                    
                    // Actualizar item activo
                    navItems.forEach(navItem => navItem.classList.remove('active'));
                    this.classList.add('active');
                }
            });
        });
        
        // Actualizar item activo en scroll
        window.addEventListener('scroll', updateActiveNavItem);
        
        // Actualizar item activo inicial
        updateActiveNavItem();
    }
    
    // Función para cargar el análisis de consulta
    function cargarAnalisisConsulta() {
        cargarAnalisisGeneral();
        cargarComentariosCampos();
    }
    
    // Función para cargar el análisis general
    function cargarAnalisisGeneral() {
        const container = document.getElementById('analisis-general-content');
        if (!container) return;
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/comentarios-analista-credito/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.comentarios.length > 0) {
                    // Buscar el comentario más reciente del analista
                    const comentarioAnalista = data.comentarios.find(c => 
                        c.comentario && c.comentario.trim()
                    );
                    
                    if (comentarioAnalista) {
                        container.innerHTML = `
                            <div class="analisis-general-text">
                                ${escapeHtml(comentarioAnalista.comentario)}
                            </div>
                        `;
                        
                        // Actualizar información del analista en el header
                        actualizarInfoAnalista(comentarioAnalista);
                    } else {
                        container.innerHTML = `
                            <div class="analisis-placeholder">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>No hay análisis general disponible</small>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="analisis-placeholder">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>No hay análisis general disponible</small>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error al cargar análisis general:', error);
                container.innerHTML = `
                    <div class="analisis-placeholder">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small>Error al cargar el análisis general</small>
                    </div>
                `;
            });
    }
    
    // Función para actualizar la información del analista en el header
    function actualizarInfoAnalista(comentarioAnalista) {
        const analisisInfo = document.getElementById('analisis-info');
        const analistaNombre = document.getElementById('analista-nombre');
        const analisisFecha = document.getElementById('analisis-fecha');
        
        if (analisisInfo && analistaNombre && analisisFecha) {
            // Mostrar la información
            analisisInfo.style.display = 'block';
            
            // Actualizar nombre del analista
            analistaNombre.textContent = comentarioAnalista.usuario_nombre;
            
            // Formatear fecha
            const fecha = new Date(comentarioAnalista.fecha_creacion);
            const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            analisisFecha.textContent = fechaFormateada;
        }
    }
    
    // Función para cargar comentarios de campos
    function cargarComentariosCampos() {
        const container = document.getElementById('comentarios-campos-content');
        if (!container) return;
        
        fetch(`/workflow/api/solicitudes/${solicitudId}/calificaciones/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.calificaciones) {
                    // Filtrar calificaciones que tienen comentarios
                    const comentariosConContenido = data.calificaciones.filter(cal => 
                        cal.comentario && 
                        cal.comentario.trim() && 
                        !cal.campo.startsWith('comentario_analista_credito_')
                    );
                    
                    if (comentariosConContenido.length === 0) {
                        container.innerHTML = `
                            <div class="analisis-placeholder">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>No hay comentarios de campos disponibles</small>
                            </div>
                        `;
                        return;
                    }
                    
                    // Crear HTML de bullet points
                    const bulletsHTML = comentariosConContenido.map(cal => {
                        const fieldName = getFieldDisplayName(cal.campo);
                        const fieldValue = getFieldValue(cal.campo);
                        const comment = cal.comentario.trim();
                        
                        return `
                            <div class="bullet-item" data-field="${cal.campo}">
                                <div class="bullet-content">
                                    <div class="bullet-header">
                                        <strong class="bullet-title">${fieldName}</strong>
                                        <span class="bullet-value">${escapeHtml(fieldValue)}</span>
                                    </div>
                                    <div class="bullet-comment">
                                        <i class="fas fa-comment-dots text-primary me-1"></i>
                                        ${escapeHtml(comment)}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    container.innerHTML = bulletsHTML;
                } else {
                    container.innerHTML = `
                        <div class="analisis-placeholder">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>No hay comentarios de campos disponibles</small>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error al cargar comentarios de campos:', error);
                container.innerHTML = `
                    <div class="analisis-placeholder">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small>Error al cargar los comentarios de campos</small>
                    </div>
                `;
            });
    }
    
    // Función para obtener el nombre de visualización del campo
    function getFieldDisplayName(field) {
        const fieldNames = {
            'empresa_privada': 'Empresa Privada',
            'cargo': 'Cargo',
            'tiempo_servicio': 'Tiempo de Servicio',
            'salario': 'Salario',
            'score': 'Score',
            'politica': 'Política',
            'sector': 'Sector',
            'valor_equipo': 'Valor del Equipo',
            'abono': 'Abono',
            'monto_financiado': 'Monto Financiado',
            'total_letra': 'Monto en Letra',
            'plazo': 'Plazo',
            'tipo_producto': 'Tipo de Producto',
            'rentabilidad': 'Rentabilidad',
            'marca': 'Marca',
            'modelo': 'Modelo',
            'año': 'Año'
        };
        
        return fieldNames[field] || field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
    
    // Función para obtener el valor del campo desde el DOM
    function getFieldValue(field) {
        const fieldElement = document.querySelector(`[data-field="${field}"]`);
        if (!fieldElement) {
            return 'Sin valor';
        }
        
        const fieldRow = fieldElement.closest('.info-row-with-status');
        if (fieldRow) {
            const fieldValueElement = fieldRow.querySelector('.info-value');
            return fieldValueElement ? fieldValueElement.textContent.trim() : 'Sin valor';
        }
        
        return 'Sin valor';
    }
    
    // Función para escapar HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Función para descargar PDF Resultado Comité (para previsualización en modal)
    function descargarPdfResultadoComite() {
        const btnElement = event.target.closest('button');
        const originalContent = btnElement.innerHTML;
        
        try {
            // Show loading state
            btnElement.disabled = true;
            btnElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando PDF...';
            
            // Get solicitud ID from global variable
            if (!solicitudId) {
                throw new Error('No se pudo obtener el ID de la solicitud');
            }
            
            console.log('Generating PDF resultado comité preview for solicitud:', solicitudId);
            
            // Get current form data to include in preview
            const form = document.getElementById('form-participacion-comite-modal');
            const formData = new FormData(form);
            const resultado = formData.get('resultado');
            const comentario = formData.get('comentario');
            
            // Prepare preview data
            const previewData = {
                preview_mode: true,
                current_participation: {
                    resultado: resultado || '',
                    comentario: comentario || '',
                    nivel_id: nivelUsuarioId,
                    usuario_nombre: '{{ request.user.get_full_name|default:request.user.username|escapejs }}'
                }
            };
            
            console.log('Sending preview data:', previewData);
            
            // Make API call to generate PDF using the consulta template (like the email function)
            fetch(`/workflow/api/solicitudes/${solicitudId}/pdf-resultado-consulta/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify(previewData),
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Check if response is PDF
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/pdf')) {
                    throw new Error('La respuesta no es un archivo PDF válido');
                }
                
                return response.blob();
            })
            .then(blob => {
                // Create blob and download
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Preview_Resultado_Comite_${solicitudId}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                // Show success message
                mostrarToast('PDF generado correctamente', 'success');
            })
            .catch(error => {
                console.error('Error generating PDF:', error);
                mostrarToast(`Error al generar el PDF: ${error.message}`, 'error');
            })
            .finally(() => {
                // Restore button state
                btnElement.disabled = false;
                btnElement.innerHTML = originalContent;
            });
            
        } catch (error) {
            console.error('Error:', error);
            mostrarToast(`Error: ${error.message}`, 'error');
            btnElement.disabled = false;
            btnElement.innerHTML = originalContent;
        }
    }
    
    // PDF Resultado Comité functionality
    const generatePdfResultadoComite = async () => {
        const btnPdf = document.getElementById('btn-pdf-resultado-comite');
        const originalContent = btnPdf.innerHTML;
        
        try {
            // Show loading state
            btnPdf.disabled = true;
            btnPdf.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando reporte...';
            
            // Get solicitud ID from global variable
            if (!solicitudId) {
                throw new Error('No se pudo obtener el ID de la solicitud');
            }
            
            console.log('Generating PDF resultado comité for solicitud:', solicitudId);
            
            // Collect current committee data from the page
            const comiteData = collectComiteData();
            
            // Make API call to generate PDF
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/pdf-resultado-comite/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify(comiteData),
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                // Try to get error message from response
                let errorMessage = 'Error al generar el PDF';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                } catch (e) {
                    errorMessage = response.statusText || errorMessage;
                }
                throw new Error(errorMessage);
            }
            
            // Check if response is PDF
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/pdf')) {
                throw new Error('La respuesta no es un archivo PDF válido');
            }
            
            // Get filename from response headers or use default
            const contentDisposition = response.headers.get('content-disposition');
            let filename = `Resultado_Comite_${solicitudId}.pdf`;
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            // Create blob and download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            // Show success message
            mostrarToast('Reporte PDF comité generado y descargado exitosamente', 'success');
            
        } catch (error) {
            console.error('Error generating PDF resultado comité:', error);
            mostrarToast(`Error: ${error.message}`, 'error');
        } finally {
            // Restore button state
            btnPdf.disabled = false;
            btnPdf.innerHTML = originalContent;
        }
    };

    // Collect committee data from the current page
    const collectComiteData = () => {
        const data = {
            committee_comment: '',
            field_values: {}
        };
        
        // Get any committee comment if available
        const comiteTextarea = document.querySelector('#comentario-comite');
        if (comiteTextarea) {
            data.committee_comment = comiteTextarea.value.trim();
        }
        
        return data;
    };
    
    // Función para descargar PDF consolidado
    const downloadMergedPDF = async () => {
        const btnDownload = document.getElementById('btn-download-merged-pdf');
        if (!btnDownload) {
            mostrarToast('Error: No se pudo encontrar el botón de descarga', 'error');
            return;
        }
        const originalContent = btnDownload.innerHTML;
        
        try {
            // Show loading state
            btnDownload.disabled = true;
            btnDownload.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando PDF...';
            
            // Make API call to download PDF
            const response = await fetch(`/workflow/api/solicitudes/${solicitudId}/download-merged-pdf/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                // Try to get error message from response
                let errorMessage = 'Error al generar el PDF';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                } catch (e) {
                    // If response is not JSON, use status text
                    errorMessage = response.statusText || errorMessage;
                }
                throw new Error(errorMessage);
            }
            
            // Check if response is PDF
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/pdf')) {
                throw new Error('La respuesta no es un archivo PDF válido');
            }
            
            // Get filename from response headers or use default
            const contentDisposition = response.headers.get('content-disposition');
            let filename = 'Solicitud_Documentos_Completos.pdf';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            // Create blob and download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            // Show success message
            mostrarToast('PDF generado y descargado exitosamente', 'success');
            
        } catch (error) {
            console.error('Error downloading PDF:', error);
            mostrarToast(`Error: ${error.message}`, 'error');
        } finally {
            // Restore button state
            btnDownload.disabled = false;
            btnDownload.innerHTML = originalContent;
        }
    };
    
    // Agregar event listener para el botón de descarga de PDF
    document.addEventListener('DOMContentLoaded', function() {
        const btnDownloadPDF = document.getElementById('btn-download-merged-pdf');
        if (btnDownloadPDF) {
            btnDownloadPDF.addEventListener('click', downloadMergedPDF);
        }
        
        // Add event listener for PDF resultado comité button
        const btnPdfResultadoComite = document.getElementById('btn-pdf-resultado-comite');
        if (btnPdfResultadoComite) {
            btnPdfResultadoComite.addEventListener('click', generatePdfResultadoComite);
        }
        
        // Habilitar/deshabilitar botón de avanzar etapa según el resultado seleccionado
        const btnAvanzarEtapa = document.getElementById('btnAvanzarEtapa');
        
        // Función para verificar si hay participaciones y habilitar el botón
        function verificarParticipaciones() {
            const participaciones = document.querySelectorAll('.participacion-row');
            // Verificar que el botón existe antes de intentar modificar sus propiedades
            if (btnAvanzarEtapa) {
                btnAvanzarEtapa.disabled = participaciones.length === 0;
            }
        }
        
        // Verificar estado inicial solo si el botón existe
        if (btnAvanzarEtapa) {
            verificarParticipaciones();
        }
    });
    
    // Función para mostrar modal de avanzar etapa
    function mostrarModalAvanzarEtapa() {
        const modal = new bootstrap.Modal(document.getElementById('modalAvanzarEtapa'));
        
        // Resetear subestados
        const divSubestados = document.getElementById('divSubestados');
        const selectSubestado = document.getElementById('selectSubestadoDestino');
        divSubestados.style.display = 'none';
        selectSubestado.innerHTML = '<option value="">Seleccione un subestado (opcional)...</option>';
        
        cargarEtapasDisponibles();
        modal.show();
    }
    
    // Variable global para almacenar las etapas con sus subestados
    let etapasDisponibles = [];
    
    // Función para cargar etapas disponibles
    function cargarEtapasDisponibles() {
        const selectEtapas = document.getElementById('selectEtapaDestino');
        selectEtapas.innerHTML = '<option value="">Cargando etapas...</option>';
        
        fetch(`/workflow/api/comite/solicitudes/${solicitudId}/etapas-disponibles/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    selectEtapas.innerHTML = '<option value="">Seleccione una etapa...</option>';
                    etapasDisponibles = data.etapas; // Guardar para uso posterior
                    data.etapas.forEach(etapa => {
                        selectEtapas.innerHTML += `<option value="${etapa.id}">${etapa.nombre}</option>`;
                    });
                } else {
                    selectEtapas.innerHTML = '<option value="">Error al cargar etapas</option>';
                    mostrarToast('Error al cargar etapas disponibles', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                selectEtapas.innerHTML = '<option value="">Error al cargar etapas</option>';
                mostrarToast('Error al cargar etapas disponibles', 'error');
            });
    }
    
    // Función para cargar subestados cuando se selecciona una etapa
    function cargarSubestados() {
        const selectEtapa = document.getElementById('selectEtapaDestino');
        const selectSubestado = document.getElementById('selectSubestadoDestino');
        const divSubestados = document.getElementById('divSubestados');
        
        const etapaId = selectEtapa.value;
        
        if (!etapaId) {
            divSubestados.style.display = 'none';
            return;
        }
        
        // Buscar la etapa seleccionada en las etapas disponibles
        const etapaSeleccionada = etapasDisponibles.find(etapa => etapa.id == etapaId);
        
        if (etapaSeleccionada && etapaSeleccionada.subestados && etapaSeleccionada.subestados.length > 0) {
            // Mostrar el div de subestados
            divSubestados.style.display = 'block';
            
            // Cargar los subestados
            selectSubestado.innerHTML = '<option value="">Seleccione un subestado (opcional)...</option>';
            etapaSeleccionada.subestados.forEach(subestado => {
                selectSubestado.innerHTML += `<option value="${subestado.id}">${subestado.nombre}</option>`;
            });
        } else {
            // Ocultar el div de subestados si no hay subestados
            divSubestados.style.display = 'none';
            selectSubestado.innerHTML = '<option value="">Seleccione un subestado (opcional)...</option>';
        }
    }
    
    // Función para avanzar etapa
    function avanzarEtapa() {
        const selectEtapa = document.getElementById('selectEtapaDestino');
        const selectSubestado = document.getElementById('selectSubestadoDestino');
        const etapaId = selectEtapa.value;
        const subestadoId = selectSubestado.value;
        
        if (!etapaId) {
            mostrarToast('Por favor seleccione una etapa', 'error');
            return;
        }
        
        const btnAvanzar = document.getElementById('btnConfirmarAvanzar');
        if (!btnAvanzar) {
            mostrarToast('Error: No se pudo encontrar el botón de avanzar', 'error');
            return;
        }
        const originalText = btnAvanzar.innerHTML;
        
        btnAvanzar.disabled = true;
        btnAvanzar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        
        fetch(`/workflow/api/comite/solicitudes/${solicitudId}/avanzar-etapa/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                etapa_destino_id: etapaId,
                subestado_destino_id: subestadoId || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Solicitud avanzada exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalAvanzarEtapa')).hide();
                
                // Redirigir después de un breve delay
                setTimeout(() => {
                    window.location.href = '/workflow/comite/';
                }, 1500);
            } else {
                mostrarToast('Error al avanzar etapa: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarToast('Error al avanzar etapa', 'error');
        })
        .finally(() => {
            btnAvanzar.disabled = false;
            btnAvanzar.innerHTML = originalText;
        });
    }
    
    // Función para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Función para mostrar toast
    function mostrarToast(mensaje, tipo = 'info') {
        // Implementar función de toast si no existe
        if (typeof showToast === 'function') {
            showToast(mensaje, tipo);
        } else {
            alert(mensaje);
        }
    }

    // Función para mostrar modal de decisión final
    function mostrarModalDecisionFinal() {
        const modal = new bootstrap.Modal(document.getElementById('modalDecisionFinal'));
        
        // Llenar el resumen de participaciones y preseleccionar valores
        llenarResumenParticipaciones();
        
        // Habilitar/deshabilitar botón basado en checkbox
        const confirmacion = document.getElementById('confirmacionEnvio');
        const decisionSelect = document.getElementById('decisionFinal');
        const btnEnviar = document.querySelector('.btn-enviar-decision');
        
        function actualizarBoton() {
            btnEnviar.disabled = !confirmacion.checked || !decisionSelect.value;
        }
        
        confirmacion.addEventListener('change', actualizarBoton);
        decisionSelect.addEventListener('change', actualizarBoton);
        
        modal.show();
    }
    
    // Función para llenar el resumen de participaciones en el modal
    function llenarResumenParticipaciones() {
        const tbody = document.getElementById('resumenParticipaciones');
        const decisionSelect = document.getElementById('decisionFinal');
        const comentarioTextarea = document.getElementById('comentarioFinal');
        tbody.innerHTML = '';
        
        // Obtener participaciones actuales de la tabla
        const participacionRows = document.querySelectorAll('.participacion-row');
        let latestParticipation = null;
        let latestDate = null;
        
        participacionRows.forEach(row => {
            const celdas = row.querySelectorAll('td');
            if (celdas.length >= 5) {
                // Create summary row
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${celdas[0].textContent.trim()}</td>
                    <td>${celdas[1].textContent.trim()}</td>
                    <td>${celdas[2].innerHTML}</td>
                    <td>${celdas[4].textContent.trim()}</td>
                `;
                tbody.appendChild(tr);
                
                // Track the latest participation for preselection
                const fechaText = celdas[4].textContent.trim();
                const resultadoBadge = celdas[2].querySelector('.badge');
                const comentarioDiv = celdas[3].querySelector('.comentario-preview');
                
                if (fechaText && resultadoBadge && comentarioDiv) {
                    // Parse the date (format: dd/mm/yyyy hh:mm)
                    const [datePart, timePart] = fechaText.split(' ');
                    const [day, month, year] = datePart.split('/');
                    const [hour, minute] = timePart.split(':');
                    const participationDate = new Date(year, month - 1, day, hour, minute);
                    
                    if (!latestDate || participationDate > latestDate) {
                        latestDate = participationDate;
                        
                        // Get the result from the badge class
                        const badgeClasses = resultadoBadge.className;
                        let resultado = '';
                        if (badgeClasses.includes('resultado-APROBADO')) {
                            resultado = 'Aprobado';
                        } else if (badgeClasses.includes('resultado-RECHAZADO')) {
                            resultado = 'Rechazado';
                        } else if (badgeClasses.includes('resultado-OBSERVACIONES')) {
                            resultado = 'Solicitar Observaciones';
                        }
                        
                        // Get the full comment (check if there's a "Ver más" button)
                        let comentario = comentarioDiv.textContent.trim();
                        const verMasBtn = celdas[3].querySelector('button[onclick*="mostrarComentarioCompleto"]');
                        if (verMasBtn) {
                            // Extract the full comment from the onclick attribute
                            const onclickAttr = verMasBtn.getAttribute('onclick');
                            const match = onclickAttr.match(/mostrarComentarioCompleto\('(.+?)'\)/);
                            if (match && match[1]) {
                                // Decode HTML entities and escape sequences
                                comentario = match[1]
                                    .replace(/\\'/g, "'")
                                    .replace(/\\"/g, '"')
                                    .replace(/&lt;/g, '<')
                                    .replace(/&gt;/g, '>')
                                    .replace(/&amp;/g, '&');
                            }
                        }
                        
                        latestParticipation = {
                            resultado: resultado,
                            comentario: comentario
                        };
                    }
                }
            }
        });
        
        // Preselect the decision and prefill the comment based on latest participation
        if (latestParticipation) {
            if (latestParticipation.resultado) {
                decisionSelect.value = latestParticipation.resultado;
            }
            if (latestParticipation.comentario) {
                comentarioTextarea.value = latestParticipation.comentario;
            }
        }
        
        // Trigger change event to update button state
        decisionSelect.dispatchEvent(new Event('change'));
    }
    
    // Función para enviar la decisión final
    function enviarDecisionFinal() {
        const decisionFinal = document.getElementById('decisionFinal').value;
        const comentarioFinal = document.getElementById('comentarioFinal').value;
        
        if (!decisionFinal) {
            mostrarToast('Por favor seleccione una decisión final', 'error');
            return;
        }
        
        const btnEnviar = document.querySelector('.btn-enviar-decision');
        btnEnviar.disabled = true;
        btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando...';
        
        // Hacer la llamada al API para enviar la decisión final
        fetch(`/workflow/api/comite/decision-final/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({
                solicitud_id: solicitudId,
                decision_final: decisionFinal,
                comentario_final: comentarioFinal
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast('Decisión final enviada exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalDecisionFinal')).hide();
                
                // Ocultar el botón de decisión final
                document.getElementById('btnDecisionFinal').style.display = 'none';
                
                // Recargar la página después de un breve delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                mostrarToast('Error: ' + (data.error || 'No se pudo enviar la decisión final'), 'error');
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Enviar Decisión Final';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarToast('Error de conexión. Por favor intente de nuevo.', 'error');
            btnEnviar.disabled = false;
            btnEnviar.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Enviar Decisión Final';
        });
    }
</script>

<!-- Modal para Avanzar Etapa -->
<div class="modal fade" id="modalAvanzarEtapa" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-forward me-2"></i>Resultado de Comité
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Confirmación:</strong> Al avanzar la etapa, se enviará un correo automático con todos los comentarios del comité ordenados por nivel de jerarquía.
                </div>
                
                <div class="mb-3">
                    <label for="selectEtapaDestino" class="form-label">Etapa Destino *</label>
                    <select class="form-control" id="selectEtapaDestino" required onchange="cargarSubestados()">
                        <option value="">Seleccione una etapa...</option>
                    </select>
                </div>
                
                <div class="mb-3" id="divSubestados" style="display: none;">
                    <label for="selectSubestadoDestino" class="form-label">Subestado Destino</label>
                    <select class="form-control" id="selectSubestadoDestino">
                        <option value="">Seleccione un subestado (opcional)...</option>
                    </select>
                    <small class="form-text text-muted">Si la etapa tiene subestados, puede seleccionar uno específico. Si no selecciona ninguno, se usará el subestado por defecto.</small>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Importante:</strong> Esta acción no se puede deshacer. La solicitud avanzará a la etapa seleccionada y se enviará la notificación correspondiente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarAvanzar" onclick="avanzarEtapa()">
                    <i class="fas fa-forward me-1"></i>Resultado de Comité
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %} 