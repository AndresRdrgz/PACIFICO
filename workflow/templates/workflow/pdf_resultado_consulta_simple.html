<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Resultado de Consulta - {{ solicitud.codigo }}</title>
    <style>
        /* Estilos simples compatibles con xhtml2pdf - Optimizado para una página */
        body {
            font-family: Arial, sans-serif;
            margin: 15px;
            font-size: 10px;
            line-height: 1.2;
        }
        
        .header {
            text-align: center;
            background: #009c3c;
            color: white;
            padding: 10px;
            
            
        }
        
        .header .logo {
            width: 40px;
            height: auto;
            margin-bottom: 5px;
            filter: brightness(0) invert(1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 16px;
        }
        
        .header .subtitle {
            margin: 2px 0 0 0;
            font-size: 10px;
        }
        
        .header .code {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 4px;
            font-size: 9px;
        }
        
        .section {
            margin-bottom: 8px;
            padding: 6px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: bold;
            color: #009c3c;
            margin-bottom: 4px;
            border-bottom: 1px solid #3b82f6;
            padding-bottom: 1px;
        }
        
        .info-grid {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
            font-size: 9px;
        }
        
        .info-grid td {
            padding: 3px 6px;
            border: 1px solid #d1d5db;
            vertical-align: top;
        }
        
        .info-grid .label {
            background: #f3f4f6;
            font-weight: bold;
            width: 35%;
        }
        
        .info-grid .value {
            background: white;
        }
        
        /* Layout compacto en tabla para máximo aprovechamiento */
        .info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            line-height: 1.2;
        }
        
        .info-table td {
            padding: 2px 4px;
            border: none;
            vertical-align: top;
            width: 25%; /* 4 columnas */
        }
        
        .info-table .label {
            font-weight: bold;
            color: #009c3c;
            white-space: nowrap;
        }
        
        .info-table .value {
            color: #374151;
        }
        
        /* Layout compacto para evaluaciones */
        .eval-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8px;
            line-height: 1.2;
            margin-bottom: 6px;
        }
        
        .eval-table td {
            padding: 2px 3px;
            border: 1px solid #e5e7eb;
            vertical-align: top;
        }
        
        .eval-table .eval-field {
            font-weight: bold;
            color: #009c3c;
            background: #f8fafc;
            width: 35%;
            font-size: 7px;
        }
        
        .eval-table .eval-status {
            text-align: center;
            width: 10%;
            font-weight: bold;
        }
        
        .eval-table .eval-comment {
            color: #4b5563;
            font-style: italic;
            font-size: 7px;
            width: 55%;
        }
        
        .eval-table .status-good {
            color: #22c55e;
            background: #f0fdf4;
        }
        
        .eval-table .status-bad {
            color: #ef4444;
            background: #fef2f2;
        }
        
        /* Análisis compacto */
        .analysis-compact {
            background: #f8fafc;
            border-left: 3px solid #10b981;
            padding: 4px 6px;
            font-size: 8px;
            line-height: 1.3;
            margin-bottom: 4px;
        }
        
        /* Comentarios en tabla compacta */
        .comments-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 7px;
            margin-top: 4px;
        }
        
        .comments-table td {
            padding: 2px 4px;
            border: 1px solid #e5e7eb;
            vertical-align: top;
        }
        
        .comments-table .comment-author {
            font-weight: bold;
            color: #009c3c;
            width: 25%;
            background: #f8fafc;
        }
        
        .comments-table .comment-date {
            color: #6b7280;
            width: 15%;
            font-size: 6px;
        }
        
        .comments-table .comment-text {
            color: #374151;
        }
        
        .bullet-item {
            margin-bottom: 3px;
            padding: 2px 0;
        }
        
        .bullet-item strong {
            color: #009c3c;
            font-weight: bold;
        }
        
        .calificacion {
            border: 1px solid #d1d5db;
            border-radius: 3px;
            padding: 4px;
            margin-bottom: 4px;
            font-size: 9px;
        }
        
        .calificacion.bueno {
            border-color: #22c55e;
            background: #f0fdf4;
        }
        
        .calificacion.malo {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .calificacion-header {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .estado-bueno {
            color: #22c55e;
            font-weight: bold;
        }
        
        .estado-malo {
            color: #ef4444;
            font-weight: bold;
        }
        
        .comentario {
            font-style: italic;
            color: #4b5563;
            margin-top: 3px;
            padding: 3px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 2px;
            font-size: 8px;
        }
        
        .analisis {
            background: #f8fafc;
            padding: 6px;
            border-radius: 4px;
            border-left: 2px solid #10b981;
            font-size: 9px;
        }
        
        .comentario-historico {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 3px;
            padding: 4px;
            margin-bottom: 4px;
            font-size: 8px;
        }
        
        .comentario-meta {
            font-size: 7px;
            color: #6b7280;
            margin-bottom: 3px;
        }
        
        .footer {
            background: #111827;
            color: white;
            padding: 8px;
            text-align: center;
            margin-top: 15px;
            border-radius: 4px;
            font-size: 8px;
        }
        
        .footer-info {
            margin-bottom: 5px;
        }
        
        /* Dos columnas para optimizar espacio */
        .two-columns {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        .column {
            display: table-cell;
            width: 50%;
            vertical-align: top;
            padding-right: 8px;
        }
        
        .column:last-child {
            padding-right: 0;
            padding-left: 8px;
        }
        
        /* Estilos para participaciones del comité */
        .comite-section {
            margin-bottom: 8px;
            padding: 6px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: #f8fafc;
        }
        
        .comite-title {
            font-size: 11px;
            font-weight: bold;
            color: #009c3c;
            margin-bottom: 6px;
            border-bottom: 1px solid #3b82f6;
            padding-bottom: 2px;
        }
        
        .participacion-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8px;
            margin-bottom: 4px;
        }
        
        .participacion-table td {
            padding: 3px 4px;
            border: 1px solid #e5e7eb;
            vertical-align: top;
        }
        
        .participacion-table .header {
            background: #009c3c;
            color: white;
            font-weight: bold;
            text-align: center;
        }
        
        .participacion-table .nivel-header {
            background: #3b82f6;
            color: white;
            font-weight: bold;
            text-align: left;
            font-size: 9px;
        }
        
        .participacion-table .participante {
            font-weight: bold;
            color: #374151;
            width: 25%;
        }
        
        .participacion-table .resultado {
            text-align: center;
            width: 15%;
            font-weight: bold;
        }
        
        .participacion-table .resultado-aprobado {
            color: #22c55e;
            background: #f0fdf4;
        }
        
        .participacion-table .resultado-rechazado {
            color: #ef4444;
            background: #fef2f2;
        }
        
        .participacion-table .resultado-observaciones {
            color: #f59e0b;
            background: #fef3c7;
        }
        
        .participacion-table .comentario {
            color: #4b5563;
            font-style: italic;
            width: 40%;
        }
        
        .participacion-table .fecha {
            color: #6b7280;
            font-size: 7px;
            width: 20%;
        }
    </style>
</head>
<body>
    <!-- Header Compacto -->
    <div class="header">
        <h1>Resultado de Consulta - {{ solicitud.codigo }} - {{ fecha_generacion|date:"d/m/Y H:i" }}</h1>
        
      </div>

    <!-- Información General - Layout ultra compacto en tabla -->
    <div class="section">
        <div class="section-title">Información General</div>
        
        <table class="info-table">
            <!-- Fila 1: Cliente -->
            <tr>
                <td class="label">Nombre negocio:</td>
                <td class="value">{{ solicitud.cliente.nombreCliente|default:"-" }}</td>
                <td class="label">Cédula:</td>
                <td class="value">{{ solicitud.cliente.cedulaCliente|default:"-" }}</td>
            </tr>
            
            <!-- Fila 2: Proceso -->
            <tr>
                <td class="label">Oficial:</td>
                <td class="value">
                    {% if solicitud.propietario %}
                        {% if solicitud.propietario.first_name and solicitud.propietario.last_name %}
                            {{ solicitud.propietario.first_name }} {{ solicitud.propietario.last_name }}
                        {% else %}
                            {{ solicitud.propietario.username }}
                        {% endif %}
                    {% else %}
                        Sin asignar
                    {% endif %}
                </td>
                <td class="label">Fecha Consulta:</td>
                <td class="value">{{ fecha_consulta|date:"d/m/Y g:i A"|default:"-" }}</td>
            </tr>
            
            
            
            
            <!-- Fila 4: Vehículo -->
            {% if solicitud.cotizacion %}
            <tr>
                <td class="label">Marca:</td>
                <td class="value">{{ solicitud.cotizacion.marca|default:"-" }}</td>
                <td class="label">Modelo:</td>
                <td class="value">{{ solicitud.cotizacion.modelo|default:"-" }}</td>
            </tr>
            <tr>
                <td class="label">Año:</td>
                <td class="value">{{ solicitud.cotizacion.yearCarro|default:"-" }}</td>
                <td class="label">Valor:</td>
                <td class="value">
                    {% if solicitud.cotizacion.valorAuto %}
                        {{ solicitud.cotizacion.valorAuto|floatformat:0 }} $
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            
            
            
            <!-- Fila 5: Financiamiento -->
            <tr>
                <td class="label">Abono:</td>
                <td class="value">
                    {% if solicitud.cotizacion.abono %}
                        {{ solicitud.cotizacion.abono|floatformat:0 }} $
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="label">% Abono:</td>
                <td class="value">{{ solicitud.cotizacion.abonoPorcentaje|default:"-" }}%</td>
            </tr>
            <tr>
                <td class="label">A financiar:</td>
                <td class="value">
                    {% if solicitud.cotizacion.montoPrestamo %}
                        {{ solicitud.cotizacion.montoPrestamo|floatformat:0 }} $
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td colspan="2"></td> <!-- Celda vacía para completar la fila -->
            </tr>
            {% else %}
            <!-- Si no hay cotización -->
            <tr>
                <td class="label">Marca:</td>
                <td class="value">-</td>
                <td class="label">Modelo:</td>
                <td class="value">-</td>
            </tr>
            <tr>
                <td class="label">Año:</td>
                <td class="value">-</td>
                <td class="label">Valor:</td>
                <td class="value">-</td>
            </tr>
            <tr><td colspan="4"><div class="section-separator"></div></td></tr>
            <tr>
                <td class="label">Abono:</td>
                <td class="value">-</td>
                <td class="label">A financiar:</td>
                <td class="value">-</td>
            </tr>
            {% endif %}
        </table>
        
        {% if solicitud.motivo_consulta %}
        <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb; font-size: 9px;">
            <span style="font-weight: bold; color: #009c3c;">Motivo:</span> {{ solicitud.motivo_consulta }}
        </div>
        {% endif %}
    </div>

    {% if calificaciones %}
    <!-- Evaluación y Análisis - Layout ultra compacto -->
    <div class="section">
        <div class="section-title">Evaluación y Análisis</div>
        
        <!-- Análisis del analista como párrafo principal -->
        {% if analyst_comment %}
        <div class="analysis-compact" style="margin-bottom: 6px; padding: 6px 8px; font-size: 9px; line-height: 1.4;">
            <strong style="color: #009c3c; font-size: 9px;">Comentarios del Analista:</strong> 
            {% if analyst_user %}
                <span style="color: #6b7280; font-size: 8px;">
                    por {{ analyst_user.first_name }} {{ analyst_user.last_name }}
                    {% if analyst_date %} - {{ analyst_date|date:"d/m/Y g:i A" }}{% endif %}
                </span><br>
            {% endif %}
            {{ analyst_comment }}
        </div>
        {% endif %}
        
        <!-- Resultado de análisis -->
        {% if resultado_analisis %}
        <div class="analysis-compact" style="margin-bottom: 8px; padding: 4px 8px; font-size: 9px; line-height: 1.4; background: #f0f9ff; border-left: 3px solid #0ea5e9;">
            <strong style="color: #0ea5e9; font-size: 9px;">Resultado:</strong> 
            <span style="font-weight: bold; 
                {% if resultado_analisis == 'Aprobado' %}color: #22c55e;
                {% elif resultado_analisis == 'Rechazado' %}color: #ef4444;
                {% else %}color: #f59e0b;{% endif %}">{{ resultado_analisis }}</span>
        </div>
        {% endif %}
        
        <!-- Calificaciones organizadas en layout 2x2 -->
        
        <!-- Primera fila: Información del Cliente + Detalle de la Solicitud -->
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 8px;">
            <tr>
                <!-- Sección 1: Información del Cliente -->
                <td style="width: 50%; vertical-align: top; padding-right: 8px;">
                    <div style="font-weight: bold; color: #009c3c; font-size: 10px; margin-bottom: 4px; border-bottom: 1px solid #e5e7eb; padding-bottom: 2px;">
                        Información del Cliente
                    </div>
                    <table class="eval-table">
                        {% for cal in calificaciones %}
                            {% if cal.campo in 'empresa_privada,cargo,tiempo_servicio,salario,score,politica,sector' and 'comentario_analista_credito' not in cal.campo %}
                                <tr>
                                    <td class="eval-field">{{ cal.campo_legible|default:cal.campo }}</td>
                                    <td class="eval-status {% if cal.estado == 'bueno' %}status-good{% else %}status-bad{% endif %}">
                                        {% if cal.estado == 'bueno' %}✓{% else %}✗{% endif %}
                                    </td>
                                    <td class="eval-comment">
                                        {% if cal.comentario %}
                                            {{ cal.comentario }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                </td>
                
                <!-- Sección 2: Detalle de la Solicitud -->
                <td style="width: 50%; vertical-align: top; padding-left: 8px;">
                    <div style="font-weight: bold; color: #009c3c; font-size: 10px; margin-bottom: 4px; border-bottom: 1px solid #e5e7eb; padding-bottom: 2px;">
                        Detalle de la Solicitud
                    </div>
                    <table class="eval-table">
                        {% for cal in calificaciones %}
                            {% if cal.campo in 'valor_equipo,abono,monto_financiado,plazo,rentabilidad,total_letra' and 'comentario_analista_credito' not in cal.campo %}
                                <tr>
                                    <td class="eval-field">{{ cal.campo_legible|default:cal.campo }}</td>
                                    <td class="eval-status {% if cal.estado == 'bueno' %}status-good{% else %}status-bad{% endif %}">
                                        {% if cal.estado == 'bueno' %}✓{% else %}✗{% endif %}
                                    </td>
                                    <td class="eval-comment">
                                        {% if cal.comentario %}
                                            {{ cal.comentario }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                </td>
            </tr>
        </table>
        
        <!-- Segunda fila: Datos del Vehículo + Adjuntos -->
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 8px;">
            <tr>
                <!-- Sección 3: Datos del Vehículo -->
                <td style="width: 50%; vertical-align: top; padding-right: 8px;">
                    <div style="font-weight: bold; color: #009c3c; font-size: 10px; margin-bottom: 4px; border-bottom: 1px solid #e5e7eb; padding-bottom: 2px;">
                        Datos del Vehículo
                    </div>
                    <table class="eval-table">
                        {% for cal in calificaciones %}
                            {% if cal.campo in 'marca,modelo,año,transmision,kilometraje' and 'comentario_analista_credito' not in cal.campo %}
                                <tr>
                                    <td class="eval-field">{{ cal.campo_legible|default:cal.campo }}</td>
                                    <td class="eval-status {% if cal.estado == 'bueno' %}status-good{% else %}status-bad{% endif %}">
                                        {% if cal.estado == 'bueno' %}✓{% else %}✗{% endif %}
                                    </td>
                                    <td class="eval-comment">
                                        {% if cal.comentario %}
                                            {{ cal.comentario }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                </td>
                
                <!-- Sección 4: Adjuntos -->
                <td style="width: 50%; vertical-align: top; padding-left: 8px;">
                    <div style="font-weight: bold; color: #009c3c; font-size: 10px; margin-bottom: 4px; border-bottom: 1px solid #e5e7eb; padding-bottom: 2px;">
                        Adjuntos
                    </div>
                    <table class="eval-table">
                        {% for cal in calificaciones %}
                            {% if 'doc_' in cal.campo and 'comentario_analista_credito' not in cal.campo %}
                                <tr>
                                    <td class="eval-field">{{ cal.campo_legible|default:cal.campo }}</td>
                                    <td class="eval-status {% if cal.estado == 'bueno' %}status-good{% else %}status-bad{% endif %}">
                                        {% if cal.estado == 'bueno' %}✓{% else %}✗{% endif %}
                                    </td>
                                    <td class="eval-comment">
                                        {% if cal.comentario %}
                                            {{ cal.comentario }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                </td>
            </tr>
        </table>
        
    </div>
    {% else %}
    <!-- Solo análisis si no hay calificaciones -->
    <div class="section">
        <div class="section-title">Análisis del Analista</div>
        
        {% if analyst_comment %}
        <div class="analisis">
            {% if analyst_user %}
                <div style="font-size: 8px; color: #6b7280; margin-bottom: 4px;">
                    <strong>Analista:</strong> {{ analyst_user.first_name }} {{ analyst_user.last_name }}
                    {% if analyst_date %} - {{ analyst_date|date:"d/m/Y g:i A" }}{% endif %}
                </div>
            {% endif %}
            {{ analyst_comment }}
        </div>
        {% endif %}
        
        <!-- Resultado de análisis -->
        {% if resultado_analisis %}
        <div class="analisis" style="margin-top: 6px; background: #f0f9ff; border-left: 3px solid #0ea5e9; font-size: 9px;">
            <strong style="color: #0ea5e9;">Resultado:</strong> 
            <span style="font-weight: bold; 
                {% if resultado_analisis == 'Aprobado' %}color: #22c55e;
                {% elif resultado_analisis == 'Rechazado' %}color: #ef4444;
                {% else %}color: #f59e0b;{% endif %}">{{ resultado_analisis }}</span>
        </div>
        {% endif %}

        {% if comentarios_analista %}
        <div style="margin-top: 8px;">
            <strong style="font-size: 9px; margin-bottom: 4px; display: block;">Comentarios Históricos</strong>
            {% for comentario in comentarios_analista|slice:":3" %}
            <div class="comentario-historico">
                <div class="comentario-meta">
                    <strong>{{ comentario.usuario.first_name }} {{ comentario.usuario.last_name }}</strong> - 
                    {{ comentario.fecha_creacion|date:"d/m/Y H:i" }}
                </div>
                <div>{{ comentario.contenido }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Participaciones del Comité - Solo mostrar si hay al menos 1 participación -->
    {% if participaciones_comite %}
    <div class="comite-section">
        <div class="comite-title">Participaciones del Comité de Crédito{% if is_preview_mode %} (Vista Previa){% endif %}</div>
        
        <table class="participacion-table">
            <!-- Header de la tabla -->
            <tr>
                <td class="header">Participante</td>
                <td class="header">Resultado</td>
                <td class="header">Comentario</td>
                <td class="header">Fecha</td>
            </tr>
            
            <!-- Agrupar por nivel y mostrar participaciones -->
            {% regroup participaciones_comite by nivel as participaciones_por_nivel %}
            {% for nivel in participaciones_por_nivel %}
                <!-- Separador de nivel -->
                <tr>
                    <td colspan="4" class="nivel-header">{{ nivel.grouper }}</td>
                </tr>
                
                <!-- Participaciones del nivel -->
                {% for participacion in nivel.list %}
                <tr{% if participacion.is_preview %} style="background-color: #fff3cd; border: 1px dashed #856404;"{% endif %}>
                    <td class="participante">
                        {{ participacion.usuario }}{% if participacion.is_preview %} (Borrador){% endif %}
                    </td>
                    <td class="resultado 
                        {% if participacion.resultado == 'APROBADO' %}resultado-aprobado
                        {% elif participacion.resultado == 'RECHAZADO' %}resultado-rechazado
                        {% elif participacion.resultado == 'OBSERVACIONES' %}resultado-observaciones
                        {% endif %}">
                        {{ participacion.resultado|default:"Sin resultado" }}
                    </td>
                    <td class="comentario">
                        {% if participacion.comentario %}
                            {{ participacion.comentario }}
                        {% else %}
                            Sin comentario
                        {% endif %}
                    </td>
                    <td class="fecha">
                        {% if participacion.fecha_modificacion %}
                            {{ participacion.fecha_modificacion|date:"d/m/Y H:i" }}
                        {% else %}
                            Sin fecha
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            {% endfor %}
        </table>
    </div>
    {% endif %}

    <!-- Historial de Reconsideraciones - Mostrar todas cronológicamente -->
    {% if reconsideraciones_data %}
    <div class="comite-section">
        <div class="comite-title">Historial de Reconsideraciones{% if is_preview_mode %} (Vista Previa){% endif %}</div>
        
        <!-- Summary information -->
        <div style="margin-bottom: 8px; padding: 4px; background: #f0f9ff; border-radius: 4px; font-size: 8px; color: #374151;">
            <strong>Total de reconsideraciones:</strong> {{ reconsideraciones_data|length }}
            {% if reconsideraciones_data %}
            {% with ultima_reconsideracion=reconsideraciones_data|last %}
            • <strong>Más reciente:</strong> #{{ ultima_reconsideracion.numero_reconsideracion }}
            {% endwith %}
            {% endif %}
        </div>
        
        <!-- Iterate through all reconsiderations -->
        {% for reconsideracion in reconsideraciones_data %}
        <div style="margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 4px; background: {% if forloop.last %}#f0fdf4{% else %}#f8fafc{% endif %};">
            <!-- Reconsideration header -->
            <div style="padding: 4px 6px; background: {% if forloop.last %}#22c55e{% else %}#6b7280{% endif %}; color: white; border-radius: 4px 4px 0 0; font-size: 9px; font-weight: bold;">
                Reconsideración #{{ reconsideracion.numero_reconsideracion }}
                {% if forloop.last %} (Más Reciente){% endif %}
                {% if reconsideracion.is_preview %} (Vista Previa){% endif %}
            </div>
            
            <!-- Información básica de la reconsideración -->
            <div style="padding: 6px; background: #f8fafc;">
                <table class="info-table">
                    <tr>
                        <td class="label">Estado:</td>
                        <td class="value" style="
                            {% if reconsideracion.estado == 'aprobada' %}color: #22c55e; font-weight: bold;
                            {% elif reconsideracion.estado == 'rechazada' %}color: #ef4444; font-weight: bold;
                            {% elif reconsideracion.estado == 'alternativa' %}color: #f59e0b; font-weight: bold;
                            {% else %}color: #6b7280;{% endif %}">
                            {% if reconsideracion.estado == 'aprobada' %}✓ Aprobada
                            {% elif reconsideracion.estado == 'rechazada' %}✗ Rechazada
                            {% elif reconsideracion.estado == 'alternativa' %}⚠ Alternativa
                            {% else %}{{ reconsideracion.estado|capfirst }}{% endif %}
                        </td>
                        <td class="label">Fecha Solicitud:</td>
                        <td class="value">{{ reconsideracion.fecha_solicitud|date:"d/m/Y H:i" }}</td>
                    </tr>
                    <tr>
                        <td class="label">Solicitada Por:</td>
                        <td class="value">{{ reconsideracion.solicitada_por_nombre }}</td>
                        {% if reconsideracion.fecha_analisis %}
                        <td class="label">Fecha Análisis:</td>
                        <td class="value">{{ reconsideracion.fecha_analisis|date:"d/m/Y H:i" }}</td>
                        {% else %}
                        <td class="label">Estado Análisis:</td>
                        <td class="value" style="color: #f59e0b; font-style: italic;">Pendiente</td>
                        {% endif %}
                    </tr>
                    {% if reconsideracion.fecha_analisis %}
                    <tr>
                        <td class="label">Analizada Por:</td>
                        <td class="value">{{ reconsideracion.analizada_por_nombre|default:"Sin analista" }}</td>
                        <td class="label">Resultado Anterior:</td>
                        <td class="value">{{ reconsideracion.resultado_consulta_anterior|default:"N/A" }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
            
            <!-- Motivo de la reconsideración -->
            {% if reconsideracion.motivo %}
            <div style="margin: 6px; padding: 6px; background: #fff7ed; border-left: 3px solid #f59e0b; border-radius: 4px;">
                <div style="font-size: 8px; color: #374151; line-height: 1.4;">
                    <span style="font-weight: bold; color: #f59e0b; font-size: 9px;">Motivo:</span> {{ reconsideracion.motivo }}
                </div>
            </div>
            {% endif %}
            
            <!-- Comentario del análisis -->
            {% if reconsideracion.comentario_analisis %}
            <div style="margin: 6px; padding: 6px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 4px;">
                <div style="font-size: 8px; color: #374151; line-height: 1.4;">
                    <span style="font-weight: bold; color: #3b82f6; font-size: 9px;">Análisis{% if reconsideracion.is_preview %} (Vista Previa){% endif %}:</span> {{ reconsideracion.comentario_analisis }}
                </div>
            </div>
            {% endif %}
            
            <!-- Decisión de la reconsideración (si está en modo vista previa) -->
            {% if reconsideracion.decision_preview %}
            <div style="margin: 6px; padding: 6px; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 4px;">
                <div style="font-weight: bold; color: #f59e0b; font-size: 9px; margin-bottom: 3px;">
                    Decisión Propuesta (Vista Previa):
                </div>
                <div style="font-size: 8px; color: #374151; line-height: 1.4;">
                    {% if reconsideracion.decision_preview == 'aprobar' %}✓ Aprobar - Aceptar la reconsideración y proceder con la nueva condición
                    {% elif reconsideracion.decision_preview == 'rechazar' %}✗ Rechazar - Mantener la decisión anterior y rechazar la reconsideración
                    {% elif reconsideracion.decision_preview == 'alternativa' %}↻ Alternativa - Proponer condiciones alternativas para la reconsideración
                    {% elif reconsideracion.decision_preview == 'enviar_comite' %}👥 Enviar a Comité - Escalar la decisión al comité de crédito para evaluación
                    {% else %}{{ reconsideracion.decision_preview|capfirst }}
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Información de cotización (solo si usa nueva cotización) -->
            {% if not reconsideracion.usar_misma_cotizacion %}
            <div style="margin: 6px;">
                <div style="font-weight: bold; color: #009c3c; font-size: 8px; margin-bottom: 4px; border-bottom: 1px solid #e5e7eb; padding-bottom: 2px;">
                    Nueva Cotización Utilizada
                </div>
                <table class="info-table" style="font-size: 7px;">
                    <tr>
                        {% if reconsideracion.cotizacion_original %}
                        <td class="label">Cotización Original:</td>
                        <td class="value">${{ reconsideracion.cotizacion_original.montoPrestamo|floatformat:0 }} - {{ reconsideracion.cotizacion_original.plazo }} meses</td>
                        {% endif %}
                        {% if reconsideracion.cotizacion_nueva %}
                        <td class="label">Nueva Cotización:</td>
                        <td class="value">${{ reconsideracion.cotizacion_nueva.montoPrestamo|floatformat:0 }} - {{ reconsideracion.cotizacion_nueva.plazo }} meses</td>
                        {% endif %}
                    </tr>
                </table>
            </div>
            {% else %}
            <div style="margin: 6px; padding: 4px; background: #f0fdf4; border-left: 3px solid #22c55e; border-radius: 4px;">
                <div style="font-size: 8px; color: #166534; font-style: italic;">
                    📋 Utilizó la misma cotización que el análisis original
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <!-- Backward compatibility: Single reconsideration section (only show if no multiple data) -->
    {% elif reconsideracion_data %}
    <div class="comite-section">
        <div class="comite-title">Resultado de Reconsideración{% if is_preview_mode %} (Vista Previa){% endif %}</div>
        
        <!-- Información de la reconsideración -->
        <div style="margin-bottom: 8px; padding: 6px; background: #f8fafc; border-radius: 4px;">
            <table class="info-table">
                <tr>
                    <td class="label">Número Reconsideración:</td>
                    <td class="value">#{{ reconsideracion_data.numero_reconsideracion }}</td>
                    <td class="label">Estado:</td>
                    <td class="value" style="
                        {% if reconsideracion_data.estado == 'aprobada' %}color: #22c55e; font-weight: bold;
                        {% elif reconsideracion_data.estado == 'rechazada' %}color: #ef4444; font-weight: bold;
                        {% elif reconsideracion_data.estado == 'alternativa' %}color: #f59e0b; font-weight: bold;
                        {% else %}color: #6b7280;{% endif %}">
                        {% if reconsideracion_data.estado == 'aprobada' %}✓ Aprobada
                        {% elif reconsideracion_data.estado == 'rechazada' %}✗ Rechazada
                        {% elif reconsideracion_data.estado == 'alternativa' %}⚠ Alternativa
                        {% else %}{{ reconsideracion_data.estado|capfirst }}{% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="label">Fecha Solicitud:</td>
                    <td class="value">{{ reconsideracion_data.fecha_solicitud|date:"d/m/Y H:i" }}</td>
                    <td class="label">Solicitada Por:</td>
                    <td class="value">{{ reconsideracion_data.solicitada_por_nombre }}</td>
                </tr>
                {% if reconsideracion_data.fecha_analisis %}
                <tr>
                    <td class="label">Fecha Análisis:</td>
                    <td class="value">{{ reconsideracion_data.fecha_analisis|date:"d/m/Y H:i" }}</td>
                    <td class="label">Analizada Por:</td>
                    <td class="value">{{ reconsideracion_data.analizada_por_nombre|default:"Sin analista" }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
        
                <!-- Motivo de la reconsideración -->
        {% if reconsideracion_data.motivo %}
        <div style="margin-bottom: 8px; padding: 6px; background: #fff7ed; border-left: 3px solid #f59e0b; border-radius: 4px;">
            <div style="font-size: 8px; color: #374151; line-height: 1.4;">
                <span style="font-weight: bold; color: #f59e0b; font-size: 9px;">Motivo de la Reconsideración:</span> {{ reconsideracion_data.motivo }}
            </div>
        </div>
        {% endif %}
        
        <!-- Comentario del análisis -->
        {% if reconsideracion_data.comentario_analisis %}
        <div style="margin-bottom: 8px; padding: 6px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 4px;">
            <div style="font-size: 8px; color: #374151; line-height: 1.4;">
                <span style="font-weight: bold; color: #3b82f6; font-size: 9px;">Análisis de la Reconsideración{% if reconsideracion_data.is_preview %} (Vista Previa){% endif %}:</span> {{ reconsideracion_data.comentario_analisis }}
            </div>
        </div>
        {% endif %}
        
        <!-- Decisión de la reconsideración (si está en modo vista previa) -->
        {% if reconsideracion_data.decision_preview %}
        <div style="margin-bottom: 8px; padding: 6px; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 4px;">
            <div style="font-weight: bold; color: #f59e0b; font-size: 9px; margin-bottom: 3px;">
                Decisión Propuesta (Vista Previa):
            </div>
            <div style="font-size: 8px; color: #374151; line-height: 1.4;">
                {% if reconsideracion_data.decision_preview == 'aprobar' %}✓ Aprobar - Aceptar la reconsideración y proceder con la nueva condición
                {% elif reconsideracion_data.decision_preview == 'rechazar' %}✗ Rechazar - Mantener la decisión anterior y rechazar la reconsideración
                {% elif reconsideracion_data.decision_preview == 'alternativa' %}↻ Alternativa - Proponer condiciones alternativas para la reconsideración
                {% elif reconsideracion_data.decision_preview == 'enviar_comite' %}👥 Enviar a Comité - Escalar la decisión al comité de crédito para evaluación
                {% else %}{{ reconsideracion_data.decision_preview|capfirst }}
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Información de cotización (solo si usa nueva cotización) -->
        {% if not reconsideracion_data.usar_misma_cotizacion %}
        <div style="margin-bottom: 8px;">
            <div style="font-weight: bold; color: #009c3c; font-size: 9px; margin-bottom: 4px; border-bottom: 1px solid #e5e7eb; padding-bottom: 2px;">
                Información de Nueva Cotización
            </div>
            <table class="info-table">
                <tr>
                    <td class="label">Cotización:</td>
                    <td class="value">{{ reconsideracion_data.nueva_cotizacion.codigo|default:"N/A" }}</td>
                    <td class="label">Fecha:</td>
                    <td class="value">{{ reconsideracion_data.nueva_cotizacion.created_at|date:"d/m/Y"|default:"N/A" }}</td>
                </tr>
                {% if reconsideracion_data.nueva_cotizacion.valorVehiculo %}
                <tr>
                    <td class="label">Valor Vehículo:</td>
                    <td class="value">${{ reconsideracion_data.nueva_cotizacion.valorVehiculo|floatformat:0 }}</td>
                    <td class="label">Prima:</td>
                    <td class="value">${{ reconsideracion_data.nueva_cotizacion.valorPrimaInicial|floatformat:0|default:"0" }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
        {% else %}
        <div style="margin-bottom: 8px; padding: 6px; background: #f0fdf4; border-left: 3px solid #22c55e; border-radius: 4px;">
            <div style="font-size: 8px; color: #166534; font-style: italic;">
                📋 Utilizó la misma cotización que el análisis original
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

   

    <!-- Footer Compacto -->
    <div class="footer">
        <div class="footer-info">
            {% if logo_path %}
                <img src="{{ logo_path }}" alt="Logo Financiera Pacífico" style="width: 80px; height: auto; filter: brightness(0) invert(1); margin-bottom: 5px;">
            {% endif %}
            
        </div>
    </div>

   
</body>
</html>
