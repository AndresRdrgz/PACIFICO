<!-- Drawer Nueva Solicitud -->
<div id="solicitudDrawer" class="drawer-overlay">
    <div class="drawer-container">
        <!-- Drawer Loading Overlay -->
        <div id="drawerLoadingOverlay" class="drawer-loading-overlay">
            <div class="drawer-loading-content">
                <div class="drawer-spinner"></div>
                <div class="drawer-loading-text">Creando solicitud...</div>
                <div class="drawer-loading-subtext">Por favor espere mientras procesamos su información</div>
                <div class="progress-indicator">
                    <div class="progress-bar indeterminate"></div>
                </div>
            </div>
        </div>
        
        <div class="drawer-header">
            <div class="drawer-title">
                <i class="fas fa-plus-circle me-2"></i>
                <span>Crear Negocio</span>
            </div>
            <button type="button" class="btn-close" onclick="closeSolicitudDrawer()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="drawer-content">
            <form id="solicitudForm" method="post">
                {% csrf_token %}

                <!-- Pipeline Selection -->
                <div class="form-section">
                    <h6 class="form-section-title">
                        <i class="fas fa-route me-2"></i>
                        Pipeline
                    </h6>
                    <div class="form-group">
                        <select id="pipelineSelect" name="pipeline" class="form-control" required>
                            <option value="">Seleccionar Pipeline</option>
                            {% for pipeline in pipelines %}
                            <option value="{{ pipeline.id }}">{{ pipeline.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div id="pipelineLockedInfo" class="locked-info" style="display: none;">
                            <i class="fas fa-lock me-2"></i>
                            <span id="pipelineLockedName"></span>
                            <small class="text-muted d-block">Pipeline bloqueado para esta vista</small>
                        </div>
                    </div>
                </div>

                <!-- Cotización Selection -->
                <div class="form-section">
                    <h6 class="form-section-title">
                        <i class="fas fa-calculator me-2"></i>
                        Cotización
                    </h6>
                    <div class="form-group">
                        <div class="search-container">
                            <input type="text" id="cotizacionSearch" class="form-control"
                                placeholder="Buscar cotización (auto o personal) por nombre, cédula o ID...">
                            <div id="cotizacionResults" class="search-results"></div>
                        </div>
                        <input type="hidden" id="cotizacionId" name="cotizacion">
                        <div id="cotizacionSelected" class="selected-item" style="display: none;">
                            <div class="selected-item-content">
                                <div class="selected-item-info">
                                    <strong class="selected-name"></strong>
                                    <span class="selected-details"></span>
                                </div>
                                <button type="button" class="btn-remove" onclick="clearCotizacion()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Cotización validation warning -->
                        <div id="cotizacionDuplicateWarning" class="alert alert-warning mt-2" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Atención:</strong> Esta cotización ya está siendo utilizada en otra solicitud del pipeline.
                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>Solicitud existente:</strong> <span id="existingSolicitudInfo"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cliente Selection -->
                <div class="form-section">
                    <h6 class="form-section-title">
                        <i class="fas fa-user me-2"></i>
                        Cliente
                    </h6>
                    <div class="form-group">
                        <input type="hidden" id="clienteId" name="cliente">
                        <div id="clienteSelected" class="selected-item" style="display: none;">
                            <div class="selected-item-content">
                                <div class="selected-item-info">
                                    <strong class="selected-name"></strong>
                                    <span class="selected-details"></span>
                                </div>
                            </div>
                        </div>
                        <div id="clientePlaceholder" class="text-muted text-center py-3">
                            <i class="fas fa-user-clock"></i>
                            Selecciona una cotización para ver el cliente asociado
                        </div>
                    </div>
                </div>

                <!-- Propietario Selection -->
                <div class="form-section">
                    <h6 class="form-section-title">
                        <i class="fas fa-user-tie me-2"></i>
                        Propietario
                    </h6>
                    <div class="form-group">
                        <select id="propietarioSelect" name="propietario" class="form-control">
                            <option value="">Cargando usuarios...</option>
                        </select>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Usuario responsable de esta solicitud. Por defecto se asigna al usuario actual.
                        </small>
                    </div>
                </div>

                <!-- Motivo de la consulta -->
                <div id="motivoConsultaSection" class="form-section" style="display: none;">
                    <h6 class="form-section-title">
                        <i class="fas fa-edit me-2"></i>
                        Motivo de la consulta
                    </h6>
                    <div class="form-group">
                        <textarea id="motivoConsulta" name="motivo_consulta" class="form-control" rows="4"
                            placeholder="Describe el motivo de la consulta o las observaciones del cliente..."
                            style="resize: vertical; min-height: 100px;"></textarea>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Esta información se utilizará para documentar el propósito de la solicitud
                        </small>
                    </div>
                </div>

                <!-- Cómo se enteró -->
                <div id="comoSeEnteroSection" class="form-section" style="display: none;">
                    <h6 class="form-section-title">
                        <i class="fas fa-question-circle me-2"></i>
                        ¿Cómo se enteró de nuestros servicios?
                    </h6>
                    <div class="form-group">
                        <select id="comoSeEntero" name="como_se_entero" class="form-control" required>
                            <option value="">Seleccionar opción...</option>
                            <option value="Sucursal">Sucursal</option>
                            <option value="Ventas externas">Ventas externas</option>
                            <option value="Telemercadeo">Telemercadeo</option>
                            <option value="Promoción">Promoción</option>
                            <option value="Feria">Feria</option>
                            <option value="Plan chispa">Plan chispa</option>
                            <option value="Carta de saldo">Carta de saldo</option>
                        </select>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Información sobre el canal de adquisición del cliente
                        </small>
                    </div>
                </div>

                <!-- Descargar APC con Makito -->
                <div id="apcMakitoSection" class="form-section" style="display: none;">
                    <h6 class="form-section-title">
                        <i class="fas fa-download me-2"></i>
                        Descargar APC con Makito
                    </h6>
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="descargarApcMakito"
                                name="descargar_apc_makito" value="1">
                            <label class="form-check-label" for="descargarApcMakito">
                                Solicitar descarga de APC
                            </label>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Al activar esta opción, se enviará una solicitud automática para descargar el APC
                        </small>
                    </div>

                    <!-- Campos adicionales para APC (ocultos por defecto) -->
                    <div id="apcCamposAdicionales" style="display: none;">
                        <div class="form-group mt-3">
                            <label for="apcTipoDocumento" class="form-label">Tipo de documento</label>
                            <select id="apcTipoDocumento" name="apc_tipo_documento" class="form-control">
                                <option value="">Seleccionar tipo...</option>
                                <option value="cedula">Cédula</option>
                                <option value="pasaporte">Pasaporte</option>
                            </select>
                        </div>
                        <div class="form-group mt-3">
                            <label for="apcNoCedula" class="form-label">Número de documento</label>
                            <input type="text" id="apcNoCedula" name="apc_no_cedula" class="form-control"
                                placeholder="Ingrese el número de cédula o pasaporte">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Este campo se completa automáticamente con la cédula del cliente seleccionado
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Cotización SURA con Makito -->
                <div id="suraMakitoSection" class="form-section" style="display: none;">
                    <h6 class="form-section-title">
                        <i class="fas fa-file-contract me-2"></i>
                        Cotización SURA con Makito
                    </h6>
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cotizarSuraMakito"
                                name="cotizar_sura_makito" value="1">
                            <label class="form-check-label" for="cotizarSuraMakito">
                                Solicitar cotización póliza SURA
                            </label>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Al activar esta opción, se enviará una solicitud automática para cotizar póliza SURA
                        </small>
                    </div>

                    <!-- Campos adicionales para SURA (ocultos por defecto) -->
                    <div id="suraCamposAdicionales" style="display: none;">
                        <!-- Información del Cliente -->
                        <div class="form-group mt-3">
                            <label for="suraPrimerNombre" class="form-label">Primer nombre</label>
                            <input type="text" id="suraPrimerNombre" name="sura_primer_nombre" class="form-control"
                                placeholder="Ingrese el primer nombre del cliente">
                        </div>
                        <div class="form-group mt-3">
                            <label for="suraSegundoNombre" class="form-label">Segundo nombre</label>
                            <input type="text" id="suraSegundoNombre" name="sura_segundo_nombre" class="form-control"
                                placeholder="Ingrese el segundo nombre del cliente (opcional)">
                        </div>
                        <div class="form-group mt-3">
                            <label for="suraPrimerApellido" class="form-label">Primer apellido</label>
                            <input type="text" id="suraPrimerApellido" name="sura_primer_apellido" class="form-control"
                                placeholder="Ingrese el primer apellido del cliente">
                        </div>
                        <div class="form-group mt-3">
                            <label for="suraSegundoApellido" class="form-label">Segundo apellido</label>
                            <input type="text" id="suraSegundoApellido" name="sura_segundo_apellido" class="form-control"
                                placeholder="Ingrese el segundo apellido del cliente (opcional)">
                        </div>
                        
                        <!-- Tipo de Documento -->
                        <div class="form-group mt-3">
                            <label for="suraTipoDocumento" class="form-label">Tipo de documento</label>
                            <select id="suraTipoDocumento" name="sura_tipo_documento" class="form-control">
                                <option value="">Seleccionar tipo...</option>
                                <option value="cedula">Cédula</option>
                                <option value="pasaporte">Pasaporte</option>
                            </select>
                        </div>
                        
                        <div class="form-group mt-3">
                            <label for="suraNoDocumento" class="form-label">Número de documento</label>
                            <input type="text" id="suraNoDocumento" name="sura_no_documento" class="form-control"
                                placeholder="Ingrese el número de documento">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Este campo se completa automáticamente con el documento del cliente seleccionado
                            </small>
                        </div>

                        <!-- Información del Vehículo -->
                        <hr class="my-3">
                        <h6 class="form-section-title mb-3">
                            <i class="fas fa-car me-2"></i>
                            Información del Vehículo
                        </h6>
                        
                        <div class="form-group mt-3">
                            <label for="suraValorAuto" class="form-label">Valor del auto</label>
                            <input type="number" id="suraValorAuto" name="sura_valor_auto" class="form-control auto-populated-field"
                                placeholder="Valor del vehículo">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Este campo se completa automáticamente desde la cotización seleccionada, pero puedes editarlo si es necesario
                            </small>
                        </div>
                        
                        <div class="form-group mt-3">
                            <label for="suraAnoAuto" class="form-label">Año del auto</label>
                            <input type="number" id="suraAnoAuto" name="sura_ano_auto" class="form-control auto-populated-field"
                                placeholder="Año del vehículo" min="1900" max="2030">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Este campo se completa automáticamente desde la cotización seleccionada, pero puedes editarlo si es necesario
                            </small>
                        </div>
                        
                        <div class="form-group mt-3">
                            <label for="suraMarca" class="form-label">Marca</label>
                            <input type="text" id="suraMarca" name="sura_marca" class="form-control auto-populated-field"
                                placeholder="Marca del vehículo">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Este campo se completa automáticamente desde la cotización seleccionada, pero puedes editarlo si es necesario
                            </small>
                        </div>
                        
                        <div class="form-group mt-3">
                            <label for="suraModelo" class="form-label">Modelo</label>
                            <input type="text" id="suraModelo" name="sura_modelo" class="form-control auto-populated-field"
                                placeholder="Modelo del vehículo">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Este campo se completa automáticamente desde la cotización seleccionada, pero puedes editarlo si es necesario
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Campos Personalizados -->
                <div id="camposPersonalizados" class="form-section">
                    <h6 class="form-section-title">
                        <i class="fas fa-cog me-2"></i>
                        Propiedades dependientes
                    </h6>
                    <div id="camposContainer">
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona un pipeline para ver los campos personalizados
                        </div>
                    </div>
                </div>

                <!-- Campos Obligatorios de Cotización -->
                <div id="cotizacionFieldsSection" class="form-section" style="display: none;">
                    <h6 class="form-section-title">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Campos Obligatorios de Cotización
                    </h6>
                    <div id="cotizacionFieldsContainer">
                        <div id="cotizacionFieldsInfo" class="alert alert-info mb-3" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Información:</strong> Algunos campos obligatorios están completos en la cotización seleccionada.
                        </div>
                        <div id="cotizacionFieldsWarning" class="alert alert-warning mb-3" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Atención:</strong> Algunos campos obligatorios están vacíos. Por favor, completa los siguientes campos:
                        </div>

                        <!-- Posición -->
                        <div id="posicionField" class="campo-dinamico" style="display: none;">
                            <label for="posicion" class="campo-label">
                                Posición <span class="campo-required">*</span>
                            </label>
                            <input type="text" id="posicion" name="posicion" class="form-control" 
                                placeholder="Ingrese la posición del cliente">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Campo requerido para crear la solicitud
                            </small>
                        </div>

                        <!-- Tiempo de Servicio -->
                        <div id="tiempoServicioField" class="campo-dinamico" style="display: none;">
                            <label for="tiempoServicio" class="campo-label">
                                Tiempo de Servicio <span class="campo-required">*</span>
                            </label>
                            <input type="text" id="tiempoServicio" name="tiempo_servicio" class="form-control" 
                                placeholder="Ej: 5 años, 2 años 6 meses">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Campo requerido para crear la solicitud
                            </small>
                        </div>

                        <!-- Salario -->
                        <div id="salarioField" class="campo-dinamico" style="display: none;">
                            <label for="salario" class="campo-label">
                                Salario Base Mensual <span class="campo-required">*</span>
                            </label>
                            <input type="number" id="salario" name="salario" class="form-control" 
                                placeholder="0.00" step="0.01" min="0">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Campo requerido para crear la solicitud
                            </small>
                        </div>

                        <!-- APC Score -->
                        <div id="apcScoreField" class="campo-dinamico" style="display: none;">
                            <label for="apcScore" class="campo-label">
                                APC Score <span class="campo-required">*</span>
                            </label>
                            <input type="number" id="apcScore" name="apc_score" class="form-control" 
                                placeholder="0" step="1" min="0" max="1000">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Campo requerido para crear la solicitud
                            </small>
                        </div>

                        <!-- Política -->
                        <div id="politicaField" class="campo-dinamico" style="display: none;">
                            <label for="politica" class="campo-label">
                                Política <span class="campo-required">*</span>
                            </label>
                            <select id="politica" name="politica" class="form-control">
                                <option value="">Seleccionar política...</option>
                                <!-- Options will be loaded dynamically -->
                            </select>
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Campo requerido para crear la solicitud
                            </small>
                        </div>

                        <!-- Sector -->
                        <div id="sectorField" class="campo-dinamico" style="display: none;">
                            <label for="sector" class="campo-label">
                                Sector <span class="campo-required">*</span>
                            </label>
                            <select id="sector" name="sector" class="form-control">
                                <option value="">Seleccionar sector...</option>
                                <option value="SECTOR A">Sector A</option>
                                <option value="SECTOR B">Sector B</option>
                                <option value="SECTOR C">Sector C</option>
                            </select>
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Campo requerido para crear la solicitud
                            </small>
                        </div>

                        <!-- Observaciones -->
                        <div id="observacionesField" class="campo-dinamico" style="display: none;">
                            <label for="observaciones" class="campo-label">
                                Observaciones <span class="campo-required">*</span>
                            </label>
                            <textarea id="observaciones" name="observaciones" class="form-control" rows="3"
                                placeholder="Describe el motivo de la consulta y observaciones relevantes..."></textarea>
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Campo requerido para crear la solicitud
                            </small>
                        </div>

                        <!-- Nombre de la Empresa -->
                        <div id="nombreEmpresaField" class="campo-dinamico" style="display: none;">
                            <label for="nombreEmpresa" class="campo-label">
                                Nombre de la Empresa <span class="campo-required">*</span>
                            </label>
                            <input type="text" id="nombreEmpresa" name="nombre_empresa" class="form-control" 
                                placeholder="Nombre de la empresa donde trabaja">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Campo requerido para crear la solicitud
                            </small>
                        </div>

                        <!-- Ingresos -->
                        <div id="ingresosField" class="campo-dinamico" style="display: none;">
                            <label for="ingresos" class="campo-label">
                                Ingresos <span class="campo-required">*</span>
                            </label>
                            <input type="number" id="ingresos" name="ingresos" class="form-control" 
                                placeholder="0.00" step="0.01" min="0">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Monto en USD - Campo requerido para crear la solicitud
                            </small>
                        </div>

                        <!-- APC PI -->
                        <div id="apcPIField" class="campo-dinamico" style="display: none;">
                            <label for="apcPI" class="campo-label">
                                APC PI <span class="campo-required">*</span>
                            </label>
                            <input type="number" id="apcPI" name="apc_pi" class="form-control" 
                                placeholder="0.00" step="0.01" min="0">
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Índice APC PI - Campo requerido para crear la solicitud
                            </small>
                        </div>

                        <!-- Save Button for Consultation Fields -->
                        <div id="consultationSaveSection" class="mt-3" style="display: none;">
                            <button type="button" class="btn btn-success btn-sm" onclick="handleSaveConsultationFields()">
                                <i class="fas fa-save me-2"></i>
                                Guardar Campos de Consulta
                            </button>
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-info-circle me-1"></i>
                                Guarde los campos antes de crear la solicitud
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Requisitos -->
                <div id="requisitosSection" class="form-section">
                    <h6 class="form-section-title">
                        <i class="fas fa-tasks me-2"></i>
                        Requisitos
                    </h6>
                    <div id="requisitosContainer">
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecciona un pipeline para ver los requisitos
                        </div>
                    </div>
                </div>

            </form>
        </div>

        <div class="drawer-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSolicitudDrawer()">
                Cancelar
            </button>
            <button type="button" class="btn btn-primary" onclick="submitSolicitud()">
                <i class="fas fa-plus me-2"></i>
                Crear
            </button>
        </div>
    </div>
</div>

<style>
    /* Drawer Styles */
    .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10500;
        /* Higher z-index to ensure it's on top of Bootstrap modals (1050-1060) */
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    .drawer-overlay.active {
        display: flex;
        opacity: 1;
        pointer-events: all;
    }

    .drawer-container {
        position: fixed;
        top: 0;
        right: 0;
        width: 500px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 20px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .drawer-overlay.active .drawer-container {
        transform: translateX(0);
    }

    /* Improve header styling */
    .drawer-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--verde-pacifico);
        color: white;
        min-height: 70px;
    }

    .drawer-title {
        font-size: 1.25rem;
        font-weight: 700;
        display: flex;
        align-items: center;
    }

    .btn-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-close:hover {
        background-color: rgba(255, 255, 255, 0.15);
        transform: scale(1.1);
    }

    /* Improve content area */
    .drawer-content {
        flex: 1;
        padding: 25px;
        overflow-y: auto;
        background: #fafafa;
    }

    .drawer-content::-webkit-scrollbar {
        width: 6px;
    }

    .drawer-content::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .drawer-content::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .drawer-content::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }

    /* Improve footer */
    .drawer-footer {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: white;
    }

    .drawer-footer .btn {
        padding: 10px 20px;
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .drawer-footer .btn-primary {
        background: var(--verde-pacifico);
        border-color: var(--verde-pacifico);
    }

    .drawer-footer .btn-primary:hover {
        background: #1e5f2a;
        border-color: #1e5f2a;
        transform: translateY(-1px);
    }

    .drawer-footer .btn-secondary {
        background: #6c757d;
        border-color: #6c757d;
    }

    .drawer-footer .btn-secondary:hover {
        background: #5a6268;
        border-color: #545b62;
        transform: translateY(-1px);
    }

    /* Loading state */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--verde-pacifico);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Form Sections */
    .form-section {
        margin-bottom: 25px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .form-section-title {
        color: var(--verde-pacifico);
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }

    .form-group {
        margin-bottom: 15px;
    }

    /* Pipeline Locked Info */
    .locked-info {
        background: #e8f5e8;
        border: 1px solid #c3e6c3;
        border-radius: 6px;
        padding: 12px;
        color: #2d5a2d;
        font-weight: 500;
    }

    .locked-info i {
        color: #28a745;
    }

    /* Search Components */
    .search-container {
        position: relative;
    }

    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 6px 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .search-results.show {
        display: block;
    }

    .search-result-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }

    .search-result-item:hover {
        background-color: #f8f9fa;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-name {
        font-weight: 600;
        color: #333;
    }

    .search-result-details {
        font-size: 0.875rem;
        color: #666;
        margin-top: 2px;
    }

    /* Selected Items */
    .selected-item {
        margin-top: 10px;
        background: #e8f5e8;
        border: 1px solid #c3e6c3;
        border-radius: 6px;
        padding: 12px;
    }

    .selected-item-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .selected-item-info {
        flex: 1;
    }

    .selected-name {
        display: block;
        color: #2d5a2d;
        font-weight: 600;
    }

    .selected-details {
        display: block;
        color: #5a7a5a;
        font-size: 0.875rem;
        margin-top: 2px;
    }

    .btn-remove {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .btn-remove:hover {
        background-color: rgba(220, 53, 69, 0.1);
    }

    /* Dynamic Fields */
    .campo-dinamico {
        margin-bottom: 15px;
    }

    .campo-label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 6px;
    }

    .campo-required {
        color: #dc3545;
        margin-left: 3px;
    }

    /* Requisitos */
    .requisito-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 15px;
        padding: 15px;
        transition: border-color 0.2s;
    }

    .requisito-item:hover {
        border-color: var(--verde-pacifico);
    }

    .requisito-header {
        margin-bottom: 12px;
    }

    .requisito-info {
        flex: 1;
    }

    .requisito-nombre {
        font-weight: 600;
        color: #333;
    }

    .requisito-obligatorio {
        color: #dc3545;
        font-size: 0.875rem;
        font-weight: normal;
    }

    .requisito-descripcion {
        color: #666;
        font-size: 0.875rem;
        margin-top: 4px;
    }

    /* File Upload Components */
    .requisito-upload {
        margin-top: 12px;
    }

    .file-upload-label {
        display: inline-block;
        padding: 8px 16px;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        color: #6c757d;
        font-size: 0.875rem;
        width: 100%;
        text-align: center;
    }

    .file-upload-label:hover {
        background: #e9ecef;
        border-color: var(--verde-pacifico);
        color: var(--verde-pacifico);
    }

    .file-upload-input {
        display: none;
    }

    .file-upload-info {
        margin-top: 6px;
        text-align: center;
    }

    .file-selected {
        margin-top: 10px;
        padding: 8px 12px;
        background: #e8f5e8;
        border: 1px solid #c3e6c3;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .file-selected .file-name {
        flex: 1;
        color: #2d5a2d;
        font-size: 0.875rem;
        margin-left: 8px;
    }

    .btn-remove-file {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .btn-remove-file:hover {
        background-color: rgba(220, 53, 69, 0.1);
    }

    /* Toast Notifications */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10001;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        font-size: 0.875rem;
        min-width: 300px;
    }

    .toast-notification.success {
        background: #28a745;
    }

    .toast-notification.error {
        background: #dc3545;
    }

    .toast-notification.warning {
        background: #ffc107;
        color: #212529;
    }

    .toast-notification.show {
        transform: translateX(0);
    }

    /* Session Warning Banner */
    .session-warning-banner {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background: #ffc107;
        color: #212529;
        padding: 10px 20px;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #e0e0e0;
    }

    /* Ensure motivo consulta section is hidden by default */
    #motivoConsultaSection {
        display: none !important;
    }

    #motivoConsultaSection.show {
        display: block !important;
    }

    /* Ensure como se entero section is hidden by default */
    #comoSeEnteroSection {
        display: none !important;
    }

    #comoSeEnteroSection.show {
        display: block !important;
    }

    /* Ensure requisitos section is hidden by default */
    #requisitosSection {
        display: none !important;
    }

    #requisitosSection.show {
        display: block !important;
    }

    /* Auto-populated field styling */
    .auto-populated-field {
        background-color: #f8fff8 !important;
        border-color: #c3e6c3 !important;
        border-left: 3px solid #28a745 !important;
    }

    .auto-populated-field:focus {
        background-color: #ffffff !important;
        border-color: var(--verde-pacifico) !important;
        border-left: 3px solid var(--verde-pacifico) !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
    }

    .auto-populated-field:hover {
        background-color: #f0f9f0 !important;
        border-color: #a8d5a8 !important;
    }

    .session-warning-content {
        display: flex;
        align-items: center;
    }

    .session-warning-content .btn {
        padding: 4px 10px;
        font-size: 0.875rem;
    }

    /* Cotización duplicate warning styles */
    .alert {
        padding: 12px 15px;
        border: 1px solid transparent;
        border-radius: 6px;
        font-size: 0.875rem;
        margin-bottom: 0;
    }

    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeaa7;
    }

    .alert i {
        color: #f39c12;
    }

    /* Validation styles */
    .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .form-control.is-valid {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }

    /* Makito message styles */
    .makito-info-message {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        color: #1565c0;
        font-size: 0.875rem;
        display: none;
    }

    .makito-info-message.show {
        display: block;
    }

    .makito-info-message i {
        color: #1976d2;
        margin-right: 8px;
    }

    .makito-info-message .makito-title {
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
    }

    .makito-info-message .makito-description {
        margin-bottom: 0;
        line-height: 1.4;
    }

    /* Cotización fields validation styles */
    .campo-dinamico {
        margin-bottom: 15px;
    }

    .campo-label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 6px;
    }

    .campo-required {
        color: #dc3545;
        margin-left: 3px;
    }

    /* Enhanced validation styles */
    .form-control.is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 24 24'%3e%3ccircle cx='12' cy='12' r='10'/%3e%3cline x1='15' y1='9' x2='9' y2='15'/%3e%3cline x1='9' y1='9' x2='15' y2='15'/%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: right calc(0.375em + 0.1875rem) center !important;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem) !important;
        padding-right: calc(1.5em + 0.75rem) !important;
    }

    .form-control.is-valid {
        border-color: #28a745 !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.94-.94 1.93 1.93.94-.94L2.3 2.93z'/%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: right calc(0.375em + 0.1875rem) center !important;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem) !important;
        padding-right: calc(1.5em + 0.75rem) !important;
    }

    /* Alert improvements */
    .alert {
        padding: 12px 15px;
        border: 1px solid transparent;
        border-radius: 6px;
        font-size: 0.875rem;
        margin-bottom: 15px;
    }

    .alert-info {
        color: #0c5460;
        background-color: #d1ecf1;
        border-color: #bee5eb;
    }

    .alert-info i {
        color: #17a2b8;
    }

    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeaa7;
    }

    .alert-warning i {
        color: #f39c12;
    }

    /* Section visibility transitions */
    #cotizacionFieldsSection {
        transition: all 0.3s ease;
    }

    #cotizacionFieldsSection.show {
        display: block !important;
        opacity: 1;
        transform: translateY(0);
    }

    #cotizacionFieldsSection.hide {
        opacity: 0;
        transform: translateY(-10px);
    }

    /* Save button styling */
    #consultationSaveSection {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        margin-top: 15px;
    }

    #consultationSaveSection .btn-success {
        background: var(--verde-pacifico);
        border-color: var(--verde-pacifico);
        font-weight: 500;
        transition: all 0.2s ease;
    }

    #consultationSaveSection .btn-success:hover {
        background: #1e5f2a;
        border-color: #1e5f2a;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    #consultationSaveSection .btn-success:disabled {
        background: #6c757d;
        border-color: #6c757d;
        transform: none;
        box-shadow: none;
    }

    /* Field grouping improvements */
    .campo-dinamico {
        margin-bottom: 20px;
        padding: 15px;
        background: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .campo-dinamico:hover {
        border-color: var(--verde-pacifico);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .campo-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
    }

    .campo-required {
        color: #dc3545;
        font-weight: 700;
    }

    .form-control:focus {
        border-color: var(--verde-pacifico);
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
</style>

<script>
    // Drawer Management - Functions defined in negocios.html to avoid conflicts

    // Search functionality - Functions defined in negocios.html to avoid conflicts

    // Selection and clear functions defined in negocios.html to avoid conflicts

    // hideSearchResults function defined in negocios.html to avoid conflicts

    // Load form data based on pipeline - Function defined in negocios.html to avoid conflicts

    // Render functions defined in negocios.html to avoid conflicts

    // Cotización duplicate validation functions
    window.validateCotizacionDuplicate = async function(cotizacionId, pipelineId) {
        console.log('🔍 Validating cotización duplicate:', { cotizacionId, pipelineId });
        
        if (!cotizacionId || !pipelineId) {
            return { isDuplicate: false };
        }

        try {
            const response = await fetch(`/workflow/api/validate-cotizacion-duplicate/?cotizacion_id=${cotizacionId}&pipeline_id=${pipelineId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('✅ Cotización validation response:', data);
            return data;
        } catch (error) {
            console.error('❌ Error validating cotización:', error);
            return { isDuplicate: false, error: true };
        }
    };

    window.showCotizacionDuplicateWarning = function(existingSolicitudData) {
        console.log('⚠️ Showing cotización duplicate warning:', existingSolicitudData);
        
        const warningElement = document.getElementById('cotizacionDuplicateWarning');
        const existingInfoElement = document.getElementById('existingSolicitudInfo');
        
        if (warningElement && existingInfoElement) {
            // Format the existing solicitud information
            const solicitudInfo = `${existingSolicitudData.codigo || 'Sin código'} - ${existingSolicitudData.etapa_actual || 'Sin etapa'} - Creada: ${existingSolicitudData.fecha_creacion || 'N/A'}`;
            existingInfoElement.textContent = solicitudInfo;
            
            // Show the warning
            warningElement.style.display = 'block';
            
            // Add visual feedback to the search input
            const cotizacionSearch = document.getElementById('cotizacionSearch');
            if (cotizacionSearch) {
                cotizacionSearch.classList.add('is-invalid');
            }
        }
    };

    window.hideCotizacionDuplicateWarning = function() {
        console.log('✅ Hiding cotización duplicate warning');
        
        const warningElement = document.getElementById('cotizacionDuplicateWarning');
        const cotizacionSearch = document.getElementById('cotizacionSearch');
        
        if (warningElement) {
            warningElement.style.display = 'none';
        }
        
        if (cotizacionSearch) {
            cotizacionSearch.classList.remove('is-invalid');
            cotizacionSearch.classList.add('is-valid');
        }
    };

    window.checkCotizacionBeforeSubmit = async function() {
        console.log('🔍 Checking cotización before submit');
        
        const cotizacionId = document.getElementById('cotizacionId')?.value;
        const pipelineId = document.getElementById('pipelineSelect')?.value;
        
        if (!cotizacionId || !pipelineId) {
            return { canProceed: true };
        }

        const validation = await validateCotizacionDuplicate(cotizacionId, pipelineId);
        
        if (validation.isDuplicate) {
            // Show error message and prevent creation
            alert(
                `Error: Esta cotización ya está siendo utilizada en otra solicitud (${validation.existingSolicitud?.codigo || 'Sin código'}).\n\n` +
                `No es posible crear un nuevo negocio con una cotización que ya está vinculada a otro negocio.`
            );
            
            return { 
                canProceed: false, 
                isDuplicate: true,
                existingSolicitud: validation.existingSolicitud 
            };
        }
        
        return { canProceed: true, isDuplicate: false };
    };

    // Consultation Fields Validation Functions
    window.validateConsultationFields = async function(cotizacionId) {
        console.log('🔍 Validating consultation fields for cotización:', cotizacionId);
        
        if (!cotizacionId) {
            return { isValid: true, missingFields: [] };
        }

        try {
            // Fetch cotización data to check required fields
            const response = await fetch(`/cotizacion/${cotizacionId}/data/`);
            if (!response.ok) {
                console.error('❌ Error fetching cotización data');
                return { isValid: true, missingFields: [] }; // Don't block if can't validate
            }

            const cotizacionData = await response.json();
            console.log('📋 Cotización data received:', cotizacionData);

            const requiredFields = {
                'sector': 'Sector',
                'politica': 'Política',
                'observaciones': 'Observaciones',
                'tiempoServicio': 'Tiempo de Servicio',
                'nombreEmpresa': 'Nombre de la Empresa',
                'ingresos': 'Ingresos',
                'posicion': 'Posición',
                'apcScore': 'APC Score',
                'apcPI': 'APC PI'
            };

            const missingFields = [];
            const fieldValues = {};

            for (const [field, displayName] of Object.entries(requiredFields)) {
                const value = cotizacionData[field];
                fieldValues[field] = value;
                
                // Check if field is missing or empty
                if (value === null || value === undefined || value === '' || 
                    (typeof value === 'string' && value.trim() === '')) {
                    missingFields.push({
                        field: field,
                        displayName: displayName
                    });
                }
            }

            const isValid = missingFields.length === 0;
            console.log(`📊 Validation result: ${isValid ? 'Valid' : 'Invalid'} - Missing fields:`, missingFields);

            return {
                isValid: isValid,
                missingFields: missingFields,
                fieldValues: fieldValues,
                cotizacionData: cotizacionData
            };

        } catch (error) {
            console.error('❌ Error validating consultation fields:', error);
            return { isValid: true, missingFields: [] }; // Don't block if validation fails
        }
    };

    window.showConsultationFieldsSection = function(validationResult) {
        console.log('📋 Showing consultation fields section');
        
        const section = document.getElementById('cotizacionFieldsSection');
        const infoAlert = document.getElementById('cotizacionFieldsInfo');
        const warningAlert = document.getElementById('cotizacionFieldsWarning');
        
        if (!section) return;

        const { isValid, missingFields, fieldValues } = validationResult;

        // Clear previous field visibility
        const dynamicFields = section.querySelectorAll('.campo-dinamico');
        dynamicFields.forEach(field => {
            field.style.display = 'none';
        });

        if (isValid) {
            // All fields are complete
            if (infoAlert) {
                infoAlert.style.display = 'block';
                infoAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Perfecto:</strong> Todos los campos obligatorios están completos en la cotización seleccionada.
                `;
            }
            if (warningAlert) {
                warningAlert.style.display = 'none';
            }
            
            // Hide save button section when all fields are complete
            const saveSection = document.getElementById('consultationSaveSection');
            if (saveSection) {
                saveSection.style.display = 'none';
            }
        } else {
            // Some fields are missing
            if (warningAlert) {
                const fieldNames = missingFields.map(f => f.displayName).join(', ');
                warningAlert.style.display = 'block';
                warningAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Atención:</strong> Los siguientes campos están vacíos en la cotización: <strong>${fieldNames}</strong>
                    <br><small class="mt-2 d-block">Por favor, complete estos campos para poder crear la solicitud.</small>
                `;
            }
            if (infoAlert) {
                infoAlert.style.display = 'none';
            }

            // Show fields for missing values and populate existing values
            missingFields.forEach(missingField => {
                const fieldElement = document.getElementById(`${missingField.field}Field`);
                if (fieldElement) {
                    fieldElement.style.display = 'block';
                }
            });

            // Show save button section when there are missing fields
            const saveSection = document.getElementById('consultationSaveSection');
            if (saveSection) {
                saveSection.style.display = 'block';
            }

            // Populate existing values for context
            populateConsultationFields(fieldValues);
        }

        section.style.display = 'block';
        section.classList.add('show');
        
        // Update create button state when section is shown
        setTimeout(() => {
            window.updateCreateButtonState();
        }, 100);
    };

    window.hideConsultationFieldsSection = function() {
        console.log('📋 Hiding consultation fields section');
        
        const section = document.getElementById('cotizacionFieldsSection');
        if (section) {
            section.style.display = 'none';
            section.classList.remove('show');
        }
        
        // Update create button state when section is hidden
        setTimeout(() => {
            window.updateCreateButtonState();
        }, 100);
    };

    window.populateConsultationFields = function(fieldValues) {
        console.log('📝 Populating consultation fields with existing values:', fieldValues);
        
        const fieldMappings = {
            'sector': 'sector',
            'politica': 'politica', 
            'observaciones': 'observaciones',
            'tiempoServicio': 'tiempoServicio',
            'nombreEmpresa': 'nombreEmpresa',
            'ingresos': 'ingresos',
            'posicion': 'posicion',
            'apcScore': 'apcScore',
            'apcPI': 'apcPI'
        };

        for (const [fieldName, elementId] of Object.entries(fieldMappings)) {
            const element = document.getElementById(elementId);
            const value = fieldValues[fieldName];
            
            if (element && value !== null && value !== undefined && value !== '') {
                element.value = value;
                console.log(`📝 Populated ${fieldName} with value:`, value);
            }
        }

        // Special handling for política - load options if needed
        if (fieldValues.politica) {
            loadPoliticasForDrawer(fieldValues.politica);
        } else {
            loadPoliticasForDrawer(null);
        }
    };

    window.loadPoliticasForDrawer = async function(selectedPoliticaId) {
        console.log('📋 Loading políticas for drawer select');
        
        const politicaSelect = document.getElementById('politica');
        if (!politicaSelect) return;

        try {
            const response = await fetch('/workflow/api/politicas/');
            const data = await response.json();
            
            politicaSelect.innerHTML = '<option value="">Seleccionar política...</option>';
            
            if (data.politicas) {
                data.politicas.forEach(politica => {
                    const option = document.createElement('option');
                    option.value = politica.id;
                    option.textContent = politica.titulo;
                    
                    if (selectedPoliticaId && String(selectedPoliticaId) === String(politica.id)) {
                        option.selected = true;
                    }
                    
                    politicaSelect.appendChild(option);
                });
            }
            
            console.log('📋 Políticas loaded successfully');
        } catch (error) {
            console.error('❌ Error loading políticas:', error);
            politicaSelect.innerHTML = '<option value="">Error cargando políticas</option>';
        }
    };

    window.saveConsultationFields = async function(cotizacionId) {
        console.log('💾 Saving consultation fields for cotización:', cotizacionId);
        
        if (!cotizacionId) {
            console.error('❌ No cotización ID provided');
            return { success: false, error: 'No cotización ID provided' };
        }

        // Collect field values
        const fieldData = {
            sector: document.getElementById('sector')?.value || '',
            politica: document.getElementById('politica')?.value || '',
            observaciones: document.getElementById('observaciones')?.value?.trim() || '',
            tiempoServicio: document.getElementById('tiempoServicio')?.value?.trim() || '',
            nombreEmpresa: document.getElementById('nombreEmpresa')?.value?.trim() || '',
            ingresos: document.getElementById('ingresos')?.value || '',
            posicion: document.getElementById('posicion')?.value?.trim() || '',
            apcScore: document.getElementById('apcScore')?.value || '',
            apcPI: document.getElementById('apcPI')?.value || ''
        };

        console.log('📋 Field data to save:', fieldData);

        // Basic client-side validation
        const requiredFields = [];
        if (!fieldData.sector) requiredFields.push('Sector');
        if (!fieldData.politica) requiredFields.push('Política');
        if (!fieldData.observaciones) requiredFields.push('Observaciones');
        if (!fieldData.tiempoServicio) requiredFields.push('Tiempo de Servicio');
        if (!fieldData.nombreEmpresa) requiredFields.push('Nombre de la Empresa');
        if (!fieldData.ingresos) requiredFields.push('Ingresos');
        if (!fieldData.posicion) requiredFields.push('Posición');
        if (!fieldData.apcScore) requiredFields.push('APC Score');
        if (!fieldData.apcPI) requiredFields.push('APC PI');

        if (requiredFields.length > 0) {
            const errorMessage = `Los siguientes campos son requeridos: ${requiredFields.join(', ')}`;
            console.error('❌ Validation failed:', errorMessage);
            alert(errorMessage);
            return { success: false, error: errorMessage };
        }

        try {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                             document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

            const response = await fetch(`/cotizacion/${cotizacionId}/update_consulta_fields/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(fieldData)
            });

            const result = await response.json();

            if (result.ok) {
                console.log('✅ Consultation fields saved successfully');
                // Hide the consultation fields section since they're now complete
                hideConsultationFieldsSection();
                
                // Show success message
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Éxito:</strong> Los campos de consulta han sido guardados correctamente.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const section = document.getElementById('cotizacionFieldsSection');
                if (section) {
                    section.parentNode.insertBefore(successAlert, section);
                }
                
                return { success: true };
            } else {
                console.error('❌ Error saving consultation fields:', result.error);
                alert(`Error al guardar los campos: ${result.error}`);
                return { success: false, error: result.error };
            }

        } catch (error) {
            console.error('❌ Network error saving consultation fields:', error);
            alert('Error de conexión al guardar los campos. Por favor, inténtelo de nuevo.');
            return { success: false, error: error.message };
        }
    };

    // Handler function for the save consultation fields button
    window.handleSaveConsultationFields = async function() {
        console.log('🔧 Save consultation fields button clicked');
        
        const cotizacionId = document.getElementById('cotizacionId')?.value;
        if (!cotizacionId) {
            alert('No hay cotización seleccionada');
            return;
        }

        // Show loading state
        const saveButton = document.querySelector('#consultationSaveSection button');
        if (saveButton) {
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
        }

        try {
            const result = await saveConsultationFields(cotizacionId);
            
            if (result.success) {
                // Re-validate consultation fields to update the display
                setTimeout(async () => {
                    const validationResult = await validateConsultationFields(cotizacionId);
                    showConsultationFieldsSection(validationResult);
                }, 1000);
            }
        } finally {
            // Restore button state
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Campos de Consulta';
            }
        }
    };

    // Submit form and showSuccessMessage functions defined in negocios.html to avoid conflicts

    // Enhanced submit validation that includes cotización fields
    window.validateFormBeforeSubmit = function() {
        console.log('🔍 validateFormBeforeSubmit called');
        
        // First check cotização duplicate
        const cotizacionCheck = checkCotizacionBeforeSubmit();
        if (!cotizacionCheck.canProceed) {
            return { canProceed: false, reason: 'duplicate_cotizacion' };
        }
        
        // Then check mandatory fields
        const fieldsCheck = validateMandatoryFieldsBeforeSubmit();
        if (!fieldsCheck.isValid) {
            console.log('❌ Mandatory fields validation failed:', fieldsCheck.missingFields);
            
            // Show error message
            const fieldNames = fieldsCheck.missingFields.join(', ');
            alert(`Por favor, complete los siguientes campos obligatorios:\n\n${fieldNames}`);
            
            return { canProceed: false, reason: 'missing_mandatory_fields', missingFields: fieldsCheck.missingFields };
        }
        
        console.log('✅ All validations passed');
        return { canProceed: true };
    };

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Drawer initialization started');
        setupSessionMonitoring();
        loadUsuariosForPropietario();

        // Drawer overlay click handler disabled - drawer won't close when clicking outside
        const drawerElement = document.getElementById('solicitudDrawer');
        if (drawerElement) {
            // Event listener removed to prevent drawer from closing when clicking outside
            console.log('✅ Drawer overlay click handler disabled (drawer stays open when clicking outside)');
        }
        console.log('✅ Drawer initialized successfully');
    });

    // Load users for propietario dropdown
    window.loadUsuariosForPropietario = async function() {
        console.log('📋 Loading users for propietario dropdown');
        
        const propietarioSelect = document.getElementById('propietarioSelect');
        if (!propietarioSelect) return;

        // Check if current user role is 'Oficial'
        const isOficial = window.currentUserRole === 'Oficial';
        console.log('🔧 Is user Oficial?', isOficial, 'Role:', window.currentUserRole);

        if (isOficial) {
            // For Oficial users, disable dropdown and only show current user
            console.log('🔒 Restricting propietario dropdown for Oficial user');
            propietarioSelect.innerHTML = '';
            propietarioSelect.disabled = true;
            propietarioSelect.style.opacity = '0.6';
            propietarioSelect.style.cursor = 'not-allowed';
            
            // Add only current user option
            const option = document.createElement('option');
            option.value = window.currentUserId;
            option.selected = true;
            
            // Try to get current user's name from the API or use a default
            try {
                const response = await fetch('/workflow/api/usuarios', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.usuarios) {
                        const currentUser = data.usuarios.find(u => String(u.id) === String(window.currentUserId));
                        if (currentUser) {
                            let displayName = '';
                            if (currentUser.first_name && currentUser.last_name) {
                                displayName = `${currentUser.first_name} ${currentUser.last_name}`;
                            } else if (currentUser.first_name) {
                                displayName = currentUser.first_name;
                            } else if (currentUser.last_name) {
                                displayName = currentUser.last_name;
                            } else {
                                displayName = currentUser.username;
                            }
                            option.textContent = `${displayName} (Usuario actual)`;
                        } else {
                            option.textContent = 'Usuario actual';
                        }
                    } else {
                        option.textContent = 'Usuario actual';
                    }
                } else {
                    option.textContent = 'Usuario actual';
                }
            } catch (error) {
                console.error('❌ Error loading current user info:', error);
                option.textContent = 'Usuario actual';
            }
            
            propietarioSelect.appendChild(option);
            
            // Add explanatory text below the select
            const parentDiv = propietarioSelect.parentElement;
            let infoMessage = parentDiv.querySelector('.oficial-restriction-info');
            if (!infoMessage) {
                infoMessage = document.createElement('small');
                infoMessage.className = 'text-warning oficial-restriction-info mt-2 d-block';
                infoMessage.innerHTML = '<i class="fas fa-lock me-1"></i>Como usuario Oficial, solo puedes asignarte solicitudes a ti mismo.';
                parentDiv.appendChild(infoMessage);
            }
            
            console.log('✅ Propietario dropdown restricted for Oficial user');
            return;
        }

        // For non-Oficial users, show full functionality
        try {
            const response = await fetch('/workflow/api/usuarios', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('✅ Users loaded for propietario dropdown:', data);
            
            // Ensure dropdown is enabled for non-Oficial users
            propietarioSelect.disabled = false;
            propietarioSelect.style.opacity = '1';
            propietarioSelect.style.cursor = 'default';
            
            propietarioSelect.innerHTML = '<option value="">Seleccionar propietario...</option>';
            
            if (data.success && data.usuarios) {
                data.usuarios.forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.id;
                    
                    // Display first name and last name if available, otherwise use username
                    let displayName = '';
                    if (usuario.first_name && usuario.last_name) {
                        displayName = `${usuario.first_name} ${usuario.last_name}`;
                    } else if (usuario.first_name) {
                        displayName = usuario.first_name;
                    } else if (usuario.last_name) {
                        displayName = usuario.last_name;
                    } else {
                        displayName = usuario.username;
                    }
                    
                    option.textContent = displayName;
                    
                    // Set current user as default selected
                    if (window.currentUserId && String(usuario.id) === String(window.currentUserId)) {
                        option.selected = true;
                    }
                    
                    propietarioSelect.appendChild(option);
                });
                
                // Remove any restriction message for non-Oficial users
                const parentDiv = propietarioSelect.parentElement;
                const infoMessage = parentDiv.querySelector('.oficial-restriction-info');
                if (infoMessage) {
                    infoMessage.remove();
                }
                
                console.log('✅ Users loaded for propietario dropdown');
            } else {
                throw new Error('Invalid response format');
            }
        } catch (error) {
            console.error('❌ Error loading users for propietario:', error);
            propietarioSelect.innerHTML = '<option value="">Error cargando usuarios</option>';
        }
    };

    // Function to set current user as default propietario
    window.setCurrentUserAsPropietario = function(userId) {
        console.log('🔧 Setting current user as default propietario:', userId);
        
        const propietarioSelect = document.getElementById('propietarioSelect');
        if (propietarioSelect && userId) {
            // For Oficial users, ensure they can only select themselves
            const isOficial = window.currentUserRole === 'Oficial';
            if (isOficial && String(userId) !== String(window.currentUserId)) {
                console.log('🔒 Oficial user cannot set different propietario, using current user instead');
                userId = window.currentUserId;
            }
            
            // Set the value if the option exists
            const option = propietarioSelect.querySelector(`option[value="${userId}"]`);
            if (option) {
                option.selected = true;
                console.log('✅ Current user set as default propietario');
            }
        }
    };

    // Session monitoring for drawer
    function setupSessionMonitoring() {
        // Check session every 5 minutes
        setInterval(checkDrawerSession, 5 * 60 * 1000);

        // Check session when drawer opens
        document.addEventListener('drawerOpened', checkDrawerSession);
    }

    function checkDrawerSession() {
        // Only check if drawer is open
        const drawer = document.getElementById('solicitudDrawer');
        if (!drawer || !drawer.classList.contains('active')) {
            return;
        }

        fetch('/workflow/api/debug-session/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('Session expired');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON - session timeout');
                }

                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('✅ Session check passed for drawer');
                } else {
                    throw new Error('Session check failed');
                }
            })
            .catch(error => {
                console.error('❌ Session check failed for drawer:', error);

                // Show session warning in drawer
                showSessionWarning();
            });
    }

    function showSessionWarning() {
        // Create warning banner
        const warningBanner = document.createElement('div');
        warningBanner.className = 'session-warning-banner';
        warningBanner.innerHTML = `
        <div class="session-warning-content">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span>Tu sesión está por expirar. Guarda tu trabajo.</span>
            <button type="button" class="btn btn-sm btn-outline-light ms-3" onclick="extendSession()">
                <i class="fas fa-sync-alt me-1"></i>Extender Sesión
            </button>
        </div>
    `;

        // Add to drawer
        const drawerContent = document.querySelector('.drawer-content');
        drawerContent.insertBefore(warningBanner, drawerContent.firstChild);

        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (warningBanner.parentNode) {
                warningBanner.remove();
            }
        }, 10000);
    }

    function extendSession() {
        // Make a request to extend the session
        fetch('/workflow/api/debug-session/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (response.ok) {
                    // Remove warning banner
                    const warningBanner = document.querySelector('.session-warning-banner');
                    if (warningBanner) {
                        warningBanner.remove();
                    }

                    // Show success message
                    showSuccessMessage('Sesión extendida exitosamente');
                } else {
                    throw new Error('Failed to extend session');
                }
            })
            .catch(error => {
                console.error('Error extending session:', error);
                showSuccessMessage('Error al extender sesión. Guarda tu trabajo.');
            });
    }

    // Function to auto-populate APC fields when client is selected
    function autoPopulateApcFields(clienteData) {
        console.log('🔧 autoPopulateApcFields called with:', clienteData);

        const apcTipoDocumento = document.getElementById('apcTipoDocumento');
        const apcNoCedula = document.getElementById('apcNoCedula');

        if (clienteData && clienteData.cedulaCliente && apcNoCedula) {
            // Auto-populate the document number with the client's cedula
            apcNoCedula.value = clienteData.cedulaCliente;

            // Add visual indicator for auto-populated field
            apcNoCedula.classList.add('auto-populated-field');
            apcNoCedula.setAttribute('data-auto-populated', 'true');
            apcNoCedula.placeholder = 'Auto-completado desde cliente seleccionado';

            // Auto-select "Cédula" as document type if not already selected
            if (apcTipoDocumento && !apcTipoDocumento.value) {
                apcTipoDocumento.value = 'cedula';
            }

            console.log('✅ APC fields auto-populated:', {
                tipo: apcTipoDocumento?.value,
                numero: apcNoCedula.value
            });
        } else {
            console.log('⚠️ No client data available for APC auto-population');
        }
    }

    // Function to clear APC fields when client is cleared
    function clearApcFields() {
        console.log('🔧 clearApcFields called');

        const apcTipoDocumento = document.getElementById('apcTipoDocumento');
        const apcNoCedula = document.getElementById('apcNoCedula');

        if (apcTipoDocumento) apcTipoDocumento.value = '';
        if (apcNoCedula) {
            apcNoCedula.value = '';
            apcNoCedula.classList.remove('auto-populated-field');
            apcNoCedula.removeAttribute('data-auto-populated');
            apcNoCedula.placeholder = 'Ingrese el número de cédula o pasaporte';
        }

        console.log('✅ APC fields cleared');
    }

    // Enhanced function to handle cotización selection with validation
    window.handleCotizacionSelection = function(cotizacionData) {
        console.log('🔧 handleCotizacionSelection called with:', cotizacionData);
        
        // Perform existing cotización selection logic
        if (typeof window.originalHandleCotizacionSelection === 'function') {
            window.originalHandleCotizacionSelection(cotizacionData);
        }
        
        // Trigger field validation
        if (cotizacionData) {
            const validation = validateCotizacionFields(cotizacionData);
            console.log('✅ Cotización validation completed:', validation);
        } else {
            // Clear validation section if no cotización selected
            hideCotizacionFieldsSection();
        }
    };

    // Function to auto-populate SURA fields when client is selected
    function autoPopulateSuraFields(clienteData, cotizacionData = null) {
        console.log('🔧 autoPopulateSuraFields called with:', { clienteData, cotizacionData });

        const suraPrimerNombre = document.getElementById('suraPrimerNombre');
        const suraSegundoNombre = document.getElementById('suraSegundoNombre');
        const suraPrimerApellido = document.getElementById('suraPrimerApellido');
        const suraSegundoApellido = document.getElementById('suraSegundoApellido');
        const suraNoDocumento = document.getElementById('suraNoDocumento');
        const suraTipoDocumento = document.getElementById('suraTipoDocumento');
        
        // Vehicle fields
        const suraValorAuto = document.getElementById('suraValorAuto');
        const suraAnoAuto = document.getElementById('suraAnoAuto');
        const suraMarca = document.getElementById('suraMarca');
        const suraModelo = document.getElementById('suraModelo');

        // Function to handle field editing - remove auto-populated styling when user edits
        function handleFieldEdit(field) {
            if (field && field.classList.contains('auto-populated-field')) {
                field.addEventListener('input', function() {
                    this.classList.remove('auto-populated-field');
                    this.removeAttribute('data-auto-populated');
                });
            }
        }

        // Auto-populate client document data
        if (clienteData && clienteData.cedulaCliente && suraNoDocumento) {
            // Auto-populate the document number with the client's cedula
            suraNoDocumento.value = clienteData.cedulaCliente;

            // Add visual indicator for auto-populated field
            suraNoDocumento.classList.add('auto-populated-field');
            suraNoDocumento.setAttribute('data-auto-populated', 'true');
            suraNoDocumento.placeholder = 'Auto-completado desde cliente seleccionado';

            console.log('✅ SURA client document auto-populated:', {
                documento: suraNoDocumento.value
            });

            // Add edit listener to document number field
            handleFieldEdit(suraNoDocumento);
        }

        // Auto-populate document type from cotización if available
        if (cotizacionData && cotizacionData.tipoDocumento && suraTipoDocumento) {
            // Map from cotización format to SURA format
            const tipoDocumentoMap = {
                'CEDULA': 'cedula',
                'PASAPORTE': 'pasaporte'
            };
            const mappedTipo = tipoDocumentoMap[cotizacionData.tipoDocumento] || 'cedula';
            suraTipoDocumento.value = mappedTipo;
            
            suraTipoDocumento.classList.add('auto-populated-field');
            suraTipoDocumento.setAttribute('data-auto-populated', 'true');
            
            console.log('✅ SURA document type auto-populated:', {
                tipoDocumento: mappedTipo
            });

            // Add edit listener to document type field
            handleFieldEdit(suraTipoDocumento);
        }

        // Auto-populate vehicle data from cotización if available
        if (cotizacionData) {
            if (cotizacionData.valorAuto && suraValorAuto) {
                suraValorAuto.value = cotizacionData.valorAuto;
                suraValorAuto.classList.add('auto-populated-field');
                suraValorAuto.setAttribute('data-auto-populated', 'true');
            }
            
            if (cotizacionData.yearCarro && suraAnoAuto) {
                suraAnoAuto.value = cotizacionData.yearCarro;
                suraAnoAuto.classList.add('auto-populated-field');
                suraAnoAuto.setAttribute('data-auto-populated', 'true');
            }
            
            if (cotizacionData.marca && suraMarca) {
                suraMarca.value = cotizacionData.marca;
                suraMarca.classList.add('auto-populated-field');
                suraMarca.setAttribute('data-auto-populated', 'true');
            }
            
            if (cotizacionData.modelo && suraModelo) {
                suraModelo.value = cotizacionData.modelo;
                suraModelo.classList.add('auto-populated-field');
                suraModelo.setAttribute('data-auto-populated', 'true');
            }

            console.log('✅ SURA vehicle data auto-populated:', {
                valorAuto: cotizacionData.valorAuto,
                yearCarro: cotizacionData.yearCarro,
                marca: cotizacionData.marca,
                modelo: cotizacionData.modelo
            });

            // Add edit listeners to vehicle fields
            handleFieldEdit(suraValorAuto);
            handleFieldEdit(suraAnoAuto);
            handleFieldEdit(suraMarca);
            handleFieldEdit(suraModelo);
        }

        if (!clienteData && !cotizacionData) {
            console.log('⚠️ No client or cotización data available for SURA auto-population');
        }
    }

    // Function to clear SURA fields when client is cleared
    function clearSuraFields() {
        console.log('🔧 clearSuraFields called');

        const suraPrimerNombre = document.getElementById('suraPrimerNombre');
        const suraSegundoNombre = document.getElementById('suraSegundoNombre');
        const suraPrimerApellido = document.getElementById('suraPrimerApellido');
        const suraSegundoApellido = document.getElementById('suraSegundoApellido');
        const suraNoDocumento = document.getElementById('suraNoDocumento');
        const suraTipoDocumento = document.getElementById('suraTipoDocumento');
        
        // Vehicle fields
        const suraValorAuto = document.getElementById('suraValorAuto');
        const suraAnoAuto = document.getElementById('suraAnoAuto');
        const suraMarca = document.getElementById('suraMarca');
        const suraModelo = document.getElementById('suraModelo');

        // Clear client fields
        if (suraPrimerNombre) suraPrimerNombre.value = '';
        if (suraSegundoNombre) suraSegundoNombre.value = '';
        if (suraPrimerApellido) suraPrimerApellido.value = '';
        if (suraSegundoApellido) suraSegundoApellido.value = '';
        
        if (suraNoDocumento) {
            suraNoDocumento.value = '';
            suraNoDocumento.classList.remove('auto-populated-field');
            suraNoDocumento.removeAttribute('data-auto-populated');
            suraNoDocumento.placeholder = 'Ingrese el número de documento';
        }
        
        if (suraTipoDocumento) {
            suraTipoDocumento.value = '';
            suraTipoDocumento.classList.remove('auto-populated-field');
            suraTipoDocumento.removeAttribute('data-auto-populated');
        }

        // Clear vehicle fields
        if (suraValorAuto) {
            suraValorAuto.value = '';
            suraValorAuto.classList.remove('auto-populated-field');
            suraValorAuto.removeAttribute('data-auto-populated');
        }
        
        if (suraAnoAuto) {
            suraAnoAuto.value = '';
            suraAnoAuto.classList.remove('auto-populated-field');
            suraAnoAuto.removeAttribute('data-auto-populated');
        }
        
        if (suraMarca) {
            suraMarca.value = '';
            suraMarca.classList.remove('auto-populated-field');
            suraMarca.removeAttribute('data-auto-populated');
        }
        
        if (suraModelo) {
            suraModelo.value = '';
            suraModelo.classList.remove('auto-populated-field');
            suraModelo.removeAttribute('data-auto-populated');
        }

        console.log('✅ SURA fields cleared');
    }

    // Global function to open drawer with context - defined in negocios.html to avoid conflicts

    // Function to show/hide Makito message in requisitos section
    window.updateMakitoMessage = function() {
        console.log('🔧 updateMakitoMessage called');
        
        const descargarApcMakito = document.getElementById('descargarApcMakito');
        const cotizarSuraMakito = document.getElementById('cotizarSuraMakito');
        
        const apcChecked = descargarApcMakito && descargarApcMakito.checked;
        const suraChecked = cotizarSuraMakito && cotizarSuraMakito.checked;
        
        let makitoMessage = document.getElementById('makitoMessage');
        const requisitosContainer = document.getElementById('requisitosContainer');
        
        if ((apcChecked || suraChecked) && requisitosContainer) {
            // Create message if it doesn't exist
            if (!makitoMessage) {
                makitoMessage = document.createElement('div');
                makitoMessage.id = 'makitoMessage';
                makitoMessage.className = 'makito-info-message';
                
                // Insert at the beginning of requisitos container
                requisitosContainer.insertBefore(makitoMessage, requisitosContainer.firstChild);
            }
            
            // Determine which documents will be uploaded by Makito
            let documents = [];
            if (apcChecked) documents.push('APC');
            if (suraChecked) documents.push('Cotización SURA');
            
            const docList = documents.join(' y ');
            
            // Update message content
            makitoMessage.innerHTML = `
                <i class="fas fa-robot"></i>
                <span class="makito-title">Documentos automáticos con Makito</span>
                <div class="makito-description">
                    Makito subirá automáticamente ${docList} al crear el negocio. 
                    No necesitas subir estos documentos manualmente.
                </div>
            `;
            
            // Show the message
            makitoMessage.classList.add('show');
            
            console.log('✅ Makito message shown for:', documents);
        } else if (makitoMessage) {
            // Hide the message if no Makito options are selected
            makitoMessage.classList.remove('show');
            console.log('✅ Makito message hidden');
        }
    };

    // Function to validate and handle mandatory cotización fields
    window.validateCotizacionFields = function(cotizacionData) {
        console.log('🔍 validateCotizacionFields called with:', cotizacionData);
        
        if (!cotizacionData) {
            hideCotizacionFieldsSection();
            return { isValid: true, missingFields: [] };
        }

        // Only show campos obligatorios for auto loans
        const isAutoLoan = cotizacionData.tipoPrestamo === 'auto';
        console.log('🔍 Loan type check:', {
            tipoPrestamo: cotizacionData.tipoPrestamo,
            isAutoLoan: isAutoLoan
        });
        
        if (!isAutoLoan) {
            console.log('🔧 Skipping cotización fields validation - not an auto loan (tipoPrestamo:', cotizacionData.tipoPrestamo, ')');
            hideCotizacionFieldsSection();
            return { isValid: true, missingFields: [] };
        }

        const mandatoryFields = [
            { key: 'posicion', name: 'Posición', fieldId: 'posicionField' },
            { key: 'tiempoServicio', name: 'Tiempo de Servicio', fieldId: 'tiempoServicioField' },
            { key: 'salarioBaseMensual', name: 'Salario Base Mensual', fieldId: 'salarioField' },
            { key: 'apcScore', name: 'APC Score', fieldId: 'apcScoreField' },
            { key: 'politica', name: 'Política', fieldId: 'politicaField' },
            { key: 'sector', name: 'Sector', fieldId: 'sectorField' }
        ];

        let missingFields = [];
        let validFields = [];

        // Check each mandatory field
        mandatoryFields.forEach(field => {
            const value = cotizacionData[field.key];
            const isEmpty = !value || (typeof value === 'string' && value.trim() === '') || 
                           (typeof value === 'number' && (isNaN(value) || value === 0));
            
            if (isEmpty) {
                missingFields.push(field);
            } else {
                validFields.push(field);
            }
        });

        console.log('✅ Field validation results:', {
            validFields: validFields.map(f => f.name),
            missingFields: missingFields.map(f => f.name)
        });

        // Show or hide the cotización fields section
        if (missingFields.length > 0) {
            showCotizacionFieldsSection(missingFields, validFields, cotizacionData);
        } else {
            hideCotizacionFieldsSection();
        }

        return {
            isValid: missingFields.length === 0,
            missingFields: missingFields,
            validFields: validFields
        };
    };

    function showCotizacionFieldsSection(missingFields, validFields, cotizacionData) {
        console.log('🔧 showCotizacionFieldsSection called with cotización data:', cotizacionData);
        
        // Safety check: never show for personal loans
        if (cotizacionData && cotizacionData.tipoPrestamo !== 'auto') {
            console.log('🔧 Blocking showCotizacionFieldsSection - not an auto loan');
            hideCotizacionFieldsSection();
            return;
        }
        
        const section = document.getElementById('cotizacionFieldsSection');
        const infoAlert = document.getElementById('cotizacionFieldsInfo');
        const warningAlert = document.getElementById('cotizacionFieldsWarning');
        
        if (!section) return;

        // Show the section
        section.style.display = 'block';

        // Hide all field containers first
        const allFields = ['posicionField', 'tiempoServicioField', 'salarioField', 'apcScoreField', 'politicaField', 'sectorField'];
        allFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.style.display = 'none';
        });

        // Show alerts based on what we have
        if (validFields.length > 0 && missingFields.length > 0) {
            // Some fields are complete, some are missing
            infoAlert.style.display = 'block';
            warningAlert.style.display = 'block';
        } else if (missingFields.length > 0) {
            // Only missing fields
            infoAlert.style.display = 'none';
            warningAlert.style.display = 'block';
        }

        // Show only the fields that are missing
        missingFields.forEach(field => {
            const fieldElement = document.getElementById(field.fieldId);
            if (fieldElement) {
                fieldElement.style.display = 'block';
                
                // Pre-populate with existing data if available
                const inputElement = fieldElement.querySelector('input, select');
                if (inputElement && cotizacionData[field.key]) {
                    inputElement.value = cotizacionData[field.key];
                }
            }
        });

        // Load políticas if politica field is missing
        if (missingFields.some(f => f.key === 'politica')) {
            loadPoliticasOptions();
        }

        console.log('✅ Cotización fields section shown with missing fields:', missingFields.map(f => f.name));
    }

    window.hideCotizacionFieldsSection = function() {
        console.log('🔧 hideCotizacionFieldsSection called');
        
        const section = document.getElementById('cotizacionFieldsSection');
        if (section) {
            section.style.display = 'none';
            section.classList.remove('show');
            console.log('🔧 Section hidden - display: none, show class removed');
        } else {
            console.log('⚠️ Could not find cotizacionFieldsSection element');
        }
        
        console.log('✅ Cotización fields section hidden');
    };

    async function loadPoliticasOptions() {
        console.log('🔧 loadPoliticasOptions called');
        
        try {
            const response = await fetch('/workflow/api/politicas/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const politicaSelect = document.getElementById('politica');
            
            if (politicaSelect && data.politicas) {
                // Clear existing options except the first one
                politicaSelect.innerHTML = '<option value="">Seleccionar política...</option>';
                
                // Add políticas options
                data.politicas.forEach(politica => {
                    const option = document.createElement('option');
                    option.value = politica.id;
                    option.textContent = politica.titulo;
                    politicaSelect.appendChild(option);
                });

                console.log('✅ Políticas loaded:', data.politicas.length);
            }
        } catch (error) {
            console.error('❌ Error loading políticas:', error);
            
            // Show fallback message
            const politicaSelect = document.getElementById('politica');
            if (politicaSelect) {
                politicaSelect.innerHTML = '<option value="">Error cargando políticas...</option>';
            }
        }
    }

    // Function to collect cotización field values from the form
    window.getCotizacionFieldValues = function() {
        console.log('🔧 getCotizacionFieldValues called');
        
        const values = {};
        const fieldMappings = {
            'posicion': 'posicion',
            'tiempoServicio': 'tiempo_servicio',
            'salario': 'salario',
            'apcScore': 'apc_score',
            'politica': 'politica',
            'sector': 'sector'
        };

        Object.keys(fieldMappings).forEach(fieldId => {
            const input = document.getElementById(fieldId);
            if (input && input.value && input.value.trim() !== '') {
                values[fieldMappings[fieldId]] = input.value.trim();
            }
        });

        console.log('✅ Collected cotización field values:', values);
        return values;
    };

    // Function to validate that all mandatory fields are completed before submit
    window.validateMandatoryFieldsBeforeSubmit = function() {
        console.log('🔍 validateMandatoryFieldsBeforeSubmit called');
        
        const section = document.getElementById('cotizacionFieldsSection');
        const isVisible = section && section.style.display !== 'none';
        
        if (!isVisible) {
            // Section is not visible, so validation passed earlier
            return { isValid: true, missingFields: [] };
        }

        const mandatoryInputs = [
            { id: 'posicion', name: 'Posición' },
            { id: 'tiempoServicio', name: 'Tiempo de Servicio' },
            { id: 'ingresos', name: 'Ingresos' },
            { id: 'apcScore', name: 'APC Score' },
            { id: 'politica', name: 'Política' },
            { id: 'sector', name: 'Sector' },
            { id: 'observaciones', name: 'Observaciones' },
            { id: 'nombreEmpresa', name: 'Nombre de la Empresa' },
            { id: 'apcPI', name: 'APC PI' }
        ];

        let missingFields = [];

        mandatoryInputs.forEach(field => {
            const input = document.getElementById(field.id);
            const fieldContainer = input?.closest('.campo-dinamico');
            
            // Only validate if the field is visible
            if (fieldContainer && fieldContainer.style.display !== 'none') {
                if (!input || !input.value || input.value.trim() === '') {
                    missingFields.push(field.name);
                    
                    // Add visual validation feedback
                    if (input) {
                        input.classList.add('is-invalid');
                    }
                } else {
                    // Remove validation feedback if field is filled
                    if (input) {
                        input.classList.remove('is-invalid');
                        input.classList.add('is-valid');
                    }
                }
            }
        });

        const isValid = missingFields.length === 0;
        
        console.log('✅ Mandatory fields validation result:', {
            isValid,
            missingFields
        });

        return { isValid, missingFields };
    };

    // Function to update create button state based on validation
    window.updateCreateButtonState = function() {
        console.log('🔍 Updating create button state');
        
        // Use a more stable selector that doesn't depend on the dynamic class
        const createButton = document.querySelector('.drawer-footer button[onclick="submitSolicitud()"]') || 
                           document.querySelector('.drawer-footer .btn-primary') ||
                           document.querySelector('.drawer-footer .btn-secondary');
        console.log('🔍 Create button found:', createButton);
        if (!createButton) return;

        // Check consultation fields validation
        const consultationValidation = window.validateMandatoryFieldsBeforeSubmit();
        
        // Check if "como se entero" is selected (only if section is visible)
        const comoSeEnteroSection = document.getElementById('comoSeEnteroSection');
        const comoSeEntero = document.getElementById('comoSeEntero');
        let comoSeEnteroValid = true; // Default to valid if section is not shown
        
        if (comoSeEnteroSection && comoSeEnteroSection.classList.contains('show')) {
            // Section is visible, so validation is required
            comoSeEnteroValid = comoSeEntero && comoSeEntero.value && comoSeEntero.value.trim() !== '';
        }
        
        // Check if pipeline is selected
        const pipelineSelect = document.getElementById('pipelineSelect');
        const pipelineValid = pipelineSelect && pipelineSelect.value && pipelineSelect.value.trim() !== '';
        
        const allValid = consultationValidation.isValid && comoSeEnteroValid && pipelineValid;
        
        if (allValid) {
            createButton.disabled = false;
            createButton.innerHTML = '<i class="fas fa-plus me-2"></i>Crear';
            createButton.classList.remove('btn-secondary');
            createButton.classList.add('btn-primary');
        } else {
            createButton.disabled = true;
            
            // Show specific reason for disabled state
            let reason = 'Crear';
            if (!pipelineValid) {
                reason = 'Selecciona Pipeline';
            } else if (!comoSeEnteroValid) {
                reason = 'Selecciona Canal';
            } else if (!consultationValidation.isValid) {
                reason = `Faltan ${consultationValidation.missingFields.length} campos`;
            }
            
            createButton.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${reason}`;
            createButton.classList.remove('btn-primary');
            createButton.classList.add('btn-secondary');
        }
        
        console.log('🔧 Create button state updated:', { 
            allValid, 
            consultationValid: consultationValidation.isValid, 
            comoSeEnteroValid,
            comoSeEnteroSectionVisible: comoSeEnteroSection && comoSeEnteroSection.classList.contains('show'),
            comoSeEnteroValue: comoSeEntero ? comoSeEntero.value : 'element not found',
            pipelineValid,
            pipelineValue: pipelineSelect ? pipelineSelect.value : 'element not found',
            buttonDisabled: createButton.disabled,
            buttonText: createButton.innerHTML
        });
    };

    // Debug function to manually test button state validation
    window.debugButtonState = function() {
        console.log('🔍 Manual button state debug');
        const createButton = document.querySelector('.drawer-footer button[onclick="submitSolicitud()"]') || 
                           document.querySelector('.drawer-footer .btn-primary') ||
                           document.querySelector('.drawer-footer .btn-secondary');
        const comoSeEnteroSection = document.getElementById('comoSeEnteroSection');
        const comoSeEntero = document.getElementById('comoSeEntero');
        const pipelineSelect = document.getElementById('pipelineSelect');
        
        console.log('Elements found:', {
            createButton: !!createButton,
            comoSeEnteroSection: !!comoSeEnteroSection,
            comoSeEntero: !!comoSeEntero,
            pipelineSelect: !!pipelineSelect
        });
        
        if (comoSeEnteroSection) {
            console.log('comoSeEnteroSection classes:', comoSeEnteroSection.className);
            console.log('comoSeEnteroSection style:', comoSeEnteroSection.style.display);
        }
        
        if (comoSeEntero) {
            console.log('comoSeEntero value:', comoSeEntero.value);
        }
        
        if (pipelineSelect) {
            console.log('pipelineSelect value:', pipelineSelect.value);
        }
        
        // Trigger the validation
        window.updateCreateButtonState();
    };

    // Add event listeners for real-time validation
    document.addEventListener('DOMContentLoaded', function() {
        // Listen for changes in consultation fields
        const consultationFieldIds = ['posicion', 'tiempoServicio', 'ingresos', 'apcScore', 'politica', 'sector', 'observaciones', 'nombreEmpresa', 'apcPI'];
        
        consultationFieldIds.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function() {
                    setTimeout(() => {
                        window.updateCreateButtonState();
                    }, 100);
                });
                
                field.addEventListener('change', function() {
                    setTimeout(() => {
                        window.updateCreateButtonState();
                    }, 100);
                });
            }
        });
        
        // Listen for changes in "como se entero"
        const comoSeEntero = document.getElementById('comoSeEntero');
        if (comoSeEntero) {
            console.log('✅ Como se enteró field found');
            comoSeEntero.addEventListener('change', function() {
                console.log('🔧 Como se enteró field changed');
                setTimeout(() => {
                    window.updateCreateButtonState();
                    console.log('🔧 Como se enteró field changed');
                }, 100);
            });
        }
        
        // Listen for changes in pipeline selection
        const pipelineSelect = document.getElementById('pipelineSelect');
        if (pipelineSelect) {
            pipelineSelect.addEventListener('change', function() {
                setTimeout(() => {
                    window.updateCreateButtonState();
                }, 100);
            });
        }
        
        console.log('✅ Real-time validation event listeners added');
    });

    // Add event listeners for Makito checkboxes when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        const descargarApcMakito = document.getElementById('descargarApcMakito');
        const cotizarSuraMakito = document.getElementById('cotizarSuraMakito');
        
        if (descargarApcMakito) {
            descargarApcMakito.addEventListener('change', function() {
                updateMakitoMessage();
                // Call existing functionality if it exists
                if (typeof handleApcMakitoChange === 'function') {
                    handleApcMakitoChange();
                }
            });
        }
        
        if (cotizarSuraMakito) {
            cotizarSuraMakito.addEventListener('change', function() {
                updateMakitoMessage();
                // Call existing functionality if it exists
                if (typeof handleSuraMakitoChange === 'function') {
                    handleSuraMakitoChange();
                }
            });
        }
        
        console.log('✅ Makito message event listeners added');
    });

</script>