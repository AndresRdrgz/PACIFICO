<!-- Modal para Requisitos Faltantes en Transiciones -->
<!-- 
    NOTA IMPORTANTE: C√ìDIGO DUPLICADO
    =================================
    
    Este archivo contiene JavaScript duplicado con negocios.html template.
    Las siguientes funciones est√°n duplicadas entre ambos archivos:
    - window.subirArchivosSecuencialmente
    - window.verificarTodosRequisitosCompletos  
    - window.configurarEventListenersModal
    - window.ejecutarCambioEtapa
    - handleIncompleteState (funci√≥n interna)
    
    RECOMENDACI√ìN: Mover estas funciones a un archivo JavaScript separado
    y incluirlo en ambos templates para evitar duplicaci√≥n y facilitar
    el mantenimiento.
    
    Archivos sugeridos:
    - static/workflow/js/modal-requisitos.js
    - static/workflow/js/requisitos-common.js
-->
<div class="modal fade" id="modalRequisitosFaltantes" tabindex="-1" aria-labelledby="modalRequisitosFaltantesLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);">
            <!-- Header con gradiente rojo/warning -->
            <div class="modal-header" id="modalHeader" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); border: none; padding: 24px 32px 20px 32px; position: relative; overflow: hidden;">
                <!-- Decoraci√≥n de fondo -->
                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; opacity: 0.6;"></div>
                <div style="position: absolute; top: 40px; right: 60px; width: 60px; height: 60px; background: rgba(255, 255, 255, 0.08); border-radius: 50%;"></div>
                
                <div class="w-100 text-center position-relative">
                    <h4 class="modal-title text-white fw-bold mb-1" id="modalRequisitosFaltantesLabel" style="font-size: 1.4rem; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <i class="fas fa-exclamation-triangle me-2" id="modalIcon" style="font-size: 1.2rem;"></i>
                        <span id="modalTitle">Requisitos Faltantes</span>
                    </h4>
                    <p class="text-white-50 mb-0" id="modalSubtitle" style="font-size: 0.9rem; font-weight: 500;">Completar para continuar</p>
                </div>
                
                <button type="button" class="btn-close btn-close-white position-absolute" style="top: 15px; right: 15px;" aria-label="Close" onclick="cerrarModalRequisitos()"></button>
            </div>
            
            <div class="modal-body" style="padding: 32px;">
                <!-- Mensaje de informaci√≥n -->
                <div class="alert alert-warning" id="infoAlert" role="alert" style="border-radius: 12px; border: none; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(253, 126, 20, 0.15));">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle text-warning me-3" id="infoIcon" style="font-size: 1.5rem;"></i>
                        <div>
                            <h6 class="alert-heading mb-1" id="infoTitle" style="color: #856404;">Documentos Requeridos y Opcionales</h6>
                            <p class="mb-0" id="infoMessage" style="color: #856404; font-size: 0.9rem;">
                                Solo necesitas completar los requisitos <strong>obligatorios</strong> para continuar a la siguiente etapa. Los documentos opcionales pueden facilitar el proceso pero no son requeridos.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n de la transici√≥n -->
                <div class="mb-4 p-3 bg-light rounded-3" style="border-left: 4px solid #007bff;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-route text-primary me-2"></i>
                        <div>
                            <h6 class="mb-1 text-primary fw-bold">Transici√≥n</h6>
                            <p class="mb-0 small text-muted">
                                <span id="etapaOrigenNombre">Etapa Actual</span>
                                <i class="fas fa-arrow-right mx-2 text-primary"></i>
                                <span id="etapaDestinoNombre">Nueva Etapa</span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de requisitos faltantes -->
                <div id="listaRequisitosFaltantes">
                    <!-- Se carga din√°micamente -->
                </div>
                
                <!-- Loading state -->
                <div id="loadingRequisitos" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando requisitos...</p>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 24px 32px; border: none; background: #f8f9fa;">
                <button type="button" class="btn btn-outline-secondary" onclick="cerrarModalRequisitos()" style="font-weight: 600; padding: 12px 24px; border-radius: 8px; border-width: 2px;">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnValidarYContinuar" style="font-weight: 600; padding: 12px 24px; border-radius: 8px; background: linear-gradient(135deg, #007bff, #0056b3); border: none; box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);" disabled>
                    <i class="fas fa-check me-2"></i>Validar y Continuar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estilos espec√≠ficos para el modal de requisitos -->
    <style>
    .requisito-item {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        background: white;
    }

    .requisito-item.completado {
        border-color: #28a745;
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.05), rgba(32, 201, 151, 0.1));
    }

    .requisito-item.faltante {
        border-color: #dc3545;
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.05), rgba(253, 126, 20, 0.1));
    }

    .requisito-item.opcional {
        border-color: #6c757d;
        background: linear-gradient(135deg, rgba(108, 117, 125, 0.05), rgba(173, 181, 189, 0.1));
    }

    .requisito-item.opcional.completado {
        border-color: #20c997;
        background: linear-gradient(135deg, rgba(32, 201, 151, 0.05), rgba(23, 162, 184, 0.1));
    }

    .requisito-header {
        display: flex;
        align-items: center;
        justify-content: between;
        margin-bottom: 15px;
    }

    .requisito-status {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.2rem;
        font-weight: bold;
    }

    .requisito-status.pendiente {
        background: linear-gradient(135deg, #dc3545, #fd7e14);
        color: white;
    }

    .requisito-status.opcional {
        background: linear-gradient(135deg, #6c757d, #adb5bd);
        color: white;
    }

    .requisito-status.opcional-completado {
        background: linear-gradient(135deg, #20c997, #17a2b8);
        color: white;
    }

    .seccion-requisitos {
        margin-bottom: 24px;
    }

    .seccion-titulo {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 16px;
        border-left: 4px solid #007bff;
    }

    .seccion-titulo.obligatorio {
        border-left-color: #dc3545;
    }

    .seccion-titulo.opcional {
        border-left-color: #6c757d;
    }

    .badge-obligatorio {
        background: linear-gradient(135deg, #dc3545, #fd7e14);
    }

    .badge-opcional {
        background: linear-gradient(135deg, #6c757d, #adb5bd);
    }

    .requisito-info h6 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #2d3748;
    }

    .requisito-info p {
        margin: 5px 0 0 0;
        font-size: 0.9rem;
        color: #6c757d;
        line-height: 1.4;
    }

    .file-upload-area {
        border: 2px dashed #ced4da;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        margin-top: 15px;
    }

    .file-upload-area:hover {
        border-color: #007bff;
        background: rgba(0, 123, 255, 0.05);
    }

    .file-upload-area.dragover {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    .file-selected-info {
        background: #e8f5e9;
        border: 1px solid #c8e6c9;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        display: none;
    }

    .file-selected-info.show {
        display: block;
    }

    .upload-progress {
        margin-top: 15px;
        display: none;
    }

    .upload-progress.show {
        display: block;
    }

    .btn-upload {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-upload:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .btn-upload:disabled {
        opacity: 0.6;
        transform: none;
        box-shadow: none;
    }
</style> 

<!-- JavaScript functions for Modal Requisitos -->
<script>
    /**
     * MODAL REQUISITOS FALTANTES - SISTEMA COMPLETO
     * ==============================================
     * 
     * Este archivo contiene toda la funcionalidad del modal de requisitos faltantes,
     * incluyendo validaci√≥n, carga de archivos y gesti√≥n de estados.
     * 
     * FUNCIONES PRINCIPALES:
     * - mostrarModalRequisitosFaltantes: Funci√≥n principal que muestra el modal
     * - llenarListaRequisitosFaltantes: Llena la lista de requisitos en el modal
     * - configurarEventListenersModal: Configura los eventos del modal
     * - verificarTodosRequisitosCompletos: Verifica si todos los requisitos est√°n completos
     * - subirArchivosSecuencialmente: Sube archivos uno por uno con progreso
     * - resetearEstadoModal: Resetea el estado del modal
     * - cerrarModalRequisitos: Cierra el modal de forma segura
     * - ejecutarCambioEtapa: Funci√≥n para cambiar etapa
     * - verificarFuncionesRequisitos: Verifica que todas las funciones est√©n disponibles
     * 
     * DEPENDENCIAS:
     * - Bootstrap 5 para modales
     * - Funci√≥n showToast para notificaciones (opcional)
     * - Token CSRF para peticiones AJAX
     */

    // Funci√≥n unificada para cerrar el modal de requisitos
    window.cerrarModalRequisitos = function () {
        console.log('üö™ Cerrando modal de requisitos');

        const modal = bootstrap.Modal.getInstance(document.getElementById('modalRequisitosFaltantes'));
        if (modal) {
            modal.hide();
        } else {
            // Si no hay instancia, intentar crear una nueva y ocultarla
            const modalElement = document.getElementById('modalRequisitosFaltantes');
            if (modalElement) {
                const newModal = new bootstrap.Modal(modalElement);
                newModal.hide();
            }
        }

        // Resetear estado despu√©s de cerrar
        setTimeout(() => {
            window.resetearEstadoModal();
        }, 300);
    }

    // Funci√≥n para mostrar modal de requisitos faltantes
    window.mostrarModalRequisitosFaltantes = function (solicitudId, nuevaEtapaId, nombreEtapa, callbackExito, callbackCancelacion) {
        console.log('üîç Mostrando modal de requisitos faltantes');
        console.log('üìã Par√°metros recibidos:', { solicitudId, nuevaEtapaId, nombreEtapa, callbackExito: typeof callbackExito, callbackCancelacion: typeof callbackCancelacion });

        // Guardar contexto global para uso en modal de agenda de firma
        window.currentSolicitudId = solicitudId;
        window.currentNuevaEtapaId = nuevaEtapaId;
        window.currentNombreEtapa = nombreEtapa;
        window.currentCallbackExito = callbackExito;
        window.currentCallbackCancelacion = callbackCancelacion;

        // Validar par√°metros con early return
        if (!solicitudId || !nuevaEtapaId || !nombreEtapa) {
            console.error('‚ùå Par√°metros inv√°lidos:', { solicitudId, nuevaEtapaId, nombreEtapa });
            const errorMessage = 'Error: Par√°metros inv√°lidos para mostrar modal de requisitos';

            if (typeof showToast !== 'undefined') {
                showToast(errorMessage, 'error', 6000);
            } else {
                alert(errorMessage);
            }
            return;
        }

        // Set current solicitud ID for file uploads
        window.currentSolicitudId = solicitudId;
        console.log('üîß currentSolicitudId establecido:', window.currentSolicitudId);

        // Resetear estado del modal
        window.resetearEstadoModal();

        // Mostrar loading en el modal
        const listaContainer = document.getElementById('listaRequisitosFaltantes');
        const loadingElement = document.getElementById('loadingRequisitos');

        if (listaContainer) listaContainer.innerHTML = '';
        if (loadingElement) loadingElement.style.display = 'block';

        // Actualizar t√≠tulo del modal (se actualizar√° con requisitos obligatorios despu√©s)
        const etapaDestinoElement = document.getElementById('etapaDestinoNombre');
        if (etapaDestinoElement) {
            etapaDestinoElement.textContent = nombreEtapa;
        }

        // Cargar requisitos faltantes
        fetch(`/workflow/api/solicitudes/${solicitudId}/requisitos-faltantes-detallado/?nueva_etapa_id=${nuevaEtapaId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üìã Requisitos faltantes recibidos:', data);

                // Ocultar loading
                if (loadingElement) loadingElement.style.display = 'none';

                if (data.success) {
                    // Actualizar t√≠tulo del modal con requisitos obligatorios faltantes
                    const etapaDestinoElement = document.getElementById('etapaDestinoNombre');
                    if (etapaDestinoElement) {
                        const obligatoriosFaltantes = data.total_obligatorios_faltantes || 0;
                        if (obligatoriosFaltantes > 0) {
                            etapaDestinoElement.textContent = `${nombreEtapa} (${obligatoriosFaltantes} requisito${obligatoriosFaltantes > 1 ? 's' : ''} obligatorio${obligatoriosFaltantes > 1 ? 's' : ''} faltante${obligatoriosFaltantes > 1 ? 's' : ''})`;
                        } else {
                            etapaDestinoElement.textContent = nombreEtapa;
                        }
                    }
                    
                    // Llenar la lista de requisitos faltantes
                    window.llenarListaRequisitosFaltantes(data.requisitos, data.total_requisitos, data.requisitos_completos, data);

                    // Configurar event listeners del modal
                    window.configurarEventListenersModal(solicitudId, nuevaEtapaId, callbackExito, callbackCancelacion);

                    // Mostrar modal
                    const modal = new bootstrap.Modal(document.getElementById('modalRequisitosFaltantes'));
                    modal.show();
                } else {
                    console.error('‚ùå Error al cargar requisitos faltantes:', data.error);
                    if (typeof showToast !== 'undefined') {
                        showToast('Error al cargar requisitos faltantes: ' + data.error, 'error', 6000);
                    } else {
                        alert('Error al cargar requisitos faltantes: ' + data.error);
                    }
                }
            })
            .catch(error => {
                console.error('‚ùå Error en petici√≥n de requisitos faltantes:', error);
                // Ocultar loading
                if (loadingElement) loadingElement.style.display = 'none';

                if (typeof showToast !== 'undefined') {
                    showToast('Error al cargar requisitos faltantes', 'error', 6000);
                } else {
                    alert('Error al cargar requisitos faltantes');
                }
            });
    }

    // Funci√≥n unificada para llenar la lista de requisitos en el modal
    window.llenarListaRequisitosFaltantes = function (requisitos, totalRequisitos, requisitosCompletos, data) {
        const listaContainer = document.getElementById('listaRequisitosFaltantes');
        const btnValidar = document.getElementById('btnValidarYContinuar');

        if (!listaContainer) {
            console.error('‚ùå No se encontr√≥ el contenedor de requisitos');
            return;
        }

        if (!btnValidar) {
            console.error('‚ùå No se encontr√≥ el bot√≥n de validar');
            return;
        }

        // Store the data globally for use by verification function
        window.currentRequisitosData = {
            requisitos: requisitos,
            requisitos_obligatorios: data.requisitos_obligatorios || [],
            requisitos_opcionales: data.requisitos_opcionales || [],
            total_requisitos: totalRequisitos,
            total_requisitos_obligatorios: data.total_requisitos_obligatorios || 0,
            total_requisitos_opcionales: data.total_requisitos_opcionales || 0,
            requisitos_completos: requisitosCompletos,
            requisitos_obligatorios_completos: data.requisitos_obligatorios_completos || 0,
            total_obligatorios_faltantes: data.total_obligatorios_faltantes || 0
        };

        // Limpiar contenedor
        listaContainer.innerHTML = '';

        // Check if all mandatory requirements are complete
        const allMandatoryComplete = data.total_obligatorios_faltantes === 0;

        // Update button based on mandatory requirements
        if (allMandatoryComplete) {
            btnValidar.innerHTML = `<i class="fas fa-check me-2"></i>Requisitos Obligatorios Completos - Continuar`;
            btnValidar.className = 'btn btn-success';
            btnValidar.disabled = false;
        } else {
            btnValidar.innerHTML = `<i class="fas fa-check me-2"></i>Validar y Continuar (${data.requisitos_obligatorios_completos}/${data.total_requisitos_obligatorios} obligatorios)`;
            btnValidar.className = 'btn btn-primary';
            btnValidar.disabled = true;
        }

        // Separar requisitos en obligatorios y opcionales
        const requisitosObligatorios = data.requisitos_obligatorios || [];
        const requisitosOpcionales = data.requisitos_opcionales || [];

        // Si hay requisitos obligatorios, mostrar secci√≥n
        if (requisitosObligatorios.length > 0) {
            const seccionObligatoriosHtml = `
                <div class="seccion-requisitos">
                    <div class="seccion-titulo obligatorio">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                <h6 class="mb-0 fw-bold">Requisitos Obligatorios</h6>
                            </div>
                            <span class="badge badge-obligatorio">${data.requisitos_obligatorios_completos}/${data.total_requisitos_obligatorios}</span>
                        </div>
                        <small class="text-muted d-block mt-1">Estos documentos son necesarios para continuar</small>
                    </div>
                    <div id="requisitos-obligatorios-lista"></div>
                </div>
            `;
            listaContainer.insertAdjacentHTML('beforeend', seccionObligatoriosHtml);
            
            // Agregar requisitos obligatorios
            const listaObligatorios = document.getElementById('requisitos-obligatorios-lista');
            requisitosObligatorios.forEach(requisito => {
                const requisitoHtml = buildRequisitoHtml(requisito, true);
                listaObligatorios.insertAdjacentHTML('beforeend', requisitoHtml);
            });
        }

        // Si hay requisitos opcionales, mostrar secci√≥n
        if (requisitosOpcionales.length > 0) {
            const requisitosOpcionalesCompletos = requisitosOpcionales.filter(req => req.esta_cumplido).length;
            const seccionOpcionalesHtml = `
                <div class="seccion-requisitos">
                    <div class="seccion-titulo opcional">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-plus-circle text-secondary me-2"></i>
                                <h6 class="mb-0 fw-bold">Requisitos Opcionales</h6>
                            </div>
                            <span class="badge badge-opcional">${requisitosOpcionalesCompletos}/${data.total_requisitos_opcionales}</span>
                        </div>
                        <small class="text-muted d-block mt-1">Documentos adicionales que pueden facilitar el proceso</small>
                    </div>
                    <div id="requisitos-opcionales-lista"></div>
                </div>
            `;
            listaContainer.insertAdjacentHTML('beforeend', seccionOpcionalesHtml);
            
            // Agregar requisitos opcionales
            const listaOpcionales = document.getElementById('requisitos-opcionales-lista');
            requisitosOpcionales.forEach(requisito => {
                const requisitoHtml = buildRequisitoHtml(requisito, false);
                listaOpcionales.insertAdjacentHTML('beforeend', requisitoHtml);
            });
        }

        // Si no hay requisitos de ning√∫n tipo
        if (requisitosObligatorios.length === 0 && requisitosOpcionales.length === 0) {
            listaContainer.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>No hay requisitos espec√≠ficos para esta transici√≥n</div>';
            btnValidar.innerHTML = `<i class="fas fa-check me-2"></i>Continuar`;
            btnValidar.className = 'btn btn-success';
            btnValidar.disabled = false;
            return;
        }

        // Configurar event listeners para los inputs de archivo
        window.configurarEventListenersArchivos();

        // Verificar estado inicial de requisitos
        window.verificarTodosRequisitosCompletos();
    }

    // Funci√≥n auxiliar para construir HTML de un requisito
    function buildRequisitoHtml(requisito, esObligatorio) {
        const isCompleto = requisito.esta_cumplido;
        const tituloClass = isCompleto ? 'text-success' : (esObligatorio ? 'text-danger' : 'text-secondary');
        const tituloIcon = isCompleto ? 'fa-check-circle' : (esObligatorio ? 'fa-exclamation-triangle' : 'fa-plus-circle');
        const badgeClass = isCompleto ? 'bg-success' : (esObligatorio ? 'bg-danger' : 'bg-secondary');
        const badgeText = isCompleto ? 'Completo' : (esObligatorio ? 'Faltante' : 'Opcional');
        const cardClass = isCompleto ? 'border-success' : (esObligatorio ? 'border-danger' : 'border-secondary');
        const cardExtraClass = esObligatorio ? '' : 'opcional';

        // L√≥gica especial para requisito de agenda de firma
        if (requisito.tipo_especial === 'agenda_firma') {
            return buildAgendaFirmaHtml(requisito, esObligatorio, isCompleto, tituloClass, tituloIcon, badgeClass, badgeText, cardClass, cardExtraClass);
        }

        return `
        <div class="card mb-3 requisito-card ${cardClass} ${cardExtraClass}" data-requisito-id="${requisito.id}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h6 class="card-title ${tituloClass} mb-1">
                            <i class="fas ${tituloIcon} me-2"></i>
                            ${requisito.nombre}
                            ${esObligatorio ? '' : '<span class="badge bg-secondary ms-2" style="font-size: 0.7rem;">Opcional</span>'}
                        </h6>
                        ${requisito.descripcion ? `<p class="text-muted small mb-2">${requisito.descripcion}</p>` : ''}
                        ${requisito.mensaje_personalizado ? `<p class="text-info small mb-2"><i class="fas fa-info-circle me-1"></i>${requisito.mensaje_personalizado}</p>` : ''}
                    </div>
                    <div class="text-end">
                        <span class="badge ${badgeClass}">${badgeText}</span>
                    </div>
                </div>
                
                ${requisito.archivo_actual ? `
                    <div class="alert alert-success mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-file-check me-2 mt-1 text-success"></i>
                            <div class="flex-grow-1">
                                <strong>Archivo subido:</strong> 
                                <a href="${requisito.archivo_actual.url}" target="_blank" class="text-decoration-none">
                                    ${requisito.archivo_actual.nombre}
                                </a>
                                ${!isCompleto ? `
                                    <div class="mt-2 d-flex gap-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="mostrarUploadParaReemplazo(${requisito.id})" aria-label="Reemplazar archivo">
                                            <i class="fas fa-upload me-1"></i>Reemplazar archivo
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" style="display:none;" id="cancelar-upload-btn-${requisito.id}" onclick="cancelarUploadParaReemplazo(${requisito.id})" aria-label="Cancelar reemplazo">
                                            <i class="fas fa-times me-1"></i>Cancelar
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${!isCompleto ? `
                    <div class="upload-section" style="${requisito.archivo_actual ? 'display: none;' : ''}" id="upload-section-${requisito.id}">
                        <div class="mb-3">
                            <label class="form-label">
                                ${requisito.archivo_actual ? 'Reemplazar archivo' : 'Subir archivo'} 
                                ${esObligatorio ? '<span class="text-danger">*</span>' : '<span class="text-secondary">(opcional)</span>'}
                            </label>
                            <input type="file" class="form-control requisito-file-input" 
                                   data-requisito-id="${requisito.id}" 
                                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif"
                                   aria-label="${requisito.archivo_actual ? 'Reemplazar archivo' : 'Subir archivo'}">
                            <small class="text-muted">El archivo se subir√° autom√°ticamente cuando hagas clic en 'Validar y Continuar'</small>
                        </div>
                    </div>
                ` : `
                    <div class="alert alert-light border-success">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span class="text-success fw-semibold">Requisito completado</span>
                        </div>
                    </div>
                `}
            </div>
        </div>
        `;
    }

    // Funci√≥n espec√≠fica para generar HTML del requisito de agenda de firma
    function buildAgendaFirmaHtml(requisito, esObligatorio, isCompleto, tituloClass, tituloIcon, badgeClass, badgeText, cardClass, cardExtraClass) {
        const agendaFirma = requisito.agenda_firma || {};
        
        return `
        <div class="card mb-3 requisito-card ${cardClass} ${cardExtraClass}" data-requisito-id="${requisito.id}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h6 class="card-title ${tituloClass} mb-1">
                            <i class="fas ${tituloIcon} me-2"></i>
                            ${requisito.nombre}
                            ${esObligatorio ? '' : '<span class="badge bg-secondary ms-2" style="font-size: 0.7rem;">Opcional</span>'}
                        </h6>
                        ${requisito.descripcion ? `<p class="text-muted small mb-2">${requisito.descripcion}</p>` : ''}
                        ${requisito.mensaje_personalizado ? `<p class="text-info small mb-2"><i class="fas fa-info-circle me-1"></i>${requisito.mensaje_personalizado}</p>` : ''}
                    </div>
                    <div class="text-end">
                        <span class="badge ${badgeClass}">${badgeText}</span>
                    </div>
                </div>
                
                ${isCompleto && agendaFirma.tiene_cita ? `
                    <div class="alert alert-success mb-3" style="border-radius: 12px; border: none; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(25, 135, 84, 0.15));">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-calendar-check me-3 mt-1 text-success" style="font-size: 1.5rem;"></i>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-2 text-success fw-bold">
                                    <i class="fas fa-check-circle me-2"></i>
                                    Firma Agendada
                                </h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <strong>Fecha:</strong><br>
                                        <span class="text-success">${agendaFirma.fecha_formateada || 'No especificada'}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Lugar:</strong><br>
                                        <span class="text-success">${agendaFirma.lugar_firma_display || 'No especificado'}</span>
                                    </div>
                                    ${agendaFirma.comentarios ? `
                                    <div class="col-12 mt-2">
                                        <strong>Comentarios:</strong><br>
                                        <span class="text-muted">${agendaFirma.comentarios}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="alert alert-warning mb-3" style="border-radius: 12px; border: none; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(253, 126, 20, 0.15));">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-calendar-plus me-3 mt-1 text-warning" style="font-size: 1.5rem;"></i>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-2 text-warning fw-bold">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Agenda de Firma Pendiente
                                </h6>
                                <p class="mb-3 text-muted">
                                    Es necesario agendar una cita de firma para continuar con el proceso.
                                </p>
                                <button type="button" class="btn btn-warning" onclick="abrirModalAgendaFirma(${requisito.id})">
                                    <i class="fas fa-calendar-plus me-2"></i>
                                    Agendar Firma
                                </button>
                            </div>
                        </div>
                    </div>
                `}
            </div>
        </div>
        `;
    }

    // Funci√≥n para mostrar upload para reemplazar archivo
    window.mostrarUploadParaReemplazo = function (requisitoId) {
        const uploadSection = document.getElementById(`upload-section-${requisitoId}`);
        const cancelarBtn = document.getElementById(`cancelar-upload-btn-${requisitoId}`);
        if (uploadSection) {
            uploadSection.style.display = 'block';
            if (cancelarBtn) cancelarBtn.style.display = 'inline-block';
            // Scroll to the upload section
            uploadSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Funci√≥n para cancelar upload para reemplazo
    window.cancelarUploadParaReemplazo = function (requisitoId) {
        const uploadSection = document.getElementById(`upload-section-${requisitoId}`);
        const cancelarBtn = document.getElementById(`cancelar-upload-btn-${requisitoId}`);
        if (uploadSection) uploadSection.style.display = 'none';
        if (cancelarBtn) cancelarBtn.style.display = 'none';
    }

    // Funci√≥n para configurar event listeners de archivos
    window.configurarEventListenersArchivos = function () {
        // Los archivos se subir√°n autom√°ticamente cuando se haga clic en "Validar y Continuar"
        console.log('Event listeners de archivos configurados - los archivos se subir√°n con "Validar y Continuar"');

        // Actualizar estado del bot√≥n cuando se selecciona un archivo
        document.querySelectorAll('.requisito-file-input').forEach(input => {
            input.addEventListener('change', function () {
                // Verificar estado de requisitos despu√©s de seleccionar archivo
                setTimeout(() => {
                    window.verificarTodosRequisitosCompletos();
                }, 100);
            });
        });
    }

    // Funci√≥n para resetear el estado del modal
    window.resetearEstadoModal = function () {
        console.log('üîÑ Reseteando estado del modal');

        // Resetear bot√≥n de validar
        const btnValidar = document.getElementById('btnValidarYContinuar');
        if (btnValidar) {
            btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Validar y Continuar';
            btnValidar.className = 'btn btn-primary';
            btnValidar.disabled = true;
        }

        // Limpiar contenedor de requisitos
        const listaContainer = document.getElementById('listaRequisitosFaltantes');
        if (listaContainer) {
            listaContainer.innerHTML = '';
        }

        // Ocultar loading
        const loadingElement = document.getElementById('loadingRequisitos');
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }

        // Limpiar variables globales
        window.currentSolicitudId = null;
        window.currentNuevaEtapaId = null;
    }

    // Funci√≥n unificada para subir archivos secuencialmente
    window.subirArchivosSecuencialmente = function (archivos, index, callback) {
        // Early return if all files processed
        if (index >= archivos.length) {
            console.log('‚úÖ Todos los archivos procesados');
            if (typeof callback === 'function') {
                callback(true); // Pass success flag
            }
            return;
        }

        // Update progress in loading overlay (removed to fix recursion error)
        console.log(`üì§ Procesando archivo ${index + 1} de ${archivos.length}`);

        const archivo = archivos[index];

        // Validate required data
        if (!archivo.requisitoId || !archivo.file) {
            console.error('‚ùå Datos de archivo inv√°lidos:', archivo);
            // Continue with next file
            window.subirArchivosSecuencialmente(archivos, index + 1, callback);
            return;
        }

        const formData = new FormData();
        formData.append('requisito_id', archivo.requisitoId);
        formData.append('archivo', archivo.file);

        const solicitudId = window.currentSolicitudId;

        if (!solicitudId) {
            console.error('‚ùå No se encontr√≥ solicitudId para subir archivo');
            // Continue with next file
            window.subirArchivosSecuencialmente(archivos, index + 1, callback);
            return;
        }

        console.log(`üì§ Subiendo archivo ${index + 1}/${archivos.length} para requisito ${archivo.requisitoId}`);

        const handleUploadError = (error, isNetworkError = false) => {
            console.error(`‚ùå Error al subir archivo para requisito ${archivo.requisitoId}:`, error);

            const mensaje = isNetworkError
                ? `Error de conexi√≥n al subir archivo: ${error}`
                : `Error al subir archivo: ${error}`;

            if (typeof showToast !== 'undefined') {
                showToast(mensaje, 'error', 5000);
            }

            // Continue with next file even on error
            window.subirArchivosSecuencialmente(archivos, index + 1, callback);
        };

        fetch(`/workflow/api/solicitudes/${solicitudId}/subir-requisito-modal/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log(`‚úÖ Archivo subido exitosamente para requisito ${archivo.requisitoId}`);

                    // Update UI for this requirement
                    const requisitoCard = document.querySelector(`.requisito-card[data-requisito-id="${archivo.requisitoId}"]`);
                    if (requisitoCard) {
                        const uploadSection = requisitoCard.querySelector('.upload-section');
                        const successSection = requisitoCard.querySelector('.success-section');

                        if (uploadSection) uploadSection.style.display = 'none';
                        if (successSection) successSection.style.display = 'block';

                        // Update badge with proper classes
                        const badge = requisitoCard.querySelector('.badge');
                        if (badge) {
                            badge.className = 'badge bg-success';
                            badge.textContent = 'Completo';
                        }
                    }

                    // UPDATE CRITICAL: Update the currentRequisitosData to reflect the completed requirement
                    if (window.currentRequisitosData) {
                        // Find and update the requirement in the obligatorios array
                        if (window.currentRequisitosData.requisitos_obligatorios) {
                            const requisito = window.currentRequisitosData.requisitos_obligatorios.find(req => req.id == archivo.requisitoId);
                            if (requisito) {
                                requisito.esta_cumplido = true;
                                console.log(`‚úÖ Updated requisito ${archivo.requisitoId} status to completed`);
                            }
                        }
                        
                        // Find and update the requirement in the opcionales array if not found in obligatorios
                        if (window.currentRequisitosData.requisitos_opcionales) {
                            const requisito = window.currentRequisitosData.requisitos_opcionales.find(req => req.id == archivo.requisitoId);
                            if (requisito) {
                                requisito.esta_cumplido = true;
                                console.log(`‚úÖ Updated optional requisito ${archivo.requisitoId} status to completed`);
                            }
                        }

                        // Recalculate counters
                        const obligatoriosCompletos = (window.currentRequisitosData.requisitos_obligatorios || [])
                            .filter(req => req.esta_cumplido).length;
                        const totalObligatorios = (window.currentRequisitosData.requisitos_obligatorios || []).length;
                        
                        window.currentRequisitosData.requisitos_obligatorios_completos = obligatoriosCompletos;
                        window.currentRequisitosData.total_obligatorios_faltantes = totalObligatorios - obligatoriosCompletos;
                        
                        console.log(`üìä Updated counters: ${obligatoriosCompletos}/${totalObligatorios} obligatorios completos`);
                    }

                    // Continue with next file
                    window.subirArchivosSecuencialmente(archivos, index + 1, callback);
                } else {
                    // Handle server-side error
                    handleUploadError(data.error || 'Error desconocido del servidor');
                }
            })
            .catch(error => {
                // Handle network or parsing errors
                handleUploadError(error.message, true);
            });
    };

    // Funci√≥n para subir requisito desde el modal (mantenida para compatibilidad)
    window.subirRequisitoModal = function (requisitoId) {
        const fileInput = document.querySelector(`.requisito-file-input[data-requisito-id="${requisitoId}"]`);
        const btnSubir = document.querySelector(`.btn-subir-requisito[data-requisito-id="${requisitoId}"]`);
        const requisitoCard = document.querySelector(`.requisito-card[data-requisito-id="${requisitoId}"]`);

        if (!fileInput.files.length) {
            alert('Por favor selecciona un archivo');
            return;
        }

        const formData = new FormData();
        formData.append('requisito_id', requisitoId);
        formData.append('archivo', fileInput.files[0]);

        // Mostrar estado de carga
        const originalText = btnSubir.innerHTML;
        btnSubir.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Subiendo...';
        btnSubir.disabled = true;

        // Obtener solicitud ID del modal (se puede pasar como par√°metro global)
        const solicitudId = window.currentSolicitudId;

        fetch(`/workflow/api/solicitudes/${solicitudId}/subir-requisito-modal/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Ocultar secci√≥n de upload y mostrar √©xito
                    const uploadSection = requisitoCard.querySelector('.upload-section');
                    const successSection = requisitoCard.querySelector('.success-section');

                    uploadSection.style.display = 'none';
                    successSection.style.display = 'block';

                    // Actualizar badge
                    const badge = requisitoCard.querySelector('.badge');
                    badge.className = 'badge bg-success';
                    badge.textContent = 'Completo';

                    // UPDATE CRITICAL: Update the currentRequisitosData to reflect the completed requirement
                    if (window.currentRequisitosData) {
                        // Find and update the requirement in the obligatorios array
                        if (window.currentRequisitosData.requisitos_obligatorios) {
                            const requisito = window.currentRequisitosData.requisitos_obligatorios.find(req => req.id == requisitoId);
                            if (requisito) {
                                requisito.esta_cumplido = true;
                                console.log(`‚úÖ Updated requisito ${requisitoId} status to completed`);
                            }
                        }
                        
                        // Find and update the requirement in the opcionales array if not found in obligatorios
                        if (window.currentRequisitosData.requisitos_opcionales) {
                            const requisito = window.currentRequisitosData.requisitos_opcionales.find(req => req.id == requisitoId);
                            if (requisito) {
                                requisito.esta_cumplido = true;
                                console.log(`‚úÖ Updated optional requisito ${requisitoId} status to completed`);
                            }
                        }

                        // Recalculate counters
                        const obligatoriosCompletos = (window.currentRequisitosData.requisitos_obligatorios || [])
                            .filter(req => req.esta_cumplido).length;
                        const totalObligatorios = (window.currentRequisitosData.requisitos_obligatorios || []).length;
                        
                        window.currentRequisitosData.requisitos_obligatorios_completos = obligatoriosCompletos;
                        window.currentRequisitosData.total_obligatorios_faltantes = totalObligatorios - obligatoriosCompletos;
                        
                        console.log(`üìä Updated counters: ${obligatoriosCompletos}/${totalObligatorios} obligatorios completos`);
                    }

                    // Mostrar mensaje de √©xito
                    if (typeof showToast !== 'undefined') {
                        showToast(data.mensaje, 'success', 4000);
                    }

                    // Verificar si todos los requisitos est√°n completos
                    window.verificarTodosRequisitosCompletos();

                } else {
                    alert('Error al subir requisito: ' + data.error);
                    btnSubir.innerHTML = originalText;
                    btnSubir.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al subir requisito');
                btnSubir.innerHTML = originalText;
                btnSubir.disabled = false;
            });
    }

    // Funci√≥n unificada para verificar si todos los requisitos est√°n completos
    window.verificarTodosRequisitosCompletos = function () {
        const btnValidar = document.getElementById('btnValidarYContinuar');

        if (!btnValidar) {
            console.error('‚ùå No se encontr√≥ el bot√≥n de validar');
            return false;
        }

        // Use the data from the last API call instead of counting DOM elements
        const requisitosData = window.currentRequisitosData;
        if (!requisitosData) {
            console.warn('‚ö†Ô∏è No hay datos de requisitos disponibles');
            return false;
        }

        // Focus on mandatory requirements only for validation
        const totalRequisitosObligatorios = requisitosData.total_requisitos_obligatorios || 0;
        const requisitosObligatoriosCompletos = requisitosData.requisitos_obligatorios_completos || 0;
        const totalObligatoriosFaltantes = requisitosData.total_obligatorios_faltantes || 0;

        // Count files selected for incomplete mandatory requirements
        let archivosSeleccionadosParaObligatoriosIncompletos = 0;
        const requisitosObligatoriosIncompletos = (requisitosData.requisitos_obligatorios || []).filter(req => !req.esta_cumplido);

        requisitosObligatoriosIncompletos.forEach(requisito => {
            const fileInput = document.querySelector(`.requisito-file-input[data-requisito-id="${requisito.id}"]`);
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                // Check if file input is visible (not hidden due to completion)
                const isVisible = fileInput.offsetParent !== null ||
                    getComputedStyle(fileInput).display !== 'none';
                if (isVisible) {
                    archivosSeleccionadosParaObligatoriosIncompletos++;
                }
            }
        });

        console.log('üîç Verificando requisitos obligatorios:', {
            totalRequisitosObligatorios,
            requisitosObligatoriosCompletos,
            totalObligatoriosFaltantes,
            archivosSeleccionadosParaObligatoriosIncompletos,
            requisitosObligatoriosIncompletos: requisitosObligatoriosIncompletos.length,
            requisitosDataComplete: window.currentRequisitosData
        });

        // Additional debug: Log current state of obligations
        console.log('üìã Estado actual de requisitos obligatorios:');
        (requisitosData.requisitos_obligatorios || []).forEach((req, index) => {
            console.log(`  ${index + 1}. ID: ${req.id}, Cumplido: ${req.esta_cumplido}, Nombre: ${req.nombre || 'Sin nombre'}`);
        });

        // Early return for no mandatory requirements
        if (totalRequisitosObligatorios === 0) {
            btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Continuar';
            btnValidar.className = 'btn btn-success';
            btnValidar.disabled = false;
            return true;
        }

        // All mandatory requirements completed
        if (totalObligatoriosFaltantes === 0) {
            btnValidar.innerHTML = '<i class="fas fa-check me-2"></i>Requisitos Obligatorios Completos - Continuar';
            btnValidar.className = 'btn btn-success';
            btnValidar.disabled = false;
            return true;
        }

        // Files selected for incomplete mandatory requirements
        if (archivosSeleccionadosParaObligatoriosIncompletos > 0) {
            btnValidar.innerHTML = `<i class="fas fa-upload me-2"></i>Validar y Continuar (${requisitosObligatoriosCompletos}/${totalRequisitosObligatorios} obligatorios)`;
            btnValidar.className = 'btn btn-primary';
            btnValidar.disabled = false;
            return false; // Not all complete, but can proceed with upload
        }

        // No files selected and mandatory requirements missing
        btnValidar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Completar Requisitos Obligatorios (${requisitosObligatoriosCompletos}/${totalRequisitosObligatorios})`;
        btnValidar.className = 'btn btn-warning';
        btnValidar.disabled = true;
        return false;
    };

    // Funci√≥n unificada para configurar event listeners del modal
    window.configurarEventListenersModal = function (solicitudId, nuevaEtapaId, callbackExito, callbackCancelacion) {
        console.log('üîß Configurando event listeners del modal:', { solicitudId, nuevaEtapaId });

        // Guardar para uso global
        window.currentSolicitudId = solicitudId;
        window.currentNuevaEtapaId = nuevaEtapaId;

        // Bot√≥n de validar y continuar
        const btnValidar = document.getElementById('btnValidarYContinuar');
        if (!btnValidar) {
            console.error('‚ùå No se encontr√≥ el bot√≥n de validar');
            return;
        }

        btnValidar.onclick = function () {
            console.log('üîÑ Bot√≥n validar clickeado');

            // Early return if button is disabled
            if (btnValidar.disabled) {
                console.log('‚ö†Ô∏è Bot√≥n deshabilitado, ignorando click');
                return;
            }

            // Disable button immediately to prevent double clicks
            btnValidar.disabled = true;
            const originalHTML = btnValidar.innerHTML;

            // Get current requirements state
            const totalRequisitos = document.querySelectorAll('.requisito-card').length;
            const requisitosCompletos = document.querySelectorAll('.requisito-card .badge.bg-success').length;

            // Get files that need to be uploaded
            const requisitosConArchivos = document.querySelectorAll('.requisito-card .requisito-file-input');
            const archivosParaSubir = [];

            requisitosConArchivos.forEach(input => {
                if (input.files && input.files.length > 0) {
                    const requisitoCard = input.closest('.requisito-card');
                    const badge = requisitoCard?.querySelector('.badge');

                    // Only upload if not already completed
                    if (badge && !badge.classList.contains('bg-success')) {
                        archivosParaSubir.push({
                            requisitoId: input.dataset.requisitoId,
                            file: input.files[0]
                        });
                    }
                }
            });

            console.log('üìÅ Archivos para subir:', archivosParaSubir.length);
            console.log('üîç Verificando requisitos:', {
                totalRequisitos,
                requisitosCompletos,
                archivosSeleccionados: archivosParaSubir.length
            });

            // Function to handle success completion
            const handleSuccessCompletion = () => {
                console.log('‚úÖ Todos los requisitos completos, procediendo con transici√≥n');
                
                // Show success animation on the modal content
                const modalContent = document.querySelector('#modalRequisitosFaltantes .modal-content');
                if (modalContent) {
                    modalContent.style.transform = 'scale(1.02)';
                    modalContent.style.boxShadow = '0 0 30px rgba(40, 167, 69, 0.3)';
                    modalContent.style.transition = 'all 0.3s ease';
                    
                    setTimeout(() => {
                        modalContent.style.transform = '';
                        modalContent.style.boxShadow = '';
                    }, 300);
                }

                // Show success notification for requirements (if available)
                if (typeof window.showStageChangeNotification === 'function') {
                    window.showStageChangeNotification('Requisitos completados exitosamente', 'success');
                }
                
                // Close modal with delay for animation
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalRequisitosFaltantes'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Execute callback with slight delay for smooth transition
                    setTimeout(() => {
                        if (callbackExito) {
                            callbackExito();
                        }
                    }, 300);
                }, 800);
            };

            // Function to handle error/incomplete state
            const handleIncompleteState = (currentCompleted, currentTotal) => {
                // Only count mandatory requirements for validation
                const requisitosData = window.currentRequisitosData;
                const totalObligatorios = requisitosData ? (requisitosData.total_requisitos_obligatorios || 0) : 0;
                const completedObligatorios = requisitosData ? (requisitosData.requisitos_obligatorios_completos || 0) : 0;
                const pendingObligatorios = totalObligatorios - completedObligatorios;
                
                const mensaje = pendingObligatorios > 0 ? 
                    `A√∫n faltan ${pendingObligatorios} requisitos obligatorios por completar` :
                    `A√∫n faltan ${currentTotal - currentCompleted} requisitos por completar`;
                
                console.log("HandleIncompleteState - Obligatorios:", {
                    totalObligatorios, 
                    completedObligatorios, 
                    pendingObligatorios,
                    currentTotal, 
                    currentCompleted
                });

                btnValidar.innerHTML = totalObligatorios > 0 ? 
                    `<i class="fas fa-exclamation-triangle me-2"></i>Completar Requisitos Obligatorios (${completedObligatorios}/${totalObligatorios})` :
                    `<i class="fas fa-exclamation-triangle me-2"></i>Validar y Continuar (${currentCompleted}/${currentTotal})`;
                btnValidar.className = 'btn btn-warning';
                btnValidar.disabled = true;

                if (typeof showToast !== 'undefined') {
                    showToast(mensaje, 'warning', 6000);
                } else {
                    alert(mensaje);
                }
            };

            // If there are files to upload, handle them first
            if (archivosParaSubir.length > 0) {
                btnValidar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Subiendo archivos...';

                // Show loading overlay with progress (removed to fix recursion error)
                console.log(`üì§ Iniciando carga de ${archivosParaSubir.length} archivos`);

                // Upload files sequentially with proper error handling
                window.subirArchivosSecuencialmente(archivosParaSubir, 0, function (uploadSuccess = true) {
                    // Hide loading overlay (removed to fix recursion error)
                    console.log('üì§ Finalizando carga de archivos');

                    // Verify final state after uploads
                    window.verificarTodosRequisitosCompletos();

                    // Count only mandatory requirements for final validation
                    const requisitosData = window.currentRequisitosData;
                    const totalObligatorios = requisitosData ? (requisitosData.total_requisitos_obligatorios || 0) : 0;
                    const obligatoriosFaltantes = requisitosData ? (requisitosData.total_obligatorios_faltantes || 0) : 0;
                    
                    // Alternative counting from DOM as fallback
                    const finalTotalRequisitos = document.querySelectorAll('.requisito-card').length;
                    const finalRequisitosCompletos = document.querySelectorAll('.requisito-card .badge.bg-success').length;

                    // Use mandatory requirements logic if available, otherwise use all requirements
                    if (totalObligatorios > 0) {
                        if (obligatoriosFaltantes === 0 && uploadSuccess) {
                            handleSuccessCompletion();
                        } else {
                            const completedObligatorios = totalObligatorios - obligatoriosFaltantes;
                            handleIncompleteState(completedObligatorios, totalObligatorios);
                        }
                    } else {
                        if (finalTotalRequisitos === finalRequisitosCompletos && uploadSuccess) {
                            handleSuccessCompletion();
                        } else {
                            handleIncompleteState(finalRequisitosCompletos, finalTotalRequisitos);
                        }
                    }
                });
            } else if (totalRequisitos === requisitosCompletos) {
                // All requirements already completed, proceed immediately
                handleSuccessCompletion();
            } else {
                // Requirements still missing - use mandatory requirements logic
                const requisitosData = window.currentRequisitosData;
                const totalObligatorios = requisitosData ? (requisitosData.total_requisitos_obligatorios || 0) : 0;
                const obligatoriosFaltantes = requisitosData ? (requisitosData.total_obligatorios_faltantes || 0) : 0;
                
                if (totalObligatorios > 0) {
                    const completedObligatorios = totalObligatorios - obligatoriosFaltantes;
                    handleIncompleteState(completedObligatorios, totalObligatorios);
                } else {
                    handleIncompleteState(requisitosCompletos, totalRequisitos);
                }
            }
        };

        // Configurar evento de cierre del modal
        const modal = document.getElementById('modalRequisitosFaltantes');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function () {
                console.log('üö™ Modal cerrado');
                if (callbackCancelacion) {
                    callbackCancelacion();
                }
            });
        }
    }

    // Funci√≥n para ejecutar el cambio de etapa (tabla √∫nicamente)
    window.ejecutarCambioEtapa = function (solicitudId, nuevaEtapaId, etapaActual, selectElement, subestadoSeleccionado = null) {
        console.log('üîÑ Ejecutando cambio de etapa:', { solicitudId, nuevaEtapaId, etapaActual, subestadoSeleccionado });

        // Deshabilitar select mientras se procesa
        if (selectElement) {
            selectElement.disabled = true;
        }

        // Preparar datos de la petici√≥n
        const requestData = {
            etapa_id: nuevaEtapaId
        };

        // Agregar subestado si se seleccion√≥ uno
        if (subestadoSeleccionado) {
            requestData.subestado_id = subestadoSeleccionado;
            console.log('üîç Incluyendo subestado en la petici√≥n:', subestadoSeleccionado);
        }

        // Realizar petici√≥n AJAX
        fetch(`/workflow/api/solicitudes/${solicitudId}/cambiar-etapa/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())
            .then(data => {
                console.log('Respuesta del servidor:', data);
                if (data.success) {
                    // Actualizar data attribute (solo para tabla)
                    if (selectElement) {
                        selectElement.setAttribute('data-etapa-actual', nuevaEtapaId);
                    }

                    // Mostrar mensaje de √©xito
                    if (typeof showToast !== 'undefined') {
                        showToast(data.mensaje || 'Etapa cambiada exitosamente', 'success', 4000);
                    } else {
                        alert(data.mensaje || 'Etapa cambiada exitosamente');
                    }

                    // Recargar p√°gina para actualizar la vista
                    setTimeout(function () {
                        location.reload();
                    }, 1000);
                } else {
                    // Manejar errores espec√≠ficos
                    if (data.tipo_error === 'transicion_invalida') {
                        if (typeof showToast !== 'undefined') {
                            showToast('Transici√≥n no v√°lida: ' + data.mensaje, 'error', 6000);
                        } else {
                            alert('Transici√≥n no v√°lida: ' + data.mensaje);
                        }
                    } else if (data.tipo_error === 'requisitos_faltantes') {
                        if (typeof showToast !== 'undefined') {
                            showToast('Requisitos faltantes: ' + data.mensaje, 'warning', 6000);
                        } else {
                            alert('Requisitos faltantes: ' + data.mensaje);
                        }
                    } else {
                        if (typeof showToast !== 'undefined') {
                            showToast('Error: ' + data.error, 'error', 6000);
                        } else {
                            alert('Error: ' + data.error);
                        }
                    }

                    // Revertir selecci√≥n
                    if (selectElement) {
                        selectElement.value = etapaActual;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof showToast !== 'undefined') {
                    showToast('Error al cambiar etapa', 'error', 6000);
                } else {
                    alert('Error al cambiar etapa');
                }

                // Revertir selecci√≥n
                if (selectElement) {
                    selectElement.value = etapaActual;
                }
            })
            .finally(() => {
                // Habilitar select
                if (selectElement) {
                    selectElement.disabled = false;
                }
            });
    }

    // Funci√≥n para verificar que todas las funciones necesarias est√©n disponibles
    window.verificarFuncionesRequisitos = function () {
        const funcionesNecesarias = [
            'mostrarModalRequisitosFaltantes',
            'llenarListaRequisitosFaltantes',
            'configurarEventListenersModal',
            'verificarTodosRequisitosCompletos',
            'subirArchivosSecuencialmente',
            'resetearEstadoModal',
            'cerrarModalRequisitos',
            'ejecutarCambioEtapa'
        ];

        const funcionesFaltantes = funcionesNecesarias.filter(func => typeof window[func] !== 'function');

        if (funcionesFaltantes.length > 0) {
            console.error('‚ùå Funciones faltantes:', funcionesFaltantes);
            return false;
        }

        console.log('‚úÖ Todas las funciones de requisitos est√°n disponibles');
        return true;
    }

    // Funci√≥n de prueba para verificar el sistema completo
    window.probarSistemaRequisitos = function () {
        console.log('üß™ Probando sistema de requisitos faltantes...');

        // Verificar funciones
        const funcionesOk = window.verificarFuncionesRequisitos();
        if (!funcionesOk) {
            console.error('‚ùå Fall√≥ la verificaci√≥n de funciones');
            return false;
        }

        // Verificar modal
        const modalElement = document.getElementById('modalRequisitosFaltantes');
        if (!modalElement) {
            console.error('‚ùå Modal no encontrado');
            return false;
        }

        // Verificar elementos del modal
        const elementosNecesarios = [
            'listaRequisitosFaltantes',
            'btnValidarYContinuar',
            'etapaDestinoNombre',
            'loadingRequisitos'
        ];

        const elementosFaltantes = elementosNecesarios.filter(id => !document.getElementById(id));
        if (elementosFaltantes.length > 0) {
            console.error('‚ùå Elementos del modal faltantes:', elementosFaltantes);
            return false;
        }

        console.log('‚úÖ Sistema de requisitos funcionando correctamente');
        console.log('üí° Para probar el modal, usa: window.mostrarModalRequisitosFaltantes(solicitudId, etapaId, "Nombre Etapa", callback)');
        return true;
    }

    // Funci√≥n para abrir modal de agenda de firma
    window.abrirModalAgendaFirma = async function(requisitoId) {
        try {
            console.log('üìÖ Abriendo modal para agendar firma, requisito ID:', requisitoId);
            
            // Obtener informaci√≥n de la solicitud actual desde el contexto global
            const solicitudId = window.currentSolicitudId || document.querySelector('[data-solicitud-id]')?.getAttribute('data-solicitud-id');
            if (!solicitudId) {
                console.error('‚ùå No se encontr√≥ ID de solicitud');
                if (typeof showToast !== 'undefined') {
                    showToast('Error: No se pudo identificar la solicitud', 'error');
                } else {
                    alert('Error: No se pudo identificar la solicitud');
                }
                return;
            }

            // Abrir la vista de agenda de firma en una nueva ventana/pesta√±a
            const agendaUrl = `/workflow/agenda-firma/?solicitud_id=${solicitudId}&requisito_id=${requisitoId}&from_modal=1`;
            window.open(agendaUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
        } catch (error) {
            console.error('‚ùå Error al abrir modal de agenda de firma:', error);
            if (typeof showToast !== 'undefined') {
                showToast('Error al abrir agenda de firma', 'error');
            } else {
                alert('Error al abrir agenda de firma');
            }
        }
    }

    // Initialize system on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        // Verify system functionality on load
        if (window.verificarFuncionesRequisitos) {
            window.verificarFuncionesRequisitos();
        }
        
        console.log('‚úÖ Modal de requisitos inicializado correctamente');
    });
</script>