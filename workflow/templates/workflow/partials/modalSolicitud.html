<!-- Modal Mejorado para Detalles de Solicitud -->
<div class="modal fade" id="modalSolicitud" tabindex="-1" aria-labelledby="modalSolicitudLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header align-items-center" style="background: linear-gradient(135deg, #009c3c 0%, #22a650 100%); color: white; border-bottom: none;">
                <div class="d-flex flex-column flex-md-row align-items-md-center w-100">
                    <div class="me-3">
                        <span class="h4 fw-bold mb-0" id="modalSolicitudCodigo">SOL-000000</span>
                        <span class="badge rounded-pill ms-2" id="modalSolicitudEstadoBadge" style="background:#ffeeba; color:#856404; font-size:1rem;">Pendiente</span>
                    </div>
                    <div class="text-muted ms-md-4 mt-2 mt-md-0" id="modalSolicitudTipo">Solicitud de préstamo personal</div>
                </div>
                <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="modalSolicitudBody">
                <div class="row mb-3">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card shadow-sm border-0">
                            <div class="card-body p-3">
                                <div class="mb-2 text-muted small">Información General</div>
                                <div class="d-flex justify-content-between mb-1">
                                    <div><i class="far fa-calendar-alt me-1"></i> <span id="modalSolicitudFechaInicio">-</span></div>
                                    <div><i class="far fa-calendar-check me-1"></i> <span id="modalSolicitudVencimiento">-</span></div>
                                </div>
                                <div class="mb-1"><span class="fw-semibold">Etapa Actual:</span> <span id="modalSolicitudEtapaActual">-</span></div>
                                <div class="mb-1"><span class="fw-semibold">Área Responsable:</span> <span id="modalSolicitudArea">-</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card shadow-sm border-0">
                            <div class="card-body p-3">
                                <div class="mb-2 text-muted small">Cliente</div>
                                <div class="fw-semibold" id="modalSolicitudCliente">-</div>
                                <div class="small text-muted">Cédula: <span id="modalSolicitudCedula">-</span></div>
                                <div class="small text-muted">Canal de Origen: <span id="modalSolicitudCanal">-</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0">
                            <div class="card-body p-3">
                                <div class="mb-2 text-muted small">Acciones</div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" id="modalBtnProcesarTarea"><i class="fas fa-check me-1"></i>Procesar Tarea</button>
                                    <button class="btn btn-outline-secondary" id="modalBtnDevolver"><i class="fas fa-undo me-1"></i>Devolver</button>
                                    <button class="btn btn-outline-danger" id="modalBtnAnular"><i class="fas fa-times me-1"></i>Anular</button>
                                    <button class="btn btn-outline-primary" id="modalBtnComentarios"><i class="fas fa-comments me-1"></i>Ver Comentarios</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Workflow Progress Bar -->
                <div class="mb-4">
                    <div class="fw-bold mb-2">Ruta del Flujo de Trabajo</div>
                    <div id="modalSolicitudWorkflowProgress">
                        <!-- Workflow progress bar will be rendered here by JS -->
                    </div>
                </div>
                <!-- Tabs for Workflow, History, Comments -->
                <ul class="nav nav-tabs mb-3" id="modalSolicitudTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-flujo" data-bs-toggle="tab" data-bs-target="#tabFlujo" type="button" role="tab">Ruta del Flujo</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-historial" data-bs-toggle="tab" data-bs-target="#tabHistorial" type="button" role="tab">Historial</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-comentarios" data-bs-toggle="tab" data-bs-target="#tabComentarios" type="button" role="tab">Comentarios</button>
                    </li>
                </ul>
                <div class="tab-content" id="modalSolicitudTabContent">
                    <div class="tab-pane fade show active" id="tabFlujo" role="tabpanel">
                        <div id="modalSolicitudWorkflowDetail">
                            <!-- Workflow detail will be rendered here by JS -->
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tabHistorial" role="tabpanel">
                        <div id="modalSolicitudHistorial">
                            <!-- Historial will be rendered here by JS -->
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tabComentarios" role="tabpanel">
                        <div id="modalSolicitudComentarios">
                            <!-- Comentarios will be rendered here by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
/* --- MODAL BRIEFING STYLES --- */
#modalSolicitud .modal-header {
    background: linear-gradient(135deg, #009c3c 0%, #22a650 100%);
    color: #fff;
    border-bottom: none;
}
#modalSolicitud .badge {
    font-size: 1rem;
    border-radius: 0.5rem;
    padding: 0.4em 1em;
}
#modalSolicitud .card {
    border-radius: 1rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    border: none;
}
#modalSolicitud .nav-tabs .nav-link.active {
    background: #009c3c;
    color: #fff;
    border-radius: 0.5rem 0.5rem 0 0;
    border: none;
}
#modalSolicitud .nav-tabs .nav-link {
    color: #009c3c;
    border: none;
}

/* --- WORKFLOW ROADMAP --- */
.workflow-roadmap {
    display: flex;
    align-items: flex-end;
    overflow-x: auto;
    padding: 1rem 0.5rem 0.5rem 0.5rem;
    gap: 0.5rem;
}
.workflow-step {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 120px;
    flex: 0 0 120px;
    z-index: 1;
}
.workflow-step .circle {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: #e9ecef;
    border: 3px solid #b0b8c1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    color: #b0b8c1;
    margin-bottom: 0.3rem;
    transition: border 0.3s, box-shadow 0.3s;
}
.workflow-step.completed .circle {
    background: #198754;
    border-color: #198754;
    color: #fff;
}
.workflow-step.current .circle {
    background: #fffbe6;
    border-color: #ffc107;
    color: #ffc107;
    box-shadow: 0 0 0 4px #ffe066, 0 0 12px 2px #ffc107;
    animation: glow 1.5s infinite alternate;
}
@keyframes glow {
    0% { box-shadow: 0 0 0 4px #ffe066, 0 0 12px 2px #ffc107; }
    100% { box-shadow: 0 0 0 8px #ffe066, 0 0 24px 4px #ffc107; }
}
.workflow-step.pending .circle {
    background: #f8f9fa;
    border-color: #b0b8c1;
    color: #b0b8c1;
}
.workflow-step .step-label {
    font-weight: 600;
    color: #333;
    font-size: 0.98rem;
    margin-bottom: 0.1rem;
    text-align: center;
}
.workflow-step .sla-label {
    font-size: 0.85rem;
    color: #009c3c;
    font-weight: 500;
    margin-bottom: 0.2rem;
}
.workflow-connector {
    flex: 0 0 32px;
    height: 4px;
    background: linear-gradient(90deg, #b0b8c1 60%, #e9ecef 100%);
    margin-bottom: 1.2rem;
    border-radius: 2px;
    z-index: 0;
}
@media (max-width: 600px) {
    .workflow-step { min-width: 90px; }
    .workflow-connector { flex-basis: 18px; }
}
</style>
<script>
window.mostrarModalSolicitud = function(solicitudId) {
    // Limpia el modal
    $('#modalSolicitudCodigo').text('Cargando...');
    $('#modalSolicitudEstadoBadge').text('');
    $('#modalSolicitudTipo').text('');
    $('#modalSolicitudFechaInicio').text('-');
    $('#modalSolicitudVencimiento').text('-');
    $('#modalSolicitudEtapaActual').text('-');
    $('#modalSolicitudArea').text('-');
    $('#modalSolicitudCliente').text('-');
    $('#modalSolicitudCedula').text('-');
    $('#modalSolicitudCanal').text('-');
    // Acciones
    $('#modalBtnProcesarTarea').prop('disabled', true);
    $('#modalBtnDevolver').prop('disabled', true);
    $('#modalBtnAnular').prop('disabled', true);
    $('#modalBtnComentarios').prop('disabled', true);
    // Workflow, historial, comentarios
    $('#modalSolicitudWorkflowProgress').html('<div class="text-center text-muted py-2">Cargando...</div>');
    $('#modalSolicitudWorkflowDetail').html('');
    $('#modalSolicitudHistorial').html('');
    $('#modalSolicitudComentarios').html('');

    // Fetch API
    $.get(`/workflow/api/solicitud_brief/${solicitudId}/`, function(data) {
        // General
        $('#modalSolicitudCodigo').text(data.general.codigo || '-');
        $('#modalSolicitudEstadoBadge').text(data.general.estado || '-');
        $('#modalSolicitudTipo').text(data.general.tipo || '-');
        $('#modalSolicitudFechaInicio').text(data.general.fecha_inicio || '-');
        $('#modalSolicitudVencimiento').text(data.general.vencimiento || '-');
        $('#modalSolicitudEtapaActual').text(data.general.etapa_actual || '-');
        $('#modalSolicitudArea').text(data.general.area || '-');
        // Cliente
        $('#modalSolicitudCliente').text(data.cliente.nombre || '-');
        $('#modalSolicitudCedula').text(data.cliente.cedula || '-');
        $('#modalSolicitudCanal').text(data.cliente.canal || '-');
        // Acciones
        $('#modalBtnProcesarTarea').prop('disabled', !data.acciones.puede_procesar);
        $('#modalBtnDevolver').prop('disabled', !data.acciones.puede_devolver);
        $('#modalBtnAnular').prop('disabled', !data.acciones.puede_anular);
        $('#modalBtnComentarios').prop('disabled', !data.acciones.puede_comentar);
        // --- WORKFLOW ROADMAP ---
        let etapas = data.workflow;
        let roadmapHtml = '<div class="workflow-roadmap">';
        etapas.forEach(function(etapa, idx) {
            let stepClass = etapa.actual ? 'workflow-step current' : (etapa.completada ? 'workflow-step completed' : 'workflow-step pending');
            let icon = etapa.completada ? '<i class="fas fa-check"></i>' : (etapa.actual ? '<i class="fas fa-bolt"></i>' : (idx+1));
            let sla = etapa.sla ? `<div class='sla-label'>SLA: ${etapa.sla}</div>` : '';
            roadmapHtml += `<div class="${stepClass}">
                <div class="circle">${icon}</div>
                <div class="step-label">${etapa.nombre}</div>
                ${sla}
            </div>`;
            if (idx < etapas.length - 1) {
                roadmapHtml += '<div class="workflow-connector"></div>';
            }
        });
        roadmapHtml += '</div>';
        $('#modalSolicitudWorkflowProgress').html(roadmapHtml);
        // Workflow detail (tab)
        let detailHtml = '<ul class="list-group">';
        etapas.forEach(function(etapa) {
            detailHtml += `<li class="list-group-item d-flex justify-content-between align-items-center ${etapa.actual ? 'active' : ''}">
                <span>${etapa.nombre}</span>
                <span class="badge bg-${etapa.completada ? 'success' : (etapa.actual ? 'warning text-dark' : 'secondary')}">${etapa.completada ? 'Completada' : (etapa.actual ? 'Actual' : 'Pendiente')}</span>
            </li>`;
        });
        detailHtml += '</ul>';
        $('#modalSolicitudWorkflowDetail').html(detailHtml);
        // Historial
        let histHtml = '<ul class="list-group">';
        data.historial.forEach(function(h) {
            histHtml += `<li class="list-group-item">
                <div><b>Etapa:</b> ${h.etapa} <span class="text-muted small">(${h.subestado})</span></div>
                <div><b>Usuario:</b> ${h.usuario}</div>
                <div><b>Inicio:</b> ${h.fecha_inicio} ${h.fecha_fin ? '<b>Fin:</b> ' + h.fecha_fin : ''}</div>
            </li>`;
        });
        histHtml += '</ul>';
        $('#modalSolicitudHistorial').html(histHtml);
        // Comentarios
        let comHtml = '';
        if (data.comentarios.length === 0) {
            comHtml = '<div class="text-muted">Sin comentarios.</div>';
        } else {
            data.comentarios.forEach(function(c) {
                comHtml += `<div class="border rounded p-2 mb-2"><b>${c.usuario}</b> <span class="text-muted small">${c.fecha}</span><br>${c.texto}</div>`;
            });
        }
        $('#modalSolicitudComentarios').html(comHtml);
    });
    // Mostrar modal
    var modal = new bootstrap.Modal(document.getElementById('modalSolicitud'));
    modal.show();
};
</script> 