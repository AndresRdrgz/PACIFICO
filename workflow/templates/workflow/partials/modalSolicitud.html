<!-- Modal Overhauled para Detalles de Solicitud -->
<div class="modal fade" id="modalSolicitud" tabindex="-1" aria-labelledby="modalSolicitudLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
        <div class="modal-content modern-modal">
            <div class="modal-header-modern">
                <div class="header-content">
                    <div class="solicitud-header">
                        <div class="solicitud-code-badge">
                            <span class="code-text" id="modalSolicitudCodigo">SOL-000000</span>
                            <span class="status-badge" id="modalSolicitudEstadoBadge">Pendiente</span>
                        </div>
                        <div class="solicitud-type" id="modalSolicitudTipo">Solicitud de préstamo personal</div>
                    </div>
                    <div class="header-actions">
                        <div class="actions-buttons">
                            <button class="action-btn-header info" id="modalBtnVerDetalle" data-solicitud-id=""
                                title="Ver Detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <button type="button" class="btn-close-modern" data-bs-dismiss="modal" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-body-modern" id="modalSolicitudBody">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs modal-tabs" id="modalSolicitudTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="informacion-tab" data-bs-toggle="tab"
                            data-bs-target="#informacion" type="button" role="tab" aria-controls="informacion"
                            aria-selected="true">
                            <i class="fas fa-info-circle me-2"></i>Información
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="documentos-tab" data-bs-toggle="tab" data-bs-target="#documentos"
                            type="button" role="tab" aria-controls="documentos" aria-selected="false">
                            <i class="fas fa-file-alt me-2"></i>Documentos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial"
                            type="button" role="tab" aria-controls="historial" aria-selected="false">
                            <i class="fas fa-history me-2"></i>Historial
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="diligencia-tab" data-bs-toggle="tab" data-bs-target="#diligencia"
                            type="button" role="tab" aria-controls="diligencia" aria-selected="false">
                            <i class="fas fa-shield-check me-2"></i>Debida Diligencia
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content modal-tab-content" id="modalSolicitudTabContent">
                    <!-- Información Tab -->
                    <div class="tab-pane fade show active" id="informacion" role="tabpanel"
                        aria-labelledby="informacion-tab">
                        <!-- Main Content Area -->
                        <div class="modal-main-content">
                            <!-- Workflow Progress Section -->
                            <div class="workflow-section">
                                <div class="section-title">
                                    <i class="fas fa-route me-2"></i>
                                    Ruta del Flujo de Trabajo
                                </div>
                                <div class="workflow-container" id="modalSolicitudWorkflowProgress">
                                    <!-- Workflow progress will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Info Cards Section -->
                        <div class="info-cards-section">
                            <!-- Unified Summary Card -->
                            <div class="summary-card-modern" id="modalSolicitudSummaryCard"
                                style="transition: 0.3s; opacity: 1; transform: translateY(0px);">
                                <!-- Content will be populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Documentos Tab -->
                    <div class="tab-pane fade" id="documentos" role="tabpanel" aria-labelledby="documentos-tab">
                        <div class="documentos-section">
                            <div class="section-title">
                                <i class="fas fa-folder-open me-2"></i>
                                Requisitos y Documentos
                            </div>
                            <div class="documentos-container" id="modalSolicitudDocumentos">
                                <!-- Documentos content will be rendered here -->
                                <div class="loading-placeholder" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando documentos...</span>
                                    </div>
                                </div>
                                <div class="empty-state" style="display: none;">
                                    <i class="fas fa-file-alt mb-3"></i>
                                    <p>No hay documentos disponibles</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Historial Tab -->
                    <div class="tab-pane fade" id="historial" role="tabpanel" aria-labelledby="historial-tab">
                        <div class="historial-section">
                            <div class="section-title">
                                <i class="fas fa-history me-2"></i>
                                Timeline de Eventos
                            </div>
                            <div class="historial-container" id="modalSolicitudHistorial">
                                <!-- Historial content will be rendered here -->
                                <div class="loading-placeholder" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando historial...</span>
                                    </div>
                                </div>
                                <div class="empty-state" style="display: none;">
                                    <i class="fas fa-history mb-3"></i>
                                    <p>No hay eventos en el historial</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Debida Diligencia Tab -->
                    <div class="tab-pane fade" id="diligencia" role="tabpanel" aria-labelledby="diligencia-tab">
                        <div class="diligencia-section">
                            <div class="section-title">
                                <i class="fas fa-shield-check me-2"></i>
                                Debida Diligencia
                            </div>
                            <div class="diligencia-container" id="modalSolicitudDiligencia">
                                <!-- Content will be loaded dynamically -->
                                <div class="loading-placeholder" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando información de debida diligencia...</span>
                                    </div>
                                </div>
                                <div id="diligencia-content">
                                    <!-- Default content when no data is loaded yet -->
                                    <div class="empty-state">
                                        <i class="fas fa-shield-alt mb-3 text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted">Cargue la información de debida diligencia para mostrar detalles</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    /* === CSS VARIABLES === */
    :root {
        --verde-pacifico: #009c3c;
        --verde-pacifico-hover: #007e31;
        --verde-pacifico-light: #22a650;
    }

    /* === MODERN MODAL STYLES === */
    .modern-modal {
        border: none;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        max-height: 95vh;
    }

    .modal-header-modern {
        background: linear-gradient(135deg, #009c3c 0%, #00b84a 50%, #22a650 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-bottom: none;
        position: relative;
        overflow: hidden;
    }

    .modal-header-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        pointer-events: none;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 1;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .actions-buttons {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .action-btn-header {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
    }

    .action-btn-header:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .action-btn-header:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .action-btn-header.primary {
        background: rgba(255, 255, 255, 0.2);
    }

    .action-btn-header.primary:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
    }

    .action-btn-header.secondary {
        background: rgba(255, 255, 255, 0.2);
    }

    .action-btn-header.secondary:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
    }

    .action-btn-header.danger {
        background: rgba(220, 53, 69, 0.8);
    }

    .action-btn-header.danger:hover:not(:disabled) {
        background: rgba(220, 53, 69, 1);
    }

    .action-btn-header.info {
        background: rgba(255, 255, 255, 0.2);
    }

    .action-btn-header.info:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
    }

    .solicitud-header {
        flex: 1;
    }

    .solicitud-code-badge {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .code-text {
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    .status-badge {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .solicitud-type {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 500;
    }

    .btn-close-modern {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .btn-close-modern:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .modal-body-modern {
        padding: 0;
        background: #f8f9fa;
        max-height: calc(95vh - 120px);
        overflow-y: auto;
    }

    /* === TAB STYLES === */
    .modal-tabs {
        background: white;
        border-bottom: 1px solid #dee2e6;
        margin: 0;
        padding: 0 2rem;
    }

    .modal-tabs .nav-link {
        border: none;
        border-radius: 0;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.5rem;
        position: relative;
        transition: all 0.3s ease;
    }

    .modal-tabs .nav-link:hover {
        border-color: transparent;
        color: var(--verde-pacifico);
        background: transparent;
    }

    .modal-tabs .nav-link.active {
        color: var(--verde-pacifico);
        background: transparent;
        border-color: transparent;
        font-weight: 600;
    }

    .modal-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--verde-pacifico);
        border-radius: 3px 3px 0 0;
    }

    .modal-tab-content {
        background: #f8f9fa;
    }

    .modal-tab-content .tab-pane {
        padding: 2rem;
    }

    /* === DOCUMENTOS SECTION === */
    .documentos-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--verde-pacifico);
    }

    /* === HISTORIAL SECTION === */
    .historial-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--verde-pacifico);
    }

    .historial-container {
        min-height: 200px;
    }

    /* === DEBIDA DILIGENCIA SECTION === */
    .diligencia-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--verde-pacifico);
    }

    .diligencia-container {
        min-height: 200px;
    }

    .diligencia-status-card {
        background: linear-gradient(135deg, #f8fffe 0%, #f0fcf5 100%);
        border: 1px solid #e2f5e8;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }

    .diligencia-status-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--verde-pacifico) 0%, #22a650 100%);
    }

    .diligencia-header {
        display: flex;
        align-items: center;
        justify-content: between;
        margin-bottom: 20px;
    }

    .diligencia-status-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 20px;
    }

    .diligencia-status-info {
        flex: 1;
    }

    .diligencia-status-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 5px 0;
        color: #2d3748;
    }

    .diligencia-status-subtitle {
        font-size: 14px;
        color: #718096;
        margin: 0;
    }

    .diligencia-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .diligencia-files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .diligencia-file-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
    }

    .diligencia-file-card:hover {
        border-color: var(--verde-pacifico);
        box-shadow: 0 4px 12px rgba(0, 156, 60, 0.1);
    }

    .diligencia-file-card.completed {
        border-color: #48bb78;
        background: linear-gradient(135deg, #f0fff4 0%, #f7fafc 100%);
    }

    .diligencia-file-card.pending {
        border-color: #ed8936;
        background: linear-gradient(135deg, #fffaf0 0%, #f7fafc 100%);
    }

    .diligencia-file-card.makito-processing {
        border-color: #4299e1;
        background: linear-gradient(135deg, #ebf8ff 0%, #f7fafc 100%);
        animation: pulse-border 2s infinite;
    }

    @keyframes pulse-border {
        0% { border-color: #4299e1; }
        50% { border-color: #63b3ed; }
        100% { border-color: #4299e1; }
    }

    .diligencia-file-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .diligencia-file-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 16px;
    }

    .diligencia-file-info {
        flex: 1;
    }

    .diligencia-file-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 5px 0;
        color: #2d3748;
    }

    .diligencia-file-status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .diligencia-file-status.completed {
        background: #c6f6d5;
        color: #22543d;
    }

    .diligencia-file-status.pending {
        background: #fed7cc;
        color: #c05621;
    }

    .diligencia-file-status.makito-processing {
        background: #bee3f8;
        color: #2c5282;
    }

    .diligencia-file-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
    }

    .diligencia-upload-area {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-top: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .diligencia-upload-area:hover {
        border-color: var(--verde-pacifico);
        background: #f0fcf5;
    }

    .diligencia-upload-area.dragover {
        border-color: var(--verde-pacifico);
        background: #f0fcf5;
        transform: scale(1.02);
    }

    .diligencia-upload-icon {
        font-size: 24px;
        color: #a0aec0;
        margin-bottom: 10px;
    }

    .diligencia-upload-text {
        color: #4a5568;
        font-size: 14px;
    }

    .btn-diligencia {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-diligencia.primary {
        background: var(--verde-pacifico);
        color: white;
    }

    .btn-diligencia.primary:hover {
        background: var(--verde-pacifico-hover);
        transform: translateY(-1px);
    }

    .btn-diligencia.secondary {
        background: #e2e8f0;
        color: #4a5568;
    }

    .btn-diligencia.secondary:hover {
        background: #cbd5e0;
    }

    .btn-diligencia.warning {
        background: #ed8936;
        color: white;
    }

    .btn-diligencia.warning:hover {
        background: #dd6b20;
    }

    .btn-diligencia:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    /* === TIMELINE STYLES === */
    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, var(--verde-pacifico) 0%, #e9ecef 100%);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 20px;
        padding-left: 60px;
        animation: fadeInUp 0.5s ease-out;
    }

    .timeline-item:last-child {
        margin-bottom: 0;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .timeline-marker {
        position: absolute;
        left: 11px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: white;
        border: 3px solid var(--verde-pacifico);
        z-index: 2;
        transition: all 0.3s ease;
    }

    .timeline-item:hover .timeline-marker {
        transform: scale(1.2);
        box-shadow: 0 0 0 4px rgba(0, 156, 60, 0.2);
    }

    .timeline-item.current .timeline-marker {
        background: var(--verde-pacifico);
        border-color: var(--verde-pacifico);
        box-shadow: 0 0 0 4px rgba(0, 156, 60, 0.3);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 156, 60, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(0, 156, 60, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(0, 156, 60, 0);
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .timeline-content {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px 16px;
        border-left: 4px solid var(--verde-pacifico);
        transition: all 0.3s ease;
        position: relative;
    }

    .timeline-content:hover {
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }

    .timeline-title {
        font-weight: 600;
        color: #495057;
        font-size: 0.95rem;
        margin: 0;
    }

    .timeline-date {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
    }

    .timeline-details {
        font-size: 0.85rem;
        color: #6c757d;
        line-height: 1.4;
        margin-top: 4px;
    }

    .timeline-duration {
        display: inline-block;
        background: rgba(0, 156, 60, 0.1);
        color: var(--verde-pacifico);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 8px;
    }

    .timeline-item.completed .timeline-marker {
        background: var(--verde-pacifico);
        border-color: var(--verde-pacifico);
    }

    .timeline-item.completed .timeline-content {
        border-left-color: var(--verde-pacifico);
    }

    .timeline-item.pending .timeline-marker {
        background: #6c757d;
        border-color: #6c757d;
    }

    .timeline-item.pending .timeline-content {
        border-left-color: #6c757d;
        opacity: 0.7;
    }

    .timeline-item.error .timeline-marker {
        background: #dc3545;
        border-color: #dc3545;
    }

    .timeline-item.error .timeline-content {
        border-left-color: #dc3545;
    }

    .timeline-item.warning .timeline-marker {
        background: #ffc107;
        border-color: #ffc107;
    }

    .timeline-item.warning .timeline-content {
        border-left-color: #ffc107;
    }

    /* === NEW COMPACT TIMELINE STYLES === */
    .timeline-date-group {
        margin-bottom: 24px;
        opacity: 0;
        animation: slideInFromLeft 0.5s ease-out forwards;
    }

    .timeline-date-group:nth-child(even) {
        animation-delay: 0.1s;
    }

    .timeline-date-group:nth-child(odd) {
        animation-delay: 0.2s;
    }

    @keyframes slideInFromLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .timeline-date-header {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f1f3f4;
    }

    .date-marker {
        margin-right: 16px;
        flex-shrink: 0;
    }

    .date-indicator {
        background: linear-gradient(135deg, var(--verde-pacifico), #4ade80);
        border-radius: 12px;
        padding: 8px 12px;
        text-align: center;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 156, 60, 0.2);
        min-width: 60px;
    }

    .date-number {
        display: block;
        font-size: 18px;
        font-weight: 700;
        line-height: 1;
    }

    .date-month {
        display: block;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        opacity: 0.9;
        margin-top: 2px;
    }

    .date-info {
        flex: 1;
    }

    .date-title {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 4px 0;
    }

    .events-count {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
    }

    .timeline-events {
        margin-left: 38px;
        position: relative;
    }

    .timeline-events::before {
        content: '';
        position: absolute;
        left: -19px;
        top: 0;
        bottom: 20px;
        width: 2px;
        background: linear-gradient(to bottom, var(--verde-pacifico) 0%, #e5e7eb 100%);
        border-radius: 1px;
    }

    .timeline-event {
        position: relative;
        display: flex;
        margin-bottom: 16px;
        align-items: flex-start;
        padding-bottom: 16px;
    }

    .timeline-event.last-event {
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .timeline-event.first-event .event-marker::before {
        background: var(--verde-pacifico);
    }

    .event-marker {
        position: relative;
        margin-right: 16px;
        flex-shrink: 0;
    }

    .event-marker::before {
        content: '';
        position: absolute;
        left: -26px;
        top: 6px;
        width: 8px;
        height: 8px;
        background: #d1d5db;
        border-radius: 50%;
        z-index: 2;
    }

    .event-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
    }

    .timeline-event:hover .event-icon {
        transform: scale(1.05);
    }

    .event-content {
        flex: 1;
        background: white;
        border-radius: 8px;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }

    .timeline-event:hover .event-content {
        border-color: var(--verde-pacifico);
        box-shadow: 0 4px 12px rgba(0, 156, 60, 0.08);
        transform: translateY(-1px);
    }

    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 4px;
    }

    .event-title {
        flex: 1;
        margin-right: 12px;
    }

    .event-user {
        font-weight: 600;
        color: #1f2937;
        font-size: 14px;
    }

    .event-action {
        color: #4b5563;
        font-size: 14px;
        margin-left: 4px;
    }

    .event-time {
        font-size: 12px;
        color: #9ca3af;
        font-weight: 500;
        white-space: nowrap;
    }

    .event-details {
        font-size: 13px;
        color: #6b7280;
        line-height: 1.4;
        margin-top: 6px;
        padding: 8px 12px;
        background: #f9fafb;
        border-radius: 6px;
        border-left: 3px solid #e5e7eb;
    }

    .event-subtitle {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 4px;
        font-style: italic;
    }

    /* === RESPONSIVE DESIGN FOR COMPACT TIMELINE === */
    @media (max-width: 768px) {
        .timeline-date-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .date-marker {
            margin-right: 0;
        }

        .timeline-events {
            margin-left: 20px;
        }

        .timeline-events::before {
            left: -11px;
        }

        .event-marker::before {
            left: -18px;
        }

        .event-header {
            flex-direction: column;
            gap: 4px;
        }

        .event-time {
            align-self: flex-start;
        }
    }

    .documentos-container {
        min-height: 200px;
    }

    .documento-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
        border-left: 4px solid #e0e0e0;
    }

    .documento-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .documento-item.cumplido {
        border-left-color: #28a745;
        background: linear-gradient(135deg, #ffffff 0%, #f8fff8 100%);
    }

    .documento-item.pendiente {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, #ffffff 0%, #fffef8 100%);
    }

    .documento-item.no-cumplido {
        border-left-color: #dc3545;
        background: linear-gradient(135deg, #ffffff 0%, #fff8f8 100%);
    }

    .documento-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .documento-nombre {
        font-weight: 600;
        color: #495057;
        font-size: 1rem;
    }

    .documento-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .documento-status.cumplido {
        background: #d4edda;
        color: #155724;
    }

    .documento-status.pendiente {
        background: #fff3cd;
        color: #856404;
    }

    .documento-status.no-cumplido {
        background: #f8d7da;
        color: #721c24;
    }

    .documento-status.apc-procesando {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        border: 1px solid #3b82f6;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        animation: pulse 2s infinite;
    }

    .documento-item.apc-procesando {
        border-left-color: #3b82f6;
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    }

    .documento-observaciones {
        color: #6c757d;
        font-size: 0.9rem;
        font-style: italic;
        margin-top: 0.5rem;
    }

    .documento-blocked-info {
        margin-top: 8px;
        padding: 8px 12px;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        font-size: 0.85em;
        color: #856404;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .documento-blocked-info i {
        color: #f39c12;
    }

    .documento-actions {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
    }

    .btn-documento {
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .btn-documento.btn-download {
        background: var(--verde-pacifico);
        color: white;
        border: none;
    }

    .btn-documento.btn-download:hover {
        background: #007e31;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .btn-documento.btn-upload {
        background: #17a2b8;
        color: white;
        border: none;
        cursor: pointer;
    }

    .btn-documento.btn-upload:hover {
        background: #138496;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .btn-documento.btn-upload:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }

    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
        margin-top: 0.5rem;
        display: none;
    }

    .upload-area.active {
        display: block;
    }

    .upload-area.dragover {
        border-color: var(--verde-pacifico);
        background: rgba(0, 156, 60, 0.05);
    }

    .upload-input {
        display: none;
    }

    .upload-text {
        color: #6c757d;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .upload-progress {
        margin-top: 0.5rem;
        display: none;
    }

    .progress-bar-custom {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: var(--verde-pacifico);
        width: 0%;
        transition: width 0.3s ease;
    }

    .file-preview {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        display: none;
        font-size: 0.875rem;
    }

    .file-preview.active {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .file-remove {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
    }

    .file-remove:hover {
        background: rgba(220, 53, 69, 0.1);
    }

    .upload-buttons {
        margin-top: 0.5rem;
        display: none;
        gap: 0.5rem;
    }

    .upload-buttons.active {
        display: flex;
    }

    .btn-upload-confirm {
        background: #28a745;
        color: white;
        border: none;
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-upload-confirm:hover {
        background: #218838;
    }

    .btn-upload-confirm:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }

    .btn-upload-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-upload-cancel:hover {
        background: #5a6268;
    }

    .documento-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
        .documento-grid {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }
    }

    /* === WORKFLOW SECTION === */
    .workflow-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--verde-pacifico);
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--verde-pacifico);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }

    .section-title i {
        color: var(--verde-pacifico);
    }

    .workflow-container {

        border-radius: 6px;

        overflow-x: auto;
    }

    /* === MODAL LAYOUT === */
    .modal-main-content {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: #fafafa;
        border-radius: 8px;


    }

    .info-cards-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    /* === INFO CARDS GRID === */
    .info-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .info-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    /* Info cards styles */
    .info-cards-section .info-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: none;
        transition: all 0.2s ease;
    }

    .info-cards-section .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Modern Summary Card Styles */
    .summary-card-modern {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .summary-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--verde-pacifico) 0%, #22a650 100%);
    }

    .summary-card-modern:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .summary-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
    }

    .summary-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--verde-pacifico) 0%, #22a650 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
        box-shadow: 0 4px 12px rgba(0, 156, 60, 0.3);
    }

    .summary-title-section {
        flex: 1;
    }

    .summary-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 4px 0;
        line-height: 1.4;
    }

    .summary-subtitle {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
        font-weight: 500;
    }

    .summary-content {
        margin-top: 16px;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .summary-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .summary-item:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: var(--verde-pacifico);
        transform: translateY(-1px);
    }

    .summary-item-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: rgba(0, 156, 60, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--verde-pacifico);
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .summary-item-content {
        flex: 1;
        min-width: 0;
    }

    .summary-item-label {
        display: block;
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 2px;
    }

    .summary-item-value {
        display: block;
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.4;
        word-break: break-word;
    }

    /* Modern Client Card Styles */
    .client-card-modern {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .client-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #2196f3 0%, #1976d2 100%);
    }

    .client-card-modern:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .client-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
    }

    .client-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    .client-title-section {
        flex: 1;
    }

    .client-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 4px 0;
        line-height: 1.4;
    }

    .client-subtitle {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
        font-weight: 500;
    }

    .client-content {
        margin-top: 16px;
    }

    .client-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .client-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .client-item:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: #2196f3;
        transform: translateY(-1px);
    }

    .client-item-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: rgba(33, 150, 243, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #2196f3;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .client-item-content {
        flex: 1;
        min-width: 0;
    }

    .client-item-label {
        display: block;
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 2px;
    }

    .client-item-value {
        display: block;
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.4;
        word-break: break-word;
    }

    /* Modern Cotización Card Styles */
    .cotizacion-card-modern {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .cotizacion-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #ff9800 0%, #f57c00 100%);
    }

    .cotizacion-card-modern:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .cotizacion-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
    }

    .cotizacion-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
    }

    .cotizacion-title-section {
        flex: 1;
    }

    .cotizacion-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 4px 0;
        line-height: 1.4;
    }

    .cotizacion-subtitle {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
        font-weight: 500;
    }

    .cotizacion-content {
        margin-top: 16px;
    }

    .cotizacion-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .cotizacion-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .cotizacion-item:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: #ff9800;
        transform: translateY(-1px);
    }

    .cotizacion-item-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: rgba(255, 152, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ff9800;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .cotizacion-item-content {
        flex: 1;
        min-width: 0;
    }

    .cotizacion-item-label {
        display: block;
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 2px;
    }

    .cotizacion-item-value {
        display: block;
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.4;
        word-break: break-word;
    }

    .info-cards-section .summary-card {
        border-left: 4px solid var(--verde-pacifico);
    }

    .info-cards-section .client-card {
        border-left: 4px solid #2196f3;
    }





    /* === WORKFLOW ROADMAP (Enhanced) === */
    .workflow-roadmap {
        display: flex;
        align-items: flex-end;
        overflow-x: auto;
        padding: 1.5rem 0.5rem;
        justify-content: center;
        gap: 0.5rem;
        scrollbar-width: thin;
        scrollbar-color: #009c3c #f1f1f1;
    }

    .workflow-roadmap::-webkit-scrollbar {
        height: 6px;
    }

    .workflow-roadmap::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .workflow-roadmap::-webkit-scrollbar-thumb {
        background: #009c3c;
        border-radius: 3px;
    }

    .workflow-roadmap::-webkit-scrollbar-thumb:hover {
        background: #007a2f;
    }

    .workflow-step {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 120px;
        flex: 0 0 120px;
        z-index: 1;
    }

    .workflow-step .circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        border: 3px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #6c757d;
        margin-bottom: 8px;
        transition: all 0.2s ease;
        position: relative;
        z-index: 2;
    }

    .workflow-step.completed .circle {
        background: var(--verde-pacifico);
        border-color: var(--verde-pacifico);
        color: white;
        box-shadow: 0 2px 8px rgba(0, 156, 60, 0.2);
    }

    .workflow-step.current .circle {
        background: #fff3cd;
        border-color: #ffc107;
        color: #856404;
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.2), 0 0 12px rgba(255, 193, 7, 0.3);
        animation: pulse-glow 2s infinite;
    }

    @keyframes pulse-glow {
        0% {
            box-shadow: 0 0 0 6px rgba(255, 193, 7, 0.2), 0 0 20px rgba(255, 193, 7, 0.4);
            transform: scale(1);
        }

        50% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0.1), 0 0 30px rgba(255, 193, 7, 0.6);
            transform: scale(1.05);
        }

        100% {
            box-shadow: 0 0 0 6px rgba(255, 193, 7, 0.2), 0 0 20px rgba(255, 193, 7, 0.4);
            transform: scale(1);
        }
    }

    .workflow-step.pending .circle {
        background: #f8f9fa;
        border-color: #dee2e6;
        color: #6c757d;
    }

    .workflow-step .step-label {
        font-weight: 600;
        color: #333;
        font-size: 0.875rem;
        margin-bottom: 4px;
        text-align: center;
        line-height: 1.3;
    }



    .workflow-connector {
        flex: 0 0 30px;
        height: 3px;
        background: linear-gradient(90deg, #dee2e6 0%, #e9ecef 100%);
        margin-bottom: 20px;
        border-radius: 2px;
        position: relative;
        z-index: 1;
    }

    .workflow-connector.completed {
        background: linear-gradient(90deg, var(--verde-pacifico) 0%, #22a650 100%);
    }





    /* === EMPTY STATE === */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state i {
        opacity: 0.5;
    }

    /* === RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
        .modal-body-modern {
            padding: 1rem;
        }

        .info-cards-section {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .info-cards-section .info-card {
            min-width: auto;
        }

        .summary-grid,
        .client-grid,
        .cotizacion-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .summary-header,
        .client-header,
        .cotizacion-header {
            flex-direction: column;
            text-align: center;
            gap: 12px;
        }

        .summary-title,
        .client-title,
        .cotizacion-title {
            font-size: 1.125rem;
        }

        .summary-card-modern,
        .client-card-modern,
        .cotizacion-card-modern {
            padding: 20px;
        }

        .info-cards-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .info-card {
            padding: 1rem;
        }

        .workflow-step {
            min-width: 100px;
            flex-basis: 100px;
        }

        .workflow-step .circle {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
        }

        .workflow-connector {
            flex-basis: 20px;
        }

        .solicitud-code-badge {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .code-text {
            font-size: 1.5rem;
        }

        .header-actions {
            flex-direction: column;
            gap: 0.5rem;
        }

        .actions-buttons {
            gap: 0.25rem;
        }

        .action-btn-header {
            width: 32px;
            height: 32px;
            font-size: 0.75rem;
        }

        .timeline-item {
            padding-left: 50px;
            margin-bottom: 16px;
        }

        .timeline-marker {
            left: 6px;
            width: 16px;
            height: 16px;
        }

        .timeline::before {
            left: 14px;
        }

        .timeline-content {
            padding: 10px 12px;
        }

        .timeline-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .timeline-title {
            font-size: 0.9rem;
        }

        .timeline-date {
            font-size: 0.75rem;
        }

        .timeline-details {
            font-size: 0.8rem;
            margin-top: 2px;
        }


    }

    @media (max-width: 480px) {
        .modal-header-modern {
            padding: 1rem;
        }

        .workflow-section {
            padding: 1rem;
        }

        .info-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }

        .info-value {
            text-align: left;
            max-width: 100%;
        }
    }

    /* === LOADING STATE === */
    .loading-placeholder {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading-shimmer 1.5s infinite;
        border-radius: 4px;
        height: 1rem;
        margin: 0.25rem 0;
    }

    @keyframes loading-shimmer {
        0% {
            background-position: -200% 0;
        }

        100% {
            background-position: 200% 0;
        }
    }

    /* === CUSTOM SCROLLBAR === */
    .modal-body-modern::-webkit-scrollbar {
        width: 8px;
    }

    .modal-body-modern::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .modal-body-modern::-webkit-scrollbar-thumb {
        background: #009c3c;
        border-radius: 4px;
    }

    .modal-body-modern::-webkit-scrollbar-thumb:hover {
        background: #007a2f;
    }

    /* === COMPACT WORKFLOW SECTION OVERRIDES === */
    .workflow-section {
        padding-top: 10px;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .section-title {
        margin-bottom: 8px;
    }

    .workflow-roadmap {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }
</style>
<script>


    window.mostrarModalSolicitud = function (solicitudId) {
        // Test if Bootstrap is available
        if (typeof bootstrap === 'undefined' && typeof window.bootstrap === 'undefined') {
            console.error('Bootstrap is not available');
            return;
        }

        console.log('Opening modal for solicitud:', solicitudId);
        console.log('Type of solicitudId:', typeof solicitudId);
        console.log('solicitudId is valid:', solicitudId && solicitudId !== 'null' && solicitudId !== 'undefined');

        // Validate solicitudId
        if (!solicitudId || solicitudId === 'null' || solicitudId === 'undefined' || solicitudId === '') {
            console.error('Invalid solicitudId provided:', solicitudId);
            alert('ID de solicitud inválido: ' + solicitudId);
            return;
        }

        // Store the solicitudId globally for use in the modal
        window.currentSolicitudId = solicitudId;

        // Set the solicitudId on the Ver Detalle button
        const btnVerDetalle = document.getElementById('modalBtnVerDetalle');
        if (btnVerDetalle) {
            btnVerDetalle.setAttribute('data-solicitud-id', solicitudId);
            console.log('Set button data-solicitud-id to:', btnVerDetalle.getAttribute('data-solicitud-id'));
        }

        // Show loading state
        showLoadingState();

        // Show modal first - try multiple ways to access Bootstrap
        try {
            const modal = new bootstrap.Modal(document.getElementById('modalSolicitud'));
            modal.show();
        } catch (error) {
            console.error('Error creating Bootstrap modal:', error);
            // Fallback: try to show modal manually
            const modalElement = document.getElementById('modalSolicitud');
            if (modalElement) {
                modalElement.classList.add('show');
                modalElement.style.display = 'block';
                modalElement.setAttribute('aria-hidden', 'false');
                // Add backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
        }

        // Construct the API URL
        const apiUrl = `/workflow/api/solicitud_brief/${solicitudId}/`;
        console.log('API URL:', apiUrl);

        // Fetch API with comprehensive error handling
        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCsrfToken()
            },
            credentials: 'same-origin'
        })
            .then(response => {
                console.log('API Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return response.json();
            })
            .then(data => {
                console.log('API Success:', { data: data });

                // Validate response data
                if (!data || typeof data !== 'object') {
                    console.error('Invalid response data:', data);
                    showErrorState('Respuesta de API inválida');
                    return;
                }

                populateModalData(data);
            })
            .catch(error => {
                console.error('API Error:', {
                    error: error.message,
                    apiUrl: apiUrl
                });

                let errorMessage = 'Error desconocido';

                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'No se pudo conectar al servidor';
                } else if (error.message.includes('404')) {
                    errorMessage = `Solicitud ${solicitudId} no encontrada`;
                } else if (error.message.includes('500')) {
                    errorMessage = 'Error interno del servidor';
                } else if (error.message.includes('503')) {
                    errorMessage = 'Servicio no disponible temporalmente';
                } else {
                    errorMessage = error.message;
                }

                // Show error but also populate with mock data for testing
                console.warn('Using mock data for testing purposes');
                populateModalData(getMockData(solicitudId));

                // Show a warning message
                setTimeout(() => {
                    const workflowProgress = document.getElementById('modalSolicitudWorkflowProgress');
                    if (workflowProgress) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-warning alert-dismissible fade show';
                        alertDiv.setAttribute('role', 'alert');
                        alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Modo de prueba:</strong> ${errorMessage}
                    <br><small>URL: ${apiUrl}</small>
                    <br><small>Para probar la API directamente, ejecute <code>testApiDirectly(${solicitudId})</code> en la consola</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                        workflowProgress.prepend(alertDiv);
                    }
                }, 500);
            });

        // Function to get CSRF token
        function getCsrfToken() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            return csrfToken ? csrfToken.value : '';
        }
    };

    function showLoadingState() {
        // Clear modal content
        const modalSolicitudCodigo = document.getElementById('modalSolicitudCodigo');
        const modalSolicitudEstadoBadge = document.getElementById('modalSolicitudEstadoBadge');
        const modalSolicitudTipo = document.getElementById('modalSolicitudTipo');

        if (modalSolicitudCodigo) {
            modalSolicitudCodigo.innerHTML = '<div class="loading-placeholder" style="width: 120px;"></div>';
        }
        if (modalSolicitudEstadoBadge) {
            modalSolicitudEstadoBadge.innerHTML = '<div class="loading-placeholder" style="width: 80px;"></div>';
        }
        if (modalSolicitudTipo) {
            modalSolicitudTipo.innerHTML = '<div class="loading-placeholder" style="width: 200px;"></div>';
        }

        // Reset info fields
        const infoFields = ['FechaInicio', 'Vencimiento', 'EtapaActual', 'Area', 'Cliente', 'Cedula', 'Canal'];
        infoFields.forEach(field => {
            const element = document.getElementById(`modalSolicitud${field}`);
            if (element) {
                element.innerHTML = '<div class="loading-placeholder" style="width: 100px;"></div>';
            }
        });

        // Reset cotización fields
        const cotizacionFields = ['MontoFinanciado', 'Plazo', 'TasaInteres', 'MontoLetra'];
        cotizacionFields.forEach(field => {
            const element = document.getElementById(`modalSolicitud${field}`);
            if (element) {
                element.innerHTML = '<div class="loading-placeholder" style="width: 100px;"></div>';
            }
        });

        // Disable action buttons
        const actionButtons = document.querySelectorAll('.action-btn-header');
        actionButtons.forEach(btn => {
            btn.disabled = true;
        });

        // Show loading in workflow
        const workflowProgress = document.getElementById('modalSolicitudWorkflowProgress');
        if (workflowProgress) {
            workflowProgress.innerHTML = `
            <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        `;
        }

        // Add loading animation to modern cards
        const modernCards = document.querySelectorAll('.summary-card-modern, .client-card-modern, .cotizacion-card-modern');
        modernCards.forEach((card, index) => {
            card.innerHTML = `
            <div class="d-flex justify-content-center align-items-center" style="height: 120px;">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        `;
        });
    }

    function showErrorState(errorMessage = 'Error al cargar la información') {
        const workflowProgress = document.getElementById('modalSolicitudWorkflowProgress');
        if (workflowProgress) {
            workflowProgress.innerHTML = `
            <div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <div class="fw-bold mb-2">${errorMessage}</div>
                <div class="text-muted">Por favor, intente nuevamente o contacte al administrador</div>
            </div>
        `;
        }

        // Enable action buttons but show they're unavailable
        const actionButtons = document.querySelectorAll('.action-btn-header');
        actionButtons.forEach(btn => {
            btn.disabled = false;
        });
    }

    function populateModalData(data) {
        try {
            console.log('Populating modal with data:', data);

            // Store current modal data globally for updates
            window.currentModalData = data;

            // Validate data structure
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid data structure');
            }

            // Get solicitudId from the current modal context
            const solicitudId = window.currentSolicitudId;
            console.log('Current solicitudId:', solicitudId);

            // Set the solicitudId on the Ver Detalle button
            const btnVerDetalle = document.getElementById('modalBtnVerDetalle');
            if (btnVerDetalle) {
                btnVerDetalle.setAttribute('data-solicitud-id', solicitudId);
            }

            // Populate the unified summary card
            populateUnifiedSummaryCard(data);

            // General info with fallbacks
            const general = data.general || {};
            setElementText('modalSolicitudCodigo', general.codigo || 'N/A');
            setElementText('modalSolicitudEstadoBadge', general.estado || 'N/A');
            setElementText('modalSolicitudTipo', general.tipo || 'N/A');
            setElementText('modalSolicitudFechaInicio', general.fecha_inicio || 'N/A');
            setElementText('modalSolicitudVencimiento', general.vencimiento || 'N/A');
            setElementText('modalSolicitudEtapaActual', general.etapa_actual || 'N/A');
            setElementText('modalSolicitudArea', general.area || 'N/A');

            // Client info with fallbacks
            const cliente = data.cliente || {};
            const cotizacion = data.cotizacion || {};

            console.log('🔍 DEBUG - Full API response data:', data);
            console.log('🔍 DEBUG - Cliente data:', cliente);
            console.log('🔍 DEBUG - Cotizacion data:', cotizacion);

            setElementText('modalSolicitudCliente', cliente.nombre || 'N/A');
            setElementText('modalSolicitudCedula', cliente.cedula || 'N/A');

            // Edad y Sexo from cotizacion (API fields)
            let edadSexo = 'N/A';
            const edad = cotizacion.edad;
            const sexo = cotizacion.sexo;

            console.log('🔍 DEBUG - Edad:', edad, 'type:', typeof edad);
            console.log('🔍 DEBUG - Sexo:', sexo, 'type:', typeof sexo);

            if (edad !== null && edad !== undefined && edad !== '-' &&
                sexo !== null && sexo !== undefined && sexo !== '-') {
                edadSexo = `${edad} años / ${sexo}`;
            } else if (edad !== null && edad !== undefined && edad !== '-') {
                edadSexo = `${edad} años`;
            } else if (sexo !== null && sexo !== undefined && sexo !== '-') {
                edadSexo = sexo;
            }

            setElementText('modalSolicitudEdadSexo', edadSexo);
            console.log('🔍 DEBUG - EdadSexo final:', edadSexo);

            // Cartera from cotizacion (API field)
            const cartera = cotizacion.cartera;
            console.log('🔍 DEBUG - Cartera:', cartera, 'type:', typeof cartera);

            const carteraText = (cartera !== null && cartera !== undefined && cartera !== '-') ? cartera : 'N/A';
            setElementText('modalSolicitudCartera', carteraText);
            console.log('🔍 DEBUG - Cartera final:', carteraText);

            // Cotización info with fallbacks
            setElementText('modalSolicitudMontoFinanciado',
                cotizacion.auxMonto2 !== undefined && cotizacion.auxMonto2 !== null ? `$${cotizacion.auxMonto2.toLocaleString()}` : 'N/A'
            );
            setElementText('modalSolicitudPlazo',
                cotizacion.plazo !== undefined ? `${cotizacion.plazo} meses` : 'N/A'
            );
            setElementText('modalSolicitudTasaInteres',
                cotizacion.tasa_interes !== undefined ? `${cotizacion.tasa_interes}%` :
                    cotizacion.tasa !== undefined ? `${cotizacion.tasa}%` : 'N/A'
            );
            setElementText('modalSolicitudMontoLetra',
                cotizacion.monto_letra !== undefined ? `$${cotizacion.monto_letra.toLocaleString()}` :
                    cotizacion.cuota !== undefined ? `$${cotizacion.cuota.toLocaleString()}` : 'N/A'
            );

            // Action buttons with fallbacks
            const acciones = data.acciones || {};
            setButtonDisabled('modalBtnProcesarTarea', !(acciones.puede_procesar || false));
            setButtonDisabled('modalBtnDevolver', !(acciones.puede_devolver || false));
            setButtonDisabled('modalBtnAnular', !(acciones.puede_anular || false));
            setButtonDisabled('modalBtnComentarios', !(acciones.puede_comentar || false));

            // Workflow roadmap with fallbacks
            const workflow = data.workflow || [];
            if (workflow.length > 0) {
                renderWorkflowRoadmap(workflow);
            } else {
                const workflowProgress = document.getElementById('modalSolicitudWorkflowProgress');
                if (workflowProgress) {
                    workflowProgress.innerHTML = '<div class="text-center text-muted py-4">No hay información de workflow disponible</div>';
                }
            }

            // Populate documentos tab
            const documentos = data.documentos || [];
            populateDocumentosTab(documentos);

            // Populate historial tab
            const historial = data.historial || [];
            populateHistorialTab(historial);

            // Add smooth animations for the new layout
            setTimeout(() => {
                const modernCards = document.querySelectorAll('.summary-card-modern, .client-card-modern, .cotizacion-card-modern');
                modernCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.transition = 'all 0.3s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 100);
                });

                const mainContent = document.querySelector('.modal-main-content');
                if (mainContent) {
                    setTimeout(() => {
                        mainContent.style.transition = 'all 0.3s ease';
                        mainContent.style.opacity = '1';
                        mainContent.style.transform = 'translateY(0)';
                    }, 300);
                }
            }, 100);

            console.log('Modal populated successfully');

        } catch (error) {
            console.error('Error populating modal:', error);
            showErrorState('Error al procesar los datos');
        }
    }

    // Function to populate unified summary card
    function populateUnifiedSummaryCard(data) {
        const summaryCard = document.getElementById('modalSolicitudSummaryCard');
        if (!summaryCard) return;
        const general = data.general || {};
        const cliente = data.cliente || {};
        const cotizacion = data.cotizacion || {};
        const isCarLoan = cotizacion.tipoPrestamo === 'auto';
        const vehicleData = isCarLoan && cotizacion.marca && cotizacion.modelo ? `${cotizacion.marca} ${cotizacion.modelo}` : 'N/A';
        const summaryHtml = `
        <div class="summary-header">
            <div class="summary-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="summary-title-section">
                <h3 class="summary-title">Resumen</h3>
                <p class="summary-subtitle">Información general</p>
            </div>
        </div>
        <div class="summary-content">
            <div class="summary-grid">
                <!-- Resumen Section -->
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-hashtag"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Código</span><span class="summary-item-value">${general.codigo || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-calendar"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Fecha Creación</span><span class="summary-item-value">${general.fecha_inicio || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-user-tie"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Propietario</span><span class="summary-item-value">${general.propietario || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-layer-group"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Pipeline</span><span class="summary-item-value">${general.tipo || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-flag"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Etapa</span><span class="summary-item-value">${general.etapa_actual || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-info-circle"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Estado</span><span class="summary-item-value">${general.estado_actual || general.estado || 'N/A'}</span></div>
                </div>
                <!-- Cliente Section -->
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-user"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Nombre</span><span class="summary-item-value">${cliente.nombre || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-id-card"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Cédula</span><span class="summary-item-value">${cliente.cedula || 'N/A'}</span></div>
                </div>
                <!-- Removed Email field -->
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-briefcase"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Ocupación</span><span class="summary-item-value">${cliente.ocupacion || 'N/A'}</span></div>
                </div>
                <!-- Cotización Section -->
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-${isCarLoan ? 'car' : 'user'}"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Producto</span><span class="summary-item-value">${cotizacion.tipoPrestamo === 'auto' ? 'Préstamo de Auto' : cotizacion.tipoPrestamo === 'personal' ? 'Préstamo Personal' : 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Monto</span><span class="summary-item-value">${cotizacion.auxMonto2 ? `$${cotizacion.auxMonto2.toLocaleString()}` : 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-calendar-alt"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Plazo</span><span class="summary-item-value">${cotizacion.plazo ? `${cotizacion.plazo} meses` : 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Letra</span><span class="summary-item-value">${cotizacion.cuota ? `$${cotizacion.cuota.toLocaleString()}` : 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-${isCarLoan ? 'car-side' : 'chart-line'}"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">${isCarLoan ? 'Datos Vehículo' : 'Prima'}</span><span class="summary-item-value">${isCarLoan ? vehicleData : (cotizacion.prima_formateada || 'N/A')}</span></div>
                </div>
            </div>
        </div>
    `;
        summaryCard.innerHTML = summaryHtml;
    }

    // Helper function to set element text safely
    function setElementText(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = text;
        }
    }

    // Helper function to set button disabled state safely
    function setButtonDisabled(elementId, disabled) {
        const element = document.getElementById(elementId);
        if (element) {
            element.disabled = disabled;
        }
    }

    function renderWorkflowRoadmap(etapas) {
        let roadmapHtml = '<div class="workflow-roadmap">';

        etapas.forEach(function (etapa, idx) {
            let stepClass = 'workflow-step';
            if (etapa.completada) stepClass += ' completed';
            if (etapa.actual) stepClass += ' current';
            if (!etapa.completada && !etapa.actual) stepClass += ' pending';

            let icon = etapa.completada ? '<i class="fas fa-check"></i>' :
                etapa.actual ? '<i class="fas fa-bolt"></i>' :
                    `<span>${idx + 1}</span>`;

            roadmapHtml += `
            <div class="${stepClass}">
                <div class="circle">${icon}</div>
                <div class="step-label">${etapa.nombre}</div>
            </div>
        `;

            if (idx < etapas.length - 1) {
                let connectorClass = etapa.completada ? 'workflow-connector completed' : 'workflow-connector';
                roadmapHtml += `<div class="${connectorClass}"></div>`;
            }
        });

        roadmapHtml += '</div>';

        const workflowProgress = document.getElementById('modalSolicitudWorkflowProgress');
        if (workflowProgress) {
            workflowProgress.innerHTML = roadmapHtml;
        }
    }

    // Function to populate documentos tab
    function populateDocumentosTab(documentos) {
        const documentosContainer = document.getElementById('modalSolicitudDocumentos');
        const loadingPlaceholder = documentosContainer.querySelector('.loading-placeholder');
        const emptyState = documentosContainer.querySelector('.empty-state');

        if (!documentosContainer) {
            console.error('Documentos container not found');
            return;
        }

        // Hide loading and empty states initially
        if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';

        // Clear existing content except placeholders
        const existingItems = documentosContainer.querySelectorAll('.documento-item');
        existingItems.forEach(item => item.remove());

        if (!documentos || documentos.length === 0) {
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        // Check if current stage is a group stage
        const isGroupStage = window.currentModalData?.general?.es_etapa_grupal || false;

        const documentosGrid = document.createElement('div');
        documentosGrid.className = 'documento-grid';

        documentos.forEach(documento => {
            const documentoItem = document.createElement('div');

            // Determine status class and text
            let statusClass = 'pendiente';
            let statusText = 'Pendiente';

            // Special handling for APC documents
            if (documento.nombre.toLowerCase() === 'apc' && documento.apc_processing) {
                statusClass = 'apc-procesando';
                statusText = 'Procesando por Makito RPA';
            } else if (documento.cumplido === true) {
                statusClass = 'cumplido';
                statusText = 'Cargado';
            } else if (documento.cumplido === false) {
                statusClass = 'no-cumplido';
                statusText = 'No Cargado';
            }

            documentoItem.className = `documento-item ${statusClass}`;

            let actionsHtml = '';
            let uploadAreaHtml = '';

            const uploadId = `upload-${documento.id || Math.random().toString(36).substr(2, 9)}`;

            if (documento.cumplido === true && documento.url && documento.url.trim() !== '') {
                // Document is loaded and has a URL
                if (isGroupStage) {
                    // In group stage - only allow download, no editing
                    actionsHtml = `
                    <div class="documento-actions">
                        <a href="${documento.url}" target="_blank" class="btn-documento btn-download">
                            <i class="fas fa-download me-1"></i>Descargar
                        </a>
                        <div class="documento-blocked-info">
                            <i class="fas fa-lock me-1"></i>
                            <span class="text-muted">Documento en revisión - No se puede editar</span>
                        </div>
                    </div>
                `;
                } else {
                    // Not in group stage - show download and replace button
                    actionsHtml = `
                    <div class="documento-actions">
                        <a href="${documento.url}" target="_blank" class="btn-documento btn-download">
                            <i class="fas fa-download me-1"></i>Descargar
                        </a>
                        <button type="button" class="btn-documento btn-upload" onclick="toggleUploadArea('${uploadId}')">
                            <i class="fas fa-sync-alt me-1"></i>Reemplazar
                        </button>
                    </div>
                `;
                }
                // Only show upload area if not in group stage
                if (!isGroupStage) {
                    uploadAreaHtml = `
                    <div class="upload-area" id="${uploadId}">
                        <div class="upload-text">
                            <i class="fas fa-cloud-upload-alt"></i><br>
                            Arrastra el archivo aquí o haz clic para seleccionar
                        </div>
                        <input type="file" class="upload-input" id="${uploadId}-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                        <div class="file-preview" id="${uploadId}-preview">
                            <div class="file-info">
                                <i class="fas fa-file"></i>
                                <span class="file-name"></span>
                                <span class="file-size"></span>
                            </div>
                            <button type="button" class="file-remove" onclick="removeFile('${uploadId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="upload-progress" id="${uploadId}-progress">
                            <div class="progress-bar-custom">
                                <div class="progress-fill"></div>
                            </div>
                        </div>
                        <div class="upload-buttons" id="${uploadId}-buttons">
                            <button type="button" class="btn-upload-confirm" onclick="uploadDocument('${uploadId}', '${documento.id || ''}', '${documento.nombre || ''}')">
                                <i class="fas fa-check me-1"></i>Confirmar Subida
                            </button>
                            <button type="button" class="btn-upload-cancel" onclick="cancelUpload('${uploadId}')">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                        </div>
                    </div>
                `;
                }
            } else {
                // Document is missing or not loaded

                // Special handling for APC documents being processed
                if (documento.nombre.toLowerCase() === 'apc' && documento.apc_processing) {
                    actionsHtml = `
                    <div class="documento-actions">
                        <div class="documento-blocked-info" style="background: #dbeafe; border-color: #3b82f6; color: #1e40af;">
                            <i class="fas fa-robot me-1"></i>
                            <span>Procesando por Makito RPA</span>
                        </div>
                        ${documento.apc_fecha_solicitud ? `
                        <div class="documento-observaciones" style="margin-top: 8px; font-size: 0.8rem;">
                            <strong>Solicitado:</strong> ${documento.apc_fecha_solicitud}
                        </div>
                        ` : ''}
                        ${documento.apc_fecha_inicio ? `
                        <div class="documento-observaciones" style="margin-top: 4px; font-size: 0.8rem;">
                            <strong>Iniciado:</strong> ${documento.apc_fecha_inicio}
                        </div>
                        ` : ''}
                    </div>
                `;
                } else if (isGroupStage) {
                    // In group stage - show blocked message
                    actionsHtml = `
                    <div class="documento-actions">
                        <div class="documento-blocked-info">
                            <i class="fas fa-lock me-1"></i>
                            <span class="text-muted">Documento bloqueado - En etapa de revisión grupal</span>
                        </div>
                    </div>
                `;
                } else {
                    // Not in group stage - show upload button
                    actionsHtml = `
                    <div class="documento-actions">
                        <button type="button" class="btn-documento btn-upload" onclick="toggleUploadArea('${uploadId}')">
                            <i class="fas fa-upload me-1"></i>Subir Documento
                        </button>
                    </div>
                `;
                }
                // Only show upload area if not in group stage
                if (!isGroupStage) {
                    uploadAreaHtml = `
                    <div class="upload-area" id="${uploadId}">
                        <div class="upload-text">
                            <i class="fas fa-cloud-upload-alt"></i><br>
                            Arrastra el archivo aquí o haz clic para seleccionar
                        </div>
                        <input type="file" class="upload-input" id="${uploadId}-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                        <div class="file-preview" id="${uploadId}-preview">
                            <div class="file-info">
                                <i class="fas fa-file"></i>
                                <span class="file-name"></span>
                                <span class="file-size"></span>
                            </div>
                            <button type="button" class="file-remove" onclick="removeFile('${uploadId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="upload-progress" id="${uploadId}-progress">
                            <div class="progress-bar-custom">
                                <div class="progress-fill"></div>
                            </div>
                        </div>
                        <div class="upload-buttons" id="${uploadId}-buttons">
                            <button type="button" class="btn-upload-confirm" onclick="uploadDocument('${uploadId}', '${documento.id || ''}', '${documento.nombre || ''}')">
                                <i class="fas fa-check me-1"></i>Confirmar Subida
                            </button>
                            <button type="button" class="btn-upload-cancel" onclick="cancelUpload('${uploadId}')">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                        </div>
                    </div>
                `;
                }
            }

            let observacionesHtml = '';
            if (documento.observaciones && documento.observaciones.trim() !== '') {
                observacionesHtml = `
                <div class="documento-observaciones">
                    <strong>Observaciones:</strong> ${documento.observaciones}
                </div>
            `;
            }

            documentoItem.innerHTML = `
            <div class="documento-header">
                <div class="documento-nombre">${documento.nombre || 'Documento sin nombre'}</div>
                <span class="documento-status ${statusClass}">${statusText}</span>
            </div>
            ${observacionesHtml}
            ${actionsHtml}
            ${uploadAreaHtml}
        `;

            documentosGrid.appendChild(documentoItem);
        });

        documentosContainer.appendChild(documentosGrid);

        console.log(`Populated ${documentos.length} documentos in the tab`);
    }

    // Function to populate historial tab
    function populateHistorialTab(historial) {
        const historialContainer = document.getElementById('modalSolicitudHistorial');
        const loadingPlaceholder = historialContainer.querySelector('.loading-placeholder');
        const emptyState = historialContainer.querySelector('.empty-state');

        if (!historialContainer) {
            console.error('Historial container not found');
            return;
        }

        // Hide loading and empty states initially
        if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';

        // Clear existing content except placeholders
        const existingItems = historialContainer.querySelectorAll('.timeline-date-group');
        existingItems.forEach(item => item.remove());

        if (!historial || historial.length === 0) {
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        // Sort historial by date (most recent first)
        const sortedHistorial = historial.sort((a, b) => {
            const dateA = new Date(a.fecha_inicio || a.fecha_creacion || 0);
            const dateB = new Date(b.fecha_inicio || b.fecha_creacion || 0);
            return dateB - dateA;
        });

        // Group events by date
        const groupedEvents = groupEventsByDate(sortedHistorial);

        // Create compact timeline groups
        Object.keys(groupedEvents).forEach((dateKey, groupIndex) => {
            const events = groupedEvents[dateKey];
            const timelineGroup = document.createElement('div');
            timelineGroup.className = 'timeline-date-group';

            const formattedDate = formatDateForGroup(dateKey);
            const dateDisplay = getDateDisplay(dateKey);

            let eventsHtml = '';
            events.forEach((evento, index) => {
                const eventType = getEventType(evento);
                const userInitials = getUserInitials(evento.usuario || 'Usuario');
                const userColor = getUserColor(evento.usuario || 'Usuario');
                const eventIcon = getEventIcon(eventType.tipo);
                const eventTime = formatTime(evento.fecha_inicio || evento.fecha_creacion);

                eventsHtml += `
                    <div class="timeline-event ${index === 0 ? 'first-event' : ''} ${index === events.length - 1 ? 'last-event' : ''}">
                        <div class="event-marker">
                            <div class="event-icon" style="background-color: ${userColor}">
                                <i class="${eventIcon}"></i>
                            </div>
                        </div>
                        <div class="event-content">
                            <div class="event-header">
                                <div class="event-title">
                                    <span class="event-user">${evento.usuario || 'Usuario'}</span>
                                    <span class="event-action">${eventType.action}</span>
                                </div>
                                <div class="event-time">${eventTime}</div>
                            </div>
                            ${eventType.details ? `
                                <div class="event-details">${eventType.details}</div>
                            ` : ''}
                            ${eventType.subtitle ? `
                                <div class="event-subtitle">${eventType.subtitle}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            timelineGroup.innerHTML = `
                <div class="timeline-date-header">
                    <div class="date-marker">
                        <div class="date-indicator">
                            <span class="date-number">${dateDisplay.day}</span>
                            <span class="date-month">${dateDisplay.month}</span>
                        </div>
                    </div>
                    <div class="date-info">
                        <h4 class="date-title">${formattedDate}</h4>
                        <span class="events-count">${events.length} evento${events.length !== 1 ? 's' : ''}</span>
                    </div>
                </div>
                <div class="timeline-events">
                    ${eventsHtml}
                </div>
            `;

            historialContainer.appendChild(timelineGroup);
        });

        console.log(`Populated ${historial.length} events in ${Object.keys(groupedEvents).length} date groups`);
    }

    // Helper function to get date display components
    function getDateDisplay(dateKey) {
        const date = new Date(dateKey);
        const day = date.getDate().toString();
        const month = date.toLocaleDateString('es-ES', { month: 'short' }).toUpperCase();

        return { day, month };
    }

    // Helper function to get event icon based on type
    function getEventIcon(tipo) {
        const iconMap = {
            'etapa': 'fas fa-route',
            'comentario': 'fas fa-comment',
            'documento': 'fas fa-file-alt',
            'requisito': 'fas fa-tasks',
            'asignacion': 'fas fa-user-plus',
            'inicio': 'fas fa-play-circle',
            'cambio': 'fas fa-exchange-alt'
        };

        return iconMap[tipo] || 'fas fa-circle';
    }

    // Helper function to group events by date
    function groupEventsByDate(historial) {
        const grouped = {};

        historial.forEach(evento => {
            const date = new Date(evento.fecha_inicio || evento.fecha_creacion);
            const dateKey = date.toISOString().split('T')[0]; // YYYY-MM-DD format

            if (!grouped[dateKey]) {
                grouped[dateKey] = [];
            }
            grouped[dateKey].push(evento);
        });

        return grouped;
    }

    // Helper function to format date for group headers
    function formatDateForGroup(dateKey) {
        const date = new Date(dateKey);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (date.toDateString() === today.toDateString()) {
            return 'Hoy';
        } else if (date.toDateString() === yesterday.toDateString()) {
            return 'Ayer';
        } else {
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    }

    // Helper function to format time
    function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Helper function to get user initials
    function getUserInitials(userName) {
        if (!userName || userName === 'Usuario no especificado') {
            return 'U';
        }

        const names = userName.split(' ');
        if (names.length >= 2) {
            return (names[0][0] + names[1][0]).toUpperCase();
        } else if (names.length === 1) {
            return names[0][0].toUpperCase();
        }
        return 'U';
    }

    // Helper function to get user color based on name
    function getUserColor(userName) {
        if (!userName || userName === 'Usuario no especificado') {
            return '#6b7280';
        }

        // Simple hash function to generate consistent colors
        let hash = 0;
        for (let i = 0; i < userName.length; i++) {
            hash = userName.charCodeAt(i) + ((hash << 5) - hash);
        }

        const colors = [
            '#3b82f6', // blue
            '#10b981', // green
            '#f59e0b', // amber
            '#ef4444', // red
            '#8b5cf6', // violet
            '#06b6d4', // cyan
            '#f97316', // orange
            '#ec4899', // pink
            '#84cc16', // lime
            '#6366f1'  // indigo
        ];

        return colors[Math.abs(hash) % colors.length];
    }

    // Helper function to determine event type
    function getEventType(evento) {
        // Use the tipo field if available, otherwise fall back to field detection
        const tipo = evento.tipo;

        if (tipo === 'etapa' || evento.etapa) {
            return {
                tipo: 'etapa',
                title: evento.etapa,
                action: `cambió la etapa a "${evento.etapa}"`,
                details: evento.subestado ? `SubEstado: ${evento.subestado}` : '',
                subtitle: evento.comentarios || ''
            };
        }

        if (tipo === 'comentario' || evento.texto || evento.comentario) {
            return {
                tipo: 'comentario',
                title: 'Comentario',
                action: 'agregó un comentario',
                details: evento.texto || evento.comentario || '',
                subtitle: ''
            };
        }

        if (tipo === 'documento' || evento.archivo || evento.url) {
            return {
                tipo: 'documento',
                title: 'Documento',
                action: evento.archivo ? `subió el documento "${evento.archivo}"` : 'actualizó un documento',
                details: evento.observaciones || '',
                subtitle: ''
            };
        }

        if (tipo === 'requisito' || evento.requisito) {
            return {
                tipo: 'requisito',
                title: 'Requisito',
                action: `marcó como ${evento.cumplido ? 'cumplido' : 'no cumplido'} el requisito "${evento.requisito}"`,
                details: evento.observaciones || '',
                subtitle: ''
            };
        }

        if (tipo === 'asignacion' || evento.usuario_asignado) {
            return {
                tipo: 'asignacion',
                title: 'Asignación',
                action: `asignó la solicitud a ${evento.usuario_asignado}`,
                details: '',
                subtitle: ''
            };
        }

        // Default event
        return {
            tipo: 'cambio',
            title: 'Actividad',
            action: 'realizó una actividad',
            details: evento.descripcion || '',
            subtitle: ''
        };
    }

    // Helper function to determine event status
    function getEventStatus(evento) {
        // Check if it's the current stage
        if (evento.etapa && window.currentModalData?.general?.etapa_actual === evento.etapa) {
            return 'current';
        }

        // Check if it's completed (has end date)
        if (evento.fecha_fin) {
            return 'completed';
        }

        // Check if it's pending
        if (evento.fecha_inicio && !evento.fecha_fin) {
            return 'pending';
        }

        // Default to completed for other events
        return 'completed';
    }

    // Helper function to calculate duration
    function calculateDuration(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
            return '1 día';
        } else if (diffDays < 7) {
            return `${diffDays} días`;
        } else if (diffDays < 30) {
            const weeks = Math.floor(diffDays / 7);
            return `${weeks} semana${weeks > 1 ? 's' : ''}`;
        } else {
            const months = Math.floor(diffDays / 30);
            return `${months} mes${months > 1 ? 'es' : ''}`;
        }
    }

    // Helper function to format date
    function formatDate(dateString) {
        if (!dateString) return 'Fecha no disponible';

        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
            return 'Ayer';
        } else if (diffDays === 0) {
            return 'Hoy';
        } else if (diffDays < 7) {
            return `Hace ${diffDays} días`;
        } else {
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }





    function getMockData(solicitudId) {
        return {
            general: {
                codigo: `SOL-${solicitudId}`,
                estado: 'En Proceso',
                tipo: 'Solicitud de préstamo personal',
                fecha_inicio: '2025-07-01',
                vencimiento: '2025-07-15',
                etapa_actual: 'Evaluación Crediticia',
                area: 'Créditos'
            },
            cliente: {
                nombre: 'Juan Pérez Rodríguez',
                cedula: '1-234-567',
                edad: 30,
                sexo: 'Masculino',
                cartera: 'Cartera A'
            },
            cotizacion: {
                monto: 25000,
                plazo: 36,
                tasa: 12.5,
                cuota: 825.50,
                monto_financiado: 20000,
                tasa_interes: 10.0,
                monto_letra: 21000,
                auxMonto2: 20000 // Added for testing
            },
            acciones: {
                puede_procesar: true,
                puede_devolver: true,
                puede_anular: false,
                puede_comentar: true
            },
            workflow: [
                {
                    nombre: 'Recepción',
                    completada: true,
                    actual: false,
                    sla: '2 días'
                },
                {
                    nombre: 'Verificación',
                    completada: true,
                    actual: false,
                    sla: '1 día'
                },
                {
                    nombre: 'Evaluación',
                    completada: false,
                    actual: true,
                    sla: '3 días'
                },
                {
                    nombre: 'Aprobación',
                    completada: false,
                    actual: false,
                    sla: '2 días'
                },
                {
                    nombre: 'Desembolso',
                    completada: false,
                    actual: false,
                    sla: '1 día'
                }
            ],
            documentos: [
                {
                    id: 1,
                    nombre: 'Cédula de Identidad',
                    url: '/media/documentos/cedula_123.pdf',
                    cumplido: true,
                    observaciones: 'Documento cargado y verificado'
                },
                {
                    id: 2,
                    nombre: 'Comprobante de Ingresos',
                    url: '/media/documentos/ingresos_123.pdf',
                    cumplido: true,
                    observaciones: ''
                },
                {
                    id: 3,
                    nombre: 'Referencias Comerciales',
                    url: '',
                    cumplido: false,
                    observaciones: 'Pendiente por cargar documento actualizado'
                },
                {
                    id: 4,
                    nombre: 'Carta de Trabajo',
                    url: '',
                    cumplido: null,
                    observaciones: 'Documento requerido - debe ser cargado para continuar'
                },
                {
                    id: 5,
                    nombre: 'Estados de Cuenta Bancarios',
                    url: '',
                    cumplido: false,
                    observaciones: 'Últimos 3 meses - debe ser cargado'
                },
                {
                    id: 6,
                    nombre: 'Declaración de Renta',
                    url: '',
                    cumplido: null,
                    observaciones: 'Año fiscal anterior - debe ser cargado'
                }
            ],
            historial: [
                {
                    etapa: 'Recepción',
                    subestado: 'Recibido',
                    usuario: 'Ana García',
                    fecha_inicio: '2025-01-15T09:30:00Z',
                    fecha_fin: '2025-01-15T14:20:00Z'
                },
                {
                    etapa: 'Verificación',
                    subestado: 'En Revisión',
                    usuario: 'Carlos López',
                    fecha_inicio: '2025-01-15T14:20:00Z',
                    fecha_fin: '2025-01-16T11:45:00Z'
                },
                {
                    etapa: 'Evaluación',
                    subestado: 'En Proceso',
                    usuario: 'María Rodríguez',
                    fecha_inicio: '2025-01-16T11:45:00Z',
                    fecha_fin: null
                },
                {
                    texto: 'Documentos recibidos correctamente',
                    usuario: 'Ana García',
                    fecha_creacion: '2025-01-15T10:15:00Z'
                },
                {
                    texto: 'Verificación de ingresos completada',
                    usuario: 'Carlos López',
                    fecha_creacion: '2025-01-15T16:30:00Z'
                },
                {
                    nombre: 'Cédula de Identidad',
                    archivo: '/media/documentos/cedula_123.pdf',
                    usuario: 'Juan Pérez',
                    fecha_creacion: '2025-01-15T11:20:00Z'
                },
                {
                    nombre: 'Comprobante de Ingresos',
                    archivo: '/media/documentos/ingresos_123.pdf',
                    usuario: 'Juan Pérez',
                    fecha_creacion: '2025-01-15T13:45:00Z'
                }
            ]
        };
    }

    // Add debug functionality
    window.testModalSolicitud = function () {
        console.log('Testing modal with mock data...');
        mostrarModalSolicitud('test-123');
    };

    // Add test function for checking button data attribute
    window.testButtonData = function () {
        const button = document.getElementById('modalBtnVerDetalle');
        console.log('Button exists:', button !== null);
        console.log('Button data-solicitud-id:', button ? button.getAttribute('data-solicitud-id') : 'Button not found');
        console.log('Global currentSolicitudId:', window.currentSolicitudId);
        console.log('Button HTML:', button ? button.outerHTML : 'Button not found');

        // Try to trigger click programmatically
        if (button) {
            console.log('Triggering click programmatically...');
            button.click();
        }
    };

    // Add a helper function to test API directly
    window.testApiDirectly = function (solicitudId = 1) {
        console.log('Testing API directly for solicitud:', solicitudId);

        fetch(`/workflow/api/solicitud_brief/${solicitudId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
            }
        })
            .then(response => {
                console.log('API Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API Response data:', data);
                if (data.success) {
                    console.log('API call successful!');
                    populateModalData(data.data);
                } else {
                    console.error('API returned error:', data.error);
                }
            })
            .catch(error => {
                console.error('API call failed:', error);
            });
    };

    // Test upload functionality
    window.testUploadFunctionality = function () {
        console.log('Testing upload functionality...');

        // Show modal first
        mostrarModalSolicitud('test-123');

        // Switch to documentos tab
        setTimeout(() => {
            const documentosTab = document.getElementById('documentos-tab');
            if (documentosTab) {
                documentosTab.click();
                console.log('Switched to documentos tab');

                setTimeout(() => {
                    // Try to find an upload button
                    const uploadButton = document.querySelector('.btn-upload');
                    if (uploadButton) {
                        console.log('Upload button found:', uploadButton);
                        console.log('Upload functionality is ready!');
                    } else {
                        console.log('No upload button found - checking document structure...');
                        const documentItems = document.querySelectorAll('.documento-item');
                        console.log('Found document items:', documentItems.length);
                        documentItems.forEach((item, index) => {
                            console.log(`Document ${index + 1}:`, item);
                        });
                    }
                }, 500);
            }
        }, 1000);
    };

    // Debug function to test document upload with real data
    window.debugDocumentUpload = function () {
        console.log('=== DEBUG DOCUMENT UPLOAD ===');
        console.log('Current solicitud ID:', window.currentSolicitudId);
        console.log('Current modal data:', window.currentModalData);

        if (window.currentModalData && window.currentModalData.documentos) {
            console.log('Documentos in modal data:', window.currentModalData.documentos);
            window.currentModalData.documentos.forEach((doc, index) => {
                console.log(`Documento ${index + 1}:`, {
                    id: doc.id,
                    nombre: doc.nombre,
                    cumplido: doc.cumplido,
                    url: doc.url
                });
            });
        }

        // Test the upload API directly
        const testData = new FormData();
        testData.append('solicitud_id', window.currentSolicitudId || '1');
        testData.append('documento_id', '194'); // Test with a known ID
        testData.append('documento_nombre', 'APC');

        // Create a test file
        const testFile = new File(['test content'], 'test.pdf', { type: 'application/pdf' });
        testData.append('file', testFile);

        console.log('Testing API with data:', {
            solicitud_id: testData.get('solicitud_id'),
            documento_id: testData.get('documento_id'),
            documento_nombre: testData.get('documento_nombre'),
            file: testData.get('file')
        });

        fetch('/workflow/api/upload-documento/', {
            method: 'POST',
            body: testData,
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
            .then(response => response.json())
            .then(data => {
                console.log('API Response:', data);
            })
            .catch(error => {
                console.error('API Error:', error);
            });
    };

    // Auto-test on page load - Wait for DOM to be ready
    function initializeModalWhenReady() {
        if (document.readyState === 'loading') {
            console.log('DOM not ready yet, waiting...');
            document.addEventListener('DOMContentLoaded', initializeModalWhenReady);
            return;
        }

        console.log('Modal script loaded successfully');

        // Initialize modal layout functionality
        initializeModalLayout();

        // Add test button to console
        console.log('To test modal, run: testModalSolicitud()');
        console.log('To test API directly, run: testApiDirectly(1)');
        console.log('To test upload functionality, run: testUploadFunctionality()');
        console.log('To debug document upload, run: debugDocumentUpload()');
        console.log('To test API endpoint, run: testApiEndpoint()');
        console.log('To test historial tab, run: testHistorialTab()');
    }

    // Start the initialization process
    initializeModalWhenReady();

    // Initialize modal layout functionality
    function initializeModalLayout() {
        // Handle window resize for responsive layout
        window.addEventListener('resize', adjustModalLayout);

        // Add click handlers for action buttons
        const btnProcesar = document.getElementById('modalBtnProcesarTarea');
        if (btnProcesar) {
            btnProcesar.addEventListener('click', function () {
                console.log('Procesar tarea clicked');
                // Add your processing logic here
            });
        }

        const btnDevolver = document.getElementById('modalBtnDevolver');
        if (btnDevolver) {
            btnDevolver.addEventListener('click', function () {
                console.log('Devolver clicked');
                // Add your return logic here
            });
        }

        const btnAnular = document.getElementById('modalBtnAnular');
        if (btnAnular) {
            btnAnular.addEventListener('click', function () {
                console.log('Anular clicked');
                // Add your cancel logic here
            });
        }

        const btnComentarios = document.getElementById('modalBtnComentarios');
        if (btnComentarios) {
            btnComentarios.addEventListener('click', function () {
                console.log('Comentarios clicked');
                // Add your comments logic here
            });
        }

        // Add click handler for 'Ver Detalle' button using event delegation
        document.addEventListener('click', function (event) {
            if (event.target && event.target.id === 'modalBtnVerDetalle') {
                let solicitudId = event.target.getAttribute('data-solicitud-id');
                let globalSolicitudId = window.currentSolicitudId;

                console.log('Ver Detalle clicked');
                console.log('Button data-solicitud-id:', solicitudId);
                console.log('Global currentSolicitudId:', globalSolicitudId);
                console.log('Button element:', event.target);

                // Try to get solicitudId from multiple sources
                const finalSolicitudId = solicitudId || globalSolicitudId;

                if (finalSolicitudId && finalSolicitudId !== 'null' && finalSolicitudId !== 'undefined' && finalSolicitudId !== '') {
                    console.log('Navigating to:', `/workflow/solicitud/${finalSolicitudId}/`);
                    window.location.href = `/workflow/solicitud/${finalSolicitudId}/`;
                } else {
                    console.error('No valid solicitud ID found:', {
                        buttonAttribute: solicitudId,
                        globalVariable: globalSolicitudId,
                        buttonElement: event.target
                    });
                    alert('No se pudo determinar el ID de la solicitud.');
                }
            }
        });
    }

    // Adjust modal layout based on screen size
    function adjustModalLayout() {
        const isMobile = window.innerWidth <= 768;
        const modalLayout = document.querySelector('.modal-layout');

        if (modalLayout) {
            if (isMobile) {
                modalLayout.classList.add('mobile-layout');
            } else {
                modalLayout.classList.remove('mobile-layout');
            }
        }
    }

    // ==========================================
    // DOCUMENT UPLOAD FUNCTIONALITY
    // ==========================================

    // Toggle upload area visibility
    function toggleUploadArea(uploadId) {
        const uploadArea = document.getElementById(uploadId);
        const uploadInput = document.getElementById(`${uploadId}-input`);

        if (uploadArea) {
            const isActive = uploadArea.classList.contains('active');
            if (isActive) {
                uploadArea.classList.remove('active');
                resetUploadArea(uploadId);
            } else {
                uploadArea.classList.add('active');
                setupUploadListeners(uploadId);
            }
        }
    }

    // Setup drag and drop listeners
    function setupUploadListeners(uploadId) {
        const uploadArea = document.getElementById(uploadId);
        const uploadInput = document.getElementById(`${uploadId}-input`);

        if (!uploadArea || !uploadInput) return;

        // Click to select file
        uploadArea.addEventListener('click', function (e) {
            if (e.target === uploadArea || e.target.classList.contains('upload-text')) {
                uploadInput.click();
            }
        });

        // File input change
        uploadInput.addEventListener('change', function (e) {
            handleFileSelection(uploadId, e.target.files);
        });

        // Drag and drop events
        uploadArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function (e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function (e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFileSelection(uploadId, e.dataTransfer.files);
        });
    }

    // Handle file selection
    function handleFileSelection(uploadId, files) {
        if (files.length === 0) return;

        const file = files[0];
        const maxSize = 10 * 1024 * 1024; // 10MB
        const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/jpg', 'image/png'];

        // Validate file size
        if (file.size > maxSize) {
            alert('El archivo es demasiado grande. El tamaño máximo permitido es 10MB.');
            return;
        }

        // Validate file type
        if (!allowedTypes.includes(file.type)) {
            alert('Tipo de archivo no permitido. Solo se permiten: PDF, DOC, DOCX, JPG, JPEG, PNG');
            return;
        }

        // Show file preview
        const preview = document.getElementById(`${uploadId}-preview`);
        const buttons = document.getElementById(`${uploadId}-buttons`);

        if (preview && buttons) {
            const fileName = preview.querySelector('.file-name');
            const fileSize = preview.querySelector('.file-size');

            if (fileName) fileName.textContent = file.name;
            if (fileSize) fileSize.textContent = `(${formatFileSize(file.size)})`;

            preview.classList.add('active');
            buttons.classList.add('active');

            // Store file for later upload
            preview.setAttribute('data-file', JSON.stringify({
                name: file.name,
                size: file.size,
                type: file.type
            }));

            // Store actual file object
            window.uploadFiles = window.uploadFiles || {};
            window.uploadFiles[uploadId] = file;
        }
    }

    // Remove selected file
    function removeFile(uploadId) {
        const preview = document.getElementById(`${uploadId}-preview`);
        const buttons = document.getElementById(`${uploadId}-buttons`);
        const uploadInput = document.getElementById(`${uploadId}-input`);

        if (preview) preview.classList.remove('active');
        if (buttons) buttons.classList.remove('active');
        if (uploadInput) uploadInput.value = '';

        // Remove stored file
        if (window.uploadFiles && window.uploadFiles[uploadId]) {
            delete window.uploadFiles[uploadId];
        }
    }

    // Upload document
    async function uploadDocument(uploadId, documentoId, documentoNombre) {
        const file = window.uploadFiles && window.uploadFiles[uploadId];

        if (!file) {
            alert('No se ha seleccionado ningún archivo');
            return;
        }

        console.log('=== UPLOAD DOCUMENT DEBUG ===');
        console.log('uploadId:', uploadId);
        console.log('documentoId:', documentoId);
        console.log('documentoNombre:', documentoNombre);
        console.log('file:', file);
        console.log('currentSolicitudId:', window.currentSolicitudId);

        const confirmBtn = document.querySelector(`#${uploadId}-buttons .btn-upload-confirm`);
        const progressContainer = document.getElementById(`${uploadId}-progress`);
        const progressFill = progressContainer?.querySelector('.progress-fill');

        if (confirmBtn) confirmBtn.disabled = true;
        if (progressContainer) progressContainer.style.display = 'block';

        try {
            // Create FormData
            const formData = new FormData();
            formData.append('file', file);
            formData.append('documento_id', documentoId);
            formData.append('documento_nombre', documentoNombre);
            formData.append('solicitud_id', window.currentSolicitudId || '');

            console.log('FormData contents:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}:`, value);
            }

            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress > 90) progress = 90;
                if (progressFill) progressFill.style.width = progress + '%';
            }, 200);

            // Make upload request
            const response = await fetch('/workflow/api/upload-documento/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            });

            clearInterval(progressInterval);
            if (progressFill) progressFill.style.width = '100%';

            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('HTTP Error:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const result = await response.json();

            console.log('API Response:', result);

            if (result.success) {
                // Success feedback
                showUploadSuccess(uploadId, documentoNombre);

                // Always refresh the documentos section after a short delay
                setTimeout(async () => {
                    console.log('Document uploaded successfully:', result);

                    const currentSolicitudId = window.currentSolicitudId;
                    if (currentSolicitudId && currentSolicitudId !== 'test-123') {
                        try {
                            const refreshResponse = await fetch(`/workflow/api/solicitud/${currentSolicitudId}/documentos/`, {
                                method: 'GET',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Accept': 'application/json',
                                }
                            });

                            if (refreshResponse.ok) {
                                const refreshData = await refreshResponse.json();
                                if (refreshData.success) {
                                    // Update the documentos in the current data and repopulate
                                    console.log('Refreshed document data:', refreshData.documentos);
                                    populateDocumentosTab(refreshData.documentos);
                                }
                            }
                        } catch (refreshError) {
                            console.warn('Could not refresh document list:', refreshError);
                        }
                    } else {
                        // For mock data, manually update the status
                        updateMockDocumentStatus(documentoId || documentoNombre, result.data.file_url);
                    }

                    resetUploadArea(uploadId);
                }, 2000);
            } else {
                throw new Error(result.error || 'Error en la subida del archivo');
            }

        } catch (error) {
            console.error('Upload error:', error);
            alert('Error al subir el archivo: ' + error.message);

            if (confirmBtn) confirmBtn.disabled = false;
            if (progressContainer) progressContainer.style.display = 'none';
        }
    }

    // Cancel upload
    function cancelUpload(uploadId) {
        resetUploadArea(uploadId);
    }

    // Reset upload area
    function resetUploadArea(uploadId) {
        const uploadArea = document.getElementById(uploadId);
        const preview = document.getElementById(`${uploadId}-preview`);
        const buttons = document.getElementById(`${uploadId}-buttons`);
        const progress = document.getElementById(`${uploadId}-progress`);
        const uploadInput = document.getElementById(`${uploadId}-input`);

        if (uploadArea) uploadArea.classList.remove('active');
        if (preview) preview.classList.remove('active');
        if (buttons) buttons.classList.remove('active');
        if (progress) progress.style.display = 'none';
        if (uploadInput) uploadInput.value = '';

        // Remove stored file
        if (window.uploadFiles && window.uploadFiles[uploadId]) {
            delete window.uploadFiles[uploadId];
        }
    }

    // Show upload success message
    function showUploadSuccess(uploadId, documentoNombre) {
        const uploadArea = document.getElementById(uploadId);
        if (uploadArea) {
            uploadArea.innerHTML = `
            <div style="text-align: center; color: #28a745; padding: 1rem;">
                <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <div><strong>¡Documento cargado exitosamente!</strong></div>
                <div style="font-size: 0.875rem; margin-top: 0.25rem;">${documentoNombre}</div>
            </div>
        `;
        }
    }

    // Utility function to format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Get CSRF token for Django
    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }

        // Fallback: try to get from meta tag
        if (!cookieValue) {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                cookieValue = metaTag.getAttribute('content');
            }
        }

        return cookieValue;
    }

    // Show notification function
    function showNotification(message, type = 'info') {
        // Remove any existing notifications
        const existingNotifications = document.querySelectorAll('.toast-notification');
        existingNotifications.forEach(notification => notification.remove());

        // Create notification element
        const notification = document.createElement('div');
        notification.className = `toast-notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <div class="notification-icon">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                </div>
                <div class="notification-message">${message}</div>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        // Add to document
        document.body.appendChild(notification);

        // Show notification
        setTimeout(() => notification.classList.add('show'), 100);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }

    // Update mock document status for testing
    function updateMockDocumentStatus(documentId, fileUrl) {
        // Find the document in mock data and update it
        const currentData = window.currentModalData;
        if (currentData && currentData.documentos) {
            const documento = currentData.documentos.find(doc =>
                doc.id == documentId || doc.nombre === documentId
            );
            if (documento) {
                documento.cumplido = true;
                documento.url = fileUrl;
                documento.observaciones = 'Documento cargado exitosamente';

                // Repopulate the tab with updated data
                populateDocumentosTab(currentData.documentos);
                console.log('Mock document status updated:', documento);
            }
        }
    }

    // Test API endpoint accessibility
    window.testApiEndpoint = function () {
        console.log('=== TESTING API ENDPOINT ===');

        // Test if the endpoint is accessible
        fetch('/workflow/api/upload-documento/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                console.log('GET Response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('GET Response text:', text);
            })
            .catch(error => {
                console.error('GET Error:', error);
            });

        // Test CSRF token
        const csrfToken = getCsrfToken();
        console.log('CSRF Token:', csrfToken);

        // Test with a simple POST request
        const testData = new FormData();
        testData.append('test', 'test');

        fetch('/workflow/api/upload-documento/', {
            method: 'POST',
            body: testData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(response => {
                console.log('POST Response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('POST Response text:', text);
            })
            .catch(error => {
                console.error('POST Error:', error);
            });
    };

    // Test historial tab functionality
    window.testHistorialTab = function () {
        console.log('=== TESTING HISTORIAL TAB ===');

        // Show modal first
        mostrarModalSolicitud('test-123');

        // Switch to historial tab after a short delay
        setTimeout(() => {
            const historialTab = document.getElementById('historial-tab');
            if (historialTab) {
                historialTab.click();
                console.log('Switched to historial tab');

                // Check if timeline is populated
                setTimeout(() => {
                    const timeline = document.querySelector('.timeline');
                    const timelineItems = document.querySelectorAll('.timeline-item');
                    console.log('Timeline found:', timeline !== null);
                    console.log('Timeline items:', timelineItems.length);

                    if (timelineItems.length > 0) {
                        console.log('✅ Historial tab is working correctly!');
                        timelineItems.forEach((item, index) => {
                            console.log(`Item ${index + 1}:`, item.querySelector('.timeline-title')?.textContent);
                        });
                    } else {
                        console.log('❌ No timeline items found');
                    }
                }, 1000);
            } else {
                console.log('❌ Historial tab not found');
            }
        }, 1000);
    };

    // Test APC functionality
    window.testApcFunctionality = function () {
        console.log('=== TESTING APC FUNCTIONALITY ===');

        // Test with a real solicitud ID that has APC
        const testSolicitudId = '1'; // Change this to a real solicitud ID with APC

        console.log('Testing APC status check for solicitud:', testSolicitudId);

        fetch(`/workflow/api/solicitud/${testSolicitudId}/apc-status/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
            .then(response => response.json())
            .then(data => {
                console.log('APC Status API Response:', data);
                if (data.success) {
                    console.log('✅ APC Status API is working!');
                    console.log('APC Info:', data.apc_info);
                } else {
                    console.log('❌ APC Status API error:', data.error);
                }
            })
            .catch(error => {
                console.error('❌ APC Status API request failed:', error);
            });
    };

    // Function to check APC status updates
    async function checkApcStatusUpdate(solicitudId) {
        try {
            const response = await fetch(`/workflow/api/solicitud/${solicitudId}/apc-status/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (data.success && data.apc_info) {
                // Check if there are any APC documents that have changed status
                const currentDocumentos = window.currentModalData?.documentos || [];
                const currentApcDoc = currentDocumentos.find(doc => doc.nombre.toLowerCase() === 'apc');

                if (currentApcDoc) {
                    // Check if APC status has changed
                    if (currentApcDoc.apc_processing !== data.apc_info.apc_processing ||
                        currentApcDoc.cumplido !== data.apc_info.cumplido ||
                        currentApcDoc.apc_status !== data.apc_info.apc_status) {

                        console.log('APC status change detected:', {
                            old: { processing: currentApcDoc.apc_processing, cumplido: currentApcDoc.cumplido, status: currentApcDoc.apc_status },
                            new: { processing: data.apc_info.apc_processing, cumplido: data.apc_info.cumplido, status: data.apc_info.apc_status }
                        });

                        // Update the APC document in the current data
                        Object.assign(currentApcDoc, data.apc_info);

                        // Refresh the documentos tab
                        populateDocumentosTab(window.currentModalData.documentos);

                        // Show a subtle notification
                        if (data.apc_info.apc_processing === false && data.apc_info.cumplido === true) {
                            showApcStatusNotification('APC descargado automáticamente por Makito RPA');
                        } else if (data.apc_info.apc_processing === true) {
                            showApcStatusNotification('APC en proceso por Makito RPA');
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Error checking APC status:', error);
        }
    }

    // Function to show APC status notification
    function showApcStatusNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            z-index: 10000;
            font-weight: 500;
            max-width: 300px;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
        `;

        notification.innerHTML = `
            <i class="fas fa-robot"></i>
            ${message}
        `;

        document.body.appendChild(notification);

        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Auto-refresh APC status every 10 seconds if modal is open and has APC documents
    setInterval(() => {
        const modal = document.getElementById('modalSolicitud');
        if (modal && modal.style.display !== 'none') {
            const currentSolicitudId = window.currentSolicitudId;
            if (currentSolicitudId && currentSolicitudId !== 'test-123') {
                // Check if there are any APC documents being processed
                const currentData = window.currentModalData;
                if (currentData && currentData.documentos) {
                    const hasApcProcessing = currentData.documentos.some(doc =>
                        doc.nombre.toLowerCase() === 'apc' && doc.apc_processing
                    );

                    if (hasApcProcessing) {
                        checkApcStatusUpdate(currentSolicitudId);
                    }
                }
            }
        }
    }, 10000);

    // =====================================
    // DEBIDA DILIGENCIA FUNCTIONALITY
    // =====================================
    
    // Load due diligence status when diligencia tab is activated
    function loadDebidaDiligenciaStatus() {
        if (!currentSolicitudId) {
            console.error('No current solicitud ID available');
            return;
        }
        
        console.log('Loading debida diligencia status for solicitud:', currentSolicitudId);
        
        // Show loading state
        const container = document.getElementById('diligencia-content');
        if (container) {
            container.innerHTML = `
                <div class="loading-placeholder">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando información de debida diligencia...</span>
                    </div>
                </div>
            `;
        }
        
        fetch(`/workflow/api/debida-diligencia/status/${currentSolicitudId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Debida diligencia data received:', data);
                renderDebidaDiligenciaContent(data);
            })
            .catch(error => {
                console.error('Error loading debida diligencia status:', error);
                renderDebidaDiligenciaError();
            });
    }

    function renderDebidaDiligenciaContent(data) {
        const container = document.getElementById('diligencia-content');
        if (!container) return;
        
        const { estado, fecha_solicitud, fecha_completado, busqueda_google, busqueda_registro_publico, comentarios } = data;
        
        let statusIcon = '';
        let statusBadge = '';
        let statusTitle = '';
        let statusSubtitle = '';
        let actionButton = '';
        
        // Status configuration
        if (estado === 'completado') {
            statusIcon = '<i class="fas fa-shield-check text-white"></i>';
            statusBadge = 'completed';
            statusTitle = 'Debida Diligencia Completada';
            statusSubtitle = `Completado el ${formatDate(fecha_completado)}`;
        } else if (estado === 'solicitado') {
            statusIcon = '<i class="fas fa-hourglass-half text-white"></i>';
            statusBadge = 'pending';
            statusTitle = 'Debida Diligencia Solicitada';
            statusSubtitle = `Solicitado el ${formatDate(fecha_solicitud)}`;
        } else if (estado === 'en_progreso') {
            statusIcon = '<i class="fas fa-robot text-white"></i>';
            statusBadge = 'makito-processing';
            statusTitle = 'Makito RPA Procesando';
            statusSubtitle = 'Los documentos están siendo generados automáticamente';
        } else {
            statusIcon = '<i class="fas fa-shield-alt text-white"></i>';
            statusBadge = 'pending';
            statusTitle = 'Debida Diligencia No Iniciada';
            statusSubtitle = 'Solicite la debida diligencia para comenzar';
            actionButton = `
                <button class="btn-diligencia primary" onclick="solicitarDebidaDiligencia()">
                    <i class="fas fa-play"></i>
                    Solicitar Debida Diligencia
                </button>
            `;
        }
        
        // Files section
        let filesSection = '';
        if (estado !== 'no_iniciado') {
            filesSection = `
                <div class="diligencia-files-grid">
                    ${renderFileCard('Búsqueda Google', 'busqueda_google', busqueda_google, estado)}
                    ${renderFileCard('Registro Público', 'busqueda_registro_publico', busqueda_registro_publico, estado)}
                </div>
            `;
        }
        
        // Comments section
        let commentsSection = '';
        if (comentarios) {
            commentsSection = `
                <div class="mt-3">
                    <h6 class="mb-2"><i class="fas fa-comment-alt me-2"></i>Observaciones</h6>
                    <div class="alert alert-info">
                        ${comentarios}
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = `
            <div class="diligencia-status-card">
                <div class="diligencia-header">
                    <div class="diligencia-status-icon bg-${statusBadge === 'completed' ? 'success' : statusBadge === 'makito-processing' ? 'info' : 'warning'}">
                        ${statusIcon}
                    </div>
                    <div class="diligencia-status-info">
                        <h5 class="diligencia-status-title">${statusTitle}</h5>
                        <p class="diligencia-status-subtitle">${statusSubtitle}</p>
                    </div>
                    <div class="diligencia-actions">
                        ${actionButton}
                    </div>
                </div>
                ${commentsSection}
            </div>
            ${filesSection}
        `;
    }

    function renderFileCard(title, type, fileData, estado) {
        let cardClass = 'pending';
        let statusText = 'Pendiente';
        let statusClass = 'pending';
        let actions = '';
        
        if (fileData && fileData.archivo) {
            cardClass = 'completed';
            statusText = 'Completado';
            statusClass = 'completed';
            actions = `
                <button class="btn-diligencia secondary" onclick="downloadFile('${fileData.archivo}')">
                    <i class="fas fa-download"></i>
                    Descargar
                </button>
                <button class="btn-diligencia secondary" onclick="previewFile('${fileData.archivo}')">
                    <i class="fas fa-eye"></i>
                    Ver
                </button>
            `;
        } else if (estado === 'en_progreso') {
            cardClass = 'makito-processing';
            statusText = 'Procesando...';
            statusClass = 'makito-processing';
        } else {
            actions = `
                <input type="file" id="upload-${type}" accept=".pdf" style="display: none;" onchange="uploadFile('${type}', this.files[0])">
                <button class="btn-diligencia primary" onclick="document.getElementById('upload-${type}').click()">
                    <i class="fas fa-upload"></i>
                    Subir Archivo
                </button>
                <button class="btn-diligencia warning" onclick="solicitarMakito('${type}')">
                    <i class="fas fa-robot"></i>
                    Solicitar a Makito
                </button>
            `;
        }
        
        return `
            <div class="diligencia-file-card ${cardClass}">
                <div class="diligencia-file-header">
                    <div class="diligencia-file-icon bg-${statusClass === 'completed' ? 'success' : statusClass === 'makito-processing' ? 'info' : 'warning'} text-white">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="diligencia-file-info">
                        <h6 class="diligencia-file-title">${title}</h6>
                        <span class="diligencia-file-status ${statusClass}">${statusText}</span>
                    </div>
                </div>
                <div class="diligencia-file-actions">
                    ${actions}
                </div>
            </div>
        `;
    }

    function renderDebidaDiligenciaError() {
        const container = document.getElementById('diligencia-content');
        if (!container) return;
        
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle mb-3 text-warning" style="font-size: 3rem;"></i>
                <p class="text-muted">Error al cargar la información de debida diligencia</p>
                <button class="btn-diligencia primary" onclick="loadDebidaDiligenciaStatus()">
                    <i class="fas fa-refresh"></i>
                    Reintentar
                </button>
            </div>
        `;
    }

    function solicitarDebidaDiligencia() {
        if (!currentSolicitudId) {
            console.error('No current solicitud ID available');
            return;
        }
        
        if (!confirm('¿Está seguro que desea solicitar la debida diligencia para esta solicitud?')) {
            return;
        }
        
        executeDebidaDiligenciaRequest(currentSolicitudId);
    }

    function executeDebidaDiligenciaRequest(solicitudId) {
        console.log('Executing debida diligencia request for solicitud:', solicitudId);
        
        fetch(`/workflow/api/debida-diligencia/solicitar/${solicitudId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Debida diligencia request successful:', data);
            showNotification(data.message || 'Debida diligencia solicitada exitosamente', 'success');
            // Reload the diligencia data
            setTimeout(() => {
                loadDebidaDiligenciaStatus();
            }, 1000);
        })
        .catch(error => {
            console.error('Error requesting debida diligencia:', error);
            showNotification('Error al solicitar debida diligencia: ' + error.message, 'error');
        });
    }

    function solicitarMakito(type) {
        if (!currentSolicitudId) {
            console.error('No current solicitud ID available');
            return;
        }
        
        if (!confirm(`¿Está seguro que desea solicitar a Makito RPA generar el documento de ${type.replace('_', ' ')}?`)) {
            return;
        }
        
        console.log('Requesting Makito to generate:', type, 'for solicitud:', currentSolicitudId);
        
        fetch(`/workflow/api/debida-diligencia/solicitar-makito/${currentSolicitudId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                tipo_documento: type
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Makito request successful:', data);
            showNotification(data.message || 'Solicitud enviada a Makito RPA exitosamente', 'success');
            // Reload the diligencia data
            setTimeout(() => {
                loadDebidaDiligenciaStatus();
            }, 1000);
        })
        .catch(error => {
            console.error('Error requesting Makito:', error);
            showNotification('Error al solicitar a Makito: ' + error.message, 'error');
        });
    }

    function uploadFile(type, file) {
        if (!currentSolicitudId) {
            console.error('No current solicitud ID available');
            return;
        }
        
        if (!file) {
            console.error('No file selected');
            return;
        }
        
        if (file.type !== 'application/pdf') {
            alert('Solo se permiten archivos PDF');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            alert('El archivo no puede ser mayor a 10MB');
            return;
        }
        
        const formData = new FormData();
        formData.append('archivo', file);
        formData.append('tipo_documento', type);
        
        fetch(`/workflow/api/debida-diligencia/upload/${currentSolicitudId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('File upload successful:', data);
            showNotification(data.message || 'Archivo subido exitosamente', 'success');
            // Reload the diligencia data
            setTimeout(() => {
                loadDebidaDiligenciaStatus();
            }, 1000);
        })
        .catch(error => {
            console.error('Error uploading file:', error);
            showNotification('Error al subir archivo: ' + error.message, 'error');
        });
    }

    function downloadFile(filePath) {
        if (!filePath) {
            console.error('No file path provided');
            return;
        }
        
        window.open(filePath, '_blank');
    }

    function previewFile(filePath) {
        if (!filePath) {
            console.error('No file path provided');
            return;
        }
        
        window.open(filePath, '_blank');
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            console.error('Error formatting date:', error);
            return 'Fecha inválida';
        }
    }

    // Event listener for diligencia tab activation
    document.addEventListener('DOMContentLoaded', function() {
        const diligenciaTab = document.getElementById('diligencia-tab');
        if (diligenciaTab) {
            diligenciaTab.addEventListener('shown.bs.tab', function (event) {
                console.log('Diligencia tab activated');
                loadDebidaDiligenciaStatus();
            });
        }
    });
</script>