<!-- Modal Overhauled para Detalles de Solicitud -->
<div class="modal fade" id="modalSolicitud" tabindex="-1" aria-labelledby="modalSolicitudLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
        <div class="modal-content modern-modal">
            <div class="modal-header-modern">
                <div class="header-content">
                    <div class="solicitud-header">
                        <div class="solicitud-code-badge">
                            <span class="code-text" id="modalSolicitudCodigo">SOL-000000</span>
                            <span class="status-badge" id="modalSolicitudEstadoBadge">Pendiente</span>
                        </div>
                        

                        
                        <div class="solicitud-type" id="modalSolicitudTipo">Solicitud de pr茅stamo personal</div>
                    </div>
                    <div class="header-actions">
                        <div class="actions-buttons">
                            <button class="action-btn-header warning" id="modalBtnReconsideracion" data-solicitud-id=""
                                title="Solicitar Reconsideraci贸n" style="display: none;" onclick="abrirModalReconsideracion(document.getElementById('modalBtnReconsideracion').dataset.solicitudId)">>
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                        
                        <!--  ICONOS DE ALERTA SUTILES - POSICIN DERECHA -->
                        <div class="documentos-icons-alert" id="documentosIconsAlert" style="display: none;">
                            <!-- Bot贸n de Asociar Entrevista -->
                            <div class="icon-alert asociar-entrevista" id="iconAsociarEntrevista" style="display: flex;" 
                                 title="Asociar entrevista de cliente" 
                                 onclick="manejarClickEntrevista()">
                                <i class="fas fa-link" id="iconAsociarEntrevistaIcon"></i>
                                <span class="status-badge" id="estadoEntrevistaBadge">!</span>
                            </div>
                            
                            <div class="icon-alert urgente" id="iconUrgente" style="display: none;" 
                                 title="Documentos urgentes que requieren correcci贸n" 
                                 onclick="switchToTab('documentos-urgentes')">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span class="count-badge" id="urgenteCountIcon">0</span>
                            </div>
                            <div class="icon-alert pendiente" id="iconPendiente" style="display: none;" 
                                 title="Documentos pendientes por completar" 
                                 onclick="switchToTab('documentos-pendientes')">
                                <i class="fas fa-clock"></i>
                                <span class="count-badge" id="pendienteCountIcon">0</span>
                            </div>
                        </div>
                        
                        <button type="button" class="btn-close-modern" data-bs-dismiss="modal" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-body-modern" id="modalSolicitudBody">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs modal-tabs" id="modalSolicitudTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="informacion-tab" data-bs-toggle="tab"
                            data-bs-target="#informacion" type="button" role="tab" aria-controls="informacion"
                            aria-selected="true">
                            <i class="fas fa-info-circle me-2"></i>Informaci贸n
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="documentos-tab" data-bs-toggle="tab" data-bs-target="#documentos"
                            type="button" role="tab" aria-controls="documentos" aria-selected="false">
                            <i class="fas fa-file-alt me-2"></i>Documentos
                        </button>
                    </li>
                    
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="diligencia-tab" data-bs-toggle="tab" data-bs-target="#diligencia"
                            type="button" role="tab" aria-controls="diligencia" aria-selected="false">
                            <svg class="me-2" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L2 7L3 17H5C5 19.76 7.24 22 10 22C10.33 22 10.67 21.95 11 21.85C11.33 21.95 11.67 22 12 22C12.33 22 12.67 21.95 13 21.85C13.33 21.95 13.67 22 14 22C16.76 22 19 19.76 19 17H21L22 7L12 2ZM12 4.16L19.97 8.33L19.31 15H17C17 16.66 15.66 18 14 18C13.45 18 12.95 17.81 12.54 17.5C12.37 17.81 12.2 18.1 12 18.37C11.8 18.1 11.63 17.81 11.46 17.5C11.05 17.81 10.55 18 10 18C8.34 18 7 16.66 7 15H4.69L4.03 8.33L12 4.16ZM12 6C10.9 6 10 6.9 10 8C10 9.1 10.9 10 12 10C13.1 10 14 9.1 14 8C14 6.9 13.1 6 12 6Z"/>
                            </svg>Debida Diligencia
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notas-tab" data-bs-toggle="tab" data-bs-target="#notas"
                            type="button" role="tab" aria-controls="notas" aria-selected="false">
                            <i class="fas fa-sticky-note me-2"></i>Notas y Recordatorios
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" id="reconsideracion-tab-item">
                        <button class="nav-link" id="reconsideracion-tab" data-bs-toggle="tab" data-bs-target="#reconsideracion"
                            type="button" role="tab" aria-controls="reconsideracion" aria-selected="false">
                            <i class="fas fa-redo me-2"></i>Reconsideraci贸n
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial"
                            type="button" role="tab" aria-controls="historial" aria-selected="false">
                            <i class="fas fa-history me-2"></i>Historial
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="formulario-general-tab" data-bs-toggle="tab" data-bs-target="#formulario-general"
                            type="button" role="tab" aria-controls="formulario-general" aria-selected="false">
                            <i class="fas fa-user-edit me-2"></i>Formulario General
                        </button>
                    </li>
                    <!-- Nuevos tabs -->
                    <li class="nav-item" role="presentation" id="documentos-urgentes-nav" style="display: none;">
                        <button class="nav-link tab-urgente" id="documentos-urgentes-tab" data-bs-toggle="tab" data-bs-target="#documentos-urgentes"
                            type="button" role="tab" aria-controls="documentos-urgentes" aria-selected="false">
                            <i class="fas fa-exclamation-triangle me-2"></i>Documentos Urgentes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link tab-pendiente" id="documentos-pendientes-tab" data-bs-toggle="tab" data-bs-target="#documentos-pendientes"
                            type="button" role="tab" aria-controls="documentos-pendientes" aria-selected="false">
                            <i class="fas fa-clock me-2"></i>Documentos Pendientes
                        </button>
                    </li>
                    <!-- Canal Digital Tab - Only shown for API-created solicitudes -->
                    <li class="nav-item" role="presentation" id="canal-digital-nav" style="display: none;">
                        <button class="nav-link" id="canal-digital-tab" data-bs-toggle="tab" data-bs-target="#canal-digital"
                            type="button" role="tab" aria-controls="canal-digital" aria-selected="false">
                            <i class="fas fa-globe me-2"></i>Canal Digital
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content modal-tab-content" id="modalSolicitudTabContent">
                    <!-- Informaci贸n Tab -->
                    <div class="tab-pane fade show active" id="informacion" role="tabpanel"
                        aria-labelledby="informacion-tab">
                        <!-- Main Content Area -->
                        <div class="modal-main-content">
                            <!-- Workflow Progress Section -->
                            <div class="workflow-section">
                                <div class="section-title">
                                    <i class="fas fa-route me-2"></i>
                                    Ruta del Flujo de Trabajo
                                </div>
                                <div class="workflow-container" id="modalSolicitudWorkflowProgress">
                                    <!-- Workflow progress will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Info Cards Section -->
                        <div class="info-cards-section">
                            <!-- Unified Summary Card -->
                            <div class="summary-card-modern" id="modalSolicitudSummaryCard"
                                style="transition: 0.3s; opacity: 1; transform: translateY(0px);">
                                <!-- Content will be populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Documentos Tab -->
                    <div class="tab-pane fade" id="documentos" role="tabpanel" aria-labelledby="documentos-tab">
                        <div class="documentos-section">
                            <div class="section-title">
                                <i class="fas fa-folder-open me-2"></i>
                                Requisitos y Documentos
                            </div>
                            <div class="documentos-container" id="modalSolicitudDocumentos">
                                <!-- Documentos content will be rendered here -->
                                <div class="loading-placeholder" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando documentos...</span>
                                    </div>
                                </div>
                                <div class="empty-state" style="display: none;">
                                    <i class="fas fa-file-alt mb-3"></i>
                                    <p>No hay documentos disponibles</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Historial Tab -->
                    <div class="tab-pane fade" id="historial" role="tabpanel" aria-labelledby="historial-tab">
                        <div class="historial-section">
                            <div class="section-title">
                                <i class="fas fa-history me-2"></i>
                                Timeline de Eventos
                            </div>
                            <div class="historial-container" id="modalSolicitudHistorial">
                                <!-- Historial content will be rendered here -->
                                <div class="loading-placeholder" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando historial...</span>
                                    </div>
                                </div>
                                <div class="empty-state" style="display: none;">
                                    <i class="fas fa-history mb-3"></i>
                                    <p>No hay eventos en el historial</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Debida Diligencia Tab -->
                    <div class="tab-pane fade" id="diligencia" role="tabpanel" aria-labelledby="diligencia-tab">
                        <div class="diligencia-section">
                            <div class="section-title">
                                <i class="fas fa-shield-check me-2"></i>
                                Debida Diligencia
                            </div>
                            <div class="diligencia-container" id="modalSolicitudDiligencia">
                                <!-- Content will be loaded dynamically -->
                                <div class="loading-placeholder" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando informaci贸n de debida diligencia...</span>
                                    </div>
                                </div>
                                <div id="diligencia-content">
                                    <!-- Default content when no data is loaded yet -->
                                    <div class="empty-state">
                                        <i class="fas fa-shield-alt mb-3 text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted">Cargue la informaci贸n de debida diligencia para mostrar detalles</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario General Tab -->
                    <div class="tab-pane fade" id="formulario-general" role="tabpanel" aria-labelledby="formulario-general-tab">
                        <div class="formulario-general-section">
                            <div class="section-title">
                                <i class="fas fa-user-edit me-2"></i>
                                Formulario General del Cliente
                            </div>
                            <div class="formulario-general-container" id="modalSolicitudFormularioGeneral">
                                
                                <!-- Estado: Sin entrevista asociada - Mostrar b煤squeda integrada -->
                                <div class="busqueda-entrevista-integrada" id="busquedaEntrevistaIntegrada" style="display: block;">
                                    <!-- Informaci贸n del cliente -->
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-user text-blue-600 me-2"></i>
                                            <strong>Cliente:</strong> <span id="clienteNombreFormulario" class="ml-1">Cargando...</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-id-card text-blue-600 me-2"></i>
                                            <strong>C茅dula:</strong> <span id="clienteCedulaFormulario" class="font-mono ml-1">Cargando...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Barra de b煤squeda -->
                                    <div class="mb-4">
                                        <label for="buscarEntrevistaTab" class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-search me-1"></i>Buscar Entrevista
                                        </label>
                                        <div class="relative">
                                            <input type="text" class="form-control" id="buscarEntrevistaTab" 
                                                   placeholder="Refinar b煤squeda por nombre o email (opcional)..." 
                                                   onkeyup="buscarEntrevistasEnTab()">
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <i class="fas fa-filter me-1"></i>Ya filtrado por c茅dula: <span id="filteredByCedulaTab">Cargando...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Resultados de b煤squeda -->
                                    <div id="resultadosEntrevistasTab" class="mb-4">
                                        <div class="text-center p-3">
                                            <i class="fas fa-spinner fa-spin me-2"></i> Buscando entrevistas...
                                        </div>
                                    </div>
                                    
                                    <!-- Entrevista seleccionada -->
                                    <div id="entrevistaSeleccionadaTab" class="p-4 border-2 border-green-500 rounded-md bg-green-50 shadow-sm" style="display: none;">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-check-circle text-green-500 text-xl me-2"></i>
                                            <div>
                                                <strong class="text-gray-700">Entrevista seleccionada:</strong>
                                                <span id="nombreEntrevistaSeleccionadaTab" class="font-medium ml-1"></span>
                                            </div>
                                        </div>
                                        <div class="text-sm mb-3">
                                            <strong class="text-gray-700">C茅dula:</strong>
                                            <span id="cedulaEntrevistaSeleccionadaTab" class="font-mono font-medium ml-1"></span>
                                        </div>
                                        <button type="button" class="btn btn-success" id="btnConfirmarAsociacionTab" onclick="confirmarAsociacionEnTab()">
                                            <i class="fas fa-link me-1"></i> Confirmar Asociaci贸n
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Estado: Entrevista asociada - Mostrar datos -->
                                <div class="entrevista-asociada" id="entrevistaAsociada" style="display: none;">
                                    <div class="entrevista-info">
                                        <h6>Entrevista Asociada</h6>
                                        <div class="entrevista-details">
                                            <p><strong>Cliente:</strong> <span id="entrevistaClienteNombre"></span></p>
                                            <p><strong>C茅dula:</strong> <span id="entrevistaClienteCedula"></span></p>
                                            <p><strong>Email:</strong> <span id="entrevistaClienteEmail"></span></p>
                                            <p><strong>Tel茅fono:</strong> <span id="entrevistaClienteTelefono"></span></p>
                                            <p><strong>Fecha:</strong> <span id="entrevistaFecha"></span></p>
                                        </div>
                                        <div class="entrevista-actions mt-3">
                                            <button class="btn btn-outline-primary" onclick="mostrarBusquedaEntrevista()">
                                                <i class="fas fa-edit me-1"></i>Cambiar Entrevista
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="desasociarEntrevista()">
                                                <i class="fas fa-unlink me-1"></i>Desasociar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notas y Recordatorios Tab -->
                    <div class="tab-pane fade" id="notas" role="tabpanel" aria-labelledby="notas-tab">
                        <div class="notas-section">
                            <div class="section-header">
                                <div class="section-title">
                                    <i class="fas fa-sticky-note me-2"></i>
                                    Notas y Recordatorios
                                </div>
                                <button class="btn btn-primary btn-sm" id="btnNuevaNota" onclick="abrirModalNuevaNota()">
                                    <i class="fas fa-plus me-1"></i>Nueva Nota/Recordatorio
                                </button>
                            </div>
                            
                            <!-- Filtros -->
                            <div class="filtros-notas mb-3">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm" id="filtroTipoNota">
                                            <option value="">Todos los tipos</option>
                                            <option value="nota">Notas</option>
                                            <option value="recordatorio">Recordatorios</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm" id="filtroEstadoNota">
                                            <option value="">Todos los estados</option>
                                            <option value="pendiente">Pendiente</option>
                                            <option value="completado">Completado</option>
                                            <option value="vencido">Vencido</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm" id="filtroPrioridadNota">
                                            <option value="">Todas las prioridades</option>
                                            <option value="Alta">Alta</option>
                                            <option value="Media">Media</option>
                                            <option value="Baja">Baja</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="limpiarFiltrosNotas()">
                                            <i class="fas fa-filter-circle-xmark me-1"></i>Limpiar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="notas-container" id="modalSolicitudNotas">
                                <!-- Notas content will be rendered here -->
                                <div class="loading-placeholder" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando notas...</span>
                                    </div>
                                </div>
                                <div class="empty-state" style="display: none;">
                                    <i class="fas fa-sticky-note mb-3 text-muted" style="font-size: 3rem;"></i>
                                    <p class="text-muted">No hay notas o recordatorios</p>
                                    <button class="btn btn-primary" onclick="abrirModalNuevaNota()">
                                        <i class="fas fa-plus me-1"></i>Crear primera nota
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Documentos Urgentes Tab -->
                    <div class="tab-pane fade" id="documentos-urgentes" role="tabpanel" aria-labelledby="documentos-urgentes-tab">
                        <div class="documentos-urgentes-section">
                            <div class="section-title text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Documentos Urgentes
                                <small class="text-muted ms-2">(Requieren correcci贸n inmediata)</small>
                            </div>
                            <div class="documentos-urgentes-container" id="modalSolicitudDocumentosUrgentes">
                                <!-- Documentos urgentes content will be rendered here -->
                                <div class="loading-placeholder" style="display: none;">
                                    <div class="spinner-border text-danger" role="status">
                                        <span class="visually-hidden">Cargando documentos urgentes...</span>
                                    </div>
                                </div>
                                <div class="empty-state" style="display: none;">
                                    <i class="fas fa-check-circle mb-3 text-success"></i>
                                    <p class="text-success">隆Excelente! No hay documentos urgentes pendientes</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reconsideraci贸n Tab -->
                    <div class="tab-pane fade" id="reconsideracion" role="tabpanel" aria-labelledby="reconsideracion-tab">
                        <div class="reconsideracion-section">
                            <div class="section-header">
                                <div class="section-title">
                                    <i class="fas fa-redo me-2"></i>
                                    Reconsideraci贸n
                                </div>
                                <div class="header-actions-group">
                                    <button class="btn-reconsideracion-primary" id="btnSolicitarReconsideracion" onclick="abrirModalReconsideracion(currentSolicitudId)" style="display: none;">
                                        <i class="fas fa-plus me-1"></i>Solicitar Reconsideraci贸n
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Estado de Reconsideraci贸n -->
                            <div class="reconsideracion-status mb-4" id="reconsideracionStatus">
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span id="reconsideracionStatusText">Verificando estado de reconsideraci贸n...</span>
                                </div>
                            </div>

                            <!-- Historial de Reconsideraciones -->
                            <div class="reconsideracion-historial" id="reconsideracionHistorial">
                                <h6 class="mb-3">
                                    <i class="fas fa-history me-2"></i>
                                    Historial de Reconsideraciones
                                </h6>
                                <div class="historial-container" id="modalSolicitudReconsideraciones">
                                    <!-- Reconsideraciones content will be rendered here -->
                                    <div class="loading-placeholder" style="display: none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando historial...</span>
                                        </div>
                                    </div>
                                    <div class="empty-state" style="display: none;">
                                        <i class="fas fa-redo mb-3 text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted">No hay reconsideraciones para esta solicitud</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Documentos Pendientes Tab -->
                    <div class="tab-pane fade" id="documentos-pendientes" role="tabpanel" aria-labelledby="documentos-pendientes-tab">
                        <div class="documentos-pendientes-section">
                            <div class="section-title text-warning">
                                <i class="fas fa-clock me-2"></i>
                                Documentos Pendientes
                                <small class="text-muted ms-2">(Opcionales - pueden cargarse cuando est茅n disponibles)</small>
                            </div>
                            <div class="documentos-pendientes-container" id="modalSolicitudDocumentosPendientes">
                                <!-- Documentos pendientes content will be rendered here -->
                                <div class="loading-placeholder" style="display: none;">
                                    <div class="spinner-border text-warning" role="status">
                                        <span class="visually-hidden">Cargando documentos pendientes...</span>
                                    </div>
                                </div>
                                <div class="empty-state" style="display: none;">
                                    <i class="fas fa-folder-open mb-3"></i>
                                    <p>No hay documentos pendientes disponibles</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Canal Digital Tab -->
                    <div class="tab-pane fade" id="canal-digital" role="tabpanel" aria-labelledby="canal-digital-tab">
                        <div class="canal-digital-section">
                            <div class="section-title text-info">
                                <i class="fas fa-globe me-2"></i>
                                Informaci贸n del Canal Digital
                                <small class="text-muted ms-2">(Solicitud creada v铆a API externa)</small>
                            </div>
                            <div class="canal-digital-container" id="modalSolicitudCanalDigital">
                                <!-- Canal Digital content will be rendered here -->
                                <div class="loading-placeholder" style="display: none;">
                                    <div class="spinner-border text-info" role="status">
                                        <span class="visually-hidden">Cargando informaci贸n del canal digital...</span>
                                    </div>
                                </div>
                                <div class="empty-state" style="display: none;">
                                    <i class="fas fa-globe mb-3 text-muted" style="font-size: 3rem;"></i>
                                    <p class="text-muted">No hay informaci贸n del canal digital disponible</p>
                                </div>
                                <div id="canal-digital-content" style="display: none;">
                                    <!-- API Information -->
                                    <div class="api-info-card mb-4">
                                        <div class="card">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-code me-2"></i>
                                                    Informaci贸n de la API
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label class="form-label fw-bold">Fuente de la API:</label>
                                                            <div class="form-control-plaintext" id="apiSourceDisplay">-</div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label fw-bold">Fecha de Creaci贸n:</label>
                                                            <div class="form-control-plaintext" id="apiCreationDate">-</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label class="form-label fw-bold">M茅todo de Creaci贸n:</label>
                                                            <div class="form-control-plaintext" id="apiCreationMethod">-</div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label fw-bold">Estado de la API:</label>
                                                            <div class="form-control-plaintext" id="apiStatus">-</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Observaciones -->
                                    <div class="observaciones-card">
                                        <div class="card">
                                            <div class="card-header bg-secondary text-white">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-comment me-2"></i>
                                                    Observaciones de la Solicitud
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Observaciones:</label>
                                                    <div class="form-control-plaintext" id="apiObservaciones" style="white-space: pre-wrap; min-height: 100px;">-</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    /* === CSS VARIABLES === */
    :root {
        --verde-pacifico: #009c3c;
        --verde-pacifico-hover: #007e31;
        --verde-pacifico-light: #22a650;
        --verde-pacifico-ultra-light: #e8f5e8;
        
        /* Enhanced Color Palette */
        --primary-blue: #0066cc;
        --primary-blue-hover: #0052a3;
        --secondary-blue: #4285f4;
        --accent-teal: #00bcd4;
        --accent-teal-hover: #00acc1;
        
        --success-green: #28a745;
        --success-green-light: #d4edda;
        --warning-orange: #fd7e14;
        --warning-orange-light: #fff3cd;
        --danger-red: #dc3545;
        --danger-red-light: #f8d7da;
        --info-cyan: #17a2b8;
        --info-cyan-light: #d1ecf1;
        
        --neutral-100: #f8f9fa;
        --neutral-200: #e9ecef;
        --neutral-300: #dee2e6;
        --neutral-400: #ced4da;
        --neutral-500: #adb5bd;
        --neutral-600: #6c757d;
        --neutral-700: #495057;
        --neutral-800: #343a40;
        --neutral-900: #212529;
        
        --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* === ESTILOS PARA ICONOS DE ALERTA SUTILES === */
    .documentos-icons-alert {
        display: flex;
        gap: 8px;
        margin: 0 12px;
        align-items: center;
    }

    .icon-alert {
        position: relative;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        flex-shrink: 0; /* Evitar que se comprima */
        overflow: visible; /* Permitir que el badge se vea fuera del contenedor */
    }

    .icon-alert.urgente {
        background: linear-gradient(135deg, #ff4757, #ff3838);
        box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
        animation: pulseSubtle 2s infinite;
    }

    .icon-alert.pendiente {
        background: linear-gradient(135deg, #ffa502, #ff9500);
        box-shadow: 0 2px 8px rgba(255, 165, 2, 0.3);
    }

    .icon-alert.asociar-entrevista {
        background: linear-gradient(135deg, #17a2b8, #138496);
        box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        position: relative;
        overflow: visible;
    }

    .icon-alert.asociar-entrevista.asociada {
        background: linear-gradient(135deg, #28a745, #20c997);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        position: relative;
        overflow: visible;
    }

    @keyframes pulseSubtle {
        0%, 100% { 
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
            transform: scale(1);
        }
        50% { 
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.5);
            transform: scale(1.05);
        }
    }

    .icon-alert:hover {
        transform: scale(1.1);
        filter: brightness(1.1);
    }

    .icon-alert.urgente:hover {
        box-shadow: 0 4px 16px rgba(255, 71, 87, 0.6);
    }

    .icon-alert.pendiente:hover {
        box-shadow: 0 4px 16px rgba(255, 165, 2, 0.6);
    }

    .icon-alert.asociar-entrevista:hover {
        box-shadow: 0 4px 16px rgba(23, 162, 184, 0.6);
    }

    .icon-alert.asociar-entrevista.asociada:hover {
        box-shadow: 0 4px 16px rgba(40, 167, 69, 0.6);
    }

    .count-badge, .icon-alert .status-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: white;
        color: #333;
        font-size: 10px;
        font-weight: bold;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        border: 2px solid rgba(255,255,255,1);
        line-height: 1;
        z-index: 10;
        transform: translateX(0) translateY(0);
    }

    /* Correcci贸n espec铆fica para el badge de asociar entrevista */
    #estadoEntrevistaBadge {
        position: absolute !important;
        top: -8px !important;
        right: -8px !important;
        background: white !important;
        color: #333 !important;
        font-size: 10px !important;
        font-weight: bold !important;
        width: 18px !important;
        height: 18px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
        border: 2px solid rgba(255,255,255,1) !important;
        line-height: 1 !important;
        z-index: 15 !important;
        transform: none !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    .icon-alert .status-badge.asociada {
        background: #28a745;
        color: white;
        border: 1px solid rgba(40, 167, 69, 0.8);
    }

    /* Responsive para iconos */
    @media (max-width: 768px) {
        .icon-alert {
            width: 28px;
            height: 28px;
            font-size: 12px;
        }
        
        .count-badge, .icon-alert .status-badge {
            width: 14px;
            height: 14px;
            font-size: 9px;
            top: -3px;
            right: -3px;
        }
    }

    /* === OTRAS VARIABLES CSS === */
    :root {
        --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.12);
        --shadow-heavy: 0 8px 16px rgba(0, 0, 0, 0.15);
        --border-radius-sm: 6px;
        --border-radius-md: 8px;
        --border-radius-lg: 12px;
        --transition-fast: 0.2s ease;
        --transition-medium: 0.3s ease;
    }

    /* === MODERN MODAL STYLES === */
    .modern-modal {
        border: none;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        max-height: 95vh;
    }

    .modal-header-modern {
        background: linear-gradient(135deg, #009c3c 0%, #00b84a 50%, #22a650 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-bottom: none;
        position: relative;
        overflow: hidden;
    }

    .modal-header-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        pointer-events: none;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 1;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .actions-buttons {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .action-btn-header {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
    }

    .action-btn-header:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .action-btn-header:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .action-btn-header.primary {
        background: rgba(255, 255, 255, 0.2);
    }

    .action-btn-header.primary:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
    }

    .action-btn-header.secondary {
        background: rgba(255, 255, 255, 0.2);
    }

    .action-btn-header.secondary:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
    }

    .action-btn-header.danger {
        background: rgba(220, 53, 69, 0.8);
    }

    .action-btn-header.danger:hover:not(:disabled) {
        background: rgba(220, 53, 69, 1);
    }

    .action-btn-header.info {
        background: rgba(255, 255, 255, 0.2);
    }

    .action-btn-header.info:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
    }

    .action-btn-header.warning {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .action-btn-header.warning:hover:not(:disabled) {
        background: rgba(255, 193, 7, 0.3);
        transform: translateY(-1px);
    }

    .solicitud-header {
        flex: 1;
    }

    .solicitud-code-badge {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .code-text {
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    .status-badge {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        position: static !important;
        display: inline-block !important;
    }

    /* Asegurar que el status-badge dentro del solicitud-code-badge no se mueva */
    .solicitud-code-badge .status-badge {
        position: static !important;
        top: auto !important;
        right: auto !important;
        transform: none !important;
    }

    .solicitud-type {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 500;
    }

    .btn-close-modern {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .btn-close-modern:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .modal-body-modern {
        padding: 0;
        background: #f8f9fa;
        max-height: calc(95vh - 120px);
        overflow-y: auto;
    }

    /* === TAB STYLES === */
    .modal-tabs {
        background: white;
        border-bottom: 1px solid #dee2e6;
        margin: 0;
        padding: 0 2rem;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        flex-wrap: nowrap;
    }

    .modal-tabs::-webkit-scrollbar {
        height: 6px;
    }

    .modal-tabs::-webkit-scrollbar-track {
        background: #f1f3f4;
        border-radius: 3px;
    }

    .modal-tabs::-webkit-scrollbar-thumb {
        background: #c1c8cd;
        border-radius: 3px;
    }

    .modal-tabs::-webkit-scrollbar-thumb:hover {
        background: #a8b3ba;
    }

    .modal-tabs .nav-item {
        flex-shrink: 0;
    }

    .modal-tabs .nav-link {
        border: none;
        border-radius: 0;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.5rem;
        position: relative;
        transition: all 0.3s ease;
    }

    .modal-tabs .nav-link:hover {
        border-color: transparent;
        color: var(--verde-pacifico);
        background: transparent;
    }

    .modal-tabs .nav-link.active {
        color: var(--verde-pacifico);
        background: transparent;
        border-color: transparent;
        font-weight: 600;
    }

    .modal-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--verde-pacifico);
        border-radius: 3px 3px 0 0;
    }

    /* === CONSISTENT TAB STYLING === */
    .modal-tabs .nav-link#diligencia-tab {
        color: #6c757d;
        font-weight: 500;
        background: transparent;
        border: none;
    }

    .modal-tabs .nav-link#diligencia-tab:hover {
        color: var(--verde-pacifico);
        background: transparent;
    }

    .modal-tabs .nav-link#diligencia-tab.active {
        color: var(--verde-pacifico);
        background: transparent;
        font-weight: 600;
    }

    /* === NUEVOS TABS COLORES === */
    .modal-tabs .nav-link.tab-urgente {
        color: #dc3545;
        font-weight: 600;
    }

    .modal-tabs .nav-link.tab-urgente:hover {
        color: #b02a37;
        background: rgba(220, 53, 69, 0.05);
    }

    .modal-tabs .nav-link.tab-urgente.active {
        color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }

    .modal-tabs .nav-link.tab-urgente.active::after {
        background: #dc3545;
    }

    .modal-tabs .nav-link.tab-pendiente {
        color: #ffc107;
        font-weight: 500;
    }

    .modal-tabs .nav-link.tab-pendiente:hover {
        color: #d39e00;
        background: rgba(255, 193, 7, 0.05);
    }

    .modal-tabs .nav-link.tab-pendiente.active {
        color: #856404;
        background: rgba(255, 193, 7, 0.1);
    }

    .modal-tabs .nav-link.tab-pendiente.active::after {
        background: #ffc107;
    }

    .modal-tab-content {
        background: #f8f9fa;
    }

    .modal-tab-content .tab-pane {
        padding: 2rem;
    }

    /* === DOCUMENTOS SECTION === */
    .documentos-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--verde-pacifico);
    }

    /* === HISTORIAL SECTION === */
    .historial-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--verde-pacifico);
    }

    /* === DOCUMENTOS URGENTES SECTION === */
    .documentos-urgentes-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #dc3545;
    }

    .documentos-urgentes-container {
        min-height: 200px;
    }

    /* === DOCUMENTOS PENDIENTES SECTION === */
    .documentos-pendientes-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #ffc107;
    }

    .documentos-pendientes-container {
        min-height: 200px;
    }

    /* === DOCUMENTO URGENTE STYLES === */
    .documento-item.urgente {
        border-left-color: #dc3545;
        background: linear-gradient(135deg, #ffffff 0%, #fff5f5 100%);
        border: 2px solid rgba(220, 53, 69, 0.2);
    }

    .documento-item.urgente:hover {
        border-color: #dc3545;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.15);
    }

    .documento-status.urgente {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #dc3545;
    }

    /* === DOCUMENTO PENDIENTE STYLES === */
    .documento-item.pendiente-opcional {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, #ffffff 0%, #fffef8 100%);
        border: 1px solid rgba(255, 193, 7, 0.2);
    }

    .documento-item.pendiente-opcional:hover {
        border-color: #ffc107;
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);
    }

    .documento-status.pendiente-opcional {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffc107;
    }

    /* === REEMPLAZAR BUTTON === */
    .btn-documento.btn-replace {
        background: #fd7e14;
        color: white;
        border: none;
        cursor: pointer;
    }

    .btn-documento.btn-replace:hover {
        background: #e76500;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* === DOCUMENTO INFO EXTRAS === */
    .documento-calificacion-info {
        margin-top: 8px;
        padding: 8px 12px;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        font-size: 0.85em;
        color: #721c24;
    }

    .documento-calificacion-info.malo {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .documento-calificacion-info.pendiente {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }

    .documento-meta {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .documento-usuario {
        font-weight: 500;
    }

    .documento-fecha {
        font-style: italic;
    }

    /* === BADGES PARA FLUJO OFICIAL-BACKOFFICE === */
    .documento-badge-oficial {
        display: inline-flex;
        align-items: center;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin: 4px 4px 0 0;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }

    .documento-badge-pendiente {
        display: inline-flex;
        align-items: center;
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: #212529;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin: 4px 4px 0 0;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
    }

    .badge-text {
        font-size: 0.7rem;
        letter-spacing: 0.3px;
    }

    .documento-badge-oficial i {
        font-size: 0.8rem;
        margin-right: 3px;
    }

    .documento-badge-pendiente i {
        font-size: 0.8rem;
        margin-right: 3px;
    }

    .historial-container {
        min-height: 200px;
    }

    /* === DEBIDA DILIGENCIA SECTION === */
    .diligencia-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--verde-pacifico);
    }

    .diligencia-container {
        min-height: 200px;
    }

    /* === RECONSIDERACIN SECTION === */
    .reconsideracion-section {
        background: white;
        border-radius: var(--border-radius-md);
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-medium);
        border-left: 4px solid var(--warning-orange);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 12px;
    }

    .header-actions-group {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* === ENHANCED BUTTON STYLES === */
    .btn-cotizaciones {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: var(--border-radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        transition: all var(--transition-medium);
        box-shadow: var(--shadow-light);
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        cursor: pointer;
    }

    .btn-cotizaciones:hover {
        background: linear-gradient(135deg, var(--primary-blue-hover) 0%, var(--primary-blue) 100%);
        transform: translateY(-1px);
        box-shadow: var(--shadow-medium);
        color: white;
    }

    .btn-cotizaciones:active {
        transform: translateY(0);
    }

    .btn-reconsideracion-primary {
        background: linear-gradient(135deg, var(--verde-pacifico) 0%, var(--verde-pacifico-light) 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: var(--border-radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        transition: all var(--transition-medium);
        box-shadow: var(--shadow-light);
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        cursor: pointer;
    }

    .btn-reconsideracion-primary:hover {
        background: linear-gradient(135deg, var(--verde-pacifico-hover) 0%, var(--verde-pacifico) 100%);
        transform: translateY(-1px);
        box-shadow: var(--shadow-medium);
        color: white;
    }

    .btn-reconsideracion-primary:active {
        transform: translateY(0);
    }

    /* === COTIZACIONES SECTION === */
    .cotizaciones-cliente-section {
        background: var(--neutral-100);
        border-radius: var(--border-radius-lg);
        padding: 20px;
        margin-bottom: 20px;
        border: 2px solid var(--primary-blue);
        animation: slideDown 0.3s ease-out;
    }

    /* === COTIZACIONES SECTION FOR RECONSIDERACION MODAL === */
    .cotizaciones-cliente-section-reconsideracion {
        background: var(--neutral-100);
        border-radius: var(--border-radius-lg);
        padding: 16px;
        margin-bottom: 16px;
        border: 2px solid var(--primary-blue);
        animation: slideDown 0.3s ease-out;
    }

    .cotizaciones-header-reconsideracion {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--primary-blue);
    }

    .cotizaciones-title-reconsideracion {
        margin: 0;
        color: var(--primary-blue);
        font-weight: 600;
        font-size: 1rem;
    }

    .btn-close-cotizaciones-reconsideracion {
        background: var(--danger-red);
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: 0.75rem;
    }

    .btn-close-cotizaciones-reconsideracion:hover {
        background: #c82333;
        transform: scale(1.1);
    }

    .cotizaciones-container-reconsideracion {
        min-height: 100px;
    }

    .loading-cotizaciones-reconsideracion {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 30px;
        color: var(--primary-blue);
        font-size: 0.9rem;
    }

    .empty-cotizaciones-reconsideracion {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 30px;
        text-align: center;
    }

    .cotizaciones-grid-reconsideracion {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 12px;
        max-height: 400px;
        overflow-y: auto;
    }

    .cotizaciones-grid-reconsideracion .cotizacion-card {
        padding: 12px;
        font-size: 0.875rem;
    }

    .cotizaciones-grid-reconsideracion .cotizacion-card:hover {
        transform: translateY(-1px);
    }

    .cotizaciones-grid-reconsideracion .cotizacion-header {
        margin-bottom: 8px;
    }

    .cotizaciones-grid-reconsideracion .cotizacion-details {
        gap: 6px;
        margin-bottom: 8px;
    }

    .cotizaciones-grid-reconsideracion .cotizacion-actions {
        margin-top: 8px;
        padding-top: 8px;
    }

    .cotizaciones-grid-reconsideracion .btn-ver-cotizacion {
        padding: 4px 8px;
        font-size: 0.75rem;
    }

    .cotizaciones-grid-reconsideracion .btn-seleccionar-cotizacion {
        background: var(--verde-pacifico);
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: var(--border-radius-sm);
        font-size: 0.75rem;
        font-weight: 500;
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .cotizaciones-grid-reconsideracion .btn-seleccionar-cotizacion:hover {
        background: var(--verde-pacifico-hover);
        color: white;
    }

    .cotizaciones-grid-reconsideracion .cotizacion-card.selected {
        border: 2px solid var(--verde-pacifico);
        background: var(--verde-pacifico-ultra-light);
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .cotizaciones-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--primary-blue);
    }

    .cotizaciones-title {
        margin: 0;
        color: var(--primary-blue);
        font-weight: 600;
        font-size: 1.1rem;
    }

    .btn-close-cotizaciones {
        background: var(--danger-red);
        color: white;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: 0.875rem;
    }

    .btn-close-cotizaciones:hover {
        background: #c82333;
        transform: scale(1.1);
    }

    .cotizaciones-container {
        min-height: 120px;
    }

    .loading-cotizaciones {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: var(--primary-blue);
        font-size: 0.95rem;
    }

    .empty-cotizaciones {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        text-align: center;
    }

    .cotizaciones-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 16px;
    }

    .cotizacion-card {
        background: white;
        border-radius: var(--border-radius-md);
        padding: 16px;
        border: 1px solid var(--neutral-300);
        box-shadow: var(--shadow-light);
        transition: all var(--transition-medium);
        position: relative;
        overflow: hidden;
    }

    .cotizacion-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, var(--accent-teal) 0%, var(--primary-blue) 100%);
    }

    .cotizacion-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        border-color: var(--primary-blue);
    }

    .cotizacion-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .cotizacion-numero {
        font-weight: 600;
        color: var(--primary-blue);
        font-size: 0.95rem;
    }

    .cotizacion-tipo {
        background: var(--info-cyan-light);
        color: var(--info-cyan);
        padding: 4px 8px;
        border-radius: var(--border-radius-sm);
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .cotizacion-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
    }

    .cotizacion-detail {
        font-size: 0.875rem;
    }

    .cotizacion-detail strong {
        color: var(--neutral-700);
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
    }

    .cotizacion-detail span {
        color: var(--neutral-900);
        font-weight: 500;
    }

    .cotizacion-monto {
        grid-column: 1 / -1;
        text-align: center;
        padding: 8px;
        background: var(--verde-pacifico-ultra-light);
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--verde-pacifico-light);
    }

    .cotizacion-monto strong {
        color: var(--verde-pacifico);
        font-size: 1.1rem;
    }

    .cotizacion-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--neutral-200);
    }

    .cotizacion-fecha {
        font-size: 0.75rem;
        color: var(--neutral-600);
    }

    .btn-ver-cotizacion {
        background: var(--accent-teal);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: var(--border-radius-sm);
        font-size: 0.8rem;
        font-weight: 500;
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .btn-ver-cotizacion:hover {
        background: var(--accent-teal-hover);
        color: white;
    }

    /* Summary Ver Cotizaci贸n Button Styles */
    .btn-ver-cotizacion-summary:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%) !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4) !important;
    }

    .btn-ver-cotizacion-summary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3) !important;
    }

    .btn-ver-cotizacion-summary:disabled {
        background: #9ca3af !important;
        cursor: not-allowed;
        transform: none;
        box-shadow: none !important;
    }

    .cotizacion-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        text-align: center;
        grid-column: 1 / -1;
    }

    /* === RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
        .header-actions-group {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }

        .btn-cotizaciones,
        .btn-reconsideracion-primary {
            width: 100%;
            justify-content: center;
        }

        .cotizaciones-grid {
            grid-template-columns: 1fr;
        }

        .cotizacion-details {
            grid-template-columns: 1fr;
        }

        .cotizaciones-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .section-header {
            flex-direction: column;
            align-items: stretch;
        }
    }

    @media (max-width: 480px) {
        .cotizacion-card {
            margin: 0 -8px;
        }

        .cotizaciones-cliente-section {
            margin: 0 -8px;
            border-radius: var(--border-radius-md);
        }

        .modal-tab-content .tab-pane {
            padding: 1rem;
        }
    }

    .reconsideracion-status .alert {
        border-radius: 8px;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .reconsideracion-historial {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        border: 1px solid #e9ecef;
    }

    .historial-container {
        min-height: 100px;
    }

    .loading-placeholder, .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        text-align: center;
    }

    .reconsideracion-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #007bff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .reconsideracion-item.aprobada {
        border-left-color: #28a745;
    }

    .reconsideracion-item.rechazada {
        border-left-color: #dc3545;
    }

    .reconsideracion-item.en_revision {
        border-left-color: #ffc107;
    }

    .reconsideracion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .reconsideracion-numero {
        font-weight: bold;
        color: #495057;
    }

    .reconsideracion-fecha {
        font-size: 0.9em;
        color: #6c757d;
    }

    .reconsideracion-estado {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .estado-enviada {
        background-color: #e3f2fd;
        color: #1976d2;
    }

    .estado-en_revision {
        background-color: #fff3cd;
        color: #856404;
    }

    .estado-aprobada {
        background-color: #d4edda;
        color: #155724;
    }

    .estado-rechazada {
        background-color: #f8d7da;
        color: #721c24;
    }

    .estado-enviada_comite {
        background-color: #f3e5f5;
        color: #7b1fa2;
    }

    .reconsideracion-motivo {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 6px;
        border-left: 3px solid #6c757d;
        margin: 10px 0;
        font-style: italic;
    }

    .reconsideracion-details {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        font-size: 0.9em;
        color: #6c757d;
    }

    .reconsideracion-detail-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .diligencia-container {
        min-height: 200px;
    }

    .diligencia-status-card {
        background: linear-gradient(135deg, #f8fffe 0%, #f0fcf5 100%);
        border: 1px solid #e2f5e8;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }

    .diligencia-status-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--verde-pacifico) 0%, #22a650 100%);
    }

    .diligencia-header {
        display: flex;
        align-items: center;
        justify-content: between;
        margin-bottom: 20px;
    }

    .diligencia-status-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 20px;
    }

    .diligencia-status-info {
        flex: 1;
    }

    .diligencia-status-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 5px 0;
        color: #2d3748;
    }

    .diligencia-status-subtitle {
        font-size: 14px;
        color: #718096;
        margin: 0;
    }

    .diligencia-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .diligencia-files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .diligencia-file-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
    }

    .diligencia-file-card:hover {
        border-color: var(--verde-pacifico);
        box-shadow: 0 4px 12px rgba(0, 156, 60, 0.1);
    }

    .diligencia-file-card.completed {
        border-color: #48bb78;
        background: linear-gradient(135deg, #f0fff4 0%, #f7fafc 100%);
    }

    .diligencia-file-card.pending {
        border-color: #ed8936;
        background: linear-gradient(135deg, #fffaf0 0%, #f7fafc 100%);
    }

    .diligencia-file-card.makito-processing {
        border-color: #4299e1;
        background: linear-gradient(135deg, #ebf8ff 0%, #f7fafc 100%);
        animation: pulse-border 2s infinite;
    }

    @keyframes pulse-border {
        0% { border-color: #4299e1; }
        50% { border-color: #63b3ed; }
        100% { border-color: #4299e1; }
    }

    .diligencia-file-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .diligencia-file-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 16px;
    }

    .diligencia-file-info {
        flex: 1;
    }

    .diligencia-file-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 5px 0;
        color: #2d3748;
    }

    .diligencia-file-status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .diligencia-file-status.completed {
        background: #c6f6d5;
        color: #22543d;
    }

    .diligencia-file-status.pending {
        background: #fed7cc;
        color: #c05621;
    }

    .diligencia-file-status.makito-processing {
        background: #bee3f8;
        color: #2c5282;
    }

    .diligencia-file-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
    }

    .diligencia-upload-area {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-top: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .diligencia-upload-area:hover {
        border-color: var(--verde-pacifico);
        background: #f0fcf5;
    }

    .diligencia-upload-area.dragover {
        border-color: var(--verde-pacifico);
        background: #f0fcf5;
        transform: scale(1.02);
    }

    .diligencia-upload-icon {
        font-size: 24px;
        color: #a0aec0;
        margin-bottom: 10px;
    }

    .diligencia-upload-text {
        color: #4a5568;
        font-size: 14px;
    }

    .btn-diligencia {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-diligencia.primary {
        background: var(--verde-pacifico);
        color: white;
    }

    .btn-diligencia.primary:hover {
        background: var(--verde-pacifico-hover);
        transform: translateY(-1px);
    }

    .btn-diligencia.secondary {
        background: #e2e8f0;
        color: #4a5568;
    }

    .btn-diligencia.secondary:hover {
        background: #cbd5e0;
    }

    .btn-diligencia.warning {
        background: #ed8936;
        color: white;
    }

    .btn-diligencia.warning:hover {
        background: #dd6b20;
    }

    .btn-diligencia:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    /* === TIMELINE STYLES === */
    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, var(--verde-pacifico) 0%, #e9ecef 100%);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 20px;
        padding-left: 60px;
        animation: fadeInUp 0.5s ease-out;
    }

    .timeline-item:last-child {
        margin-bottom: 0;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .timeline-marker {
        position: absolute;
        left: 11px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: white;
        border: 3px solid var(--verde-pacifico);
        z-index: 2;
        transition: all 0.3s ease;
    }

    .timeline-item:hover .timeline-marker {
        transform: scale(1.2);
        box-shadow: 0 0 0 4px rgba(0, 156, 60, 0.2);
    }

    .timeline-item.current .timeline-marker {
        background: var(--verde-pacifico);
        border-color: var(--verde-pacifico);
        box-shadow: 0 0 0 4px rgba(0, 156, 60, 0.3);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 156, 60, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(0, 156, 60, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(0, 156, 60, 0);
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .timeline-content {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px 16px;
        border-left: 4px solid var(--verde-pacifico);
        transition: all 0.3s ease;
        position: relative;
    }

    .timeline-content:hover {
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }

    .timeline-title {
        font-weight: 600;
        color: #495057;
        font-size: 0.95rem;
        margin: 0;
    }

    .timeline-date {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
    }

    .timeline-details {
        font-size: 0.85rem;
        color: #6c757d;
        line-height: 1.4;
        margin-top: 4px;
    }

    .timeline-duration {
        display: inline-block;
        background: rgba(0, 156, 60, 0.1);
        color: var(--verde-pacifico);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 8px;
    }

    .timeline-item.completed .timeline-marker {
        background: var(--verde-pacifico);
        border-color: var(--verde-pacifico);
    }

    .timeline-item.completed .timeline-content {
        border-left-color: var(--verde-pacifico);
    }

    .timeline-item.pending .timeline-marker {
        background: #6c757d;
        border-color: #6c757d;
    }

    .timeline-item.pending .timeline-content {
        border-left-color: #6c757d;
        opacity: 0.7;
    }

    .timeline-item.error .timeline-marker {
        background: #dc3545;
        border-color: #dc3545;
    }

    .timeline-item.error .timeline-content {
        border-left-color: #dc3545;
    }

    .timeline-item.warning .timeline-marker {
        background: #ffc107;
        border-color: #ffc107;
    }

    .timeline-item.warning .timeline-content {
        border-left-color: #ffc107;
    }

    /* === NEW COMPACT TIMELINE STYLES === */
    .timeline-date-group {
        margin-bottom: 24px;
        opacity: 0;
        animation: slideInFromLeft 0.5s ease-out forwards;
    }

    .timeline-date-group:nth-child(even) {
        animation-delay: 0.1s;
    }

    .timeline-date-group:nth-child(odd) {
        animation-delay: 0.2s;
    }

    @keyframes slideInFromLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .timeline-date-header {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f1f3f4;
    }

    .date-marker {
        margin-right: 16px;
        flex-shrink: 0;
    }

    .date-indicator {
        background: linear-gradient(135deg, var(--verde-pacifico), #4ade80);
        border-radius: 12px;
        padding: 8px 12px;
        text-align: center;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 156, 60, 0.2);
        min-width: 60px;
    }

    .date-number {
        display: block;
        font-size: 18px;
        font-weight: 700;
        line-height: 1;
    }

    .date-month {
        display: block;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        opacity: 0.9;
        margin-top: 2px;
    }

    .date-info {
        flex: 1;
    }

    .date-title {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 4px 0;
    }

    .events-count {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
    }

    .timeline-events {
        margin-left: 38px;
        position: relative;
    }

    .timeline-events::before {
        content: '';
        position: absolute;
        left: -19px;
        top: 0;
        bottom: 20px;
        width: 2px;
        background: linear-gradient(to bottom, var(--verde-pacifico) 0%, #e5e7eb 100%);
        border-radius: 1px;
    }

    .timeline-event {
        position: relative;
        display: flex;
        margin-bottom: 16px;
        align-items: flex-start;
        padding-bottom: 16px;
    }

    .timeline-event.last-event {
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .timeline-event.first-event .event-marker::before {
        background: var(--verde-pacifico);
    }

    .event-marker {
        position: relative;
        margin-right: 16px;
        flex-shrink: 0;
    }

    .event-marker::before {
        content: '';
        position: absolute;
        left: -26px;
        top: 6px;
        width: 8px;
        height: 8px;
        background: #d1d5db;
        border-radius: 50%;
        z-index: 2;
    }

    .event-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
    }

    .timeline-event:hover .event-icon {
        transform: scale(1.05);
    }

    .event-content {
        flex: 1;
        background: white;
        border-radius: 8px;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }

    .timeline-event:hover .event-content {
        border-color: var(--verde-pacifico);
        box-shadow: 0 4px 12px rgba(0, 156, 60, 0.08);
        transform: translateY(-1px);
    }

    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 4px;
    }

    .event-title {
        flex: 1;
        margin-right: 12px;
    }

    .event-user {
        font-weight: 600;
        color: #1f2937;
        font-size: 14px;
    }

    .event-action {
        color: #4b5563;
        font-size: 14px;
        margin-left: 4px;
    }

    .event-time {
        font-size: 12px;
        color: #9ca3af;
        font-weight: 500;
        white-space: nowrap;
    }

    .event-details {
        font-size: 13px;
        color: #6b7280;
        line-height: 1.4;
        margin-top: 6px;
        padding: 8px 12px;
        background: #f9fafb;
        border-radius: 6px;
        border-left: 3px solid #e5e7eb;
    }

    .event-subtitle {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 4px;
        font-style: italic;
    }

    /* === RESPONSIVE DESIGN FOR COMPACT TIMELINE === */
    @media (max-width: 768px) {
        .timeline-date-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .date-marker {
            margin-right: 0;
        }

        .timeline-events {
            margin-left: 20px;
        }

        .timeline-events::before {
            left: -11px;
        }

        .event-marker::before {
            left: -18px;
        }

        .event-header {
            flex-direction: column;
            gap: 4px;
        }

        .event-time {
            align-self: flex-start;
        }
    }

    .documentos-container {
        min-height: 200px;
    }

    .documento-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
        border-left: 4px solid #e0e0e0;
    }

    .documento-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .documento-item.cumplido {
        border-left-color: #28a745;
        background: linear-gradient(135deg, #ffffff 0%, #f8fff8 100%);
    }

    .documento-item.pendiente {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, #ffffff 0%, #fffef8 100%);
    }

    .documento-item.no-cumplido {
        border-left-color: #dc3545;
        background: linear-gradient(135deg, #ffffff 0%, #fff8f8 100%);
    }

    .documento-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .documento-nombre {
        font-weight: 600;
        color: #495057;
        font-size: 1rem;
    }

    .documento-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .documento-status.cumplido {
        background: #d4edda;
        color: #155724;
    }

    .documento-status.pendiente {
        background: #fff3cd;
        color: #856404;
    }

    .documento-status.no-cumplido {
        background: #f8d7da;
        color: #721c24;
    }

    .documento-status.apc-procesando {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        border: 1px solid #3b82f6;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        animation: pulse 2s infinite;
    }

    .documento-item.apc-procesando {
        border-left-color: #3b82f6;
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    }

    .documento-status.sura-procesando {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        border: 1px solid #3b82f6;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        animation: pulse 2s infinite;
    }

    .documento-item.sura-procesando {
        border-left-color: #3b82f6;
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    }

    .documento-observaciones {
        color: #6c757d;
        font-size: 0.9rem;
        font-style: italic;
        margin-top: 0.5rem;
    }

    .documento-blocked-info {
        margin-top: 8px;
        padding: 8px 12px;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        font-size: 0.85em;
        color: #856404;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .documento-blocked-info i {
        color: #f39c12;
    }

    .documento-actions {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
    }

    .btn-documento {
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .btn-documento.btn-download {
        background: var(--verde-pacifico);
        color: white;
        border: none;
    }

    .btn-documento.btn-download:hover {
        background: #007e31;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .btn-documento.btn-upload {
        background: #17a2b8;
        color: white;
        border: none;
        cursor: pointer;
    }

    .btn-documento.btn-upload:hover {
        background: #138496;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .btn-documento.btn-upload:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }

    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
        margin-top: 0.5rem;
        display: none;
    }

    .upload-area.active {
        display: block;
    }

    .upload-area.dragover {
        border-color: var(--verde-pacifico);
        background: rgba(0, 156, 60, 0.05);
    }

    .upload-input {
        display: none;
    }

    .upload-text {
        color: #6c757d;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .upload-progress {
        margin-top: 0.5rem;
        display: none;
    }

    .progress-bar-custom {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: var(--verde-pacifico);
        width: 0%;
        transition: width 0.3s ease;
    }

    .file-preview {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        display: none;
        font-size: 0.875rem;
    }

    .file-preview.active {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .file-remove {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
    }

    .file-remove:hover {
        background: rgba(220, 53, 69, 0.1);
    }

    .upload-buttons {
        margin-top: 0.5rem;
        display: none;
        gap: 0.5rem;
    }

    .upload-buttons.active {
        display: flex;
    }

    .btn-upload-confirm {
        background: #28a745;
        color: white;
        border: none;
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-upload-confirm:hover {
        background: #218838;
    }

    .btn-upload-confirm:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }

    .btn-upload-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-upload-cancel:hover {
        background: #5a6268;
    }

    .documento-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
        .documento-grid {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }
    }

    /* === WORKFLOW SECTION === */
    .workflow-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--verde-pacifico);
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--verde-pacifico);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }

    .section-title i {
        color: var(--verde-pacifico);
    }

    .workflow-container {

        border-radius: 6px;

        overflow-x: auto;
    }

    /* === MODAL LAYOUT === */
    .modal-main-content {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: #fafafa;
        border-radius: 8px;


    }

    .info-cards-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    /* === INFO CARDS GRID === */
    .info-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .info-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    /* Info cards styles */
    .info-cards-section .info-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: none;
        transition: all 0.2s ease;
    }

    .info-cards-section .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Modern Summary Card Styles */
    .summary-card-modern {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .summary-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--verde-pacifico) 0%, #22a650 100%);
    }

    .summary-card-modern:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .summary-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
    }

    .summary-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--verde-pacifico) 0%, #22a650 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
        box-shadow: 0 4px 12px rgba(0, 156, 60, 0.3);
    }

    .summary-title-section {
        flex: 1;
    }

    .summary-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 4px 0;
        line-height: 1.4;
    }

    .summary-subtitle {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
        font-weight: 500;
    }

    .summary-content {
        margin-top: 16px;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .summary-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .summary-item:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: var(--verde-pacifico);
        transform: translateY(-1px);
    }

    .summary-item-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: rgba(0, 156, 60, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--verde-pacifico);
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .summary-item-content {
        flex: 1;
        min-width: 0;
    }

    .summary-item-label {
        display: block;
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 2px;
    }

    .summary-item-value {
        display: block;
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.4;
        word-break: break-word;
    }

    /* Modern Client Card Styles */
    .client-card-modern {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .client-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #2196f3 0%, #1976d2 100%);
    }

    .client-card-modern:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .client-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
    }

    .client-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    .client-title-section {
        flex: 1;
    }

    .client-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 4px 0;
        line-height: 1.4;
    }

    .client-subtitle {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
        font-weight: 500;
    }

    .client-content {
        margin-top: 16px;
    }

    .client-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .client-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .client-item:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: #2196f3;
        transform: translateY(-1px);
    }

    .client-item-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: rgba(33, 150, 243, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #2196f3;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .client-item-content {
        flex: 1;
        min-width: 0;
    }

    .client-item-label {
        display: block;
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 2px;
    }

    .client-item-value {
        display: block;
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.4;
        word-break: break-word;
    }

    /* Modern Cotizaci贸n Card Styles */
    .cotizacion-card-modern {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .cotizacion-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #ff9800 0%, #f57c00 100%);
    }

    .cotizacion-card-modern:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .cotizacion-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
    }

    .cotizacion-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
    }

    .cotizacion-title-section {
        flex: 1;
    }

    .cotizacion-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 4px 0;
        line-height: 1.4;
    }

    .cotizacion-subtitle {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
        font-weight: 500;
    }

    .cotizacion-content {
        margin-top: 16px;
    }

    .cotizacion-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .cotizacion-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .cotizacion-item:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: #ff9800;
        transform: translateY(-1px);
    }

    .cotizacion-item-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: rgba(255, 152, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ff9800;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .cotizacion-item-content {
        flex: 1;
        min-width: 0;
    }

    .cotizacion-item-label {
        display: block;
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 2px;
    }

    .cotizacion-item-value {
        display: block;
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.4;
        word-break: break-word;
    }

    .info-cards-section .summary-card {
        border-left: 4px solid var(--verde-pacifico);
    }

    .info-cards-section .client-card {
        border-left: 4px solid #2196f3;
    }





    /* === WORKFLOW ROADMAP (Enhanced) === */
    .workflow-roadmap {
        display: flex;
        align-items: flex-end;
        overflow-x: auto;
        padding: 1.5rem 0.5rem;
        justify-content: flex-start; /* left-align so auto-scroll positions correctly */
        gap: 0.5rem;
        scrollbar-width: thin;
        scrollbar-color: #009c3c #f1f1f1;
        scroll-behavior: smooth; /* smooth scroll to current etapa on open */
    }

    .workflow-roadmap::-webkit-scrollbar {
        height: 6px;
    }

    .workflow-roadmap::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .workflow-roadmap::-webkit-scrollbar-thumb {
        background: #009c3c;
        border-radius: 3px;
    }

    .workflow-roadmap::-webkit-scrollbar-thumb:hover {
        background: #007a2f;
    }

    .workflow-step {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 120px;
        flex: 0 0 120px;
        z-index: 1;
    }

    .workflow-step .circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        border: 3px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #6c757d;
        margin-bottom: 8px;
        transition: all 0.2s ease;
        position: relative;
        z-index: 2;
    }

    .workflow-step.completed .circle {
        background: var(--verde-pacifico);
        border-color: var(--verde-pacifico);
        color: white;
        box-shadow: 0 2px 8px rgba(0, 156, 60, 0.2);
    }

    .workflow-step.current .circle {
        background: #fff3cd;
        border-color: #ffc107;
        color: #856404;
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.2), 0 0 12px rgba(255, 193, 7, 0.3);
        animation: pulse-glow 2s infinite;
    }

    @keyframes pulse-glow {
        0% {
            box-shadow: 0 0 0 6px rgba(255, 193, 7, 0.2), 0 0 20px rgba(255, 193, 7, 0.4);
            transform: scale(1);
        }

        50% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0.1), 0 0 30px rgba(255, 193, 7, 0.6);
            transform: scale(1.05);
        }

        100% {
            box-shadow: 0 0 0 6px rgba(255, 193, 7, 0.2), 0 0 20px rgba(255, 193, 7, 0.4);
            transform: scale(1);
        }
    }

    .workflow-step.pending .circle {
        background: #f8f9fa;
        border-color: #dee2e6;
        color: #6c757d;
    }

    .workflow-step .step-label {
        font-weight: 600;
        color: #333;
        font-size: 0.875rem;
        margin-bottom: 4px;
        text-align: center;
        line-height: 1.3;
    }



    .workflow-connector {
        flex: 0 0 30px;
        height: 3px;
        background: linear-gradient(90deg, #dee2e6 0%, #e9ecef 100%);
        margin-bottom: 20px;
        border-radius: 2px;
        position: relative;
        z-index: 1;
    }

    .workflow-connector.completed {
        background: linear-gradient(90deg, var(--verde-pacifico) 0%, #22a650 100%);
    }





    /* === EMPTY STATE === */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state i {
        opacity: 0.5;
    }

    /* === RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
        .modal-body-modern {
            padding: 1rem;
        }

        .info-cards-section {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .info-cards-section .info-card {
            min-width: auto;
        }

        .summary-grid,
        .client-grid,
        .cotizacion-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .summary-header,
        .client-header,
        .cotizacion-header {
            flex-direction: column;
            text-align: center;
            gap: 12px;
        }

        .summary-title,
        .client-title,
        .cotizacion-title {
            font-size: 1.125rem;
        }

        .summary-card-modern,
        .client-card-modern,
        .cotizacion-card-modern {
            padding: 20px;
        }

        .info-cards-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .info-card {
            padding: 1rem;
        }

        .workflow-step {
            min-width: 100px;
            flex-basis: 100px;
        }

        .workflow-step .circle {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
        }

        .workflow-connector {
            flex-basis: 20px;
        }

        .solicitud-code-badge {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .code-text {
            font-size: 1.5rem;
        }

        .header-actions {
            flex-direction: column;
            gap: 0.5rem;
        }

        .actions-buttons {
            gap: 0.25rem;
        }

        .action-btn-header {
            width: 32px;
            height: 32px;
            font-size: 0.75rem;
        }

        .timeline-item {
            padding-left: 50px;
            margin-bottom: 16px;
        }

        .timeline-marker {
            left: 6px;
            width: 16px;
            height: 16px;
        }

        .timeline::before {
            left: 14px;
        }

        .timeline-content {
            padding: 10px 12px;
        }

        .timeline-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .timeline-title {
            font-size: 0.9rem;
        }

        .timeline-date {
            font-size: 0.75rem;
        }

        .timeline-details {
            font-size: 0.8rem;
            margin-top: 2px;
        }


    }

    @media (max-width: 480px) {
        .modal-header-modern {
            padding: 1rem;
        }

        .workflow-section {
            padding: 1rem;
        }

        .info-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }

        .info-value {
            text-align: left;
            max-width: 100%;
        }
    }

    /* === LOADING STATE === */
    .loading-placeholder {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading-shimmer 1.5s infinite;
        border-radius: 4px;
        height: 1rem;
        margin: 0.25rem 0;
    }

    @keyframes loading-shimmer {
        0% {
            background-position: -200% 0;
        }

        100% {
            background-position: 200% 0;
        }
    }

    /* === MENSAJE DE CONFIRMACION === */
    .confirmation-message {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s ease;
    }

    .confirmation-message.show {
        transform: translateX(0);
        opacity: 1;
    }

    .confirmation-message.success {
        background: linear-gradient(135deg, #28a745, #20c997);
    }

    .confirmation-message.error {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
    }

    .confirmation-message.warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: #212529;
    }

    /* === CUSTOM SCROLLBAR === */
    .modal-body-modern::-webkit-scrollbar {
        width: 8px;
    }

    .modal-body-modern::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .modal-body-modern::-webkit-scrollbar-thumb {
        background: #009c3c;
        border-radius: 4px;
    }

    .modal-body-modern::-webkit-scrollbar-thumb:hover {
        background: #007a2f;
    }

    /* === COMPACT WORKFLOW SECTION OVERRIDES === */
    .workflow-section {
        padding-top: 10px;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .section-title {
        margin-bottom: 8px;
    }

    .workflow-roadmap {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }

    /* === NOTAS Y RECORDATORIOS STYLES === */
    .notas-section {
        padding: 1.5rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }

    .filtros-notas {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .notas-container {
        max-height: 600px;
        overflow-y: auto;
    }

    .nota-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        position: relative;
    }

    .nota-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .nota-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .nota-tipo-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .nota-tipo-badge.nota {
        background: #e3f2fd;
        color: #1976d2;
    }

    .nota-tipo-badge.recordatorio {
        background: #fff3e0;
        color: #f57c00;
    }

    .nota-prioridad-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .nota-prioridad-badge.alta {
        background: #ffebee;
        color: #c62828;
    }

    .nota-prioridad-badge.media {
        background: #fff8e1;
        color: #f57f17;
    }

    .nota-prioridad-badge.baja {
        background: #e8f5e8;
        color: #2e7d32;
    }

    .nota-titulo {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        line-height: 1.4;
    }

    .nota-contenido {
        color: #5a6c7d;
        line-height: 1.6;
        margin-bottom: 1rem;
        white-space: pre-wrap;
    }

    .nota-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .nota-fecha {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nota-acciones {
        display: flex;
        gap: 0.5rem;
    }

    .btn-nota-accion {
        padding: 0.25rem 0.5rem;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-nota-accion.editar {
        background: #e3f2fd;
        color: #1976d2;
    }

    .btn-nota-accion.editar:hover {
        background: #bbdefb;
    }

    .btn-nota-accion.eliminar {
        background: #ffebee;
        color: #c62828;
    }

    .btn-nota-accion.eliminar:hover {
        background: #ffcdd2;
    }

    .btn-nota-accion.completar {
        background: #e8f5e8;
        color: #2e7d32;
    }

    .btn-nota-accion.completar:hover {
        background: #c8e6c9;
    }

    .recordatorio-vencido {
        border-left: 4px solid #dc3545;
        background: #fff5f5;
    }

    .recordatorio-proximo {
        border-left: 4px solid #ffc107;
        background: #fffbf0;
    }

    .recordatorio-completado {
        border-left: 4px solid #28a745;
        background: #f8fff9;
        opacity: 0.8;
    }

    .estado-recordatorio {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .estado-recordatorio.pendiente {
        background: #fff3e0;
        color: #f57c00;
    }

    .estado-recordatorio.completado {
        background: #e8f5e8;
        color: #2e7d32;
    }

    .estado-recordatorio.vencido {
        background: #ffebee;
        color: #c62828;
    }

    .fecha-vencimiento {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
    }

    .fecha-vencimiento.vencida {
        color: #dc3545;
    }

    .fecha-vencimiento.proxima {
        color: #ffc107;
    }

    .fecha-vencimiento.normal {
        color: #28a745;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .loading-placeholder {
        text-align: center;
        padding: 2rem;
    }

    /* === MODERN RECONSIDERACIN MODAL STYLES === */
    .modern-modal-reconsideracion {
        border: none;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-heavy);
        overflow: hidden;
        max-height: 90vh;
    }

    .modal-header-modern-reconsideracion {
        background: linear-gradient(135deg, var(--warning-orange) 0%, #ff8c00 50%, #ff6b35 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-bottom: none;
        position: relative;
        overflow: hidden;
    }

    .modal-header-modern-reconsideracion::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        pointer-events: none;
    }

    .reconsideracion-header-info {
        flex: 1;
    }

    .reconsideracion-title-section {
        position: relative;
        z-index: 1;
    }

    .reconsideracion-title-section h5 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        letter-spacing: -0.5px;
    }

    .reconsideracion-subtitle {
        font-size: 0.95rem;
        opacity: 0.9;
        font-weight: 500;
    }

    .modal-body-modern-reconsideracion {
        padding: 2rem;
        background: var(--neutral-100);
        max-height: calc(90vh - 140px);
        overflow-y: auto;
    }

    /* === INSTRUCTIONS SECTION === */
    .instructions-section {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border-radius: var(--border-radius-md);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--primary-blue);
        box-shadow: var(--shadow-light);
    }

    .instructions-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .instructions-icon {
        color: var(--primary-blue);
        font-size: 1.25rem;
        margin-right: 0.75rem;
    }

    .instructions-title {
        color: var(--primary-blue);
        font-weight: 600;
        margin: 0;
        font-size: 1.1rem;
    }

    .instructions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .instructions-column {
        flex: 1;
    }

    .instructions-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .instructions-list li {
        padding: 0.5rem 0;
        font-size: 0.9rem;
        color: var(--neutral-700);
        line-height: 1.5;
        position: relative;
        padding-left: 1.25rem;
    }

    .instructions-list li::before {
        content: '';
        color: var(--primary-blue);
        font-weight: bold;
        position: absolute;
        left: 0;
    }

    /* === RESULTADO ANTERIOR SECTION === */
    .resultado-anterior-section {
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        border-radius: var(--border-radius-md);
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--danger-red);
        box-shadow: var(--shadow-light);
    }

    .resultado-anterior-content {
        display: flex;
        align-items: flex-start;
    }

    .resultado-icon {
        color: var(--danger-red);
        font-size: 1.1rem;
        margin-right: 0.75rem;
        margin-top: 0.125rem;
    }

    .resultado-text {
        flex: 1;
        font-size: 0.9rem;
        color: var(--neutral-700);
    }

    .resultado-text strong {
        color: var(--danger-red);
    }

    /* === FORM STYLES === */
    .reconsideracion-form {
        background: white;
        border-radius: var(--border-radius-md);
        padding: 1.5rem;
        box-shadow: var(--shadow-light);
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section:last-child {
        margin-bottom: 0;
    }

    .form-label-modern {
        display: block;
        font-weight: 600;
        color: var(--neutral-800);
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }

    .required-mark {
        color: var(--danger-red);
        font-weight: 700;
    }

    .form-control-modern {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--neutral-300);
        border-radius: var(--border-radius-md);
        font-size: 0.95rem;
        transition: all var(--transition-medium);
        background: white;
        color: var(--neutral-800);
    }

    .form-control-modern:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .form-control-modern::placeholder {
        color: var(--neutral-500);
    }

    .form-helper-text {
        margin-top: 0.5rem;
    }

    .character-counter {
        color: var(--neutral-600);
        font-size: 0.85rem;
    }

    /* === SECTION TITLES === */
    .section-title-modern {
        font-weight: 600;
        color: var(--primary-blue);
        margin-bottom: 1rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
    }

    /* === COTIZACION OPTIONS === */
    .cotizacion-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .cotizacion-option-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: var(--border-radius-md);
        transition: all var(--transition-medium);
        cursor: pointer;
    }

    .cotizacion-option-item:hover {
        background: var(--neutral-100);
    }

    .form-check-input-modern {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.75rem;
        accent-color: var(--primary-blue);
        cursor: pointer;
    }

    .form-check-label-modern {
        font-weight: 500;
        color: var(--neutral-800);
        cursor: pointer;
        flex: 1;
    }

    /* === COTIZACION CURRENT CARD === */
    .cotizacion-current-card {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid var(--primary-blue);
        border-radius: var(--border-radius-md);
        padding: 1.25rem;
        margin-top: 0.75rem;
        box-shadow: var(--shadow-light);
        transition: all var(--transition-medium);
    }

    .cotizacion-current-card:hover {
        box-shadow: var(--shadow-medium);
        transform: translateY(-1px);
    }

    .cotizacion-current-content {
        width: 100%;
    }

    .cotizacion-current-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .cotizacion-current-item {
        display: flex;
        flex-direction: column;
    }

    .cotizacion-current-label {
        color: var(--neutral-600);
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .cotizacion-current-value {
        color: var(--neutral-900);
        font-weight: 600;
        font-size: 0.95rem;
    }

    /* === COTIZACIONES DISPONIBLES === */
    .cotizaciones-disponibles-section {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--neutral-100);
        border-radius: var(--border-radius-md);
        border: 1px solid var(--neutral-300);
    }

    .cotizaciones-disponibles-title {
        color: var(--neutral-700);
        font-weight: 600;
        margin-bottom: 1rem;
        font-size: 1rem;
    }

    .cotizaciones-action-section {
        margin-bottom: 1rem;
    }

    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: var(--primary-blue);
    }

    .loading-text {
        margin-top: 0.75rem;
        color: var(--neutral-600);
        font-size: 0.9rem;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        text-align: center;
    }

    .empty-icon {
        font-size: 2rem;
        color: var(--neutral-400);
        margin-bottom: 0.75rem;
    }

    .empty-text {
        color: var(--neutral-600);
        font-size: 0.9rem;
    }

    .cotizaciones-legacy-container {
        border: 1px solid var(--neutral-300);
        border-radius: var(--border-radius-md);
        padding: 1rem;
        background: white;
    }

    /* === MODAL FOOTER === */
    .modal-footer-modern {
        background: white;
        border-top: 1px solid var(--neutral-200);
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: flex-end;
    }

    .footer-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .btn-cancel-modern {
        background: var(--neutral-300);
        color: var(--neutral-700);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--border-radius-md);
        font-weight: 500;
        transition: all var(--transition-medium);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
    }

    .btn-cancel-modern:hover {
        background: var(--neutral-400);
        color: var(--neutral-800);
        transform: translateY(-1px);
    }

    .btn-submit-modern {
        background: linear-gradient(135deg, var(--warning-orange) 0%, #ff8c00 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--border-radius-md);
        font-weight: 600;
        transition: all var(--transition-medium);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        box-shadow: var(--shadow-light);
    }

    .btn-submit-modern:hover {
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        transform: translateY(-1px);
        box-shadow: var(--shadow-medium);
        color: white;
    }

    .btn-submit-modern:disabled {
        background: var(--neutral-400);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* === RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
        .modal-header-modern-reconsideracion {
            padding: 1rem 1.5rem;
        }

        .modal-body-modern-reconsideracion {
            padding: 1.5rem;
        }

        .instructions-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .cotizacion-current-grid {
            grid-template-columns: 1fr;
        }

        .footer-actions {
            flex-direction: column;
            width: 100%;
        }

        .btn-cancel-modern,
        .btn-submit-modern {
            width: 100%;
            justify-content: center;
        }

        .reconsideracion-title-section h5 {
            font-size: 1.25rem;
        }
    }

    @media (max-width: 480px) {
        .modal-header-modern-reconsideracion {
            padding: 1rem;
        }

        .modal-body-modern-reconsideracion {
            padding: 1rem;
        }

        .instructions-section {
            padding: 1rem;
        }

        .reconsideracion-form {
            padding: 1rem;
        }
    }

    .cotizacion-option {
        border: 2px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .cotizacion-option:hover {
        border-color: #007bff;
        background: #f0f8ff;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
    }

    .cotizacion-option input[type="radio"]:checked + .cotizacion-info {
        background: #e3f2fd;
    }

    .cotizacion-option input[type="radio"]:checked {
        accent-color: #007bff;
    }

    .cotizacion-info {
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: background-color 0.3s ease;
    }

    .cotizacion-monto {
        font-size: 1.1rem;
        font-weight: 700;
        color: #28a745;
        margin-bottom: 0.25rem;
    }

    .cotizacion-fecha {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .cotizacion-cliente {
        font-size: 0.9rem;
        color: #495057;
        font-weight: 500;
    }

    .form-floating {
        position: relative;
    }

    .form-floating > .form-control {
        padding: 1rem 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-floating > .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .form-floating > label {
        padding: 1rem 0.75rem;
        font-weight: 500;
        color: #6c757d;
    }

    .btn-reconsideracion {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.75rem 2rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
    }

    .btn-reconsideracion:hover {
        background: linear-gradient(135deg, #218838, #1e7e34);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        color: white;
    }

    .btn-reconsideracion:disabled {
        background: #6c757d;
        transform: none;
        box-shadow: none;
        cursor: not-allowed;
    }

    .alert-warning {
        border-left: 4px solid #ffc107;
        border-radius: 0.5rem;
        background: #fff8e1;
        color: #8a6d3b;
    }

    .no-cotizaciones {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .no-cotizaciones i {
        font-size: 3rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }

    .loading-cotizaciones {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        #modalReconsideracion .modal-dialog {
            max-width: 95%;
            margin: 1rem auto;
        }
        
        .reconsideracion-header {
            padding: 1rem;
            margin: -1rem -1rem 1rem -1rem;
        }
        
        .cotizacion-option {
            padding: 0.75rem;
        }
        
        .btn-reconsideracion {
            width: 100%;
            margin-top: 1rem;
        }
    }
</style>
<script>
    // Set current user ID globally
    window.currentUserId = {{ request.user.id|default:0 }};

    window.mostrarModalSolicitud = function (solicitudId, activeTab = 'info') {
        // Test if Bootstrap is available
        if (typeof bootstrap === 'undefined' && typeof window.bootstrap === 'undefined') {
            console.error('Bootstrap is not available');
            return;
        }

        console.log('Opening modal for solicitud:', solicitudId, 'with active tab:', activeTab);
        console.log('Type of solicitudId:', typeof solicitudId);
        console.log('solicitudId is valid:', solicitudId && solicitudId !== 'null' && solicitudId !== 'undefined');

        // Validate solicitudId
        if (!solicitudId || solicitudId === 'null' || solicitudId === 'undefined' || solicitudId === '') {
            console.error('Invalid solicitudId provided:', solicitudId);
            alert('ID de solicitud inv谩lido: ' + solicitudId);
            return;
        }

        // Store the solicitudId and activeTab globally for use in the modal
        window.currentSolicitudId = solicitudId;
        window.currentModalSolicitudId = solicitudId;
        window.currentActiveTab = activeTab;

        // Set the solicitudId on the Ver Cotizaci贸n button
        const btnVerCotizacion = document.getElementById('modalBtnVerCotizacion');
        if (btnVerCotizacion) {
            btnVerCotizacion.setAttribute('data-solicitud-id', solicitudId);
            console.log('Set button data-solicitud-id to:', btnVerCotizacion.getAttribute('data-solicitud-id'));
        }

        // Show loading state
        showLoadingState();

        // Show modal first - try multiple ways to access Bootstrap
        try {
            const modal = new bootstrap.Modal(document.getElementById('modalSolicitud'));
            modal.show();
        } catch (error) {
            console.error('Error creating Bootstrap modal:', error);
            // Fallback: try to show modal manually
            const modalElement = document.getElementById('modalSolicitud');
            if (modalElement) {
                modalElement.classList.add('show');
                modalElement.style.display = 'block';
                modalElement.setAttribute('aria-hidden', 'false');
                // Add backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
        }

        // Construct the API URL
        const apiUrl = `/workflow/api/solicitud_brief/${solicitudId}/`;
        console.log('API URL:', apiUrl);

        // Fetch API with comprehensive error handling
        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCsrfToken()
            },
            credentials: 'same-origin'
        })
            .then(response => {
                console.log('API Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return response.json();
            })
            .then(data => {
                console.log('API Success:', { data: data });

                // Validate response data
                if (!data || typeof data !== 'object') {
                    console.error('Invalid response data:', data);
                    showErrorState('Respuesta de API inv谩lida');
                    return;
                }

                populateModalData(data);
            })
            .catch(error => {
                console.error('API Error:', {
                    error: error.message,
                    apiUrl: apiUrl
                });

                let errorMessage = 'Error desconocido';

                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'No se pudo conectar al servidor';
                } else if (error.message.includes('404')) {
                    errorMessage = `Solicitud ${solicitudId} no encontrada`;
                } else if (error.message.includes('500')) {
                    errorMessage = 'Error interno del servidor';
                } else if (error.message.includes('503')) {
                    errorMessage = 'Servicio no disponible temporalmente';
                } else {
                    errorMessage = error.message;
                }

                // Show error but also populate with mock data for testing
                console.warn('Using mock data for testing purposes');
                populateModalData(getMockData(solicitudId));

                // Show a warning message
                setTimeout(() => {
                    const workflowProgress = document.getElementById('modalSolicitudWorkflowProgress');
                    if (workflowProgress) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-warning alert-dismissible fade show';
                        alertDiv.setAttribute('role', 'alert');
                        alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Modo de prueba:</strong> ${errorMessage}
                    <br><small>URL: ${apiUrl}</small>
                    <br><small>Para probar la API directamente, ejecute <code>testApiDirectly(${solicitudId})</code> en la consola</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                        workflowProgress.prepend(alertDiv);
                    }
                }, 500);
            });

        // Function to get CSRF token
        function getCsrfToken() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            return csrfToken ? csrfToken.value : '';
        }
    };

    function showLoadingState() {
        // Clear modal content
        const modalSolicitudCodigo = document.getElementById('modalSolicitudCodigo');
        const modalSolicitudEstadoBadge = document.getElementById('modalSolicitudEstadoBadge');
        const modalSolicitudTipo = document.getElementById('modalSolicitudTipo');

        if (modalSolicitudCodigo) {
            modalSolicitudCodigo.innerHTML = '<div class="loading-placeholder" style="width: 120px;"></div>';
        }
        if (modalSolicitudEstadoBadge) {
            modalSolicitudEstadoBadge.innerHTML = '<div class="loading-placeholder" style="width: 80px;"></div>';
        }
        if (modalSolicitudTipo) {
            modalSolicitudTipo.innerHTML = '<div class="loading-placeholder" style="width: 200px;"></div>';
        }

        // Reset info fields
        const infoFields = ['FechaInicio', 'Vencimiento', 'EtapaActual', 'Area', 'Cliente', 'Cedula', 'Canal'];
        infoFields.forEach(field => {
            const element = document.getElementById(`modalSolicitud${field}`);
            if (element) {
                element.innerHTML = '<div class="loading-placeholder" style="width: 100px;"></div>';
            }
        });

        // Reset cotizaci贸n fields
        const cotizacionFields = ['MontoFinanciado', 'Plazo', 'TasaInteres', 'MontoLetra'];
        cotizacionFields.forEach(field => {
            const element = document.getElementById(`modalSolicitud${field}`);
            if (element) {
                element.innerHTML = '<div class="loading-placeholder" style="width: 100px;"></div>';
            }
        });

        // Disable action buttons (except Ver Cotizaci贸n which will be enabled once data loads)
        const actionButtons = document.querySelectorAll('.action-btn-header:not(#modalBtnVerCotizacion)');
        actionButtons.forEach(btn => {
            btn.disabled = true;
        });

        // Show loading in workflow
        const workflowProgress = document.getElementById('modalSolicitudWorkflowProgress');
        if (workflowProgress) {
            workflowProgress.innerHTML = `
            <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        `;
        }

        // Add loading animation to modern cards
        const modernCards = document.querySelectorAll('.summary-card-modern, .client-card-modern, .cotizacion-card-modern');
        modernCards.forEach((card, index) => {
            card.innerHTML = `
            <div class="d-flex justify-content-center align-items-center" style="height: 120px;">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        `;
        });

        // Hide Canal Digital tab during loading
        const canalDigitalNav = document.getElementById('canal-digital-nav');
        if (canalDigitalNav) {
            canalDigitalNav.style.display = 'none';
        }
    }

    function showErrorState(errorMessage = 'Error al cargar la informaci贸n') {
        const workflowProgress = document.getElementById('modalSolicitudWorkflowProgress');
        if (workflowProgress) {
            workflowProgress.innerHTML = `
            <div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <div class="fw-bold mb-2">${errorMessage}</div>
                <div class="text-muted">Por favor, intente nuevamente o contacte al administrador</div>
            </div>
        `;
        }

        // Enable action buttons but show they're unavailable
        const actionButtons = document.querySelectorAll('.action-btn-header:not(#modalBtnVerCotizacion)');
        actionButtons.forEach(btn => {
            btn.disabled = false;
        });
        
        // Keep Ver Cotizaci贸n button disabled in error state since no data is available
        const btnVerCotizacion = document.getElementById('modalBtnVerCotizacion');
        if (btnVerCotizacion) {
            btnVerCotizacion.disabled = true;
        }
    }

    function populateModalData(data) {
        try {
            console.log('Populating modal with data:', data);

            // Store current modal data globally for updates
            window.currentModalData = data;

            // Validate data structure
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid data structure');
            }

            // Get solicitudId from the current modal context
            const solicitudId = window.currentSolicitudId;
            console.log('Current solicitudId:', solicitudId);

            // Set the solicitudId on the Ver Cotizaci贸n button and enable it if cotization data exists
            const btnVerCotizacion = document.getElementById('modalBtnVerCotizacion');
            if (btnVerCotizacion) {
                btnVerCotizacion.setAttribute('data-solicitud-id', solicitudId);
                
                // Enable the button if cotization data is available
                const cotizacion = data.cotizacion || {};
                const hasValidCotization = cotizacion && (cotizacion.id || cotizacion.numero) && cotizacion.tipoPrestamo;
                
                if (hasValidCotization) {
                    btnVerCotizacion.disabled = false;
                    console.log('Ver Cotizaci贸n button enabled - cotization data available');
                } else {
                    btnVerCotizacion.disabled = true;
                    console.log('Ver Cotizaci贸n button disabled - no valid cotization data');
                }
            }

            // Set the solicitudId on the Reconsideraci贸n button
            const btnReconsideracion = document.getElementById('modalBtnReconsideracion');
            if (btnReconsideracion) {
                btnReconsideracion.setAttribute('data-solicitud-id', solicitudId);
            }

            // Populate the unified summary card
            populateUnifiedSummaryCard(data);

            // General info with fallbacks
            const general = data.general || {};
            setElementText('modalSolicitudCodigo', general.codigo || 'N/A');
            setElementText('modalSolicitudEstadoBadge', general.estado || 'N/A');
            setElementText('modalSolicitudTipo', general.tipo || 'N/A');
            setElementText('modalSolicitudFechaInicio', general.fecha_inicio || 'N/A');
            setElementText('modalSolicitudVencimiento', general.vencimiento || 'N/A');
            setElementText('modalSolicitudEtapaActual', general.etapa_actual || 'N/A');
            setElementText('modalSolicitudArea', general.area || 'N/A');

            // Client info with fallbacks
            const cliente = data.cliente || {};
            const cotizacion = data.cotizacion || {};

            console.log(' DEBUG - Full API response data:', data);
            console.log(' DEBUG - Cliente data:', cliente);
            console.log(' DEBUG - Cotizacion data:', cotizacion);

            setElementText('modalSolicitudCliente', cliente.nombre || 'N/A');
            setElementText('modalSolicitudCedula', cliente.cedula || 'N/A');

            // Edad y Sexo from cotizacion (API fields)
            let edadSexo = 'N/A';
            const edad = cotizacion.edad;
            const sexo = cotizacion.sexo;

            console.log(' DEBUG - Edad:', edad, 'type:', typeof edad);
            console.log(' DEBUG - Sexo:', sexo, 'type:', typeof sexo);

            if (edad !== null && edad !== undefined && edad !== '-' &&
                sexo !== null && sexo !== undefined && sexo !== '-') {
                edadSexo = `${edad} a帽os / ${sexo}`;
            } else if (edad !== null && edad !== undefined && edad !== '-') {
                edadSexo = `${edad} a帽os`;
            } else if (sexo !== null && sexo !== undefined && sexo !== '-') {
                edadSexo = sexo;
            }

            setElementText('modalSolicitudEdadSexo', edadSexo);
            console.log(' DEBUG - EdadSexo final:', edadSexo);

            // Cartera from cotizacion (API field)
            const cartera = cotizacion.cartera;
            console.log(' DEBUG - Cartera:', cartera, 'type:', typeof cartera);

            const carteraText = (cartera !== null && cartera !== undefined && cartera !== '-') ? cartera : 'N/A';
            setElementText('modalSolicitudCartera', carteraText);
            console.log(' DEBUG - Cartera final:', carteraText);

            // Cotizaci贸n info with fallbacks
            setElementText('modalSolicitudMontoFinanciado',
                cotizacion.auxMonto2 !== undefined && cotizacion.auxMonto2 !== null ? `$${cotizacion.auxMonto2.toLocaleString()}` : 'N/A'
            );
            setElementText('modalSolicitudPlazo',
                cotizacion.plazo !== undefined ? `${cotizacion.plazo} meses` : 'N/A'
            );
            setElementText('modalSolicitudTasaInteres',
                cotizacion.tasa_interes !== undefined ? `${cotizacion.tasa_interes}%` :
                    cotizacion.tasa !== undefined ? `${cotizacion.tasa}%` : 'N/A'
            );
            setElementText('modalSolicitudMontoLetra',
                cotizacion.monto_letra !== undefined ? `$${cotizacion.monto_letra.toLocaleString()}` :
                    cotizacion.cuota !== undefined ? `$${cotizacion.cuota.toLocaleString()}` : 'N/A'
            );

            // Action buttons with fallbacks
            const acciones = data.acciones || {};
            setButtonDisabled('modalBtnProcesarTarea', !(acciones.puede_procesar || false));
            setButtonDisabled('modalBtnDevolver', !(acciones.puede_devolver || false));
            setButtonDisabled('modalBtnAnular', !(acciones.puede_anular || false));
            setButtonDisabled('modalBtnComentarios', !(acciones.puede_comentar || false));

            // Workflow roadmap with fallbacks
            const workflow = data.workflow || [];
            if (workflow.length > 0) {
                renderWorkflowRoadmap(workflow);
            } else {
                const workflowProgress = document.getElementById('modalSolicitudWorkflowProgress');
                if (workflowProgress) {
                    workflowProgress.innerHTML = '<div class="text-center text-muted py-4">No hay informaci贸n de workflow disponible</div>';
                }
            }

            // Populate documentos tab
            const documentos = data.documentos || [];
            populateDocumentosTab(documentos);

            // Populate historial tab
            const historial = data.historial || [];
            populateHistorialTab(historial);

            // Populate nuevos tabs
            populateDocumentosUrgentesTab(documentos);
            populateDocumentosPendientesTab(documentos);
            
            //  MOSTRAR ALERTAS DE DOCUMENTOS
            mostrarAlertasDocumentos(documentos);
            
            // Verificar y actualizar estado de entrevista
            if (data.solicitud) {
                verificarEstadoEntrevista(data.solicitud);
            } else {
                console.log('锔 No hay datos de solicitud en la respuesta');
                // Mostrar solo el bot贸n sin datos de entrevista
                const alertContainer = document.getElementById('documentosIconsAlert');
                if (alertContainer) {
                    alertContainer.style.display = 'flex';
                }
                actualizarEstadoEntrevista(false);
            }

            // Add smooth animations for the new layout
            setTimeout(() => {
                const modernCards = document.querySelectorAll('.summary-card-modern, .client-card-modern, .cotizacion-card-modern');
                modernCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.transition = 'all 0.3s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 100);
                });

                const mainContent = document.querySelector('.modal-main-content');
                if (mainContent) {
                    setTimeout(() => {
                        mainContent.style.transition = 'all 0.3s ease';
                        mainContent.style.opacity = '1';
                        mainContent.style.transform = 'translateY(0)';
                    }, 300);
                }
            }, 100);

            // Switch to the specified tab if provided
            if (window.currentActiveTab && window.currentActiveTab !== 'info') {
                setTimeout(() => {
                    switchToTab(window.currentActiveTab);
                }, 500); // Delay to ensure modal is fully loaded
            }

            // Configure reconsideraci贸n functionality
            const solicitudData = {
                ...data.general,
                resultado_consulta: data.general.resultado_consulta,
                es_reconsideracion: data.general.es_reconsideracion,
                propietario_id: data.general.propietario_id
            };
            console.log('Full API response data:', data);
            console.log('General data:', data.general);
            console.log('Data for reconsideraci贸n:', solicitudData);
            configurarTabReconsideracion(solicitudData);

            // Handle Canal Digital tab visibility and content
            handleCanalDigitalTab(data);

            console.log('Modal populated successfully');

        } catch (error) {
            console.error('Error populating modal:', error);
            showErrorState('Error al procesar los datos');
        }
    }

    // Function to handle Canal Digital tab visibility and content
    function handleCanalDigitalTab(data) {
        try {
            console.log('Handling Canal Digital tab with data:', data);
            
            const canalDigitalNav = document.getElementById('canal-digital-nav');
            const canalDigitalContent = document.getElementById('canal-digital-content');
            const canalDigitalEmptyState = document.querySelector('#modalSolicitudCanalDigital .empty-state');
            const canalDigitalLoading = document.querySelector('#modalSolicitudCanalDigital .loading-placeholder');
            
            if (!canalDigitalNav || !canalDigitalContent || !canalDigitalEmptyState || !canalDigitalLoading) {
                console.warn('Canal Digital tab elements not found');
                return;
            }

            // Check if solicitud was created via API
            const apiInfo = data.api_info || {};
            const isApiCreated = apiInfo.creada_via_api === true;
            
            console.log('Is API created:', isApiCreated, 'API info:', apiInfo);
            
            if (isApiCreated) {
                // Show the tab
                canalDigitalNav.style.display = 'block';
                
                // Hide loading and empty state, show content
                canalDigitalLoading.style.display = 'none';
                canalDigitalEmptyState.style.display = 'none';
                canalDigitalContent.style.display = 'block';
                
                // Populate the content
                populateCanalDigitalContent(apiInfo);
                
                console.log('Canal Digital tab shown and populated');
            } else {
                // Hide the tab
                canalDigitalNav.style.display = 'none';
                
                // Hide content, show empty state
                canalDigitalContent.style.display = 'none';
                canalDigitalLoading.style.display = 'none';
                canalDigitalEmptyState.style.display = 'block';
                
                console.log('Canal Digital tab hidden - not API created');
            }
        } catch (error) {
            console.error('Error handling Canal Digital tab:', error);
        }
    }

    // Function to populate Canal Digital tab content
    function populateCanalDigitalContent(apiInfo) {
        try {
            console.log('Populating Canal Digital content with:', apiInfo);
            
            // API Source
            const apiSourceDisplay = document.getElementById('apiSourceDisplay');
            if (apiSourceDisplay) {
                apiSourceDisplay.textContent = apiInfo.api_source || 'No especificado';
            }
            
            // API Creation Date (from general data)
            const apiCreationDate = document.getElementById('apiCreationDate');
            if (apiCreationDate) {
                const general = window.currentModalData?.general || {};
                apiCreationDate.textContent = general.fecha_inicio || 'No especificado';
            }
            
            // API Creation Method
            const apiCreationMethod = document.getElementById('apiCreationMethod');
            if (apiCreationMethod) {
                apiCreationMethod.textContent = 'API Externa';
            }
            
            // API Status
            const apiStatus = document.getElementById('apiStatus');
            if (apiStatus) {
                apiStatus.textContent = 'Activo';
            }
            
            // Observaciones
            const apiObservaciones = document.getElementById('apiObservaciones');
            if (apiObservaciones) {
                const observaciones = apiInfo.observaciones;
                if (observaciones && observaciones.trim() !== '') {
                    apiObservaciones.textContent = observaciones;
                } else {
                    apiObservaciones.textContent = 'No hay observaciones registradas';
                }
            }
            
            console.log('Canal Digital content populated successfully');
        } catch (error) {
            console.error('Error populating Canal Digital content:', error);
        }
    }

    // Function to switch to a specific tab in the modal
    function switchToTab(tabName) {
        try {
            console.log('Switching to tab:', tabName);
            
            // Find the tab and trigger click
            const tabButton = document.getElementById(`${tabName}-tab`);
            if (tabButton) {
                console.log('Found tab button, clicking:', tabButton);
                tabButton.click();
                
                // Also trigger Bootstrap tab show event
                const tabInstance = new bootstrap.Tab(tabButton);
                tabInstance.show();
                
                // Special handling for notas tab to load content
                if (tabName === 'notas') {
                    setTimeout(() => {
                        if (typeof cargarNotasRecordatorios === 'function') {
                            cargarNotasRecordatorios();
                        }
                    }, 100);
                }
            } else {
                console.warn('Tab button not found for:', tabName);
            }
        } catch (error) {
            console.error('Error switching to tab:', error);
        }
    }

    // Function to populate unified summary card
    function populateUnifiedSummaryCard(data) {
        const summaryCard = document.getElementById('modalSolicitudSummaryCard');
        if (!summaryCard) return;
        const general = data.general || {};
        const cliente = data.cliente || {};
        const cotizacion = data.cotizacion || {};
        const isCarLoan = cotizacion.tipoPrestamo === 'auto';
        const vehicleData = isCarLoan && cotizacion.marca && cotizacion.modelo ? `${cotizacion.marca} ${cotizacion.modelo}` : 'N/A';
        const summaryHtml = `
        <div class="summary-header">
            <div class="summary-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="summary-title-section">
                <h3 class="summary-title">Resumen</h3>
                <p class="summary-subtitle">Informaci贸n general</p>
            </div>
        </div>
        <div class="summary-content">
            <div class="summary-grid">
                <!-- Resumen Section -->
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-hashtag"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">C贸digo</span><span class="summary-item-value">${general.codigo || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-calendar"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Fecha Creaci贸n</span><span class="summary-item-value">${general.fecha_inicio || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-user-tie"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Propietario</span><span class="summary-item-value">${general.propietario || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-layer-group"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Pipeline</span><span class="summary-item-value">${general.tipo || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-flag"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Etapa</span><span class="summary-item-value">${general.etapa_actual || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-info-circle"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Estado</span><span class="summary-item-value">${general.estado_actual || general.estado || 'N/A'}</span></div>
                </div>
                <!-- Cliente Section -->
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-user"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Nombre</span><span class="summary-item-value">${cliente.nombre || 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-id-card"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">C茅dula</span><span class="summary-item-value">${cliente.cedula || 'N/A'}</span></div>
                </div>
                <!-- Removed Email field -->
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-briefcase"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Ocupaci贸n</span><span class="summary-item-value">${cliente.ocupacion || 'N/A'}</span></div>
                </div>
                <!-- Cotizaci贸n Section -->
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-${isCarLoan ? 'car' : 'user'}"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Producto</span><span class="summary-item-value">${cotizacion.tipoPrestamo === 'auto' ? 'Pr茅stamo de Auto' : cotizacion.tipoPrestamo === 'personal' ? 'Pr茅stamo Personal' : 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Monto</span><span class="summary-item-value">${cotizacion.auxMonto2 ? `$${cotizacion.auxMonto2.toLocaleString()}` : 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-calendar-alt"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Plazo</span><span class="summary-item-value">${cotizacion.plazo ? `${cotizacion.plazo} meses` : 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">Letra</span><span class="summary-item-value">${cotizacion.cuota ? `$${cotizacion.cuota.toLocaleString()}` : 'N/A'}</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-icon"><i class="fas fa-${isCarLoan ? 'car-side' : 'chart-line'}"></i></div>
                    <div class="summary-item-content"><span class="summary-item-label">${isCarLoan ? 'Datos Veh铆culo' : 'Prima'}</span><span class="summary-item-value">${isCarLoan ? vehicleData : (cotizacion.prima_formateada || 'N/A')}</span></div>
                </div>
            </div>
            <!-- Cotizaci贸n Actions -->
            <div class="summary-actions" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                <button type="button" 
                        class="btn-ver-cotizacion-summary" 
                        id="btnVerCotizacionSummary"
                        onclick="redirectToCotizacion()"
                        style="width: 100%; padding: 12px 20px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; cursor: pointer; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);">
                    <i class="fas fa-external-link-alt"></i>
                    Ver Cotizaci贸n Completa
                </button>
            </div>
        </div>
    `;
        summaryCard.innerHTML = summaryHtml;
        
        // Enable/disable the summary button based on cotization data availability
        setTimeout(() => {
            const btnSummary = document.getElementById('btnVerCotizacionSummary');
            if (btnSummary) {
                // Simplified check: just need cotizacion_id to redirect
                const hasCotizacionData = data.cotizacion_id;
                
                console.log(' Button enablement check:', {
                    cotizacion: !!cotizacion,
                    cotizacion_id: data.cotizacion_id,
                    tipoPrestamo: cotizacion.tipoPrestamo,
                    hasCotizacionData: hasCotizacionData
                });
                
                if (hasCotizacionData) {
                    btnSummary.disabled = false;
                    btnSummary.style.opacity = '1';
                    btnSummary.style.cursor = 'pointer';
                    console.log(' Summary Ver Cotizaci贸n button enabled');
                } else {
                    btnSummary.disabled = true;
                    btnSummary.style.opacity = '0.6';
                    btnSummary.style.cursor = 'not-allowed';
                    console.log(' Summary Ver Cotizaci贸n button disabled - no cotizacion_id');
                }
            }
        }, 100);
    }

    // Function to redirect to cotization page
    function redirectToCotizacion() {
        try {
            console.log(' redirectToCotizacion called');
            
            // Get cotization data from current modal data
            const modalData = window.currentModalData;
            console.log(' Modal data:', modalData);
            
            if (!modalData || !modalData.cotizacion) {
                console.error(' No cotization data available');
                alert('No hay informaci贸n de cotizaci贸n disponible');
                return;
            }

            // Get the related cotizacion ID and loan type from API response
            const cotizacionInfo = modalData.cotizacion || {};
            const cotizacionId = modalData.cotizacion_id;
            const tipoPrestamo = cotizacionInfo.tipoPrestamo;
            
            console.log(' Cotization details:', {
                cotizacionInfo: cotizacionInfo,
                cotizacionId: cotizacionId,
                tipoPrestamo: tipoPrestamo
            });
            
            let cotizacionUrl;

            if (!cotizacionId) {
                console.error(' No cotizacion ID available');
                alert('No hay informaci贸n de cotizaci贸n disponible para redirigir');
                return;
            }
            
            // Build URL based on loan type
            if (tipoPrestamo === 'personal') {
                cotizacionUrl = `/cotizacionPP/${cotizacionId}/`;
            } else if (tipoPrestamo === 'auto') {
                cotizacionUrl = `/cotizacion/${cotizacionId}/`;
            } else {
                console.warn('锔 Loan type not specified or unrecognized, defaulting to cotizacion_detail');
                cotizacionUrl = `/cotizacion/${cotizacionId}/`;
            }

            console.log(' Redirecting to:', cotizacionUrl);
            
            // Open in new tab
            window.open(cotizacionUrl, '_blank');
            
        } catch (error) {
            console.error(' Error redirecting to cotization:', error);
            alert('Error al abrir la cotizaci贸n');
        }
    }

    // Helper function to set element text safely
    function setElementText(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = text;
        }
    }

    // Helper function to set button disabled state safely
    function setButtonDisabled(elementId, disabled) {
        const element = document.getElementById(elementId);
        if (element) {
            element.disabled = disabled;
        }
    }

    function renderWorkflowRoadmap(etapas) {
        // Derive the index of the current etapa
        const currentIndex = Math.max(0, etapas.findIndex(e => e.actual));

        // Visibility policy:
        // - Show all etapas that are completed
        // - Show the current etapa (with the lightning bolt)
        // - Show at most the immediate next etapa after current for context
        // - Hide past etapas that were NOT traversed (not completed and index < current)
        const visibleEtapas = etapas.filter((e, i) => {
            if (e.completada || e.actual) return true;
            return i === currentIndex + 1; // show just next
        });
        const startIdx = etapas.indexOf(visibleEtapas[0]);

        let roadmapHtml = '<div class="workflow-roadmap">';

        visibleEtapas.forEach(function (etapa, localIdx) {
            // Map localIdx to the global index for numbering
            const globalIdx = startIdx + localIdx;
            let stepClass = 'workflow-step';
            if (etapa.completada) stepClass += ' completed';
            if (etapa.actual) stepClass += ' current';
            if (!etapa.completada && !etapa.actual) stepClass += ' pending';

            let icon = etapa.completada ? '<i class="fas fa-check"></i>' :
                etapa.actual ? '<i class="fas fa-bolt"></i>' :
                    `<span>${globalIdx + 1}</span>`;

            roadmapHtml += `
            <div class="${stepClass}">
                <div class="circle">${icon}</div>
                <div class="step-label">${etapa.nombre}</div>
            </div>
        `;

            if (localIdx < visibleEtapas.length - 1) {
                let connectorClass = etapa.completada ? 'workflow-connector completed' : 'workflow-connector';
                roadmapHtml += `<div class="${connectorClass}"></div>`;
            }
        });

        roadmapHtml += '</div>';

        const workflowProgress = document.getElementById('modalSolicitudWorkflowProgress');
        if (workflowProgress) {
            workflowProgress.innerHTML = roadmapHtml;

            // Auto-scroll so the current etapa is visible/centered
            const currentEl = workflowProgress.querySelector('.workflow-step.current');
            if (currentEl && currentEl.scrollIntoView) {
                // Use microtask to ensure layout is ready before scrolling
                setTimeout(() => currentEl.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }), 0);
            }
        }
    }

    // Function to populate documentos tab
    function populateDocumentosTab(documentos) {
        const documentosContainer = document.getElementById('modalSolicitudDocumentos');
        const loadingPlaceholder = documentosContainer.querySelector('.loading-placeholder');
        const emptyState = documentosContainer.querySelector('.empty-state');

        if (!documentosContainer) {
            console.error('Documentos container not found');
            return;
        }

        // Hide loading and empty states initially
        if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';

        // Clear existing content except placeholders
        const existingItems = documentosContainer.querySelectorAll('.documento-item');
        existingItems.forEach(item => item.remove());

        if (!documentos || documentos.length === 0) {
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        // Check if current stage is a group stage
        const isGroupStage = window.currentModalData?.general?.es_etapa_grupal || false;

        const documentosGrid = document.createElement('div');
        documentosGrid.className = 'documento-grid';

        documentos.forEach(documento => {
            const documentoItem = document.createElement('div');

            // Determine status class and text
            let statusClass = 'pendiente';
            let statusText = 'Pendiente';

            // Special handling for APC documents
            if (documento.nombre.toLowerCase() === 'apc' && documento.apc_processing) {
                statusClass = 'apc-procesando';
                statusText = 'Procesando por Makito RPA';
            } else if (documento.nombre.toLowerCase() === 'sura' && documento.sura_processing) {
                statusClass = 'sura-procesando';
                statusText = 'Procesando por Makito RPA';
            } else if (documento.nombre.toLowerCase() === 'cotizaci贸n sura' && documento.sura_processing) {
                statusClass = 'sura-procesando';
                statusText = 'Procesando por Makito RPA';
            } else if (documento.cumplido === true) {
                statusClass = 'cumplido';
                statusText = 'Cargado';
            } else if (documento.cumplido === false) {
                statusClass = 'no-cumplido';
                statusText = 'No Cargado';
            }

            documentoItem.className = `documento-item ${statusClass}`;

            let actionsHtml = '';
            let uploadAreaHtml = '';

            const uploadId = `upload-${documento.id || Math.random().toString(36).substr(2, 9)}`;

            if (documento.cumplido === true && documento.url && documento.url.trim() !== '') {
                // Document is loaded and has a URL
                if (isGroupStage) {
                    // In group stage - only allow download, no editing
                    actionsHtml = `
                    <div class="documento-actions">
                        <a href="${documento.url}" target="_blank" class="btn-documento btn-download">
                            <i class="fas fa-download me-1"></i>Descargar
                        </a>
                        <div class="documento-blocked-info">
                            <i class="fas fa-lock me-1"></i>
                            <span class="text-muted">Documento en revisi贸n - No se puede editar</span>
                        </div>
                    </div>
                `;
                } else {
                    // Not in group stage - show download and replace button
                    actionsHtml = `
                    <div class="documento-actions">
                        <a href="${documento.url}" target="_blank" class="btn-documento btn-download">
                            <i class="fas fa-download me-1"></i>Descargar
                        </a>
                        <button type="button" class="btn-documento btn-upload" onclick="toggleUploadArea('${uploadId}')">
                            <i class="fas fa-sync-alt me-1"></i>Reemplazar
                        </button>
                    </div>
                `;
                }
                // Only show upload area if not in group stage
                if (!isGroupStage) {
                    uploadAreaHtml = `
                    <div class="upload-area" id="${uploadId}">
                        <div class="upload-text">
                            <i class="fas fa-cloud-upload-alt"></i><br>
                            Arrastra el archivo aqu铆 o haz clic para seleccionar
                        </div>
                        <input type="file" class="upload-input" id="${uploadId}-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                        <div class="file-preview" id="${uploadId}-preview">
                            <div class="file-info">
                                <i class="fas fa-file"></i>
                                <span class="file-name"></span>
                                <span class="file-size"></span>
                            </div>
                            <button type="button" class="file-remove" onclick="removeFile('${uploadId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="upload-progress" id="${uploadId}-progress">
                            <div class="progress-bar-custom">
                                <div class="progress-fill"></div>
                            </div>
                        </div>
                        <div class="upload-buttons" id="${uploadId}-buttons">
                            <button type="button" class="btn-upload-confirm" onclick="uploadDocument('${uploadId}', '${documento.id || ''}', '${documento.nombre || ''}')">
                                <i class="fas fa-check me-1"></i>Confirmar Subida
                            </button>
                            <button type="button" class="btn-upload-cancel" onclick="cancelUpload('${uploadId}')">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                        </div>
                    </div>
                `;
                }
            } else {
                // Document is missing or not loaded

                // Special handling for APC documents being processed
                if (documento.nombre.toLowerCase() === 'apc' && documento.apc_processing) {
                    actionsHtml = `
                    <div class="documento-actions">
                        <div class="documento-blocked-info" style="background: #dbeafe; border-color: #3b82f6; color: #1e40af;">
                            <i class="fas fa-robot me-1"></i>
                            <span>Procesando por Makito RPA</span>
                        </div>
                        ${documento.apc_fecha_solicitud ? `
                        <div class="documento-observaciones" style="margin-top: 8px; font-size: 0.8rem;">
                            <strong>Solicitado:</strong> ${documento.apc_fecha_solicitud}
                        </div>
                        ` : ''}
                        ${documento.apc_fecha_inicio ? `
                        <div class="documento-observaciones" style="margin-top: 4px; font-size: 0.8rem;">
                            <strong>Iniciado:</strong> ${documento.apc_fecha_inicio}
                        </div>
                        ` : ''}
                    </div>
                `;
                // Special handling for SURA documents being processed
                } else if ((documento.nombre.toLowerCase() === 'sura' || documento.nombre.toLowerCase() === 'cotizaci贸n sura') && documento.sura_processing) {
                    actionsHtml = `
                    <div class="documento-actions">
                        <div class="documento-blocked-info" style="background: #dbeafe; border-color: #3b82f6; color: #1e40af;">
                            <i class="fas fa-robot me-1"></i>
                            <span>Procesando por Makito RPA</span>
                        </div>
                        ${documento.sura_fecha_solicitud ? `
                        <div class="documento-observaciones" style="margin-top: 8px; font-size: 0.8rem;">
                            <strong>Solicitado:</strong> ${documento.sura_fecha_solicitud}
                        </div>
                        ` : ''}
                        ${documento.sura_fecha_inicio ? `
                        <div class="documento-observaciones" style="margin-top: 4px; font-size: 0.8rem;">
                            <strong>Iniciado:</strong> ${documento.sura_fecha_inicio}
                        </div>
                        ` : ''}
                    </div>
                `;
                } else if (isGroupStage) {
                    // In group stage - show blocked message
                    actionsHtml = `
                    <div class="documento-actions">
                        <div class="documento-blocked-info">
                            <i class="fas fa-lock me-1"></i>
                            <span class="text-muted">Documento bloqueado - En etapa de revisi贸n grupal</span>
                        </div>
                    </div>
                `;
                } else {
                    // Not in group stage - show upload button
                    actionsHtml = `
                    <div class="documento-actions">
                        <button type="button" class="btn-documento btn-upload" onclick="toggleUploadArea('${uploadId}')">
                            <i class="fas fa-upload me-1"></i>Subir Documento
                        </button>
                    </div>
                `;
                }
                // Only show upload area if not in group stage
                if (!isGroupStage) {
                    uploadAreaHtml = `
                    <div class="upload-area" id="${uploadId}">
                        <div class="upload-text">
                            <i class="fas fa-cloud-upload-alt"></i><br>
                            Arrastra el archivo aqu铆 o haz clic para seleccionar
                        </div>
                        <input type="file" class="upload-input" id="${uploadId}-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                        <div class="file-preview" id="${uploadId}-preview">
                            <div class="file-info">
                                <i class="fas fa-file"></i>
                                <span class="file-name"></span>
                                <span class="file-size"></span>
                            </div>
                            <button type="button" class="file-remove" onclick="removeFile('${uploadId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="upload-progress" id="${uploadId}-progress">
                            <div class="progress-bar-custom">
                                <div class="progress-fill"></div>
                            </div>
                        </div>
                        <div class="upload-buttons" id="${uploadId}-buttons">
                            <button type="button" class="btn-upload-confirm" onclick="uploadDocument('${uploadId}', '${documento.id || ''}', '${documento.nombre || ''}')">
                                <i class="fas fa-check me-1"></i>Confirmar Subida
                            </button>
                            <button type="button" class="btn-upload-cancel" onclick="cancelUpload('${uploadId}')">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                        </div>
                    </div>
                `;
                }
            }

            let observacionesHtml = '';
            if (documento.observaciones && documento.observaciones.trim() !== '') {
                observacionesHtml = `
                <div class="documento-observaciones">
                    <strong>Observaciones:</strong> ${documento.observaciones}
                </div>
            `;
            }

            documentoItem.innerHTML = `
            <div class="documento-header">
                <div class="documento-nombre">${documento.nombre || 'Documento sin nombre'}</div>
                <span class="documento-status ${statusClass}">${statusText}</span>
            </div>
            ${observacionesHtml}
            ${actionsHtml}
            ${uploadAreaHtml}
        `;

            documentosGrid.appendChild(documentoItem);
        });

        documentosContainer.appendChild(documentosGrid);

        console.log(`Populated ${documentos.length} documentos in the tab`);
    }

    // Function to populate historial tab
    function populateHistorialTab(historial) {
        const historialContainer = document.getElementById('modalSolicitudHistorial');
        const loadingPlaceholder = historialContainer.querySelector('.loading-placeholder');
        const emptyState = historialContainer.querySelector('.empty-state');

        if (!historialContainer) {
            console.error('Historial container not found');
            return;
        }

        // Hide loading and empty states initially
        if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';

        // Clear existing content except placeholders
        const existingItems = historialContainer.querySelectorAll('.timeline-date-group');
        existingItems.forEach(item => item.remove());

        if (!historial || historial.length === 0) {
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        // Sort historial by date (most recent first)
        const sortedHistorial = historial.sort((a, b) => {
            const dateA = new Date(a.fecha_inicio || a.fecha_creacion || 0);
            const dateB = new Date(b.fecha_inicio || b.fecha_creacion || 0);
            return dateB - dateA;
        });

        // Group events by date
        const groupedEvents = groupEventsByDate(sortedHistorial);

        // Create compact timeline groups
        Object.keys(groupedEvents).forEach((dateKey, groupIndex) => {
            const events = groupedEvents[dateKey];
            const timelineGroup = document.createElement('div');
            timelineGroup.className = 'timeline-date-group';

            const formattedDate = formatDateForGroup(dateKey);
            const dateDisplay = getDateDisplay(dateKey);

            let eventsHtml = '';
            events.forEach((evento, index) => {
                const eventType = getEventType(evento);
                const userInitials = getUserInitials(evento.usuario || 'Usuario');
                const userColor = getUserColor(evento.usuario || 'Usuario');
                const eventIcon = getEventIcon(eventType.tipo);
                const eventTime = formatTime(evento.fecha_inicio || evento.fecha_creacion);

                eventsHtml += `
                    <div class="timeline-event ${index === 0 ? 'first-event' : ''} ${index === events.length - 1 ? 'last-event' : ''}">
                        <div class="event-marker">
                            <div class="event-icon" style="background-color: ${userColor}">
                                <i class="${eventIcon}"></i>
                            </div>
                        </div>
                        <div class="event-content">
                            <div class="event-header">
                                <div class="event-title">
                                    <span class="event-user">${evento.usuario || 'Usuario'}</span>
                                    <span class="event-action">${eventType.action}</span>
                                </div>
                                <div class="event-time">${eventTime}</div>
                            </div>
                            ${eventType.details ? `
                                <div class="event-details">${eventType.details}</div>
                            ` : ''}
                            ${eventType.subtitle ? `
                                <div class="event-subtitle">${eventType.subtitle}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            timelineGroup.innerHTML = `
                <div class="timeline-date-header">
                    <div class="date-marker">
                        <div class="date-indicator">
                            <span class="date-number">${dateDisplay.day}</span>
                            <span class="date-month">${dateDisplay.month}</span>
                        </div>
                    </div>
                    <div class="date-info">
                        <h4 class="date-title">${formattedDate}</h4>
                        <span class="events-count">${events.length} evento${events.length !== 1 ? 's' : ''}</span>
                    </div>
                </div>
                <div class="timeline-events">
                    ${eventsHtml}
                </div>
            `;

            historialContainer.appendChild(timelineGroup);
        });

        console.log(`Populated ${historial.length} events in ${Object.keys(groupedEvents).length} date groups`);
    }

    // Helper function to get date display components
    function getDateDisplay(dateKey) {
        const date = new Date(dateKey);
        const day = date.getDate().toString();
        const month = date.toLocaleDateString('es-ES', { month: 'short' }).toUpperCase();

        return { day, month };
    }

    // Helper function to get event icon based on type
    function getEventIcon(tipo) {
        const iconMap = {
            'etapa': 'fas fa-route',
            'comentario': 'fas fa-comment',
            'documento': 'fas fa-file-alt',
            'requisito': 'fas fa-tasks',
            'asignacion': 'fas fa-user-plus',
            'inicio': 'fas fa-play-circle',
            'cambio': 'fas fa-exchange-alt'
        };

        return iconMap[tipo] || 'fas fa-circle';
    }

    // Helper function to group events by date
    function groupEventsByDate(historial) {
        const grouped = {};

        historial.forEach(evento => {
            const date = new Date(evento.fecha_inicio || evento.fecha_creacion);
            const dateKey = date.toISOString().split('T')[0]; // YYYY-MM-DD format

            if (!grouped[dateKey]) {
                grouped[dateKey] = [];
            }
            grouped[dateKey].push(evento);
        });

        return grouped;
    }

    // Helper function to format date for group headers
    function formatDateForGroup(dateKey) {
        const date = new Date(dateKey);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (date.toDateString() === today.toDateString()) {
            return 'Hoy';
        } else if (date.toDateString() === yesterday.toDateString()) {
            return 'Ayer';
        } else {
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    }

    // Helper function to format time
    function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Helper function to get user initials
    function getUserInitials(userName) {
        if (!userName || userName === 'Usuario no especificado') {
            return 'U';
        }

        const names = userName.split(' ');
        if (names.length >= 2) {
            return (names[0][0] + names[1][0]).toUpperCase();
        } else if (names.length === 1) {
            return names[0][0].toUpperCase();
        }
        return 'U';
    }

    // Helper function to get user color based on name
    function getUserColor(userName) {
        if (!userName || userName === 'Usuario no especificado') {
            return '#6b7280';
        }

        // Simple hash function to generate consistent colors
        let hash = 0;
        for (let i = 0; i < userName.length; i++) {
            hash = userName.charCodeAt(i) + ((hash << 5) - hash);
        }

        const colors = [
            '#3b82f6', // blue
            '#10b981', // green
            '#f59e0b', // amber
            '#ef4444', // red
            '#8b5cf6', // violet
            '#06b6d4', // cyan
            '#f97316', // orange
            '#ec4899', // pink
            '#84cc16', // lime
            '#6366f1'  // indigo
        ];

        return colors[Math.abs(hash) % colors.length];
    }

    // Helper function to determine event type
    function getEventType(evento) {
        // Use the tipo field if available, otherwise fall back to field detection
        const tipo = evento.tipo;

        if (tipo === 'etapa' || evento.etapa) {
            return {
                tipo: 'etapa',
                title: evento.etapa,
                action: `cambi贸 la etapa a "${evento.etapa}"`,
                details: evento.subestado ? `SubEstado: ${evento.subestado}` : '',
                subtitle: evento.comentarios || ''
            };
        }

        if (tipo === 'comentario' || evento.texto || evento.comentario) {
            return {
                tipo: 'comentario',
                title: 'Comentario',
                action: 'agreg贸 un comentario',
                details: evento.texto || evento.comentario || '',
                subtitle: ''
            };
        }

        if (tipo === 'documento' || evento.archivo || evento.url) {
            return {
                tipo: 'documento',
                title: 'Documento',
                action: evento.archivo ? `subi贸 el documento "${evento.archivo}"` : 'actualiz贸 un documento',
                details: evento.observaciones || '',
                subtitle: ''
            };
        }

        if (tipo === 'requisito' || evento.requisito) {
            return {
                tipo: 'requisito',
                title: 'Requisito',
                action: `marc贸 como ${evento.cumplido ? 'cumplido' : 'no cumplido'} el requisito "${evento.requisito}"`,
                details: evento.observaciones || '',
                subtitle: ''
            };
        }

        if (tipo === 'asignacion' || evento.usuario_asignado) {
            return {
                tipo: 'asignacion',
                title: 'Asignaci贸n',
                action: `asign贸 la solicitud a ${evento.usuario_asignado}`,
                details: '',
                subtitle: ''
            };
        }

        // Default event
        return {
            tipo: 'cambio',
            title: 'Actividad',
            action: 'realiz贸 una actividad',
            details: evento.descripcion || '',
            subtitle: ''
        };
    }

    // Helper function to determine event status
    function getEventStatus(evento) {
        // Check if it's the current stage
        if (evento.etapa && window.currentModalData?.general?.etapa_actual === evento.etapa) {
            return 'current';
        }

        // Check if it's completed (has end date)
        if (evento.fecha_fin) {
            return 'completed';
        }

        // Check if it's pending
        if (evento.fecha_inicio && !evento.fecha_fin) {
            return 'pending';
        }

        // Default to completed for other events
        return 'completed';
    }

    // Helper function to calculate duration
    function calculateDuration(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
            return '1 d铆a';
        } else if (diffDays < 7) {
            return `${diffDays} d铆as`;
        } else if (diffDays < 30) {
            const weeks = Math.floor(diffDays / 7);
            return `${weeks} semana${weeks > 1 ? 's' : ''}`;
        } else {
            const months = Math.floor(diffDays / 30);
            return `${months} mes${months > 1 ? 'es' : ''}`;
        }
    }

    // Helper function to format date
    function formatDate(dateString) {
        if (!dateString) return 'Fecha no disponible';

        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
            return 'Ayer';
        } else if (diffDays === 0) {
            return 'Hoy';
        } else if (diffDays < 7) {
            return `Hace ${diffDays} d铆as`;
        } else {
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }





    // ============================================
    // FUNCIONES PARA DOCUMENTOS URGENTES
    // ============================================

    function populateDocumentosUrgentesTab(documentos) {
        try {
            console.log(' INICIANDO populateDocumentosUrgentesTab');
            
        const urgentesContainer = document.getElementById('modalSolicitudDocumentosUrgentes');
        const loadingPlaceholder = urgentesContainer.querySelector('.loading-placeholder');
        const emptyState = urgentesContainer.querySelector('.empty-state');
        const urgentesNav = document.getElementById('documentos-urgentes-nav');
            
            if (urgentesNav) {
                console.log(' Nav de documentos urgentes encontrado');
            } else {
                console.log(' ERROR: Nav de documentos urgentes no encontrado');
            }

        if (!urgentesContainer) {
                console.error(' ERROR: Documentos urgentes container not found');
            return;
            } else {
                console.log(' Documentos urgentes container encontrado');
        }

        // Hide loading and empty states initially
            if (loadingPlaceholder) {
                loadingPlaceholder.style.display = 'none';
                console.log(' Loading placeholder ocultado');
            } else {
                console.log('锔 Loading placeholder no encontrado');
            }
            if (emptyState) {
                emptyState.style.display = 'none';
                console.log(' Empty state ocultado');
            } else {
                console.log('锔 Empty state no encontrado');
            }

        // Clear existing content
        const existingItems = urgentesContainer.querySelectorAll('.documento-item');
        existingItems.forEach(item => item.remove());

            // DEBUG: Log todos los documentos recibidos
            console.log(' DEBUG: Todos los documentos recibidos:', documentos);

        // Filtrar documentos urgentes (calificados como "malo")
        console.log(' DEBUG: Filtrando documentos urgentes...');
        const documentosUrgentes = documentos.filter(doc => {
                console.log(` DEBUG: Analizando documento "${doc.nombre}":`, {
                    id: doc.id,
                    calificacion_estado: doc.calificacion_estado,
                    subsanado: doc.subsanado,
                    motivo_calificacion: doc.motivo_calificacion,
                    calificado_por: doc.calificado_por,
                    fecha_calificacion: doc.fecha_calificacion
                });
                
            const esUrgente = doc.calificacion_estado === 'malo' && !doc.subsanado;
            if (esUrgente) {
                console.log(` "${doc.nombre}" es urgente: malo=${doc.calificacion_estado === 'malo'}, subsanado=${doc.subsanado}`);
                } else {
                    console.log(` "${doc.nombre}" NO es urgente: malo=${doc.calificacion_estado === 'malo'}, subsanado=${doc.subsanado}`);
            }
            return esUrgente;
        });
        
        console.log(' DEBUG: Documentos urgentes encontrados:', documentosUrgentes);

        // Mostrar/ocultar tab seg煤n si hay documentos urgentes
        if (documentosUrgentes.length === 0) {
                if (urgentesNav) {
                    urgentesNav.style.display = 'none';
                    console.log(' DEBUG: Ocultando tab de documentos urgentes');
                }
                if (emptyState) {
                    emptyState.style.display = 'block';
                    console.log(' DEBUG: Mostrando estado vac铆o');
                }
                console.log(' DEBUG: No hay documentos urgentes, ocultando tab');
            return;
        } else {
                if (urgentesNav) {
                    urgentesNav.style.display = 'block';
                    console.log(' DEBUG: Mostrando tab de documentos urgentes');
                }
                console.log(` DEBUG: Mostrando tab con ${documentosUrgentes.length} documentos urgentes`);
        }

        const documentosGrid = document.createElement('div');
        documentosGrid.className = 'documento-grid';

        documentosUrgentes.forEach(documento => {
            const documentoItem = document.createElement('div');
            documentoItem.className = 'documento-item urgente';

            const uploadId = `upload-urgente-${documento.id || Math.random().toString(36).substr(2, 9)}`;

            let motivoHtml = '';
            if (documento.motivo_calificacion || documento.comentario_reciente) {
                motivoHtml = `
                    <div class="documento-calificacion-info malo">
                        <div class="row">
                            ${documento.motivo_calificacion ? `
                                <div class="col-6">
                                    <strong>Motivo:</strong> ${documento.motivo_calificacion}
                                </div>
                            ` : ''}
                            ${documento.comentario_reciente ? `
                                <div class="col-6">
                                    <strong>Comentario:</strong> ${documento.comentario_reciente}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            let metaHtml = '';
            if (documento.calificado_por || documento.fecha_calificacion) {
                metaHtml = `
                    <div class="documento-meta">
                        <span class="documento-usuario">
                            <i class="fas fa-user me-1"></i>${documento.calificado_por || 'Usuario'}
                        </span>
                        <span class="documento-fecha">
                            <i class="fas fa-calendar me-1"></i>${documento.fecha_calificacion || 'Fecha no disponible'}
                        </span>
                    </div>
                `;
            }
            
            // NUEVO: Badges temporalmente comentados hasta ejecutar migration
            let badgesHtml = '';
            // COMENTADO TEMPORALMENTE - EJECUTAR MIGRATION PRIMERO
            // if (documento.subsanado_por_oficial) {
            //     badgesHtml += `
            //         <div class="documento-badge-oficial">
            //             <i class="fas fa-check-circle me-1"></i>
            //             <span class="badge-text">Subsanado por Oficial</span>
            //         </div>
            //     `;
            // }
            // if (documento.pendiente_completado) {
            //     badgesHtml += `
            //         <div class="documento-badge-pendiente">
            //             <i class="fas fa-clock-o me-1"></i>
            //             <span class="badge-text">Pendiente Completado</span>
            //         </div>
            //     `;
            // }

            let actionsHtml = `
                <div class="documento-actions">
                    <button type="button" class="btn-documento btn-replace" onclick="toggleUploadArea('${uploadId}')">
                        <i class="fas fa-sync-alt me-1"></i>Reemplazar Documento
                    </button>
                </div>
            `;

            let uploadAreaHtml = `
                <div class="upload-area" id="${uploadId}">
                    <div class="upload-text">
                        <i class="fas fa-cloud-upload-alt"></i><br>
                        Arrastra el nuevo archivo aqu铆 o haz clic para seleccionar
                    </div>
                    <input type="file" class="upload-input" id="${uploadId}-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                    <div class="file-preview" id="${uploadId}-preview">
                        <div class="file-info">
                            <i class="fas fa-file"></i>
                            <span class="file-name"></span>
                            <span class="file-size"></span>
                        </div>
                        <button type="button" class="file-remove" onclick="removeFile('${uploadId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="upload-progress" id="${uploadId}-progress">
                        <div class="progress-bar-custom">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="upload-buttons" id="${uploadId}-buttons">
                        <button type="button" class="btn-upload-confirm" onclick="replaceDocument('${uploadId}', '${documento.id || ''}', '${documento.nombre || ''}')">
                            <i class="fas fa-check me-1"></i>Confirmar Reemplazo
                        </button>
                        <button type="button" class="btn-upload-cancel" onclick="cancelUpload('${uploadId}')">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                    </div>
                </div>
            `;

            documentoItem.innerHTML = `
                <div class="documento-header">
                    <div class="documento-nombre">${documento.nombre || 'Documento sin nombre'}</div>
                    <span class="documento-status urgente"> MALO</span>
                </div>
                ${motivoHtml}
                ${metaHtml}
                ${badgesHtml}
                ${actionsHtml}
                ${uploadAreaHtml}
            `;

            documentosGrid.appendChild(documentoItem);
        });

        urgentesContainer.appendChild(documentosGrid);
            console.log(` DEBUG: Populated ${documentosUrgentes.length} documentos urgentes`);
            console.log(' DEBUG: Contenido del contenedor urgentes:', urgentesContainer.innerHTML.length, 'caracteres');
            console.log(' DEBUG: Elementos .documento-item creados:', urgentesContainer.querySelectorAll('.documento-item').length);
            

            
            console.log(' FINALIZANDO populateDocumentosUrgentesTab exitosamente');
            
        } catch (error) {
            console.error(' ERROR CRTICO en populateDocumentosUrgentesTab:', error);
            console.error(' ERROR Stack:', error.stack);
            
            // Mostrar estado de error en la UI
            const urgentesContainer = document.getElementById('modalSolicitudDocumentosUrgentes');
            if (urgentesContainer) {
                urgentesContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Error al cargar documentos urgentes:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
    }

    // ============================================
    // FUNCIONES PARA DOCUMENTOS PENDIENTES
    // ============================================

    function populateDocumentosPendientesTab(documentos) {
        try {
            console.log(' INICIANDO populateDocumentosPendientesTab');
            
        const pendientesContainer = document.getElementById('modalSolicitudDocumentosPendientes');
        const loadingPlaceholder = pendientesContainer.querySelector('.loading-placeholder');
        const emptyState = pendientesContainer.querySelector('.empty-state');

        if (!pendientesContainer) {
                console.error(' ERROR: Documentos pendientes container not found');
            return;
            } else {
                console.log(' Documentos pendientes container encontrado');
        }

        // CRTICO: Limpiar completamente el contenedor antes de renderizar
        console.log('Ч Limpiando contenedor de documentos pendientes...');
        const existingGrids = pendientesContainer.querySelectorAll('.documento-grid');
        existingGrids.forEach(grid => grid.remove());
        
        // Hide loading and empty states initially
        if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';

        // Clear existing content
        const existingItems = pendientesContainer.querySelectorAll('.documento-item');
        existingItems.forEach(item => item.remove());

        // Filtrar documentos pendientes - LGICA ESTRICTA MEJORADA
        console.log(' DEBUG: Todos los documentos recibidos:', documentos);
        
        const documentosPendientes = documentos.filter(doc => {
            console.log(` DEBUG: Analizando documento "${doc.nombre}":`, {
                id: doc.id,
                obligatorio: doc.obligatorio,
                cumplido: doc.cumplido,
                calificacion_estado: doc.calificacion_estado,
                url: doc.url,
                hasFile: doc.url && doc.url !== ''
            });
            
            // EXCLUSIN PRIORITARIA: Si est谩 cumplido o tiene archivo, NO debe aparecer
            if (doc.cumplido || (doc.url && doc.url !== '')) {
                console.log(` "${doc.nombre}" EXCLUIDO: cumplido=${doc.cumplido}, hasFile=${doc.url && doc.url !== ''}`);
                return false;
            }
            
            // INCLUSIN 1: Documentos calificados expl铆citamente como 'pendiente' SIN archivo
            if (doc.calificacion_estado === 'pendiente') {
                console.log(` "${doc.nombre}" incluido: calificado como pendiente SIN archivo`);
                return true;
            }
            
            // INCLUSIN 2: Documentos NO obligatorios sin archivo y sin estar cumplidos
            if (!doc.obligatorio && !doc.cumplido && (!doc.url || doc.url === '')) {
                console.log(` "${doc.nombre}" incluido: no obligatorio SIN archivo`);
                return true;
            }
            
            // INCLUSIN 3: Documentos sin calificaci贸n, sin archivo, no obligatorios
            if (!doc.calificacion_estado && !doc.cumplido && !doc.obligatorio && (!doc.url || doc.url === '')) {
                console.log(` "${doc.nombre}" incluido: sin calificaci贸n SIN archivo, no obligatorio`);
                return true;
            }
            
            console.log(` "${doc.nombre}" excluido: no cumple criterios de pendiente`);
            return false;
        });
        
        console.log(' DEBUG: Documentos pendientes filtrados:', documentosPendientes);

        // TEMPORAL: Esta verificaci贸n se movi贸 al final para mejor debugging

        const documentosGrid = document.createElement('div');
        documentosGrid.className = 'documento-grid';

        documentosPendientes.forEach(documento => {
            const documentoItem = document.createElement('div');
            documentoItem.className = 'documento-item pendiente-opcional';

            const uploadId = `upload-pendiente-${documento.id || Math.random().toString(36).substr(2, 9)}`;

            let statusText = ' Pendiente no obligatorio';
            let statusClass = 'pendiente-opcional';

            if (documento.calificacion_estado === 'pendiente') {
                statusText = ' Pendiente';
            }
            
            // NUEVO: Badges temporalmente comentados hasta ejecutar migration  
            let badgesPendientesHtml = '';
            // COMENTADO TEMPORALMENTE - EJECUTAR MIGRATION PRIMERO
            // if (documento.subsanado_por_oficial) {
            //     badgesPendientesHtml += `
            //         <div class="documento-badge-oficial">
            //             <i class="fas fa-check-circle me-1"></i>
            //             <span class="badge-text">Subsanado por Oficial</span>
            //         </div>
            //     `;
            // }
            // if (documento.pendiente_completado) {
            //     badgesPendientesHtml += `
            //         <div class="documento-badge-pendiente">
            //             <i class="fas fa-clock-o me-1"></i>
            //             <span class="badge-text">Pendiente Completado</span>
            //         </div>
            //     `;
            // }

            let actionsHtml = `
                <div class="documento-actions">
                    <button type="button" class="btn-documento btn-upload" onclick="toggleUploadArea('${uploadId}')">
                        <i class="fas fa-upload me-1"></i>Subir Documento
                    </button>
                </div>
            `;

            let uploadAreaHtml = `
                <div class="upload-area" id="${uploadId}">
                    <div class="upload-text">
                        <i class="fas fa-cloud-upload-alt"></i><br>
                        Arrastra el archivo aqu铆 o haz clic para seleccionar
                    </div>
                    <input type="file" class="upload-input" id="${uploadId}-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                    <div class="file-preview" id="${uploadId}-preview">
                        <div class="file-info">
                            <i class="fas fa-file"></i>
                            <span class="file-name"></span>
                            <span class="file-size"></span>
                        </div>
                        <button type="button" class="file-remove" onclick="removeFile('${uploadId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="upload-progress" id="${uploadId}-progress">
                        <div class="progress-bar-custom">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="upload-buttons" id="${uploadId}-buttons">
                        <button type="button" class="btn-upload-confirm" onclick="uploadDocumentPendiente('${uploadId}', '${documento.id || ''}', '${documento.nombre || ''}')">
                            <i class="fas fa-check me-1"></i>Confirmar Subida
                        </button>
                        <button type="button" class="btn-upload-cancel" onclick="cancelUpload('${uploadId}')">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                    </div>
                </div>
            `;

            documentoItem.innerHTML = `
                <div class="documento-header">
                    <div class="documento-nombre">${documento.nombre || 'Documento sin nombre'}</div>
                    <span class="documento-status ${statusClass}">${statusText}</span>
                </div>
                ${badgesPendientesHtml}
                ${actionsHtml}
                ${uploadAreaHtml}
            `;

            documentosGrid.appendChild(documentoItem);
        });

        // Solo agregar el grid si tiene documentos
        if (documentosPendientes.length > 0) {
            pendientesContainer.appendChild(documentosGrid);
            console.log(` Mostrados ${documentosPendientes.length} documentos pendientes`);
                console.log(' DEBUG: Contenido del contenedor pendientes:', pendientesContainer.innerHTML.length, 'caracteres');
                console.log(' DEBUG: Elementos .documento-item creados:', pendientesContainer.querySelectorAll('.documento-item').length);
                

        } else {
            console.log(' No hay documentos pendientes - mostrando estado vac铆o');
            if (emptyState) emptyState.style.display = 'block';
            }
            console.log(' FINALIZANDO populateDocumentosPendientesTab exitosamente');
            
        } catch (error) {
            console.error(' ERROR CRTICO en populateDocumentosPendientesTab:', error);
            console.error(' ERROR Stack:', error.stack);
            
            // Mostrar estado de error en la UI
            const pendientesContainer = document.getElementById('modalSolicitudDocumentosPendientes');
            if (pendientesContainer) {
                pendientesContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Error al cargar documentos pendientes:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
    }

    // ============================================
    // FUNCIONES DE UPLOAD Y REEMPLAZO
    // ============================================

    window.replaceDocument = function(uploadId, documentoId, documentoNombre) {
        uploadDocumentGeneric(uploadId, documentoId, documentoNombre, 'replace');
    };

    window.uploadDocumentPendiente = function(uploadId, documentoId, documentoNombre) {
        uploadDocumentGeneric(uploadId, documentoId, documentoNombre, 'upload');
    };

    function uploadDocumentGeneric(uploadId, documentoId, documentoNombre, action) {
        const input = document.getElementById(`${uploadId}-input`);
        const progressElement = document.getElementById(`${uploadId}-progress`);
        const progressFill = progressElement.querySelector('.progress-fill');
        const buttons = document.getElementById(`${uploadId}-buttons`);
        
        if (!input.files || input.files.length === 0) {
            showConfirmationMessage('Por favor selecciona un archivo', 'error');
            return;
        }

        const file = input.files[0];
        const formData = new FormData();
        formData.append('archivo', file);
        formData.append('documento_id', documentoId);
        formData.append('documento_nombre', documentoNombre);
        formData.append('action', action);
        formData.append('csrfmiddlewaretoken', getCsrfToken());

        // Show progress
        progressElement.style.display = 'block';
        buttons.querySelectorAll('button').forEach(btn => btn.disabled = true);

        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentage = (e.loaded / e.total) * 100;
                progressFill.style.width = percentage + '%';
            }
        });

        xhr.onload = function() {
            progressElement.style.display = 'none';
            buttons.querySelectorAll('button').forEach(btn => btn.disabled = false);
            
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        showConfirmationMessage(
                            action === 'replace' ? 
                            `Documento "${documentoNombre}" reemplazado exitosamente. Actualizando vista...` :
                            `Documento "${documentoNombre}" subido exitosamente. El documento se remover谩 de pendientes...`, 
                            'success'
                        );
                        
                        // Refresh modal data - CON VERIFICACIN DE DATOS
                        if (window.currentSolicitudId) {
                            console.log(' Refrescando modal despu茅s de upload exitoso...', {
                                documentoId: documentoId,
                                documentoNombre: documentoNombre,
                                action: action,
                                solicitudId: window.currentSolicitudId
                            });
                            
                            // Limpiar datos cacheados si existen
                            if (window.modalDataCache) {
                                delete window.modalDataCache[window.currentSolicitudId];
                                console.log('锔 Cache limpiado para solicitud', window.currentSolicitudId);
                            }
                            
                            setTimeout(() => {
                                console.log(' Ejecutando refresh del modal...');
                                mostrarModalSolicitud(window.currentSolicitudId);
                            }, 300); // M谩s r谩pido para mejor UX
                        }
                    } else {
                        showConfirmationMessage(response.error || 'Error al procesar el archivo', 'error');
                    }
                } catch (e) {
                    showConfirmationMessage('Error al procesar la respuesta del servidor', 'error');
                }
            } else {
                showConfirmationMessage(`Error del servidor: ${xhr.status}`, 'error');
            }
        };

        xhr.onerror = function() {
            progressElement.style.display = 'none';
            buttons.querySelectorAll('button').forEach(btn => btn.disabled = false);
            showConfirmationMessage('Error de conexi贸n', 'error');
        };

        // Send request
        const apiUrl = `/workflow/api/upload-documento/${window.currentSolicitudId}/`;
        xhr.open('POST', apiUrl, true);
        xhr.send(formData);
    }

    // ============================================
    // FUNCIONES UTILITARIAS
    // ============================================

    function showConfirmationMessage(message, type = 'success') {
        // Remove existing messages
        document.querySelectorAll('.confirmation-message').forEach(msg => msg.remove());
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `confirmation-message ${type}`;
        messageDiv.innerHTML = `
            <i class="fas ${
                type === 'success' ? 'fa-check-circle' : 
                type === 'error' ? 'fa-exclamation-circle' : 
                'fa-info-circle'
            } me-2"></i>
            ${message}
        `;
        
        document.body.appendChild(messageDiv);
        
        // Show animation
        setTimeout(() => messageDiv.classList.add('show'), 100);
        
        // Auto remove
        setTimeout(() => {
            messageDiv.classList.remove('show');
            setTimeout(() => messageDiv.remove(), 300);
        }, 3000);
    }

    function getCsrfToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }

    function getMockData(solicitudId) {
        return {
            general: {
                codigo: `SOL-${solicitudId}`,
                estado: 'En Proceso',
                tipo: 'Solicitud de pr茅stamo personal',
                fecha_inicio: '2025-07-01',
                vencimiento: '2025-07-15',
                etapa_actual: 'Evaluaci贸n Crediticia',
                area: 'Cr茅ditos'
            },
            cliente: {
                nombre: 'Juan P茅rez Rodr铆guez',
                cedula: '1-234-567',
                edad: 30,
                sexo: 'Masculino',
                cartera: 'Cartera A'
            },
            cotizacion: {
                monto: 25000,
                plazo: 36,
                tasa: 12.5,
                cuota: 825.50,
                monto_financiado: 20000,
                tasa_interes: 10.0,
                monto_letra: 21000,
                auxMonto2: 20000 // Added for testing
            },
            acciones: {
                puede_procesar: true,
                puede_devolver: true,
                puede_anular: false,
                puede_comentar: true
            },
            workflow: [
                {
                    nombre: 'Recepci贸n',
                    completada: true,
                    actual: false,
                    sla: '2 d铆as'
                },
                {
                    nombre: 'Verificaci贸n',
                    completada: true,
                    actual: false,
                    sla: '1 d铆a'
                },
                {
                    nombre: 'Evaluaci贸n',
                    completada: false,
                    actual: true,
                    sla: '3 d铆as'
                },
                {
                    nombre: 'Aprobaci贸n',
                    completada: false,
                    actual: false,
                    sla: '2 d铆as'
                },
                {
                    nombre: 'Desembolso',
                    completada: false,
                    actual: false,
                    sla: '1 d铆a'
                }
            ],
            documentos: [
                {
                    id: 1,
                    nombre: 'C茅dula de Identidad',
                    url: '/media/documentos/cedula_123.pdf',
                    cumplido: true,
                    observaciones: 'Documento cargado y verificado'
                },
                {
                    id: 2,
                    nombre: 'Comprobante de Ingresos',
                    url: '/media/documentos/ingresos_123.pdf',
                    cumplido: true,
                    observaciones: ''
                },
                {
                    id: 3,
                    nombre: 'Referencias Comerciales',
                    url: '',
                    cumplido: false,
                    observaciones: 'Pendiente por cargar documento actualizado'
                },
                {
                    id: 4,
                    nombre: 'Carta de Trabajo',
                    url: '',
                    cumplido: null,
                    observaciones: 'Documento requerido - debe ser cargado para continuar'
                },
                {
                    id: 5,
                    nombre: 'Estados de Cuenta Bancarios',
                    url: '',
                    cumplido: false,
                    observaciones: 'ltimos 3 meses - debe ser cargado'
                },
                {
                    id: 6,
                    nombre: 'Declaraci贸n de Renta',
                    url: '',
                    cumplido: null,
                    observaciones: 'A帽o fiscal anterior - debe ser cargado'
                }
            ],
            historial: [
                {
                    etapa: 'Recepci贸n',
                    subestado: 'Recibido',
                    usuario: 'Ana Garc铆a',
                    fecha_inicio: '2025-01-15T09:30:00Z',
                    fecha_fin: '2025-01-15T14:20:00Z'
                },
                {
                    etapa: 'Verificaci贸n',
                    subestado: 'En Revisi贸n',
                    usuario: 'Carlos L贸pez',
                    fecha_inicio: '2025-01-15T14:20:00Z',
                    fecha_fin: '2025-01-16T11:45:00Z'
                },
                {
                    etapa: 'Evaluaci贸n',
                    subestado: 'En Proceso',
                    usuario: 'Mar铆a Rodr铆guez',
                    fecha_inicio: '2025-01-16T11:45:00Z',
                    fecha_fin: null
                },
                {
                    texto: 'Documentos recibidos correctamente',
                    usuario: 'Ana Garc铆a',
                    fecha_creacion: '2025-01-15T10:15:00Z'
                },
                {
                    texto: 'Verificaci贸n de ingresos completada',
                    usuario: 'Carlos L贸pez',
                    fecha_creacion: '2025-01-15T16:30:00Z'
                },
                {
                    nombre: 'C茅dula de Identidad',
                    archivo: '/media/documentos/cedula_123.pdf',
                    usuario: 'Juan P茅rez',
                    fecha_creacion: '2025-01-15T11:20:00Z'
                },
                {
                    nombre: 'Comprobante de Ingresos',
                    archivo: '/media/documentos/ingresos_123.pdf',
                    usuario: 'Juan P茅rez',
                    fecha_creacion: '2025-01-15T13:45:00Z'
                }
            ]
        };
    }

    // Add debug functionality
    window.testModalSolicitud = function () {
        console.log('Testing modal with mock data...');
        mostrarModalSolicitud('test-123');
    };
    
    // Comprehensive end-to-end test function
    window.testVerCotizacionEndToEnd = function(solicitudId) {
        console.log('И === COMPREHENSIVE VER COTIZACIN TEST ===');
        
        if (!solicitudId) {
            // Try to get from current context
            solicitudId = window.currentSolicitudId;
            if (!solicitudId) {
                console.error(' No solicitudId provided. Usage: testVerCotizacionEndToEnd(123)');
                return;
            }
        }
        
        console.log(' Testing with solicitudId:', solicitudId);
        
        // Step 1: Test API endpoint
        console.log(' Step 1: Testing API endpoint...');
        fetch(`/workflow/api/solicitud_brief/${solicitudId}/`)
            .then(response => response.json())
            .then(data => {
                console.log(' API Response received:', data);
                console.log(' Cotization data:', data.cotizacion);
                console.log(' Cotization ID:', data.cotizacion_id);
                
                // Step 2: Test modal population
                console.log(' Step 2: Testing modal population...');
                window.currentModalData = data;
                populateUnifiedSummaryCard(data);
                
                // Step 3: Test button state
                setTimeout(() => {
                    console.log(' Step 3: Testing button state...');
                    testButtonData();
                    
                    // Step 4: Test redirect function directly
                    console.log(' Step 4: Testing redirect function...');
                    console.log('Ready to test redirectToCotizacion() - check console and try clicking the button');
                }, 200);
            })
            .catch(error => {
                console.error(' API test failed:', error);
            });
    };
    
    // Show quick testing guide
    window.showCotizacionTestGuide = function() {
        console.log(' VER COTIZACIN TESTING GUIDE:');
        console.log('1. testButtonData() - Check current button state');
        console.log('2. testVerCotizacionEndToEnd(solicitudId) - Full end-to-end test');
        console.log('3. redirectToCotizacion() - Test redirect directly');
        console.log(' Example: testVerCotizacionEndToEnd(123)');
    };
    
    // Auto-show guide when modal loads
    console.log(' Ver Cotizaci贸n debugging tools loaded. Type showCotizacionTestGuide() for help.');

    // Add test function for checking button data attribute
    window.testButtonData = function () {
        const button = document.getElementById('modalBtnVerCotizacion');
        console.log('=== VER COTIZACIN BUTTON DEBUG ===');
        console.log('Button exists:', button !== null);
        console.log('Button disabled:', button ? button.disabled : 'N/A');
        console.log('Button data-solicitud-id:', button ? button.getAttribute('data-solicitud-id') : 'Button not found');
        console.log('Global currentSolicitudId:', window.currentSolicitudId);
        console.log('Button HTML:', button ? button.outerHTML : 'Button not found');
        
        // Check modal data
        console.log('Current modal data exists:', !!window.currentModalData);
        if (window.currentModalData) {
            console.log('Cotization data exists:', !!window.currentModalData.cotizacion);
            if (window.currentModalData.cotizacion) {
                const cot = window.currentModalData.cotizacion;
                console.log('Cotization details:', {
                    id: cot.id,
                    numero: cot.numero,
                    tipoPrestamo: cot.tipoPrestamo,
                    hasValidId: !!(cot.id || cot.numero),
                    hasValidType: !!cot.tipoPrestamo
                });
            }
        }

        // Try to trigger click programmatically
        if (button && !button.disabled) {
            console.log('Triggering click programmatically...');
            button.click();
        } else if (button) {
            console.log('Button is disabled, cannot trigger click');
        }
        
        // Check summary button
        const summaryButton = document.getElementById('btnVerCotizacionSummary');
        console.log('=== SUMMARY VER COTIZACIN BUTTON DEBUG ===');
        console.log('Summary button exists:', summaryButton !== null);
        console.log('Summary button disabled:', summaryButton ? summaryButton.disabled : 'N/A');
        console.log('Summary button style.opacity:', summaryButton ? summaryButton.style.opacity : 'N/A');
        console.log('Summary button HTML:', summaryButton ? summaryButton.outerHTML : 'Button not found');

        // Try to trigger summary click programmatically
        if (summaryButton && !summaryButton.disabled) {
            console.log(' Attempting to trigger summary button click...');
            summaryButton.click();
        } else if (summaryButton) {
            console.log(' Summary button is disabled, cannot click');
        }
    };

    // Add a helper function to test API directly
    window.testApiDirectly = function (solicitudId = 1) {
        console.log('Testing API directly for solicitud:', solicitudId);

        fetch(`/workflow/api/solicitud_brief/${solicitudId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
            }
        })
            .then(response => {
                console.log('API Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API Response data:', data);
                if (data.success) {
                    console.log('API call successful!');
                    populateModalData(data.data);
                } else {
                    console.error('API returned error:', data.error);
                }
            })
            .catch(error => {
                console.error('API call failed:', error);
            });
    };

    // Test upload functionality
    window.testUploadFunctionality = function () {
        console.log('Testing upload functionality...');

        // Show modal first
        mostrarModalSolicitud('test-123');

        // Switch to documentos tab
        setTimeout(() => {
            const documentosTab = document.getElementById('documentos-tab');
            if (documentosTab) {
                documentosTab.click();
                console.log('Switched to documentos tab');

                setTimeout(() => {
                    // Try to find an upload button
                    const uploadButton = document.querySelector('.btn-upload');
                    if (uploadButton) {
                        console.log('Upload button found:', uploadButton);
                        console.log('Upload functionality is ready!');
                    } else {
                        console.log('No upload button found - checking document structure...');
                        const documentItems = document.querySelectorAll('.documento-item');
                        console.log('Found document items:', documentItems.length);
                        documentItems.forEach((item, index) => {
                            console.log(`Document ${index + 1}:`, item);
                        });
                    }
                }, 500);
            }
        }, 1000);
    };

    // Debug function to test document upload with real data
    window.debugDocumentUpload = function () {
        console.log('=== DEBUG DOCUMENT UPLOAD ===');
        console.log('Current solicitud ID:', window.currentSolicitudId);
        console.log('Current modal data:', window.currentModalData);

        if (window.currentModalData && window.currentModalData.documentos) {
            console.log('Documentos in modal data:', window.currentModalData.documentos);
            window.currentModalData.documentos.forEach((doc, index) => {
                console.log(`Documento ${index + 1}:`, {
                    id: doc.id,
                    nombre: doc.nombre,
                    cumplido: doc.cumplido,
                    url: doc.url
                });
            });
        }

        // Test the upload API directly
        const testData = new FormData();
        testData.append('solicitud_id', window.currentSolicitudId || '1');
        testData.append('documento_id', '194'); // Test with a known ID
        testData.append('documento_nombre', 'APC');

        // Create a test file
        const testFile = new File(['test content'], 'test.pdf', { type: 'application/pdf' });
        testData.append('file', testFile);

        console.log('Testing API with data:', {
            solicitud_id: testData.get('solicitud_id'),
            documento_id: testData.get('documento_id'),
            documento_nombre: testData.get('documento_nombre'),
            file: testData.get('file')
        });

        fetch('/workflow/api/upload-documento/', {
            method: 'POST',
            body: testData,
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
            .then(response => response.json())
            .then(data => {
                console.log('API Response:', data);
            })
            .catch(error => {
                console.error('API Error:', error);
            });
    };

    // Auto-test on page load - Wait for DOM to be ready
    function initializeModalWhenReady() {
        if (document.readyState === 'loading') {
            console.log('DOM not ready yet, waiting...');
            document.addEventListener('DOMContentLoaded', initializeModalWhenReady);
            return;
        }

        console.log('Modal script loaded successfully');

        // Initialize modal layout functionality
        initializeModalLayout();

        // Add test button to console
        console.log('To test modal, run: testModalSolicitud()');
        console.log('To test API directly, run: testApiDirectly(1)');
        console.log('To test upload functionality, run: testUploadFunctionality()');
        console.log('To debug document upload, run: debugDocumentUpload()');
        console.log('To test API endpoint, run: testApiEndpoint()');
        console.log('To test historial tab, run: testHistorialTab()');
    }

    // Start the initialization process
    initializeModalWhenReady();

    // Initialize modal layout functionality
    function initializeModalLayout() {
        // Handle window resize for responsive layout
        window.addEventListener('resize', adjustModalLayout);

        // Add click handlers for action buttons
        const btnProcesar = document.getElementById('modalBtnProcesarTarea');
        if (btnProcesar) {
            btnProcesar.addEventListener('click', function () {
                console.log('Procesar tarea clicked');
                // Add your processing logic here
            });
        }

        const btnDevolver = document.getElementById('modalBtnDevolver');
        if (btnDevolver) {
            btnDevolver.addEventListener('click', function () {
                console.log('Devolver clicked');
                // Add your return logic here
            });
        }

        const btnAnular = document.getElementById('modalBtnAnular');
        if (btnAnular) {
            btnAnular.addEventListener('click', function () {
                console.log('Anular clicked');
                // Add your cancel logic here
            });
        }

        const btnComentarios = document.getElementById('modalBtnComentarios');
        if (btnComentarios) {
            btnComentarios.addEventListener('click', function () {
                console.log('Comentarios clicked');
                // Add your comments logic here
            });
        }

        // Add click handler for 'Ver Cotizaci贸n' button using event delegation
        document.addEventListener('click', function (event) {
            // Handle clicks on the button or its child elements
            const button = event.target.closest('#modalBtnVerCotizacion');
            if (button) {
                console.log('Ver Cotizaci贸n clicked');
                
                // Check if button is disabled
                if (button.disabled) {
                    console.log('Button is disabled, ignoring click');
                    return;
                }
                
                // Get cotization data from modal
                const currentData = window.currentModalData;
                if (!currentData || !currentData.cotizacion) {
                    console.error('No cotization data found in modal');
                    alert('No se pudo encontrar la informaci贸n de la cotizaci贸n.');
                    return;
                }

                const cotizacion = currentData.cotizacion;
                const tipoPrestamo = cotizacion.tipoPrestamo;
                const cotizacionId = cotizacion.id || cotizacion.numero;

                console.log('Cotization data:', {
                    tipoPrestamo: tipoPrestamo,
                    cotizacionId: cotizacionId,
                    cotizacion: cotizacion
                });

                // Validate required data
                if (!cotizacionId) {
                    console.error('No cotization ID found');
                    alert('No se pudo encontrar el ID de la cotizaci贸n.');
                    return;
                }

                if (!tipoPrestamo) {
                    console.error('No loan type found');
                    alert('No se pudo determinar el tipo de pr茅stamo.');
                    return;
                }

                // Determine URL based on loan type
                let redirectUrl = '';
                if (tipoPrestamo === 'auto') {
                    redirectUrl = `/cotizacion/${cotizacionId}/`;
                } else if (tipoPrestamo === 'personal') {
                    redirectUrl = `/cotizacionPP/${cotizacionId}/`;
                } else {
                    console.error('Unknown loan type:', tipoPrestamo);
                    alert('Tipo de pr茅stamo no reconocido: ' + (tipoPrestamo || 'sin definir'));
                    return;
                }

                console.log('Navigating to cotization:', redirectUrl);
                window.location.href = redirectUrl;
            }
        });
    }

    // Adjust modal layout based on screen size
    function adjustModalLayout() {
        const isMobile = window.innerWidth <= 768;
        const modalLayout = document.querySelector('.modal-layout');

        if (modalLayout) {
            if (isMobile) {
                modalLayout.classList.add('mobile-layout');
            } else {
                modalLayout.classList.remove('mobile-layout');
            }
        }
    }

    // ==========================================
    // DOCUMENT UPLOAD FUNCTIONALITY
    // ==========================================

    // Toggle upload area visibility
    function toggleUploadArea(uploadId) {
        const uploadArea = document.getElementById(uploadId);
        const uploadInput = document.getElementById(`${uploadId}-input`);

        if (uploadArea) {
            const isActive = uploadArea.classList.contains('active');
            if (isActive) {
                uploadArea.classList.remove('active');
                resetUploadArea(uploadId);
            } else {
                uploadArea.classList.add('active');
                setupUploadListeners(uploadId);
            }
        }
    }

    // Setup drag and drop listeners
    function setupUploadListeners(uploadId) {
        const uploadArea = document.getElementById(uploadId);
        const uploadInput = document.getElementById(`${uploadId}-input`);

        if (!uploadArea || !uploadInput) return;

        // Click to select file
        uploadArea.addEventListener('click', function (e) {
            if (e.target === uploadArea || e.target.classList.contains('upload-text')) {
                uploadInput.click();
            }
        });

        // File input change
        uploadInput.addEventListener('change', function (e) {
            handleFileSelection(uploadId, e.target.files);
        });

        // Drag and drop events
        uploadArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function (e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function (e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFileSelection(uploadId, e.dataTransfer.files);
        });
    }

    // Handle file selection
    function handleFileSelection(uploadId, files) {
        if (files.length === 0) return;

        const file = files[0];
        const maxSize = 10 * 1024 * 1024; // 10MB
        const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/jpg', 'image/png'];

        // Validate file size
        if (file.size > maxSize) {
            alert('El archivo es demasiado grande. El tama帽o m谩ximo permitido es 10MB.');
            return;
        }

        // Validate file type
        if (!allowedTypes.includes(file.type)) {
            alert('Tipo de archivo no permitido. Solo se permiten: PDF, DOC, DOCX, JPG, JPEG, PNG');
            return;
        }

        // Show file preview
        const preview = document.getElementById(`${uploadId}-preview`);
        const buttons = document.getElementById(`${uploadId}-buttons`);

        if (preview && buttons) {
            const fileName = preview.querySelector('.file-name');
            const fileSize = preview.querySelector('.file-size');

            if (fileName) fileName.textContent = file.name;
            if (fileSize) fileSize.textContent = `(${formatFileSize(file.size)})`;

            preview.classList.add('active');
            buttons.classList.add('active');

            // Store file for later upload
            preview.setAttribute('data-file', JSON.stringify({
                name: file.name,
                size: file.size,
                type: file.type
            }));

            // Store actual file object
            window.uploadFiles = window.uploadFiles || {};
            window.uploadFiles[uploadId] = file;
        }
    }

    // Remove selected file
    function removeFile(uploadId) {
        const preview = document.getElementById(`${uploadId}-preview`);
        const buttons = document.getElementById(`${uploadId}-buttons`);
        const uploadInput = document.getElementById(`${uploadId}-input`);

        if (preview) preview.classList.remove('active');
        if (buttons) buttons.classList.remove('active');
        if (uploadInput) uploadInput.value = '';

        // Remove stored file
        if (window.uploadFiles && window.uploadFiles[uploadId]) {
            delete window.uploadFiles[uploadId];
        }
    }

    // Upload document
    async function uploadDocument(uploadId, documentoId, documentoNombre) {
        const file = window.uploadFiles && window.uploadFiles[uploadId];

        if (!file) {
            alert('No se ha seleccionado ning煤n archivo');
            return;
        }

        console.log('=== UPLOAD DOCUMENT DEBUG ===');
        console.log('uploadId:', uploadId);
        console.log('documentoId:', documentoId);
        console.log('documentoNombre:', documentoNombre);
        console.log('file:', file);
        console.log('currentSolicitudId:', window.currentSolicitudId);

        const confirmBtn = document.querySelector(`#${uploadId}-buttons .btn-upload-confirm`);
        const progressContainer = document.getElementById(`${uploadId}-progress`);
        const progressFill = progressContainer?.querySelector('.progress-fill');

        if (confirmBtn) confirmBtn.disabled = true;
        if (progressContainer) progressContainer.style.display = 'block';

        try {
            // Create FormData
            const formData = new FormData();
            formData.append('file', file);
            formData.append('documento_id', documentoId);
            formData.append('documento_nombre', documentoNombre);
            formData.append('solicitud_id', window.currentSolicitudId || '');

            console.log('FormData contents:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}:`, value);
            }

            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress > 90) progress = 90;
                if (progressFill) progressFill.style.width = progress + '%';
            }, 200);

            // Make upload request
            const response = await fetch('/workflow/api/upload-documento/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            });

            clearInterval(progressInterval);
            if (progressFill) progressFill.style.width = '100%';

            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('HTTP Error:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const result = await response.json();

            console.log('API Response:', result);

            if (result.success) {
                // Success feedback
                showUploadSuccess(uploadId, documentoNombre);

                // Always refresh the documentos section after a short delay
                setTimeout(async () => {
                    console.log('Document uploaded successfully:', result);

                    const currentSolicitudId = window.currentSolicitudId;
                    if (currentSolicitudId && currentSolicitudId !== 'test-123') {
                        try {
                            const refreshResponse = await fetch(`/workflow/api/solicitud/${currentSolicitudId}/documentos/`, {
                                method: 'GET',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Accept': 'application/json',
                                }
                            });

                            if (refreshResponse.ok) {
                                const refreshData = await refreshResponse.json();
                                if (refreshData.success) {
                                    // Update the documentos in the current data and repopulate
                                    console.log('Refreshed document data:', refreshData.documentos);
                                    populateDocumentosTab(refreshData.documentos);
                                }
                            }
                        } catch (refreshError) {
                            console.warn('Could not refresh document list:', refreshError);
                        }
                    } else {
                        // For mock data, manually update the status
                        updateMockDocumentStatus(documentoId || documentoNombre, result.data.file_url);
                    }

                    resetUploadArea(uploadId);
                }, 2000);
            } else {
                throw new Error(result.error || 'Error en la subida del archivo');
            }

        } catch (error) {
            console.error('Upload error:', error);
            alert('Error al subir el archivo: ' + error.message);

            if (confirmBtn) confirmBtn.disabled = false;
            if (progressContainer) progressContainer.style.display = 'none';
        }
    }

    // Cancel upload
    function cancelUpload(uploadId) {
        resetUploadArea(uploadId);
    }

    // Reset upload area
    function resetUploadArea(uploadId) {
        const uploadArea = document.getElementById(uploadId);
        const preview = document.getElementById(`${uploadId}-preview`);
        const buttons = document.getElementById(`${uploadId}-buttons`);
        const progress = document.getElementById(`${uploadId}-progress`);
        const uploadInput = document.getElementById(`${uploadId}-input`);

        if (uploadArea) uploadArea.classList.remove('active');
        if (preview) preview.classList.remove('active');
        if (buttons) buttons.classList.remove('active');
        if (progress) progress.style.display = 'none';
        if (uploadInput) uploadInput.value = '';

        // Remove stored file
        if (window.uploadFiles && window.uploadFiles[uploadId]) {
            delete window.uploadFiles[uploadId];
        }
    }

    // Show upload success message
    function showUploadSuccess(uploadId, documentoNombre) {
        const uploadArea = document.getElementById(uploadId);
        if (uploadArea) {
            uploadArea.innerHTML = `
            <div style="text-align: center; color: #28a745; padding: 1rem;">
                <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <div><strong>隆Documento cargado exitosamente!</strong></div>
                <div style="font-size: 0.875rem; margin-top: 0.25rem;">${documentoNombre}</div>
            </div>
        `;
        }
    }

    // Utility function to format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Get CSRF token for Django
    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }

        // Fallback: try to get from meta tag
        if (!cookieValue) {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                cookieValue = metaTag.getAttribute('content');
            }
        }

        return cookieValue;
    }

    // Show notification function
    function showNotification(message, type = 'info') {
        // Remove any existing notifications
        const existingNotifications = document.querySelectorAll('.toast-notification');
        existingNotifications.forEach(notification => notification.remove());

        // Create notification element
        const notification = document.createElement('div');
        notification.className = `toast-notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <div class="notification-icon">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                </div>
                <div class="notification-message">${message}</div>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        // Add to document
        document.body.appendChild(notification);

        // Show notification
        setTimeout(() => notification.classList.add('show'), 100);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }

    // Update mock document status for testing
    function updateMockDocumentStatus(documentId, fileUrl) {
        // Find the document in mock data and update it
        const currentData = window.currentModalData;
        if (currentData && currentData.documentos) {
            const documento = currentData.documentos.find(doc =>
                doc.id == documentId || doc.nombre === documentId
            );
            if (documento) {
                documento.cumplido = true;
                documento.url = fileUrl;
                documento.observaciones = 'Documento cargado exitosamente';

                // Repopulate the tab with updated data
                populateDocumentosTab(currentData.documentos);
                console.log('Mock document status updated:', documento);
            }
        }
    }

    // Test API endpoint accessibility
    window.testApiEndpoint = function () {
        console.log('=== TESTING API ENDPOINT ===');

        // Test if the endpoint is accessible
        fetch('/workflow/api/upload-documento/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                console.log('GET Response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('GET Response text:', text);
            })
            .catch(error => {
                console.error('GET Error:', error);
            });

        // Test CSRF token
        const csrfToken = getCsrfToken();
        console.log('CSRF Token:', csrfToken);

        // Test with a simple POST request
        const testData = new FormData();
        testData.append('test', 'test');

        fetch('/workflow/api/upload-documento/', {
            method: 'POST',
            body: testData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(response => {
                console.log('POST Response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('POST Response text:', text);
            })
            .catch(error => {
                console.error('POST Error:', error);
            });
    };

    // Test historial tab functionality
    window.testHistorialTab = function () {
        console.log('=== TESTING HISTORIAL TAB ===');

        // Show modal first
        mostrarModalSolicitud('test-123');

        // Switch to historial tab after a short delay
        setTimeout(() => {
            const historialTab = document.getElementById('historial-tab');
            if (historialTab) {
                historialTab.click();
                console.log('Switched to historial tab');

                // Check if timeline is populated
                setTimeout(() => {
                    const timeline = document.querySelector('.timeline');
                    const timelineItems = document.querySelectorAll('.timeline-item');
                    console.log('Timeline found:', timeline !== null);
                    console.log('Timeline items:', timelineItems.length);

                    if (timelineItems.length > 0) {
                        console.log(' Historial tab is working correctly!');
                        timelineItems.forEach((item, index) => {
                            console.log(`Item ${index + 1}:`, item.querySelector('.timeline-title')?.textContent);
                        });
                    } else {
                        console.log(' No timeline items found');
                    }
                }, 1000);
            } else {
                console.log(' Historial tab not found');
            }
        }, 1000);
    };

    // Test APC functionality
    window.testApcFunctionality = function () {
        console.log('=== TESTING APC FUNCTIONALITY ===');

        // Test with a real solicitud ID that has APC
        const testSolicitudId = '1'; // Change this to a real solicitud ID with APC

        console.log('Testing APC status check for solicitud:', testSolicitudId);

        fetch(`/workflow/api/solicitud/${testSolicitudId}/apc-status/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
            .then(response => response.json())
            .then(data => {
                console.log('APC Status API Response:', data);
                if (data.success) {
                    console.log(' APC Status API is working!');
                    console.log('APC Info:', data.apc_info);
                } else {
                    console.log(' APC Status API error:', data.error);
                }
            })
            .catch(error => {
                console.error(' APC Status API request failed:', error);
            });
    };

    // Function to check APC status updates
    async function checkApcStatusUpdate(solicitudId) {
        try {
            const response = await fetch(`/workflow/api/solicitud/${solicitudId}/apc-status/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (data.success && data.apc_status) {
                // Check if there are any APC documents that have changed status
                const currentDocumentos = window.currentModalData?.documentos || [];
                const currentApcDoc = currentDocumentos.find(doc => doc.nombre.toLowerCase() === 'apc');

                if (currentApcDoc) {
                    // Determine if APC is being processed
                    const apcProcessing = ['pending', 'in_progress'].includes(data.apc_status.apc_status);
                    const apcCompleted = data.apc_status.apc_status === 'completed' && data.apc_status.apc_archivo_disponible;
                    
                    // Check if APC status has changed
                    if (currentApcDoc.apc_processing !== apcProcessing ||
                        currentApcDoc.cumplido !== apcCompleted ||
                        currentApcDoc.apc_status !== data.apc_status.apc_status) {

                        console.log('APC status change detected:', {
                            old: { processing: currentApcDoc.apc_processing, cumplido: currentApcDoc.cumplido, status: currentApcDoc.apc_status },
                            new: { processing: apcProcessing, cumplido: apcCompleted, status: data.apc_status.apc_status }
                        });

                        // Update the APC document in the current data
                        currentApcDoc.apc_processing = apcProcessing;
                        currentApcDoc.cumplido = apcCompleted;
                        currentApcDoc.apc_status = data.apc_status.apc_status;
                        currentApcDoc.apc_fecha_solicitud = data.apc_status.apc_fecha_solicitud;
                        currentApcDoc.apc_fecha_inicio = data.apc_status.apc_fecha_inicio;
                        currentApcDoc.apc_fecha_completado = data.apc_status.apc_fecha_completado;
                        currentApcDoc.apc_observaciones = data.apc_status.apc_observaciones;
                        
                        if (apcCompleted) {
                            currentApcDoc.url = `/media/apc_files/apc_${data.apc_status.codigo}_*.pdf`;
                        }

                        // Refresh the documentos tab
                        populateDocumentosTab(window.currentModalData.documentos);

                        // Show a subtle notification
                        if (apcProcessing === false && apcCompleted === true) {
                            showApcStatusNotification('APC descargado autom谩ticamente por Makito RPA');
                        } else if (apcProcessing === true) {
                            showApcStatusNotification('APC en proceso por Makito RPA');
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Error checking APC status:', error);
        }
    }

    // Function to check SURA status updates
    async function checkSuraStatusUpdate(solicitudId) {
        try {
            const response = await fetch(`/workflow/api/solicitud/${solicitudId}/sura-status/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (data.success && data.sura_status) {
                // Check if there are any SURA documents that have changed status
                const currentDocumentos = window.currentModalData?.documentos || [];
                const currentSuraDoc = currentDocumentos.find(doc => 
                    doc.nombre.toLowerCase() === 'sura' || doc.nombre.toLowerCase() === 'cotizaci贸n sura'
                );

                if (currentSuraDoc) {
                    // Determine if SURA is being processed
                    const suraProcessing = ['pending', 'in_progress'].includes(data.sura_status.sura_status);
                    const suraCompleted = data.sura_status.sura_status === 'completed' && data.sura_status.sura_archivo_disponible;
                    
                    // Check if SURA status has changed
                    if (currentSuraDoc.sura_processing !== suraProcessing ||
                        currentSuraDoc.cumplido !== suraCompleted ||
                        currentSuraDoc.sura_status !== data.sura_status.sura_status) {

                        console.log('SURA status change detected:', {
                            old: { processing: currentSuraDoc.sura_processing, cumplido: currentSuraDoc.cumplido, status: currentSuraDoc.sura_status },
                            new: { processing: suraProcessing, cumplido: suraCompleted, status: data.sura_status.sura_status }
                        });

                        // Update the SURA document in the current data
                        currentSuraDoc.sura_processing = suraProcessing;
                        currentSuraDoc.cumplido = suraCompleted;
                        currentSuraDoc.sura_status = data.sura_status.sura_status;
                        currentSuraDoc.sura_fecha_solicitud = data.sura_status.sura_fecha_solicitud;
                        currentSuraDoc.sura_fecha_inicio = data.sura_status.sura_fecha_inicio;
                        currentSuraDoc.sura_fecha_completado = data.sura_status.sura_fecha_completado;
                        currentSuraDoc.sura_observaciones = data.sura_status.sura_observaciones;
                        
                        if (suraCompleted) {
                            currentSuraDoc.url = `/media/sura_files/sura_${data.sura_status.codigo}_*.pdf`;
                        }

                        // Refresh the documentos tab
                        populateDocumentosTab(window.currentModalData.documentos);

                        // Show a subtle notification
                        if (suraProcessing === false && suraCompleted === true) {
                            showSuraStatusNotification('Cotizaci贸n SURA descargada autom谩ticamente por Makito RPA');
                        } else if (suraProcessing === true) {
                            showSuraStatusNotification('Cotizaci贸n SURA en proceso por Makito RPA');
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Error checking SURA status:', error);
        }
    }

    // Function to show SURA status notification
    function showSuraStatusNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            z-index: 10000;
            font-weight: 500;
            max-width: 300px;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
        `;

        notification.innerHTML = `
            <i class="fas fa-robot"></i>
            ${message}
        `;

        document.body.appendChild(notification);

        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Function to show APC status notification
    function showApcStatusNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            z-index: 10000;
            font-weight: 500;
            max-width: 300px;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
        `;

        notification.innerHTML = `
            <i class="fas fa-robot"></i>
            ${message}
        `;

        document.body.appendChild(notification);

        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Function to check Debida Diligencia status updates
    async function checkDebidaDiligenciaStatusUpdate(solicitudId) {
        try {
            const response = await fetch(`/workflow/api/solicitud_brief/${solicitudId}/`);
            if (!response.ok) throw new Error('Failed to fetch debida diligencia status');
            
            const data = await response.json();
            
            if (data.success && data.debida_diligencia_status) {
                const currentData = window.currentModalData;
                if (currentData && currentData.debida_diligencia_status !== data.debida_diligencia_status) {
                    console.log('Debida diligencia status change detected:', {
                        old: currentData.debida_diligencia_status,
                        new: data.debida_diligencia_status
                    });
                    
                    // Update current data
                    window.currentModalData = data;
                    
                    // Show notification
                    let message = '';
                    if (data.debida_diligencia_status === 'completado') {
                        message = 'Debida diligencia completada exitosamente';
                    } else if (data.debida_diligencia_status === 'error') {
                        message = 'Error en el procesamiento de debida diligencia';
                    } else if (data.debida_diligencia_status === 'en_progreso') {
                        message = 'Debida diligencia en progreso';
                    }
                    
                    if (message) {
                        showDebidaDiligenciaStatusNotification(message);
                    }
                    
                    // Reload debida diligencia section
                    loadDebidaDiligenciaStatus();
                }
            }
        } catch (error) {
            console.error('Error checking debida diligencia status:', error);
        }
    }

    // Function to show Debida Diligencia status notification
    function showDebidaDiligenciaStatusNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            z-index: 10000;
            font-weight: 500;
            max-width: 300px;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
        `;

        notification.innerHTML = `
            <i class="fas fa-shield-alt"></i>
            ${message}
        `;

        document.body.appendChild(notification);

        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Auto-refresh APC, SURA and Debida Diligencia status every 10 seconds if modal is open and has documents being processed
    setInterval(() => {
        const modal = document.getElementById('modalSolicitud');
        if (modal && modal.style.display !== 'none') {
            const currentSolicitudId = window.currentSolicitudId;
            if (currentSolicitudId && currentSolicitudId !== 'test-123') {
                // Check if there are any documents being processed
                const currentData = window.currentModalData;
                if (currentData && currentData.documentos) {
                    const hasApcProcessing = currentData.documentos.some(doc =>
                        doc.nombre.toLowerCase() === 'apc' && doc.apc_processing
                    );
                    const hasSuraProcessing = currentData.documentos.some(doc =>
                        (doc.nombre.toLowerCase() === 'sura' || doc.nombre.toLowerCase() === 'cotizaci贸n sura') && doc.sura_processing
                    );

                    if (hasApcProcessing) {
                        checkApcStatusUpdate(currentSolicitudId);
                    }
                    if (hasSuraProcessing) {
                        checkSuraStatusUpdate(currentSolicitudId);
                    }
                }
                
                // Check debida diligencia status if it's being processed
                if (currentData && currentData.debida_diligencia_status && 
                    ['solicitado', 'en_progreso'].includes(currentData.debida_diligencia_status)) {
                    checkDebidaDiligenciaStatusUpdate(currentSolicitudId);
                }
            }
        }
    }, 10000);

    // Auto-refresh SURA status every 10 seconds if modal is open and has SURA documents
    setInterval(() => {
        const modal = document.getElementById('modalSolicitud');
        if (modal && modal.style.display !== 'none') {
            const currentSolicitudId = window.currentSolicitudId;
            if (currentSolicitudId && currentSolicitudId !== 'test-123') {
                // Check if there are any SURA documents being processed
                const currentData = window.currentModalData;
                if (currentData && currentData.documentos) {
                    const hasSuraProcessing = currentData.documentos.some(doc =>
                        (doc.nombre.toLowerCase() === 'sura' || doc.nombre.toLowerCase() === 'cotizaci贸n sura') && doc.sura_processing
                    );

                    if (hasSuraProcessing) {
                        checkSuraStatusUpdate(currentSolicitudId);
                    }
                }
            }
        }
    }, 10000);

    // =====================================
    // DEBIDA DILIGENCIA FUNCTIONALITY
    // =====================================
    
    // Load due diligence status when diligencia tab is activated
    function loadDebidaDiligenciaStatus() {
        if (!currentSolicitudId) {
            console.error('No current solicitud ID available');
            return;
        }
        
        console.log('Loading debida diligencia status for solicitud:', currentSolicitudId);
        
        // Show loading state
        const container = document.getElementById('diligencia-content');
        if (container) {
            container.innerHTML = `
                <div class="loading-placeholder">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando informaci贸n de debida diligencia...</span>
                    </div>
                </div>
            `;
        }
        
        fetch(`/workflow/api/debida-diligencia/status/${currentSolicitudId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Debida diligencia data received:', data);
                renderDebidaDiligenciaContent(data);
            })
            .catch(error => {
                console.error('Error loading debida diligencia status:', error);
                renderDebidaDiligenciaError();
            });
    }

    function renderDebidaDiligenciaContent(data) {
        const container = document.getElementById('diligencia-content');
        if (!container) return;
        
        const { estado, fecha_solicitud, fecha_completado, busqueda_google, busqueda_registro_publico, comentarios } = data;
        
        let statusIcon = '';
        let statusBadge = '';
        let statusTitle = '';
        let statusSubtitle = '';
        let actionButton = '';
        
        // Status configuration
        if (estado === 'completado') {
            statusIcon = '<i class="fas fa-shield-check text-white"></i>';
            statusBadge = 'completed';
            statusTitle = 'Debida Diligencia Completada';
            statusSubtitle = `Completado el ${formatDate(fecha_completado)}`;
            actionButton = `
                <button class="btn-diligencia secondary" onclick="reenviarCorreoDiligencia('ambos')">
                    <i class="fas fa-envelope"></i>
                    Reenviar Correo
                </button>
            `;
        } else if (estado === 'solicitado') {
            statusIcon = '<i class="fas fa-hourglass-half text-white"></i>';
            statusBadge = 'pending';
            statusTitle = 'Debida Diligencia Solicitada';
            statusSubtitle = `Solicitado el ${formatDate(fecha_solicitud)}`;
            actionButton = `
                <button class="btn-diligencia secondary" onclick="reenviarCorreoDiligencia('ambos')">
                    <i class="fas fa-envelope"></i>
                    Reenviar Correo
                </button>
            `;
        } else if (estado === 'en_progreso') {
            statusIcon = '<i class="fas fa-robot text-white"></i>';
            statusBadge = 'makito-processing';
            statusTitle = 'Makito RPA Procesando';
            statusSubtitle = 'Los documentos est谩n siendo generados autom谩ticamente';
            actionButton = `
                <button class="btn-diligencia secondary" onclick="reenviarCorreoDiligencia('ambos')">
                    <i class="fas fa-envelope"></i>
                    Reenviar Correo
                </button>
            `;
        } else {
            statusIcon = '<i class="fas fa-shield-alt text-white"></i>';
            statusBadge = 'pending';
            statusTitle = 'Debida Diligencia No Iniciada';
            statusSubtitle = 'Solicite la debida diligencia para comenzar';
            actionButton = `
                <button class="btn-diligencia primary" onclick="solicitarDebidaDiligencia()">
                    <i class="fas fa-play"></i>
                    Solicitar Debida Diligencia
                </button>
            `;
        }
        
        // Files section
        let filesSection = '';
        if (estado !== 'no_iniciado') {
            filesSection = `
                <div class="diligencia-files-grid">
                    ${renderFileCard('B煤squeda Google', 'busqueda_google', busqueda_google, estado)}
                    ${renderFileCard('Registro P煤blico', 'busqueda_registro_publico', busqueda_registro_publico, estado)}
                </div>
            `;
        }
        
        // Comments section
        let commentsSection = '';
        if (comentarios) {
            commentsSection = `
                <div class="mt-3">
                    <h6 class="mb-2"><i class="fas fa-comment-alt me-2"></i>Observaciones</h6>
                    <div class="alert alert-info">
                        ${comentarios}
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = `
            <div class="diligencia-status-card">
                <div class="diligencia-header">
                    <div class="diligencia-status-icon bg-${statusBadge === 'completed' ? 'success' : statusBadge === 'makito-processing' ? 'info' : 'warning'}">
                        ${statusIcon}
                    </div>
                    <div class="diligencia-status-info">
                        <h5 class="diligencia-status-title">${statusTitle}</h5>
                        <p class="diligencia-status-subtitle">${statusSubtitle}</p>
                    </div>
                    <div class="diligencia-actions">
                        ${actionButton}
                    </div>
                </div>
                ${commentsSection}
            </div>
            ${filesSection}
        `;
    }

    function renderFileCard(title, type, fileData, estado) {
        let cardClass = 'pending';
        let statusText = 'Pendiente';
        let statusClass = 'pending';
        let actions = '';
        
        if (fileData && fileData.archivo) {
            cardClass = 'completed';
            statusText = 'Completado';
            statusClass = 'completed';
            actions = `
                <button class="btn-diligencia secondary" onclick="downloadFile('${fileData.archivo}')">
                    <i class="fas fa-download"></i>
                    Descargar
                </button>
                <button class="btn-diligencia secondary" onclick="previewFile('${fileData.archivo}')">
                    <i class="fas fa-eye"></i>
                    Ver
                </button>
                <button class="btn-diligencia warning" onclick="reenviarCorreoDiligencia('${type}')">
                    <i class="fas fa-envelope"></i>
                    Reenviar Correo
                </button>
            `;
        } else if (estado === 'en_progreso') {
            cardClass = 'makito-processing';
            statusText = 'Procesando...';
            statusClass = 'makito-processing';
            actions = `
                <button class="btn-diligencia warning" onclick="reenviarCorreoDiligencia('${type}')">
                    <i class="fas fa-envelope"></i>
                    Reenviar Correo
                </button>
            `;
        } else if (estado !== 'no_iniciado') {
            // For states like 'solicitado' - show both options
            actions = `
                <input type="file" id="upload-${type}" accept=".pdf" style="display: none;" onchange="uploadFile('${type}', this.files[0])">
                <button class="btn-diligencia primary" onclick="document.getElementById('upload-${type}').click()">
                    <i class="fas fa-upload"></i>
                    Subir Archivo
                </button>
                <button class="btn-diligencia warning" onclick="solicitarMakito('${type}')">
                    <i class="fas fa-robot"></i>
                    Solicitar a Makito
                </button>
                <button class="btn-diligencia secondary" onclick="reenviarCorreoDiligencia('${type}')">
                    <i class="fas fa-envelope"></i>
                    Reenviar Correo
                </button>
            `;
        } else {
            // For 'no_iniciado' state - only show upload and solicitar options
            actions = `
                <input type="file" id="upload-${type}" accept=".pdf" style="display: none;" onchange="uploadFile('${type}', this.files[0])">
                <button class="btn-diligencia primary" onclick="document.getElementById('upload-${type}').click()">
                    <i class="fas fa-upload"></i>
                    Subir Archivo
                </button>
                <button class="btn-diligencia warning" onclick="solicitarMakito('${type}')">
                    <i class="fas fa-robot"></i>
                    Solicitar a Makito
                </button>
            `;
        }
        
        return `
            <div class="diligencia-file-card ${cardClass}">
                <div class="diligencia-file-header">
                    <div class="diligencia-file-icon bg-${statusClass === 'completed' ? 'success' : statusClass === 'makito-processing' ? 'info' : 'warning'} text-white">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="diligencia-file-info">
                        <h6 class="diligencia-file-title">${title}</h6>
                        <span class="diligencia-file-status ${statusClass}">${statusText}</span>
                    </div>
                </div>
                <div class="diligencia-file-actions">
                    ${actions}
                </div>
            </div>
        `;
    }

    function renderDebidaDiligenciaError() {
        const container = document.getElementById('diligencia-content');
        if (!container) return;
        
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle mb-3 text-warning" style="font-size: 3rem;"></i>
                <p class="text-muted">Error al cargar la informaci贸n de debida diligencia</p>
                <button class="btn-diligencia primary" onclick="loadDebidaDiligenciaStatus()">
                    <i class="fas fa-refresh"></i>
                    Reintentar
                </button>
            </div>
        `;
    }

    function solicitarDebidaDiligencia() {
        if (!currentSolicitudId) {
            console.error('No current solicitud ID available');
            return;
        }
        
        if (!confirm('驴Est谩 seguro que desea solicitar la debida diligencia (B煤squeda Google y Registro P煤blico) para esta solicitud? Se enviar谩 un email a Makito RPA con las instrucciones.')) {
            return;
        }
        
        // Solicitar ambos documentos simult谩neamente
        solicitarAmbosDocumentosDiligencia(currentSolicitudId);
    }

    function solicitarAmbosDocumentosDiligencia(solicitudId) {
        console.log('Solicitando ambos documentos de debida diligencia para solicitud:', solicitudId);
        
        // Crear un array de promesas para ambos documentos
        const promesas = [
            solicitarDocumentoDiligencia(solicitudId, 'busqueda_google'),
            solicitarDocumentoDiligencia(solicitudId, 'busqueda_registro_publico')
        ];
        
        // Mostrar indicador de carga
        showNotification('Enviando solicitudes a Makito RPA...', 'info');
        
        // Ejecutar ambas solicitudes
        Promise.all(promesas)
            .then(results => {
                console.log('Ambas solicitudes completadas:', results);
                showNotification('Solicitudes de debida diligencia enviadas exitosamente a Makito RPA', 'success');
                // Recargar el estado de diligencia
                setTimeout(() => {
                    loadDebidaDiligenciaStatus();
                }, 1000);
            })
            .catch(error => {
                console.error('Error en las solicitudes de diligencia:', error);
                showNotification('Error al enviar las solicitudes: ' + error.message, 'error');
            });
    }

    function solicitarDocumentoDiligencia(solicitudId, tipoDocumento) {
        return fetch(`/workflow/api/debida-diligencia/solicitar-makito/${solicitudId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                tipo_documento: tipoDocumento
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(`Solicitud ${tipoDocumento} exitosa:`, data);
            return data;
        });
    }

    function executeDebidaDiligenciaRequest(solicitudId) {
        console.log('Executing debida diligencia request for solicitud:', solicitudId);
        
        fetch(`/workflow/api/debida-diligencia/solicitar/${solicitudId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Debida diligencia request successful:', data);
            showNotification(data.message || 'Debida diligencia solicitada exitosamente', 'success');
            // Reload the diligencia data
            setTimeout(() => {
                loadDebidaDiligenciaStatus();
            }, 1000);
        })
        .catch(error => {
            console.error('Error requesting debida diligencia:', error);
            showNotification('Error al solicitar debida diligencia: ' + error.message, 'error');
        });
    }

    function solicitarMakito(type) {
        if (!currentSolicitudId) {
            console.error('No current solicitud ID available');
            return;
        }
        
        if (!confirm(`驴Est谩 seguro que desea solicitar a Makito RPA generar el documento de ${type.replace('_', ' ')}?`)) {
            return;
        }
        
        console.log('Requesting Makito to generate:', type, 'for solicitud:', currentSolicitudId);
        
        fetch(`/workflow/api/debida-diligencia/solicitar-makito/${currentSolicitudId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                tipo_documento: type
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Makito request successful:', data);
            showNotification(data.message || 'Solicitud enviada a Makito RPA exitosamente', 'success');
            // Reload the diligencia data
            setTimeout(() => {
                loadDebidaDiligenciaStatus();
            }, 1000);
        })
        .catch(error => {
            console.error('Error requesting Makito:', error);
            showNotification('Error al solicitar a Makito: ' + error.message, 'error');
        });
    }

    function uploadFile(type, file) {
        if (!currentSolicitudId) {
            console.error('No current solicitud ID available');
            return;
        }
        
        if (!file) {
            console.error('No file selected');
            return;
        }
        
        if (file.type !== 'application/pdf') {
            alert('Solo se permiten archivos PDF');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            alert('El archivo no puede ser mayor a 10MB');
            return;
        }
        
        const formData = new FormData();
        formData.append('archivo', file);
        formData.append('tipo_documento', type);
        
        fetch(`/workflow/api/debida-diligencia/upload/${currentSolicitudId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('File upload successful:', data);
            showNotification(data.message || 'Archivo subido exitosamente', 'success');
            // Reload the diligencia data
            setTimeout(() => {
                loadDebidaDiligenciaStatus();
            }, 1000);
        })
        .catch(error => {
            console.error('Error uploading file:', error);
            showNotification('Error al subir archivo: ' + error.message, 'error');
        });
    }

    function downloadFile(filePath) {
        if (!filePath) {
            console.error('No file path provided');
            return;
        }
        
        window.open(filePath, '_blank');
    }

    function previewFile(filePath) {
        if (!filePath) {
            console.error('No file path provided');
            return;
        }
        
        window.open(filePath, '_blank');
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            console.error('Error formatting date:', error);
            return 'Fecha inv谩lida';
        }
    }

    function reenviarCorreoDiligencia(tipoDocumento = 'ambos') {
        if (!currentSolicitudId) {
            console.error('No current solicitud ID available');
            return;
        }
        
        const tipoText = tipoDocumento === 'ambos' ? 'ambos documentos (B煤squeda Google y Registro P煤blico)' : 
                        tipoDocumento === 'busqueda_google' ? 'B煤squeda Google' : 'B煤squeda Registro P煤blico';
        
        if (!confirm(`驴Est谩 seguro que desea reenviar el correo a Makito RPA para ${tipoText}? Se enviar谩 un nuevo email con las instrucciones.`)) {
            return;
        }
        
        // Mostrar indicador de carga
        showNotification('Reenviando correo a Makito RPA...', 'info');
        
        fetch(`/workflow/api/debida-diligencia/reenviar-correo/${currentSolicitudId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                tipo_documento: tipoDocumento
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Correo reenviado exitosamente:', data);
            showNotification(data.message || 'Correo reenviado exitosamente a Makito RPA', 'success');
            // Recargar el estado de diligencia para reflejar cualquier cambio
            setTimeout(() => {
                loadDebidaDiligenciaStatus();
            }, 1000);
        })
        .catch(error => {
            console.error('Error reenviando correo:', error);
            showNotification('Error al reenviar correo: ' + error.message, 'error');
        });
    }

    // Event listener for diligencia tab activation
    document.addEventListener('DOMContentLoaded', function() {
        const diligenciaTab = document.getElementById('diligencia-tab');
        if (diligenciaTab) {
            diligenciaTab.addEventListener('shown.bs.tab', function (event) {
                console.log('Diligencia tab activated');
                loadDebidaDiligenciaStatus();
            });
        }
        
        // Event listener for notas tab activation
        const notasTab = document.getElementById('notas-tab');
        if (notasTab) {
            notasTab.addEventListener('shown.bs.tab', function (event) {
                console.log('Notas tab activated');
                cargarNotasRecordatorios();
            });
        }
        
        // Event listener for documentos pendientes tab activation
        const documentosPendientesTab = document.getElementById('documentos-pendientes-tab');
        if (documentosPendientesTab) {
            documentosPendientesTab.addEventListener('shown.bs.tab', function (event) {
                console.log('Documentos Pendientes tab activated');
                console.log('Tab event target:', event.target);
                console.log('Current modal data available:', !!window.currentModalData);
                
                // Ensure the container is visible
                const pendientesContainer = document.getElementById('modalSolicitudDocumentosPendientes');
                if (pendientesContainer) {
                    console.log('Documentos pendientes container found');
                    console.log('Container visibility:', getComputedStyle(pendientesContainer).display);
                } else {
                    console.error('Documentos pendientes container not found!');
                }
                
                // Refresh documentos pendientes data if needed
                if (window.currentModalData && window.currentModalData.documentos) {
                    console.log('Repopulating documentos pendientes with', window.currentModalData.documentos.length, 'documentos');
                    populateDocumentosPendientesTab(window.currentModalData.documentos);
                } else {
                    console.warn('No modal data available for documentos pendientes');
                }
            });
        } else {
            console.error('Documentos pendientes tab not found!');
        }
        
        // Event listener for documentos urgentes tab activation
        const documentosUrgentesTab = document.getElementById('documentos-urgentes-tab');
        if (documentosUrgentesTab) {
            documentosUrgentesTab.addEventListener('shown.bs.tab', function (event) {
                console.log('Documentos Urgentes tab activated');
                console.log('Tab event target:', event.target);
                console.log('Current modal data available:', !!window.currentModalData);
                
                // Ensure the container is visible
                const urgentesContainer = document.getElementById('modalSolicitudDocumentosUrgentes');
                if (urgentesContainer) {
                    console.log('Documentos urgentes container found');
                    console.log('Container visibility:', getComputedStyle(urgentesContainer).display);
                } else {
                    console.error('Documentos urgentes container not found!');
                }
                
                // Refresh documentos urgentes data if needed
                if (window.currentModalData && window.currentModalData.documentos) {
                    console.log('Repopulating documentos urgentes with', window.currentModalData.documentos.length, 'documentos');
                    populateDocumentosUrgentesTab(window.currentModalData.documentos);
                } else {
                    console.warn('No modal data available for documentos urgentes');
                }
            });
        } else {
            console.error('Documentos urgentes tab not found!');
        }

        // Event listener for formulario general tab activation
        const formularioGeneralTab = document.getElementById('formulario-general-tab');
        if (formularioGeneralTab) {
            formularioGeneralTab.addEventListener('shown.bs.tab', function (event) {
                console.log(' Formulario General tab activated');
                
                // Verificar estado de entrevista cuando se abre el tab
                if (window.currentModalData && window.currentModalData.solicitud) {
                    console.log(' Verificando estado de entrevista en tab...');
                    verificarEstadoEntrevista(window.currentModalData.solicitud);
                } else {
                    console.log('锔 No hay datos de solicitud disponibles para verificar entrevista');
                }
            });
        } else {
            console.error('Formulario general tab not found!');
        }
    });

    // ========================================
    // FUNCIONES PARA ALERTAS DE DOCUMENTOS
    // ========================================

    function mostrarAlertasDocumentos(documentos) {
        console.log(' INICIANDO mostrarAlertasDocumentos con', documentos.length, 'documentos');
        
        const alertContainer = document.getElementById('documentosIconsAlert');
        const iconUrgente = document.getElementById('iconUrgente');
        const iconPendiente = document.getElementById('iconPendiente');
        const urgenteCount = document.getElementById('urgenteCountIcon');
        const pendienteCount = document.getElementById('pendienteCountIcon');
        
        if (!alertContainer) {
            console.error(' No se encontr贸 el contenedor de iconos de alerta');
            return;
        }
        
        // Filtrar documentos urgentes (malo y no subsanado)
        const documentosUrgentes = documentos.filter(doc => 
            doc.calificacion_estado === 'malo' && !doc.subsanado
        );
        
        // Filtrar documentos pendientes
        const documentosPendientes = documentos.filter(doc => 
            doc.calificacion_estado === 'pendiente' && !doc.subsanado
        );
        
        console.log(' Documentos urgentes encontrados:', documentosUrgentes.length);
        console.log(' Documentos pendientes encontrados:', documentosPendientes.length);
        
        // Mostrar/ocultar iconos seg煤n corresponda
        let hayAlertas = false;
        
        if (documentosUrgentes.length > 0) {
            urgenteCount.textContent = documentosUrgentes.length;
            iconUrgente.style.display = 'flex';
            hayAlertas = true;
            console.log(' Mostrando icono de documentos urgentes');
        } else {
            iconUrgente.style.display = 'none';
        }
        
        if (documentosPendientes.length > 0) {
            pendienteCount.textContent = documentosPendientes.length;
            iconPendiente.style.display = 'flex';
            hayAlertas = true;
            console.log(' Mostrando icono de documentos pendientes');
        } else {
            iconPendiente.style.display = 'none';
        }
        
        // Mostrar/ocultar el contenedor principal
        if (hayAlertas) {
            alertContainer.style.display = 'flex';
            console.log(' Contenedor de iconos mostrado');
            
            // Reproducir sonido de alerta m谩s sutil
            reproducirSonidoAlerta(documentosUrgentes.length > 0);
        } else {
            alertContainer.style.display = 'none';
            console.log('癸 No hay alertas que mostrar');
        }
    }
    
    function reproducirSonidoAlerta(esUrgente) {
        try {
            // Crear contexto de audio
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Configuraci贸n del sonido m谩s sutil
            const frequency = esUrgente ? 650 : 550; // Frecuencias m谩s suaves
            const duration = 0.15; // M谩s corto
            
            // Crear oscilador
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            // Configurar volumen muy suave
            gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            // Reproducir
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
            
            console.log(' Sonido sutil de alerta reproducido');
        } catch (error) {
            console.log(' No se pudo reproducir sonido de alerta:', error.message);
        }
    }

    // ========================================
    // FUNCIONES PARA ASOCIAR ENTREVISTA
    // ========================================

    let entrevistaSeleccionadaId = null;
    let currentSolicitudData = null;

    function abrirModalAsociarEntrevista() {
        // Usar los datos de la solicitud actual del modal
        if (!window.currentModalData || !window.currentModalData.solicitud) {
            console.error('No hay datos de solicitud disponibles');
            showNotification('No se pueden cargar los datos de la solicitud para asociar entrevista', 'error');
            return;
        }

        const solicitud = window.currentModalData.solicitud;
        const clienteNombre = solicitud.cliente_nombre_completo || 'Cliente';
        const clienteCedula = solicitud.cliente_cedula_completa || 'No disponible';
        
        // Actualizar el encabezado del modal con los datos del cliente
        document.getElementById('clienteNombreModal').textContent = clienteNombre;
        document.getElementById('clienteCedulaModal').textContent = clienteCedula;
        document.getElementById('filteredByCedula').textContent = clienteCedula;
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('modalAsociarEntrevista'));
        modal.show();
        
        // Limpiar b煤squeda anterior y configurarla con la c茅dula del cliente
        const inputBusqueda = document.getElementById('buscarEntrevista');
        inputBusqueda.value = '';
        inputBusqueda.placeholder = `Buscar por nombre o email (ya filtrado por c茅dula)`;
        
        // Autom谩ticamente buscar entrevistas con la misma c茅dula
        buscarEntrevistasPorCedula(clienteCedula);
        document.getElementById('resultadosEntrevistas').innerHTML = '';
        document.getElementById('entrevistaSeleccionada').style.display = 'none';
        document.getElementById('btnConfirmarAsociacion').disabled = true;
        entrevistaSeleccionadaId = null;
    }

    function buscarEntrevistasPorCedula(cedula) {
        if (!cedula || cedula === 'No disponible') {
            document.getElementById('resultadosEntrevistas').innerHTML = 
                '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No se puede buscar entrevistas porque la solicitud no tiene un n煤mero de c茅dula asociado.</div>';
            return;
        }
        
        // Mostrar loading
        document.getElementById('resultadosEntrevistas').innerHTML = 
            '<div class="text-center p-3"><i class="fas fa-spinner fa-spin me-2"></i> Buscando entrevistas para la c茅dula ' + cedula + '...</div>';
        
        // Realizar b煤squeda AJAX filtrando por c茅dula
        fetch(`/workflow/buscar-entrevistas/?cedula=${encodeURIComponent(cedula)}`)
            .then(response => response.json())
            .then(data => {
                //  VALIDACIN: Verificar que la respuesta sea exitosa y contenga entrevistas
                if (!data.success) {
                    throw new Error(data.error || 'Error en la respuesta del servidor');
                }
                
                // Mostrar mensaje sobre la b煤squeda flexible
                const mensajeFlexible = `
                    <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-3">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-500"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    <strong>B煤squeda inteligente:</strong> El sistema busca entrevistas que tengan una c茅dula similar a <strong>${cedula}</strong>, 
                                    incluso si el formato de escritura es diferente.
                                </p>
                                <p class="text-sm text-blue-700 mt-1">
                                    <i class="fas fa-shield-alt text-blue-600 me-1"></i>
                                    <strong>Nota:</strong> Por seguridad, solo puede seleccionar entrevistas con coincidencia exacta o parcial de c茅dula.
                                    <button type="button" class="btn btn-link text-info p-0 ml-1" onclick="mostrarInfoCoincidencias()">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                const container = document.getElementById('resultadosEntrevistas');
                container.innerHTML = mensajeFlexible;
                mostrarResultadosEntrevistas(data.entrevistas || [], cedula);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('resultadosEntrevistas').innerHTML = 
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al buscar entrevistas</div>';
            });
    }

    function buscarEntrevistas() {
        const termino = document.getElementById('buscarEntrevista').value.trim();
        const clienteCedula = window.currentModalData?.solicitud?.cliente_cedula_completa || 'No disponible';
        
        if (termino.length < 3) {
            // Si no hay t茅rmino de b煤squeda, volvemos a la b煤squeda por c茅dula
            buscarEntrevistasPorCedula(clienteCedula);
            return;
        }
        
        // Mostrar loading
        document.getElementById('resultadosEntrevistas').innerHTML = 
            '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i> Buscando...</div>';
        
        // Realizar b煤squeda AJAX con filtro adicional de c茅dula
        fetch(`/workflow/buscar-entrevistas/?cedula=${encodeURIComponent(clienteCedula)}&query=${encodeURIComponent(termino)}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Error en la respuesta del servidor');
                }
                mostrarResultadosEntrevistas(data.entrevistas || [], clienteCedula);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('resultadosEntrevistas').innerHTML = 
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al buscar entrevistas</div>';
            });
    }

    function mostrarResultadosEntrevistas(entrevistas, cedulaCliente) {
        const container = document.getElementById('resultadosEntrevistas');
        
        if (!entrevistas || entrevistas.length === 0) {
            container.innerHTML += `
                <div class="text-center p-4">
                    <i class="fas fa-search text-muted mb-3" style="font-size: 3rem;"></i>
                    <p class="text-muted">No se encontraron entrevistas para la c茅dula <strong>${cedulaCliente}</strong></p>
                    <p class="text-sm text-muted">Verifique que el cliente haya completado una entrevista previamente.</p>
                </div>
            `;
            return;
        }
        
        const resultadosHtml = `
            <div class="divide-y divide-gray-200 max-h-[50vh] overflow-y-auto px-1 py-2 rounded-md shadow-inner bg-gray-50">
                ${entrevistas.map(entrevista => {
                    const tieneCoincidencia = verificarCoincidenciaCedula(entrevista.cedula, cedulaCliente);
                    const esSeleccionable = tieneCoincidencia;
                    
                    return `
                        <div class="p-4 hover:bg-gray-100 rounded-md ${esSeleccionable ? 'cursor-pointer' : 'cursor-not-allowed'} transition-all duration-300 ${esSeleccionable ? 'bg-white' : 'bg-gray-50 opacity-70'} mb-2" 
                             onclick="${esSeleccionable ? `seleccionarEntrevista('${entrevista.id}', '${entrevista.nombre}', '${entrevista.cedula}', '${entrevista.email}', '${entrevista.telefono}', '${entrevista.fecha}')` : `mostrarMensajeCoincidencia('${entrevista.cedula}', '${cedulaCliente}')`}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h6 class="font-medium text-gray-900 mb-1">${entrevista.nombre}</h6>
                                    <p class="text-gray-800 font-mono mb-1">
                                        <strong class="text-gray-600">C茅dula:</strong> ${entrevista.cedula}
                                        <span class="inline-flex items-center ml-2 px-2 py-0.5 rounded-full text-xs font-medium ${tieneCoincidencia ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            <i class="fas ${tieneCoincidencia ? 'fa-check-circle' : 'fa-times-circle'} mr-1"></i>${tieneCoincidencia ? 'Coincidencia' : 'Sin coincidencia'}
                                        </span>
                                    </p>
                                    <p class="text-gray-600 text-sm">
                                        <strong>Email:</strong> ${entrevista.email} | 
                                        <strong>Tel茅fono:</strong> ${entrevista.telefono}
                                    </p>
                                </div>
                                <div class="flex flex-col items-end">
                                    <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${entrevista.tipo_prestamo}</span>
                                    <small class="text-gray-500 mt-2">${entrevista.fecha}</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        container.innerHTML += resultadosHtml;
    }

    function verificarCoincidenciaCedula(cedulaEntrevista, cedulaCliente) {
        // Limpiar ambas c茅dulas de caracteres especiales y espacios
        const limpiarCedula = (cedula) => cedula.replace(/[^\w]/g, '').toLowerCase();
        
        const cedulaEntrevistaLimpia = limpiarCedula(cedulaEntrevista);
        const cedulaClienteLimpia = limpiarCedula(cedulaCliente);
        
        // Verificar coincidencia exacta o parcial (al menos 70% de coincidencia)
        if (cedulaEntrevistaLimpia === cedulaClienteLimpia) {
            return true;
        }
        
        // Verificar si una est谩 contenida en la otra (para casos como "8-123-456" vs "81234567")
        return cedulaEntrevistaLimpia.includes(cedulaClienteLimpia) || 
               cedulaClienteLimpia.includes(cedulaEntrevistaLimpia);
    }

    function seleccionarEntrevista(id, nombre, cedula, email, telefono, fecha) {
        entrevistaSeleccionadaId = id;
        
        // Mostrar informaci贸n de la entrevista seleccionada
        document.getElementById('nombreEntrevistaSeleccionada').textContent = nombre;
        document.getElementById('cedulaEntrevistaSeleccionada').textContent = cedula;
        document.getElementById('entrevistaSeleccionada').style.display = 'block';
        document.getElementById('btnConfirmarAsociacion').disabled = false;
        
        console.log('Entrevista seleccionada:', { id, nombre, cedula, email, telefono, fecha });
    }

    function mostrarMensajeCoincidencia(cedulaEntrevista, cedulaCliente) {
        showNotification(
            `Esta entrevista (${cedulaEntrevista}) no coincide con la c茅dula del cliente (${cedulaCliente}). Por seguridad, solo puede seleccionar entrevistas del mismo cliente.`,
            'warning'
        );
    }

    function mostrarInfoCoincidencias() {
        showNotification(
            'El sistema verifica que la c茅dula de la entrevista coincida con la del cliente de la solicitud. Esto garantiza que solo se asocien entrevistas del cliente correcto.',
            'info'
        );
    }

    function confirmarAsociacion() {
        if (!entrevistaSeleccionadaId) {
            showNotification('Debe seleccionar una entrevista primero', 'error');
            return;
        }
        
        if (!window.currentModalData?.solicitud?.id) {
            showNotification('No se puede obtener el ID de la solicitud', 'error');
            return;
        }
        
        // Mostrar loading en el bot贸n
        const btnConfirmar = document.getElementById('btnConfirmarAsociacion');
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Asociando...';
        
        // Realizar la asociaci贸n via AJAX
        fetch('/workflow/asociar-entrevista/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                solicitud_id: window.currentModalData.solicitud.id,
                entrevista_id: entrevistaSeleccionadaId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Entrevista asociada exitosamente', 'success');
                // Cerrar el modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAsociarEntrevista'));
                modal.hide();
                
                // Actualizar el estado del bot贸n y tab
                actualizarEstadoEntrevista(true);
                
                // Recargar el modal principal para mostrar los datos actualizados
                setTimeout(() => {
                    // Solo actualizar el estado visual del tab
                    verificarEstadoEntrevista(window.currentModalData.solicitud);
                }, 500);
            } else {
                throw new Error(data.error || 'Error al asociar entrevista');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error al asociar entrevista: ' + error.message, 'error');
        })
        .finally(() => {
            // Restaurar el bot贸n
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="fas fa-link me-1"></i> Confirmar Asociaci贸n';
        });
    }

    function desasociarEntrevista() {
        if (!window.currentModalData?.solicitud?.id) {
            showNotification('No se puede obtener el ID de la solicitud', 'error');
            return;
        }
        
        if (!confirm('驴Est谩 seguro de que desea desasociar la entrevista de esta solicitud?')) {
            return;
        }
        
        // Realizar la desasociaci贸n via AJAX usando el endpoint existente
        fetch('/workflow/asociar-entrevista/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                solicitud_id: window.currentModalData.solicitud.id,
                accion: 'desasociar'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Entrevista desasociada exitosamente', 'success');
                // Actualizar el estado del bot贸n y tab
                actualizarEstadoEntrevista(false);
                // Limpiar el contenido del tab
                mostrarEstadoSinEntrevista();
            } else {
                throw new Error(data.error || 'Error al desasociar entrevista');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error al desasociar entrevista: ' + error.message, 'error');
        });
    }

    function actualizarEstadoEntrevista(tieneEntrevista) {
        console.log(' actualizarEstadoEntrevista llamada con:', tieneEntrevista);
        
        const iconAsociar = document.getElementById('iconAsociarEntrevista');
        const iconoElement = document.getElementById('iconAsociarEntrevistaIcon');
        const badgeElement = document.getElementById('estadoEntrevistaBadge');
        
        console.log(' Elementos encontrados:', {
            iconAsociar: !!iconAsociar,
            iconoElement: !!iconoElement,
            badgeElement: !!badgeElement
        });
        
        if (tieneEntrevista) {
            console.log(' Configurando estado ASOCIADA');
            if (iconAsociar) {
                iconAsociar.classList.add('asociada');
                iconAsociar.title = 'Entrevista asociada - Click para ver detalles';
                console.log(' IconAsociar configurado como asociada');
            }
            if (iconoElement) {
                iconoElement.className = 'fas fa-check';
                console.log(' IconoElement cambiado a fa-check');
            }
            if (badgeElement) {
                badgeElement.textContent = '';
                badgeElement.classList.add('asociada');
                console.log(' BadgeElement cambiado a  y clase asociada agregada');
            }
        } else {
            console.log(' Configurando estado SIN ASOCIAR');
            if (iconAsociar) {
                iconAsociar.classList.remove('asociada');
                iconAsociar.title = 'Asociar entrevista de cliente';
                console.log(' IconAsociar configurado sin asociar');
            }
            if (iconoElement) {
                iconoElement.className = 'fas fa-link';
                console.log(' IconoElement cambiado a fa-link');
            }
            if (badgeElement) {
                badgeElement.textContent = '!';
                badgeElement.classList.remove('asociada');
                console.log(' BadgeElement cambiado a ! y clase asociada removida');
            }
        }
    }

    function mostrarEstadoSinEntrevista() {
        document.getElementById('entrevistaAsociada').style.display = 'none';
        document.getElementById('busquedaEntrevistaIntegrada').style.display = 'block';
    }

    function mostrarEstadoConEntrevista(entrevista) {
        document.getElementById('entrevistaClienteNombre').textContent = entrevista.nombre || 'No disponible';
        document.getElementById('entrevistaClienteCedula').textContent = entrevista.cedula || 'No disponible';
        document.getElementById('entrevistaClienteEmail').textContent = entrevista.email || 'No disponible';
        document.getElementById('entrevistaClienteTelefono').textContent = entrevista.telefono || 'No disponible';
        document.getElementById('entrevistaFecha').textContent = entrevista.fecha || 'No disponible';
        
        document.getElementById('busquedaEntrevistaIntegrada').style.display = 'none';
        document.getElementById('entrevistaAsociada').style.display = 'block';
    }

    function manejarClickEntrevista() {
        // En el modal de negocios, SIEMPRE abrir el tab de Formulario General
        // El modal de asociaci贸n se abre desde el bot贸n dentro del tab
        switchToTab('formulario-general');
    }

    function verificarEstadoEntrevista(solicitud) {
        // Validar que solicitud existe
        if (!solicitud) {
            console.log('锔 No hay datos de solicitud para verificar entrevista');
            return;
        }
        
        console.log(' Verificando estado de entrevista para solicitud:', solicitud);
        console.log(' Datos de entrevista_cliente:', solicitud.entrevista_cliente);
        
        // Mostrar siempre el bot贸n de asociar entrevista
        const alertContainer = document.getElementById('documentosIconsAlert');
        if (alertContainer) {
            alertContainer.style.display = 'flex';
        }
        
        // Verificar si tiene entrevista asociada
        const tieneEntrevista = solicitud.entrevista_cliente && solicitud.entrevista_cliente.id;
        console.log(' 驴Tiene entrevista asociada?', tieneEntrevista);
        
        // Actualizar el estado del bot贸n
        actualizarEstadoEntrevista(tieneEntrevista);
        
        // Actualizar los datos del cliente en el tab
        document.getElementById('clienteNombreFormulario').textContent = solicitud.cliente_nombre_completo || 'No disponible';
        document.getElementById('clienteCedulaFormulario').textContent = solicitud.cliente_cedula_completa || 'No disponible';
        document.getElementById('filteredByCedulaTab').textContent = solicitud.cliente_cedula_completa || 'No disponible';
        
        // Actualizar el contenido del tab
        if (tieneEntrevista) {
            const entrevista = solicitud.entrevista_cliente;
            console.log(' Entrevista encontrada:', entrevista);
            mostrarEstadoConEntrevista({
                nombre: entrevista.nombre_completo || 'No disponible',
                cedula: entrevista.cedula || 'No disponible',
                email: entrevista.email || 'No disponible',
                telefono: entrevista.telefono || 'No disponible',
                fecha: entrevista.fecha_entrevista || 'No disponible'
            });
        } else {
            console.log(' No hay entrevista asociada');
            mostrarEstadoSinEntrevista();
            // Iniciar b煤squeda autom谩tica por c茅dula cuando se carga el tab
            buscarEntrevistasPorCedulaEnTab(solicitud.cliente_cedula_completa);
        }
    }

    // ========================================
    // FUNCIONES PARA BSQUEDA INTEGRADA EN TAB
    // ========================================

    // Variables para el tab integrado
    let entrevistaSeleccionadaIdTab = null;

    // Funci贸n para comparar c茅dulas y determinar coincidencias
    function compararCedulas(cedulaSolicitud, cedulaEntrevista) {
        if (!cedulaSolicitud || !cedulaEntrevista) return 'sin_coincidencia';
        
        // Limpiar ambas c茅dulas de espacios y guiones
        const cedula1 = cedulaSolicitud.toString().replace(/[-\s]/g, '');
        const cedula2 = cedulaEntrevista.toString().replace(/[-\s]/g, '');
        
        // Coincidencia exacta
        if (cedula1 === cedula2) return 'exacta';
        
        // Coincidencia parcial (al menos 6 d铆gitos consecutivos)
        for (let i = 0; i <= cedula1.length - 6; i++) {
            const subcedula1 = cedula1.substring(i, i + 6);
            if (cedula2.includes(subcedula1)) return 'parcial';
        }
        
        for (let i = 0; i <= cedula2.length - 6; i++) {
            const subcedula2 = cedula2.substring(i, i + 6);
            if (cedula1.includes(subcedula2)) return 'parcial';
        }
        
        return 'sin_coincidencia';
    }

    // Funci贸n para buscar entrevistas por c茅dula en el tab
    function buscarEntrevistasPorCedulaEnTab(cedula) {
        if (!cedula || cedula === 'No disponible') {
            document.getElementById('resultadosEntrevistasTab').innerHTML = 
                '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No se puede buscar entrevistas porque la solicitud no tiene un n煤mero de c茅dula asociado.</div>';
            return;
        }
        
        // Mostrar loading
        document.getElementById('resultadosEntrevistasTab').innerHTML = 
            '<div class="text-center p-3"><i class="fas fa-spinner fa-spin me-2"></i> Buscando entrevistas para la c茅dula ' + cedula + '...</div>';
        
        // Realizar b煤squeda AJAX filtrando por c茅dula
        fetch(`/workflow/buscar-entrevistas/?cedula=${encodeURIComponent(cedula)}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Error en la respuesta del servidor');
                }
                
                mostrarResultadosEntrevistasEnTab(data.entrevistas || [], cedula);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('resultadosEntrevistasTab').innerHTML = 
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al buscar entrevistas</div>';
            });
    }

    // Funci贸n para buscar entrevistas en el tab (con filtro de texto)
    function buscarEntrevistasEnTab() {
        const termino = document.getElementById('buscarEntrevistaTab').value.trim();
        const clienteCedula = document.getElementById('clienteCedulaFormulario').textContent;
        
        if (termino.length < 3) {
            // Si no hay t茅rmino de b煤squeda, volvemos a la b煤squeda por c茅dula
            buscarEntrevistasPorCedulaEnTab(clienteCedula);
            return;
        }
        
        // Mostrar loading
        document.getElementById('resultadosEntrevistasTab').innerHTML = 
            '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i> Buscando...</div>';
        
        // Realizar b煤squeda AJAX con filtro adicional de c茅dula
        fetch(`/workflow/buscar-entrevistas/?cedula=${encodeURIComponent(clienteCedula)}&query=${encodeURIComponent(termino)}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Error en la respuesta del servidor');
                }
                
                mostrarResultadosEntrevistasEnTab(data.entrevistas || [], clienteCedula);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('resultadosEntrevistasTab').innerHTML = 
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al buscar entrevistas</div>';
            });
    }

    // Funci贸n para mostrar resultados de entrevistas en el tab
    function mostrarResultadosEntrevistasEnTab(entrevistas, cedula) {
        const container = document.getElementById('resultadosEntrevistasTab');
        
        if (!entrevistas || entrevistas.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No se encontraron entrevistas para la c茅dula <strong>${cedula}</strong>
                </div>`;
            return;
        }
        
        let html = `<div class="entrevistas-results max-h-96 overflow-y-auto">`;
        
        entrevistas.forEach(entrevista => {
            const coincidencia = compararCedulas(entrevista.cedula, cedula);
            let rowClass, badgeClass, badgeText, cursorStyle, onclickAttr;
            
            if (coincidencia === 'exacta') {
                rowClass = 'bg-green-50 border border-green-200 shadow-sm hover:shadow-md';
                badgeClass = 'bg-green-100 text-green-800';
                badgeText = '<i class="fas fa-check-circle mr-1"></i>Coincidencia exacta';
                cursorStyle = 'cursor-pointer';
                onclickAttr = `onclick="seleccionarEntrevistaEnTab(${entrevista.id}, '${entrevista.nombre_completo}', '${entrevista.cedula}', '${entrevista.email}', '${entrevista.telefono}', '${entrevista.fecha_entrevista}')"`;
            } else if (coincidencia === 'parcial') {
                rowClass = 'bg-blue-50 border border-blue-200 shadow-sm hover:shadow-md'; 
                badgeClass = 'bg-blue-100 text-blue-800';
                badgeText = '<i class="fas fa-check mr-1"></i>Coincidencia parcial';
                cursorStyle = 'cursor-pointer';
                onclickAttr = `onclick="seleccionarEntrevistaEnTab(${entrevista.id}, '${entrevista.nombre_completo}', '${entrevista.cedula}', '${entrevista.email}', '${entrevista.telefono}', '${entrevista.fecha_entrevista}')"`;
            } else {
                rowClass = 'bg-gray-50 opacity-70';
                badgeClass = 'bg-red-100 text-red-800';
                badgeText = '<i class="fas fa-times-circle mr-1"></i>Sin coincidencia';
                cursorStyle = 'cursor-not-allowed';
                onclickAttr = `onclick="showNotification('Esta entrevista no coincide con la c茅dula del cliente por motivos de seguridad.', 'warning')"`;
            }
            
            html += `
                <div class="p-3 mb-2 rounded-md ${cursorStyle} transition-all duration-300 ${rowClass}" ${onclickAttr}>
                    <div class="flex justify-between items-start">
                        <div>
                            <h6 class="font-medium text-gray-900 mb-1">${entrevista.nombre_completo}</h6>
                            <p class="text-gray-800 font-mono mb-1">
                                <strong class="text-gray-600">C茅dula:</strong> ${entrevista.cedula}
                                <span class="inline-flex items-center ml-2 px-2 py-0.5 rounded-full text-xs font-medium ${badgeClass}">
                                    ${badgeText}
                                </span>
                            </p>
                            <p class="text-gray-600 text-sm">
                                <strong>Email:</strong> ${entrevista.email || 'No disponible'} | 
                                <strong>Tel茅fono:</strong> ${entrevista.telefono || 'No disponible'}
                            </p>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${entrevista.tipo_producto || 'Sin producto'}</span>
                            <small class="text-gray-500 mt-2">${entrevista.fecha_entrevista || 'Fecha no disponible'}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    // Funci贸n para seleccionar entrevista en el tab
    function seleccionarEntrevistaEnTab(id, nombre, cedula, email, telefono, fecha) {
        entrevistaSeleccionadaIdTab = id;
        
        // Mostrar la secci贸n de entrevista seleccionada
        document.getElementById('entrevistaSeleccionadaTab').style.display = 'block';
        document.getElementById('nombreEntrevistaSeleccionadaTab').textContent = nombre;
        document.getElementById('cedulaEntrevistaSeleccionadaTab').textContent = cedula;
        
        console.log('Entrevista seleccionada en tab:', { id, nombre, cedula, email, telefono, fecha });
    }

    // Funci贸n para confirmar asociaci贸n en el tab
    function confirmarAsociacionEnTab() {
        if (!entrevistaSeleccionadaIdTab) {
            showNotification('Debe seleccionar una entrevista primero', 'error');
            return;
        }
        
        if (!window.currentModalData?.solicitud?.id) {
            showNotification('No se puede obtener el ID de la solicitud', 'error');
            return;
        }
        
        // Mostrar loading en el bot贸n
        const btnConfirmar = document.getElementById('btnConfirmarAsociacionTab');
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Asociando...';
        
        // Verificar datos antes de enviar
        const solicitudId = window.currentModalData?.solicitud?.id;
        console.log(' DEBUG - Datos para asociaci贸n:', {
            solicitudId: solicitudId,
            entrevistaId: entrevistaSeleccionadaIdTab,
            currentModalData: window.currentModalData
        });
        
        if (!solicitudId || !entrevistaSeleccionadaIdTab) {
            showNotification('Error: Faltan datos necesarios para la asociaci贸n', 'error');
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="fas fa-link me-1"></i> Confirmar Asociaci贸n';
            return;
        }
        
        // Realizar la asociaci贸n via AJAX
        fetch('/workflow/asociar-entrevista/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                solicitud_id: solicitudId,
                entrevista_id: entrevistaSeleccionadaIdTab,
                accion: 'asociar'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Entrevista asociada exitosamente', 'success');
                
                // Actualizar los datos de la solicitud con la entrevista asociada
                if (window.currentModalData && window.currentModalData.solicitud) {
                    window.currentModalData.solicitud.entrevista_cliente = data.entrevista;
                    console.log(' Datos de solicitud actualizados con entrevista:', data.entrevista);
                }
                
                // Actualizar el estado del bot贸n de asociar entrevista
                actualizarEstadoEntrevista(true);
                
                // Mostrar el estado con entrevista asociada en el tab
                setTimeout(() => {
                    if (data.entrevista) {
                        mostrarEstadoConEntrevista({
                            nombre: data.entrevista.nombre_completo || 'No disponible',
                            cedula: data.entrevista.cedula || 'No disponible',
                            email: 'Asociada exitosamente',
                            telefono: data.entrevista.celular || '',
                            fecha: data.entrevista.fecha_creacion || new Date().toLocaleDateString()
                        });
                        
                        // Ocultar la secci贸n de b煤squeda y selecci贸n
                        document.getElementById('entrevistaSeleccionadaTab').style.display = 'none';
                        document.getElementById('resultadosEntrevistasTab').innerHTML = '';
                        document.getElementById('buscarEntrevistaTab').value = '';
                    }
                }, 500);
            } else {
                throw new Error(data.error || 'Error al asociar entrevista');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error al asociar entrevista: ' + error.message, 'error');
        })
        .finally(() => {
            // Restaurar bot贸n
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="fas fa-link me-1"></i> Confirmar Asociaci贸n';
        });
    }

    // Funci贸n para mostrar la b煤squeda cuando se quiere cambiar entrevista
    function mostrarBusquedaEntrevista() {
        document.getElementById('busquedaEntrevistaIntegrada').style.display = 'block';
        document.getElementById('entrevistaAsociada').style.display = 'none';
        
        // Reiniciar b煤squeda
        const cedula = document.getElementById('clienteCedulaFormulario').textContent;
        buscarEntrevistasPorCedulaEnTab(cedula);
    }

    // ========================================
    // FUNCIONES PARA NOTAS Y RECORDATORIOS
    // ========================================

    function cargarNotasRecordatorios() {
        if (!currentSolicitudId) {
            console.error('No current solicitud ID available');
            return;
        }

        const container = document.getElementById('modalSolicitudNotas');
        let loadingPlaceholder = container.querySelector('.loading-placeholder');
        let emptyState = container.querySelector('.empty-state');

        // Create loading and empty state elements if they don't exist
        if (!loadingPlaceholder) {
            loadingPlaceholder = document.createElement('div');
            loadingPlaceholder.className = 'loading-placeholder';
            loadingPlaceholder.style.display = 'none';
            loadingPlaceholder.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando notas...</span>
                </div>
            `;
            container.appendChild(loadingPlaceholder);
        }

        if (!emptyState) {
            emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.style.display = 'none';
            emptyState.innerHTML = `
                <i class="fas fa-sticky-note mb-3 text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted">No hay notas o recordatorios</p>
                <button class="btn btn-primary" onclick="abrirModalNuevaNota()">
                    <i class="fas fa-plus me-1"></i>Crear primera nota
                </button>
            `;
            container.appendChild(emptyState);
        }

        // Show loading
        loadingPlaceholder.style.display = 'block';
        emptyState.style.display = 'none';

        fetch(`/workflow/api/notas-recordatorios/${currentSolicitudId}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Notas cargadas:', data);
            renderizarNotas(data.notas);
        })
        .catch(error => {
            console.error('Error cargando notas:', error);
            showNotification('Error al cargar notas: ' + error.message, 'error');
            emptyState.style.display = 'block';
        })
        .finally(() => {
            loadingPlaceholder.style.display = 'none';
        });
    }

    function renderizarNotas(notas) {
        const container = document.getElementById('modalSolicitudNotas');
        let emptyState = container.querySelector('.empty-state');
        let loadingPlaceholder = container.querySelector('.loading-placeholder');

        // Ensure emptyState exists
        if (!emptyState) {
            emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.style.display = 'none';
            emptyState.innerHTML = `
                <i class="fas fa-sticky-note mb-3 text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted">No hay notas o recordatorios</p>
                <button class="btn btn-primary" onclick="abrirModalNuevaNota()">
                    <i class="fas fa-plus me-1"></i>Crear primera nota
                </button>
            `;
            container.appendChild(emptyState);
        }

        // Remove existing note cards (keep loading and empty state elements)
        const existingNotes = container.querySelectorAll('.nota-card');
        existingNotes.forEach(note => note.remove());

        if (!notas || notas.length === 0) {
            resetEmptyStateToOriginal(emptyState);
            emptyState.style.display = 'block';
            return;
        }

        // Reset empty state to original content in case it was changed by filters
        resetEmptyStateToOriginal(emptyState);
        emptyState.style.display = 'none';

        // Aplicar filtros
        const filtroTipoEl = document.getElementById('filtroTipoNota');
        const filtroEstadoEl = document.getElementById('filtroEstadoNota');
        const filtroPrioridadEl = document.getElementById('filtroPrioridadNota');
        
        const filtroTipo = filtroTipoEl ? filtroTipoEl.value : '';
        const filtroEstado = filtroEstadoEl ? filtroEstadoEl.value : '';
        const filtroPrioridad = filtroPrioridadEl ? filtroPrioridadEl.value : '';

        let notasFiltradas = notas.filter(nota => {
            if (filtroTipo && nota.tipo !== filtroTipo) return false;
            if (filtroEstado && nota.estado !== filtroEstado) return false;
            if (filtroPrioridad && nota.prioridad !== filtroPrioridad) return false;
            return true;
        });

        if (notasFiltradas.length === 0) {
            // Update the empty state content for filtered results
            emptyState.innerHTML = `
                <i class="fas fa-filter mb-3 text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted">No hay notas que coincidan con los filtros aplicados</p>
                <button class="btn btn-outline-primary" onclick="limpiarFiltrosNotas()">
                    <i class="fas fa-filter-circle-xmark me-1"></i>Limpiar filtros
                </button>
            `;
            emptyState.style.display = 'block';
            return;
        }

        // Create and append note elements
        notasFiltradas.forEach(nota => {
            const noteElement = document.createElement('div');
            noteElement.innerHTML = crearNotaHTML(nota);
            container.appendChild(noteElement.firstElementChild);
        });
    }

    function resetEmptyStateToOriginal(emptyState) {
        emptyState.innerHTML = `
            <i class="fas fa-sticky-note mb-3 text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted">No hay notas o recordatorios</p>
            <button class="btn btn-primary" onclick="abrirModalNuevaNota()">
                <i class="fas fa-plus me-1"></i>Crear primera nota
            </button>
        `;
    }

    function crearNotaHTML(nota) {
        const fechaCreacion = new Date(nota.fecha_creacion).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        let fechaVencimientoHTML = '';
        let estadoHTML = '';
        let cardClasses = 'nota-card';

        if (nota.tipo === 'recordatorio') {
            const fechaVencimiento = new Date(nota.fecha_vencimiento);
            const ahora = new Date();
            const tiempoRestante = fechaVencimiento - ahora;
            const diasRestantes = Math.ceil(tiempoRestante / (1000 * 60 * 60 * 24));

            let fechaVencimientoClass = 'normal';
            let fechaVencimientoText = `Vence en ${diasRestantes} d铆as`;

            if (tiempoRestante < 0) {
                fechaVencimientoClass = 'vencida';
                fechaVencimientoText = `Vencido hace ${Math.abs(diasRestantes)} d铆as`;
                cardClasses += ' recordatorio-vencido';
            } else if (tiempoRestante <= 24 * 60 * 60 * 1000) { // 24 horas
                fechaVencimientoClass = 'proxima';
                fechaVencimientoText = `Vence en ${Math.ceil(tiempoRestante / (1000 * 60 * 60))} horas`;
                cardClasses += ' recordatorio-proximo';
            }

            if (nota.estado === 'completado') {
                cardClasses += ' recordatorio-completado';
                fechaVencimientoText = 'Completado';
            }

            fechaVencimientoHTML = `
                <div class="fecha-vencimiento ${fechaVencimientoClass}">
                    <i class="fas fa-clock me-1"></i>
                    ${fechaVencimientoText}
                </div>
            `;

            estadoHTML = `
                <span class="estado-recordatorio ${nota.estado}">
                    ${nota.estado.charAt(0).toUpperCase() + nota.estado.slice(1)}
                </span>
            `;
        }

        return `
            <div class="${cardClasses}" data-nota-id="${nota.id}">
                <div class="nota-header">
                    <div class="d-flex align-items-center gap-2">
                        <span class="nota-tipo-badge ${nota.tipo}">
                            ${nota.tipo === 'nota' ? 'Nota' : 'Recordatorio'}
                        </span>
                        <span class="nota-prioridad-badge ${nota.prioridad.toLowerCase()}">
                            ${nota.prioridad}
                        </span>
                        ${estadoHTML}
                    </div>
                    <div class="nota-acciones">
                        <button class="btn-nota-accion editar" onclick="editarNota(${nota.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${nota.tipo === 'recordatorio' && nota.estado === 'pendiente' ? `
                            <button class="btn-nota-accion completar" onclick="completarRecordatorio(${nota.id})" title="Marcar como completado">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button class="btn-nota-accion eliminar" onclick="eliminarNota(${nota.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="nota-titulo">${nota.titulo}</div>
                <div class="nota-contenido">${nota.contenido}</div>
                <div class="nota-meta">
                    <div class="nota-fecha">
                        <i class="fas fa-user me-1"></i>
                        ${nota.usuario_nombre}
                        <span class="mx-2"></span>
                        <i class="fas fa-calendar me-1"></i>
                        ${fechaCreacion}
                    </div>
                    ${fechaVencimientoHTML}
                </div>
            </div>
        `;
    }

    function abrirModalNuevaNota() {
        document.getElementById('modalNotaTitulo').textContent = 'Nueva Nota/Recordatorio';
        document.getElementById('formNotaRecordatorio').reset();
        document.getElementById('notaId').value = '';
        document.getElementById('solicitudIdNota').value = currentSolicitudId;
        document.getElementById('recordatorioFields').style.display = 'none';
        
        const modal = new bootstrap.Modal(document.getElementById('modalNotaRecordatorio'));
        modal.show();
    }

    function editarNota(notaId) {
        fetch(`/workflow/api/notas-recordatorios/${currentSolicitudId}/${notaId}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('modalNotaTitulo').textContent = 'Editar Nota/Recordatorio';
            document.getElementById('notaId').value = data.nota.id;
            document.getElementById('solicitudIdNota').value = currentSolicitudId;
            document.getElementById('tipoNota').value = data.nota.tipo;
            document.getElementById('prioridadNota').value = data.nota.prioridad;
            document.getElementById('tituloNota').value = data.nota.titulo;
            document.getElementById('contenidoNota').value = data.nota.contenido;
            
            if (data.nota.tipo === 'recordatorio') {
                document.getElementById('recordatorioFields').style.display = 'flex';
                document.getElementById('fechaVencimiento').value = data.nota.fecha_vencimiento_local;
                document.getElementById('estadoRecordatorio').value = data.nota.estado;
            } else {
                document.getElementById('recordatorioFields').style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalNotaRecordatorio'));
            modal.show();
        })
        .catch(error => {
            console.error('Error cargando nota:', error);
            showNotification('Error al cargar nota: ' + error.message, 'error');
        });
    }

    function guardarNotaRecordatorio() {
        const form = document.getElementById('formNotaRecordatorio');
        const formData = new FormData(form);
        
        const notaId = formData.get('nota_id');
        const solicitudId = formData.get('solicitud_id');
        const tipo = formData.get('tipo');
        const prioridad = formData.get('prioridad');
        const titulo = formData.get('titulo');
        const contenido = formData.get('contenido');
        
        if (!titulo.trim() || !contenido.trim()) {
            showNotification('Por favor complete todos los campos requeridos', 'error');
            return;
        }
        
        const data = {
            tipo: tipo,
            prioridad: prioridad,
            titulo: titulo.trim(),
            contenido: contenido.trim()
        };
        
        if (tipo === 'recordatorio') {
            const fechaVencimiento = formData.get('fecha_vencimiento');
            const estado = formData.get('estado');
            
            if (!fechaVencimiento) {
                showNotification('Por favor seleccione una fecha de vencimiento', 'error');
                return;
            }
            
            data.fecha_vencimiento = fechaVencimiento;
            data.estado = estado;
        }
        
        const url = notaId ? 
            `/workflow/api/notas-recordatorios/${solicitudId}/${notaId}/actualizar/` :
            `/workflow/api/notas-recordatorios/${solicitudId}/crear/`;
        
        const method = notaId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            showNotification(data.message || 'Nota guardada exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalNotaRecordatorio'));
            modal.hide();
            cargarNotasRecordatorios();
        })
        .catch(error => {
            console.error('Error guardando nota:', error);
            showNotification('Error al guardar nota: ' + error.message, 'error');
        });
    }

    function completarRecordatorio(notaId) {
        if (!confirm('驴Est谩 seguro que desea marcar este recordatorio como completado?')) {
            return;
        }
        
        fetch(`/workflow/api/notas-recordatorios/${currentSolicitudId}/${notaId}/completar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            showNotification(data.message || 'Recordatorio marcado como completado', 'success');
            cargarNotasRecordatorios();
        })
        .catch(error => {
            console.error('Error completando recordatorio:', error);
            showNotification('Error al completar recordatorio: ' + error.message, 'error');
        });
    }

    function eliminarNota(notaId) {
        if (!confirm('驴Est谩 seguro que desea eliminar esta nota/recordatorio? Esta acci贸n no se puede deshacer.')) {
            return;
        }
        
        fetch(`/workflow/api/notas-recordatorios/${currentSolicitudId}/${notaId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            showNotification(data.message || 'Nota eliminada exitosamente', 'success');
            cargarNotasRecordatorios();
        })
        .catch(error => {
            console.error('Error eliminando nota:', error);
            showNotification('Error al eliminar nota: ' + error.message, 'error');
        });
    }

    function limpiarFiltrosNotas() {
        const filtroTipoEl = document.getElementById('filtroTipoNota');
        const filtroEstadoEl = document.getElementById('filtroEstadoNota');
        const filtroPrioridadEl = document.getElementById('filtroPrioridadNota');
        
        if (filtroTipoEl) filtroTipoEl.value = '';
        if (filtroEstadoEl) filtroEstadoEl.value = '';
        if (filtroPrioridadEl) filtroPrioridadEl.value = '';
        
        cargarNotasRecordatorios();
    }

    // Event listeners para filtros
    document.addEventListener('DOMContentLoaded', function() {
        const filtroTipo = document.getElementById('filtroTipoNota');
        const filtroEstado = document.getElementById('filtroEstadoNota');
        const filtroPrioridad = document.getElementById('filtroPrioridadNota');
        
        if (filtroTipo) {
            filtroTipo.addEventListener('change', cargarNotasRecordatorios);
        }
        if (filtroEstado) {
            filtroEstado.addEventListener('change', cargarNotasRecordatorios);
        }
        if (filtroPrioridad) {
            filtroPrioridad.addEventListener('change', cargarNotasRecordatorios);
        }
        
        // Event listener para cambio de tipo en el modal
        const tipoNota = document.getElementById('tipoNota');
        if (tipoNota) {
            tipoNota.addEventListener('change', function() {
                const recordatorioFields = document.getElementById('recordatorioFields');
                if (this.value === 'recordatorio') {
                    recordatorioFields.style.display = 'flex';
                    document.getElementById('fechaVencimiento').required = true;
                } else {
                    recordatorioFields.style.display = 'none';
                    document.getElementById('fechaVencimiento').required = false;
                }
            });
        }
    });

    // ===== RECONSIDERACIN FUNCTIONALITY =====

    // Function to check if solicitud can be reconsidered
    function puedeSerReconsiderada(solicitud) {
        if (!solicitud) {
            console.log(' No solicitud data provided');
            return { canRequest: false, reason: 'no_data', message: 'No hay datos de la solicitud' };
        }
        
        console.log(' Checking if solicitud can be reconsidered:', solicitud);
        
        // Check if solicitud is "Rechazado" or "Alternativa"
        const estadosReconsiderables = ['Rechazado', 'Alternativa'];
        
        // Use multiple fallback sources for estado
        const resultadoConsulta = solicitud.resultado_consulta || '';
        const subestadoActual = solicitud.subestado_actual || '';
        const estado = solicitud.estado || '';
        
        // Try to extract estado from subestado text (e.g., "Resultado Consulta - Rechazado" -> "Rechazado")
        let estadoExtraido = resultadoConsulta;
        if (!estadoExtraido && subestadoActual && subestadoActual.includes(' - ')) {
            estadoExtraido = subestadoActual.split(' - ').pop() || '';
        }
        if (!estadoExtraido) {
            estadoExtraido = estado;
        }
        
        console.log(' Estado Analysis:');
        console.log('   resultado_consulta:', resultadoConsulta);
        console.log('   subestado_actual:', subestadoActual);
        console.log('   estado:', estado);
        console.log('   estado_extraido:', estadoExtraido);
        console.log('   estados_reconsiderables:', estadosReconsiderables);
        
        const estadoEsReconsiderable = estadosReconsiderables.includes(estadoExtraido);
        console.log('   驴Estado es reconsiderable?:', estadoEsReconsiderable ? '' : '');
        
        // Check if user is the owner
        const propietarioId = solicitud.propietario_id || solicitud.propietario?.id;
        const currentUserId = parseInt(window.currentUserId || '0');
        const esProps = propietarioId === currentUserId;
        
        console.log(' Ownership Analysis:');
        console.log('   propietario_id:', propietarioId);
        console.log('   current_user_id:', currentUserId);
        console.log('   es_propietario:', esProps ? '' : '');
        
        // Check for active reconsideraci贸n
        const tieneReconsideracionActiva = solicitud.es_reconsideracion || false;
        console.log(' Reconsideraci贸n activa:', tieneReconsideracionActiva ? '' : '');
        
        // Determine result and reason
        let canRequest = false;
        let reason = '';
        let message = '';
        
        if (!estadoEsReconsiderable) {
            reason = 'estado_no_reconsiderable';
            message = `La solicitud debe estar en estado "Rechazado" o "Alternativa". Estado actual: "${estadoExtraido || 'No definido'}"`;
        } else if (!esProps) {
            reason = 'no_propietario';
            message = 'Solo el propietario de la solicitud puede solicitar una reconsideraci贸n';
        } else if (tieneReconsideracionActiva) {
            reason = 'reconsideracion_activa';
            message = 'Esta solicitud ya tiene una reconsideraci贸n en proceso';
        } else {
            canRequest = true;
            reason = 'puede_reconsiderar';
            message = 'Esta solicitud puede ser reconsiderada';
        }
        
        console.log(' Final Result:', canRequest ? ' PUEDE' : ' NO PUEDE');
        console.log(' Reason:', reason);
        console.log(' Message:', message);
        
        return { canRequest, reason, message, estadoExtraido };
    }

    // Function to load reconsideraciones history
    function cargarHistorialReconsideraciones(solicitudId) {
        // Validate solicitudId
        if (!solicitudId || solicitudId === 'undefined' || solicitudId === 'null') {
            console.error('Invalid solicitudId provided to cargarHistorialReconsideraciones:', solicitudId);
            return;
        }
        
        const container = document.getElementById('modalSolicitudReconsideraciones');
        if (!container) {
            console.error('Reconsideraciones container not found');
            return;
        }
        
        const loadingPlaceholder = container.querySelector('.loading-placeholder');
        const emptyState = container.querySelector('.empty-state');
        
        if (!loadingPlaceholder || !emptyState) {
            console.error('Loading placeholder or empty state not found');
            return;
        }
        
        // Show loading
        loadingPlaceholder.style.display = 'flex';
        emptyState.style.display = 'none';
        
        console.log('Fetching reconsideraciones for solicitud:', solicitudId);
        
        fetch(`/workflow/api/solicitud/${solicitudId}/reconsideracion/historial/`)
        .then(response => {
            console.log('Reconsideraciones API response status:', response.status);
            if (!response.ok) {
                throw new Error(`Error al cargar historial: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Reconsideraciones API data:', data);
            loadingPlaceholder.style.display = 'none';
            
            if (data.success && data.reconsideraciones && data.reconsideraciones.length > 0) {
                renderHistorialReconsideraciones(data.reconsideraciones);
            } else {
                emptyState.style.display = 'flex';
            }
        })
        .catch(error => {
            console.error('Error loading reconsideraciones:', error);
            loadingPlaceholder.style.display = 'none';
            emptyState.style.display = 'flex';
            emptyState.innerHTML = `
                <i class="fas fa-exclamation-triangle mb-3 text-warning" style="font-size: 3rem;"></i>
                <p class="text-muted">Error al cargar el historial de reconsideraciones</p>
                <small class="text-muted">${error.message}</small>
            `;
        });
    }

    // Function to render reconsideraciones history
    function renderHistorialReconsideraciones(reconsideraciones) {
        const container = document.getElementById('modalSolicitudReconsideraciones');
        const emptyState = container.querySelector('.empty-state');
        
        emptyState.style.display = 'none';
        
        const historialHtml = reconsideraciones.map(recon => {
            const estadoClass = `estado-${recon.estado}`;
            const itemClass = `reconsideracion-item ${recon.estado}`;
            
            return `
                <div class="${itemClass}">
                    <div class="reconsideracion-header">
                        <div>
                            <span class="reconsideracion-numero">Reconsideraci贸n #${recon.numero || recon.id}</span>
                            <span class="reconsideracion-fecha">${formatDateTime(recon.fecha_solicitud)}</span>
                        </div>
                        <span class="reconsideracion-estado ${estadoClass}">${getEstadoDisplayName(recon.estado)}</span>
                    </div>
                    
                    <div class="reconsideracion-motivo">
                        <strong>Motivo:</strong> ${recon.motivo || 'No especificado'}
                    </div>
                    
                    <div class="reconsideracion-details">
                        <div class="reconsideracion-detail-item">
                            <i class="fas fa-user"></i>
                            <span>Solicitado por: ${recon.solicitada_por?.nombre || 'N/A'}</span>
                        </div>
                        ${recon.cotizacion_nueva_id ? `
                        <div class="reconsideracion-detail-item">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Nueva cotizaci贸n: ${recon.cotizacion_nueva_id}</span>
                        </div>
                        ` : ''}
                        ${recon.fecha_analisis ? `
                        <div class="reconsideracion-detail-item">
                            <i class="fas fa-clock"></i>
                            <span>Analizado: ${formatDateTime(recon.fecha_analisis)}</span>
                        </div>
                        ` : ''}
                        ${recon.analizada_por?.nombre ? `
                        <div class="reconsideracion-detail-item">
                            <i class="fas fa-user-tie"></i>
                            <span>Analizado por: ${recon.analizada_por.nombre}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${recon.comentario_analisis ? `
                    <div class="reconsideracion-motivo">
                        <strong>Comentario del Analista:</strong> ${recon.comentario_analisis}
                    </div>
                    ` : ''}
                </div>
            `;
        }).join('');
        
        // Replace empty state with history
        emptyState.outerHTML = historialHtml;
    }

    // Function to get display name for estado
    function getEstadoDisplayName(estado) {
        const estados = {
            'enviada': 'Enviada',
            'en_revision': 'En Revisi贸n',
            'aprobada': 'Aprobada',
            'rechazada': 'Rechazada',
            'enviada_comite': 'Enviada a Comit茅'
        };
        return estados[estado] || estado;
    }

    // Function to format date and time
    function formatDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString('es-ES', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Function to show/hide reconsideracion tab and content
    function configurarTabReconsideracion(solicitud) {
        console.log(' Configurando tab de reconsideraci贸n con solicitud:', solicitud);
        
        const tabItem = document.getElementById('reconsideracion-tab-item');
        const btnSolicitar = document.getElementById('btnSolicitarReconsideracion');
        const statusDiv = document.getElementById('reconsideracionStatus');
        const statusText = document.getElementById('reconsideracionStatusText');
        
        if (!tabItem || !btnSolicitar || !statusDiv || !statusText) {
            console.error(' Reconsideraci贸n elements not found');
            return;
        }
        
        // Get the current solicitud ID from the global context
        const solicitudId = window.currentSolicitudId || window.currentModalSolicitudId;
        
        console.log(' Solicitud ID for reconsideraci贸n:', solicitudId);
        
        if (!solicitudId) {
            console.error(' No solicitud ID available for reconsideraci贸n');
            statusText.innerHTML = `
                <strong>Error de configuraci贸n:</strong><br>
                No se pudo identificar la solicitud actual.
            `;
            statusDiv.className = 'alert alert-danger';
            btnSolicitar.style.display = 'none';
            return;
        }
        
        // Use enhanced logic with detailed feedback
        const result = puedeSerReconsiderada(solicitud);
        const { canRequest, reason, message, estadoExtraido } = result;
        
        console.log(' Enhanced reconsideraci贸n result:', result);
        
        if (canRequest) {
            // Check if there's an active reconsideration in the solicitud data
            const tieneReconsideracionActiva = solicitud.es_reconsideracion || false;
            
            console.log(' Tiene reconsideraci贸n activa:', tieneReconsideracionActiva);
            
            if (tieneReconsideracionActiva) {
                statusText.innerHTML = `
                    <strong><i class="fas fa-hourglass-half"></i> Reconsideraci贸n en Proceso</strong><br>
                    Esta solicitud tiene una reconsideraci贸n actualmente en revisi贸n.
                `;
                statusDiv.className = 'alert alert-warning';
                btnSolicitar.style.display = 'none';
            } else {
                statusText.innerHTML = `
                    <strong><i class="fas fa-check-circle text-success"></i> Solicitud Elegible</strong><br>
                    Esta solicitud puede ser reconsiderada porque est谩 en estado "<strong>${estadoExtraido}</strong>" y usted es el propietario.
                    <br><small class="text-muted mt-1">
                        <i class="fas fa-info-circle"></i> 
                        Las reconsideraciones est谩n disponibles para solicitudes "Rechazadas" o con "Alternativa".
                    </small>
                `;
                statusDiv.className = 'alert alert-success';
                btnSolicitar.style.display = 'inline-block';
            }
        } else {
            // Provide specific feedback based on the reason
            let alertClass = 'alert alert-secondary';
            let iconClass = 'fas fa-info-circle';
            let detailedMessage = message;
            
            switch (reason) {
                case 'estado_no_reconsiderable':
                    alertClass = 'alert alert-info';
                    iconClass = 'fas fa-exclamation-triangle text-warning';
                    detailedMessage = `
                        <strong>Estado No Elegible</strong><br>
                        ${message}
                        <br><small class="text-muted mt-1">
                            <i class="fas fa-lightbulb"></i> 
                            Las reconsideraciones solo est谩n disponibles para solicitudes "Rechazadas" o con "Alternativa".
                        </small>
                    `;
                    break;
                    
                case 'no_propietario':
                    alertClass = 'alert alert-warning';
                    iconClass = 'fas fa-user-times text-warning';
                    detailedMessage = `
                        <strong><i class="fas fa-lock"></i> Permisos Insuficientes</strong><br>
                        ${message}
                        <br><small class="text-muted mt-1">
                            <i class="fas fa-info-circle"></i> 
                            Solo el oficial que cre贸 la solicitud puede solicitar una reconsideraci贸n.
                        </small>
                    `;
                    break;
                    
                case 'reconsideracion_activa':
                    alertClass = 'alert alert-warning';
                    iconClass = 'fas fa-hourglass-half text-warning';
                    detailedMessage = `
                        <strong>Reconsideraci贸n en Proceso</strong><br>
                        ${message}
                        <br><small class="text-muted mt-1">
                            <i class="fas fa-clock"></i> 
                            Debe esperar a que se complete la reconsideraci贸n actual antes de solicitar una nueva.
                        </small>
                    `;
                    break;
                    
                case 'no_data':
                    alertClass = 'alert alert-danger';
                    iconClass = 'fas fa-exclamation-triangle text-danger';
                    detailedMessage = `
                        <strong>Error de Datos</strong><br>
                        ${message}
                        <br><small class="text-muted mt-1">
                            <i class="fas fa-refresh"></i> 
                            Intente recargar la p谩gina o contacte al administrador.
                        </small>
                    `;
                    break;
                    
                default:
                    detailedMessage = `
                        <strong>No Disponible</strong><br>
                        ${message}
                    `;
            }
            
            statusText.innerHTML = detailedMessage;
            statusDiv.className = alertClass;
            btnSolicitar.style.display = 'none';
        }
        
        // Load history using the correct solicitud ID
        console.log(' Loading reconsideraciones history for solicitud:', solicitudId);
        cargarHistorialReconsideraciones(solicitudId);
    }

    // Function to request reconsideration
    function solicitarReconsideracion() {
        const solicitudId = window.currentModalSolicitudId;
        if (!solicitudId) {
            showNotification('Error: No se pudo identificar la solicitud', 'error');
            return;
        }
        
        // Redirect to reconsideration form
        window.location.href = `/workflow/solicitud/${solicitudId}/reconsideracion/solicitar/`;
    }

    // ===== COTIZACIONES FUNCTIONALITY =====

    /**
     * Show cotizaciones for the current cliente in the reconsideraci贸n modal
     */
    function mostrarCotizacionesClienteReconsideracion() {
        console.log(' mostrarCotizacionesClienteReconsideracion called');
        
        const modalElement = document.getElementById('modalReconsideracion');
        const solicitudId = modalElement?.dataset?.solicitudId;
        
        if (!solicitudId) {
            console.error(' No solicitud ID available in reconsideraci贸n modal');
            showNotification('Error: No se pudo identificar la solicitud', 'error');
            return;
        }

        const section = document.getElementById('cotizacionesClienteSectionReconsideracion');
        if (!section) {
            console.error(' Cotizaciones section not found in reconsideraci贸n modal');
            return;
        }

        // Show the section
        section.style.display = 'block';
        
        // Load cotizaciones
        cargarCotizacionesClienteReconsideracion(solicitudId);
    }

    /**
     * Hide cotizaciones section in reconsideraci贸n modal
     */
    function ocultarCotizacionesClienteReconsideracion() {
        console.log(' ocultarCotizacionesClienteReconsideracion called');
        
        const section = document.getElementById('cotizacionesClienteSectionReconsideracion');
        if (section) {
            section.style.display = 'none';
        }
    }

    /**
     * Load cotizaciones for the cliente in reconsideraci贸n modal
     */
    async function cargarCotizacionesClienteReconsideracion(solicitudId) {
        console.log(' cargarCotizacionesClienteReconsideracion called with solicitudId:', solicitudId);
        
        const container = document.getElementById('cotizacionesContainerReconsideracion');
        const loadingDiv = container?.querySelector('.loading-cotizaciones-reconsideracion');
        const emptyDiv = container?.querySelector('.empty-cotizaciones-reconsideracion');
        const gridDiv = document.getElementById('cotizacionesGridReconsideracion');

        if (!container || !loadingDiv || !emptyDiv || !gridDiv) {
            console.error(' Required cotizaciones elements not found in reconsideraci贸n modal');
            return;
        }

        // Show loading state
        loadingDiv.style.display = 'flex';
        emptyDiv.style.display = 'none';
        gridDiv.innerHTML = '';

        try {
            // Fetch cotizaciones from the API
            const response = await fetch(`/workflow/api/cotizaciones-cliente/${solicitudId}/`);
            const data = await response.json();

            console.log(' Cotizaciones API response for reconsideraci贸n:', data);

            // Add detailed debugging for the issue
            if (data.debug_info) {
                console.log(' DEBUG INFO:');
                console.log('  - Solicitud ID:', data.debug_info.solicitud_id);
                console.log('  - Total cotizaciones in DB:', data.debug_info.total_cotizaciones_db);
                console.log('  - Filtered count:', data.debug_info.filtered_count);
                console.log('  - Cliente cedula:', data.debug_info.cliente_cedula);
            }
            
            if (data.cotizaciones && data.cotizaciones.length > 0) {
                console.log(' Cotizaciones details:');
                data.cotizaciones.forEach((cot, index) => {
                    if (index < 3) { // Log first 3 cotizaciones
                        console.log(`  Cotizaci贸n ${index + 1}:`, {
                            id: cot.id,
                            cedula: cot.cedulaCliente,
                            cliente: cot.nombreCliente,
                            monto: cot.monto
                        });
                    }
                });
            }

            if (!response.ok) {
                throw new Error(data.message || 'Error al cargar cotizaciones');
            }

            // Hide loading
            loadingDiv.style.display = 'none';

            if (!data.cotizaciones || data.cotizaciones.length === 0) {
                // Show empty state
                emptyDiv.style.display = 'flex';
                return;
            }

            // Render cotizaciones
            renderCotizacionesReconsideracion(data.cotizaciones, gridDiv);

        } catch (error) {
            console.error(' Error loading cotizaciones for reconsideraci贸n:', error);
            loadingDiv.style.display = 'none';
            
            // Show error state
            gridDiv.innerHTML = `
                <div class="cotizacion-error">
                    <i class="fas fa-exclamation-triangle text-danger mb-2" style="font-size: 2rem;"></i>
                    <p class="text-danger mb-0">Error al cargar las cotizaciones</p>
                    <small class="text-muted">${error.message}</small>
                </div>
            `;
        }
    }

    /**
     * Render cotizaciones in the reconsideraci贸n modal grid
     */
    function renderCotizacionesReconsideracion(cotizaciones, gridDiv) {
        console.log(' renderCotizacionesReconsideracion called with', cotizaciones.length, 'cotizaciones');
        
        gridDiv.innerHTML = '';
        
        cotizaciones.forEach((cotizacion, index) => {
            const card = createCotizacionCardReconsideracion(cotizacion, index);
            gridDiv.appendChild(card);
        });
    }

    /**
     * Create a cotizacion card element for the reconsideraci贸n modal
     */
    function createCotizacionCardReconsideracion(cotizacion, index) {
        const card = document.createElement('div');
        card.className = 'cotizacion-card';
        card.dataset.cotizacionId = cotizacion.id;
        
        // Format date
        const fecha = cotizacion.fecha_creacion ? 
            new Date(cotizacion.fecha_creacion).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : 'N/A';

        // Format monto
        const monto = cotizacion.auxMonto2 || cotizacion.monto || 0;
        const montoFormateado = monto > 0 ? `$${Number(monto).toLocaleString('es-ES')}` : 'N/A';

        // Format tipo
        let tipoFormateado = 'Personal';
        if (cotizacion.tipoPrestamo === 'auto') {
            tipoFormateado = 'Auto';
        } else if (cotizacion.tipoPrestamo === 'personal') {
            tipoFormateado = 'Personal';
        }

        card.innerHTML = `
            <div class="cotizacion-header">
                <div class="cotizacion-numero">
                    <i class="fas fa-calculator me-1"></i>
                    Cotizaci贸n #${cotizacion.id || (index + 1)}
                </div>
                <span class="cotizacion-tipo">${tipoFormateado}</span>
            </div>
            
            <div class="cotizacion-details">
                <div class="cotizacion-detail">
                    <strong>Oficial</strong>
                    <span>${cotizacion.oficial || 'N/A'}</span>
                </div>
                <div class="cotizacion-detail">
                    <strong>Sucursal</strong>
                    <span>${cotizacion.sucursal || 'N/A'}</span>
                </div>
                <div class="cotizacion-detail">
                    <strong>Plazo</strong>
                    <span>${cotizacion.plazo ? `${cotizacion.plazo} meses` : 'N/A'}</span>
                </div>
                <div class="cotizacion-detail">
                    <strong>Tasa</strong>
                    <span>${cotizacion.tasa ? `${cotizacion.tasa}%` : 'N/A'}</span>
                </div>
                <div class="cotizacion-monto">
                    <strong>Monto: ${montoFormateado}</strong>
                </div>
            </div>
            
            <div class="cotizacion-actions">
                <span class="cotizacion-fecha">
                    <i class="fas fa-calendar me-1"></i>
                    ${fecha}
                </span>
                <div class="d-flex gap-1">
                    <button class="btn-ver-cotizacion" onclick="verDetalleCotizacion(${cotizacion.id})" title="Ver detalles">
                        <i class="fas fa-eye me-1"></i>Ver
                    </button>
                    <button class="btn-seleccionar-cotizacion" onclick="seleccionarCotizacionReconsideracion(${cotizacion.id})" title="Seleccionar para reconsideraci贸n">
                        <i class="fas fa-check me-1"></i>Seleccionar
                    </button>
                </div>
            </div>
        `;

        return card;
    }

    /**
     * Select a cotizacion for the reconsideraci贸n
     */
    function seleccionarCotizacionReconsideracion(cotizacionId) {
        console.log(' seleccionarCotizacionReconsideracion called with ID:', cotizacionId);
        
        // Mark cotizaci贸n nueva radio as selected
        const cotizacionNueva = document.getElementById('cotizacionNueva');
        if (cotizacionNueva) {
            cotizacionNueva.checked = true;
        }
        
        // Set the hidden field
        const nuevaCotizacionId = document.getElementById('nuevaCotizacionId');
        if (nuevaCotizacionId) {
            nuevaCotizacionId.value = cotizacionId;
        }
        
        // Visual feedback: highlight selected card
        const allCards = document.querySelectorAll('#cotizacionesGridReconsideracion .cotizacion-card');
        allCards.forEach(card => {
            card.classList.remove('selected');
        });
        
        const selectedCard = document.querySelector(`#cotizacionesGridReconsideracion .cotizacion-card[data-cotizacion-id="${cotizacionId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
        
        // Close the cotizaciones section
        ocultarCotizacionesClienteReconsideracion();
        
        // Show success message
        showNotification(`Cotizaci贸n #${cotizacionId} seleccionada para la reconsideraci贸n`, 'success');
        
        // Trigger validation if available
        if (typeof validarFormularioReconsideracion === 'function') {
            validarFormularioReconsideracion();
        }
    }

    /**
     * View cotizacion details
     */
    function verDetalleCotizacion(cotizacionId) {
        console.log('锔 verDetalleCotizacion called with ID:', cotizacionId);
        
        // Redirect to cotizacion detail page
        window.open(`/pacifico/cotizacion/${cotizacionId}/`, '_blank');
    }

    /**
     * Check if there are additional cotizaciones available and show/hide the nueva cotizaci贸n option
     */
    async function verificarCotizacionesDisponibles(solicitudId) {
        console.log(' verificarCotizacionesDisponibles called with solicitudId:', solicitudId);
        
        try {
            // Fetch cotizaciones from the API
            const response = await fetch(`/workflow/api/cotizaciones-cliente/${solicitudId}/`);
            const data = await response.json();

            console.log(' Cotizaciones verification response:', data);

            if (response.ok && data.cotizaciones && data.cotizaciones.length > 1) {
                // There are multiple cotizaciones available, show the nueva cotizaci贸n option
                const nuevaCotizacionOption = document.getElementById('nuevaCotizacionOption');
                if (nuevaCotizacionOption) {
                    nuevaCotizacionOption.style.display = 'block';
                    console.log(' Nueva cotizaci贸n option shown - found', data.cotizaciones.length, 'cotizaciones');
                }
            } else {
                // Only one or no additional cotizaciones, hide the option
                const nuevaCotizacionOption = document.getElementById('nuevaCotizacionOption');
                if (nuevaCotizacionOption) {
                    nuevaCotizacionOption.style.display = 'none';
                    console.log('癸 Nueva cotizaci贸n option hidden - only', data.cotizaciones?.length || 0, 'cotizaciones available');
                }
            }

        } catch (error) {
            console.error(' Error checking cotizaciones availability:', error);
            // Hide the option on error
            const nuevaCotizacionOption = document.getElementById('nuevaCotizacionOption');
            if (nuevaCotizacionOption) {
                nuevaCotizacionOption.style.display = 'none';
            }
        }
    }

    // Legacy functions for backward compatibility (now empty)
    function mostrarCotizacionesCliente() {
        console.log('锔 mostrarCotizacionesCliente called - this function is deprecated, use reconsideraci贸n modal instead');
    }

    function ocultarCotizacionesCliente() {
        console.log('锔 ocultarCotizacionesCliente called - this function is deprecated');
    }

    // === NEW MODAL RECONSIDERACIN FUNCTIONS ===
    function abrirModalReconsideracion(solicitudId) {
        console.log(' abrirModalReconsideracion called with solicitudId:', solicitudId);
        // Validate solicitudId
        if (!solicitudId) {
            console.error(' solicitudId is required for abrirModalReconsideracion');
            alert('Error: ID de solicitud requerido');
            return;
        }
        
        // Check if modal element exists
        const modalElement = document.getElementById('modalReconsideracion');
        if (!modalElement) {
            console.error(' modalReconsideracion element not found');
            alert('Error: Modal de reconsideraci贸n no encontrado');
            return;
        }
        
        try {
            // Show the modal
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // Store solicitud ID
            modalElement.dataset.solicitudId = solicitudId;
            
            console.log(' Modal opened, populating data...');
            
            // Populate current cotizaci贸n information
            populateCurrentCotizacionInfo();
            
            // Check if we should show the "nueva cotizaci贸n" option
            verificarCotizacionesDisponibles(solicitudId);
            
            // Ensure validation is triggered after modal is shown
            setTimeout(() => {
                if (typeof validarFormularioReconsideracion === 'function') {
                    console.log(' Triggering validation after modal is shown');
                    validarFormularioReconsideracion();
                }
            }, 100);
        } catch (error) {
            console.error(' Error opening reconsideraci贸n modal:', error);
            alert('Error al abrir el modal de reconsideraci贸n');
        }
    }

    function populateCurrentCotizacionInfo() {
        console.log(' populateCurrentCotizacionInfo called');
        
        // Get current modal data
        const currentData = window.currentModalData;
        if (!currentData) {
            console.error(' No current modal data available');
            // Try to get solicitudId from modal dataset
            const modalElement = document.getElementById('modalReconsideracion');
            const solicitudId = modalElement?.dataset?.solicitudId;
            if (solicitudId) {
                console.log(' Attempting to fetch data for solicitudId:', solicitudId);
                fetchAndPopulateCotizacionInfo(solicitudId);
            }
            return;
        }
        
        console.log('Current modal data:', currentData);
        
        // Get cotizaci贸n data
        const cotizacion = currentData.cotizacion || {};
        const general = currentData.general || {};
        
        console.log('Cotizaci贸n data:', cotizacion);
        
        // Get DOM elements
        const numeroActual = document.getElementById('numeroActual');
        const montoActual = document.getElementById('montoActual');
        const tipoActual = document.getElementById('tipoActual');
        const plazoActual = document.getElementById('plazoActual');
        
        // Check if elements exist
        if (!numeroActual || !montoActual || !tipoActual || !plazoActual) {
            console.error('Required cotizaci贸n elements not found');
            return;
        }
        
        // Populate the fields
        numeroActual.textContent = cotizacion.numero || cotizacion.id || general.codigo || 'N/A';
        
        // Also populate the solicitud code in the modal header
        const codigoSolicitudRecon = document.getElementById('codigoSolicitudRecon');
        if (codigoSolicitudRecon) {
            const modalElement = document.getElementById('modalReconsideracion');
            const solicitudId = modalElement?.dataset?.solicitudId;
            codigoSolicitudRecon.textContent = general.codigo || solicitudId || 'N/A';
        }
        
        // Format monto
        const monto = cotizacion.auxMonto2 || cotizacion.monto || 0;
        montoActual.textContent = monto > 0 ? `$${monto.toLocaleString()}` : 'N/A';
        
        // Format tipo
        const tipo = cotizacion.tipoPrestamo || cotizacion.tipo || 'N/A';
        tipoActual.textContent = tipo === 'auto' ? 'Pr茅stamo de Auto' : 
                                tipo === 'personal' ? 'Pr茅stamo Personal' : 
                                tipo || 'N/A';
        
        // Format plazo
        const plazo = cotizacion.plazo || 0;
        plazoActual.textContent = plazo > 0 ? `${plazo} meses` : 'N/A';
        
        console.log('Cotizaci贸n info populated:', {
            numero: numeroActual.textContent,
            monto: montoActual.textContent,
            tipo: tipoActual.textContent,
            plazo: plazoActual.textContent
        });
        
        // Set up radio button event listeners
        setupCotizacionOptionListeners();
        
        // Set up character counter for motivo textarea
        setupMotivoCharacterCounter();
        
        // Trigger validation after populating data
        setTimeout(() => {
            if (typeof validarFormularioReconsideracion === 'function') {
                console.log(' Triggering validation after populating cotizaci贸n info');
                validarFormularioReconsideracion();
            }
        }, 50);
    }

    function setupMotivoCharacterCounter() {
        const motivoTextarea = document.getElementById('motivoReconsideracion');
        const contadorElement = document.getElementById('contadorCaracteres');
        
        if (motivoTextarea && contadorElement) {
            motivoTextarea.addEventListener('input', function() {
                const currentLength = this.value.length;
                const maxLength = 2000;
                const minLength = 50;
                
                contadorElement.textContent = `${currentLength} / ${maxLength} caracteres (m铆nimo ${minLength})`;
                
                // Change color based on length
                if (currentLength < minLength) {
                    contadorElement.className = 'text-danger';
                    motivoTextarea.classList.add('is-invalid');
                    motivoTextarea.classList.remove('is-valid');
                } else if (currentLength > maxLength * 0.9) {
                    contadorElement.className = 'text-warning';
                    motivoTextarea.classList.remove('is-invalid', 'is-valid');
                } else {
                    contadorElement.className = 'text-muted';
                    motivoTextarea.classList.remove('is-invalid');
                    motivoTextarea.classList.add('is-valid');
                }
                
                // Trigger validation check
                if (typeof validarFormularioReconsideracion === 'function') {
                    validarFormularioReconsideracion();
                }
            });
            
            // Trigger initial count
            motivoTextarea.dispatchEvent(new Event('input'));
        }
    }

    function setupCotizacionOptionListeners() {
        const cotizacionActual = document.getElementById('cotizacionActual');
        const cotizacionNueva = document.getElementById('cotizacionNueva');
        const cotizacionesDisponibles = document.getElementById('cotizacionesDisponibles');
        
        console.log(' Setting up cotizaci贸n option listeners:', {
            cotizacionActual: !!cotizacionActual,
            cotizacionNueva: !!cotizacionNueva,
            cotizacionesDisponibles: !!cotizacionesDisponibles
        });
        
        if (cotizacionActual && cotizacionNueva && cotizacionesDisponibles) {
            cotizacionActual.addEventListener('change', function() {
                console.log(' Cotizaci贸n actual changed, checked:', this.checked);
                if (this.checked) {
                    cotizacionesDisponibles.style.display = 'none';
                    // Clear any previously selected nueva cotizaci贸n
                    const nuevaCotizacionIdField = document.getElementById('nuevaCotizacionId');
                    if (nuevaCotizacionIdField) {
                        nuevaCotizacionIdField.value = '';
                    }
                    // Trigger validation
                    if (typeof validarFormularioReconsideracion === 'function') {
                        validarFormularioReconsideracion();
                    }
                }
            });
            
            cotizacionNueva.addEventListener('change', function() {
                console.log(' Cotizaci贸n nueva changed, checked:', this.checked);
                if (this.checked) {
                    cotizacionesDisponibles.style.display = 'block';
                    // Trigger validation
                    if (typeof validarFormularioReconsideracion === 'function') {
                        validarFormularioReconsideracion();
                    }
                }
            });
            
            // Log initial state
            console.log(' Initial radio button states:', {
                cotizacionActualChecked: cotizacionActual.checked,
                cotizacionNuevaChecked: cotizacionNueva.checked
            });
        } else {
            console.error(' Required elements not found for setupCotizacionOptionListeners');
        }
    }

    async function fetchAndPopulateCotizacionInfo(solicitudId) {
        console.log('fetchAndPopulateCotizacionInfo called with solicitudId:', solicitudId);
        
        try {
            const response = await fetch(`/workflow/api/solicitud_brief/${solicitudId}/`);
            const data = await response.json();
            
            if (data && data.cotizacion) {
                // Temporarily set the current modal data
                window.currentModalData = data;
                
                // Populate the cotizaci贸n info
                populateCurrentCotizacionInfo();
            } else {
                console.error('No cotizaci贸n data found in API response');
            }
        } catch (error) {
            console.error('Error fetching cotizaci贸n data:', error);
        }
    }

    async function cargarCotizacionesCliente(solicitudId) {
        console.log('cargarCotizacionesCliente called with solicitudId:', solicitudId);
        
        const contenedor = document.getElementById('cotizacionesContainer');
        const loadingElement = document.getElementById('loadingCotizaciones');
        const noCotizacionesElement = document.getElementById('noCotizaciones');
        
        // Check if elements exist before proceeding
        if (!contenedor || !loadingElement || !noCotizacionesElement) {
            console.error('Required elements not found for cargarCotizacionesCliente:', {
                contenedor: !!contenedor,
                loadingElement: !!loadingElement,
                noCotizacionesElement: !!noCotizacionesElement
            });
            return;
        }
        
        // Show loading
        loadingElement.style.display = 'block';
        contenedor.style.display = 'none';
        noCotizacionesElement.style.display = 'none';
        
        try {
            const response = await fetch(`/workflow/api/cotizaciones-cliente/${solicitudId}/`);
            const data = await response.json();
            
            if (data.success && data.cotizaciones && data.cotizaciones.length > 0) {
                mostrarCotizaciones(data.cotizaciones);
                contenedor.style.display = 'block';
            } else {
                noCotizacionesElement.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading cotizaciones:', error);
            noCotizacionesElement.style.display = 'block';
        } finally {
            loadingElement.style.display = 'none';
        }
    }

    function mostrarCotizaciones(cotizaciones) {
        const contenedor = document.getElementById('cotizacionesContainer');
        
        // Check if container exists
        if (!contenedor) {
            console.error('cotizacionesContainer element not found');
            return;
        }
        
        contenedor.innerHTML = '';
        
        if (!Array.isArray(cotizaciones)) {
            console.error('cotizaciones is not an array:', cotizaciones);
            return;
        }
        
        cotizaciones.forEach(cotizacion => {
            const div = document.createElement('div');
            div.className = 'cotizacion-option';
            div.innerHTML = `
                <label class="d-flex align-items-center cursor-pointer w-100">
                    <input type="radio" name="cotizacion_id" value="${cotizacion.id || ''}" class="me-3">
                    <div class="cotizacion-info flex-grow-1">
                        <div class="cotizacion-monto">$${(cotizacion.monto || 0).toLocaleString()}</div>
                        <div class="cotizacion-fecha">
                            <i class="fas fa-calendar-alt me-1"></i>
                            ${cotizacion.fecha_creacion ? new Date(cotizacion.fecha_creacion).toLocaleDateString() : 'N/A'}
                        </div>
                        <div class="cotizacion-cliente">
                            <i class="fas fa-user me-1"></i>
                            ${cotizacion.cliente_nombre || 'Cliente no especificado'}
                        </div>
                    </div>
                </label>
            `;
            contenedor.appendChild(div);
        });
        
        // Enable form validation
        validarFormularioReconsideracion();
    }

    function validarFormularioReconsideracion() {
        const cotizacionActualRadio = document.getElementById('cotizacionActual');
        const cotizacionNuevaRadio = document.getElementById('cotizacionNueva');
        const motivoTextarea = document.getElementById('motivoReconsideracion');
        const submitBtn = document.getElementById('btnEnviarReconsideracion');
        
        // Check if required elements exist
        if (!motivoTextarea || !submitBtn) {
            console.error('Required form elements not found for validation');
            return;
        }
        
        function checkValidation() {
            const motivoFilled = motivoTextarea.value.trim().length > 0; // Just require non-empty text
            
            // Check cotizaci贸n selection
            let cotizacionSelected = false;
            
            if (cotizacionActualRadio && cotizacionActualRadio.checked) {
                // If "Usar cotizaci贸n actual" is selected, that's valid
                cotizacionSelected = true;
                console.log(' Cotizaci贸n actual seleccionada');
            } else if (cotizacionNuevaRadio && cotizacionNuevaRadio.checked) {
                // If "Usar una cotizaci贸n diferente" is selected, check if a cotizaci贸n has been selected
                const nuevaCotizacionIdField = document.getElementById('nuevaCotizacionId');
                cotizacionSelected = nuevaCotizacionIdField && nuevaCotizacionIdField.value;
                console.log(' Cotizaci贸n nueva seleccionada, nueva cotizaci贸n ID:', nuevaCotizacionIdField?.value);
            } else {
                console.log(' Ninguna opci贸n de cotizaci贸n seleccionada');
            }
            
            const isValid = cotizacionSelected && motivoFilled;
            submitBtn.disabled = !isValid;
            
            // Update button styling based on validation
            if (isValid) {
                submitBtn.classList.remove('btn-secondary');
                submitBtn.classList.add('btn-warning');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Enviar Reconsideraci贸n';
            } else {
                submitBtn.classList.remove('btn-warning');
                submitBtn.classList.add('btn-secondary');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Enviar Reconsideraci贸n';
            }
            
            console.log('Validation check:', {
                cotizacionSelected,
                motivoFilled,
                motivoLength: motivoTextarea.value.trim().length,
                isValid,
                submitBtnDisabled: submitBtn.disabled,
                cotizacionActualChecked: cotizacionActualRadio?.checked,
                cotizacionNuevaChecked: cotizacionNuevaRadio?.checked
            });
        }
        
        // Add event listeners for cotizaci贸n options
        if (cotizacionActualRadio) {
            cotizacionActualRadio.addEventListener('change', checkValidation);
        }
        if (cotizacionNuevaRadio) {
            cotizacionNuevaRadio.addEventListener('change', checkValidation);
        }
        
        // Add event listener for nueva cotizaci贸n ID field changes
        const nuevaCotizacionIdField = document.getElementById('nuevaCotizacionId');
        if (nuevaCotizacionIdField) {
            nuevaCotizacionIdField.addEventListener('change', checkValidation);
        }
        
        // Add event listener for motivo textarea
        motivoTextarea.addEventListener('input', checkValidation);
        
        // Initial check
        checkValidation();
    }

    async function enviarReconsideracion() {
        const modal = document.getElementById('modalReconsideracion');
        const motivoTextarea = document.getElementById('motivoReconsideracion');
        const submitBtn = document.getElementById('btnEnviarReconsideracion');
        
        // Check if required elements exist
        if (!modal || !motivoTextarea || !submitBtn) {
            console.error('Required elements not found for enviarReconsideracion');
            alert('Error: Elementos del formulario no encontrados');
            return;
        }
        
        const solicitudId = modal.dataset.solicitudId;
        if (!solicitudId) {
            console.error('solicitudId not found in modal dataset');
            alert('Error: ID de solicitud no encontrado');
            return;
        }
        
        // Check which cotizaci贸n option is selected
        const cotizacionActualSelected = document.getElementById('cotizacionActual')?.checked;
        const cotizacionNuevaSelected = document.getElementById('cotizacionNueva')?.checked;
        
        console.log(' Enviar reconsideraci贸n - Opciones seleccionadas:', {
            cotizacionActualSelected,
            cotizacionNuevaSelected
        });
        
        let cotizacionId = null;
        
        if (cotizacionActualSelected) {
            // Use current cotizaci贸n - get from modal data or hidden field
            const currentData = window.currentModalData;
            if (currentData && currentData.cotizacion) {
                cotizacionId = currentData.cotizacion.id || currentData.cotizacion.numero;
                console.log(' Usando cotizaci贸n actual desde modal data:', cotizacionId);
            } else {
                // Fallback: try to get from a hidden field or use a special value
                cotizacionId = 'actual'; // Backend will understand this means use current cotizaci贸n
                console.log(' Usando cotizaci贸n actual (fallback):', cotizacionId);
            }
        } else if (cotizacionNuevaSelected) {
            // Use selected cotizaci贸n from the nueva cotizaci贸n hidden field
            const nuevaCotizacionIdField = document.getElementById('nuevaCotizacionId');
            if (nuevaCotizacionIdField && nuevaCotizacionIdField.value) {
                cotizacionId = nuevaCotizacionIdField.value;
                console.log(' Usando cotizaci贸n nueva seleccionada:', cotizacionId);
            } else {
                console.error(' Nueva cotizaci贸n seleccionada pero no se encontr贸 ID');
                showAlert('Por favor, selecciona una cotizaci贸n espec铆fica de la lista.', 'warning');
                return;
            }
        } else {
            console.error(' No se seleccion贸 ninguna opci贸n de cotizaci贸n');
            showAlert('Por favor, selecciona una opci贸n de cotizaci贸n.', 'warning');
            return;
        }
        
        // Validate motivo
        if (!motivoTextarea.value.trim()) {
            showAlert('Por favor, proporciona un motivo para la reconsideraci贸n.', 'warning');
            return;
        }
        
        if (!cotizacionId) {
            showAlert('Por favor, selecciona una cotizaci贸n.', 'warning');
            return;
        }
        
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        
        const formData = new FormData();
        formData.append('cotizacion_id', cotizacionId);
        formData.append('motivo', motivoTextarea.value.trim());
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        try {
            const response = await fetch(`/workflow/solicitud/${solicitudId}/reconsideracion/solicitar/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Reconsideraci贸n enviada exitosamente', 'success');
                
                // Close modal
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                
                // Reset form
                resetFormularioReconsideracion();
                
                // Refresh solicitud data
                if (typeof cargarDatosSolicitud === 'function') {
                    cargarDatosSolicitud(solicitudId);
                }
                
            } else {
                showAlert(data.message || 'Error al enviar la reconsideraci贸n', 'danger');
            }
            
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error de conexi贸n. Intenta nuevamente.', 'danger');
        } finally {
            // Restore button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Reconsideraci贸n';
        }
    }

    function resetFormularioReconsideracion() {
        // Clear cotizaci贸n selection
        const cotizacionRadios = document.querySelectorAll('input[name="cotizacion_id"]');
        cotizacionRadios.forEach(radio => radio.checked = false);
        
        // Clear motivo
        const motivoTextarea = document.getElementById('motivoReconsideracion');
        if (motivoTextarea) {
            motivoTextarea.value = '';
        }
        
        // Disable submit button
        const submitBtn = document.getElementById('btnEnviarReconsideracion');
        if (submitBtn) {
            submitBtn.disabled = true;
        }
        
        // Hide containers with null checks
        const contenedor = document.getElementById('cotizacionesContainer');
        const loading = document.getElementById('loadingCotizaciones');
        const noCotizaciones = document.getElementById('noCotizaciones');
        
        if (contenedor) contenedor.style.display = 'none';
        if (loading) loading.style.display = 'none';
        if (noCotizaciones) noCotizaciones.style.display = 'none';
    }

    // Simple alert function if not already defined
    function showAlert(message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'warning' ? 'alert-warning' : 
                          type === 'danger' ? 'alert-danger' : 'alert-info';
        
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        // Try to find a container to show the alert
        const modalBody = document.querySelector('#modalReconsideracion .modal-body');
        if (modalBody) {
            const alertDiv = document.createElement('div');
            alertDiv.innerHTML = alertHtml;
            modalBody.insertBefore(alertDiv.firstElementChild, modalBody.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alertElement = modalBody.querySelector('.alert');
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        } else {
            // Fallback to browser alert
            alert(message);
        }
    }

    // Make functions available globally
    window.solicitarReconsideracion = solicitarReconsideracion;
    window.configurarTabReconsideracion = configurarTabReconsideracion;
    window.cargarHistorialReconsideraciones = cargarHistorialReconsideraciones;
    window.abrirModalReconsideracion = abrirModalReconsideracion;
    window.enviarReconsideracion = enviarReconsideracion;
    window.populateCurrentCotizacionInfo = populateCurrentCotizacionInfo;
    window.fetchAndPopulateCotizacionInfo = fetchAndPopulateCotizacionInfo;
    window.setupCotizacionOptionListeners = setupCotizacionOptionListeners;
    window.setupMotivoCharacterCounter = setupMotivoCharacterCounter;
    window.validarFormularioReconsideracion = validarFormularioReconsideracion;
    window.showAlert = showAlert;
</script>

<!-- Modal para Crear/Editar Nota o Recordatorio -->
<div class="modal fade" id="modalNotaRecordatorio" tabindex="-1" aria-labelledby="modalNotaRecordatorioLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNotaRecordatorioLabel">
                    <i class="fas fa-sticky-note me-2"></i>
                    <span id="modalNotaTitulo">Nueva Nota/Recordatorio</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNotaRecordatorio">
                    <input type="hidden" id="notaId" name="nota_id">
                    <input type="hidden" id="solicitudIdNota" name="solicitud_id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="tipoNota" class="form-label">Tipo *</label>
                            <select class="form-select" id="tipoNota" name="tipo" required>
                                <option value="nota">Nota</option>
                                <option value="recordatorio">Recordatorio</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="prioridadNota" class="form-label">Prioridad</label>
                            <select class="form-select" id="prioridadNota" name="prioridad">
                                <option value="Baja">Baja</option>
                                <option value="Media" selected>Media</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tituloNota" class="form-label">T铆tulo *</label>
                        <input type="text" class="form-control" id="tituloNota" name="titulo" required maxlength="200">
                    </div>
                    
                    <div class="mb-3">
                        <label for="contenidoNota" class="form-label">Contenido *</label>
                        <textarea class="form-control" id="contenidoNota" name="contenido" rows="4" required></textarea>
                    </div>
                    
                    <div class="row mb-3" id="recordatorioFields" style="display: none;">
                        <div class="col-md-6">
                            <label for="fechaVencimiento" class="form-label">Fecha de Vencimiento *</label>
                            <input type="datetime-local" class="form-control" id="fechaVencimiento" name="fecha_vencimiento">
                        </div>
                        <div class="col-md-6">
                            <label for="estadoRecordatorio" class="form-label">Estado</label>
                            <select class="form-select" id="estadoRecordatorio" name="estado">
                                <option value="pendiente" selected>Pendiente</option>
                                <option value="completado">Completado</option>
                                <option value="vencido">Vencido</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarNotaRecordatorio()">
                    <i class="fas fa-save me-1"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Solicitar Reconsideraci贸n -->
<div class="modal fade" id="modalReconsideracion" tabindex="-1" aria-labelledby="modalReconsideracionLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modern-modal-reconsideracion">
            <div class="modal-header-modern-reconsideracion">
                <div class="header-content">
                    <div class="reconsideracion-header-info">
                        <div class="reconsideracion-title-section">
                            <h5 class="modal-title mb-0" id="modalReconsideracionLabel">
                                <i class="fas fa-redo-alt me-2"></i>
                                Solicitar Reconsideraci贸n
                            </h5>
                            <small class="reconsideracion-subtitle" id="solicitudReconsideracionInfo">
                                Solicitud: <span id="codigoSolicitudRecon" class="fw-semibold"></span>
                            </small>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button type="button" class="btn-close-modern" data-bs-dismiss="modal" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-body-modern-reconsideracion">
                <!-- Instructions Section -->
                <div class="instructions-section">
                    <div class="instructions-content">
                        <div class="instructions-header">
                            <i class="fas fa-lightbulb instructions-icon"></i>
                            <h6 class="instructions-title">
                                Instrucciones para Solicitar Reconsideraci贸n
                            </h6>
                        </div>
                        <div class="instructions-grid">
                            <div class="instructions-column">
                                <ul class="instructions-list">
                                    <li><strong>Motivo:</strong> Explique detalladamente por qu茅 solicita la reconsideraci贸n</li>
                                    <li><strong>Cotizaci贸n:</strong> Seleccione si usar la cotizaci贸n actual o una diferente</li>
                                    <li><strong>Revisi贸n:</strong> Su solicitud ser谩 revisada por el comit茅 correspondiente</li>
                                </ul>
                            </div>
                            <div class="instructions-column">
                                <ul class="instructions-list">
                                    <li><strong>Tiempo:</strong> El proceso puede tomar 2-3 d铆as h谩biles</li>
                                    <li><strong>Notificaci贸n:</strong> Recibir谩 una notificaci贸n del resultado</li>
                                    <li><strong>Historial:</strong> Puede consultar el estado en la pesta帽a "Reconsideraci贸n"</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mostrar resultado anterior -->
                <div class="resultado-anterior-section" id="resultadoAnterior">
                    <div class="resultado-anterior-content">
                        <i class="fas fa-exclamation-triangle resultado-icon"></i>
                        <div class="resultado-text">
                            <strong>Resultado anterior:</strong>
                            <span id="resultadoAnteriorTexto"></span>
                        </div>
                    </div>
                </div>
                
                <form id="formReconsideracion" class="reconsideracion-form">
                    <div class="form-section">
                        <label for="motivoReconsideracion" class="form-label-modern">
                            <i class="fas fa-comment-dots me-2"></i>
                            Motivo de la Reconsideraci贸n <span class="required-mark">*</span>
                        </label>
                        <textarea 
                            class="form-control-modern" 
                            id="motivoReconsideracion" 
                            name="motivo" 
                            rows="4" 
                            required 
                            placeholder="Explique detalladamente por qu茅 solicita esta reconsideraci贸n"
                            maxlength="2000"></textarea>
                        <div class="form-helper-text">
                            <small id="contadorCaracteres" class="character-counter">0 / 2000 caracteres</small>
                        </div>
                    </div>
                    
                    <!-- Selecci贸n de cotizaci贸n -->
                    <div class="form-section">
                        <h6 class="section-title-modern">
                            <i class="fas fa-file-invoice-dollar me-2"></i>
                            Cotizaci贸n a Utilizar
                        </h6>
                        
                        <div class="cotizacion-options">
                            <div class="cotizacion-option-item">
                                <input class="form-check-input-modern" type="radio" name="cotizacion_opcion" id="cotizacionActual" value="actual" checked>
                                <label class="form-check-label-modern" for="cotizacionActual">
                                    <strong>Usar cotizaci贸n actual</strong>
                                </label>
                            </div>
                            
                            <!-- Cotizaci贸n actual -->
                            <div class="cotizacion-current-card" id="cotizacionActualCard">
                                <div class="cotizacion-current-content">
                                    <div class="cotizacion-current-grid">
                                        <div class="cotizacion-current-item">
                                            <small class="cotizacion-current-label">N煤mero de Cotizaci贸n:</small>
                                            <div class="cotizacion-current-value" id="numeroActual">-</div>
                                        </div>
                                        <div class="cotizacion-current-item">
                                            <small class="cotizacion-current-label">Monto:</small>
                                            <div class="cotizacion-current-value" id="montoActual">-</div>
                                        </div>
                                        <div class="cotizacion-current-item">
                                            <small class="cotizacion-current-label">Tipo:</small>
                                            <div class="cotizacion-current-value" id="tipoActual">-</div>
                                        </div>
                                        <div class="cotizacion-current-item">
                                            <small class="cotizacion-current-label">Plazo:</small>
                                            <div class="cotizacion-current-value" id="plazoActual">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="cotizacion-option-item" id="nuevaCotizacionOption" style="display: none;">
                                <input class="form-check-input-modern" type="radio" name="cotizacion_opcion" id="cotizacionNueva" value="nueva">
                                <label class="form-check-label-modern" for="cotizacionNueva">
                                    <strong>Usar una cotizaci贸n diferente</strong>
                                </label>
                            </div>
                        
                        <!-- Cotizaciones disponibles -->
                        <div id="cotizacionesDisponibles" class="cotizaciones-disponibles-section" style="display: none;">
                            <h6 class="cotizaciones-disponibles-title">Seleccione una cotizaci贸n:</h6>
                            
                            <!-- Button to show all cotizaciones -->
                            <div class="cotizaciones-action-section">
                                <button type="button" class="btn-cotizaciones" id="btnVerCotizacionesReconsideracion" onclick="mostrarCotizacionesClienteReconsideracion()" title="Ver todas las cotizaciones del cliente">
                                    <i class="fas fa-calculator me-2"></i>Ver Todas las Cotizaciones del Cliente
                                </button>
                            </div>
                            
                            <!-- Cotizaciones del Cliente Section -->
                            <div class="cotizaciones-cliente-section-reconsideracion" id="cotizacionesClienteSectionReconsideracion" style="display: none;">
                                <div class="cotizaciones-header-reconsideracion">
                                    <h6 class="cotizaciones-title-reconsideracion">
                                        <i class="fas fa-calculator me-2"></i>
                                        Cotizaciones Disponibles del Cliente
                                    </h6>
                                    <button class="btn-close-cotizaciones-reconsideracion" onclick="ocultarCotizacionesClienteReconsideracion()" title="Cerrar">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="cotizaciones-container-reconsideracion" id="cotizacionesContainerReconsideracion">
                                    <div class="loading-cotizaciones-reconsideracion" style="display: none;">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Cargando cotizaciones...</span>
                                        </div>
                                        <span class="ms-2">Cargando cotizaciones del cliente...</span>
                                    </div>
                                    <div class="empty-cotizaciones-reconsideracion" style="display: none;">
                                        <i class="fas fa-calculator text-muted mb-2" style="font-size: 2rem;"></i>
                                        <p class="text-muted mb-0">No se encontraron cotizaciones para este cliente</p>
                                    </div>
                                    <div class="cotizaciones-grid-reconsideracion" id="cotizacionesGridReconsideracion">
                                        <!-- Cotizaciones will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Loading state -->
                            <div id="loadingCotizaciones" class="loading-state" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Cargando cotizaciones...</span>
                                </div>
                                <div class="loading-text">Cargando cotizaciones disponibles...</div>
                            </div>
                            
                            <!-- No cotizaciones state -->
                            <div id="noCotizaciones" class="empty-state" style="display: none;">
                                <i class="fas fa-file-invoice-dollar empty-icon"></i>
                                <div class="empty-text">No hay cotizaciones adicionales disponibles</div>
                            </div>
                            
                            <!-- Cotizaciones container -->
                            <div id="cotizacionesContainer" class="cotizaciones-legacy-container" style="display: none;">
                                <!-- Las cotizaciones se cargar谩n din谩micamente aqu铆 -->
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" name="solicitud_id" id="solicitudIdReconsideracion">
                    <input type="hidden" name="nueva_cotizacion_id" id="nuevaCotizacionId">
                </form>
            </div>
            <div class="modal-footer-modern">
                <div class="footer-actions">
                    <button type="button" class="btn-cancel-modern" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn-submit-modern" id="btnEnviarReconsideracion" onclick="enviarReconsideracion()">
                        <i class="fas fa-paper-plane me-2"></i>Enviar Reconsideraci贸n
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Asociar Entrevista -->
<div class="modal fade" id="modalAsociarEntrevista" tabindex="-1" aria-labelledby="modalAsociarEntrevistaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-white border-b p-4 sticky-top shadow-sm">
        <div>
          <h5 class="modal-title text-lg font-medium mb-2" id="modalAsociarEntrevistaLabel">
            <i class="fas fa-user-edit me-2 text-blue-600"></i>Asociar Entrevista de Cliente
          </h5>
          <div class="flex flex-col bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
            <div class="text-gray-800 mb-1">
              <i class="fas fa-user me-1 text-blue-600"></i>
              <strong>Cliente:</strong> <span id="clienteNombreModal" class="font-semibold ml-1">Cargando...</span>
            </div>
            <div class="text-gray-800">
              <i class="fas fa-id-card me-1 text-blue-600"></i>
              <strong>C茅dula:</strong> <span id="clienteCedulaModal" class="font-mono font-semibold ml-1">Cargando...</span>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4" style="max-height: 60vh; overflow-y: auto;">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 sticky top-0 z-10">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-shield-alt text-yellow-400"></i>
            </div>
            <div class="ml-3">
              <div class="d-flex align-items-center">
                <p class="text-sm text-yellow-700 mb-0">
                  <strong>Seguridad:</strong> Por seguridad, solo puede seleccionar entrevistas con coincidencia exacta o parcial de c茅dula.
                  <button type="button" class="btn btn-link text-yellow-700 p-0 ml-1" onclick="mostrarInfoCoincidencias()">
                    <i class="fas fa-info-circle"></i>
                  </button>
                </p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-4 sticky top-20 z-10 pt-2 pb-2 bg-white">
          <label for="buscarEntrevista" class="block text-sm font-medium text-gray-700 mb-1">Buscar Entrevista</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-gray-400"></i>
            </div>
            <input type="text" class="form-control pl-10" id="buscarEntrevista" 
                   placeholder="Refinar b煤squeda por nombre o email (opcional)..."
                   onkeyup="buscarEntrevistas()">
          </div>
          <div class="text-xs text-gray-500 mt-1">
            <i class="fas fa-filter me-1"></i>Ya filtrado por c茅dula: <span id="filteredByCedula" class="font-mono">Cargando...</span>
          </div>
        </div>
        
        <div id="resultadosEntrevistas" class="mt-4 transition-all duration-300">
          <!-- Aqu铆 se cargar谩n los resultados -->
        </div>
        
        <div id="entrevistaSeleccionada" class="mt-4 p-4 border-2 border-green-500 rounded-md bg-green-50 shadow-sm transition-all duration-300" style="display: none;">
          <div class="flex items-center mb-2">
            <div class="flex-shrink-0">
              <i class="fas fa-check-circle text-green-500 text-xl"></i>
            </div>
            <div class="ml-3">
              <div class="mb-1">
                <strong class="text-gray-700">Entrevista seleccionada:</strong>
                <span id="nombreEntrevistaSeleccionada" class="font-medium"></span>
              </div>
              <div class="text-sm">
                <strong class="text-gray-700">C茅dula:</strong>
                <span id="cedulaEntrevistaSeleccionada" class="font-mono font-medium"></span>
                <span class="inline-flex items-center ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  <i class="fas fa-shield-alt mr-1"></i>Verificada
                </span>
              </div>
            </div>
          </div>
          <div class="bg-white p-3 rounded-md border border-gray-200 mt-2 text-sm">
            <p class="text-gray-700 mb-0">
              <i class="fas fa-info-circle text-blue-600 mr-1"></i>
              Esta acci贸n vincular谩 los datos de la entrevista seleccionada con la solicitud actual.
              <br>Solo se asocian entrevistas del mismo cliente por motivos de seguridad.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-gray-50 p-3 sticky-bottom shadow-sm">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Cancelar
        </button>
        <button type="button" class="btn btn-success" id="btnConfirmarAsociacion" onclick="confirmarAsociacion()" disabled>
          <i class="fas fa-link me-1"></i> Confirmar Asociaci贸n
        </button>
            </div>
        </div>
    </div>
</div>