{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}Reportes y Analítica - {{ block.super }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
<style>
    :root {
        --verde-pacifico: #009c3c;
        --verde-hover: #007529;
        --verde-oscuro: #00692b;
        --verde-claro: #22a650;
        --verde-muy-oscuro: #004d33;
        --primary-gradient: linear-gradient(135deg, var(--verde-pacifico) 0%, var(--verde-claro) 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        --info-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --shadow-heavy: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --border-radius: 12px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .reportes-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .reportes-header {
        margin-bottom: 2rem;
        padding: 0 0 2rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .reportes-title {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.025em;
    }

    .reportes-subtitle {
        color: #6b7280;
        font-size: 1.1rem;
        margin-top: 0.5rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-light);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        box-shadow: var(--shadow-medium);
        transform: translateY(-2px);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
    }

    .stat-card.success::before {
        background: var(--success-gradient);
    }

    .stat-card.warning::before {
        background: var(--warning-gradient);
    }

    .stat-card.danger::before {
        background: var(--danger-gradient);
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        background: var(--primary-gradient);
    }

    .stat-icon.success {
        background: var(--success-gradient);
    }

    .stat-icon.warning {
        background: var(--warning-gradient);
    }

    .stat-icon.danger {
        background: var(--danger-gradient);
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
        line-height: 1;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        font-weight: 500;
    }

    .main-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
    }

    .main-panel {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    .panel-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .panel-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .panel-body {
        padding: 1.5rem;
    }

    .reportes-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        background: #f8fafc;
        padding: 0.5rem;
        border-radius: 10px;
    }

    .tab-btn {
        flex: 1;
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 8px;
        background: transparent;
        color: #6b7280;
        font-weight: 500;
        transition: var(--transition);
        cursor: pointer;
    }

    .tab-btn.active {
        background: var(--primary-gradient);
        color: white;
        box-shadow: var(--shadow-light);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .reportes-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .reporte-card {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 1.25rem;
        transition: var(--transition);
        cursor: pointer;
        position: relative;
    }

    .reporte-card:hover {
        background: white;
        border-color: var(--verde-pacifico);
        box-shadow: var(--shadow-light);
        transform: translateY(-1px);
    }

    .reporte-card.favorito::before {
        content: '⭐';
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.2rem;
    }

    .reporte-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .reporte-info {
        flex: 1;
    }

    .reporte-nombre {
        font-size: 1.1rem;
        font-weight: 600;
        color: #111827;
        margin: 0 0 0.25rem 0;
    }

    .reporte-descripcion {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .reporte-meta {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        font-size: 0.85rem;
        color: #6b7280;
    }

    .reporte-actions {
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.9rem;
    }

    .action-btn.ejecutar {
        background: #dbeafe;
        color: #1d4ed8;
    }

    .action-btn.ejecutar:hover {
        background: var(--verde-pacifico);
        color: white;
    }

    .action-btn.exportar {
        background: #dcfce7;
        color: var(--verde-oscuro);
    }

    .action-btn.exportar:hover {
        background: var(--verde-claro);
        color: white;
    }

    .action-btn.editar {
        background: #fef3c7;
        color: #d97706;
    }

    .action-btn.editar:hover {
        background: #f59e0b;
        color: white;
    }

    .action-btn.eliminar {
        background: #fef2f2;
        color: #dc2626;
    }

    .action-btn.eliminar:hover {
        background: #dc2626;
        color: white;
    }

    .sidebar-panel {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
        height: fit-content;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .btn-primary {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 0.875rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: var(--transition);
        cursor: pointer;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-medium);
        color: white;
    }

    .btn-secondary {
        background: white;
        color: #374151;
        border: 2px solid #e5e7eb;
        padding: 0.875rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: var(--transition);
        cursor: pointer;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-secondary:hover {
        border-color: var(--verde-pacifico);
        color: var(--verde-pacifico);
    }

    .quick-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .quick-stat {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }

    .quick-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--verde-pacifico);
        margin-bottom: 0.25rem;
    }

    .quick-stat-label {
        font-size: 0.8rem;
        color: #6b7280;
        font-weight: 500;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }

    .loading-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: var(--shadow-heavy);
    }

    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #e5e7eb;
        border-top: 4px solid var(--verde-pacifico);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6b7280;
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
        color: var(--verde-pacifico);
    }

    .empty-state-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #111827;
    }

    .empty-state-description {
        font-size: 0.9rem;
        max-width: 300px;
        margin: 0 auto;
    }

    .chart-container {
        margin: 1.5rem 0;
        height: 300px;
        position: relative;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .data-table th,
    .data-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }

    .data-table th {
        background: #f8fafc;
        font-weight: 600;
        color: #374151;
    }

    .data-table tbody tr:hover {
        background: #f8fafc;
    }

    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .badge.success {
        background: #d1fae5;
        color: #065f46;
    }

    .badge.warning {
        background: #fef3c7;
        color: #92400e;
    }

    .badge.danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge.info {
        background: #dbeafe;
        color: #1e40af;
    }

    @media (max-width: 1024px) {
        .main-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .reportes-container {
            padding: 1rem;
        }
        
        .reportes-title {
            font-size: 2rem;
        }
        
        .reportes-tabs {
            flex-direction: column;
        }
        
        .reporte-header {
            flex-direction: column;
            gap: 1rem;
        }
        
        .quick-stats {
            grid-template-columns: 1fr;
        }
    }

    /* Estilos para el modal de crear reporte */
    .modal-xl {
        max-width: 1200px;
    }

    .filter-section {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .filter-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #374151;
    }

    .campos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }

    .campo-section {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fa;
        margin-bottom: 10px;
    }

    .campo-section-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid #dee2e6;
        font-size: 0.9rem;
    }

    .campo-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: white;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        transition: var(--transition);
    }

    .campo-checkbox:hover {
        border-color: var(--verde-pacifico);
    }

    .campo-checkbox input:checked + label {
        color: var(--verde-pacifico);
        font-weight: 600;
    }

    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: var(--shadow-heavy);
        padding: 1rem 1.5rem;
        z-index: 1000;
        transform: translateX(100%);
        transition: var(--transition);
        border-left: 4px solid var(--verde-pacifico);
        min-width: 300px;
    }

    .toast.show {
        transform: translateX(0);
    }

    .toast.success {
        border-left-color: var(--verde-pacifico);
    }

    .toast.error {
        border-left-color: #ef4444;
    }

    .toast.warning {
        border-left-color: #f59e0b;
    }

    .toast-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .toast-title {
        font-weight: 600;
        color: #111827;
    }

    .toast-close {
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0;
        margin-left: 1rem;
    }

    .toast-body {
        color: #6b7280;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="reportes-container">
    <!-- Header -->
    <div class="reportes-header">
        <h1 class="reportes-title">Reportes y Analítica</h1>
        <p class="reportes-subtitle">Panel integral de reportería y análisis de datos del workflow</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
            </div>
            <div class="stat-value" id="total-solicitudes">{{ total_solicitudes }}</div>
            <div class="stat-label">Total Solicitudes</div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-header">
                <div class="stat-icon success">
                    <i class="fas fa-play"></i>
                </div>
            </div>
            <div class="stat-value" id="solicitudes-activas">{{ solicitudes_activas }}</div>
            <div class="stat-label">Solicitudes Activas</div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-header">
                <div class="stat-icon warning">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div class="stat-value" id="solicitudes-completadas">{{ solicitudes_completadas }}</div>
            <div class="stat-label">Solicitudes Completadas</div>
        </div>
        
        <div class="stat-card danger">
            <div class="stat-header">
                <div class="stat-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <div class="stat-value" id="solicitudes-vencidas">{{ solicitudes_vencidas }}</div>
            <div class="stat-label">SLA Vencidos</div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="main-grid">
        <!-- Reports Panel -->
        <div class="main-panel">
            <div class="panel-header">
                <h2 class="panel-title">
                    <i class="fas fa-chart-bar"></i>
                    Reportes Disponibles
                </h2>
            </div>
            <div class="panel-body">
                <!-- Tabs -->
                <div class="reportes-tabs">
                    <button class="tab-btn active" onclick="cambiarTab('personalizados')">
                        <i class="fas fa-user-cog"></i>
                        Personalizados
                    </button>
                    <button class="tab-btn" onclick="cambiarTab('predefinidos')">
                        <i class="fas fa-chart-line"></i>
                        Predefinidos
                    </button>
                    <button class="tab-btn" onclick="cambiarTab('favoritos')">
                        <i class="fas fa-star"></i>
                        Favoritos
                    </button>
                </div>

                <!-- Reportes Personalizados -->
                <div id="tab-personalizados" class="tab-content active">
                    <div class="reportes-list" id="reportes-personalizados">
                        {% for reporte in reportes_usuario %}
                        <div class="reporte-card {% if reporte.es_favorito %}favorito{% endif %}" data-reporte-id="{{ reporte.id }}">
                            <div class="reporte-header">
                                <div class="reporte-info">
                                    <h4 class="reporte-nombre">{{ reporte.nombre }}</h4>
                                    <p class="reporte-descripcion">{{ reporte.descripcion|default:"Sin descripción" }}</p>
                                </div>
                                <div class="reporte-actions">
                                    <button class="action-btn ejecutar" onclick="ejecutarReporte({{ reporte.id }})" title="Ejecutar">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="action-btn exportar" onclick="exportarReporte({{ reporte.id }})" title="Exportar">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="action-btn editar" onclick="editarReporte({{ reporte.id }})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn eliminar" onclick="eliminarReporte({{ reporte.id }})" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="reporte-meta">
                                <span><i class="fas fa-user"></i> {{ reporte.usuario.get_full_name }}</span>
                                <span><i class="fas fa-clock"></i> {{ reporte.fecha_modificacion|date:"d/m/Y H:i" }}</span>
                                <span><i class="fas fa-play-circle"></i> {{ reporte.veces_ejecutado }} ejecuciones</span>
                                {% if reporte.es_publico %}
                                <span class="badge info"><i class="fas fa-share"></i> Público</span>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="empty-state-title">No hay reportes personalizados</div>
                            <div class="empty-state-description">
                                Crea tu primer reporte personalizado para comenzar el análisis de datos.
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Reportes Predefinidos -->
                <div id="tab-predefinidos" class="tab-content">
                    <div class="reportes-list" id="reportes-predefinidos">
                        <!-- Se cargarán via JavaScript -->
                    </div>
                </div>

                <!-- Reportes Favoritos -->
                <div id="tab-favoritos" class="tab-content">
                    <div class="reportes-list" id="reportes-favoritos">
                        {% for reporte in reportes_favoritos %}
                        <div class="reporte-card favorito" data-reporte-id="{{ reporte.id }}">
                            <div class="reporte-header">
                                <div class="reporte-info">
                                    <h4 class="reporte-nombre">{{ reporte.nombre }}</h4>
                                    <p class="reporte-descripcion">{{ reporte.descripcion|default:"Sin descripción" }}</p>
                                </div>
                                <div class="reporte-actions">
                                    <button class="action-btn ejecutar" onclick="ejecutarReporte({{ reporte.id }})" title="Ejecutar">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="action-btn exportar" onclick="exportarReporte({{ reporte.id }})" title="Exportar">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="reporte-meta">
                                <span><i class="fas fa-clock"></i> {{ reporte.ultima_ejecucion|date:"d/m/Y H:i"|default:"Nunca ejecutado" }}</span>
                                <span><i class="fas fa-play-circle"></i> {{ reporte.veces_ejecutado }} ejecuciones</span>
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="empty-state-title">No hay reportes favoritos</div>
                            <div class="empty-state-description">
                                Marca reportes como favoritos para acceso rápido.
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Panel -->
        <div class="sidebar-panel">
            <div class="panel-header">
                <h3 class="panel-title">
                    <i class="fas fa-tools"></i>
                    Herramientas
                </h3>
            </div>
            <div class="panel-body">
                <div class="action-buttons">
                    <button class="btn-primary" onclick="crearReporte()">
                        <i class="fas fa-plus"></i>
                        Crear Reporte Personalizado
                    </button>
                    <button class="btn-secondary ms-2" onclick="crearReportePrueba()" title="Crear reporte de prueba para verificar exportación">
                        <i class="fas fa-flask"></i>
                        Reporte Prueba
                    </button>
                    <button class="btn-secondary" onclick="exportarTodo()">
                        <i class="fas fa-file-export"></i>
                        Exportar Dashboard
                    </button>
                    <button class="btn-secondary" onclick="programarReporte()">
                        <i class="fas fa-clock"></i>
                        Programar Reporte
                    </button>
                </div>

                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-value">{{ reportes_usuario|length }}</div>
                        <div class="quick-stat-label">Mis Reportes</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">{{ reportes_favoritos|length }}</div>
                        <div class="quick-stat-label">Favoritos</div>
                    </div>
                </div>

                <!-- Pipeline Stats -->
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-project-diagram"></i>
                        Por Pipeline
                    </div>
                    <div id="pipeline-stats">
                        {% for stat in stats_pipelines %}
                        <div class="permission-item">
                            <div class="permission-header">
                                <span class="permission-name">{{ stat.nombre }}</span>
                                <span class="badge info">{{ stat.total_solicitudes }}</span>
                            </div>
                            <div class="permission-description">
                                Activas: {{ stat.solicitudes_activas }} | 
                                Tiempo promedio: {{ stat.tiempo_promedio|floatformat:1|default:"N/A" }}h
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Chart Container -->
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-chart-line"></i>
                        Tendencia (30 días)
                    </div>
                    <div class="chart-container">
                        <canvas id="tendenciasChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div id="loading-text">Procesando reporte...</div>
    </div>
</div>

<!-- Modal para crear/editar reporte -->
<div class="modal fade" id="reporteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reporteModalTitle">Crear Reporte Personalizado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="reporteForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Nombre del Reporte *</label>
                                <input type="text" class="form-control" id="reporte-nombre" name="nombre" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Reporte</label>
                                <select class="form-select" id="reporte-tipo" name="tipo">
                                    <option value="general">General</option>
                                    <option value="sla">SLA y Tiempos</option>
                                    <option value="productividad">Productividad</option>
                                    <option value="comite">Comité</option>
                                    <option value="clientes">Clientes y Productos</option>
                                    <option value="requisitos">Requisitos</option>
                                    <option value="origen">Origen de Solicitudes</option>
                                    <option value="prioridades">Prioridades Urgentes</option>
                                    <option value="compliance">Compliance</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" id="reporte-descripcion" name="descripcion" rows="2" placeholder="Describe el propósito y alcance de este reporte..."></textarea>
                    </div>

                    <!-- Filtros -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-filter"></i>
                            Filtros Avanzados
                            <small class="text-muted">(Opcional - Dejar vacío para incluir todos)</small>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fecha Inicio</label>
                                    <input type="date" class="form-control" id="fecha-inicio" name="fecha_inicio">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fecha Fin</label>
                                    <input type="date" class="form-control" id="fecha-fin" name="fecha_fin">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Pipeline</label>
                                    <select class="form-select" id="filtro-pipeline" name="pipeline" multiple>
                                        <option value="">Seleccionar todos</option>
                                        {% for pipeline in pipelines %}
                                        <option value="{{ pipeline.id }}">{{ pipeline.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Mantén Ctrl/Cmd para seleccionar múltiples</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Etapa</label>
                                    <select class="form-select" id="filtro-etapa" name="etapa" multiple>
                                        <option value="">Seleccionar todas</option>
                                        {% for etapa in etapas %}
                                        <option value="{{ etapa.id }}">{{ etapa.pipeline.nombre }} - {{ etapa.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Mantén Ctrl/Cmd para seleccionar múltiples</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Usuario Asignado</label>
                                    <select class="form-select" id="filtro-usuario" name="usuario" multiple>
                                        <option value="">Seleccionar todos</option>
                                        {% for usuario in usuarios %}
                                        <option value="{{ usuario.id }}">{{ usuario.get_full_name|default:usuario.username }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Mantén Ctrl/Cmd para seleccionar múltiples</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Estado SLA</label>
                                    <select class="form-select" id="filtro-sla" name="estado_sla">
                                        <option value="">Todos los estados</option>
                                        <option value="vigente">Vigente</option>
                                        <option value="vencido">Vencido</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Prioridad</label>
                                    <select class="form-select" id="filtro-prioridad" name="prioridad">
                                        <option value="">Todas las prioridades</option>
                                        <option value="Alta">Alta</option>
                                        <option value="Media">Media</option>
                                        <option value="Baja">Baja</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Producto</label>
                                    <select class="form-select" id="filtro-producto" name="producto">
                                        <option value="">Todos los productos</option>
                                        <option value="Personal">Personal</option>
                                        <option value="Auto">Auto</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Origen de Solicitud</label>
                                    <select class="form-select" id="filtro-origen" name="origen">
                                        <option value="">Todos los orígenes</option>
                                        <option value="Canal Digital">Canal Digital</option>
                                        <option value="Presencial">Presencial</option>
                                        <option value="Telefónico">Telefónico</option>
                                        <option value="Email">Email</option>
                                        <option value="Referido">Referido</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Rango de Monto</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="monto-min" name="monto_min" placeholder="Mínimo">
                                        <span class="input-group-text">-</span>
                                        <input type="number" class="form-control" id="monto-max" name="monto_max" placeholder="Máximo">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos a incluir -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-columns"></i>
                            Campos a Incluir
                            <small class="text-muted">(Selecciona los campos que quieres ver en el reporte)</small>
                        </div>
                        <div class="campos-grid">
                            <!-- CAMPOS BÁSICOS -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">📋 Información Básica</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-codigo" name="campos" value="codigo" checked="">
                                    <label for="campo-codigo">Código</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-pipeline" name="campos" value="pipeline" checked="">
                                    <label for="campo-pipeline">Pipeline</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-etapa" name="campos" value="etapa_actual" checked="">
                                    <label for="campo-etapa">Etapa Actual</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-subestado" name="campos" value="subestado_actual">
                                    <label for="campo-subestado">Subestado Actual</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-prioridad" name="campos" value="prioridad">
                                    <label for="campo-prioridad">Prioridad</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-origen" name="campos" value="origen">
                                    <label for="campo-origen">Origen</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-etiquetas" name="campos" value="etiquetas_oficial">
                                    <label for="campo-etiquetas">Etiquetas Oficial</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE CLIENTE -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">👤 Información del Cliente</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-cliente" name="campos" value="cliente_nombre">
                                    <label for="campo-cliente">Nombre Cliente</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-cedula" name="campos" value="cliente_cedula">
                                    <label for="campo-cedula">Cédula</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-telefono" name="campos" value="cliente_telefono">
                                    <label for="campo-telefono">Teléfono</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-email" name="campos" value="cliente_email">
                                    <label for="campo-email">Email</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-fecha-nacimiento" name="campos" value="cliente_fecha_nacimiento">
                                    <label for="campo-fecha-nacimiento">Fecha Nacimiento</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-edad" name="campos" value="cliente_edad">
                                    <label for="campo-edad">Edad</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-sexo" name="campos" value="cliente_sexo">
                                    <label for="campo-sexo">Sexo</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-jubilado" name="campos" value="cliente_jubilado">
                                    <label for="campo-jubilado">Jubilado</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE COTIZACIÓN -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">💰 Información Financiera</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-monto" name="campos" value="monto">
                                    <label for="campo-monto">Monto</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-producto" name="campos" value="producto">
                                    <label for="campo-producto">Producto</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-monto-prestamo" name="campos" value="cotizacion_monto_prestamo">
                                    <label for="campo-monto-prestamo">Monto Préstamo</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-plazo-pago" name="campos" value="cotizacion_plazo_pago">
                                    <label for="campo-plazo-pago">Plazo Pago</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tasa-interes" name="campos" value="cotizacion_tasa_interes">
                                    <label for="campo-tasa-interes">Tasa Interés</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tasa-estimada" name="campos" value="tasa_estimada">
                                    <label for="campo-tasa-estimada">Tasa Estimada</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tasa-bruta" name="campos" value="tasa_bruta">
                                    <label for="campo-tasa-bruta">Tasa Bruta</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-comision-cierre" name="campos" value="comision_cierre">
                                    <label for="campo-comision-cierre">Comisión Cierre</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE COTIZACIÓN DETALLADA -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">🏢 Información de Cotización</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-oficial" name="campos" value="cotizacion_oficial">
                                    <label for="campo-oficial">Oficial</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-sucursal" name="campos" value="cotizacion_sucursal">
                                    <label for="campo-sucursal">Sucursal</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tipo-prestamo" name="campos" value="cotizacion_tipo_prestamo">
                                    <label for="campo-tipo-prestamo">Tipo Préstamo</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-sector" name="campos" value="cotizacion_sector">
                                    <label for="campo-sector">Sector</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-patrono" name="campos" value="cotizacion_patrono">
                                    <label for="campo-patrono">Patrono</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-vendedor" name="campos" value="cotizacion_vendedor">
                                    <label for="campo-vendedor">Vendedor</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tipo-vendedor" name="campos" value="cotizacion_vendedor_tipo">
                                    <label for="campo-tipo-vendedor">Tipo Vendedor</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-apc-score" name="campos" value="cotizacion_apc_score">
                                    <label for="campo-apc-score">APC Score</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-apc-pi" name="campos" value="cotizacion_apc_pi">
                                    <label for="campo-apc-pi">APC PI</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE AUTO -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">🚗 Información del Auto</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-auto-marca" name="campos" value="auto_marca">
                                    <label for="campo-auto-marca">Marca Auto</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-auto-modelo" name="campos" value="auto_modelo">
                                    <label for="campo-auto-modelo">Modelo Auto</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-auto-year" name="campos" value="auto_year">
                                    <label for="campo-auto-year">Año Auto</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-auto-valor" name="campos" value="auto_valor">
                                    <label for="campo-auto-valor">Valor Auto</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-auto-cashback" name="campos" value="auto_cashback">
                                    <label for="campo-auto-cashback">Cashback</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-auto-abono" name="campos" value="auto_abono">
                                    <label for="campo-auto-abono">Abono</label>
                                </div>
                            </div>

                            <!-- CAMPOS LABORALES -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">💼 Información Laboral</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tiempo-servicio" name="campos" value="tiempo_servicio">
                                    <label for="campo-tiempo-servicio">Tiempo Servicio</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-ingresos" name="campos" value="ingresos">
                                    <label for="campo-ingresos">Ingresos</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-nombre-empresa" name="campos" value="nombre_empresa">
                                    <label for="campo-nombre-empresa">Nombre Empresa</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-posicion" name="campos" value="posicion">
                                    <label for="campo-posicion">Posición</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-salario-base" name="campos" value="salario_base">
                                    <label for="campo-salario-base">Salario Base</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-salario-neto" name="campos" value="salario_neto">
                                    <label for="campo-salario-neto">Salario Neto</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE CODEUDOR -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">👥 Información Codeudor</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-aplica-codeudor" name="campos" value="aplica_codeudor">
                                    <label for="campo-aplica-codeudor">Aplica Codeudor</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-codeudor-nombre" name="campos" value="codeudor_nombre">
                                    <label for="campo-codeudor-nombre">Codeudor Nombre</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-codeudor-cedula" name="campos" value="codeudor_cedula">
                                    <label for="campo-codeudor-cedula">Codeudor Cédula</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-codeudor-ingresos" name="campos" value="codeudor_ingresos">
                                    <label for="campo-codeudor-ingresos">Codeudor Ingresos</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE SEGURO -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">🛡️ Información de Seguro</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-financia-seguro" name="campos" value="financia_seguro">
                                    <label for="campo-financia-seguro">Financia Seguro</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-monto-anual-seguro" name="campos" value="monto_anual_seguro">
                                    <label for="campo-monto-anual-seguro">Monto Anual Seguro</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-monto-mensual-seguro" name="campos" value="monto_mensual_seguro">
                                    <label for="campo-monto-mensual-seguro">Monto Mensual Seguro</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE FECHAS -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">📅 Fechas Importantes</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-fecha-creacion" name="campos" value="fecha_creacion">
                                    <label for="campo-fecha-creacion">Fecha Creación</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-fecha-ultima-actualizacion" name="campos" value="fecha_ultima_actualizacion">
                                    <label for="campo-fecha-ultima-actualizacion">Última Actualización</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-fecha-inicio-pago" name="campos" value="fecha_inicio_pago">
                                    <label for="campo-fecha-inicio-pago">Fecha Inicio Pago</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-fecha-vencimiento" name="campos" value="fecha_vencimiento">
                                    <label for="campo-fecha-vencimiento">Fecha Vencimiento</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE RESULTADOS FINANCIEROS -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">💵 Resultados Financieros</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tabla-total-pagos" name="campos" value="tabla_total_pagos">
                                    <label for="campo-tabla-total-pagos">Total Pagos</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tabla-total-seguro" name="campos" value="tabla_total_seguro">
                                    <label for="campo-tabla-total-seguro">Total Seguro</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tabla-total-interes" name="campos" value="tabla_total_interes">
                                    <label for="campo-tabla-total-interes">Total Interés</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tabla-total-capital" name="campos" value="tabla_total_capital">
                                    <label for="campo-tabla-total-capital">Total Capital</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE PROCESO -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">⚙️ Información de Proceso</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-creada-por" name="campos" value="creada_por">
                                    <label for="campo-creada-por">Creado Por</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-asignada-a" name="campos" value="asignada_a">
                                    <label for="campo-asignada-a">Asignado A</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-propietario" name="campos" value="propietario">
                                    <label for="campo-propietario">Propietario</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tiempo-en-etapa" name="campos" value="tiempo_en_etapa">
                                    <label for="campo-tiempo-en-etapa">Tiempo en Etapa</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-sla-status" name="campos" value="sla_status">
                                    <label for="campo-sla-status">Estado SLA</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-sla-vencido" name="campos" value="sla_vencido">
                                    <label for="campo-sla-vencido">SLA Vencido</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE HISTORIAL -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">📊 Historial y Tiempos</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-historial-etapas" name="campos" value="historial_etapas">
                                    <label for="campo-historial-etapas">Historial Etapas</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-tiempo-total-proceso" name="campos" value="tiempo_total_proceso">
                                    <label for="campo-tiempo-total-proceso">Tiempo Total Proceso</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-etapas-completadas" name="campos" value="etapas_completadas">
                                    <label for="campo-etapas-completadas">Etapas Completadas</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE REQUISITOS -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">📋 Requisitos</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-requisitos-total" name="campos" value="requisitos_total">
                                    <label for="campo-requisitos-total">Total Requisitos</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-requisitos-cumplidos" name="campos" value="requisitos_cumplidos">
                                    <label for="campo-requisitos-cumplidos">Requisitos Cumplidos</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-requisitos-pendientes" name="campos" value="requisitos_pendientes">
                                    <label for="campo-requisitos-pendientes">Requisitos Pendientes</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-porcentaje-cumplimiento-requisitos" name="campos" value="porcentaje_cumplimiento_requisitos">
                                    <label for="campo-porcentaje-cumplimiento-requisitos">% Cumplimiento Requisitos</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE COMENTARIOS -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">💬 Comentarios</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-comentarios-total" name="campos" value="comentarios_total">
                                    <label for="campo-comentarios-total">Total Comentarios</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-comentarios-general" name="campos" value="comentarios_general">
                                    <label for="campo-comentarios-general">Comentarios Generales</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-comentarios-analista" name="campos" value="comentarios_analista">
                                    <label for="campo-comentarios-analista">Comentarios Analista</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-ultimo-comentario" name="campos" value="ultimo_comentario">
                                    <label for="campo-ultimo-comentario">Último Comentario</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE CALIFICACIONES -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">⭐ Calificaciones Compliance</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-calificaciones-total" name="campos" value="calificaciones_total">
                                    <label for="campo-calificaciones-total">Total Calificaciones</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-calificaciones-buenas" name="campos" value="calificaciones_buenas">
                                    <label for="campo-calificaciones-buenas">Calificaciones Buenas</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-calificaciones-malas" name="campos" value="calificaciones_malas">
                                    <label for="campo-calificaciones-malas">Calificaciones Malas</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-calificaciones-sin-calificar" name="campos" value="calificaciones_sin_calificar">
                                    <label for="campo-calificaciones-sin-calificar">Sin Calificar</label>
                                </div>
                            </div>

                            <!-- CAMPOS DE COMITÉ -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">👥 Comité</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-comite-participaciones" name="campos" value="comite_participaciones">
                                    <label for="campo-comite-participaciones">Participaciones Comité</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-comite-escalamientos" name="campos" value="comite_escalamientos">
                                    <label for="campo-comite-escalamientos">Escalamientos Comité</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-comite-ultima-participacion" name="campos" value="comite_ultima_participacion">
                                    <label for="campo-comite-ultima-participacion">Última Participación Comité</label>
                                </div>
                            </div>

                            <!-- CAMPOS ADICIONALES -->
                            <div class="campo-section">
                                <h6 class="campo-section-title">🔧 Información Adicional</h6>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-campos-personalizados" name="campos" value="campos_personalizados">
                                    <label for="campo-campos-personalizados">Campos Personalizados</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-debida-diligencia-estado" name="campos" value="debida_diligencia_estado">
                                    <label for="campo-debida-diligencia-estado">Estado Debida Diligencia</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-documentos-cotizacion" name="campos" value="documentos_cotizacion">
                                    <label for="campo-documentos-cotizacion">Documentos Cotización</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-motivo-consulta" name="campos" value="motivo_consulta">
                                    <label for="campo-motivo-consulta">Motivo Consulta</label>
                                </div>
                                <div class="campo-checkbox">
                                    <input type="checkbox" id="campo-observaciones" name="campos" value="observaciones">
                                    <label for="campo-observaciones">Observaciones</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración adicional -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-cog"></i>
                            Configuración Adicional
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="es-publico" name="es_publico">
                                    <label class="form-check-label" for="es-publico">
                                        <i class="fas fa-users"></i> Compartir con mi grupo
                                    </label>
                                    <small class="text-muted d-block">Otros usuarios de tu grupo podrán ver este reporte</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="es-favorito" name="es_favorito">
                                    <label class="form-check-label" for="es-favorito">
                                        <i class="fas fa-star"></i> Marcar como favorito
                                    </label>
                                    <small class="text-muted d-block">Aparecerá en la sección de favoritos</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ordenar por</label>
                                    <select class="form-select" id="ordenar-por" name="ordenar_por">
                                        <option value="fecha_creacion">Fecha de Creación</option>
                                        <option value="fecha_ultima_actualizacion">Última Actualización</option>
                                        <option value="codigo">Código de Solicitud</option>
                                        <option value="cliente_nombre">Nombre del Cliente</option>
                                        <option value="monto_solicitado">Monto Solicitado</option>
                                        <option value="prioridad">Prioridad</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Dirección del orden</label>
                                    <select class="form-select" id="orden-direccion" name="orden_direccion">
                                        <option value="desc">Descendente (más reciente primero)</option>
                                        <option value="asc">Ascendente (más antiguo primero)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Límite de registros</label>
                                    <select class="form-select" id="limite-registros" name="limite_registros">
                                        <option value="">Sin límite</option>
                                        <option value="100">100 registros</option>
                                        <option value="500">500 registros</option>
                                        <option value="1000">1,000 registros</option>
                                        <option value="5000">5,000 registros</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Formato de fecha</label>
                                    <select class="form-select" id="formato-fecha" name="formato_fecha">
                                        <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                                        <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                        <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                        <option value="dd-mm-yyyy">DD-MM-YYYY</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-between w-100">
                        <div>
                            <button type="button" class="btn btn-outline-info btn-sm me-2" onclick="reportesManager.establecerFechasPorDefecto()">
                                <i class="fas fa-calendar"></i> Fechas por Defecto
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm me-2" onclick="reportesManager.limpiarFiltros()">
                                <i class="fas fa-broom"></i> Limpiar Filtros
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm d-none" id="form-spinner"></span>
                                <i class="fas fa-save"></i> Guardar Reporte
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para mostrar resultados -->
<div class="modal fade" id="resultadosModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultadosModalTitle">Resultados del Reporte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resultados-container">
                    <!-- Los resultados se cargarán aquí -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="exportar-resultados">
                    <i class="fas fa-download"></i>
                    Exportar a Excel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ tendencias|default:"[]"|json_script:"tendencias-data" }}
<script>
class ReportesManager {
    constructor() {
        this.reporteActual = null;
        this.tabActivo = 'personalizados';
        this.init();
    }

    init() {
        this.cargarReportesPredefinidos();
        this.inicializarGraficos();
        this.setupEventListeners();
    }

    setupEventListeners() {
        // Form submission
        document.getElementById('reporteForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.guardarReporte();
        });

        // Exportar resultados
        document.getElementById('exportar-resultados').addEventListener('click', () => {
            if (this.reporteActual) {
                this.exportarReporte(this.reporteActual);
            }
        });
    }

    async cargarReportesPredefinidos() {
        try {
            console.log('Cargando reportes predefinidos...');
            // Cargar todos los tipos de reportes predefinidos
            const tiposReportes = [
                'dashboard_general',
                'sla_cumplimiento', 
                'productividad_usuarios',
                'tiempos_etapas',
                'comite_participaciones',
                'clientes_productos',
                'requisitos_cumplimiento',
                'origen_solicitudes',
                'prioridades_urgentes',
                'calificaciones_compliance'
            ];
            
            let todosReportes = [];
            
            for (const tipo of tiposReportes) {
                try {
                    console.log(`Cargando reporte tipo: ${tipo}`);
                    const response = await fetch(`{% url "workflow:api_reportes_predefinidos" %}?tipo=${tipo}`);
                    const data = await response.json();
                    
                    console.log(`Respuesta para ${tipo}:`, data);
                    
                    if (data.success && data.reportes.length > 0) {
                        todosReportes = todosReportes.concat(data.reportes);
                    }
                } catch (error) {
                    console.error(`Error cargando reporte ${tipo}:`, error);
                }
            }
            
            console.log(`Total reportes cargados: ${todosReportes.length}`);
            
            if (todosReportes.length > 0) {
                this.renderReportesPredefinidos(todosReportes);
            } else {
                this.renderReportesPredefinidos([]);
            }
        } catch (error) {
            console.error('Error cargando reportes predefinidos:', error);
            this.renderReportesPredefinidos([]);
        }
    }

    renderReportesPredefinidos(reportes) {
        const container = document.getElementById('reportes-predefinidos');
        
        if (reportes.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="empty-state-title">No hay reportes predefinidos</div>
                    <div class="empty-state-description">
                        Los reportes predefinidos se mostrarán aquí.
                    </div>
                </div>
            `;
            return;
        }

        container.innerHTML = reportes.map(reporte => `
            <div class="reporte-card" data-reporte-predefinido="${reporte.tipo}">
                <div class="reporte-header">
                    <div class="reporte-info">
                        <h4 class="reporte-nombre">${reporte.nombre}</h4>
                        <p class="reporte-descripcion">${reporte.descripcion}</p>
                    </div>
                    <div class="reporte-actions">
                        <button class="action-btn ejecutar" onclick="reportesManager.ejecutarReportePredefinido('${reporte.tipo}')" title="Ejecutar">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="action-btn exportar" onclick="reportesManager.exportarReportePredefinido('${reporte.tipo}')" title="Exportar">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="reporte-meta">
                    <span class="badge info">${reporte.tipo.toUpperCase()}</span>
                    <span><i class="fas fa-chart-bar"></i> ${reporte.datos ? reporte.datos.length || 0 : 0} registros</span>
                </div>
            </div>
        `).join('');
    }

    inicializarGraficos() {
        const ctx = document.getElementById('tendenciasChart');
        if (!ctx) {
            console.warn('Canvas de tendencias no encontrado');
            return;
        }
        const context = ctx.getContext('2d');
        // Datos de tendencias desde el backend de forma segura
        const tendenciasData = JSON.parse(document.getElementById('tendencias-data').textContent);
        if (!Array.isArray(tendenciasData) || tendenciasData.length === 0) {
            console.warn('No hay datos de tendencias disponibles');
            return;
        }
        new Chart(context, {
            type: 'line',
            data: {
                labels: tendenciasData.map(item => {
                    const fecha = new Date(item.fecha);
                    return fecha.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                }),
                datasets: [{
                    label: 'Solicitudes por día',
                    data: tendenciasData.map(item => item.total),
                    borderColor: 'var(--verde-pacifico)',
                    backgroundColor: 'rgba(0, 156, 60, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    cambiarTab(tab) {
        this.tabActivo = tab;
        
        // Actualizar botones
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Mostrar contenido
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`tab-${tab}`).classList.add('active');
    }

    crearReporte() {
        document.getElementById('reporteModalTitle').textContent = 'Crear Reporte Personalizado';
        document.getElementById('reporteForm').reset();
        
        // Establecer fechas por defecto
        this.establecerFechasPorDefecto();
        
        // Seleccionar campos básicos por defecto
        this.seleccionarCamposBasicos();
        
        const modal = new bootstrap.Modal(document.getElementById('reporteModal'));
        modal.show();
    }

    async guardarReporte() {
        // Validar formulario antes de enviar
        if (!this.validarFormulario()) {
            return;
        }

        const formData = new FormData(document.getElementById('reporteForm'));
        const spinner = document.getElementById('form-spinner');
        
        spinner.classList.remove('d-none');
        
        try {
            // Obtener campos seleccionados
            const camposSeleccionados = Array.from(document.querySelectorAll('input[name="campos"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Construir filtros
            const filtros = {
                fecha_inicio: formData.get('fecha_inicio'),
                fecha_fin: formData.get('fecha_fin'),
                pipeline_ids: Array.from(document.getElementById('filtro-pipeline').selectedOptions).map(opt => opt.value),
                etapa_ids: Array.from(document.getElementById('filtro-etapa').selectedOptions).map(opt => opt.value),
                usuario_ids: Array.from(document.getElementById('filtro-usuario').selectedOptions).map(opt => opt.value),
                estado_sla: formData.get('estado_sla'),
                prioridad: formData.get('prioridad'),
                origen: formData.get('origen'),
                monto_min: formData.get('monto_min'),
                monto_max: formData.get('monto_max')
            };
            
            // Construir configuración
            const configuracion = {
                tipo: formData.get('tipo'),
                ordenar_por: formData.get('ordenar_por'),
                orden_direccion: formData.get('orden_direccion'),
                limite_registros: formData.get('limite_registros'),
                formato_fecha: formData.get('formato_fecha')
            };
            
            const payload = {
                nombre: formData.get('nombre'),
                descripcion: formData.get('descripcion'),
                filtros: filtros,
                campos: camposSeleccionados,
                configuracion: configuracion,
                es_publico: document.getElementById('es-publico').checked,
                es_favorito: document.getElementById('es-favorito').checked
            };
            
            console.log('Enviando payload:', payload);
            
            const response = await fetch('{% url "workflow:api_crear_reporte" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify(payload)
            });
            
            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.success) {
                this.showToast('Reporte creado exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('reporteModal')).hide();
                // Actualizar la lista de reportes sin recargar la página
                this.actualizarReportesPersonalizados();
            } else {
                this.showToast(data.message || 'Error al crear reporte', 'error');
            }
        } catch (error) {
            console.error('Error guardando reporte:', error);
            this.showToast(`Error al guardar reporte: ${error.message}`, 'error');
        } finally {
            spinner.classList.add('d-none');
        }
    }

    async ejecutarReporte(reporteId) {
        this.mostrarLoading('Ejecutando reporte...');
        
        try {
            const response = await fetch(`/workflow/api/reportes/${reporteId}/ejecutar/`);
            const data = await response.json();
            
            if (data.success) {
                this.reporteActual = reporteId;
                this.mostrarResultados(data.datos, data.configuracion);
                this.showToast(`Reporte ejecutado: ${data.total_registros} registros`, 'success');
            } else {
                this.showToast(data.message || 'Error al ejecutar reporte', 'error');
            }
        } catch (error) {
            console.error('Error ejecutando reporte:', error);
            this.showToast('Error al ejecutar reporte', 'error');
        } finally {
            this.ocultarLoading();
        }
    }

    async exportarReporte(reporteId) {
        this.mostrarLoading('Exportando a Excel...');
        
        try {
            console.log(`Exportando reporte ID: ${reporteId}`);
            
            const url = `{% url "workflow:api_exportar_reporte" reporte_id=0 %}`.replace('0', reporteId);
            console.log('URL de exportación:', url);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.getCSRFToken()
                }
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (response.ok) {
                const blob = await response.blob();
                console.log('Blob size:', blob.size);
                
                if (blob.size === 0) {
                    throw new Error('El archivo generado está vacío');
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                
                // Obtener nombre del archivo del header
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'reporte.xlsx';
                
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="([^"]+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                console.log('Filename:', filename);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                this.showToast('Reporte exportado exitosamente', 'success');
            } else {
                // Intentar obtener el mensaje de error
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.message || `Error HTTP ${response.status}`;
                console.error('Error response:', errorData);
                this.showToast(`Error al exportar reporte: ${errorMessage}`, 'error');
            }
        } catch (error) {
            console.error('Error exportando reporte:', error);
            this.showToast(`Error al exportar reporte: ${error.message}`, 'error');
        } finally {
            this.ocultarLoading();
        }
    }

    async ejecutarReportePredefinido(tipo) {
        this.mostrarLoading('Ejecutando reporte predefinido...');
        
        try {
            const response = await fetch(`{% url "workflow:api_reportes_predefinidos" %}?tipo=${tipo}`);
            const data = await response.json();
            
            if (data.success && data.reportes.length > 0) {
                const reporte = data.reportes[0];
                this.mostrarResultados(reporte.datos, { tipo: tipo });
                this.showToast(`Reporte ${reporte.nombre} ejecutado`, 'success');
            } else {
                this.showToast('Error al ejecutar reporte predefinido', 'error');
            }
        } catch (error) {
            console.error('Error ejecutando reporte predefinido:', error);
            this.showToast('Error al ejecutar reporte predefinido', 'error');
        } finally {
            this.ocultarLoading();
        }
    }

    exportarReportePredefinido(tipo) {
        this.mostrarLoading('Exportando reporte predefinido...');
        fetch(`{% url "workflow:api_reportes_predefinidos" %}?tipo=${tipo}&exportar=1`, {
            method: 'GET'
            // No se necesita CSRF para GET
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error('Error al exportar reporte predefinido');
            }
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `reporte_predefinido_${tipo}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            this.showToast('Reporte predefinido exportado exitosamente', 'success');
        })
        .catch(error => {
            console.error(error);
            this.showToast('Error al exportar reporte predefinido', 'error');
        })
        .finally(() => {
            this.ocultarLoading();
        });
    }

    mostrarResultados(datos, configuracion) {
        const container = document.getElementById('resultados-container');
        
        if (!datos || datos.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="empty-state-title">No se encontraron datos</div>
                    <div class="empty-state-description">
                        Los filtros aplicados no devolvieron resultados.
                    </div>
                </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('resultadosModal'));
            modal.show();
            return;
        }
        
        // Verificar que el primer elemento tenga datos válidos
        const primerElemento = datos[0];
        if (!primerElemento || typeof primerElemento !== 'object') {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="empty-state-title">Formato de datos inválido</div>
                    <div class="empty-state-description">
                        Los datos recibidos no tienen el formato esperado.
                    </div>
                </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('resultadosModal'));
            modal.show();
            return;
        }
        
        // Crear tabla con los datos
        const headers = Object.keys(primerElemento);
        
        let html = `
            <div class="mb-3">
                <h6><i class="fas fa-chart-bar"></i> Total de registros: ${datos.length}</h6>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
        `;
        
        headers.forEach(header => {
            html += `<th>${header}</th>`;
        });
        
        html += `
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        datos.slice(0, 100).forEach(fila => { // Limitar a 100 filas para rendimiento
            html += '<tr>';
            headers.forEach(header => {
                let valor = fila[header] || '';
                
                // Formatear valores especiales
                if (header === 'Estado SLA') {
                    valor = valor === 'Vencido' 
                        ? `<span class="badge danger">${valor}</span>`
                        : `<span class="badge success">${valor}</span>`;
                } else if (header === 'Prioridad') {
                    const colorClass = valor === 'Alta' ? 'danger' : valor === 'Media' ? 'warning' : 'info';
                    valor = `<span class="badge ${colorClass}">${valor}</span>`;
                }
                
                html += `<td>${valor}</td>`;
            });
            html += '</tr>';
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        if (datos.length > 100) {
            html += `
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Mostrando los primeros 100 registros de ${datos.length} total. 
                        Usa la exportación para ver todos los datos.
                    </small>
                </div>
            `;
        }
        
        container.innerHTML = html;
        
        const modal = new bootstrap.Modal(document.getElementById('resultadosModal'));
        modal.show();
    }

    mostrarLoading(texto = 'Cargando...') {
        document.getElementById('loading-text').textContent = texto;
        document.getElementById('loading-overlay').style.display = 'flex';
    }

    ocultarLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }

    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <div class="toast-header">
                <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <button class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
            </div>
            <div class="toast-body">${message}</div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // Funciones para selección rápida de campos
    seleccionarTodosCampos() {
        document.querySelectorAll('.campo-checkbox input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
        });
        this.showToast('Todos los campos seleccionados', 'info');
    }

    deseleccionarTodosCampos() {
        document.querySelectorAll('.campo-checkbox input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        this.showToast('Todos los campos deseleccionados', 'info');
    }

    seleccionarCamposBasicos() {
        const camposBasicos = ['codigo', 'pipeline', 'etapa_actual', 'cliente_nombre', 'producto', 'asignada_a'];
        document.querySelectorAll('.campo-checkbox input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = camposBasicos.includes(checkbox.value);
        });
        this.showToast('Campos básicos seleccionados', 'info');
    }

    // Función para establecer fechas por defecto
    establecerFechasPorDefecto() {
        const hoy = new Date();
        const hace30Dias = new Date(hoy.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        document.getElementById('fecha-inicio').value = hace30Dias.toISOString().split('T')[0];
        document.getElementById('fecha-fin').value = hoy.toISOString().split('T')[0];
    }

    // Función para limpiar filtros
    limpiarFiltros() {
        document.getElementById('fecha-inicio').value = '';
        document.getElementById('fecha-fin').value = '';
        document.getElementById('filtro-pipeline').selectedIndex = 0;
        document.getElementById('filtro-etapa').selectedIndex = 0;
        document.getElementById('filtro-usuario').selectedIndex = 0;
        document.getElementById('filtro-sla').selectedIndex = 0;
        document.getElementById('filtro-prioridad').selectedIndex = 0;
        document.getElementById('filtro-producto').selectedIndex = 0;
        document.getElementById('filtro-origen').selectedIndex = 0;
        document.getElementById('monto-min').value = '';
        document.getElementById('monto-max').value = '';
        this.showToast('Filtros limpiados', 'info');
    }

    // Función para validar formulario
    validarFormulario() {
        const nombre = document.getElementById('reporte-nombre').value.trim();
        if (!nombre) {
            this.showToast('El nombre del reporte es obligatorio', 'error');
            return false;
        }

        const camposSeleccionados = document.querySelectorAll('.campo-checkbox input[type="checkbox"]:checked');
        if (camposSeleccionados.length === 0) {
            this.showToast('Debes seleccionar al menos un campo', 'error');
            return false;
        }

        return true;
    }

    // Función para obtener el token CSRF de forma segura
    getCSRFToken() {
        // Intentar obtener el token de diferentes formas
        const csrfToken = 
            document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
            document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] ||
            '';
        
        if (!csrfToken) {
            console.warn('No se pudo obtener el token CSRF');
        }
        
        return csrfToken;
    }
    
    // Función para actualizar la lista de reportes personalizados
    async actualizarReportesPersonalizados() {
        try {
            console.log('Actualizando reportes personalizados...');
            
            // Hacer una petición AJAX para obtener los reportes actualizados
            const response = await fetch('{% url "workflow:api_obtener_reportes_usuario" %}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Actualizar reportes personalizados
                const contenedorPersonalizados = document.querySelector('#reportes-personalizados');
                if (contenedorPersonalizados) {
                    if (data.reportes_usuario.length > 0) {
                        contenedorPersonalizados.innerHTML = this.generarHTMLReportes(data.reportes_usuario, 'personalizados');
                    } else {
                        contenedorPersonalizados.innerHTML = this.generarEmptyState('personalizados');
                    }
                }
                
                // Actualizar reportes favoritos
                const contenedorFavoritos = document.querySelector('#reportes-favoritos');
                if (contenedorFavoritos) {
                    if (data.reportes_favoritos.length > 0) {
                        contenedorFavoritos.innerHTML = this.generarHTMLReportes(data.reportes_favoritos, 'favoritos');
                    } else {
                        contenedorFavoritos.innerHTML = this.generarEmptyState('favoritos');
                    }
                }
                
                // Actualizar el contador en el dashboard
                const contadorReportes = document.querySelector('.quick-stat-value');
                if (contadorReportes) {
                    contadorReportes.textContent = data.total_reportes;
                }
                
                console.log('Reportes actualizados correctamente');
            } else {
                throw new Error(data.message || 'Error al obtener reportes');
            }
        } catch (error) {
            console.error('Error actualizando reportes:', error);
            this.showToast('Error al actualizar reportes', 'error');
            // Si falla, recargar la página como fallback
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    }
    
    // Función para generar HTML de reportes
    generarHTMLReportes(reportes, tipo) {
        let html = '';
        for (const reporte of reportes) {
            const esFavorito = reporte.es_favorito ? 'favorito' : '';
            html += `
                <div class="reporte-card ${esFavorito}" data-reporte-id="${reporte.id}">
                    <div class="reporte-header">
                        <div class="reporte-info">
                            <h4 class="reporte-nombre">${reporte.nombre}</h4>
                            <p class="reporte-descripcion">${reporte.descripcion}</p>
                        </div>
                        <div class="reporte-actions">
                            <button class="action-btn ejecutar" onclick="ejecutarReporte(${reporte.id})" title="Ejecutar">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="action-btn exportar" onclick="exportarReporte(${reporte.id})" title="Exportar">
                                <i class="fas fa-download"></i>
                            </button>
                            ${tipo === 'personalizados' ? `
                                <button class="action-btn editar" onclick="editarReporte(${reporte.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn eliminar" onclick="eliminarReporte(${reporte.id})" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="reporte-meta">
                        <span><i class="fas fa-clock"></i> ${reporte.fecha_modificacion}</span>
                        <span><i class="fas fa-play-circle"></i> ${reporte.veces_ejecutado} ejecuciones</span>
                        ${reporte.es_publico ? '<span class="badge info"><i class="fas fa-share"></i> Público</span>' : ''}
                    </div>
                </div>
            `;
        }
        return html;
    }
    
    // Función para generar empty state
    generarEmptyState(tipo) {
        const iconos = {
            'personalizados': 'fas fa-chart-bar',
            'favoritos': 'fas fa-star'
        };
        const titulos = {
            'personalizados': 'No hay reportes personalizados',
            'favoritos': 'No hay reportes favoritos'
        };
        const descripciones = {
            'personalizados': 'Crea tu primer reporte personalizado para comenzar el análisis de datos.',
            'favoritos': 'Marca reportes como favoritos para acceso rápido.'
        };
        
        return `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="${iconos[tipo]}"></i>
                </div>
                <div class="empty-state-title">${titulos[tipo]}</div>
                <div class="empty-state-description">
                    ${descripciones[tipo]}
                </div>
            </div>
        `;
    }
    
    // Función para crear reporte de prueba
    async crearReportePrueba() {
        this.mostrarLoading('Creando reporte de prueba...');
        
        try {
            const response = await fetch('{% url "workflow:api_crear_reporte_prueba" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.getCSRFToken()
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showToast('Reporte de prueba creado exitosamente', 'success');
                // Actualizar la lista de reportes
                this.actualizarReportesPersonalizados();
            } else {
                this.showToast(data.message || 'Error al crear reporte de prueba', 'error');
            }
        } catch (error) {
            console.error('Error creando reporte de prueba:', error);
            this.showToast('Error al crear reporte de prueba', 'error');
        } finally {
            this.ocultarLoading();
        }
    }
}

// Funciones globales
function cambiarTab(tab) {
    reportesManager.cambiarTab(tab);
}

function crearReporte() {
    reportesManager.crearReporte();
}

function crearReportePrueba() {
    reportesManager.crearReportePrueba();
}

function ejecutarReporte(id) {
    reportesManager.ejecutarReporte(id);
}

function exportarReporte(id) {
    reportesManager.exportarReporte(id);
}

function editarReporte(id) {
    reportesManager.showToast('Función de edición próximamente', 'info');
}

async function eliminarReporte(id) {
    if (confirm('¿Estás seguro de eliminar este reporte?')) {
        try {
            const response = await fetch(`{% url "workflow:api_eliminar_reporte" 0 %}`.replace('0', id), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': reportesManager.getCSRFToken()
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                reportesManager.showToast(data.message, 'success');
                // Actualizar la lista de reportes
                reportesManager.actualizarReportesPersonalizados();
            } else {
                reportesManager.showToast(data.message || 'Error al eliminar reporte', 'error');
            }
        } catch (error) {
            console.error('Error eliminando reporte:', error);
            reportesManager.showToast('Error al eliminar reporte', 'error');
        }
    }
}

function exportarTodo() {
    reportesManager.showToast('Exportación de dashboard próximamente', 'info');
}

function programarReporte() {
    reportesManager.showToast('Programación de reportes próximamente', 'info');
}

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    window.reportesManager = new ReportesManager();
});
</script>
{% endblock %}
