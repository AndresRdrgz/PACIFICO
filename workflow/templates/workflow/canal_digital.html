{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}{{ titulo }} - Sistema de Workflow - Pac√≠fico{% endblock %}

{% block extra_css %}
<style>
    :root {
        --pacifico-primary: #2c5530;
        --pacifico-secondary: #4a7c59;
        --pacifico-accent: #6faa75;
        --pacifico-light: #e8f4ea;
        --pacifico-gradient: linear-gradient(135deg, #2c5530 0%, #4a7c59 50%, #6faa75 100%);
        --digital-blue: #007bff;
        --digital-teal: #20c997;
        --digital-gradient: linear-gradient(135deg, #007bff 0%, #20c997 100%);
        --card-shadow: 0 8px 32px rgba(44, 85, 48, 0.15);
        --card-shadow-hover: 0 16px 48px rgba(44, 85, 48, 0.25);
    }

    .digital-container {
        background: linear-gradient(135deg, #f8fffe 0%, #f0f9f2 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    /* Enhanced KPI Cards */
    .kpi-card {
        background: var(--digital-gradient);
        color: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: var(--card-shadow);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        border: none;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        pointer-events: none;
    }
    
    .kpi-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--card-shadow-hover);
    }
    
    .kpi-number {
        font-size: 2.8rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .kpi-label {
        font-size: 1rem;
        opacity: 0.95;
        font-weight: 500;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .digital-icon {
        font-size: 3.5rem;
        opacity: 0.15;
        position: absolute;
        right: 1.5rem;
        top: 1.5rem;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    /* Modern Header */
    .digital-header {
        background: var(--pacifico-gradient);
        color: white;
        border-radius: 24px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        position: relative;
        overflow: hidden;
    }

    .digital-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        pointer-events: none;
    }

    .digital-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .digital-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
    }

    /* Enhanced Table */
    .modern-table-container {
        background: white;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
        border: 1px solid rgba(44, 85, 48, 0.05);
    }

    .modern-table-header {
        background: var(--pacifico-gradient);
        color: white;
        padding: 1.5rem 2rem;
        border: none;
    }

    .modern-table-header h5 {
        font-size: 1.3rem;
        font-weight: 600;
        margin: 0;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .workflow-table {
        font-size: 0.9rem;
        margin: 0;
        border: none;
    }
    
    .workflow-table th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: none;
        font-weight: 600;
        color: var(--pacifico-primary);
        padding: 1rem 0.75rem;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
    }
    
    .workflow-table td {
        vertical-align: middle;
        border: none;
        border-bottom: 1px solid #f1f3f4;
        padding: 1rem 0.75rem;
    }

    .workflow-table tbody tr {
        transition: all 0.3s ease;
    }

    .workflow-table tbody tr:hover {
        background: linear-gradient(135deg, #f8fff9 0%, #f0f9f2 100%);
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(44, 85, 48, 0.1);
    }

    /* Enhanced Badges */
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: none;
    }

    .status-procesado {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .status-pendiente {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
    }

    /* Propietario Assignment */
    .propietario-select {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        background: white;
    }

    .propietario-select:focus {
        border-color: var(--pacifico-secondary);
        box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.1);
        outline: none;
    }

    .propietario-select:hover {
        border-color: var(--pacifico-accent);
    }

    .unassigned {
        color: #6c757d;
        font-style: italic;
    }

    .assigned {
        color: var(--pacifico-primary);
        font-weight: 600;
    }

    /* Action Buttons */
    .btn-pacifico {
        background: var(--pacifico-gradient);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(44, 85, 48, 0.2);
    }

    .btn-pacifico:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(44, 85, 48, 0.3);
        color: white;
    }

    .btn-outline-pacifico {
        border: 2px solid var(--pacifico-secondary);
        color: var(--pacifico-secondary);
        background: transparent;
        border-radius: 12px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-outline-pacifico:hover {
        background: var(--pacifico-secondary);
        color: white;
        transform: translateY(-1px);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .digital-container {
            padding: 1rem 0;
        }

        .digital-header {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .digital-header h1 {
            font-size: 1.8rem;
        }

        .kpi-number {
            font-size: 2rem;
        }
        
        .workflow-table {
            font-size: 0.8rem;
        }

        .modern-table-header {
            padding: 1rem;
        }
    }

    /* Loading Animation */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(4px);
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--pacifico-light);
        border-left: 4px solid var(--pacifico-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Success Messages */
    .success-message {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* User Management Styles */
    .avatar-sm {
        width: 36px;
        height: 36px;
        font-size: 14px;
        font-weight: 600;
    }

    .nav-tabs .nav-link {
        border: none;
        border-radius: 12px 12px 0 0;
        background: transparent;
        color: var(--pacifico-primary);
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        background: var(--pacifico-light);
        border: none;
    }

    .nav-tabs .nav-link.active {
        background: var(--pacifico-primary);
        color: white;
        border: none;
    }

    .table-hover tbody tr:hover {
        background-color: var(--pacifico-light);
    }

    .user-management-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(44, 85, 48, 0.1);
        border: 1px solid rgba(44, 85, 48, 0.05);
        transition: all 0.3s ease;
    }

    .user-management-card:hover {
        box-shadow: 0 8px 32px rgba(44, 85, 48, 0.15);
        transform: translateY(-2px);
    }

    .btn-user-action {
        border-radius: 8px;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }

    .btn-user-action:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Search Bar Styles */
    .user-search {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .user-search:focus {
        border-color: var(--pacifico-secondary);
        box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.1);
        outline: none;
    }

    .input-group-text {
        background-color: var(--pacifico-light);
        border: 2px solid #e9ecef;
        border-right: none;
        color: var(--pacifico-primary);
    }

    .user-search:focus + .input-group-text,
    .user-search:focus ~ .btn {
        border-color: var(--pacifico-secondary);
    }

    .no-results-message td {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    /* Search Animation */
    .user-row {
        transition: all 0.3s ease;
    }

    .user-row[style*="none"] {
        opacity: 0;
        transform: translateX(-10px);
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="digital-container">
    <div class="container-fluid">
        <!-- Enhanced Header -->
        <div class="digital-header">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1>
                        <i class="fas fa-mobile-alt me-3"></i>
                        Canal Digital
                    </h1>
                    <p class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Gesti√≥n avanzada de leads y solicitudes digitales
                    </p>
                </div>
                <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                    <a href="{% url 'workflow:formulario_web' %}" class="btn btn-light btn-lg" target="_blank">
                        <i class="fas fa-plus me-2"></i>
                        Nueva Solicitud Digital
                    </a>
                </div>
            </div>
        </div>

        <!-- Enhanced KPIs Row -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="kpi-card">
                    <div class="kpi-number">{{ solicitudes_canal_digital }}</div>
                    <div class="kpi-label">Total Leads</div>
                    <i class="fas fa-users digital-icon"></i>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="kpi-card">
                    <div class="kpi-number">{{ solicitudes_pendientes }}</div>
                    <div class="kpi-label">Pendientes</div>
                    <i class="fas fa-clock digital-icon"></i>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="kpi-card">
                    <div class="kpi-number">{{ solicitudes_procesadas }}</div>
                    <div class="kpi-label">Procesados</div>
                    <i class="fas fa-check-circle digital-icon"></i>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="kpi-card">
                    <div class="kpi-number">
                        {% if solicitudes_canal_digital > 0 %}
                            {{ solicitudes_procesadas|floatformat:0 }}/{{ solicitudes_canal_digital }}
                        {% else %}
                            0/0
                        {% endif %}
                    </div>
                    <div class="kpi-label">Ratio Conversi√≥n</div>
                    <i class="fas fa-chart-line digital-icon"></i>
                </div>
            </div>
        </div>

        <!-- Enhanced Table Section -->
        <div class="row">
            <div class="col-12">
                <div class="modern-table-container">
                    <div class="modern-table-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5>
                                    <i class="fas fa-table me-2"></i>
                                    Leads del Canal Digital
                                </h5>
                                <small class="opacity-75">
                                    Gestiona y asigna propietarios a los leads digitales
                                </small>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-light btn-sm" onclick="location.reload()">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    Actualizar
                                </button>
                                <button type="button" class="btn btn-light btn-sm" onclick="exportarDatos()">
                                    <i class="fas fa-download me-1"></i>
                                    Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        {% if formularios_tabla %}
                            <table class="table workflow-table" id="tablaFormularios">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-user me-1"></i>Cliente</th>
                                        <th><i class="fas fa-id-card me-1"></i>C√©dula</th>
                                        <th><i class="fas fa-phone me-1"></i>Contacto</th>
                                        <th><i class="fas fa-briefcase me-1"></i>Producto</th>
                                        <th><i class="fas fa-dollar-sign me-1"></i>Monto</th>
                                        <th><i class="fas fa-user-tie me-1"></i>Propietario</th>
                                        <th><i class="fas fa-calendar me-1"></i>Fecha</th>
                                        <th><i class="fas fa-tasks me-1"></i>Estado</th>
                                        <th><i class="fas fa-globe me-1"></i>IP</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for formulario in formularios_tabla %}
                                    <tr data-formulario-id="{{ formulario.id }}">
                                        <td>
                                            <div class="fw-bold text-dark">{{ formulario.nombre_completo }}</div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ formulario.cedula }}</span>
                                        </td>
                                        <td>
                                            <div class="small">
                                                {% if formulario.celular %}
                                                    <div><i class="fas fa-mobile-alt me-1"></i>{{ formulario.celular }}</div>
                                                {% endif %}
                                                {% if formulario.correo %}
                                                    <div><i class="fas fa-envelope me-1"></i>{{ formulario.correo }}</div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ formulario.producto_interesado }}</span>
                                        </td>
                                        <td>
                                            <span class="fw-bold text-success">{{ formulario.monto_solicitar }}</span>
                                        </td>
                                        <td>
                                            <select class="propietario-select" 
                                                    data-formulario-id="{{ formulario.id }}"
                                                    onchange="asignarPropietario(this)">
                                                <option value="">Sin asignar</option>
                                                {% for usuario in usuarios_disponibles %}
                                                    <option value="{{ usuario.id }}" 
                                                            {% if formulario.propietario and formulario.propietario.id == usuario.id %}selected{% endif %}>
                                                        {{ usuario.get_full_name|default:usuario.username }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <div class="mt-1">
                                                {% if formulario.propietario_nombre %}
                                                    <small class="assigned">
                                                        <i class="fas fa-user-check me-1"></i>{{ formulario.propietario_nombre }}
                                                    </small>
                                                {% else %}
                                                    <small class="unassigned">
                                                        <i class="fas fa-user-times me-1"></i>No asignado
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="small">
                                                <div>{{ formulario.fecha_creacion|date:"d/m/Y" }}</div>
                                                <div class="text-muted">{{ formulario.fecha_creacion|time:"H:i" }}</div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if formulario.procesado %}
                                                <span class="status-badge status-procesado">
                                                    <i class="fas fa-check me-1"></i>
                                                    Procesado
                                                </span>
                                            {% else %}
                                                <span class="status-badge status-pendiente">
                                                    <i class="fas fa-clock me-1"></i>
                                                    Pendiente
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ formulario.ip_address|default:"-" }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <!-- Enhanced Pagination -->
                            {% if formularios_page.has_other_pages %}
                            <nav aria-label="Paginaci√≥n de formularios" class="p-3">
                                <ul class="pagination justify-content-center mb-0">
                                    {% if formularios_page.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ formularios_page.previous_page_number }}">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                    
                                    {% for num in formularios_page.paginator.page_range %}
                                        {% if num == formularios_page.number %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% else %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if formularios_page.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ formularios_page.next_page_number }}">
                                                <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                            {% endif %}
                            
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-inbox text-muted mb-4" style="font-size: 5rem; opacity: 0.3;"></i>
                                <h5 class="text-muted mb-3">No hay leads a√∫n</h5>
                                <p class="text-muted mb-4">Los formularios del canal digital aparecer√°n aqu√≠</p>
                                <a href="{% url 'workflow:formulario_web' %}" class="btn btn-pacifico" target="_blank">
                                    <i class="fas fa-plus me-2"></i>
                                    Crear Primera Solicitud
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        {% if formularios_tabla %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="modern-table-container">
                    <div class="modern-table-header">
                        <h5>
                            <i class="fas fa-chart-bar me-2"></i>
                            Resumen de Asignaciones
                        </h5>
                    </div>
                    <div class="p-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="h4 text-danger mb-1">
                                        <span id="leads-sin-asignar">0</span>
                                    </div>
                                    <small class="text-muted">Leads sin asignar</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="h4 text-warning mb-1">
                                        <span id="leads-asignados">0</span>
                                    </div>
                                    <small class="text-muted">Leads asignados</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="h4 text-success mb-1">
                                        <span id="leads-procesados">{{ solicitudes_procesadas }}</span>
                                    </div>
                                    <small class="text-muted">Leads procesados</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- DEBUG INFO - REMOVE AFTER TESTING -->
        {% if user.is_superuser %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h6>üîç Debug Info (Solo visible para superusers)</h6>
                    <p><strong>Usuario actual:</strong> {{ user.username }} (ID: {{ user.id }})</p>
                    <p><strong>Es superuser:</strong> {{ user.is_superuser }}</p>
                    <p><strong>Gesti√≥n usuarios disponible:</strong> {% if gestion_usuarios %}‚úÖ S√≠{% else %}‚ùå No{% endif %}</p>
                    {% if gestion_usuarios %}
                    <p><strong>Total usuarios en grupo:</strong> {{ gestion_usuarios.total_usuarios_grupo }}</p>
                    <p><strong>Total usuarios disponibles:</strong> {{ gestion_usuarios.total_usuarios_disponibles }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Canal Digital Configuration Section - Only for Superusers -->
        {% if user.is_superuser %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="modern-table-container">
                    <div class="modern-table-header">
                        <h5>
                            <i class="fas fa-cogs me-2"></i>
                            Configuraci√≥n del Canal Digital
                        </h5>
                        <small class="opacity-75">
                            Configurar pipeline y etapa de destino para nuevas solicitudes
                        </small>
                    </div>
                    <div class="p-4">
                        <!-- Configuration Form -->
                        <form id="configForm" class="row g-3">
                            {% csrf_token %}
                            <div class="col-md-6">
                                <label for="pipelineSelect" class="form-label">
                                    <i class="fas fa-project-diagram me-1"></i>
                                    Pipeline por Defecto
                                </label>
                                <select class="form-select" id="pipelineSelect" name="pipeline_id">
                                    <option value="">Seleccionar Pipeline...</option>
                                    {% for pipeline in pipelines_disponibles %}
                                        <option value="{{ pipeline.id }}" 
                                                {% if pipeline_por_defecto and pipeline.id == pipeline_por_defecto.id %}selected{% endif %}>
                                            {{ pipeline.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    Pipeline donde se crear√°n las nuevas solicitudes del canal digital
                                </small>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="etapaSelect" class="form-label">
                                    <i class="fas fa-flag me-1"></i>
                                    Etapa por Defecto
                                </label>
                                <select class="form-select" id="etapaSelect" name="etapa_id">
                                    <option value="">Seleccionar Etapa...</option>
                                    {% if etapa_por_defecto %}
                                        <option value="{{ etapa_por_defecto.id }}" selected>
                                            {{ etapa_por_defecto.nombre }}
                                        </option>
                                    {% endif %}
                                </select>
                                <small class="form-text text-muted">
                                    Etapa inicial donde comenzar√°n las solicitudes
                                </small>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="propietarioSelect" class="form-label">
                                    <i class="fas fa-user-tie me-1"></i>
                                    Propietario por Defecto
                                </label>
                                <select class="form-select" id="propietarioSelect" name="propietario_id">
                                    <option value="">Sin propietario por defecto</option>
                                    {% for usuario in usuarios_disponibles %}
                                        <option value="{{ usuario.id }}" 
                                                {% if propietario_por_defecto and usuario.id == propietario_por_defecto.id %}selected{% endif %}>
                                            {{ usuario.get_full_name|default:usuario.username }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    Usuario que ser√° asignado autom√°ticamente como propietario de nuevos leads
                                </small>
                            </div>
                            
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <button type="button" class="btn btn-pacifico" onclick="guardarConfiguracion()">
                                            <i class="fas fa-save me-2"></i>
                                            Guardar Configuraci√≥n
                                        </button>
                                        <button type="button" class="btn btn-outline-pacifico ms-2" onclick="cargarConfiguracion()">
                                            <i class="fas fa-sync-alt me-2"></i>
                                            Recargar
                                        </button>
                                    </div>
                                    <div class="text-muted">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            Los cambios se aplicar√°n a las nuevas solicitudes del canal digital
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Current Configuration Display -->
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-project-diagram text-primary me-2"></i>
                                            Pipeline Actual
                                        </h6>
                                        <p class="card-text h5 text-primary mb-0">
                                            {{ pipeline_por_defecto.nombre|default:"No configurado" }}
                                        </p>
                                        {% if pipeline_por_defecto %}
                                            <small class="text-muted">{{ pipeline_por_defecto.descripcion|default:"Sin descripci√≥n" }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-flag text-success me-2"></i>
                                            Etapa Actual
                                        </h6>
                                        <p class="card-text h5 text-success mb-0">
                                            {{ etapa_por_defecto.nombre|default:"No configurada" }}
                                        </p>
                                        {% if etapa_por_defecto %}
                                            <small class="text-muted">
                                                SLA: {{ etapa_por_defecto.sla|default:"Sin SLA" }}
                                                {% if etapa_por_defecto.es_bandeja_grupal %}
                                                    | <span class="badge bg-info">Bandeja Grupal</span>
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-user-tie text-warning me-2"></i>
                                            Propietario Actual
                                        </h6>
                                        <p class="card-text h5 text-warning mb-0">
                                            {% if propietario_por_defecto %}
                                                {{ propietario_por_defecto.get_full_name|default:propietario_por_defecto.username }}
                                            {% else %}
                                                Sin propietario
                                            {% endif %}
                                        </p>
                                        {% if propietario_por_defecto %}
                                            <small class="text-muted">
                                                @{{ propietario_por_defecto.username }}
                                                {% if propietario_por_defecto.is_active %}
                                                    | <span class="badge bg-success">Activo</span>
                                                {% else %}
                                                    | <span class="badge bg-danger">Inactivo</span>
                                                {% endif %}
                                            </small>
                                        {% else %}
                                            <small class="text-muted">Los leads se asignar√°n manualmente</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- User Management Section - Only for Superusers -->
        {% if user.is_superuser %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="modern-table-container">
                    <div class="modern-table-header">
                        <h5>
                            <i class="fas fa-users-cog me-2"></i>
                            Gesti√≥n de Usuarios del Canal Digital
                        </h5>
                        <small class="opacity-75">
                            Administra los usuarios que tienen acceso al Canal Digital
                        </small>
                    </div>
                    <div class="p-4">
                        {% if gestion_usuarios %}
                        <!-- User Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-body text-center">
                                        <div class="h2 text-primary mb-1">{{ gestion_usuarios.total_usuarios_grupo }}</div>
                                        <small class="text-muted">Usuarios en Canal Digital</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-body text-center">
                                        <div class="h2 text-secondary mb-1">{{ gestion_usuarios.total_usuarios_disponibles }}</div>
                                        <small class="text-muted">Usuarios disponibles para agregar</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Management Actions -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-outline-success" onclick="cargarGestionUsuarios()">
                                    <i class="fas fa-sync-alt me-2"></i>
                                    Actualizar Lista de Usuarios
                                </button>
                                <button type="button" class="btn btn-outline-info ms-2" onclick="mostrarInfoGrupo()">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Info del Grupo
                                </button>
                            </div>
                        </div>

                        <!-- User Management Tabs -->
                        <ul class="nav nav-tabs" id="userManagementTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="current-users-tab" data-bs-toggle="tab" data-bs-target="#current-users" type="button" role="tab">
                                    <i class="fas fa-users me-2"></i>
                                    Usuarios Actuales ({{ gestion_usuarios.total_usuarios_grupo }})
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="available-users-tab" data-bs-toggle="tab" data-bs-target="#available-users" type="button" role="tab">
                                    <i class="fas fa-user-plus me-2"></i>
                                    Agregar Usuarios ({{ gestion_usuarios.total_usuarios_disponibles }})
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content mt-3" id="userManagementTabContent">
                            <!-- Current Users Tab -->
                            <div class="tab-pane fade show active" id="current-users" role="tabpanel">
                                {% if gestion_usuarios.usuarios_en_grupo %}
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th><i class="fas fa-user me-1"></i>Usuario</th>
                                                    <th><i class="fas fa-envelope me-1"></i>Email</th>
                                                    <th><i class="fas fa-id-badge me-1"></i>Username</th>
                                                    <th class="text-center"><i class="fas fa-cogs me-1"></i>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for usuario in gestion_usuarios.usuarios_en_grupo %}
                                                <tr id="user-row-{{ usuario.id }}">
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                                {{ usuario.first_name|first|default:usuario.username|first|upper }}
                                                            </div>
                                                            <div>
                                                                <div class="fw-medium">{{ usuario.get_full_name|default:usuario.username }}</div>
                                                                <small class="text-muted">{{ usuario.first_name }} {{ usuario.last_name }}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ usuario.email|default:"Sin email" }}</td>
                                                    <td><code>{{ usuario.username }}</code></td>
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                onclick="removerUsuarioDelGrupo({{ usuario.id }}, '{{ usuario.get_full_name|default:usuario.username|escapejs }}')">
                                                            <i class="fas fa-user-minus me-1"></i>
                                                            Remover
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center py-4">
                                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No hay usuarios en el grupo Canal Digital</h5>
                                        <p class="text-muted">Agrega usuarios desde la pesta√±a "Agregar Usuarios"</p>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Available Users Tab -->
                            <div class="tab-pane fade" id="available-users" role="tabpanel">
                                {% if gestion_usuarios.usuarios_disponibles_para_agregar %}
                                    <!-- Search Bar for Available Users -->
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                                <input type="text" 
                                                       class="form-control user-search" 
                                                       id="searchAvailableUsers"
                                                       placeholder="Buscar usuarios por nombre, email o username..."
                                                       autocomplete="off">
                                                <button class="btn btn-outline-secondary" 
                                                        type="button" 
                                                        onclick="clearSearch('searchAvailableUsers')">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Escriba para filtrar usuarios disponibles para agregar al grupo Canal Digital
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="availableUsersTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th><i class="fas fa-user me-1"></i>Usuario</th>
                                                    <th><i class="fas fa-envelope me-1"></i>Email</th>
                                                    <th><i class="fas fa-id-badge me-1"></i>Username</th>
                                                    <th class="text-center"><i class="fas fa-cogs me-1"></i>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for usuario in gestion_usuarios.usuarios_disponibles_para_agregar %}
                                                <tr id="available-user-row-{{ usuario.id }}" class="user-row">
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                                {{ usuario.first_name|first|default:usuario.username|first|upper }}
                                                            </div>
                                                            <div>
                                                                <div class="fw-medium">{{ usuario.get_full_name|default:usuario.username }}</div>
                                                                <small class="text-muted">{{ usuario.first_name }} {{ usuario.last_name }}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ usuario.email|default:"Sin email" }}</td>
                                                    <td><code>{{ usuario.username }}</code></td>
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                                onclick="agregarUsuarioAlGrupo({{ usuario.id }}, '{{ usuario.get_full_name|default:usuario.username|escapejs }}')">
                                                            <i class="fas fa-user-plus me-1"></i>
                                                            Agregar
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center py-4">
                                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                        <h5 class="text-success">Todos los usuarios activos est√°n ya en el grupo</h5>
                                        <p class="text-muted">No hay usuarios disponibles para agregar al Canal Digital</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <!-- Fallback when gestion_usuarios is not available -->
                        <div class="text-center py-4">
                            <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Gesti√≥n de usuarios no disponible</h5>
                            <p class="text-muted">Por favor, recarga la p√°gina para inicializar la gesti√≥n de usuarios.</p>
                            <button type="button" class="btn btn-pacifico" onclick="location.reload()">
                                <i class="fas fa-sync-alt me-2"></i>
                                Recargar P√°gina
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    // Animaci√≥n de KPI cards al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        const kpiCards = document.querySelectorAll('.kpi-card');
        kpiCards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'all 0.6s ease';
                
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100);
            }, index * 100);
        });
        
        // Actualizar contador de asignaciones
        actualizarContadorAsignaciones();
    });
    
    // Funci√≥n para asignar propietario
    function asignarPropietario(selectElement) {
        const formularioId = selectElement.dataset.formularioId;
        const propietarioId = selectElement.value;
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Mostrar loading
        loadingOverlay.style.display = 'flex';
        
        const data = {
            formulario_id: formularioId,
            propietario_id: propietarioId || null
        };
        
        fetch('{% url "workflow:api_asignar_propietario_formulario" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                // Actualizar la visualizaci√≥n del propietario
                const row = selectElement.closest('tr');
                const statusContainer = row.querySelector('.mt-1');
                
                if (propietarioId) {
                    const userName = selectElement.options[selectElement.selectedIndex].text;
                    statusContainer.innerHTML = `
                        <small class="assigned">
                            <i class="fas fa-user-check me-1"></i>${userName}
                        </small>
                    `;
                } else {
                    statusContainer.innerHTML = `
                        <small class="unassigned">
                            <i class="fas fa-user-times me-1"></i>No asignado
                        </small>
                    `;
                }
                
                // Actualizar contadores
                actualizarContadorAsignaciones();
                
                // Mostrar mensaje de √©xito
                mostrarToast('Propietario asignado correctamente', 'success');
            } else {
                mostrarToast(data.error, 'error');
                // Revertir la selecci√≥n en caso de error
                location.reload();
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error('Error:', error);
            mostrarToast('Error al asignar propietario', 'error');
            location.reload();
        });
    }
    
    // Funci√≥n para actualizar contadores de asignaciones
    function actualizarContadorAsignaciones() {
        const selects = document.querySelectorAll('.propietario-select');
        let sinAsignar = 0;
        let asignados = 0;
        
        selects.forEach(select => {
            if (select.value === '') {
                sinAsignar++;
            } else {
                asignados++;
            }
        });
        
        // Actualizar contadores en la UI
        const sinAsignarElement = document.getElementById('leads-sin-asignar');
        const asignadosElement = document.getElementById('leads-asignados');
        
        if (sinAsignarElement) sinAsignarElement.textContent = sinAsignar;
        if (asignadosElement) asignadosElement.textContent = asignados;
    }
    
    // Funci√≥n para exportar datos
    function exportarDatos() {
        const data = [];
        const table = document.getElementById('tablaFormularios');
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = {
                cliente: cells[0].textContent.trim(),
                cedula: cells[1].textContent.trim(),
                contacto: cells[2].textContent.trim(),
                producto: cells[3].textContent.trim(),
                monto: cells[4].textContent.trim(),
                propietario: cells[5].querySelector('.assigned, .unassigned').textContent.trim(),
                fecha: cells[6].textContent.trim(),
                estado: cells[7].textContent.trim(),
                ip: cells[8].textContent.trim()
            };
            data.push(rowData);
        });
        
        // Crear CSV
        const csv = convertToCSV(data);
        downloadCSV(csv, 'leads_canal_digital.csv');
    }
    
    function convertToCSV(objArray) {
        const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
        let str = '';
        
        // Encabezados
        const headers = Object.keys(array[0]);
        str += headers.join(',') + '\r\n';
        
        // Datos
        for (let i = 0; i < array.length; i++) {
            let line = '';
            for (let index in array[i]) {
                if (line !== '') line += ',';
                line += '"' + array[i][index] + '"';
            }
            str += line + '\r\n';
        }
        return str;
    }
    
    function downloadCSV(csv, filename) {
        const csvFile = new Blob([csv], { type: 'text/csv' });
        const downloadLink = document.createElement('a');
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }
    
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    function mostrarToast(mensaje, tipo) {
        // Crear toast simple
        const toast = document.createElement('div');
        toast.className = `alert alert-${tipo === 'success' ? 'success' : tipo === 'error' ? 'danger' : 'warning'} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
        toast.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }

    // ==========================================
    // FUNCIONES DE GESTI√ìN DE USUARIOS DEL CANAL DIGITAL
    // ==========================================

    // ==========================================
    // FUNCIONES DE CONFIGURACI√ìN DEL CANAL DIGITAL
    // ==========================================

    function cargarConfiguracion() {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'flex';

        fetch('{% url "workflow:api_obtener_configuracion_canal_digital" %}', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                // Actualizar selects
                const pipelineSelect = document.getElementById('pipelineSelect');
                const etapaSelect = document.getElementById('etapaSelect');
                const propietarioSelect = document.getElementById('propietarioSelect');
                
                if (data.configuracion && data.configuracion.pipeline_id) {
                    pipelineSelect.value = data.configuracion.pipeline_id;
                    cargarEtapasPipeline(data.configuracion.pipeline_id, data.configuracion.etapa_id);
                    
                    // Actualizar propietario por defecto
                    if (data.configuracion.propietario_id) {
                        propietarioSelect.value = data.configuracion.propietario_id;
                    } else {
                        propietarioSelect.value = '';
                    }
                }
                
                mostrarToast('Configuraci√≥n cargada correctamente', 'success');
            } else {
                mostrarToast(data.error || 'Error al cargar configuraci√≥n', 'error');
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error('Error:', error);
            mostrarToast('Error al cargar configuraci√≥n', 'error');
        });
    }

    function guardarConfiguracion() {
        const pipelineId = document.getElementById('pipelineSelect').value;
        const etapaId = document.getElementById('etapaSelect').value;
        const propietarioId = document.getElementById('propietarioSelect').value;

        if (!pipelineId || !etapaId) {
            mostrarToast('Debe seleccionar tanto el pipeline como la etapa', 'warning');
            return;
        }

        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'flex';

        const data = {
            pipeline_id: pipelineId,
            etapa_id: etapaId,
            propietario_id: propietarioId || null  // Incluir propietario (puede ser null)
        };

        fetch('{% url "workflow:api_guardar_configuracion_canal_digital" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                mostrarToast('Configuraci√≥n guardada exitosamente', 'success');
                
                // Actualizar la vista de configuraci√≥n actual
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                mostrarToast(data.error || 'Error al guardar configuraci√≥n', 'error');
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error('Error:', error);
            mostrarToast('Error al guardar configuraci√≥n', 'error');
        });
    }

    function cargarEtapasPipeline(pipelineId, etapaSeleccionada = null) {
        const etapaSelect = document.getElementById('etapaSelect');
        
        if (!pipelineId) {
            etapaSelect.innerHTML = '<option value="">Seleccionar Etapa...</option>';
            return;
        }

        fetch(`{% url "workflow:api_obtener_etapas_pipeline" pipeline_id=0 %}`.replace('0', pipelineId), {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                etapaSelect.innerHTML = '<option value="">Seleccionar Etapa...</option>';
                
                data.etapas.forEach(etapa => {
                    const option = document.createElement('option');
                    option.value = etapa.id;
                    option.textContent = `${etapa.nombre} (Orden: ${etapa.orden})`;
                    
                    if (etapaSeleccionada && etapa.id == etapaSeleccionada) {
                        option.selected = true;
                    }
                    
                    etapaSelect.appendChild(option);
                });
            } else {
                mostrarToast('Error al cargar etapas', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarToast('Error al cargar etapas', 'error');
        });
    }

    function cargarGestionUsuarios() {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'flex';

        // Recargar la p√°gina para obtener datos actualizados
        setTimeout(() => {
            location.reload();
        }, 500);
    }

    function mostrarInfoGrupo() {
        const info = `
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>Informaci√≥n del Grupo "Canal Digital"</h6>
            <ul class="mb-0">
                <li>Los usuarios en este grupo pueden ser asignados como propietarios de leads del canal digital</li>
                <li>Solo los usuarios de este grupo aparecer√°n en el dropdown de propietarios</li>
                <li>Los superusuarios pueden gestionar la membres√≠a de este grupo</li>
                <li>El grupo se crea autom√°ticamente si no existe</li>
            </ul>
        </div>
        `;
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = info;
        tempDiv.style.position = 'fixed';
        tempDiv.style.top = '50%';
        tempDiv.style.left = '50%';
        tempDiv.style.transform = 'translate(-50%, -50%)';
        tempDiv.style.zIndex = '10000';
        tempDiv.style.backgroundColor = 'white';
        tempDiv.style.padding = '20px';
        tempDiv.style.borderRadius = '8px';
        tempDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        tempDiv.style.maxWidth = '500px';
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.className = 'btn-close position-absolute top-0 end-0 m-2';
        closeBtn.onclick = () => document.body.removeChild(tempDiv);
        
        tempDiv.appendChild(closeBtn);
        document.body.appendChild(tempDiv);
        
        setTimeout(() => {
            if (document.body.contains(tempDiv)) {
                document.body.removeChild(tempDiv);
            }
        }, 5000);
    }

    // Event listener para cambio de pipeline
    document.addEventListener('DOMContentLoaded', function() {
        const pipelineSelect = document.getElementById('pipelineSelect');
        if (pipelineSelect) {
            pipelineSelect.addEventListener('change', function() {
                cargarEtapasPipeline(this.value);
            });
        }
    });

    function agregarUsuarioAlGrupo(userId, userName) {
        if (!confirm(`¬øEst√° seguro de agregar a ${userName} al grupo "Canal Digital"?`)) {
            return;
        }

        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'flex';

        const data = {
            user_id: userId
        };

        fetch('{% url "workflow:api_agregar_usuario_canal_digital" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                mostrarToast(data.mensaje, 'success');
                
                // Remover la fila de la tabla de usuarios disponibles
                const availableRow = document.getElementById(`available-user-row-${userId}`);
                if (availableRow) {
                    availableRow.remove();
                }
                
                // Recargar la p√°gina despu√©s de un breve delay para mostrar cambios
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                mostrarToast(data.error, 'error');
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error('Error:', error);
            mostrarToast('Error al agregar usuario al grupo', 'error');
        });
    }

    function removerUsuarioDelGrupo(userId, userName) {
        if (!confirm(`¬øEst√° seguro de remover a ${userName} del grupo "Canal Digital"?\n\nEsto eliminar√° su acceso al Canal Digital y no podr√° ser asignado como propietario de leads.`)) {
            return;
        }

        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'flex';

        const data = {
            user_id: userId
        };

        fetch('{% url "workflow:api_remover_usuario_canal_digital" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                mostrarToast(data.mensaje, 'success');
                
                // Remover la fila de la tabla de usuarios actuales
                const userRow = document.getElementById(`user-row-${userId}`);
                if (userRow) {
                    userRow.remove();
                }
                
                // Recargar la p√°gina despu√©s de un breve delay para mostrar cambios
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                mostrarToast(data.error, 'error');
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error('Error:', error);
            mostrarToast('Error al remover usuario del grupo', 'error');
        });
    }

    // Inicializar tooltips y funcionalidades adicionales para gesti√≥n de usuarios
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar tooltips de Bootstrap si est√°n disponibles
        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Configurar funcionalidad de b√∫squeda para usuarios disponibles
        setupUserSearch();
    });

    function setupUserSearch() {
        const searchInput = document.getElementById('searchAvailableUsers');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                filterAvailableUsers(this.value);
            });
        }
    }

    function filterAvailableUsers(searchTerm) {
        const table = document.getElementById('availableUsersTable');
        if (!table) return;
        
        const rows = table.querySelectorAll('tbody tr.user-row');
        const normalizedSearch = searchTerm.toLowerCase().trim();
        
        let visibleCount = 0;
        
        rows.forEach(row => {
            const userNameElement = row.querySelector('.fw-medium');
            const emailElement = row.querySelector('td:nth-child(2)');
            const usernameElement = row.querySelector('code');
            
            const userName = userNameElement ? userNameElement.textContent.toLowerCase() : '';
            const email = emailElement ? emailElement.textContent.toLowerCase() : '';
            const username = usernameElement ? usernameElement.textContent.toLowerCase() : '';
            
            const matches = userName.includes(normalizedSearch) || 
                           email.includes(normalizedSearch) || 
                           username.includes(normalizedSearch);
            
            if (matches || normalizedSearch === '') {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Mostrar mensaje si no hay resultados
        updateSearchResults(visibleCount, normalizedSearch, table);
    }

    function updateSearchResults(visibleCount, searchTerm, table) {
        // Remover mensaje anterior si existe
        const existingMessage = table.querySelector('.no-results-message');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        if (visibleCount === 0 && searchTerm !== '') {
            // Crear mensaje de "no hay resultados"
            const tbody = table.querySelector('tbody');
            const noResultsRow = document.createElement('tr');
            noResultsRow.className = 'no-results-message';
            noResultsRow.innerHTML = `
                <td colspan="4" class="text-center py-4">
                    <i class="fas fa-search fa-2x text-muted mb-2"></i>
                    <h6 class="text-muted">No se encontraron usuarios</h6>
                    <p class="text-muted mb-0">No hay usuarios que coincidan con "${searchTerm}"</p>
                </td>
            `;
            tbody.appendChild(noResultsRow);
        }
    }

    function clearSearch(inputId) {
        const searchInput = document.getElementById(inputId);
        if (searchInput) {
            searchInput.value = '';
            if (inputId === 'searchAvailableUsers') {
                filterAvailableUsers('');
            }
            searchInput.focus();
        }
    }
</script>
{% endblock %}
