{% extends "workflow/base.html" %}
{% load static %}
{% load workflow_filters %}

{% block title %}Back Office - Captura - Sistema de Workflow{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'workflow/css/detalleSolicitud.css' %}" />
{% include "workflow/partials/backoffice_styles.html" %}
<style>
/* Estilos específicos para la vista de Captura */
.captura-container {
  background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
  border: 2px solid #2196f3;
  border-radius: 15px;
  padding: 2rem;
  margin: 1rem 0;
}



.document-preview {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 1rem;
  margin: 0.5rem 0;
  background: white;
  transition: all 0.3s ease;
}

.document-preview:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}

/* Estilos para el indicador de progreso */
.process-step-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  border: 1px solid #e9ecef;
  border-radius: 12px;
  padding: 1rem 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.step-indicator {
  display: flex;
  align-items: baseline;
  font-weight: bold;
}

.step-number {
  font-size: 2rem;
  color: #2196f3;
  font-weight: 700;
}

.step-total {
  font-size: 1.2rem;
  color: #6c757d;
  margin-left: 2px;
}

.subestado-icon {
  font-size: 2.5rem;
  color: #2196f3;
  opacity: 0.8;
}

.step-status .badge {
  font-size: 0.9rem;
  padding: 0.5rem 1rem;
  font-weight: 500;
}

/* Estilos para botones de acción */
.action-buttons {
  text-align: center;
  margin-top: 2rem;
  padding: 1.5rem;
  border-top: 1px solid #e9ecef;
  background: rgba(255, 255, 255, 0.5);
  border-radius: 0 0 15px 15px;
  margin-left: -2rem;
  margin-right: -2rem;
  margin-bottom: -2rem;
}

/* Estilos específicos para la sección de pendientes */
.pendientes-card {
  border: none;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  border-radius: 12px;
  overflow: hidden;
}

.pendientes-card .card-header {
  background: linear-gradient(135deg, #2196f3, #1976d2);
  border: none;
  color: #ffffff;
}

.filtros-pendientes .btn-check:checked + .btn {
  background-color: var(--bs-primary);
  border-color: var(--bs-primary);
  color: white;
}

.filtros-pendientes .btn-outline-danger:hover,
.filtros-pendientes .btn-check:checked + .btn-outline-danger {
  background-color: #dc3545;
  border-color: #dc3545;
  color: white;
}

.filtros-pendientes .btn-outline-warning:hover,
.filtros-pendientes .btn-check:checked + .btn-outline-warning {
  background-color: #ffc107;
  border-color: #ffc107;
  color: #212529;
}

.filtros-pendientes .btn-outline-primary:hover,
.filtros-pendientes .btn-check:checked + .btn-outline-primary {
  background-color: #2196f3;
  border-color: #2196f3;
  color: #ffffff;
}

.filtros-pendientes .btn-outline-success:hover,
.filtros-pendientes .btn-check:checked + .btn-outline-success {
  background-color: #198754;
  border-color: #198754;
  color: white;
}

.pendiente-item:hover {
  background-color: #f8f9fa;
}

.estado-dropdown {
  min-width: 120px;
}

#tabla-pendientes thead th {
  background-color: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
  color: #495057;
  position: sticky;
  top: 0;
  z-index: 10;
}

#tabla-pendientes tbody tr:hover {
  background-color: rgba(0,123,255,0.05);
}

/* Estilos para el modal de agregar pendientes */
#modalAgregarPendientes .modal-header {
  background: linear-gradient(135deg, #2196f3, #1976d2);
  color: #ffffff;
  border-bottom: none;
}

#modalAgregarPendientes .pendiente-item {
  transition: all 0.3s ease;
  border-radius: 8px;
  margin: 2px 0;
}

#modalAgregarPendientes .pendiente-item:hover {
  background-color: #e3f2fd;
  transform: translateX(2px);
}

.bg-gradient-primary {
  background: linear-gradient(135deg, #2196f3, #1976d2) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <!-- Header de la Solicitud -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header processes-header">
          <div class="d-flex align-items-center justify-content-between">
            <!-- Sección Izquierda: Icono y Títulos -->
            <div class="d-flex align-items-center">
              <div class="process-icon-container">
                <i class="fas fa-tasks"></i>
              </div>
              <div class="ms-3">
                <h5 class="mb-0 process-title">Procesos de Back Office</h5>
                <small class="process-subtitle">Gestión completa del flujo de trabajo</small>
              </div>
            </div>

            <!-- Sección Central: Información del Negocio -->
            <div class="d-flex align-items-center justify-content-center flex-wrap gap-2">
              {% if solicitud.cliente_nombre_completo or solicitud.cotizacion.nombreCliente %}
              <span class="mini-badge mini-badge-primary">
                <i class="fas fa-user"></i>
                {{ solicitud.cliente_nombre_completo|default:solicitud.cotizacion.nombreCliente }}
              </span>
              {% endif %}
              
              {% if solicitud.cotizacion.montoPrestamo %}
              <span class="mini-badge mini-badge-warning">
                <i class="fas fa-dollar-sign"></i>
                B/. {{ solicitud.cotizacion.montoPrestamo|floatformat:0 }}
              </span>
              {% endif %}
              
              {% if solicitud.cotizacion.tipoPrestamo %}
              <span class="mini-badge mini-badge-info">
                <i class="fas fa-briefcase"></i>
                {{ solicitud.cotizacion.get_tipoPrestamo_display|default:solicitud.cotizacion.tipoPrestamo|title }}
              </span>
              {% endif %}
              
              <span class="mini-badge mini-badge-success">
                <i class="fas fa-file-alt"></i>
                {{ solicitud.codigo }}
              </span>
            </div>

            <!-- Sección Derecha: Badge de Etapas -->
            <div class="process-badge">
              <span class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>
                {{ solicitud.etapa_actual.subestados.count }} Etapas
              </span>
            </div>
          </div>
        </div>

        {% csrf_token %}

        <div class="card-body p-0">
          <!-- Navegación entre Subestados -->
          <div class="nav-tabs-container">
            <ul class="nav nav-tabs nav-tabs-modern d-flex flex-column flex-md-row" id="backoffice-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <a href="{% url 'backoffice_checklist' solicitud.id %}" 
                   class="nav-link tab-modern {% if solicitud.subestado_actual.nombre == 'Checklist' %}active{% endif %}">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">1</div>
                    <div class="tab-text">
                      <span class="tab-title">Checklist</span>
                      <span class="tab-status">{% if solicitud.subestado_actual.nombre == 'Checklist' %}Activo{% else %}Disponible{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </a>
              </li>
              <li class="nav-item" role="presentation">
                <a href="{% url 'backoffice_captura' solicitud.id %}" 
                   class="nav-link tab-modern {% if solicitud.subestado_actual.nombre == 'Captura' %}active{% endif %}">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">2</div>
                    <div class="tab-text">
                      <span class="tab-title">Captura</span>
                      <span class="tab-status">{% if solicitud.subestado_actual.nombre == 'Captura' %}Activo{% else %}Disponible{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </a>
              </li>
              <li class="nav-item" role="presentation">
                <a href="{% url 'backoffice_firma' solicitud.id %}" 
                   class="nav-link tab-modern {% if solicitud.subestado_actual.nombre == 'Firma' %}active{% endif %}">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">3</div>
                    <div class="tab-text">
                      <span class="tab-title">Firma</span>
                      <span class="tab-status">{% if solicitud.subestado_actual.nombre == 'Firma' %}Activo{% else %}Disponible{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </a>
              </li>
              <li class="nav-item" role="presentation">
                <a href="{% url 'backoffice_orden' solicitud.id %}" 
                   class="nav-link tab-modern {% if solicitud.subestado_actual.nombre == 'Orden del expediente' %}active{% endif %}">
                  <div class="tab-content-wrapper">
                    <div class="tab-number">4</div>
                    <div class="tab-text">
                      <span class="tab-title">Orden del expediente</span>
                      <span class="tab-status">{% if solicitud.subestado_actual.nombre == 'Orden del expediente' %}Activo{% else %}Disponible{% endif %}</span>
                    </div>
                    <div class="tab-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </a>
              </li>
            </ul>
          </div>

          <!-- Contenido Principal - Captura -->
          <div class="captura-container">
            <!-- Indicador de Progreso -->
            <div class="process-step-header">
              <div class="step-indicator">
                <span class="step-number">2</span>
                <span class="step-total">/ 4</span>
              </div>
              <div class="subestado-icon">
                <i class="fas fa-camera"></i>
              </div>
              <div class="step-status">
                <span class="badge bg-primary">
                  <i class="fas fa-cog me-1"></i>Procesando
                </span>
              </div>
            </div>



            <!-- Sección de Asociar Entrevista de Cliente -->
            <div class="mt-4 mb-4">
              <div class="alert alert-info">
                <div class="d-flex align-items-center">
                  <i class="fas fa-user-edit text-info me-3" style="font-size: 1.5rem;"></i>
                  <div>
                    <strong>Asociar Entrevista de Cliente</strong><br>
                    <small>Vincule los datos generales del cliente con esta solicitud.</small>
                  </div>
                  <div class="ms-auto">
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="mostrarModalEntrevista()">
                      <i class="fas fa-link me-1"></i> Asociar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sección de Pendientes Antes de Firma -->
            <div class="mt-4 mb-4">
              <div class="card pendientes-card">
                <div class="card-header bg-gradient-primary text-white">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-clipboard-list me-2" style="font-size: 1.2rem;"></i>
                      <div>
                        <h6 class="mb-0 fw-bold">Pendientes Antes de Firma</h6>
                        <small class="opacity-75">Gestión de tareas pendientes para esta solicitud</small>
                      </div>
                    </div>
                    <button type="button" class="btn btn-light btn-sm" onclick="mostrarModalAgregarPendientes()">
                      <i class="fas fa-plus me-1"></i> Agregar Pendientes
                    </button>
                  </div>
                </div>
                <div class="card-body p-0">
                  <!-- Filtros de la tabla -->
                  <div class="px-3 py-2 border-bottom">
                    <div class="row align-items-center">
                      <div class="col-md-6">
                        <div class="btn-group btn-group-sm filtros-pendientes" role="group">
                          <input type="radio" class="btn-check" name="filtro-estado" id="filtro-todos" value="todos" checked>
                          <label class="btn btn-outline-secondary" for="filtro-todos">
                            <i class="fas fa-list me-1"></i>Todos
                          </label>
                          
                          <input type="radio" class="btn-check" name="filtro-estado" id="filtro-por-hacer" value="por_hacer">
                          <label class="btn btn-outline-danger" for="filtro-por-hacer">
                            <i class="fas fa-circle me-1"></i>Por Hacer
                          </label>
                          
                          <input type="radio" class="btn-check" name="filtro-estado" id="filtro-haciendo" value="haciendo">
                          <label class="btn btn-outline-warning" for="filtro-haciendo">
                            <i class="fas fa-circle me-1"></i>Haciendo
                          </label>
                          
                          <input type="radio" class="btn-check" name="filtro-estado" id="filtro-listo" value="listo">
                          <label class="btn btn-outline-success" for="filtro-listo">
                            <i class="fas fa-circle me-1"></i>Listo
                          </label>
                        </div>
                      </div>
                      <div class="col-md-6 text-end">
                        <span class="badge bg-info" id="contador-pendientes">0 pendientes</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Tabla de pendientes -->
                  <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover table-sm mb-0" id="tabla-pendientes">
                      <thead class="table-light sticky-top">
                        <tr>
                          <th style="width: 35%;">Pendiente</th>
                          <th style="width: 15%;">Estado</th>
                          <th style="width: 20%;">Agregado Por</th>
                          <th style="width: 15%;">Fecha</th>
                          <th style="width: 15%;">Acciones</th>
                        </tr>
                      </thead>
                      <tbody id="lista-pendientes">
                        <!-- Los pendientes se cargarán aquí dinámicamente -->
                      </tbody>
                    </table>
                  </div>
                  
                  <!-- Mensaje cuando no hay pendientes -->
                  <div id="mensaje-sin-pendientes" class="text-center p-4 text-muted" style="display: none;">
                    <i class="fas fa-clipboard-check fa-2x mb-2 opacity-50"></i>
                    <p class="mb-0">No hay pendientes asignados a esta solicitud</p>
                    <small>Utilice el botón "Agregar Pendientes" para comenzar</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botones de Acción -->
            <div class="action-buttons">
              <!-- Botón de avance - siempre habilitado, validación al hacer clic -->
              <button id="btn-avanzar-subestado" type="button" class="btn btn-success btn-lg" onclick="validarDocumentosYAvanzar()">
                <i class="fas fa-arrow-right me-2"></i>
                <span id="btn-avanzar-texto">Avanzar</span>
              </button>
              
              <!-- Botón Devolver a Oficial - se muestra solo si hay transiciones negativas -->
              <button id="btn-devolver-oficial" type="button" class="btn btn-warning btn-lg ms-2" style="display: inline-block;" onclick="mostrarModalDevolucion()">
                <i class="fas fa-arrow-left me-2"></i>
                <span>Devolver a Oficial</span>
              </button>
              
              <!-- Indicador de estado de validación -->
              <div id="validacion-estado" class="mt-2">
                <small class="text-muted">
                  <i class="fas fa-check-circle text-success me-1"></i>
                  <span id="validacion-mensaje">Listo para avanzar</span>
                </small>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts específicos para Captura -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Vista de Captura cargada para solicitud:', '{{ solicitud.id }}');
});

  // =======================================================
  // FUNCIONALIDAD PARA ASOCIAR ENTREVISTA DE CLIENTE
  // =======================================================

  let entrevistaSeleccionadaId = null;

  // Función para mostrar modal de entrevista
  function mostrarModalEntrevista() {
    // Obtener datos del cliente de la solicitud actual
    const clienteNombre = "{{ solicitud.cliente_nombre_completo|default:'Cliente' }}";
    const clienteCedula = "{{ solicitud.cliente_cedula_completa|default:'No disponible' }}";
    
    // Actualizar el encabezado del modal con los datos del cliente
    document.getElementById('clienteNombreModal').textContent = clienteNombre;
    document.getElementById('clienteCedulaModal').textContent = clienteCedula;
    document.getElementById('filteredByCedula').textContent = clienteCedula;
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalAsociarEntrevista'));
    modal.show();
    
    // Limpiar búsqueda anterior y configurarla con la cédula del cliente
    const inputBusqueda = document.getElementById('buscarEntrevista');
    inputBusqueda.value = '';
    inputBusqueda.placeholder = `Buscar por nombre o email (ya filtrado por cédula)`;
    
    // Automáticamente buscar entrevistas con la misma cédula
    buscarEntrevistasPorCedula(clienteCedula);
    document.getElementById('resultadosEntrevistas').innerHTML = '';
    document.getElementById('entrevistaSeleccionada').style.display = 'none';
    document.getElementById('btnConfirmarAsociacion').disabled = true;
    entrevistaSeleccionadaId = null;
  }

  function buscarEntrevistasPorCedula(cedula) {
    if (!cedula || cedula === 'No disponible') {
      document.getElementById('resultadosEntrevistas').innerHTML = 
        '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No se puede buscar entrevistas porque la solicitud no tiene un número de cédula asociado.</div>';
      return;
    }
    
    // Mostrar loading
    document.getElementById('resultadosEntrevistas').innerHTML = 
      '<div class="text-center p-3"><i class="fas fa-spinner fa-spin me-2"></i> Buscando entrevistas para la cédula ' + cedula + '...</div>';
    
    // Realizar búsqueda AJAX filtrando por cédula
    fetch(`/workflow/buscar-entrevistas/?cedula=${encodeURIComponent(cedula)}`)
      .then(response => response.json())
      .then(data => {
        // Mostrar mensaje sobre la búsqueda flexible
        const mensajeFlexible = `
          <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-3">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-500"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm text-blue-700">
                  <strong>Búsqueda inteligente:</strong> El sistema busca entrevistas que tengan una cédula similar a <strong>${cedula}</strong>, 
                  incluso si el formato de escritura es diferente.
                </p>
                <p class="text-sm text-blue-700 mt-1">
                  <i class="fas fa-shield-alt text-blue-600 me-1"></i>
                <div class="d-flex align-items-center">
                  <strong>Nota:</strong> Por seguridad, solo puede seleccionar entrevistas con coincidencia exacta o parcial de cédula.
                  <button type="button" class="btn btn-link text-info p-0 ml-1" onclick="mostrarInfoCoincidencias()">
                    <i class="fas fa-info-circle"></i>
                  </button>
                </div>
                </p>
              </div>
            </div>
          </div>
        `;
        
        const container = document.getElementById('resultadosEntrevistas');
        container.innerHTML = mensajeFlexible;
        mostrarResultadosEntrevistas(data.entrevistas, cedula);
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('resultadosEntrevistas').innerHTML = 
          '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al buscar entrevistas</div>';
      });
  }

  function buscarEntrevistas() {
    const termino = document.getElementById('buscarEntrevista').value.trim();
    const clienteCedula = "{{ solicitud.cliente_cedula_completa|default:'No disponible' }}";
    
    if (termino.length < 3) {
      // Si no hay término de búsqueda, volvemos a la búsqueda por cédula
      buscarEntrevistasPorCedula(clienteCedula);
      return;
    }
    
    // Mostrar loading
    document.getElementById('resultadosEntrevistas').innerHTML = 
      '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i> Buscando...</div>';
    
    // Realizar búsqueda AJAX con filtro adicional de cédula
    fetch(`/workflow/buscar-entrevistas/?q=${encodeURIComponent(termino)}&cedula=${encodeURIComponent(clienteCedula)}`)
      .then(response => response.json())
      .then(data => {
        mostrarResultadosEntrevistas(data.entrevistas, clienteCedula);
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('resultadosEntrevistas').innerHTML = 
          '<div class="alert alert-danger">Error al buscar entrevistas</div>';
      });
  }

  function mostrarResultadosEntrevistas(entrevistas, cedula) {
    const container = document.getElementById('resultadosEntrevistas');
    
    // Función para comparar similitud entre cédulas
    function compararCedulas(cedula1, cedula2) {
      // 1. Normalizar cedulas para comparación (mantener números y letras, quitar guiones y espacios)
      const normalizada1 = cedula1.replace(/[-\s]/g, '').toUpperCase();
      const normalizada2 = cedula2.replace(/[-\s]/g, '').toUpperCase();
      
      // Coincidencia exacta después de normalizar
      if (normalizada1 === normalizada2) return 'exacta';
      
      // 2. Extraer números y letras por separado
      const numerosYLetras1 = normalizada1.match(/[0-9A-Z]/g) || [];
      const numerosYLetras2 = normalizada2.match(/[0-9A-Z]/g) || [];
      
      // Verificar si las versiones sin caracteres especiales coinciden
      if (numerosYLetras1.join('') === numerosYLetras2.join('')) return 'exacta';
      
      // 3. Extraer solo números para comparación numérica
      const numeros1 = normalizada1.replace(/[^0-9]/g, '');
      const numeros2 = normalizada2.replace(/[^0-9]/g, '');
      
      // Si ambas tienen números
      if (numeros1.length > 0 && numeros2.length > 0) {
        // 4. Comparar primeros dígitos (entre 3-4 dígitos iniciales)
        const primerDigitos1 = numeros1.substring(0, Math.min(4, numeros1.length));
        const primerDigitos2 = numeros2.substring(0, Math.min(4, numeros2.length));
        
        // 5. Comparar últimos dígitos (6-8 dígitos finales)
        const ultimosDigitos1 = numeros1.length > 6 ? numeros1.slice(-8) : numeros1;
        const ultimosDigitos2 = numeros2.length > 6 ? numeros2.slice(-8) : numeros2;
        
        // Si coinciden los primeros o últimos dígitos significativos
        if ((primerDigitos1 === primerDigitos2 && primerDigitos1.length >= 3) || 
            (ultimosDigitos1 === ultimosDigitos2 && ultimosDigitos1.length >= 4)) {
          return 'parcial';
        }
        
        // 6. Calcular distancia de Levenshtein para detectar errores de tipografía
        // Solo si las longitudes son similares (diferencia máxima de 2 caracteres)
        if (Math.abs(numeros1.length - numeros2.length) <= 2) {
          const distancia = levenshteinDistance(numeros1, numeros2);
          // Si la distancia es pequeña en relación al tamaño de la cédula (máximo 2 caracteres diferentes)
          if (distancia <= 2) {
            return 'parcial';
          }
        }
        
        // 7. Verificar si al menos la mitad de los caracteres coinciden (para cédulas de longitud similar)
        if (Math.abs(normalizada1.length - normalizada2.length) <= 3) {
          let coincidencias = 0;
          const minLength = Math.min(normalizada1.length, normalizada2.length);
          
          // Contar caracteres coincidentes en las mismas posiciones
          for (let i = 0; i < minLength; i++) {
            if (normalizada1[i] === normalizada2[i]) {
              coincidencias++;
            }
          }
          
          // Si coinciden más del 70% de los caracteres
          if (coincidencias >= 0.7 * minLength) {
            return 'parcial';
          }
        }
      }
      
      // 8. Comparar letras (importante para extranjeros)
      const letras1 = normalizada1.replace(/[^A-Z]/g, '');
      const letras2 = normalizada2.replace(/[^A-Z]/g, '');
      
      // Si ambas tienen la misma letra de extranjero y algunos dígitos coinciden
      if (letras1 && letras2 && letras1 === letras2) {
        // Verificar si al menos algunos dígitos coinciden
        if (numeros1 && numeros2 && 
            (numeros1.includes(numeros2.slice(-4)) || numeros2.includes(numeros1.slice(-4)))) {
          return 'parcial';
        }
      }
      
      return 'ninguna';
    }
    
    // Función para calcular distancia de Levenshtein (para comparación fuzzy)
    function levenshteinDistance(a, b) {
      if (a.length === 0) return b.length;
      if (b.length === 0) return a.length;
      
      const matrix = [];
      
      // Inicializar matriz
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      
      // Rellenar matriz
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          const costo = a[j - 1] === b[i - 1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i - 1][j] + 1,      // eliminación
            matrix[i][j - 1] + 1,      // inserción
            matrix[i - 1][j - 1] + costo  // sustitución
          );
        }
      }
      
      return matrix[b.length][a.length];
    }
    
    if (entrevistas.length === 0) {
      const mensajeNoEntrevistas = `
        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-3">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <i class="fas fa-info-circle text-yellow-500"></i>
            </div>
            <div class="ml-3">
              <p class="text-sm text-yellow-700">
                No se encontraron entrevistas para la cédula <strong>${cedula}</strong>
              </p>
            </div>
          </div>
        </div>`;
      
      // Agregamos el mensaje al contenido existente (no reemplazamos)
      container.innerHTML += mensajeNoEntrevistas;
      return;
    }
    
    let html = `
      <div class="divide-y divide-gray-200 max-h-[50vh] overflow-y-auto px-1 py-2 rounded-md shadow-inner bg-gray-50">`;
    
    entrevistas.forEach(entrevista => {
      const coincidencia = compararCedulas(entrevista.cedula, cedula);
      let rowClass, badgeClass, badgeText;
      
      let cursorStyle, onclickAttr;
      
      if (coincidencia === 'exacta') {
        rowClass = 'bg-green-50 border border-green-200 shadow-sm hover:shadow-md';
        badgeClass = 'bg-green-100 text-green-800';
        badgeText = '<i class="fas fa-check-circle mr-1"></i>Coincidencia exacta';
        cursorStyle = 'cursor-pointer';
        onclickAttr = `onclick="seleccionarEntrevista(${entrevista.id}, '${entrevista.nombre_completo}', '${entrevista.cedula}')"`;
      } else if (coincidencia === 'parcial') {
        rowClass = 'bg-blue-50 border border-blue-200 shadow-sm hover:shadow-md'; 
        badgeClass = 'bg-blue-100 text-blue-800';
        badgeText = '<i class="fas fa-check mr-1"></i>Coincidencia parcial';
        cursorStyle = 'cursor-pointer';
        onclickAttr = `onclick="seleccionarEntrevista(${entrevista.id}, '${entrevista.nombre_completo}', '${entrevista.cedula}')"`;
      } else {
        rowClass = 'bg-gray-50 opacity-70'; // Gris claro para mostrar que está deshabilitado
        badgeClass = 'bg-red-100 text-red-800';
        badgeText = '<i class="fas fa-times-circle mr-1"></i>Sin coincidencia';
        cursorStyle = 'cursor-not-allowed';
        onclickAttr = `onclick="mostrarMensajeCoincidencia('${entrevista.cedula}', '${cedula}')"`;
      }
      
      html += `
        <div class="p-4 hover:bg-gray-100 rounded-md ${cursorStyle} transition-all duration-300 ${rowClass} mb-2" 
             ${onclickAttr}>
          <div class="flex justify-between items-start">
            <div>
              <h6 class="font-medium text-gray-900 mb-1">${entrevista.nombre_completo}</h6>
              <p class="text-gray-800 font-mono mb-1">
                <strong class="text-gray-600">Cédula:</strong> ${entrevista.cedula}
                <span class="inline-flex items-center ml-2 px-2 py-0.5 rounded-full text-xs font-medium ${badgeClass}">
                  ${badgeText}
                </span>
              </p>
              <p class="text-gray-600 text-sm">
                <strong>Email:</strong> ${entrevista.email || 'No disponible'} | 
                <strong>Teléfono:</strong> ${entrevista.telefono || 'No disponible'}
              </p>
            </div>
            <div class="flex flex-col items-end">
              <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${entrevista.tipo_producto || 'Sin producto'}</span>
              <small class="text-gray-500 mt-2">${entrevista.fecha_entrevista || 'Fecha no disponible'}</small>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    container.innerHTML = html;
  }
  
  // Función para mostrar detalles sobre las coincidencias
  function mostrarInfoCoincidencias() {
    Swal.fire({
      title: 'Criterios de Coincidencia de Cédulas',
      html: `
        <div class="text-left">
          <h5 class="font-weight-bold mb-3">Coincidencia Exacta:</h5>
          <ul class="pl-4">
            <li>Cédulas idénticas después de normalizar (eliminar guiones y espacios)</li>
            <li>Mismos caracteres alfanuméricos en el mismo orden</li>
          </ul>
          
          <h5 class="font-weight-bold mb-3 mt-4">Coincidencia Parcial:</h5>
          <ul class="pl-4">
            <li>Coinciden los primeros 3-4 dígitos <strong>o</strong> los últimos 4-8 dígitos</li>
            <li>Cédulas que difieren en máximo 2 caracteres (errores tipográficos)</li>
            <li>Más del 70% de caracteres coinciden en las mismas posiciones</li>
            <li>Misma letra para extranjeros con algunos dígitos coincidentes</li>
          </ul>
          
          <div class="alert alert-info mt-3">
            <i class="fas fa-lightbulb mr-2"></i>
            <strong>Ejemplos de coincidencia parcial:</strong>
            <ul class="mb-0 mt-1">
              <li>"8-123-456" y "8123456" (mismos dígitos, formato diferente)</li>
              <li>"1-E-234-567" y "E234567" (letra de extranjero igual)</li>
              <li>"9-876-5432" y "9-876-5431" (error tipográfico en un dígito)</li>
              <li>"10-123-456" y "123-456" (últimos 6 dígitos iguales)</li>
            </ul>
          </div>
        </div>
      `,
      icon: 'info',
      confirmButtonText: 'Entendido'
    });
  }

  function seleccionarEntrevista(id, nombre, cedula) {
    const clienteCedula = "{{ solicitud.cliente_cedula_completa|default:'No disponible' }}";
    
    // Función para comparar coincidencia entre cédulas (versión simplificada para esta función)
    function compararCedulas(cedula1, cedula2) {
      if (!cedula1 || !cedula2 || cedula1 === 'No disponible' || cedula2 === 'No disponible') return 'ninguna';
      
      // Normalizar cedulas para comparación (mantener números y letras, quitar guiones y espacios)
      const normalizada1 = cedula1.replace(/[-\s]/g, '').toUpperCase();
      const normalizada2 = cedula2.replace(/[-\s]/g, '').toUpperCase();
      
      // Coincidencia exacta después de normalizar
      if (normalizada1 === normalizada2) return 'exacta';
      
      // Verificación básica de coincidencia parcial para esta función
      const numeros1 = normalizada1.replace(/[^0-9]/g, '');
      const numeros2 = normalizada2.replace(/[^0-9]/g, '');
      
      if (numeros1.length > 0 && numeros2.length > 0) {
        // Comparar primeros y últimos dígitos
        const primerDigitos1 = numeros1.substring(0, Math.min(4, numeros1.length));
        const primerDigitos2 = numeros2.substring(0, Math.min(4, numeros2.length));
        const ultimosDigitos1 = numeros1.length > 6 ? numeros1.slice(-8) : numeros1;
        const ultimosDigitos2 = numeros2.length > 6 ? numeros2.slice(-8) : numeros2;
        
        if ((primerDigitos1 === primerDigitos2 && primerDigitos1.length >= 3) || 
            (ultimosDigitos1 === ultimosDigitos2 && ultimosDigitos1.length >= 4)) {
          return 'parcial';
        }
      }
      
      return 'ninguna';
    }
    
    // Verificar el tipo de coincidencia entre cédulas
    const coincidencia = compararCedulas(cedula, clienteCedula);
    
    // Solo permitir seleccionar si hay coincidencia exacta o parcial
    if (coincidencia === 'ninguna') {
      Swal.fire({
        title: 'No se puede asociar',
        html: `<p>La cédula de esta entrevista <strong>(${cedula})</strong> no coincide con la cédula del cliente de la solicitud <strong>(${clienteCedula})</strong>.</p>
              <p class="mt-2">Por motivos de seguridad, solo puede asociar entrevistas con coincidencia exacta o parcial de cédula.</p>`,
        icon: 'error',
        confirmButtonText: 'Entendido'
      });
      return;
    }
    
    entrevistaSeleccionadaId = id;
    
    // Animar el scroll hacia la sección de entrevista seleccionada
    const entrevistaSeleccionadaEl = document.getElementById('entrevistaSeleccionada');
    
    // Mostrar entrevista seleccionada con animación
    document.getElementById('nombreEntrevistaSeleccionada').textContent = nombre;
    document.getElementById('cedulaEntrevistaSeleccionada').textContent = cedula;
    
    // Aplicar animación
    entrevistaSeleccionadaEl.style.opacity = '0';
    entrevistaSeleccionadaEl.style.transform = 'translateY(20px)';
    entrevistaSeleccionadaEl.style.display = 'block';
    
    // Efecto de aparición
    setTimeout(() => {
      entrevistaSeleccionadaEl.style.opacity = '1';
      entrevistaSeleccionadaEl.style.transform = 'translateY(0)';
    }, 10);
    
    // Scroll suave hasta la sección
    setTimeout(() => {
      entrevistaSeleccionadaEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 300);
    
    // Habilitar botón de confirmación
    document.getElementById('btnConfirmarAsociacion').disabled = false;
    
    // Resaltar selección con animación
    document.querySelectorAll('.p-4[onclick]').forEach(item => {
      item.classList.remove('ring-2', 'ring-green-500', 'bg-green-100');
    });
    
    const selectedItem = event.target.closest('.p-4');
    if (selectedItem) {
      selectedItem.classList.add('ring-2', 'ring-green-500', 'bg-green-100');
    }
  }

  function mostrarMensajeCoincidencia(cedulaEntrevista, cedulaSolicitud) {
    // Muestra un mensaje de error cuando intentan seleccionar una entrevista sin coincidencia
    Swal.fire({
      title: 'No se puede asociar',
      html: `<p>La cédula de esta entrevista <strong>(${cedulaEntrevista})</strong> no coincide con la cédula del cliente de la solicitud <strong>(${cedulaSolicitud})</strong>.</p>
             <p class="mt-2">Por motivos de seguridad, solo puede asociar entrevistas con coincidencia exacta o parcial de cédula.</p>`,
      icon: 'error',
      confirmButtonText: 'Entendido'
    });
  }

  function confirmarAsociacion() {
    if (!entrevistaSeleccionadaId) return;
    
    const solicitudId = {{ solicitud.id }};
    
    // Mostrar loading en el botón
    const btn = document.getElementById('btnConfirmarAsociacion');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Asociando...';
    btn.disabled = true;
    
    // Realizar asociación AJAX
    fetch('/workflow/asociar-entrevista/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({
        solicitud_id: solicitudId,
        entrevista_id: entrevistaSeleccionadaId,
        accion: 'asociar'
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('modalAsociarEntrevista')).hide();
        
        // Mostrar mensaje de éxito
        mostrarMensaje('Entrevista asociada correctamente', 'success');
        
        // Recargar la página para mostrar la entrevista asociada
        setTimeout(() => {
          location.reload();
        }, 1500);
        
      } else {
        mostrarMensaje(data.error || 'Error al asociar entrevista', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      mostrarMensaje('Error al asociar entrevista', 'error');
    })
    .finally(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  }

  function desasociarEntrevista() {
    const solicitudId = {{ solicitud.id }};
    
    if (!confirm('¿Está seguro de que desea desasociar la entrevista de esta solicitud?')) {
      return;
    }
    
    fetch('/workflow/asociar-entrevista/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({
        solicitud_id: solicitudId,
        accion: 'desasociar'
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        mostrarMensaje('Entrevista desasociada correctamente', 'success');
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        mostrarMensaje(data.error || 'Error al desasociar entrevista', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      mostrarMensaje('Error al desasociar entrevista', 'error');
    });
  }

  function verDetallesEntrevista(entrevistaId) {
    // Abrir modal o página con detalles de la entrevista
    window.open(`/workflow/entrevista/${entrevistaId}/`, '_blank');
  }

  // Función para obtener el token CSRF
  function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
           getCookie('csrftoken');
  }

  // Función auxiliar para obtener cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Función para mostrar mensajes toast
  function mostrarMensaje(mensaje, tipo) {
    // Crear un toast simple si no existe sistema más avanzado
    const toast = document.createElement('div');
    toast.className = `alert alert-${tipo === 'success' ? 'success' : tipo === 'error' ? 'danger' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${mensaje}
      </div>
    `;
    document.body.appendChild(toast);
    
    // Auto-remover después de 3 segundos
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

// Funciones para botones de acción
function validarDocumentosYAvanzar() {
    alert('Funcionalidad de validación y avance - En desarrollo');
    console.log('Validando documentos para solicitud:', '{{ solicitud.id }}');
}

function mostrarModalDevolucion() {
    alert('Funcionalidad de devolución a oficial - En desarrollo');
    console.log('Mostrando modal de devolución para solicitud:', '{{ solicitud.id }}');
}

// =======================================================
// FUNCIONALIDAD PARA PENDIENTES ANTES DE FIRMA
// =======================================================

let pendientesSeleccionados = [];
let todosLosPendientes = [];

// Función para mostrar modal de agregar pendientes
function mostrarModalAgregarPendientes() {
    const modal = new bootstrap.Modal(document.getElementById('modalAgregarPendientes'));
    modal.show();
    
    // Limpiar estado al abrir modal
    pendientesSeleccionados = [];
    actualizarVistaSeleccionados();
    
    // Cargar pendientes automáticamente
    buscarPendientesEnCatalogo();
}

// Función para buscar pendientes en el catálogo
function buscarPendientesEnCatalogo() {
    const query = document.getElementById('buscarPendientes').value.trim();
    const loadingElement = document.getElementById('loading-pendientes');
    const resultadosElement = document.getElementById('resultados-pendientes');
    
    // Mostrar loading
    resultadosElement.innerHTML = '<div class="text-center p-4 text-muted" id="loading-pendientes"><i class="fas fa-spinner fa-spin me-2"></i>Buscando pendientes...</div>';
    
    // Realizar búsqueda
    const url = query ? `/workflow/api/pendientes/catalogo/?q=${encodeURIComponent(query)}` : '/workflow/api/pendientes/catalogo/';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                todosLosPendientes = data.pendientes;
                mostrarResultadosPendientes(data.pendientes);
                document.getElementById('contador-resultados').textContent = `${data.pendientes.length} resultado${data.pendientes.length !== 1 ? 's' : ''}`;
            } else {
                resultadosElement.innerHTML = `<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-circle me-2"></i>Error: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultadosElement.innerHTML = '<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al cargar pendientes</div>';
        });
}

// Función para mostrar los resultados de pendientes
function mostrarResultadosPendientes(pendientes) {
    const container = document.getElementById('resultados-pendientes');
    
    if (pendientes.length === 0) {
        container.innerHTML = '<div class="text-center p-4 text-muted"><i class="fas fa-inbox me-2"></i>No se encontraron pendientes</div>';
        return;
    }
    
    let html = '';
    pendientes.forEach(pendiente => {
        const yaSeleccionado = pendientesSeleccionados.some(p => p.id === pendiente.id);
                 const claseBoton = yaSeleccionado ? 'btn-outline-success disabled' : 'btn-outline-primary';
        const textoBoton = yaSeleccionado ? '<i class="fas fa-check me-1"></i>Seleccionado' : '<i class="fas fa-plus me-1"></i>Seleccionar';
        
        html += `
            <div class="border-bottom p-3 pendiente-item" data-pendiente-id="${pendiente.id}">
                <div class="d-flex align-items-start justify-content-between">
                    <div class="flex-grow-1">
                        <h6 class="mb-1 fw-bold text-dark">${pendiente.nombre}</h6>
                        ${pendiente.descripcion ? `<p class="mb-2 text-muted small">${pendiente.descripcion}</p>` : ''}
                        <div class="d-flex align-items-center text-muted small">
                            <span class="badge bg-light text-dark me-2">
                                <i class="fas fa-sort-numeric-up me-1"></i>Orden: ${pendiente.orden}
                            </span>
                        </div>
                    </div>
                    <div class="ms-3">
                        <button type="button" class="btn btn-sm ${claseBoton}" 
                                onclick="seleccionarPendiente(${pendiente.id}, '${pendiente.nombre.replace(/'/g, "\\'")}', '${(pendiente.descripcion || '').replace(/'/g, "\\'")}')"
                                ${yaSeleccionado ? 'disabled' : ''}>
                            ${textoBoton}
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Función para seleccionar un pendiente
function seleccionarPendiente(id, nombre, descripcion) {
    // Verificar si ya está seleccionado
    if (pendientesSeleccionados.some(p => p.id === id)) {
        return;
    }
    
    // Agregar al array de seleccionados
    pendientesSeleccionados.push({
        id: id,
        nombre: nombre,
        descripcion: descripcion
    });
    
    // Actualizar vistas
    actualizarVistaSeleccionados();
    mostrarResultadosPendientes(todosLosPendientes); // Refrescar lista para mostrar como seleccionado
}

// Función para quitar un pendiente seleccionado
function quitarPendienteSeleccionado(id) {
    pendientesSeleccionados = pendientesSeleccionados.filter(p => p.id !== id);
    actualizarVistaSeleccionados();
    mostrarResultadosPendientes(todosLosPendientes); // Refrescar lista
}

// Función para limpiar todos los seleccionados
function limpiarSeleccionados() {
    pendientesSeleccionados = [];
    actualizarVistaSeleccionados();
    mostrarResultadosPendientes(todosLosPendientes); // Refrescar lista
}

// Función para actualizar la vista de seleccionados
function actualizarVistaSeleccionados() {
    const seccionSeleccionados = document.getElementById('seccion-seleccionados');
    const listaSeleccionados = document.getElementById('lista-seleccionados');
    const contadorSeleccionados = document.getElementById('contador-seleccionados');
    const btnConfirmar = document.getElementById('btn-confirmar-pendientes');
    
    if (pendientesSeleccionados.length === 0) {
        seccionSeleccionados.style.display = 'none';
        btnConfirmar.disabled = true;
        return;
    }
    
    seccionSeleccionados.style.display = 'block';
    btnConfirmar.disabled = false;
    contadorSeleccionados.textContent = `${pendientesSeleccionados.length} seleccionado${pendientesSeleccionados.length !== 1 ? 's' : ''}`;
    
    let html = '';
    pendientesSeleccionados.forEach(pendiente => {
        html += `
            <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-white border rounded">
                <div>
                    <span class="fw-bold text-success">${pendiente.nombre}</span>
                    ${pendiente.descripcion ? `<br><small class="text-muted">${pendiente.descripcion}</small>` : ''}
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="quitarPendienteSeleccionado(${pendiente.id})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    
    listaSeleccionados.innerHTML = html;
}

// Función para confirmar agregar pendientes
function confirmarAgregarPendientes() {
    if (pendientesSeleccionados.length === 0) {
        return;
    }
    
    const solicitudId = {{ solicitud.id }};
    const pendientesIds = pendientesSeleccionados.map(p => p.id);
    const btnConfirmar = document.getElementById('btn-confirmar-pendientes');
    
    // Mostrar loading
    const textoOriginal = btnConfirmar.innerHTML;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Agregando...';
    btnConfirmar.disabled = true;
    
    // Realizar petición
    fetch(`/workflow/api/solicitudes/${solicitudId}/pendientes/agregar/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            pendientes_ids: pendientesIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('modalAgregarPendientes')).hide();
            
            // Mostrar mensaje de éxito
            mostrarMensaje(data.message, 'success');
            
            // Recargar lista de pendientes
            cargarPendientesSolicitud();
        } else {
            mostrarMensaje(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error al agregar pendientes', 'error');
    })
    .finally(() => {
        btnConfirmar.innerHTML = textoOriginal;
        btnConfirmar.disabled = false;
    });
}

// Función para cargar pendientes de la solicitud
function cargarPendientesSolicitud() {
    const solicitudId = {{ solicitud.id }};
    
    fetch(`/workflow/api/solicitudes/${solicitudId}/pendientes/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarPendientesEnTabla(data.pendientes);
                actualizarContadorPendientes(data.pendientes);
            } else {
                console.error('Error al cargar pendientes:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// Función para mostrar pendientes en la tabla
function mostrarPendientesEnTabla(pendientes) {
    const tbody = document.getElementById('lista-pendientes');
    const mensajeSinPendientes = document.getElementById('mensaje-sin-pendientes');
    
    if (pendientes.length === 0) {
        tbody.innerHTML = '';
        mensajeSinPendientes.style.display = 'block';
        return;
    }
    
    mensajeSinPendientes.style.display = 'none';
    
    let html = '';
    pendientes.forEach(pendiente => {
        // Determinar clases CSS para el estado
        let estadoClass, estadoIcon;
        switch (pendiente.estado) {
            case 'por_hacer':
                estadoClass = 'text-danger';
                estadoIcon = 'fas fa-circle';
                break;
            case 'haciendo':
                estadoClass = 'text-warning';
                estadoIcon = 'fas fa-circle';
                break;
            case 'listo':
                estadoClass = 'text-success';
                estadoIcon = 'fas fa-check-circle';
                break;
            default:
                estadoClass = 'text-muted';
                estadoIcon = 'fas fa-question-circle';
        }
        
        html += `
            <tr data-pendiente-id="${pendiente.id}" data-estado="${pendiente.estado}">
                <td>
                    <div>
                        <span class="fw-bold">${pendiente.pendiente.nombre}</span>
                        ${pendiente.pendiente.descripcion ? `<br><small class="text-muted">${pendiente.pendiente.descripcion}</small>` : ''}
                    </div>
                </td>
                <td>
                    <select class="form-select form-select-sm estado-dropdown" onchange="cambiarEstadoPendiente(${pendiente.id}, this.value)">
                        <option value="por_hacer" ${pendiente.estado === 'por_hacer' ? 'selected' : ''}>Por Hacer</option>
                        <option value="haciendo" ${pendiente.estado === 'haciendo' ? 'selected' : ''}>Haciendo</option>
                        <option value="listo" ${pendiente.estado === 'listo' ? 'selected' : ''}>Listo</option>
                    </select>
                </td>
                <td>
                    <div>
                        <span class="fw-bold">${pendiente.agregado_por.nombre_completo}</span>
                        <br><small class="text-muted">@${pendiente.agregado_por.username}</small>
                    </div>
                </td>
                <td>
                    <span class="small">${pendiente.fecha_agregado_display}</span>
                    ${pendiente.fecha_completado_display ? `<br><small class="text-success"><i class="fas fa-check me-1"></i>${pendiente.fecha_completado_display}</small>` : ''}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="eliminarPendiente(${pendiente.id}, '${pendiente.pendiente.nombre.replace(/'/g, "\\'")}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Función para cambiar estado de pendiente
function cambiarEstadoPendiente(pendienteId, nuevoEstado) {
    const dropdown = event.target;
    const estadoOriginal = dropdown.dataset.estadoOriginal || dropdown.value;
    
    // Deshabilitar dropdown mientras se procesa
    dropdown.disabled = true;
    
    fetch(`/workflow/api/pendientes/${pendienteId}/cambiar-estado/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            estado: nuevoEstado
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje(data.message, 'success');
            dropdown.dataset.estadoOriginal = nuevoEstado;
            
            // Actualizar la fila visualmente si es necesario
            const fila = dropdown.closest('tr');
            fila.dataset.estado = nuevoEstado;
            
            // Aplicar filtro actual
            aplicarFiltroPendientes();
        } else {
            // Revertir al estado original
            dropdown.value = estadoOriginal;
            mostrarMensaje(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        dropdown.value = estadoOriginal;
        mostrarMensaje('Error al cambiar estado', 'error');
    })
    .finally(() => {
        dropdown.disabled = false;
    });
}

// Función para eliminar pendiente
function eliminarPendiente(pendienteId, nombrePendiente) {
    if (!confirm(`¿Está seguro de que desea eliminar el pendiente "${nombrePendiente}"?`)) {
        return;
    }
    
    fetch(`/workflow/api/pendientes/${pendienteId}/eliminar/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje(data.message, 'success');
            cargarPendientesSolicitud(); // Recargar lista
        } else {
            mostrarMensaje(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error al eliminar pendiente', 'error');
    });
}

// Función para actualizar contador de pendientes
function actualizarContadorPendientes(pendientes) {
    const contador = document.getElementById('contador-pendientes');
    const total = pendientes.length;
    
    if (total === 0) {
        contador.textContent = 'Sin pendientes';
        contador.className = 'badge bg-secondary';
    } else {
        const porHacer = pendientes.filter(p => p.estado === 'por_hacer').length;
        const haciendo = pendientes.filter(p => p.estado === 'haciendo').length;
        const listo = pendientes.filter(p => p.estado === 'listo').length;
        
        contador.innerHTML = `
            <i class="fas fa-clipboard-list me-1"></i>
            ${porHacer} por hacer, ${haciendo} haciendo, ${listo} listo
        `;
        contador.className = 'badge bg-info';
    }
}

// Función para aplicar filtros a la tabla
function aplicarFiltroPendientes() {
    const filtroSeleccionado = document.querySelector('input[name="filtro-estado"]:checked').value;
    const filas = document.querySelectorAll('#lista-pendientes tr');
    let filasMostradas = 0;
    
    filas.forEach(fila => {
        const estadoFila = fila.dataset.estado;
        
        if (filtroSeleccionado === 'todos' || estadoFila === filtroSeleccionado) {
            fila.style.display = '';
            filasMostradas++;
        } else {
            fila.style.display = 'none';
        }
    });
    
    // Actualizar contador
    const total = filas.length;
    const contadorElement = document.getElementById('contador-pendientes');
    if (filtroSeleccionado === 'todos') {
        contadorElement.textContent = `${total} pendientes`;
    } else {
        const estadoTexto = {
            'por_hacer': 'Por Hacer',
            'haciendo': 'Haciendo',
            'listo': 'Listo'
        };
        contadorElement.textContent = `${filasMostradas} ${estadoTexto[filtroSeleccionado]}`;
    }
}

// Event listeners para filtros
document.addEventListener('DOMContentLoaded', function() {
    // Cargar pendientes al cargar la página
    cargarPendientesSolicitud();
    
    // Event listeners para filtros
    document.querySelectorAll('input[name="filtro-estado"]').forEach(radio => {
        radio.addEventListener('change', aplicarFiltroPendientes);
    });
});
</script>

<!-- Modal para Asociar Entrevista -->
<div class="modal fade" id="modalAsociarEntrevista" tabindex="-1" aria-labelledby="modalAsociarEntrevistaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-white border-b p-4 sticky-top shadow-sm">
        <div>
          <h5 class="modal-title text-lg font-medium mb-2" id="modalAsociarEntrevistaLabel">
            <i class="fas fa-user-edit me-2 text-blue-600"></i>Asociar Entrevista de Cliente
          </h5>
          <div class="flex flex-col bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
            <div class="text-gray-800 mb-1">
              <i class="fas fa-user me-1 text-blue-600"></i>
              <strong>Cliente:</strong> <span id="clienteNombreModal" class="font-semibold ml-1">Cargando...</span>
            </div>
            <div class="text-gray-800">
              <i class="fas fa-id-card me-1 text-blue-600"></i>
              <strong>Cédula:</strong> <span id="clienteCedulaModal" class="font-mono font-semibold ml-1">Cargando...</span>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4" style="max-height: 60vh; overflow-y: auto;">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 sticky top-0 z-10">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-shield-alt text-yellow-400"></i>
            </div>
            <div class="ml-3">
              <div class="d-flex align-items-center">
                <p class="text-sm text-yellow-700 mb-0">
                  <strong>Seguridad:</strong> Por seguridad, solo puede seleccionar entrevistas con coincidencia exacta o parcial de cédula.
                  <button type="button" class="btn btn-link text-yellow-700 p-0 ml-1" onclick="mostrarInfoCoincidencias()">
                    <i class="fas fa-info-circle"></i>
                  </button>
                </p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-4 sticky top-20 z-10 pt-2 pb-2 bg-white">
          <label for="buscarEntrevista" class="block text-sm font-medium text-gray-700 mb-1">Buscar Entrevista</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-gray-400"></i>
            </div>
            <input type="text" class="form-control pl-10" id="buscarEntrevista" 
                   placeholder="Refinar búsqueda por nombre o email (opcional)..."
                   onkeyup="buscarEntrevistas()">
          </div>
          <div class="text-xs text-gray-500 mt-1">
            <i class="fas fa-filter me-1"></i>Ya filtrado por cédula: <span id="filteredByCedula" class="font-mono">Cargando...</span>
          </div>
        </div>
        
        <div id="resultadosEntrevistas" class="mt-4 transition-all duration-300">
          <!-- Aquí se cargarán los resultados -->
        </div>
        
        <div id="entrevistaSeleccionada" class="mt-4 p-4 border-2 border-green-500 rounded-md bg-green-50 shadow-sm transition-all duration-300" style="display: none;">
          <div class="flex items-center mb-2">
            <div class="flex-shrink-0">
              <i class="fas fa-check-circle text-green-500 text-xl"></i>
            </div>
            <div class="ml-3">
              <div class="mb-1">
                <strong class="text-gray-700">Entrevista seleccionada:</strong>
                <span id="nombreEntrevistaSeleccionada" class="font-medium"></span>
              </div>
              <div class="text-sm">
                <strong class="text-gray-700">Cédula:</strong>
                <span id="cedulaEntrevistaSeleccionada" class="font-mono font-medium"></span>
                <span class="inline-flex items-center ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  <i class="fas fa-shield-alt mr-1"></i>Verificada
                </span>
              </div>
            </div>
          </div>
          <div class="bg-white p-3 rounded-md border border-gray-200 mt-2 text-sm">
            <p class="text-gray-700 mb-0">
              <i class="fas fa-info-circle text-blue-600 mr-1"></i>
              Esta acción vinculará los datos de la entrevista seleccionada con la solicitud actual.
              <br>Solo se asocian entrevistas del mismo cliente por motivos de seguridad.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-gray-50 p-3 sticky-bottom shadow-sm">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Cancelar
        </button>
        <button type="button" class="btn btn-success" id="btnConfirmarAsociacion" onclick="confirmarAsociacion()" disabled>
          <i class="fas fa-link me-1"></i> Confirmar Asociación
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Agregar Pendientes Antes de Firma -->
<div class="modal fade" id="modalAgregarPendientes" tabindex="-1" aria-labelledby="modalAgregarPendientesLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <div>
          <h5 class="modal-title fw-bold" id="modalAgregarPendientesLabel">
            <i class="fas fa-clipboard-list me-2"></i>Agregar Pendientes Antes de Firma
          </h5>
          <small class="d-block mt-1 opacity-75">Seleccione uno o varios pendientes para agregar a esta solicitud</small>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Buscador de pendientes -->
        <div class="mb-4">
          <label for="buscarPendientes" class="form-label fw-bold">
            <i class="fas fa-search me-1"></i>Buscar Pendientes
          </label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search text-muted"></i>
            </span>
            <input type="text" class="form-control" id="buscarPendientes" 
                   placeholder="Escriba el nombre del pendiente que desea buscar..."
                   oninput="buscarPendientesEnCatalogo()">
          </div>
          <small class="form-text text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Los resultados se actualizan automáticamente mientras escribe
          </small>
        </div>

        <!-- Resultados de la búsqueda -->
        <div class="mb-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="mb-0 fw-bold text-secondary">
              <i class="fas fa-list me-1"></i>Pendientes Disponibles
            </h6>
            <span class="badge bg-info" id="contador-resultados">0 resultados</span>
          </div>
          
          <!-- Lista de pendientes disponibles -->
          <div id="resultados-pendientes" class="border rounded" style="max-height: 300px; overflow-y: auto;">
            <div class="text-center p-4 text-muted" id="loading-pendientes">
              <i class="fas fa-spinner fa-spin me-2"></i>Cargando pendientes...
            </div>
          </div>
        </div>

        <!-- Pendientes seleccionados -->
        <div id="seccion-seleccionados" style="display: none;">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="mb-0 fw-bold text-success">
              <i class="fas fa-check-square me-1"></i>Pendientes Seleccionados
            </h6>
            <div>
              <span class="badge bg-success" id="contador-seleccionados">0 seleccionados</span>
              <button type="button" class="btn btn-outline-danger btn-sm ms-2" onclick="limpiarSeleccionados()">
                <i class="fas fa-trash me-1"></i>Limpiar
              </button>
            </div>
          </div>
          
          <div id="lista-seleccionados" class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
            <!-- Los pendientes seleccionados aparecerán aquí -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-primary" id="btn-confirmar-pendientes" onclick="confirmarAgregarPendientes()" disabled>
          <i class="fas fa-plus me-1"></i>Agregar Pendientes
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
