{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}Tracking {{ tracking_type|title }} Makito{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2d5a2d;
        --primary-hover: #1e5f2a;
        --background-color: #f8fafc;
        --card-background: #ffffff;
        --border-color: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --border-radius: 12px;
        --border-radius-sm: 8px;
    }

    /* Override with Pacifico green if available */
    .tracking-container {
        --primary-color: var(--verde-pacifico, #2d5a2d) !important;
    }

    /* Ensure styles are applied with higher specificity */
    body .tracking-container {
        padding: 24px;
        background: var(--background-color);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    body .tracking-header {
        background: var(--card-background) !important;
        border-radius: var(--border-radius);
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    body .tracking-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
    }
    
    body .tracking-filters {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }
    
    body .tracking-table-container {
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-transform: capitalize;
    }
    
    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
    }
    
    .status-in_progress {
        background-color: #dbeafe;
        color: #1e40af;
        border: 1px solid #3b82f6;
        animation: pulse 2s infinite;
    }
    
    .status-completed {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }
    
    .status-error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
    }
    
    /* Tipo Solicitud Badge Styles */
    .tipo-badge {
        padding: 6px 12px;
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .tipo-badge.apc {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        border: 1px solid #3b82f6;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }
    
    .tipo-badge.sura {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        border: 1px solid #f59e0b;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
    }
    
    .tipo-badge.debida_diligencia {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
        border: 1px solid #ef4444;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }
    
    .tracking-table {
        width: 100%;
        margin: 0;
        border-collapse: collapse;
        font-size: 0.875rem;
    }
    
    .tracking-table th,
    .tracking-table td {
        padding: 16px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    .tracking-table th {
        background: #f8fafc;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .tracking-table th:first-child {
        border-top-left-radius: var(--border-radius);
    }

    .tracking-table th:last-child {
        border-top-right-radius: var(--border-radius);
    }
    
    .tracking-table tbody tr {
        transition: all 0.2s ease;
        background: #ffffff;
        position: relative;
    }

    .tracking-table tbody tr:hover {
        background: #f8fafc;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    }

    .tracking-table tbody tr {
        cursor: pointer;
    }

    .tracking-table tbody tr::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 1px;
        background: var(--border-color);
        transition: all 0.2s ease;
    }

    .tracking-table tbody tr:hover::after {
        background: var(--primary-color);
        height: 2px;
    }

    .tracking-table tbody tr:active {
        transform: translateY(0);
    }

    .tracking-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    body .refresh-btn {
        background: var(--primary-color) !important;
        border: none !important;
        color: white !important;
        padding: 12px 24px !important;
        border-radius: var(--border-radius-sm) !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
        transition: all 0.2s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 8px !important;
        box-shadow: var(--shadow-sm) !important;
    }
    
    body .refresh-btn:hover {
        background: var(--primary-hover) !important;
        transform: translateY(-2px) !important;
        box-shadow: var(--shadow-md) !important;
    }

    body .refresh-btn:active {
        transform: translateY(0) !important;
    }
    
    .filter-row {
        display: flex;
        gap: 16px;
        align-items: end;
        flex-wrap: wrap;
    }

    @media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 200px;
    }
    
    .filter-group label {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
    }
    
    .filter-group select,
    .filter-group input {
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        background: white;
        transition: all 0.2s ease;
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .filter-group select:hover,
    .filter-group input:hover {
        border-color: var(--primary-color);
    }

    /* Quick Search Styles */
    .search-container input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .search-container input:hover {
        border-color: var(--primary-color);
    }

    #clearSearch:hover {
        background-color: #f3f4f6;
    }

    /* Search Results Highlighting */
    .search-highlight {
        background-color: #fef3c7;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 600;
    }
    
    .no-data {
        text-align: center;
        padding: 64px 32px;
        color: var(--text-muted);
    }

    .no-data i {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .no-data p {
        font-size: 1.125rem;
        margin: 0;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    @media (max-width: 768px) {
        .stats-row {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
    }

    @media (max-width: 480px) {
        .stats-row {
            grid-template-columns: 1fr;
        }
    }
    
    body .stat-card {
        background: var(--card-background) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: var(--border-radius) !important;
        padding: 24px !important;
        box-shadow: var(--shadow-sm) !important;
        transition: all 0.2s ease !important;
        position: relative !important;
        overflow: hidden !important;
    }

    body .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-color);
    }

    body .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md) !important;
    }
    
    body .stat-number {
        font-size: 2rem !important;
        font-weight: 700 !important;
        color: var(--primary-color) !important;
        margin-bottom: 8px !important;
        line-height: 1 !important;
    }
    
    body .stat-label {
        color: var(--text-secondary) !important;
        font-size: 0.875rem !important;
        font-weight: 500 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.05em !important;
    }
    
    /* Estilos específicos para estadísticas por tipo */
    body .stat-card.stat-info {
        border-left: 4px solid #007bff !important;
    }
    
    body .stat-card.stat-info .stat-number {
        color: #007bff !important;
    }
    
    body .stat-card.stat-warning {
        border-left: 4px solid #ffc107 !important;
    }
    
    body .stat-card.stat-warning .stat-number {
        color: #ffc107 !important;
    }
    
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 64px;
        color: var(--text-muted);
        font-size: 1.125rem;
    }
    
    .spinner {
        display: inline-block;
        width: 32px;
        height: 32px;
        border: 3px solid var(--border-color);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s linear infinite;
        margin-right: 12px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-title i {
        color: var(--primary-color);
    }

    .header-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .header-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
        font-weight: 500;
    }

    .btn-action {
        padding: 8px 16px;
        border-radius: var(--border-radius-sm);
        font-size: 0.8rem;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        background: var(--primary-color);
        color: white;
    }

    .btn-action:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
        color: white;
        text-decoration: none;
    }
    
    .btn-action.warning {
        background: #f59e0b;
        color: white;
    }
    
    .btn-action.warning:hover {
        background: #d97706;
        color: white;
    }

    .table-responsive {
        overflow-x: auto;
        max-height: 70vh;
        border-radius: var(--border-radius);
    }

    /* Custom scrollbar styling for webkit browsers */
    .table-responsive::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }

    /* Ensure table maintains minimum width for scrolling */
    .tracking-table {
        min-width: 1200px;
    }

    /* Column width optimization for better responsive behavior */
    .tracking-table th:nth-child(1), .tracking-table td:nth-child(1) { /* Código */
        width: 120px;
        min-width: 120px;
    }
    
    .tracking-table th:nth-child(2), .tracking-table td:nth-child(2) { /* Tipo Solicitud */
        width: 100px;
        min-width: 100px;
    }
    
    .tracking-table th:nth-child(3), .tracking-table td:nth-child(3) { /* Cliente */
        width: 180px;
        min-width: 160px;
    }
    
    .tracking-table th:nth-child(4), .tracking-table td:nth-child(4) { /* Documento */
        width: 120px;
        min-width: 120px;
    }
    
    .tracking-table th:nth-child(5), .tracking-table td:nth-child(5) { /* Estado */
        width: 130px;
        min-width: 130px;
    }
    
    .tracking-table th:nth-child(6), .tracking-table td:nth-child(6) { /* Pipeline */
        width: 140px;
        min-width: 140px;
    }
    
    .tracking-table th:nth-child(7), .tracking-table td:nth-child(7) { /* Solicitado por */
        width: 140px;
        min-width: 140px;
    }
    
    .tracking-table th:nth-child(8), .tracking-table td:nth-child(8) { /* Fecha Solicitud */
        width: 110px;
        min-width: 110px;
    }
    
    .tracking-table th:nth-child(9), .tracking-table td:nth-child(9) { /* Fecha Inicio */
        width: 110px;
        min-width: 110px;
    }
    
    .tracking-table th:nth-child(10), .tracking-table td:nth-child(10) { /* Fecha Completado */
        width: 110px;
        min-width: 110px;
    }
    
    .tracking-table th:nth-child(11), .tracking-table td:nth-child(11) { /* Archivo */
        width: 120px;
        min-width: 120px;
    }
    
    .tracking-table th:nth-child(12), .tracking-table td:nth-child(12) { /* Observaciones */
        width: 180px;
        min-width: 160px;
    }
    


    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    .modal-header h2 {
        margin: 0;
        color: var(--primary-color);
        font-size: 1.25rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .btn-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }

    .btn-close:hover {
        background: var(--border-color);
        color: var(--text-primary);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background: #f8fafc;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Timeline Styles */
    .timeline {
        position: relative;
        padding-left: 32px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 16px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 24px;
        padding: 16px;
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-sm);
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -24px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary-color);
        border: 3px solid var(--card-background);
        box-shadow: 0 0 0 2px var(--primary-color);
    }

    .timeline-item:last-child {
        margin-bottom: 0;
    }

    .timeline-content {
        margin-left: 16px;
    }

    .timeline-content strong {
        display: block;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .timeline-content small {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .timeline-content p {
        margin: 8px 0 0 0;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    /* File Actions */
    .file-actions {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .btn-preview,
    .btn-download {
        background: var(--card-background);
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        padding: 12px 20px;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
    }

    .btn-preview:hover,
    .btn-download:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .btn-download {
        background: var(--primary-color);
        color: white;
    }

    .btn-download:hover {
        background: var(--primary-hover);
    }

    /* Observaciones */
    .observaciones-content {
        background: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        padding: 16px;
        color: var(--text-primary);
        line-height: 1.6;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(20px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive Modal */
    @media (max-width: 768px) {
        .modal-overlay {
            padding: 10px;
        }

        .modal-content {
            max-height: 95vh;
        }

        .modal-header {
            padding: 16px;
        }

        .modal-body {
            padding: 16px;
        }

        .timeline {
            padding-left: 24px;
        }

        .timeline-item::before {
            left: -16px;
        }
    }

</style>
{% endblock %}

{% block content %}
<div class="tracking-container">
    <div class="tracking-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="header-title">
                    <i class="fas {% if tracking_type == 'sura' %}fa-file-contract{% elif tracking_type == 'unified' %}fa-tasks{% else %}fa-download{% endif %} me-3"></i>
                    Tracking {{ tracking_type|title }} Makito
                </h1>
                <p class="header-subtitle">
                    {% if tracking_type == 'sura' %}
                        Seguimiento de cotizaciones de pólizas SURA procesadas por Makito RPA
                    {% elif tracking_type == 'unified' %}
                        Seguimiento unificado de solicitudes APC, SURA y Debida Diligencia procesadas por Makito RPA
                    {% else %}
                        Seguimiento de descargas APC procesadas por Makito RPA
                    {% endif %}
                </p>
            </div>
            <div class="d-flex gap-2">
                <button class="refresh-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    Actualizar
                </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="stats-row" id="statsContainer">
        <!-- Las estadísticas se cargarán dinámicamente -->
    </div>

    <!-- Filtros -->
    <div class="tracking-filters">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title mb-0">
                <i class="fas fa-filter"></i>
                Filtros
            </h2>
        </div>
        
        <div class="filter-row">
            <div class="filter-group">
                <label for="statusFilter">Estado</label>
                <select id="statusFilter" class="form-select">
                    <option value="">Todos los estados</option>
                    <option value="pending">Pendiente</option>
                    <option value="in_progress">En Proceso</option>
                    <option value="completed">Completado</option>
                    <option value="error">Error</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="pipelineFilter">Pipeline</label>
                <select id="pipelineFilter" class="form-select">
                    <option value="">Todos los pipelines</option>
                    <!-- Se llenarán dinámicamente -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="fechaDesde">Fecha Desde</label>
                <input type="date" id="fechaDesde" class="form-control">
            </div>
            
            <div class="filter-group">
                <label for="fechaHasta">Fecha Hasta</label>
                <input type="date" id="fechaHasta" class="form-control">
            </div>
            
            <div class="filter-group">
                <label for="quickSearch">Búsqueda rápida</label>
                <div class="search-container position-relative">
                    <input type="text" id="quickSearch" class="form-control" placeholder="Buscar por código, cliente...">
                    <button type="button" id="clearSearch" class="btn btn-sm btn-outline-secondary position-absolute end-0 top-50 translate-middle-y me-1" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="filter-group">
                <label>&nbsp;</label>
                <div class="d-flex gap-2">
                    <button class="btn-action" onclick="applyFilters()">
                        <i class="fas fa-search"></i>
                        Filtrar
                    </button>
                    <button class="btn-action warning" onclick="clearFilters()">
                        <i class="fas fa-times"></i>
                        Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de solicitudes -->
    <div class="tracking-table-container">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <h2 class="section-title mb-0">
                <i class="fas fa-table"></i>
                Lista de Solicitudes
            </h2>
            <small class="text-muted" id="totalCount">
                <!-- Se actualizará dinámicamente -->
            </small>
        </div>
        
        <div class="table-responsive">
            <table class="tracking-table" id="trackingTable">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Tipo Solicitud</th>
                        <th>Cliente</th>
                        <th>Documento</th>
                        <th>Estado</th>
                        <th>Pipeline</th>
                        <th>Solicitado por</th>
                        <th>Fecha Solicitud</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Completado</th>
                        <th>Archivo</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody id="trackingTableBody">
                    <!-- Los datos se cargarán dinámicamente -->
                </tbody>
            </table>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            Cargando datos...
        </div>
        
        <div id="noDataIndicator" class="no-data" style="display: none;">
            <i class="fas {% if tracking_type == 'sura' %}fa-file-contract{% elif tracking_type == 'unified' %}fa-tasks{% else %}fa-download{% endif %}"></i>
            <p>No se encontraron solicitudes {{ tracking_type|title }}</p>
        </div>
    </div>
</div>

<!-- Modal para detalles -->
<div id="detailModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Detalles de {{ tracking_type|title }}</h2>
            <button type="button" class="btn-close" onclick="closeDetailModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Contenido dinámico -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">Cerrar</button>
            <div id="modalActions">
                <!-- Acciones dinámicas -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentData = [];
const isUserSuperuser = {{ user.is_superuser|yesno:"true,false" }};
const trackingType = '{{ tracking_type }}';
const apiEndpoints = {
    apc: {
        list: '/workflow/api/apc/list/',
        detail: '/workflow/api/apc/detail/',
        reenviar: '/workflow/api/apc/reenviar/'
    },
    sura: {
        list: '/workflow/api/sura/list/',
        detail: '/workflow/api/sura/detail/',
        reenviar: '/workflow/api/sura/reenviar/'
    },
    debida_diligencia: {
        list: '/workflow/api/debida-diligencia-tracking/',
        detail: '/workflow/api/solicitud_brief/',
        reenviar: '/workflow/api/debida-diligencia/solicitar-makito/'
    }
};

// Función para cargar datos iniciales
document.addEventListener('DOMContentLoaded', function() {
    loadTrackingData();
    setupQuickSearch();
});

// Función para cargar datos unificados
async function loadTrackingData() {
    showLoading(true);
    
    try {
        let allSolicitudes = [];
        
        if (trackingType === 'unified') {
            // Cargar datos APC, SURA y Debida Diligencia para vista unificada
            const [apcResponse, suraResponse, diligenciaResponse] = await Promise.all([
                fetch('/workflow/api/apc/list/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                }),
                fetch('/workflow/api/sura/list/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                }),
                fetch('/workflow/api/debida-diligencia-tracking/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                })
            ]);

            if (apcResponse.ok) {
                const apcResult = await apcResponse.json();
                if (apcResult.success) {
                    // Agregar tipo de solicitud a cada item APC
                    // Handle both 'data' and 'solicitudes' field names
                    const apcData = apcResult.data || apcResult.solicitudes || [];
                    const apcSolicitudes = apcData.map(item => ({
                        ...item,
                        tipo_solicitud: 'APC',
                        tipo_solicitud_badge: 'info',
                        status_field: 'apc_status',
                        fecha_solicitud_field: 'apc_fecha_solicitud',
                        fecha_inicio_field: 'apc_fecha_inicio',
                        fecha_completado_field: 'apc_fecha_completado',
                        archivo_field: 'apc_archivo_name',
                        observaciones_field: 'apc_observaciones',
                        // Map field names to match expected structure
                        cliente_documento: item.apc_no_cedula || '',
                        pipeline: { nombre: item.pipeline || 'N/A' },
                        creada_por: { full_name: item.creada_por || 'N/A' }
                    }));
                    allSolicitudes = allSolicitudes.concat(apcSolicitudes);
                }
            }

            if (suraResponse.ok) {
                const suraResult = await suraResponse.json();
                if (suraResult.success) {
                    // Agregar tipo de solicitud a cada item SURA
                    // Handle both 'data' and 'solicitudes' field names
                    const suraData = suraResult.data || suraResult.solicitudes || [];
                    const suraSolicitudes = suraData.map(item => ({
                        ...item,
                        tipo_solicitud: 'SURA',
                        tipo_solicitud_badge: 'warning',
                        status_field: 'sura_status',
                        fecha_solicitud_field: 'sura_fecha_solicitud',
                        fecha_inicio_field: 'sura_fecha_inicio',
                        fecha_completado_field: 'sura_fecha_completado',
                        archivo_field: 'sura_archivo_name',
                        observaciones_field: 'sura_observaciones',
                        // Ensure consistent field structure
                        cliente_documento: item.cliente_documento || '',
                        pipeline: item.pipeline || { nombre: 'N/A' },
                        creada_por: item.creada_por || { full_name: 'N/A' }
                    }));
                    allSolicitudes = allSolicitudes.concat(suraSolicitudes);
                }
            }

            if (diligenciaResponse.ok) {
                const diligenciaResult = await diligenciaResponse.json();
                if (diligenciaResult.success) {
                    // Agregar tipo de solicitud a cada item Debida Diligencia
                    const diligenciaData = diligenciaResult.data || diligenciaResult.solicitudes || [];
                    const diligenciaSolicitudes = diligenciaData.map(item => ({
                        ...item,
                        tipo_solicitud: 'DEBIDA DILIGENCIA',
                        tipo_solicitud_badge: 'danger',
                        status_field: 'debida_diligencia_status',
                        fecha_solicitud_field: 'diligencia_fecha_solicitud',
                        fecha_inicio_field: 'diligencia_fecha_inicio',
                        fecha_completado_field: 'diligencia_fecha_completado',
                        archivo_field: 'diligencia_archivos',
                        observaciones_field: 'diligencia_observaciones',
                        // Ensure consistent field structure
                        cliente_documento: item.cliente_documento || '',
                        pipeline: item.pipeline || { nombre: 'N/A' },
                        creada_por: item.creada_por || { full_name: 'N/A' }
                    }));
                    allSolicitudes = allSolicitudes.concat(diligenciaSolicitudes);
                }
            }
            
            // Ordenar por fecha de solicitud (más recientes primero)
            allSolicitudes.sort((a, b) => {
                const dateA = new Date(a[a.fecha_solicitud_field] || a.fecha_creacion);
                const dateB = new Date(b[b.fecha_solicitud_field] || b.fecha_creacion);
                return dateB - dateA;
            });

        } else {
            // Cargar solo datos de un tipo específico (APC o SURA)
            const params = new URLSearchParams();
            
            // Aplicar filtros si están activos
            const statusFilter = document.getElementById('statusFilter')?.value;
            const pipelineFilter = document.getElementById('pipelineFilter')?.value;
            const fechaDesde = document.getElementById('fechaDesde')?.value;
            const fechaHasta = document.getElementById('fechaHasta')?.value;
            
            if (statusFilter) params.append('status', statusFilter);
            if (pipelineFilter) params.append('pipeline', pipelineFilter);
            if (fechaDesde) params.append('fecha_desde', fechaDesde);
            if (fechaHasta) params.append('fecha_hasta', fechaHasta);
            
            const response = await fetch(`${apiEndpoints[trackingType].list}?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.success) {
                // Handle both 'data' and 'solicitudes' field names
                const resultData = result.data || result.solicitudes || [];
                allSolicitudes = resultData.map(item => ({
                    ...item,
                    tipo_solicitud: trackingType.toUpperCase(),
                    tipo_solicitud_badge: trackingType === 'apc' ? 'info' : 'warning',
                    status_field: `${trackingType}_status`,
                    fecha_solicitud_field: `${trackingType}_fecha_solicitud`,
                    fecha_inicio_field: `${trackingType}_fecha_inicio`,
                    fecha_completado_field: `${trackingType}_fecha_completado`,
                    archivo_field: `${trackingType}_archivo_name`,
                    observaciones_field: `${trackingType}_observaciones`,
                    // Map field names to match expected structure
                    cliente_documento: trackingType === 'apc' ? (item.apc_no_cedula || '') : (item.cliente_documento || ''),
                    pipeline: trackingType === 'apc' ? { nombre: item.pipeline || 'N/A' } : (item.pipeline || { nombre: 'N/A' }),
                    creada_por: trackingType === 'apc' ? { full_name: item.creada_por || 'N/A' } : (item.creada_por || { full_name: 'N/A' })
                }));
            } else {
                throw new Error(result.error || 'Error desconocido');
            }
        }
        
        currentData = allSolicitudes;
        updateStats(allSolicitudes);
        renderTable(allSolicitudes);
        updatePipelineFilter(allSolicitudes);
        
    } catch (error) {
        console.error('Error cargando datos:', error);
        showError('Error al cargar los datos: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Función para mostrar/ocultar loading
function showLoading(show) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noDataIndicator = document.getElementById('noDataIndicator');
    const tableBody = document.getElementById('trackingTableBody');
    
    if (show) {
        loadingIndicator.style.display = 'block';
        noDataIndicator.style.display = 'none';
        tableBody.style.display = 'none';
    } else {
        loadingIndicator.style.display = 'none';
    }
}

// Función para actualizar estadísticas
function updateStats(solicitudes) {
    let pending = 0, inProgress = 0, completed = 0;
    
    solicitudes.forEach(s => {
        const statusField = s.status_field || `${trackingType}_status`;
        const status = s[statusField];
        
        if (status === 'pending') pending++;
        else if (status === 'in_progress') inProgress++;
        else if (status === 'completed') completed++;
    });
    
    const total = solicitudes.length;

    const statsContainer = document.getElementById('statsContainer');
    
    if (trackingType === 'unified') {
        // Para vista unificada, mostrar estadísticas por tipo también
        const apcCount = solicitudes.filter(s => s.tipo_solicitud === 'APC').length;
        const suraCount = solicitudes.filter(s => s.tipo_solicitud === 'SURA').length;
        const diligenciaCount = solicitudes.filter(s => s.tipo_solicitud === 'DEBIDA DILIGENCIA').length;
        
        statsContainer.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${total}</div>
                <div class="stat-label">Total Solicitudes</div>
            </div>
            <div class="stat-card stat-info">
                <div class="stat-number">${apcCount}</div>
                <div class="stat-label">APC</div>
            </div>
            <div class="stat-card stat-warning">
                <div class="stat-number">${suraCount}</div>
                <div class="stat-label">SURA</div>
            </div>
            <div class="stat-card" style="border-left: 4px solid #ef4444;">
                <div class="stat-number" style="color: #ef4444;">${diligenciaCount}</div>
                <div class="stat-label">Debida Diligencia</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${pending}</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${inProgress}</div>
                <div class="stat-label">En Proceso</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${completed}</div>
                <div class="stat-label">Completadas</div>
            </div>
        `;
    } else {
        // Para vista específica (APC o SURA)
        statsContainer.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${total}</div>
                <div class="stat-label">Total Solicitudes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${pending}</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${inProgress}</div>
                <div class="stat-label">En Proceso</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${completed}</div>
                <div class="stat-label">Completadas</div>
            </div>
        `;
    }
}

// Función para renderizar la tabla
function renderTable(solicitudes, searchTerm = '') {
    const tableBody = document.getElementById('trackingTableBody');
    const noDataIndicator = document.getElementById('noDataIndicator');
    
    if (solicitudes.length === 0) {
        tableBody.style.display = 'none';
        noDataIndicator.style.display = 'block';
        return;
    }
    
    tableBody.style.display = '';
    noDataIndicator.style.display = 'none';
    
    tableBody.innerHTML = solicitudes.map(solicitud => {
        // Debug: Log the solicitud data to see what's available
        console.log('Solicitud data:', solicitud);
        
        // Usar los campos dinámicos basados en el tipo de solicitud
        const statusField = solicitud.status_field || `${trackingType}_status`;
        const statusDisplayField = statusField.replace('_status', '_status_display');
        const fechaSolicitudField = solicitud.fecha_solicitud_field || `${trackingType}_fecha_solicitud`;
        const fechaInicioField = solicitud.fecha_inicio_field || `${trackingType}_fecha_inicio`;
        const fechaCompletadoField = solicitud.fecha_completado_field || `${trackingType}_fecha_completado`;
        const archivoField = solicitud.archivo_field || `${trackingType}_archivo_name`;
        const observacionesField = solicitud.observaciones_field || `${trackingType}_observaciones`;
        
        const highlightedCodigo = highlightSearchTerm(solicitud.codigo || '', searchTerm);
        const highlightedCliente = highlightSearchTerm(solicitud.cliente_nombre || '', searchTerm);
        const highlightedDocumento = highlightSearchTerm(solicitud.cliente_documento || '', searchTerm);
        const highlightedStatus = highlightSearchTerm(solicitud[statusDisplayField] || '', searchTerm);
        const highlightedTipoSolicitud = highlightSearchTerm(solicitud.tipo_solicitud || '', searchTerm);
        
        return `
            <tr onclick="openDetailModal('${solicitud.codigo}', '${solicitud.tipo_solicitud?.toLowerCase()}')">
                <td>
                    <strong>${highlightedCodigo}</strong>
                </td>
                <td>
                    <span class="tipo-badge ${solicitud.tipo_solicitud?.toLowerCase().replace(' ', '_') || 'apc'}">
                        <i class="fas ${solicitud.tipo_solicitud === 'APC' ? 'fa-download' : solicitud.tipo_solicitud === 'SURA' ? 'fa-file-contract' : 'fa-shield-alt'}"></i>
                        ${highlightedTipoSolicitud}
                    </span>
                </td>
                <td>${highlightedCliente}</td>
                <td>
                    <code>${highlightedDocumento}</code>
                </td>
                <td>
                    <span class="status-badge status-${solicitud[statusField]}">
                        ${getStatusIcon(solicitud[statusField])} ${highlightedStatus}
                    </span>
                </td>
                <td>${solicitud.pipeline?.nombre || 'N/A'}</td>
                <td>${solicitud.creada_por?.full_name || 'N/A'}</td>
                <td>${formatDate(solicitud[fechaSolicitudField])}</td>
                <td>${formatDate(solicitud[fechaInicioField])}</td>
                <td>${formatDate(solicitud[fechaCompletadoField])}</td>
                <td>
                    ${solicitud[archivoField] ? 
                        `<i class="fas fa-file-pdf text-danger"></i> ${solicitud[archivoField]}` : 
                        '<span class="text-muted">Sin archivo</span>'
                    }
                </td>
                <td class="text-truncate" style="max-width: 200px;" title="${solicitud[observacionesField] || ''}">
                    ${solicitud[observacionesField] || '<span class="text-muted">Sin observaciones</span>'}
                </td>
            </tr>
        `;
    }).join('');
}

// Función para obtener ícono de estado
function getStatusIcon(status) {
    const icons = {
        'pending': '<i class="fas fa-clock"></i>',
        'in_progress': '<i class="fas fa-spinner fa-spin"></i>',
        'completed': '<i class="fas fa-check-circle"></i>',
        'error': '<i class="fas fa-exclamation-triangle"></i>'
    };
    return icons[status] || '<i class="fas fa-question-circle"></i>';
}

// Función para aplicar filtros
function applyFilters() {
    loadTrackingData();
}

// Función para limpiar filtros
function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('pipelineFilter').value = '';
    document.getElementById('fechaDesde').value = '';
    document.getElementById('fechaHasta').value = '';
    document.getElementById('quickSearch').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    loadTrackingData();
}

// Quick Search Functionality
function setupQuickSearch() {
    const quickSearch = document.getElementById('quickSearch');
    const clearSearch = document.getElementById('clearSearch');
    let searchTimeout;
    
    quickSearch.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterAndRenderData(searchTerm);
        }, 300);
        
        clearSearch.style.display = searchTerm ? 'block' : 'none';
    });
    
    clearSearch.addEventListener('click', function() {
        quickSearch.value = '';
        this.style.display = 'none';
        filterAndRenderData('');
    });
}

function filterAndRenderData(searchTerm) {
    if (!searchTerm) {
        renderTable(currentData);
        return;
    }
    
    const filtered = currentData.filter(solicitud => {
        const searchableFields = [
            solicitud.codigo || '',
            solicitud.cliente_nombre || '',
            solicitud.cliente_documento || '',
            solicitud.tipo_solicitud || '',
            solicitud.pipeline?.nombre || '',
            solicitud.creada_por?.full_name || ''
        ];
        
        return searchableFields.some(field => 
            field.toLowerCase().includes(searchTerm.toLowerCase())
        );
    });
    
    renderTable(filtered, searchTerm);
}

function highlightSearchTerm(text, searchTerm) {
    if (!searchTerm || !text) return text;
    
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
}

// Función para actualizar filtro de pipeline
function updatePipelineFilter(solicitudes) {
    const pipelineFilter = document.getElementById('pipelineFilter');
    const pipelines = [...new Set(solicitudes.map(s => s.pipeline?.nombre).filter(Boolean))];
    
    const currentValue = pipelineFilter.value;
    pipelineFilter.innerHTML = '<option value="">Todos los pipelines</option>';
    
    pipelines.forEach(pipeline => {
        const option = document.createElement('option');
        option.value = pipeline;
        option.textContent = pipeline;
        if (pipeline === currentValue) option.selected = true;
        pipelineFilter.appendChild(option);
    });
}

// Función para refrescar datos
function refreshData() {
    loadTrackingData();
}

// Función para mostrar errores
function showError(message) {
    console.error(message);
    // Aquí podrías agregar un toast o notificación
    alert(message);
}

// Modal functionality
let currentModalData = null;

async function openDetailModal(codigo, tipoSolicitud = null) {
    try {
        let endpoint;
        
        if (trackingType === 'unified' && tipoSolicitud) {
            // Vista unificada: usar el tipo específico de solicitud
            if (tipoSolicitud === 'debida_diligencia') {
                endpoint = `${apiEndpoints[tipoSolicitud].detail}${codigo}/`;
            } else {
                endpoint = `${apiEndpoints[tipoSolicitud].detail}${codigo}/`;
            }
        } else {
            // Vista específica: usar el tipo configurado
            endpoint = `${apiEndpoints[trackingType].detail}${codigo}/`;
        }
        
        const response = await fetch(endpoint, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });

        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
            // Handle different response structures for APC and SURA
            const modalData = result.data || result.solicitud;
            if (!modalData) {
                throw new Error('No se encontraron datos en la respuesta');
            }
            currentModalData = modalData;
            populateModal(modalData, tipoSolicitud);
            document.getElementById('detailModal').style.display = 'flex';
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
    } catch (error) {
        console.error('Error al cargar detalles:', error);
        showError('Error al cargar los detalles: ' + error.message);
    }
}

function populateModal(solicitud, tipoSolicitud = null) {
    const modalType = tipoSolicitud || trackingType;
    const modalTypeUpper = modalType.toUpperCase();
    
    document.getElementById('modalTitle').textContent = `Detalles ${modalTypeUpper} - ${solicitud.codigo}`;
    
    const modalBody = document.getElementById('modalBody');
    const statusField = modalType === 'debida_diligencia' ? 'debida_diligencia_status' : `${modalType}_status`;
    const statusDisplayField = modalType === 'debida_diligencia' ? 'debida_diligencia_status_display' : `${modalType}_status_display`;
    const archivoField = modalType === 'debida_diligencia' ? 'diligencia_archivos' : `${modalType}_archivo_url`;
    const archivoNameField = modalType === 'debida_diligencia' ? 'diligencia_archivos' : `${modalType}_archivo_name`;
    
    // Handle different field structures for APC vs SURA vs Debida Diligencia
    const clienteDocumento = modalType === 'apc' ? (solicitud.apc_no_cedula || 'N/A') : (solicitud.cliente_documento || 'N/A');
    const pipelineNombre = modalType === 'apc' ? (solicitud.pipeline || 'N/A') : (solicitud.pipeline?.nombre || 'N/A');
    const observacionesField = modalType === 'debida_diligencia' ? 'diligencia_observaciones' : `${modalType}_observaciones`;
    const fechaSolicitudField = modalType === 'debida_diligencia' ? 'diligencia_fecha_solicitud' : `${modalType}_fecha_solicitud`;
    const fechaInicioField = modalType === 'debida_diligencia' ? 'diligencia_fecha_inicio' : `${modalType}_fecha_inicio`;
    const fechaCompletadoField = modalType === 'debida_diligencia' ? 'diligencia_fecha_completado' : `${modalType}_fecha_completado`;
    
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h5>Información General</h5>
                <table class="table table-sm">
                    <tr><td><strong>Código:</strong></td><td>${solicitud.codigo}</td></tr>
                    ${trackingType === 'unified' ? `<tr><td><strong>Tipo Solicitud:</strong></td><td>
                        <span class="badge badge-${modalType === 'apc' ? 'info' : 'warning'}">${modalTypeUpper}</span>
                    </td></tr>` : ''}
                    <tr><td><strong>Cliente:</strong></td><td>${solicitud.cliente_nombre || 'N/A'}</td></tr>
                    <tr><td><strong>Documento:</strong></td><td>${clienteDocumento}</td></tr>
                    <tr><td><strong>Pipeline:</strong></td><td>${pipelineNombre}</td></tr>
                    <tr><td><strong>Estado:</strong></td><td>
                        <span class="status-badge status-${solicitud[statusField]}">
                            ${getStatusIcon(solicitud[statusField])} ${solicitud[statusDisplayField]}
                        </span>
                    </td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h5>Fechas</h5>
                <table class="table table-sm">
                    <tr><td><strong>Solicitud:</strong></td><td>${formatDate(solicitud[fechaSolicitudField])}</td></tr>
                    <tr><td><strong>Inicio:</strong></td><td>${formatDate(solicitud[fechaInicioField])}</td></tr>
                    <tr><td><strong>Completado:</strong></td><td>${formatDate(solicitud[fechaCompletadoField])}</td></tr>
                </table>
                
                ${modalType === 'debida_diligencia' ? `
                    <h5>Archivos de Debida Diligencia</h5>
                    ${solicitud.diligencia_busqueda_google ? `
                        <div class="mb-2">
                            <strong>Búsqueda Google:</strong>
                            <div class="d-flex gap-2 mt-1">
                                <a href="${solicitud.diligencia_busqueda_google}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Ver
                                </a>
                                <a href="${solicitud.diligencia_busqueda_google}" download class="btn btn-sm btn-success">
                                    <i class="fas fa-download"></i> Descargar
                                </a>
                            </div>
                        </div>
                    ` : '<div class="mb-2"><strong>Búsqueda Google:</strong> <span class="text-muted">No disponible</span></div>'}
                    ${solicitud.diligencia_busqueda_registro_publico ? `
                        <div class="mb-2">
                            <strong>Registro Público:</strong>
                            <div class="d-flex gap-2 mt-1">
                                <a href="${solicitud.diligencia_busqueda_registro_publico}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Ver
                                </a>
                                <a href="${solicitud.diligencia_busqueda_registro_publico}" download class="btn btn-sm btn-success">
                                    <i class="fas fa-download"></i> Descargar
                                </a>
                            </div>
                        </div>
                    ` : '<div class="mb-2"><strong>Registro Público:</strong> <span class="text-muted">No disponible</span></div>'}
                ` : solicitud[archivoField] ? `
                    <h5>Archivo</h5>
                    <div class="d-flex gap-2">
                        <a href="${solicitud[archivoField]}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye"></i> Ver archivo
                        </a>
                        <a href="${solicitud[archivoField]}" download class="btn btn-sm btn-success">
                            <i class="fas fa-download"></i> Descargar
                        </a>
                    </div>
                ` : ''}
            </div>
        </div>
        
        ${solicitud[observacionesField] ? `
            <div class="mt-3">
                <h5>Observaciones</h5>
                <div class="alert alert-info">
                    ${solicitud[observacionesField].replace(/\n/g, '<br>')}
                </div>
            </div>
        ` : ''}
        
        ${generateTimeline(solicitud, modalType)}
    `;
    
    // Modal actions
    const modalActions = document.getElementById('modalActions');
    modalActions.innerHTML = '';
    
    if (isUserSuperuser) {
        modalActions.innerHTML = `
            <button type="button" class="btn btn-warning" onclick="reenviarSolicitud('${solicitud.codigo}')">
                <i class="fas fa-paper-plane"></i> Reenviar
            </button>
        `;
    }
}

function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
    currentModalData = null;
}

// Función para reenviar solicitud
async function reenviarSolicitud(codigo, tipoSolicitud = null) {
    const modalType = tipoSolicitud || trackingType;
    const modalTypeUpper = modalType.toUpperCase();
    
    if (!confirm(`¿Estás seguro de que deseas reenviar la solicitud ${modalTypeUpper} ${codigo}?`)) {
        return;
    }
    
    try {
        let endpoint;
        
        if (trackingType === 'unified' && tipoSolicitud) {
            // Vista unificada: usar el tipo específico de solicitud
            if (tipoSolicitud === 'debida_diligencia') {
                endpoint = `${apiEndpoints[tipoSolicitud].reenviar}${codigo}/`;
            } else {
                endpoint = `${apiEndpoints[tipoSolicitud].reenviar}${codigo}/`;
            }
        } else {
            // Vista específica: usar el tipo configurado
            endpoint = `${apiEndpoints[trackingType].reenviar}${codigo}/`;
        }
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });

        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            // Refrescar datos
            loadTrackingData();
            // Cerrar modal si está abierto
            if (currentModalData) {
                closeDetailModal();
            }
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
    } catch (error) {
        console.error('Error al reenviar:', error);
        showError('Error al reenviar la solicitud: ' + error.message);
    }
}

// Helper functions
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function showSuccess(message) {
    console.log('Success:', message);
    // Aquí podrías agregar un toast o notificación
    alert(message);
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return 'Fecha inválida';
    }
}

// Function to generate timeline HTML
function generateTimeline(solicitud, modalType) {
    const events = [];
    
    // Add creation event
    if (solicitud.fecha_creacion) {
        events.push({
            evento: 'Solicitud Creada',
            fecha: solicitud.fecha_creacion,
            descripcion: `Solicitud creada en el sistema`
        });
    }
    
    // Add request event based on type
    const fechaSolicitudField = `${modalType}_fecha_solicitud`;
    if (solicitud[fechaSolicitudField]) {
        const tipoSolicitud = modalType === 'debida_diligencia' ? 'DEBIDA DILIGENCIA' : modalType.toUpperCase();
        events.push({
            evento: `${tipoSolicitud} Solicitado`,
            fecha: solicitud[fechaSolicitudField],
            descripcion: `Solicitud de ${tipoSolicitud} enviada a Makito RPA`
        });
    }
    
    // Add processing start event
    const fechaInicioField = `${modalType}_fecha_inicio`;
    if (solicitud[fechaInicioField]) {
        events.push({
            evento: 'Procesamiento Iniciado',
            fecha: solicitud[fechaInicioField],
            descripcion: 'Makito RPA inició el procesamiento'
        });
    }
    
    // Add completion event
    const fechaCompletadoField = `${modalType}_fecha_completado`;
    if (solicitud[fechaCompletadoField]) {
        events.push({
            evento: `${modalType.toUpperCase()} Completado`,
            fecha: solicitud[fechaCompletadoField],
            descripcion: `Proceso de ${modalType.toUpperCase()} completado exitosamente`
        });
    }
    
    // Sort events by date
    events.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    
    if (events.length > 0) {
        return `
            <div class="mt-3">
                <h5>Timeline</h5>
                <div class="timeline">
                    ${events.map(event => `
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <strong>${event.evento}</strong>
                                <small class="text-muted d-block">${formatDate(event.fecha)}</small>
                                ${event.descripcion ? `<p class="mb-0">${event.descripcion}</p>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else {
        return `
            <div class="mt-3">
                <h5>Timeline</h5>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-content">
                            <strong>Sin eventos registrados</strong>
                            <small class="text-muted d-block">No hay eventos registrados para esta solicitud</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

// Auto-refresh cada 30 segundos
setInterval(() => {
    refreshData();
}, 30000);

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('detailModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeDetailModal();
            }
        });
    }
});
</script>
{% endblock %}
