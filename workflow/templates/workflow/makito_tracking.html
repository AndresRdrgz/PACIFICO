{% extends 'workflow/base.html' %}
{% load static %}

{% block title %}Tracking {{ tracking_type|title }} Makito{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2d5a2d;
        --primary-hover: #1e5f2a;
        --background-color: #f8fafc;
        --card-background: #ffffff;
        --border-color: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --border-radius: 12px;
        --border-radius-sm: 8px;
    }

    /* Override with Pacifico green if available */
    .tracking-container {
        --primary-color: var(--verde-pacifico, #2d5a2d) !important;
    }

    /* Ensure styles are applied with higher specificity */
    body .tracking-container {
        padding: 24px;
        background: var(--background-color);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    body .tracking-header {
        background: var(--card-background) !important;
        border-radius: var(--border-radius);
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    body .tracking-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
    }
    
    body .tracking-filters {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }
    
    body .tracking-table-container {
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-transform: capitalize;
    }
    
    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
    }
    
    .status-in_progress {
        background-color: #dbeafe;
        color: #1e40af;
        border: 1px solid #3b82f6;
        animation: pulse 2s infinite;
    }
    
    .status-completed {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }
    
    .status-error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
    }
    
    /* Tipo Solicitud Badge Styles */
    .tipo-badge {
        padding: 6px 12px;
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .tipo-badge.apc {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        border: 1px solid #3b82f6;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }
    
    .tipo-badge.sura {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        border: 1px solid #f59e0b;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
    }
    
    .tipo-badge.debida_diligencia {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
        border: 1px solid #ef4444;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }
    
    .tracking-table {
        width: 100%;
        margin: 0;
        border-collapse: collapse;
        font-size: 0.875rem;
    }
    
    .tracking-table th,
    .tracking-table td {
        padding: 16px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    .tracking-table th {
        background: #f8fafc;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .tracking-table th:first-child {
        border-top-left-radius: var(--border-radius);
    }

    .tracking-table th:last-child {
        border-top-right-radius: var(--border-radius);
    }
    
    .tracking-table tbody tr {
        transition: all 0.2s ease;
        background: #ffffff;
        position: relative;
    }

    .tracking-table tbody tr:hover {
        background: #f8fafc;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    }

    .tracking-table tbody tr {
        cursor: pointer;
    }

    .tracking-table tbody tr::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 1px;
        background: var(--border-color);
        transition: all 0.2s ease;
    }

    .tracking-table tbody tr:hover::after {
        background: var(--primary-color);
        height: 2px;
    }

    .tracking-table tbody tr:active {
        transform: translateY(0);
    }

    .tracking-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    body .refresh-btn {
        background: var(--primary-color) !important;
        border: none !important;
        color: white !important;
        padding: 12px 24px !important;
        border-radius: var(--border-radius-sm) !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
        transition: all 0.2s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 8px !important;
        box-shadow: var(--shadow-sm) !important;
    }
    
    body .refresh-btn:hover {
        background: var(--primary-hover) !important;
        transform: translateY(-2px) !important;
        box-shadow: var(--shadow-md) !important;
    }

    body .refresh-btn:active {
        transform: translateY(0) !important;
    }
    
    .filter-row {
        display: flex;
        gap: 16px;
        align-items: end;
        flex-wrap: wrap;
    }

    @media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 200px;
    }
    
    .filter-group label {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
    }
    
    .filter-group select,
    .filter-group input {
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        background: white;
        transition: all 0.2s ease;
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .filter-group select:hover,
    .filter-group input:hover {
        border-color: var(--primary-color);
    }

    /* Quick Search Styles */
    .search-container input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .search-container input:hover {
        border-color: var(--primary-color);
    }

    #clearSearch:hover {
        background-color: #f3f4f6;
    }

    /* Search Results Highlighting */
    .search-highlight {
        background-color: #fef3c7;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 600;
    }
    
    .no-data {
        text-align: center;
        padding: 64px 32px;
        color: var(--text-muted);
    }

    .no-data i {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .no-data p {
        font-size: 1.125rem;
        margin: 0;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    @media (max-width: 768px) {
        .stats-row {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
    }

    @media (max-width: 480px) {
        .stats-row {
            grid-template-columns: 1fr;
        }
    }
    
    body .stat-card {
        background: var(--card-background) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: var(--border-radius) !important;
        padding: 24px !important;
        box-shadow: var(--shadow-sm) !important;
        transition: all 0.2s ease !important;
        position: relative !important;
        overflow: hidden !important;
    }

    body .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-color);
    }

    body .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md) !important;
    }
    
    body .stat-number {
        font-size: 2rem !important;
        font-weight: 700 !important;
        color: var(--primary-color) !important;
        margin-bottom: 8px !important;
        line-height: 1 !important;
    }
    
    body .stat-label {
        color: var(--text-secondary) !important;
        font-size: 0.875rem !important;
        font-weight: 500 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.05em !important;
    }
    
    /* Estilos específicos para estadísticas por tipo */
    body .stat-card.stat-info {
        border-left: 4px solid #007bff !important;
    }
    
    body .stat-card.stat-info .stat-number {
        color: #007bff !important;
    }
    
    body .stat-card.stat-warning {
        border-left: 4px solid #ffc107 !important;
    }
    
    body .stat-card.stat-warning .stat-number {
        color: #ffc107 !important;
    }
    
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 64px;
        color: var(--text-muted);
        font-size: 1.125rem;
    }
    
    .spinner {
        display: inline-block;
        width: 32px;
        height: 32px;
        border: 3px solid var(--border-color);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s linear infinite;
        margin-right: 12px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-title i {
        color: var(--primary-color);
    }

    .header-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .header-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
        font-weight: 500;
    }

    .btn-action {
        padding: 8px 16px;
        border-radius: var(--border-radius-sm);
        font-size: 0.8rem;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        background: var(--primary-color);
        color: white;
    }

    .btn-action:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
        color: white;
        text-decoration: none;
    }
    
    .btn-action.warning {
        background: #f59e0b;
        color: white;
    }
    
    .btn-action.warning:hover {
        background: #d97706;
        color: white;
    }

    .table-responsive {
        overflow-x: auto;
        max-height: 70vh;
        border-radius: var(--border-radius);
    }

    /* Custom scrollbar styling for webkit browsers */
    .table-responsive::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }

    /* Ensure table maintains minimum width for scrolling */
    .tracking-table {
        min-width: 1200px;
    }

    /* Column width optimization for better responsive behavior */
    .tracking-table th:nth-child(1), .tracking-table td:nth-child(1) { /* Código */
        width: 120px;
        min-width: 120px;
    }
    
    .tracking-table th:nth-child(2), .tracking-table td:nth-child(2) { /* Tipo Solicitud */
        width: 100px;
        min-width: 100px;
    }
    
    .tracking-table th:nth-child(3), .tracking-table td:nth-child(3) { /* Cliente */
        width: 180px;
        min-width: 160px;
    }
    
    .tracking-table th:nth-child(4), .tracking-table td:nth-child(4) { /* Documento */
        width: 120px;
        min-width: 120px;
    }
    
    .tracking-table th:nth-child(5), .tracking-table td:nth-child(5) { /* Estado */
        width: 130px;
        min-width: 130px;
    }
    
    .tracking-table th:nth-child(6), .tracking-table td:nth-child(6) { /* Pipeline */
        width: 140px;
        min-width: 140px;
    }
    
    .tracking-table th:nth-child(7), .tracking-table td:nth-child(7) { /* Solicitado por */
        width: 140px;
        min-width: 140px;
    }
    
    .tracking-table th:nth-child(8), .tracking-table td:nth-child(8) { /* Fecha Solicitud */
        width: 110px;
        min-width: 110px;
    }
    
    .tracking-table th:nth-child(9), .tracking-table td:nth-child(9) { /* Fecha Inicio */
        width: 110px;
        min-width: 110px;
    }
    
    .tracking-table th:nth-child(10), .tracking-table td:nth-child(10) { /* Fecha Completado */
        width: 110px;
        min-width: 110px;
    }
    
    .tracking-table th:nth-child(11), .tracking-table td:nth-child(11) { /* Archivo */
        width: 120px;
        min-width: 120px;
    }
    
    .tracking-table th:nth-child(12), .tracking-table td:nth-child(12) { /* Observaciones */
        width: 180px;
        min-width: 160px;
    }
    


    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    .modal-header h2 {
        margin: 0;
        color: var(--primary-color);
        font-size: 1.25rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .btn-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }

    .btn-close:hover {
        background: var(--border-color);
        color: var(--text-primary);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background: #f8fafc;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Timeline Styles */
    .timeline {
        position: relative;
        padding-left: 32px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 16px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 24px;
        padding: 16px;
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-sm);
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -24px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary-color);
        border: 3px solid var(--card-background);
        box-shadow: 0 0 0 2px var(--primary-color);
    }

    .timeline-item:last-child {
        margin-bottom: 0;
    }

    .timeline-content {
        margin-left: 16px;
    }

    .timeline-content strong {
        display: block;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .timeline-content small {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .timeline-content p {
        margin: 8px 0 0 0;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    /* File Actions */
    .file-actions {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .btn-preview,
    .btn-download {
        background: var(--card-background);
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        padding: 12px 20px;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
    }

    .btn-preview:hover,
    .btn-download:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .btn-download {
        background: var(--primary-color);
        color: white;
    }

    .btn-download:hover {
        background: var(--primary-hover);
    }

    /* Observaciones */
    .observaciones-content {
        background: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        padding: 16px;
        color: var(--text-primary);
        line-height: 1.6;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(20px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive Modal */
    @media (max-width: 768px) {
        .modal-overlay {
            padding: 10px;
        }

        .modal-content {
            max-height: 95vh;
        }

        .modal-header {
            padding: 16px;
        }

        .modal-body {
            padding: 16px;
        }

        .timeline {
            padding-left: 24px;
        }

        .timeline-item::before {
            left: -16px;
        }
    }

    /* Nueva Solicitud Modal Styles */
    .service-type-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .service-option {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--card-background);
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
        overflow: hidden;
    }

    .service-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: transparent;
        transition: all 0.3s ease;
    }

    .service-option:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .service-option:hover::before {
        background: var(--primary-color);
    }

    .service-option.selected {
        border-color: var(--primary-color);
        background: rgba(45, 90, 45, 0.05);
        box-shadow: var(--shadow-md);
    }

    .service-option.selected::before {
        background: var(--primary-color);
    }

    .service-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .service-option.selected .service-icon {
        animation: pulse 2s infinite;
    }

    .service-info h6 {
        margin: 0 0 4px 0;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .service-info small {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .solicitudes-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        background: var(--card-background);
    }

    .solicitud-item {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .solicitud-item:last-child {
        border-bottom: none;
    }

    .solicitud-item:hover {
        background: #f8fafc;
        transform: translateX(4px);
    }

    .solicitud-item.selected {
        background: rgba(45, 90, 45, 0.05);
        border-left: 4px solid var(--primary-color);
        font-weight: 600;
    }

    .solicitud-item.selected::after {
        content: '\f00c';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        right: 16px;
        color: var(--primary-color);
        font-size: 1.2rem;
    }

    .solicitud-info {
        flex: 1;
    }

    .solicitud-code {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 0.95rem;
        margin-bottom: 4px;
    }

    .solicitud-details {
        color: var(--text-secondary);
        font-size: 0.875rem;
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
    }

    .solicitud-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }

    .pipeline-badge {
        background: #e2e8f0;
        color: #475569;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .etapa-badge {
        background: #dbeafe;
        color: #1e40af;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* Custom scrollbar for solicitudes list */
    .solicitudes-list::-webkit-scrollbar {
        width: 6px;
    }

    .solicitudes-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .solicitudes-list::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .solicitudes-list::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }

    /* Responsive adjustments for nueva solicitud modal */
    @media (max-width: 768px) {
        .service-type-selector {
            grid-template-columns: 1fr;
        }

        .service-option {
            padding: 16px;
        }

        .solicitud-details {
            flex-direction: column;
            gap: 4px;
        }

        .solicitud-meta {
            align-items: flex-start;
        }
    }

    /* Validation Form Styles */
    .validation-form-group {
        margin-bottom: 20px;
        padding: 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        background: #f8fafc;
    }

    .validation-form-group label {
        display: block;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .validation-form-group .required-indicator {
        color: #dc3545;
        margin-left: 4px;
    }

    .validation-form-group input,
    .validation-form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        background: white;
        transition: all 0.2s ease;
    }

    .validation-form-group input:focus,
    .validation-form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
    }

    .validation-form-group .field-description {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 4px;
        font-style: italic;
    }

    .validation-form-group.has-error input,
    .validation-form-group.has-error select {
        border-color: #dc3545;
        background-color: #fef2f2;
    }

    .validation-form-group.has-success input,
    .validation-form-group.has-success select {
        border-color: #10b981;
        background-color: #f0fdf4;
    }

    .validation-form-group.error input,
    .validation-form-group.error select {
        border-color: #dc3545;
        background-color: #fef2f2;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
    }

    .validation-form-group.success input,
    .validation-form-group.success select {
        border-color: #10b981;
        background-color: #f0fdf4;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .validation-form-group.has-error .field-description {
        color: #dc3545;
    }

    .validation-form-group.has-success .field-description {
        color: #10b981;
    }

    /* Solicitud info display in validation */
    .solicitud-info-display {
        background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        border: 1px solid #0ea5e9;
        border-radius: var(--border-radius);
        padding: 16px;
        margin-bottom: 20px;
    }

    .solicitud-info-display h6 {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 1rem;
    }

    .solicitud-info-display .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 0.875rem;
    }

    .solicitud-info-display .info-label {
        font-weight: 600;
        color: var(--text-primary);
    }

    .solicitud-info-display .info-value {
        color: var(--text-secondary);
    }

    /* Auto-populated field styles */
    .auto-populated {
        background-color: #f0f9ff !important;
        border-color: #0ea5e9 !important;
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.1) !important;
        position: relative;
    }

    .auto-populated::after {
        content: '🤖';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.875rem;
        opacity: 0.7;
        pointer-events: none;
    }

    .auto-populated:focus {
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2) !important;
    }

    /* Auto-populated field animation */
    @keyframes autoFill {
        0% {
            background-color: #fef3c7;
            border-color: #f59e0b;
        }
        100% {
            background-color: #f0f9ff;
            border-color: #0ea5e9;
        }
    }

    .auto-populated {
        animation: autoFill 0.5s ease-in-out;
    }

</style>
{% endblock %}

{% block content %}
<div class="tracking-container">
    <div class="tracking-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="header-title">
                    <i class="fas {% if tracking_type == 'sura' %}fa-file-contract{% elif tracking_type == 'unified' %}fa-tasks{% else %}fa-download{% endif %} me-3"></i>
                    Solicitudes Makito RPA
                </h1>
                <p class="header-subtitle">
                    {% if tracking_type == 'sura' %}
                        Seguimiento de cotizaciones de pólizas SURA procesadas por Makito RPA
                    {% elif tracking_type == 'unified' %}
                        Seguimiento unificado de solicitudes APC, SURA y Debida Diligencia procesadas por Makito RPA
                    {% else %}
                        Seguimiento de descargas APC procesadas por Makito RPA
                    {% endif %}
                    {% if not user.is_superuser %}
                        <br><small class="text-info">
                            <i class="fas fa-info-circle me-1"></i>
                            Mostrando únicamente las solicitudes donde eres propietario
                        </small>
                    {% else %}
                        <br><small class="text-success">
                            <i class="fas fa-crown me-1"></i>
                            Vista de administrador: Mostrando todas las solicitudes
                        </small>
                    {% endif %}
                </p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn-action" onclick="openNuevaSolicitudModal()">
                    <i class="fas fa-plus"></i>
                    Nueva solicitud
                </button>
                <button class="refresh-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    Actualizar
                </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="stats-row" id="statsContainer">
        <!-- Las estadísticas se cargarán dinámicamente -->
    </div>

    <!-- Filtros -->
    <div class="tracking-filters">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title mb-0">
                <i class="fas fa-filter"></i>
                Filtros
            </h2>
        </div>
        
        <div class="filter-row">
            <div class="filter-group">
                <label for="statusFilter">Estado</label>
                <select id="statusFilter" class="form-select">
                    <option value="">Todos los estados</option>
                    <option value="pending">Pendiente</option>
                    <option value="in_progress">En Proceso</option>
                    <option value="completed">Completado</option>
                    <option value="error">Error</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="pipelineFilter">Pipeline</label>
                <select id="pipelineFilter" class="form-select">
                    <option value="">Todos los pipelines</option>
                    <!-- Se llenarán dinámicamente -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="fechaDesde">Fecha Desde</label>
                <input type="date" id="fechaDesde" class="form-control">
            </div>
            
            <div class="filter-group">
                <label for="fechaHasta">Fecha Hasta</label>
                <input type="date" id="fechaHasta" class="form-control">
            </div>
            
            <div class="filter-group">
                <label for="quickSearch">Búsqueda rápida</label>
                <div class="search-container position-relative">
                    <input type="text" id="quickSearch" class="form-control" placeholder="Buscar por código, cliente...">
                    <button type="button" id="clearSearch" class="btn btn-sm btn-outline-secondary position-absolute end-0 top-50 translate-middle-y me-1" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="filter-group">
                <label>&nbsp;</label>
                <div class="d-flex gap-2">
                    <button class="btn-action" onclick="applyFilters()">
                        <i class="fas fa-search"></i>
                        Filtrar
                    </button>
                    <button class="btn-action warning" onclick="clearFilters()">
                        <i class="fas fa-times"></i>
                        Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de solicitudes -->
    <div class="tracking-table-container">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <h2 class="section-title mb-0">
                <i class="fas fa-table"></i>
                Lista de Solicitudes
            </h2>
            <small class="text-muted" id="totalCount">
                <!-- Se actualizará dinámicamente -->
            </small>
        </div>
        
        <div class="table-responsive">
            <table class="tracking-table" id="trackingTable">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Tipo Solicitud</th>
                        <th>Cliente</th>
                        <th>Documento</th>
                        <th>Estado</th>
                        <th>Pipeline</th>
                        <th>Solicitado por</th>
                        <th>Fecha Solicitud</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Completado</th>
                        <th>Archivo</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody id="trackingTableBody">
                    <!-- Los datos se cargarán dinámicamente -->
                </tbody>
            </table>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            Cargando datos...
        </div>
        
        <div id="noDataIndicator" class="no-data" style="display: none;">
            <i class="fas {% if tracking_type == 'sura' %}fa-file-contract{% elif tracking_type == 'unified' %}fa-tasks{% else %}fa-download{% endif %}"></i>
            <p>No se encontraron solicitudes {{ tracking_type|title }}</p>
        </div>
    </div>
</div>

<!-- Modal para detalles -->
<div id="detailModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Detalles de {{ tracking_type|title }}</h2>
            <button type="button" class="btn-close" onclick="closeDetailModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Contenido dinámico -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">Cerrar</button>
            <div id="modalActions">
                <!-- Acciones dinámicas -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para nueva solicitud -->
<div id="nuevaSolicitudModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="nuevaSolicitudTitle">
                <i class="fas fa-plus me-2"></i>
                Nueva Solicitud Makito
            </h2>
            <button type="button" class="btn-close" onclick="closeNuevaSolicitudModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="nuevaSolicitudBody">
            <!-- Selector de tipo de solicitud -->
            <div class="mb-4">
                <h5 class="mb-3">
                    <i class="fas fa-cog me-2"></i>
                    Tipo de Solicitud
                </h5>
                <div class="service-type-selector">
                    <div class="service-option" data-type="apc">
                        <div class="service-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="service-info">
                            <h6>APC</h6>
                            <small>Descarga de APC automática</small>
                        </div>
                    </div>
                    <div class="service-option" data-type="sura">
                        <div class="service-icon">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <div class="service-info">
                            <h6>SURA</h6>
                            <small>Cotización de póliza SURA</small>
                        </div>
                    </div>
                    <div class="service-option" data-type="debida_diligencia">
                        <div class="service-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="service-info">
                            <h6>Debida Diligencia</h6>
                            <small>Verificación de documentos</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de solicitudes disponibles -->
            <div id="solicitudesSection" style="display: none;">
                <h5 class="mb-3">
                    <i class="fas fa-list me-2"></i>
                    Seleccionar Solicitud
                </h5>
                
                <!-- Filtro de búsqueda -->
                <div class="mb-3">
                    <div class="position-relative">
                        <input type="text" id="searchSolicitudes" class="form-control" placeholder="Buscar solicitud por código, cliente, documento...">
                        <i class="fas fa-search position-absolute end-0 top-50 translate-middle-y me-3 text-muted"></i>
                    </div>
                </div>

                <!-- Lista de solicitudes -->
                <div id="solicitudesList" class="solicitudes-list">
                    <!-- Se cargará dinámicamente -->
                </div>
                
                <div id="loadingSolicitudes" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando solicitudes...</p>
                </div>
                
                <div id="noSolicitudesFound" class="text-center py-4" style="display: none;">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No se encontraron solicitudes disponibles</p>
                </div>
            </div>

            <!-- Formulario de validación de campos -->
            <div id="validacionCamposSection" style="display: none;">
                <h5 class="mb-3">
                    <i class="fas fa-check-circle me-2"></i>
                    Validar Campos Requeridos
                </h5>
                
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Por favor verifica que todos los campos requeridos estén completos antes de procesar la solicitud.
                </div>

                <div id="camposValidacionForm">
                    <!-- Información de la solicitud seleccionada -->
                    <div id="solicitudInfoDisplay" class="solicitud-info-display mb-3">
                        <!-- Se completará dinámicamente -->
                    </div>

                    <!-- Formulario de validación APC -->
                    <div id="apcValidationForm" style="display: none;">
                        <h6 class="mb-3 text-primary">
                            <i class="fas fa-download me-2"></i>
                            Campos requeridos para APC
                        </h6>
                        
                        <div class="validation-form-group">
                            <label for="apcTipoDocumento">
                                Tipo de Documento
                                <span class="required-indicator">*</span>
                            </label>
                            <select id="apcTipoDocumento" required>
                                <option value="">Seleccione el tipo de documento</option>
                                <option value="cedula">Cédula</option>
                                <option value="pasaporte">Pasaporte</option>
                            </select>
                            <div class="field-description">Tipo de documento de identidad del cliente</div>
                        </div>
                        
                        <div class="validation-form-group">
                            <label for="apcNumeroDocumento">
                                Número de Documento
                                <span class="required-indicator">*</span>
                            </label>
                            <input type="text" id="apcNumeroDocumento" placeholder="Ingresa el número de documento" required>
                            <div class="field-description">Número de cédula o pasaporte del cliente</div>
                        </div>
                    </div>

                    <!-- Formulario de validación SURA -->
                    <div id="suraValidationForm" style="display: none;">
                        <h6 class="mb-3 text-primary">
                            <i class="fas fa-file-contract me-2"></i>
                            Campos requeridos para SURA
                        </h6>
                        
                        <!-- Names Grid -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="validation-form-group">
                                    <label for="suraPrimerNombre">
                                        Primer Nombre
                                        <span class="required-indicator">*</span>
                                    </label>
                                    <input type="text" id="suraPrimerNombre" placeholder="Primer nombre del cliente" required>
                                    <div class="field-description">Primer nombre según documento de identidad</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="validation-form-group">
                                    <label for="suraSegundoNombre">
                                        Segundo Nombre
                                    </label>
                                    <input type="text" id="suraSegundoNombre" placeholder="Segundo nombre (opcional)">
                                    <div class="field-description">Segundo nombre del cliente (opcional)</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Last Names Grid -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="validation-form-group">
                                    <label for="suraPrimerApellido">
                                        Primer Apellido
                                        <span class="required-indicator">*</span>
                                    </label>
                                    <input type="text" id="suraPrimerApellido" placeholder="Primer apellido del cliente" required>
                                    <div class="field-description">Primer apellido según documento de identidad</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="validation-form-group">
                                    <label for="suraSegundoApellido">
                                        Segundo Apellido
                                    </label>
                                    <input type="text" id="suraSegundoApellido" placeholder="Segundo apellido (opcional)">
                                    <div class="field-description">Segundo apellido del cliente (opcional)</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="validation-form-group">
                            <label for="suraTipoDocumento">
                                Tipo de Documento
                                <span class="required-indicator">*</span>
                            </label>
                            <select id="suraTipoDocumento" required>
                                <option value="">Seleccione el tipo de documento</option>
                                <option value="cedula">Cédula</option>
                                <option value="pasaporte">Pasaporte</option>
                            </select>
                            <div class="field-description">Tipo de documento de identidad del cliente</div>
                        </div>
                        
                        <div class="validation-form-group">
                            <label for="suraDocumento">
                                Número de Documento
                                <span class="required-indicator">*</span>
                            </label>
                            <input type="text" id="suraDocumento" placeholder="Número de documento" required>
                            <div class="field-description">Número de documento de identidad del cliente</div>
                        </div>
                        
                        <!-- Car Info Grid -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="validation-form-group">
                                    <label for="suraMarcaAuto">
                                        Marca del Auto
                                        <span class="required-indicator">*</span>
                                    </label>
                                    <input type="text" id="suraMarcaAuto" placeholder="Ej: TOYOTA" required>
                                    <div class="field-description">Marca del vehículo a asegurar</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="validation-form-group">
                                    <label for="suraModeloAuto">
                                        Modelo del Auto
                                        <span class="required-indicator">*</span>
                                    </label>
                                    <input type="text" id="suraModeloAuto" placeholder="Ej: COROLLA" required>
                                    <div class="field-description">Modelo del vehículo a asegurar</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Year and Value Grid -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="validation-form-group">
                                    <label for="suraAnoAuto">
                                        Año del Auto
                                        <span class="required-indicator">*</span>
                                    </label>
                                    <input type="number" id="suraAnoAuto" min="2000" max="2030" placeholder="Ej: 2025" required>
                                    <div class="field-description">Año de fabricación del vehículo</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="validation-form-group">
                                    <label for="suraValorAuto">
                                        Valor del Auto
                                        <span class="required-indicator">*</span>
                                    </label>
                                    <input type="number" id="suraValorAuto" step="0.01" placeholder="Ej: 21995.00" required>
                                    <div class="field-description">Valor comercial del vehículo</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario de validación Debida Diligencia -->
                    <div id="debidaDiligenciaValidationForm" style="display: none;">
                        <h6 class="mb-3 text-primary">
                            <i class="fas fa-shield-alt me-2"></i>
                            Campos requeridos para Debida Diligencia
                        </h6>
                        
                        <div class="validation-form-group">
                            <label for="ddNombres">
                                Nombres del Cliente
                                <span class="required-indicator">*</span>
                            </label>
                            <input type="text" id="ddNombres" placeholder="Nombres completos del cliente" required>
                            <div class="field-description">Nombres del cliente a verificar</div>
                        </div>
                        
                        <div class="validation-form-group">
                            <label for="ddDocumento">
                                Documento del Cliente
                                <span class="required-indicator">*</span>
                            </label>
                            <input type="text" id="ddDocumento" placeholder="Número de documento" required>
                            <div class="field-description">Número de documento del cliente a verificar</div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning mt-3" id="camposFaltantesAlert" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Campos faltantes:</strong>
                    <ul id="camposFaltantesList" class="mb-0 mt-2"></ul>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeNuevaSolicitudModal()">Cancelar</button>
            <button type="button" id="continuarValidacionBtn" class="btn btn-success" onclick="continuarAValidacion()" style="display: none;">
                <i class="fas fa-arrow-right me-2"></i>
                Continuar
            </button>
            <button type="button" id="volverSolicitudesBtn" class="btn btn-outline-secondary" onclick="volverASolicitudes()" style="display: none;">
                <i class="fas fa-arrow-left me-2"></i>
                Volver
            </button>
            <button type="button" id="procesarSolicitudBtn" class="btn btn-primary" onclick="procesarSolicitudValidada()" style="display: none;" disabled>
                <i class="fas fa-paper-plane me-2"></i>
                Procesar Solicitud
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentData = [];
let solicitudesList = [];
let selectedServiceType = null;
let selectedSolicitudId = null;
const isUserSuperuser = {{ user.is_superuser|yesno:"true,false" }};
const trackingType = '{{ tracking_type }}';
const apiEndpoints = {
    apc: {
        list: '/workflow/api/apc/list/',
        detail: '/workflow/api/apc/detail/',
        reenviar: '/workflow/api/apc/reenviar/'
    },
    sura: {
        list: '/workflow/api/sura/list/',
        detail: '/workflow/api/sura/detail/',
        reenviar: '/workflow/api/sura/reenviar/'
    },
    debida_diligencia: {
        list: '/workflow/api/debida-diligencia-tracking/',
        detail: '/workflow/api/solicitud_brief/',
        reenviar: '/workflow/api/debida-diligencia/solicitar-makito/'
    }
};

// Función para cargar datos iniciales
document.addEventListener('DOMContentLoaded', function() {
    loadTrackingData();
    setupQuickSearch();
});

// Función para cargar datos unificados
async function loadTrackingData() {
    showLoading(true);
    
    try {
        let allSolicitudes = [];
        
        if (trackingType === 'unified') {
            // Cargar datos APC, SURA y Debida Diligencia para vista unificada
            const [apcResponse, suraResponse, diligenciaResponse] = await Promise.all([
                fetch('/workflow/api/apc/list/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                }),
                fetch('/workflow/api/sura/list/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                }),
                fetch('/workflow/api/debida-diligencia-tracking/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                })
            ]);

            if (apcResponse.ok) {
                const apcResult = await apcResponse.json();
                if (apcResult.success) {
                    // Agregar tipo de solicitud a cada item APC
                    // Handle both 'data' and 'solicitudes' field names
                    const apcData = apcResult.data || apcResult.solicitudes || [];
                    const apcSolicitudes = apcData.map(item => ({
                        ...item,
                        tipo_solicitud: 'APC',
                        tipo_solicitud_badge: 'info',
                        status_field: 'apc_status',
                        fecha_solicitud_field: 'apc_fecha_solicitud',
                        fecha_inicio_field: 'apc_fecha_inicio',
                        fecha_completado_field: 'apc_fecha_completado',
                        archivo_field: 'apc_archivo_name',
                        observaciones_field: 'apc_observaciones',
                        // Map field names to match expected structure
                        cliente_documento: item.apc_no_cedula || '',
                        pipeline: { nombre: item.pipeline || 'N/A' },
                        creada_por: { full_name: item.creada_por || 'N/A' }
                    }));
                    allSolicitudes = allSolicitudes.concat(apcSolicitudes);
                }
            }

            if (suraResponse.ok) {
                const suraResult = await suraResponse.json();
                if (suraResult.success) {
                    // Agregar tipo de solicitud a cada item SURA
                    // Handle both 'data' and 'solicitudes' field names
                    const suraData = suraResult.data || suraResult.solicitudes || [];
                    const suraSolicitudes = suraData.map(item => ({
                        ...item,
                        tipo_solicitud: 'SURA',
                        tipo_solicitud_badge: 'warning',
                        status_field: 'sura_status',
                        fecha_solicitud_field: 'sura_fecha_solicitud',
                        fecha_inicio_field: 'sura_fecha_inicio',
                        fecha_completado_field: 'sura_fecha_completado',
                        archivo_field: 'sura_archivo_name',
                        observaciones_field: 'sura_observaciones',
                        // Ensure consistent field structure
                        cliente_documento: item.cliente_documento || '',
                        pipeline: item.pipeline || { nombre: 'N/A' },
                        creada_por: item.creada_por || { full_name: 'N/A' }
                    }));
                    allSolicitudes = allSolicitudes.concat(suraSolicitudes);
                }
            }

            if (diligenciaResponse.ok) {
                const diligenciaResult = await diligenciaResponse.json();
                if (diligenciaResult.success) {
                    // Agregar tipo de solicitud a cada item Debida Diligencia
                    const diligenciaData = diligenciaResult.data || diligenciaResult.solicitudes || [];
                    const diligenciaSolicitudes = diligenciaData.map(item => ({
                        ...item,
                        tipo_solicitud: 'DEBIDA DILIGENCIA',
                        tipo_solicitud_badge: 'danger',
                        status_field: 'debida_diligencia_status',
                        fecha_solicitud_field: 'diligencia_fecha_solicitud',
                        fecha_inicio_field: 'diligencia_fecha_inicio',
                        fecha_completado_field: 'diligencia_fecha_completado',
                        archivo_field: 'diligencia_archivos',
                        observaciones_field: 'diligencia_observaciones',
                        // Ensure consistent field structure
                        cliente_documento: item.cliente_documento || '',
                        pipeline: item.pipeline || { nombre: 'N/A' },
                        creada_por: item.creada_por || { full_name: 'N/A' }
                    }));
                    allSolicitudes = allSolicitudes.concat(diligenciaSolicitudes);
                }
            }
            
            // Ordenar por fecha de solicitud (más recientes primero)
            allSolicitudes.sort((a, b) => {
                const dateA = new Date(a[a.fecha_solicitud_field] || a.fecha_creacion);
                const dateB = new Date(b[b.fecha_solicitud_field] || b.fecha_creacion);
                return dateB - dateA;
            });

        } else {
            // Cargar solo datos de un tipo específico (APC o SURA)
            const params = new URLSearchParams();
            
            // Aplicar filtros si están activos
            const statusFilter = document.getElementById('statusFilter')?.value;
            const pipelineFilter = document.getElementById('pipelineFilter')?.value;
            const fechaDesde = document.getElementById('fechaDesde')?.value;
            const fechaHasta = document.getElementById('fechaHasta')?.value;
            
            if (statusFilter) params.append('status', statusFilter);
            if (pipelineFilter) params.append('pipeline', pipelineFilter);
            if (fechaDesde) params.append('fecha_desde', fechaDesde);
            if (fechaHasta) params.append('fecha_hasta', fechaHasta);
            
            const response = await fetch(`${apiEndpoints[trackingType].list}?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.success) {
                // Handle both 'data' and 'solicitudes' field names
                const resultData = result.data || result.solicitudes || [];
                allSolicitudes = resultData.map(item => ({
                    ...item,
                    tipo_solicitud: trackingType.toUpperCase(),
                    tipo_solicitud_badge: trackingType === 'apc' ? 'info' : 'warning',
                    status_field: `${trackingType}_status`,
                    fecha_solicitud_field: `${trackingType}_fecha_solicitud`,
                    fecha_inicio_field: `${trackingType}_fecha_inicio`,
                    fecha_completado_field: `${trackingType}_fecha_completado`,
                    archivo_field: `${trackingType}_archivo_name`,
                    observaciones_field: `${trackingType}_observaciones`,
                    // Map field names to match expected structure
                    cliente_documento: trackingType === 'apc' ? (item.apc_no_cedula || '') : (item.cliente_documento || ''),
                    pipeline: trackingType === 'apc' ? { nombre: item.pipeline || 'N/A' } : (item.pipeline || { nombre: 'N/A' }),
                    creada_por: trackingType === 'apc' ? { full_name: item.creada_por || 'N/A' } : (item.creada_por || { full_name: 'N/A' })
                }));
            } else {
                throw new Error(result.error || 'Error desconocido');
            }
        }
        
        currentData = allSolicitudes;
        updateStats(allSolicitudes);
        renderTable(allSolicitudes);
        updatePipelineFilter(allSolicitudes);
        
    } catch (error) {
        console.error('Error cargando datos:', error);
        showError('Error al cargar los datos: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Función para mostrar/ocultar loading
function showLoading(show) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noDataIndicator = document.getElementById('noDataIndicator');
    const tableBody = document.getElementById('trackingTableBody');
    
    if (show) {
        loadingIndicator.style.display = 'block';
        noDataIndicator.style.display = 'none';
        tableBody.style.display = 'none';
    } else {
        loadingIndicator.style.display = 'none';
    }
}

// Función para actualizar estadísticas
function updateStats(solicitudes) {
    let pending = 0, inProgress = 0, completed = 0;
    
    solicitudes.forEach(s => {
        const statusField = s.status_field || `${trackingType}_status`;
        const status = s[statusField];
        
        if (status === 'pending') pending++;
        else if (status === 'in_progress') inProgress++;
        else if (status === 'completed') completed++;
    });
    
    const total = solicitudes.length;

    const statsContainer = document.getElementById('statsContainer');
    
    if (trackingType === 'unified') {
        // Para vista unificada, mostrar solo KPI generales y tiempo promedio
        // Calcular tiempo promedio de completación (horas)
        let totalTime = 0, completedTimeCount = 0;
        solicitudes.forEach(s => {
            const statusField = s.status_field || `${trackingType}_status`;
            const status = s[statusField];
            const start = s[s.fecha_inicio_field] ? new Date(s[s.fecha_inicio_field]) : null;
            const end = s[s.fecha_completado_field] ? new Date(s[s.fecha_completado_field]) : null;
            if (status === 'completed' && start && end) {
                totalTime += (end - start);
                completedTimeCount++;
            }
        });
        const avgMinutes = completedTimeCount ? (totalTime / completedTimeCount / (1000 * 60)) : 0;
        statsContainer.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${total}</div>
                <div class="stat-label">Total Solicitudes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${pending}</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${inProgress}</div>
                <div class="stat-label">En Proceso</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${completed}</div>
                <div class="stat-label">Completadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${avgMinutes.toFixed(2)}</div>
                <div class="stat-label">Tiempo Promedio (min)</div>
            </div>
        `;
    } else {
        // Para vista específica (APC o SURA)
        statsContainer.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${total}</div>
                <div class="stat-label">Total Solicitudes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${pending}</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${inProgress}</div>
                <div class="stat-label">En Proceso</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${completed}</div>
                <div class="stat-label">Completadas</div>
            </div>
        `;
    }
}

// Función para renderizar la tabla
function renderTable(solicitudes, searchTerm = '') {
    const tableBody = document.getElementById('trackingTableBody');
    const noDataIndicator = document.getElementById('noDataIndicator');
    
    if (solicitudes.length === 0) {
        tableBody.style.display = 'none';
        noDataIndicator.style.display = 'block';
        return;
    }
    
    tableBody.style.display = '';
    noDataIndicator.style.display = 'none';
    
    tableBody.innerHTML = solicitudes.map(solicitud => {
        // Debug: Log the solicitud data to see what's available
        console.log('Solicitud data:', solicitud);
        
        // Usar los campos dinámicos basados en el tipo de solicitud
        const statusField = solicitud.status_field || `${trackingType}_status`;
        const statusDisplayField = statusField.replace('_status', '_status_display');
        const fechaSolicitudField = solicitud.fecha_solicitud_field || `${trackingType}_fecha_solicitud`;
        const fechaInicioField = solicitud.fecha_inicio_field || `${trackingType}_fecha_inicio`;
        const fechaCompletadoField = solicitud.fecha_completado_field || `${trackingType}_fecha_completado`;
        const archivoField = solicitud.archivo_field || `${trackingType}_archivo_name`;
        const observacionesField = solicitud.observaciones_field || `${trackingType}_observaciones`;
        
        const highlightedCodigo = highlightSearchTerm(solicitud.codigo || '', searchTerm);
        const highlightedCliente = highlightSearchTerm(solicitud.cliente_nombre || '', searchTerm);
        const highlightedDocumento = highlightSearchTerm(solicitud.cliente_documento || '', searchTerm);
        const highlightedStatus = highlightSearchTerm(solicitud[statusDisplayField] || '', searchTerm);
        const highlightedTipoSolicitud = highlightSearchTerm(solicitud.tipo_solicitud || '', searchTerm);
        
        return `
            <tr onclick="openDetailModal('${solicitud.codigo}', '${solicitud.tipo_solicitud?.toLowerCase()}')">
                <td>
                    <strong>${highlightedCodigo}</strong>
                </td>
                <td>
                    <span class="tipo-badge ${solicitud.tipo_solicitud?.toLowerCase().replace(' ', '_') || 'apc'}">
                        <i class="fas ${solicitud.tipo_solicitud === 'APC' ? 'fa-download' : solicitud.tipo_solicitud === 'SURA' ? 'fa-file-contract' : 'fa-shield-alt'}"></i>
                        ${highlightedTipoSolicitud}
                    </span>
                </td>
                <td>${highlightedCliente}</td>
                <td>
                    <code>${highlightedDocumento}</code>
                </td>
                <td>
                    <span class="status-badge status-${solicitud[statusField]}">
                        ${getStatusIcon(solicitud[statusField])} ${highlightedStatus}
                    </span>
                </td>
                <td>${solicitud.pipeline?.nombre || 'N/A'}</td>
                <td>${solicitud.creada_por?.full_name || 'N/A'}</td>
                <td>${formatDate(solicitud[fechaSolicitudField])}</td>
                <td>${formatDate(solicitud[fechaInicioField])}</td>
                <td>${formatDate(solicitud[fechaCompletadoField])}</td>
                <td>
                    ${solicitud[archivoField] ? 
                        `<i class="fas fa-file-pdf text-danger"></i> ${solicitud[archivoField]}` : 
                        '<span class="text-muted">Sin archivo</span>'
                    }
                </td>
                <td class="text-truncate" style="max-width: 200px;" title="${solicitud[observacionesField] || ''}">
                    ${solicitud[observacionesField] || '<span class="text-muted">Sin observaciones</span>'}
                </td>
            </tr>
        `;
    }).join('');
}

// Función para obtener ícono de estado
function getStatusIcon(status) {
    const icons = {
        'pending': '<i class="fas fa-clock"></i>',
        'in_progress': '<i class="fas fa-spinner fa-spin"></i>',
        'completed': '<i class="fas fa-check-circle"></i>',
        'error': '<i class="fas fa-exclamation-triangle"></i>'
    };
    return icons[status] || '<i class="fas fa-question-circle"></i>';
}

// Función para aplicar filtros
function applyFilters() {
    loadTrackingData();
}

// Función para limpiar filtros
function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('pipelineFilter').value = '';
    document.getElementById('fechaDesde').value = '';
    document.getElementById('fechaHasta').value = '';
    document.getElementById('quickSearch').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    loadTrackingData();
}

// Quick Search Functionality
function setupQuickSearch() {
    const quickSearch = document.getElementById('quickSearch');
    const clearSearch = document.getElementById('clearSearch');
    let searchTimeout;
    
    quickSearch.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterAndRenderData(searchTerm);
        }, 300);
        
        clearSearch.style.display = searchTerm ? 'block' : 'none';
    });
    
    clearSearch.addEventListener('click', function() {
        quickSearch.value = '';
        this.style.display = 'none';
        filterAndRenderData('');
    });
}

function filterAndRenderData(searchTerm) {
    if (!searchTerm) {
        renderTable(currentData);
        return;
    }
    
    const filtered = currentData.filter(solicitud => {
        const searchableFields = [
            solicitud.codigo || '',
            solicitud.cliente_nombre || '',
            solicitud.cliente_documento || '',
            solicitud.tipo_solicitud || '',
            solicitud.pipeline?.nombre || '',
            solicitud.creada_por?.full_name || ''
        ];
        
        return searchableFields.some(field => 
            field.toLowerCase().includes(searchTerm.toLowerCase())
        );
    });
    
    renderTable(filtered, searchTerm);
}

function highlightSearchTerm(text, searchTerm) {
    if (!searchTerm || !text) return text;
    
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
}

// Función para actualizar filtro de pipeline
function updatePipelineFilter(solicitudes) {
    const pipelineFilter = document.getElementById('pipelineFilter');
    const pipelines = [...new Set(solicitudes.map(s => s.pipeline?.nombre).filter(Boolean))];
    
    const currentValue = pipelineFilter.value;
    pipelineFilter.innerHTML = '<option value="">Todos los pipelines</option>';
    
    pipelines.forEach(pipeline => {
        const option = document.createElement('option');
        option.value = pipeline;
        option.textContent = pipeline;
        if (pipeline === currentValue) option.selected = true;
        pipelineFilter.appendChild(option);
    });
}

// Función para refrescar datos
function refreshData() {
    loadTrackingData();
}

// Función para mostrar errores
function showError(message) {
    console.error(message);
    // Aquí podrías agregar un toast o notificación
    alert(message);
}

// Modal functionality
let currentModalData = null;

async function openDetailModal(codigo, tipoSolicitud = null) {
    try {
        let endpoint;
        
        if (trackingType === 'unified' && tipoSolicitud) {
            // Vista unificada: usar el tipo específico de solicitud
            if (tipoSolicitud === 'debida_diligencia') {
                endpoint = `${apiEndpoints[tipoSolicitud].detail}${codigo}/`;
            } else {
                endpoint = `${apiEndpoints[tipoSolicitud].detail}${codigo}/`;
            }
        } else {
            // Vista específica: usar el tipo configurado
            endpoint = `${apiEndpoints[trackingType].detail}${codigo}/`;
        }
        
        const response = await fetch(endpoint, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });

        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
            // Handle different response structures for APC and SURA
            const modalData = result.data || result.solicitud;
            if (!modalData) {
                throw new Error('No se encontraron datos en la respuesta');
            }
            currentModalData = modalData;
            populateModal(modalData, tipoSolicitud);
            document.getElementById('detailModal').style.display = 'flex';
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
    } catch (error) {
        console.error('Error al cargar detalles:', error);
        showError('Error al cargar los detalles: ' + error.message);
    }
}

function populateModal(solicitud, tipoSolicitud = null) {
    const modalType = tipoSolicitud || trackingType;
    const modalTypeUpper = modalType.toUpperCase();
    
    document.getElementById('modalTitle').textContent = `Detalles ${modalTypeUpper} - ${solicitud.codigo}`;
    
    const modalBody = document.getElementById('modalBody');
    const statusField = modalType === 'debida_diligencia' ? 'debida_diligencia_status' : `${modalType}_status`;
    const statusDisplayField = modalType === 'debida_diligencia' ? 'debida_diligencia_status_display' : `${modalType}_status_display`;
    const archivoField = modalType === 'debida_diligencia' ? 'diligencia_archivos' : `${modalType}_archivo_url`;
    const archivoNameField = modalType === 'debida_diligencia' ? 'diligencia_archivos' : `${modalType}_archivo_name`;
    
    // Handle different field structures for APC vs SURA vs Debida Diligencia
    const clienteDocumento = modalType === 'apc' ? (solicitud.apc_no_cedula || 'N/A') : (solicitud.cliente_documento || 'N/A');
    const pipelineNombre = modalType === 'apc' ? (solicitud.pipeline || 'N/A') : (solicitud.pipeline?.nombre || 'N/A');
    const observacionesField = modalType === 'debida_diligencia' ? 'diligencia_observaciones' : `${modalType}_observaciones`;
    const fechaSolicitudField = modalType === 'debida_diligencia' ? 'diligencia_fecha_solicitud' : `${modalType}_fecha_solicitud`;
    const fechaInicioField = modalType === 'debida_diligencia' ? 'diligencia_fecha_inicio' : `${modalType}_fecha_inicio`;
    const fechaCompletadoField = modalType === 'debida_diligencia' ? 'diligencia_fecha_completado' : `${modalType}_fecha_completado`;
    
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h5>Información General</h5>
                <table class="table table-sm">
                    <tr><td><strong>Código:</strong></td><td>${solicitud.codigo}</td></tr>
                    ${trackingType === 'unified' ? `<tr><td><strong>Tipo Solicitud:</strong></td><td>
                        <span class="badge badge-${modalType === 'apc' ? 'info' : 'warning'}">${modalTypeUpper}</span>
                    </td></tr>` : ''}
                    <tr><td><strong>Cliente:</strong></td><td>${solicitud.cliente_nombre || 'N/A'}</td></tr>
                    <tr><td><strong>Documento:</strong></td><td>${clienteDocumento}</td></tr>
                    <tr><td><strong>Pipeline:</strong></td><td>${pipelineNombre}</td></tr>
                    <tr><td><strong>Estado:</strong></td><td>
                        <span class="status-badge status-${solicitud[statusField]}">
                            ${getStatusIcon(solicitud[statusField])} ${solicitud[statusDisplayField]}
                        </span>
                    </td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h5>Fechas</h5>
                <table class="table table-sm">
                    <tr><td><strong>Solicitud:</strong></td><td>${formatDate(solicitud[fechaSolicitudField])}</td></tr>
                    <tr><td><strong>Inicio:</strong></td><td>${formatDate(solicitud[fechaInicioField])}</td></tr>
                    <tr><td><strong>Completado:</strong></td><td>${formatDate(solicitud[fechaCompletadoField])}</td></tr>
                </table>
                
                ${modalType === 'debida_diligencia' ? `
                    <h5>Archivos de Debida Diligencia</h5>
                    ${solicitud.diligencia_busqueda_google ? `
                        <div class="mb-2">
                            <strong>Búsqueda Google:</strong>
                            <div class="d-flex gap-2 mt-1">
                                <a href="${solicitud.diligencia_busqueda_google}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Ver
                                </a>
                                <a href="${solicitud.diligencia_busqueda_google}" download class="btn btn-sm btn-success">
                                    <i class="fas fa-download"></i> Descargar
                                </a>
                            </div>
                        </div>
                    ` : '<div class="mb-2"><strong>Búsqueda Google:</strong> <span class="text-muted">No disponible</span></div>'}
                    ${solicitud.diligencia_busqueda_registro_publico ? `
                        <div class="mb-2">
                            <strong>Registro Público:</strong>
                            <div class="d-flex gap-2 mt-1">
                                <a href="${solicitud.diligencia_busqueda_registro_publico}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Ver
                                </a>
                                <a href="${solicitud.diligencia_busqueda_registro_publico}" download class="btn btn-sm btn-success">
                                    <i class="fas fa-download"></i> Descargar
                                </a>
                            </div>
                        </div>
                    ` : '<div class="mb-2"><strong>Registro Público:</strong> <span class="text-muted">No disponible</span></div>'}
                ` : solicitud[archivoField] ? `
                    <h5>Archivo</h5>
                    <div class="d-flex gap-2">
                        <a href="${solicitud[archivoField]}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye"></i> Ver archivo
                        </a>
                        <a href="${solicitud[archivoField]}" download class="btn btn-sm btn-success">
                            <i class="fas fa-download"></i> Descargar
                        </a>
                    </div>
                ` : ''}
            </div>
        </div>
        
        ${solicitud[observacionesField] ? `
            <div class="mt-3">
                <h5>Observaciones</h5>
                <div class="alert alert-info">
                    ${solicitud[observacionesField].replace(/\n/g, '<br>')}
                </div>
            </div>
        ` : ''}
        
        ${generateTimeline(solicitud, modalType)}
    `;
    
    // Modal actions
    const modalActions = document.getElementById('modalActions');
    modalActions.innerHTML = '';
    
    if (isUserSuperuser) {
        modalActions.innerHTML = `
            <button type="button" class="btn btn-warning" onclick="reenviarSolicitud('${solicitud.codigo}', '${modalType}')">
                <i class="fas fa-paper-plane"></i> Reenviar
            </button>
        `;
    }
}

function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
    currentModalData = null;
}

// Función para reenviar solicitud
async function reenviarSolicitud(codigo, tipoSolicitud = null) {
    const modalType = tipoSolicitud || trackingType;
    const modalTypeUpper = modalType.toUpperCase();
    
    if (!confirm(`¿Estás seguro de que deseas reenviar la solicitud ${modalTypeUpper} ${codigo}?`)) {
        return;
    }
    
    try {
        let endpoint;
        
        if (trackingType === 'unified' && tipoSolicitud) {
            // Vista unificada: usar el tipo específico de solicitud
            // Normalize the tipo to match apiEndpoints keys
            let normalizedType = tipoSolicitud.toLowerCase();
            if (normalizedType === 'debida diligencia' || normalizedType === 'debida_diligencia') {
                normalizedType = 'debida_diligencia';
            }
            
            if (apiEndpoints[normalizedType]) {
                endpoint = `${apiEndpoints[normalizedType].reenviar}${codigo}/`;
            } else {
                throw new Error(`Tipo de solicitud no soportado: ${tipoSolicitud}`);
            }
        } else {
            // Vista específica: usar el tipo configurado
            endpoint = `${apiEndpoints[trackingType].reenviar}${codigo}/`;
        }
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });

        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            // Refrescar datos
            loadTrackingData();
            // Cerrar modal si está abierto
            if (currentModalData) {
                closeDetailModal();
            }
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
    } catch (error) {
        console.error('Error al reenviar:', error);
        showError('Error al reenviar la solicitud: ' + error.message);
    }
}

// Helper functions
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function showSuccess(message) {
    console.log('Success:', message);
    // Aquí podrías agregar un toast o notificación
    alert(message);
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'N/A';
    return date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Function to generate timeline HTML
function generateTimeline(solicitud, modalType) {
    const events = [];
    
    // Add creation event
    if (solicitud.fecha_creacion) {
        events.push({
            evento: 'Solicitud Creada',
            fecha: solicitud.fecha_creacion,
            descripcion: `Solicitud creada en el sistema`
        });
    }
    
    // Add request event based on type
    const fechaSolicitudField = `${modalType}_fecha_solicitud`;
    if (solicitud[fechaSolicitudField]) {
        const tipoSolicitud = modalType === 'debida_diligencia' ? 'DEBIDA DILIGENCIA' : modalType.toUpperCase();
        events.push({
            evento: `${tipoSolicitud} Solicitado`,
            fecha: solicitud[fechaSolicitudField],
            descripcion: `Solicitud de ${tipoSolicitud} enviada a Makito RPA`
        });
    }
    
    // Add processing start event
    const fechaInicioField = `${modalType}_fecha_inicio`;
    if (solicitud[fechaInicioField]) {
        events.push({
            evento: 'Procesamiento Iniciado',
            fecha: solicitud[fechaInicioField],
            descripcion: 'Makito RPA inició el procesamiento'
        });
    }
    
    // Add completion event
    const fechaCompletadoField = `${modalType}_fecha_completado`;
    if (solicitud[fechaCompletadoField]) {
        events.push({
            evento: `${modalType.toUpperCase()} Completado`,
            fecha: solicitud[fechaCompletadoField],
            descripcion: `Proceso de ${modalType.toUpperCase()} completado exitosamente`
        });
    }
    
    // Sort events by date
    events.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    
    if (events.length > 0) {
        return `
            <div class="mt-3">
                <h5>Timeline</h5>
                <div class="timeline">
                    ${events.map(event => `
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <strong>${event.evento}</strong>
                                <small class="text-muted d-block">${formatDate(event.fecha)}</small>
                                ${event.descripcion ? `<p class="mb-0">${event.descripcion}</p>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else {
        return `
            <div class="mt-3">
                <h5>Timeline</h5>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-content">
                            <strong>Sin eventos registrados</strong>
                            <small class="text-muted d-block">No hay eventos registrados para esta solicitud</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

// ==========================================
// NUEVA SOLICITUD FUNCTIONALITY
// ==========================================

let availableSolicitudes = [];

function openNuevaSolicitudModal() {
    document.getElementById('nuevaSolicitudModal').style.display = 'flex';
    setupServiceTypeSelector();
    resetNuevaSolicitudModal();
}

function closeNuevaSolicitudModal() {
    document.getElementById('nuevaSolicitudModal').style.display = 'none';
    resetNuevaSolicitudModal();
}

function resetNuevaSolicitudModal() {
    selectedServiceType = null;
    selectedSolicitudId = null;
    availableSolicitudes = [];
    
    // Reset search listener flag
    resetSearchListener();
    
    // Reset UI
    document.querySelectorAll('.service-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    document.getElementById('solicitudesSection').style.display = 'none';
    document.getElementById('procesarSolicitudBtn').style.display = 'none';
    
    const searchInput = document.getElementById('searchSolicitudes');
    if (searchInput) {
        searchInput.value = '';
    }
}

function setupServiceTypeSelector() {
    document.querySelectorAll('.service-option').forEach(option => {
        option.addEventListener('click', function() {
            // Remove previous selection
            document.querySelectorAll('.service-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add selection to clicked option
            this.classList.add('selected');
            selectedServiceType = this.dataset.type;
            
            console.log('Selected service type:', selectedServiceType);
            
            // Clear search input when switching service types
            const searchInput = document.getElementById('searchSolicitudes');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Show solicitudes section and load data
            document.getElementById('solicitudesSection').style.display = 'block';
            loadAvailableSolicitudes();
        });
    });
}

async function loadAvailableSolicitudes() {
    const loadingElement = document.getElementById('loadingSolicitudes');
    const listElement = document.getElementById('solicitudesList');
    const noDataElement = document.getElementById('noSolicitudesFound');
    
    // Show loading
    if (loadingElement) loadingElement.style.display = 'block';
    if (listElement) listElement.innerHTML = '';
    if (noDataElement) noDataElement.style.display = 'none';
    
    try {
        const response = await fetch('/workflow/api/solicitudes/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Received solicitudes data:', data);
        
        // Store the full list of available solicitudes
        availableSolicitudes = (data.solicitudes || []).filter(solicitud => {
            console.log('Filtering solicitud:', {
                id: solicitud.id,
                codigo: solicitud.codigo,
                etapa_actual: solicitud.etapa_actual,
                apc_status: solicitud.apc_status,
                sura_status: solicitud.sura_status,
                debida_diligencia_status: solicitud.debida_diligencia_status,
                selectedServiceType: selectedServiceType
            });
            
            // Only show active solicitudes (not completed)
            if (!solicitud.etapa_actual || solicitud.etapa_actual.toLowerCase() === 'completado') {
                console.log('Filtering out - solicitud completed');
                return false;
            }
            
            // Filter based on selected service type status
            switch (selectedServiceType) {
                case 'apc':
                    // Don't show if APC is already pending, in_progress, or completed
                    const apcStatus = solicitud.apc_status || '';
                    const apcAllowed = apcStatus === '' || apcStatus === 'no_iniciado' || apcStatus === 'none' || apcStatus === null || apcStatus === 'undefined';
                    console.log('APC filter result:', apcAllowed, 'Status:', apcStatus);
                    return apcAllowed;
                    
                case 'sura':
                    // Don't show if SURA is already pending, in_progress, or completed
                    const suraStatus = solicitud.sura_status || '';
                    const suraAllowed = suraStatus === '' || suraStatus === 'no_iniciado' || suraStatus === 'none' || suraStatus === null || suraStatus === 'undefined';
                    console.log('SURA filter result:', suraAllowed, 'Status:', suraStatus);
                    return suraAllowed;
                    
                case 'debida_diligencia':
                    // Don't show if Debida Diligencia is already pending, in_progress, or completed
                    const ddStatus = solicitud.debida_diligencia_status || '';
                    const ddAllowed = ddStatus === '' || ddStatus === 'no_iniciado' || ddStatus === 'none' || ddStatus === null || ddStatus === 'undefined';
                    console.log('DD filter result:', ddAllowed, 'Status:', ddStatus);
                    return ddAllowed;
                    
                default:
                    console.log('Default filter - allowing all');
                    return true;
            }
        });
        
        console.log('Filtered solicitudes:', availableSolicitudes.length);
        
        if (loadingElement) loadingElement.style.display = 'none';
        
        if (availableSolicitudes.length === 0) {
            if (noDataElement) noDataElement.style.display = 'block';
            return;
        }
        
        renderSolicitudesList(availableSolicitudes);
        
        // Set up search functionality after a small delay to ensure DOM is ready
        setTimeout(() => {
            setupSolicitudesSearch();
        }, 100);
        
    } catch (error) {
        console.error('Error loading solicitudes:', error);
        if (loadingElement) loadingElement.style.display = 'none';
        if (noDataElement) noDataElement.style.display = 'block';
        
        showAlert('Error al cargar las solicitudes. Intenta nuevamente.', 'error');
    }
}

function renderSolicitudesList(solicitudes) {
    const listElement = document.getElementById('solicitudesList');
    const noDataElement = document.getElementById('noSolicitudesFound');
    
    if (!listElement) {
        console.warn('Solicitudes list element not found');
        return;
    }
    
    if (!solicitudes || solicitudes.length === 0) {
        listElement.innerHTML = '';
        if (noDataElement) {
            noDataElement.style.display = 'block';
        }
        return;
    }
    
    if (noDataElement) {
        noDataElement.style.display = 'none';
    }
    
    listElement.innerHTML = solicitudes.map(solicitud => `
        <div class="solicitud-item" data-solicitud-id="${solicitud.id}" onclick="selectSolicitud(${solicitud.id})">
            <div class="solicitud-info">
                <div class="solicitud-code">${solicitud.cliente_nombre || solicitud.nombreCliente || 'Sin cliente'}</div>
                <div class="solicitud-details">
                    <span><i class="fas fa-code me-1"></i>${solicitud.codigo || 'N/A'}</span>
                    <span><i class="fas fa-id-card me-1"></i>${solicitud.apc_no_cedula || solicitud.cedulaCliente || solicitud.cliente_documento || solicitud.documento || 'Sin documento'}</span>
                    <span><i class="fas fa-calendar me-1"></i>${formatDate(solicitud.fecha_creacion)}</span>
                    <span><i class="fas fa-user-tag me-1"></i>${solicitud.creada_por || 'N/A'}</span>
                </div>
            </div>
            <div class="solicitud-meta">
                <span class="pipeline-badge">${solicitud.pipeline || 'N/A'}</span>
                <span class="etapa-badge">${solicitud.etapa_actual || 'Completada'}</span>
            </div>
        </div>
    `).join('');
}

function selectSolicitud(solicitudId) {
    console.log('Selecting solicitud with ID:', solicitudId);
    
    // Remove previous selection
    document.querySelectorAll('.solicitud-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Add selection to clicked item
    const selectedItem = document.querySelector(`[data-solicitud-id="${solicitudId}"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
        selectedSolicitudId = solicitudId;
        
        console.log('Solicitud selected successfully:', selectedSolicitudId);
        
        // Show continue button instead of process button
        const continuarBtn = document.getElementById('continuarValidacionBtn');
        const procesarBtn = document.getElementById('procesarSolicitudBtn');
        
        if (continuarBtn) continuarBtn.style.display = 'inline-block';
        if (procesarBtn) procesarBtn.style.display = 'none';
    } else {
        console.warn('Could not find solicitud item with ID:', solicitudId);
    }
}

// Global flag to prevent multiple search listeners
let searchListenerAttached = false;

function setupSolicitudesSearch() {
    const searchInput = document.getElementById('searchSolicitudes');
    
    if (!searchInput) {
        console.warn('Search input element with ID "searchSolicitudes" not found');
        return;
    }
    
    console.log('Setting up solicitudes search... Available solicitudes:', availableSolicitudes.length);
    
    // Only attach listeners if not already attached
    if (!searchListenerAttached) {
        // Add the event listeners
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('keyup', handleSearchInput);
        searchListenerAttached = true;
        console.log('Search event listeners attached successfully');
    } else {
        console.log('Search listeners already attached, skipping');
    }
}

// Reset the flag when modal is closed
function resetSearchListener() {
    searchListenerAttached = false;
}

function handleSearchInput(event) {
    const searchTerm = event.target.value.toLowerCase().trim();
    
    console.log('=== SEARCH INPUT HANDLER ===');
    console.log('Search term:', searchTerm);
    console.log('Available solicitudes count:', availableSolicitudes.length);
    console.log('Selected service type:', selectedServiceType);
    
    if (searchTerm === '') {
        console.log('Empty search term - showing all solicitudes');
        renderSolicitudesList(availableSolicitudes);
        return;
    }
    
    const filteredSolicitudes = availableSolicitudes.filter(solicitud => {
        // Create searchable text from all relevant fields
        const searchableFields = [
            solicitud.codigo || '',
            solicitud.cliente_nombre || '',
            solicitud.nombreCliente || '',
            solicitud.apc_no_cedula || '',
            solicitud.cedulaCliente || '',
            solicitud.cliente_documento || '',
            solicitud.documento || '',
            solicitud.pipeline || '',
            solicitud.creada_por || '',
            solicitud.etapa_actual || '',
            solicitud.subestado_actual || ''
        ];
        
        const searchableText = searchableFields.join(' ').toLowerCase();
        const matches = searchableText.includes(searchTerm);
        
        if (matches) {
            console.log(`Match found for ${solicitud.codigo}:`, {
                codigo: solicitud.codigo,
                cliente: solicitud.cliente_nombre || solicitud.nombreCliente,
                searchableText: searchableText.substring(0, 100) + '...'
            });
        }
        
        return matches;
    });
    
    console.log(`Search results: ${filteredSolicitudes.length} matches for "${searchTerm}"`);
    console.log('=== END SEARCH INPUT HANDLER ===');
    
    renderSolicitudesList(filteredSolicitudes);
}

async function procesarNuevaSolicitud() {
    if (!selectedServiceType || !selectedSolicitudId) {
        showAlert('Por favor selecciona un tipo de servicio y una solicitud.', 'warning');
        return;
    }
    
    const procesarBtn = document.getElementById('procesarSolicitudBtn');
    const originalText = procesarBtn.innerHTML;
    
    // Show loading state
    procesarBtn.disabled = true;
    procesarBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
    
    try {
        let apiUrl = '';
        let requestData = {};
        
        // Determine API endpoint and data based on service type
        switch (selectedServiceType) {
            case 'apc':
                // For APC, we need to collect form data and send it to the backend
                apiUrl = `/workflow/api/solicitar-apc-makito/${selectedSolicitudId}/`;
                const apcTipoDoc = document.getElementById('apcTipoDocumento')?.value;
                const apcNumeroDoc = document.getElementById('apcNumeroDocumento')?.value;
                requestData = {
                    tipo_documento: apcTipoDoc,
                    numero_documento: apcNumeroDoc
                };
                break;
            case 'sura':
                // For SURA, collect detailed field data matching makitoRPA.html structure
                apiUrl = `/workflow/api/solicitar-sura-makito/${selectedSolicitudId}/`;
                const suraPrimerNombre = document.getElementById('suraPrimerNombre')?.value;
                const suraSegundoNombre = document.getElementById('suraSegundoNombre')?.value;
                const suraPrimerApellido = document.getElementById('suraPrimerApellido')?.value;
                const suraSegundoApellido = document.getElementById('suraSegundoApellido')?.value;
                const suraDocumento = document.getElementById('suraDocumento')?.value;
                const suraMarcaAuto = document.getElementById('suraMarcaAuto')?.value;
                const suraModeloAuto = document.getElementById('suraModeloAuto')?.value;
                const suraAnoAuto = document.getElementById('suraAnoAuto')?.value;
                const suraValorAuto = document.getElementById('suraValorAuto')?.value;
                
                requestData = {
                    primer_nombre: suraPrimerNombre,
                    segundo_nombre: suraSegundoNombre,
                    primer_apellido: suraPrimerApellido,
                    segundo_apellido: suraSegundoApellido,
                    documento: suraDocumento,
                    marca_auto: suraMarcaAuto,
                    modelo_auto: suraModeloAuto,
                    ano_auto: suraAnoAuto,
                    valor_auto: suraValorAuto
                };
                break;
            case 'debida_diligencia':
                // This endpoint already exists
                apiUrl = `/workflow/api/debida-diligencia/solicitar-makito/${selectedSolicitudId}/`;
                requestData = { tipo_documento: 'busqueda_google' }; // Default to google search
                break;
            default:
                throw new Error('Tipo de servicio no válido');
        }
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        if (response.ok && (data.success || data.message)) {
            showAlert(
                `Solicitud de ${selectedServiceType.toUpperCase()} enviada correctamente. ${data.message || 'El proceso ha sido iniciado.'}`,
                'success'
            );
            
            // Close modal and refresh data
            closeNuevaSolicitudModal();
            refreshData();
            
        } else {
            throw new Error(data.message || data.error || 'Error al procesar la solicitud');
        }
        
    } catch (error) {
        console.error('Error processing nueva solicitud:', error);
        
        // If endpoint doesn't exist, fall back to manual process
        if (error.message.includes('404') || error.message.includes('Not Found')) {
            showAlert(
                `La funcionalidad para ${selectedServiceType.toUpperCase()} está en desarrollo. Por favor contacta al administrador.`,
                'warning'
            );
        } else {
            showAlert(`Error al procesar la solicitud: ${error.message}`, 'error');
        }
        
    } finally {
        // Restore button state
        procesarBtn.disabled = false;
        procesarBtn.innerHTML = originalText;
    }
}

function formatDate(dateString) {
    if (!dateString) return 'Sin fecha';
    
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

function showAlert(message, type = 'info') {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    
    const iconMap = {
        success: 'check-circle',
        error: 'exclamation-triangle',
        warning: 'exclamation-circle',
        info: 'info-circle'
    };
    
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${iconMap[type]} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}

// Validation functions
function continuarAValidacion() {
    if (!selectedSolicitudId) return;
    
    // Hide solicitudes section
    document.getElementById('solicitudesSection').style.display = 'none';
    
    // Show validation section
    document.getElementById('validacionCamposSection').style.display = 'block';
    
    // Update button visibility for validation mode
    document.getElementById('continuarValidacionBtn').style.display = 'none';
    document.getElementById('volverSolicitudesBtn').style.display = 'inline-block';
    document.getElementById('procesarSolicitudBtn').style.display = 'inline-block';
    
    // Load validation form based on service type
    loadValidationForm();
}

function volverASolicitudes() {
    // Hide validation section
    document.getElementById('validacionCamposSection').style.display = 'none';
    
    // Show solicitudes section
    document.getElementById('solicitudesSection').style.display = 'block';
    
    // Update button visibility for solicitudes mode
    document.getElementById('continuarValidacionBtn').style.display = 'inline-block';
    document.getElementById('volverSolicitudesBtn').style.display = 'none';
    document.getElementById('procesarSolicitudBtn').style.display = 'none';
    
    // Clear any validation errors
    clearValidationErrors();
}

function loadValidationForm() {
    const solicitud = availableSolicitudes.find(s => s.id == selectedSolicitudId);
    if (!solicitud) return;
    
    // Show solicitud info
    displaySolicitudInfo(solicitud);
    
    // Show appropriate validation form
    hideAllValidationForms();
    
    if (selectedServiceType === 'apc') {
        showAPCValidationForm(solicitud);
    } else if (selectedServiceType === 'sura') {
        showSURAValidationForm(solicitud);
    } else if (selectedServiceType === 'debida_diligencia') {
        showDebidaDiligenciaValidationForm(solicitud);
    }
}

function displaySolicitudInfo(solicitud) {
    const infoDiv = document.getElementById('solicitudInfoDisplay');
    infoDiv.innerHTML = `
        <h4>Solicitud Seleccionada</h4>
        <p><strong>ID:</strong> ${solicitud.id}</p>
        <p><strong>Cliente:</strong> ${solicitud.cliente_nombre || 'N/A'}</p>
        <p><strong>Proceso:</strong> ${solicitud.proceso || 'N/A'}</p>
        <p><strong>Estado:</strong> ${solicitud.estado || 'N/A'}</p>
    `;
}

function hideAllValidationForms() {
    document.getElementById('apcValidationForm').style.display = 'none';
    document.getElementById('suraValidationForm').style.display = 'none';
    document.getElementById('debidaDiligenciaValidationForm').style.display = 'none';
}

function showAPCValidationForm(solicitud) {
    const form = document.getElementById('apcValidationForm');
    if (!form) return;
    
    form.style.display = 'block';
    
    // Pre-fill form fields - handle various field name possibilities
    const tipoDocField = document.getElementById('apcTipoDocumento');
    const numeroDocField = document.getElementById('apcNumeroDocumento');
    
    if (tipoDocField) {
        tipoDocField.value = solicitud.apc_tipo_documento || solicitud.tipo_documento || '';
    }
    if (numeroDocField) {
        numeroDocField.value = solicitud.apc_no_cedula || solicitud.no_documento || solicitud.cliente_cedula || '';
    }
    
    // Show validation status
    validateAPCFields();
}

function showSURAValidationForm(solicitud) {
    const form = document.getElementById('suraValidationForm');
    if (!form) return;
    console.log('Showing SURA validation form for solicitud:', solicitud);
    form.style.display = 'block';
    
    // Get form field elements
    const tipoDocumentoField = document.getElementById('suraTipoDocumento');
    const primerNombreField = document.getElementById('suraPrimerNombre');
    const segundoNombreField = document.getElementById('suraSegundoNombre');
    const primerApellidoField = document.getElementById('suraPrimerApellido');
    const segundoApellidoField = document.getElementById('suraSegundoApellido');
    const documentoField = document.getElementById('suraDocumento');
    const marcaAutoField = document.getElementById('suraMarcaAuto');
    const modeloAutoField = document.getElementById('suraModeloAuto');
    const anoAutoField = document.getElementById('suraAnoAuto');
    const valorAutoField = document.getElementById('suraValorAuto');
    
    // Clear all fields first
    if (tipoDocumentoField) tipoDocumentoField.value = '';
    if (primerNombreField) primerNombreField.value = '';
    if (segundoNombreField) segundoNombreField.value = '';
    if (primerApellidoField) primerApellidoField.value = '';
    if (segundoApellidoField) segundoApellidoField.value = '';
    if (documentoField) documentoField.value = '';
    if (marcaAutoField) marcaAutoField.value = '';
    if (modeloAutoField) modeloAutoField.value = '';
    if (anoAutoField) anoAutoField.value = '';
    if (valorAutoField) valorAutoField.value = '';
    
    // Prefill tipo de documento - default to cedula if not specified
    if (tipoDocumentoField) {
        tipoDocumentoField.value = solicitud.apc_tipo_documento || 'cedula';
        tipoDocumentoField.classList.add('auto-populated');
    }
    
    // Prefill document number from various possible sources
    if (documentoField) {
        const documentoValue = solicitud.cedulaCliente || solicitud.documento || solicitud.apc_no_cedula || solicitud.sura_no_documento || '';
        if (documentoValue) {
            documentoField.value = documentoValue;
            documentoField.classList.add('auto-populated');
        }
    }
    
    // Parse client name from available sources
    const nombreCompleto = solicitud.cliente_nombre || solicitud.nombreCliente || '';
    if (nombreCompleto) {
        const nombreParts = nombreCompleto.trim().split(' ');
        
        // Smart name parsing logic
        if (nombreParts.length >= 1 && primerNombreField) {
            primerNombreField.value = nombreParts[0];
            primerNombreField.classList.add('auto-populated');
        }
        
        if (nombreParts.length >= 2) {
            if (nombreParts.length === 2) {
                // Format: "Nombre Apellido"
                if (primerApellidoField) {
                    primerApellidoField.value = nombreParts[1];
                    primerApellidoField.classList.add('auto-populated');
                }
            } else if (nombreParts.length === 3) {
                // Format: "Nombre Apellido1 Apellido2" or "Nombre1 Nombre2 Apellido"
                // Assume last 2 are apellidos
                if (primerApellidoField) {
                    primerApellidoField.value = nombreParts[1];
                    primerApellidoField.classList.add('auto-populated');
                }
                if (segundoApellidoField) {
                    segundoApellidoField.value = nombreParts[2];
                    segundoApellidoField.classList.add('auto-populated');
                }
            } else if (nombreParts.length === 4) {
                // Format: "Nombre1 Nombre2 Apellido1 Apellido2"
                if (segundoNombreField) {
                    segundoNombreField.value = nombreParts[1];
                    segundoNombreField.classList.add('auto-populated');
                }
                if (primerApellidoField) {
                    primerApellidoField.value = nombreParts[2];
                    primerApellidoField.classList.add('auto-populated');
                }
                if (segundoApellidoField) {
                    segundoApellidoField.value = nombreParts[3];
                    segundoApellidoField.classList.add('auto-populated');
                }
            } else if (nombreParts.length > 4) {
                // More than 4 parts, take first as primer nombre, last 2 as apellidos
                if (segundoNombreField) {
                    segundoNombreField.value = nombreParts.slice(1, nombreParts.length - 2).join(' ');
                    segundoNombreField.classList.add('auto-populated');
                }
                if (primerApellidoField) {
                    primerApellidoField.value = nombreParts[nombreParts.length - 2];
                    primerApellidoField.classList.add('auto-populated');
                }
                if (segundoApellidoField) {
                    segundoApellidoField.value = nombreParts[nombreParts.length - 1];
                    segundoApellidoField.classList.add('auto-populated');
                }
            }
        }
    }
    
    // Prefill car data from cotization fields (direct from API response)
    if (solicitud.marca && marcaAutoField) {
        marcaAutoField.value = solicitud.marca;
        marcaAutoField.classList.add('auto-populated');
    }
    
    if (solicitud.modelo && modeloAutoField) {
        modeloAutoField.value = solicitud.modelo;
        modeloAutoField.classList.add('auto-populated');
    }
    
    if (solicitud.yearCarro && anoAutoField) {
        anoAutoField.value = solicitud.yearCarro;
        anoAutoField.classList.add('auto-populated');
    }
    
    if (solicitud.valorAuto && valorAutoField) {
        valorAutoField.value = solicitud.valorAuto;
        valorAutoField.classList.add('auto-populated');
    }
    
    // Fallback to any existing SURA-specific fields from solicitud
    if (solicitud.sura_primer_nombre && primerNombreField && !primerNombreField.value) {
        primerNombreField.value = solicitud.sura_primer_nombre;
        primerNombreField.classList.add('auto-populated');
    }
    
    if (solicitud.sura_segundo_nombre && segundoNombreField && !segundoNombreField.value) {
        segundoNombreField.value = solicitud.sura_segundo_nombre;
        segundoNombreField.classList.add('auto-populated');
    }
    
    if (solicitud.sura_primer_apellido && primerApellidoField && !primerApellidoField.value) {
        primerApellidoField.value = solicitud.sura_primer_apellido;
        primerApellidoField.classList.add('auto-populated');
    }
    
    if (solicitud.sura_segundo_apellido && segundoApellidoField && !segundoApellidoField.value) {
        segundoApellidoField.value = solicitud.sura_segundo_apellido;
        segundoApellidoField.classList.add('auto-populated');
    }
    
    // Show validation status
    validateSURAFields();
    
    console.log('SURA form prefilled with solicitud data:', {
        nombreCliente: solicitud.cliente_nombre || solicitud.nombreCliente,
        cedulaCliente: solicitud.cedulaCliente || solicitud.documento,
        marca: solicitud.marca,
        modelo: solicitud.modelo,
        yearCarro: solicitud.yearCarro,
        valorAuto: solicitud.valorAuto,
        apc_tipo_documento: solicitud.apc_tipo_documento
    });
}

function showDebidaDiligenciaValidationForm(solicitud) {
    const form = document.getElementById('debidaDiligenciaValidationForm');
    if (!form) return;
    
    form.style.display = 'block';
    
    // Pre-fill form fields - handle various field name possibilities
    const nombresField = document.getElementById('ddNombres');
    const documentoField = document.getElementById('ddDocumento');
    
    if (nombresField) {
        nombresField.value = solicitud.nombres || solicitud.cliente_nombre || '';
    }
    if (documentoField) {
        documentoField.value = solicitud.no_documento || solicitud.cliente_cedula || '';
    }
    
    // Show validation status
    validateDebidaDiligenciaFields();
}

function validateAPCFields() {
    const tipoDocField = document.getElementById('apcTipoDocumento');
    const numeroDocField = document.getElementById('apcNumeroDocumento');
    
    if (!tipoDocField || !numeroDocField) {
        console.warn('APC validation fields not found');
        return false;
    }
    
    const tipoDoc = tipoDocField.value.trim();
    const numeroDoc = numeroDocField.value.trim();
    
    let hasErrors = false;
    
    // Clear previous errors
    clearFieldError('apcTipoDocumento');
    clearFieldError('apcNumeroDocumento');
    
    if (!tipoDoc) {
        showFieldError('apcTipoDocumento', 'El tipo de documento es requerido');
        hasErrors = true;
    }
    
    if (!numeroDoc) {
        showFieldError('apcNumeroDocumento', 'El número de documento es requerido');
        hasErrors = true;
    }
    
    updateProcessButton(!hasErrors);
    return !hasErrors;
}

function validateSURAFields() {
    const tipoDocumentoField = document.getElementById('suraTipoDocumento');
    const primerNombreField = document.getElementById('suraPrimerNombre');
    const primerApellidoField = document.getElementById('suraPrimerApellido');
    const documentoField = document.getElementById('suraDocumento');
    const marcaAutoField = document.getElementById('suraMarcaAuto');
    const modeloAutoField = document.getElementById('suraModeloAuto');
    const anoAutoField = document.getElementById('suraAnoAuto');
    const valorAutoField = document.getElementById('suraValorAuto');
    
    if (!tipoDocumentoField || !primerNombreField || !primerApellidoField || !documentoField || !marcaAutoField || 
        !modeloAutoField || !anoAutoField || !valorAutoField) {
        console.warn('SURA validation fields not found');
        return false;
    }
    
    const tipoDocumento = tipoDocumentoField.value.trim();
    const primerNombre = primerNombreField.value.trim();
    const primerApellido = primerApellidoField.value.trim();
    const documento = documentoField.value.trim();
    const marcaAuto = marcaAutoField.value.trim();
    const modeloAuto = modeloAutoField.value.trim();
    const anoAuto = anoAutoField.value;
    const valorAuto = valorAutoField.value;
    
    let hasErrors = false;
    
    // Clear previous errors
    clearFieldError('suraTipoDocumento');
    clearFieldError('suraPrimerNombre');
    clearFieldError('suraPrimerApellido');
    clearFieldError('suraDocumento');
    clearFieldError('suraMarcaAuto');
    clearFieldError('suraModeloAuto');
    clearFieldError('suraAnoAuto');
    clearFieldError('suraValorAuto');
    
    if (!tipoDocumento) {
        showFieldError('suraTipoDocumento', 'El tipo de documento es requerido');
        hasErrors = true;
    }
    
    if (!primerNombre) {
        showFieldError('suraPrimerNombre', 'El primer nombre es requerido');
        hasErrors = true;
    }
    
    if (!primerApellido) {
        showFieldError('suraPrimerApellido', 'El primer apellido es requerido');
        hasErrors = true;
    }
    
    if (!documento) {
        showFieldError('suraDocumento', 'El documento es requerido');
        hasErrors = true;
    }
    
    if (!marcaAuto) {
        showFieldError('suraMarcaAuto', 'La marca del auto es requerida');
        hasErrors = true;
    }
    
    if (!modeloAuto) {
        showFieldError('suraModeloAuto', 'El modelo del auto es requerido');
        hasErrors = true;
    }
    
    if (!anoAuto) {
        showFieldError('suraAnoAuto', 'El año del auto es requerido');
        hasErrors = true;
    }
    
    if (!valorAuto) {
        showFieldError('suraValorAuto', 'El valor del auto es requerido');
        hasErrors = true;
    }
    
    updateProcessButton(!hasErrors);
    return !hasErrors;
}

function validateDebidaDiligenciaFields() {
    const nombresField = document.getElementById('ddNombres');
    const documentoField = document.getElementById('ddDocumento');
    
    if (!nombresField || !documentoField) {
        console.warn('Debida Diligencia validation fields not found');
        return false;
    }
    
    const nombres = nombresField.value.trim();
    const documento = documentoField.value.trim();
    
    let hasErrors = false;
    
    // Clear previous errors
    clearFieldError('ddNombres');
    clearFieldError('ddDocumento');
    
    if (!nombres) {
        showFieldError('ddNombres', 'Los nombres son requeridos');
        hasErrors = true;
    }
    
    if (!documento) {
        showFieldError('ddDocumento', 'El documento es requerido');
        hasErrors = true;
    }
    
    updateProcessButton(!hasErrors);
    return !hasErrors;
}

function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    const group = field.closest('.validation-form-group');
    if (!group) return;
    
    // Add error class
    group.classList.add('error');
    group.classList.remove('success');
    
    // Show error message
    let errorDiv = group.querySelector('.field-error');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        errorDiv.style.color = '#dc3545';
        errorDiv.style.fontSize = '0.8rem';
        errorDiv.style.marginTop = '4px';
        group.appendChild(errorDiv);
    }
    errorDiv.textContent = message;
}

function clearFieldError(fieldId) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    const group = field.closest('.validation-form-group');
    if (!group) return;
    
    // Remove error class
    group.classList.remove('error');
    
    // Remove error message
    const errorDiv = group.querySelector('.field-error');
    if (errorDiv) {
        errorDiv.remove();
    }
    
    // Add success class if field has value
    if (field.value.trim()) {
        group.classList.add('success');
    } else {
        group.classList.remove('success');
    }
}

function clearValidationErrors() {
    document.querySelectorAll('.validation-form-group').forEach(group => {
        group.classList.remove('error', 'success');
        const errorDiv = group.querySelector('.field-error');
        if (errorDiv) {
            errorDiv.remove();
        }
    });
}

function updateProcessButton(isValid) {
    const processBtn = document.getElementById('procesarSolicitudBtn');
    if (!processBtn) {
        console.warn('Process button not found');
        return;
    }
    
    if (isValid) {
        processBtn.disabled = false;
        processBtn.classList.remove('disabled');
    } else {
        processBtn.disabled = true;
        processBtn.classList.add('disabled');
    }
}

function procesarSolicitudValidada() {
    if (!selectedSolicitudId || !selectedServiceType) return;
    
    // Validate fields before processing
    let isValid = false;
    if (selectedServiceType === 'apc') {
        isValid = validateAPCFields();
    } else if (selectedServiceType === 'sura') {
        isValid = validateSURAFields();
    } else if (selectedServiceType === 'debida_diligencia') {
        isValid = validateDebidaDiligenciaFields();
    }
    
    if (!isValid) {
        showAlert('Por favor complete todos los campos requeridos antes de continuar.', 'error');
        return;
    }
    
    // Show loading
    showAlert('Procesando solicitud...', 'info');
    
    // Get the original procesarSolicitud functionality
    procesarNuevaSolicitud();
}

// Add event listeners for validation form fields
document.addEventListener('DOMContentLoaded', function() {
    // APC validation fields
    const apcTipoDoc = document.getElementById('apcTipoDocumento');
    const apcNumeroDoc = document.getElementById('apcNumeroDocumento');
    
    if (apcTipoDoc) apcTipoDoc.addEventListener('input', validateAPCFields);
    if (apcNumeroDoc) apcNumeroDoc.addEventListener('input', validateAPCFields);
    
    // SURA validation fields - updated to match makitoRPA.html structure
    const suraTipoDocumento = document.getElementById('suraTipoDocumento');
    const suraPrimerNombre = document.getElementById('suraPrimerNombre');
    const suraSegundoNombre = document.getElementById('suraSegundoNombre');
    const suraPrimerApellido = document.getElementById('suraPrimerApellido');
    const suraSegundoApellido = document.getElementById('suraSegundoApellido');
    const suraDoc = document.getElementById('suraDocumento');
    const suraMarcaAuto = document.getElementById('suraMarcaAuto');
    const suraModeloAuto = document.getElementById('suraModeloAuto');
    const suraAnoAuto = document.getElementById('suraAnoAuto');
    const suraValorAuto = document.getElementById('suraValorAuto');
    
    if (suraTipoDocumento) suraTipoDocumento.addEventListener('change', validateSURAFields);
    if (suraPrimerNombre) suraPrimerNombre.addEventListener('input', validateSURAFields);
    if (suraSegundoNombre) suraSegundoNombre.addEventListener('input', validateSURAFields);
    if (suraPrimerApellido) suraPrimerApellido.addEventListener('input', validateSURAFields);
    if (suraSegundoApellido) suraSegundoApellido.addEventListener('input', validateSURAFields);
    if (suraDoc) suraDoc.addEventListener('input', validateSURAFields);
    if (suraMarcaAuto) suraMarcaAuto.addEventListener('input', validateSURAFields);
    if (suraModeloAuto) suraModeloAuto.addEventListener('input', validateSURAFields);
    if (suraAnoAuto) suraAnoAuto.addEventListener('input', validateSURAFields);
    if (suraValorAuto) suraValorAuto.addEventListener('input', validateSURAFields);
    
    // Debida Diligencia validation fields
    const ddNombres = document.getElementById('ddNombres');
    const ddDoc = document.getElementById('ddDocumento');
    
    if (ddNombres) ddNombres.addEventListener('input', validateDebidaDiligenciaFields);
    if (ddDoc) ddDoc.addEventListener('input', validateDebidaDiligenciaFields);
});

// Auto-refresh cada 30 segundos
setInterval(() => {
    refreshData();
}, 30000);

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const detailModal = document.getElementById('detailModal');
    if (detailModal) {
        detailModal.addEventListener('click', function(e) {
            if (e.target === detailModal) {
                closeDetailModal();
            }
        });
    }
    
    const nuevaSolicitudModal = document.getElementById('nuevaSolicitudModal');
    if (nuevaSolicitudModal) {
        nuevaSolicitudModal.addEventListener('click', function(e) {
            if (e.target === nuevaSolicitudModal) {
                closeNuevaSolicitudModal();
            }
        });
    }
});
</script>
{% endblock %}
